<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Update re2 - livegrep - Fast, regular expression code search service</title>
<meta name="description" content="Fast, regular expression code search service" />
<meta name="author" content="Kevin Lin" />
<link rel="icon" type="image/png" href="https://static.kevinlin.info/favicon.png" />
<link rel="alternate" type="application/atom+xml" title="livegrep Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="livegrep Atom Feed (tags)" href="../tags.xml" />
<style type="text/css">
body{color:#000;background-color:#fff;font-family:monospace}h1,h2,h3,h4,h5,h6{font-size:1em;margin:0}img,h1,h2{vertical-align:middle}img{border:0}a:target{background-color:#ccc}a.d,a.h,a.i{text-decoration:none}a.line{text-decoration:none;user-select:none}#blob a{color:#555}#blob a:hover{color:blue;text-decoration:none}table thead td{font-weight:bold}table td{padding:0 .4em}table td pre{margin:0}#content table td{vertical-align:top;white-space:nowrap}#branches tr:hover td,#tags tr:hover td,#index tr:hover td,#log tr:hover td,#files tr:hover td{background-color:#eee}#index tr td:nth-child(2),#tags tr td:nth-child(3),#branches tr td:nth-child(3),#log tr td:nth-child(2){white-space:normal}td.num{text-align:right}.desc{color:#555}hr{border:0;border-top:1px solid #555;height:1px}pre{font-family:monospace}pre a.h{color:#00a}.A,span.i,pre a.i{color:#070}.D,span.d,pre a.d{color:#e00}pre a.h:hover,pre a.i:hover,pre a.d:hover{text-decoration:none}
</style>
</head>
<body>
<table><tr><td><a href="/"><img src="https://static.kevinlin.info/favicon.png" alt="" width="32" height="32" /></a></td><td><h1>livegrep</h1><span class="desc">Fast, regular expression code search service</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://source.static.kevinlin.info/external/livegrep.git">https://source.static.kevinlin.info/external/livegrep.git</a></td></tr><tr><td></td><td>
<a href="../log">Log</a> | <a href="../files">Files</a> | <a href="../refs">Refs</a> | <a href="../file/README.md">README</a> | <a href="../file/COPYING">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/9df46426f45026768df55df4e2d4c831ca7cfbc2">9df46426f45026768df55df4e2d4c831ca7cfbc2</a>
<b>parent</b> <a href="../commit/5cdcd301f4c5eb5abe3f65f86c61cf6c84f2cbfa">5cdcd301f4c5eb5abe3f65f86c61cf6c84f2cbfa</a>
<b>Author:</b> Nelson Elhage &lt;<a href="mailto:nelhage@nelhage.com">nelhage@nelhage.com</a>&gt;
<b>Date:</b>   Sat  7 Nov 2015 21:03:32 -0800

Update re2

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">src/vendor/re2/.gitignore</a></td><td> | </td><td class="num">1</td><td><span class="i">+</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h1">src/vendor/re2/BUILD</a></td><td> | </td><td class="num">134</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h2">src/vendor/re2/CMakeLists.txt</a></td><td> | </td><td class="num">112</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">src/vendor/re2/Makefile</a></td><td> | </td><td class="num">61</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d">---------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">src/vendor/re2/README</a></td><td> | </td><td class="num">21</td><td><span class="i">+++++++++++++++++</span><span class="d">----</span></td></tr>
<tr><td class="A">A</td><td><a href="#h5">src/vendor/re2/benchlog/benchplot.py</a></td><td> | </td><td class="num">98</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h6">src/vendor/re2/lib/codereview/codereview.cfg</a></td><td> | </td><td class="num">1</td><td><span class="i"></span><span class="d">-</span></td></tr>
<tr><td class="D">D</td><td><a href="#h7">src/vendor/re2/lib/codereview/codereview.py</a></td><td> | </td><td class="num">3594</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h8">src/vendor/re2/libre2.symbols</a></td><td> | </td><td class="num">4</td><td><span class="i">+++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h9">src/vendor/re2/libre2.symbols.darwin</a></td><td> | </td><td class="num">12</td><td><span class="i">+++++++++</span><span class="d">---</span></td></tr>
<tr><td class="A">A</td><td><a href="#h10">src/vendor/re2/re2.pc</a></td><td> | </td><td class="num">10</td><td><span class="i">++++++++++</span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h11">src/vendor/re2/re2/Makefile</a></td><td> | </td><td class="num">1</td><td><span class="i"></span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h12">src/vendor/re2/re2/compile.cc</a></td><td> | </td><td class="num">24</td><td><span class="i">+++++++++++++++++</span><span class="d">-------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h13">src/vendor/re2/re2/dfa.cc</a></td><td> | </td><td class="num">40</td><td><span class="i">++++++++++++++++++</span><span class="d">----------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h14">src/vendor/re2/re2/filtered_re2.cc</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h15">src/vendor/re2/re2/make_perl_groups.pl</a></td><td> | </td><td class="num">34</td><td><span class="i">++++++++++++++++++++</span><span class="d">--------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h16">src/vendor/re2/re2/make_unicode_casefold.py</a></td><td> | </td><td class="num">3</td><td><span class="i">++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h17">src/vendor/re2/re2/nfa.cc</a></td><td> | </td><td class="num">51</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h18">src/vendor/re2/re2/onepass.cc</a></td><td> | </td><td class="num">4</td><td><span class="i"></span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h19">src/vendor/re2/re2/parse.cc</a></td><td> | </td><td class="num">137</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">----------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h20">src/vendor/re2/re2/prefilter.cc</a></td><td> | </td><td class="num">3</td><td><span class="i">+++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h21">src/vendor/re2/re2/prefilter_tree.cc</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h22">src/vendor/re2/re2/prefilter_tree.h</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h23">src/vendor/re2/re2/prog.cc</a></td><td> | </td><td class="num">8</td><td><span class="i">++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h24">src/vendor/re2/re2/prog.h</a></td><td> | </td><td class="num">9</td><td><span class="i">+++++++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h25">src/vendor/re2/re2/re2.cc</a></td><td> | </td><td class="num">109</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">----------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h26">src/vendor/re2/re2/re2.h</a></td><td> | </td><td class="num">29</td><td><span class="i">++++++++++++++++</span><span class="d">-------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h27">src/vendor/re2/re2/regexp.cc</a></td><td> | </td><td class="num">16</td><td><span class="i">++++++++</span><span class="d">--------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h28">src/vendor/re2/re2/regexp.h</a></td><td> | </td><td class="num">4</td><td><span class="i">+++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h29">src/vendor/re2/re2/set.cc</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h30">src/vendor/re2/re2/simplify.cc</a></td><td> | </td><td class="num">312</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">-------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h31">src/vendor/re2/re2/stringpiece.cc</a></td><td> | </td><td class="num">95</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h32">src/vendor/re2/re2/stringpiece.h</a></td><td> | </td><td class="num">1</td><td><span class="i">+</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h33">src/vendor/re2/re2/testing/compile_test.cc</a></td><td> | </td><td class="num">4</td><td><span class="i">++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h34">src/vendor/re2/re2/testing/dfa_test.cc</a></td><td> | </td><td class="num">28</td><td><span class="i">++++++++++++++++</span><span class="d">------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h35">src/vendor/re2/re2/testing/dump.cc</a></td><td> | </td><td class="num">2</td><td><span class="i">++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h36">src/vendor/re2/re2/testing/filtered_re2_test.cc</a></td><td> | </td><td class="num">12</td><td><span class="i">+++++</span><span class="d">-------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h37">src/vendor/re2/re2/testing/parse_test.cc</a></td><td> | </td><td class="num">39</td><td><span class="i">++++++++++++++++++++++++++++++++++++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h38">src/vendor/re2/re2/testing/re2_arg_test.cc</a></td><td> | </td><td class="num">16</td><td><span class="i">++++++++</span><span class="d">--------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h39">src/vendor/re2/re2/testing/re2_test.cc</a></td><td> | </td><td class="num">92</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">-----------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h40">src/vendor/re2/re2/testing/regexp_benchmark.cc</a></td><td> | </td><td class="num">22</td><td><span class="i">++++++++++++</span><span class="d">----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h41">src/vendor/re2/re2/testing/regexp_generator.cc</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h42">src/vendor/re2/re2/testing/regexp_test.cc</a></td><td> | </td><td class="num">3</td><td><span class="i">++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h43">src/vendor/re2/re2/testing/set_test.cc</a></td><td> | </td><td class="num">32</td><td><span class="i">+++++++++++++++++++++++++++++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h44">src/vendor/re2/re2/testing/simplify_test.cc</a></td><td> | </td><td class="num">93</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h45">src/vendor/re2/re2/testing/string_generator.cc</a></td><td> | </td><td class="num">7</td><td><span class="i">+++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h46">src/vendor/re2/re2/testing/tester.cc</a></td><td> | </td><td class="num">13</td><td><span class="i">++++++++</span><span class="d">-----</span></td></tr>
<tr><td class="D">D</td><td><a href="#h47">src/vendor/re2/re2/testing/unicode_test.py</a></td><td> | </td><td class="num">207</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h48">src/vendor/re2/re2/tostring.cc</a></td><td> | </td><td class="num">10</td><td><span class="i">++++++</span><span class="d">----</span></td></tr>
<tr><td class="A">A</td><td><a href="#h49">src/vendor/re2/re2_test.bzl</a></td><td> | </td><td class="num">14</td><td><span class="i">++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h50">src/vendor/re2/util/arena.cc</a></td><td> | </td><td class="num">168</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h51">src/vendor/re2/util/arena.h</a></td><td> | </td><td class="num">103</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h52">src/vendor/re2/util/atomicops.h</a></td><td> | </td><td class="num">51</td><td><span class="i">++++++++++++++++++++++++++++</span><span class="d">-----------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h53">src/vendor/re2/util/benchmark.cc</a></td><td> | </td><td class="num">23</td><td><span class="i">+++++++++++++++++++++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h54">src/vendor/re2/util/flags.h</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="A">A</td><td><a href="#h55">src/vendor/re2/util/logging.cc</a></td><td> | </td><td class="num">9</td><td><span class="i">+++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h56">src/vendor/re2/util/logging.h</a></td><td> | </td><td class="num">45</td><td><span class="i">++++++++++++++++++++++++++++++++++</span><span class="d">-----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h57">src/vendor/re2/util/mutex.h</a></td><td> | </td><td class="num">43</td><td><span class="i">++++++++++++++++++++++++++++++++</span><span class="d">-----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h58">src/vendor/re2/util/pcre.cc</a></td><td> | </td><td class="num">84</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">----------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h59">src/vendor/re2/util/pcre.h</a></td><td> | </td><td class="num">15</td><td><span class="i">+</span><span class="d">--------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h60">src/vendor/re2/util/rune.cc</a></td><td> | </td><td class="num">10</td><td><span class="i">+++++</span><span class="d">-----</span></td></tr>
<tr><td class="D">D</td><td><a href="#h61">src/vendor/re2/util/sparse_array_test.cc</a></td><td> | </td><td class="num">150</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h62">src/vendor/re2/util/stringpiece.cc</a></td><td> | </td><td class="num">91</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h63">src/vendor/re2/util/stringprintf.cc</a></td><td> | </td><td class="num">9</td><td><span class="i">++++++++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h64">src/vendor/re2/util/strutil.cc</a></td><td> | </td><td class="num">16</td><td><span class="i">+++++++++++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h65">src/vendor/re2/util/test.cc</a></td><td> | </td><td class="num">14</td><td><span class="i">+</span><span class="d">-------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h66">src/vendor/re2/util/test.h</a></td><td> | </td><td class="num">14</td><td><span class="i">++</span><span class="d">------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h67">src/vendor/re2/util/thread.cc</a></td><td> | </td><td class="num">4</td><td><span class="i">+</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h68">src/vendor/re2/util/thread.h</a></td><td> | </td><td class="num">11</td><td><span class="i">+++++++++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h69">src/vendor/re2/util/threadwin.cc</a></td><td> | </td><td class="num">13</td><td><span class="i">++++</span><span class="d">---------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h70">src/vendor/re2/util/util.h</a></td><td> | </td><td class="num">30</td><td><span class="i">++++++++++++++++++++</span><span class="d">----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h71">src/vendor/re2/util/valgrind.cc</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
</table></pre><pre>72 files changed, 1671 insertions(+), 4772 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/src/vendor/re2/.gitignore">src/vendor/re2/.gitignore</a> b/<a href="../file/src/vendor/re2/.gitignore">src/vendor/re2/.gitignore</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -2,3 +2,4 @@
</a> *.orig
 core
 obj/
<a href="#h0-0-3" id="h0-0-3" class="i">+benchlog.*
</a><b>diff --git a/<a id="h1" href="../file/src/vendor/re2/BUILD">src/vendor/re2/BUILD</a> b/<a href="../file/src/vendor/re2/BUILD">src/vendor/re2/BUILD</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -0,0 +1,134 @@
</a><a href="#h1-0-0" id="h1-0-0" class="i">+# Copyright 2009 The RE2 Authors.  All Rights Reserved.
</a><a href="#h1-0-1" id="h1-0-1" class="i">+# Use of this source code is governed by a BSD-style
</a><a href="#h1-0-2" id="h1-0-2" class="i">+# license that can be found in the LICENSE file.
</a><a href="#h1-0-3" id="h1-0-3" class="i">+
</a><a href="#h1-0-4" id="h1-0-4" class="i">+# Bazel (http://bazel.io/) BUILD file for RE2.
</a><a href="#h1-0-5" id="h1-0-5" class="i">+
</a><a href="#h1-0-6" id="h1-0-6" class="i">+licenses([&quot;notice&quot;])
</a><a href="#h1-0-7" id="h1-0-7" class="i">+
</a><a href="#h1-0-8" id="h1-0-8" class="i">+# stringpiece is a standalone library so that it can be used without pulling in
</a><a href="#h1-0-9" id="h1-0-9" class="i">+# all of the other parts of RE2.
</a><a href="#h1-0-10" id="h1-0-10" class="i">+cc_library(
</a><a href="#h1-0-11" id="h1-0-11" class="i">+    name = &quot;stringpiece&quot;,
</a><a href="#h1-0-12" id="h1-0-12" class="i">+    srcs = [&quot;re2/stringpiece.cc&quot;],
</a><a href="#h1-0-13" id="h1-0-13" class="i">+    hdrs = [&quot;re2/stringpiece.h&quot;],
</a><a href="#h1-0-14" id="h1-0-14" class="i">+    includes = [&quot;.&quot;],
</a><a href="#h1-0-15" id="h1-0-15" class="i">+    visibility = [&quot;//visibility:public&quot;],
</a><a href="#h1-0-16" id="h1-0-16" class="i">+)
</a><a href="#h1-0-17" id="h1-0-17" class="i">+
</a><a href="#h1-0-18" id="h1-0-18" class="i">+cc_library(
</a><a href="#h1-0-19" id="h1-0-19" class="i">+    name = &quot;re2&quot;,
</a><a href="#h1-0-20" id="h1-0-20" class="i">+    srcs = [
</a><a href="#h1-0-21" id="h1-0-21" class="i">+        &quot;re2/bitstate.cc&quot;,
</a><a href="#h1-0-22" id="h1-0-22" class="i">+        &quot;re2/compile.cc&quot;,
</a><a href="#h1-0-23" id="h1-0-23" class="i">+        &quot;re2/dfa.cc&quot;,
</a><a href="#h1-0-24" id="h1-0-24" class="i">+        &quot;re2/filtered_re2.cc&quot;,
</a><a href="#h1-0-25" id="h1-0-25" class="i">+        &quot;re2/mimics_pcre.cc&quot;,
</a><a href="#h1-0-26" id="h1-0-26" class="i">+        &quot;re2/nfa.cc&quot;,
</a><a href="#h1-0-27" id="h1-0-27" class="i">+        &quot;re2/onepass.cc&quot;,
</a><a href="#h1-0-28" id="h1-0-28" class="i">+        &quot;re2/parse.cc&quot;,
</a><a href="#h1-0-29" id="h1-0-29" class="i">+        &quot;re2/perl_groups.cc&quot;,
</a><a href="#h1-0-30" id="h1-0-30" class="i">+        &quot;re2/prefilter.cc&quot;,
</a><a href="#h1-0-31" id="h1-0-31" class="i">+        &quot;re2/prefilter.h&quot;,
</a><a href="#h1-0-32" id="h1-0-32" class="i">+        &quot;re2/prefilter_tree.cc&quot;,
</a><a href="#h1-0-33" id="h1-0-33" class="i">+        &quot;re2/prefilter_tree.h&quot;,
</a><a href="#h1-0-34" id="h1-0-34" class="i">+        &quot;re2/prog.cc&quot;,
</a><a href="#h1-0-35" id="h1-0-35" class="i">+        &quot;re2/prog.h&quot;,
</a><a href="#h1-0-36" id="h1-0-36" class="i">+        &quot;re2/re2.cc&quot;,
</a><a href="#h1-0-37" id="h1-0-37" class="i">+        &quot;re2/regexp.cc&quot;,
</a><a href="#h1-0-38" id="h1-0-38" class="i">+        &quot;re2/regexp.h&quot;,
</a><a href="#h1-0-39" id="h1-0-39" class="i">+        &quot;re2/set.cc&quot;,
</a><a href="#h1-0-40" id="h1-0-40" class="i">+        &quot;re2/simplify.cc&quot;,
</a><a href="#h1-0-41" id="h1-0-41" class="i">+        &quot;re2/tostring.cc&quot;,
</a><a href="#h1-0-42" id="h1-0-42" class="i">+        &quot;re2/unicode_casefold.cc&quot;,
</a><a href="#h1-0-43" id="h1-0-43" class="i">+        &quot;re2/unicode_casefold.h&quot;,
</a><a href="#h1-0-44" id="h1-0-44" class="i">+        &quot;re2/unicode_groups.cc&quot;,
</a><a href="#h1-0-45" id="h1-0-45" class="i">+        &quot;re2/unicode_groups.h&quot;,
</a><a href="#h1-0-46" id="h1-0-46" class="i">+        &quot;re2/walker-inl.h&quot;,
</a><a href="#h1-0-47" id="h1-0-47" class="i">+        &quot;util/atomicops.h&quot;,
</a><a href="#h1-0-48" id="h1-0-48" class="i">+        &quot;util/flags.h&quot;,
</a><a href="#h1-0-49" id="h1-0-49" class="i">+        &quot;util/hash.cc&quot;,
</a><a href="#h1-0-50" id="h1-0-50" class="i">+        &quot;util/logging.cc&quot;,
</a><a href="#h1-0-51" id="h1-0-51" class="i">+        &quot;util/logging.h&quot;,
</a><a href="#h1-0-52" id="h1-0-52" class="i">+        &quot;util/mutex.h&quot;,
</a><a href="#h1-0-53" id="h1-0-53" class="i">+        &quot;util/rune.cc&quot;,
</a><a href="#h1-0-54" id="h1-0-54" class="i">+        &quot;util/sparse_array.h&quot;,
</a><a href="#h1-0-55" id="h1-0-55" class="i">+        &quot;util/sparse_set.h&quot;,
</a><a href="#h1-0-56" id="h1-0-56" class="i">+        &quot;util/stringprintf.cc&quot;,
</a><a href="#h1-0-57" id="h1-0-57" class="i">+        &quot;util/strutil.cc&quot;,
</a><a href="#h1-0-58" id="h1-0-58" class="i">+        &quot;util/utf.h&quot;,
</a><a href="#h1-0-59" id="h1-0-59" class="i">+        &quot;util/util.h&quot;,
</a><a href="#h1-0-60" id="h1-0-60" class="i">+        &quot;util/valgrind.cc&quot;,
</a><a href="#h1-0-61" id="h1-0-61" class="i">+        &quot;util/valgrind.h&quot;,
</a><a href="#h1-0-62" id="h1-0-62" class="i">+    ],
</a><a href="#h1-0-63" id="h1-0-63" class="i">+    hdrs = [
</a><a href="#h1-0-64" id="h1-0-64" class="i">+        &quot;re2/filtered_re2.h&quot;,
</a><a href="#h1-0-65" id="h1-0-65" class="i">+        &quot;re2/re2.h&quot;,
</a><a href="#h1-0-66" id="h1-0-66" class="i">+        &quot;re2/set.h&quot;,
</a><a href="#h1-0-67" id="h1-0-67" class="i">+        &quot;re2/variadic_function.h&quot;,
</a><a href="#h1-0-68" id="h1-0-68" class="i">+    ],
</a><a href="#h1-0-69" id="h1-0-69" class="i">+    includes = [&quot;.&quot;],
</a><a href="#h1-0-70" id="h1-0-70" class="i">+    linkopts = [&quot;-pthread&quot;],
</a><a href="#h1-0-71" id="h1-0-71" class="i">+    visibility = [&quot;//visibility:public&quot;],
</a><a href="#h1-0-72" id="h1-0-72" class="i">+    deps = [
</a><a href="#h1-0-73" id="h1-0-73" class="i">+        &quot;:stringpiece&quot;,
</a><a href="#h1-0-74" id="h1-0-74" class="i">+    ],
</a><a href="#h1-0-75" id="h1-0-75" class="i">+)
</a><a href="#h1-0-76" id="h1-0-76" class="i">+
</a><a href="#h1-0-77" id="h1-0-77" class="i">+cc_library(
</a><a href="#h1-0-78" id="h1-0-78" class="i">+    name = &quot;test&quot;,
</a><a href="#h1-0-79" id="h1-0-79" class="i">+    testonly = 1,
</a><a href="#h1-0-80" id="h1-0-80" class="i">+    srcs = [
</a><a href="#h1-0-81" id="h1-0-81" class="i">+        &quot;re2/testing/backtrack.cc&quot;,
</a><a href="#h1-0-82" id="h1-0-82" class="i">+        &quot;re2/testing/dump.cc&quot;,
</a><a href="#h1-0-83" id="h1-0-83" class="i">+        &quot;re2/testing/exhaustive_tester.cc&quot;,
</a><a href="#h1-0-84" id="h1-0-84" class="i">+        &quot;re2/testing/null_walker.cc&quot;,
</a><a href="#h1-0-85" id="h1-0-85" class="i">+        &quot;re2/testing/regexp_generator.cc&quot;,
</a><a href="#h1-0-86" id="h1-0-86" class="i">+        &quot;re2/testing/string_generator.cc&quot;,
</a><a href="#h1-0-87" id="h1-0-87" class="i">+        &quot;re2/testing/tester.cc&quot;,
</a><a href="#h1-0-88" id="h1-0-88" class="i">+        &quot;util/pcre.cc&quot;,
</a><a href="#h1-0-89" id="h1-0-89" class="i">+        &quot;util/random.cc&quot;,
</a><a href="#h1-0-90" id="h1-0-90" class="i">+        &quot;util/test.cc&quot;,
</a><a href="#h1-0-91" id="h1-0-91" class="i">+        &quot;util/thread.cc&quot;,
</a><a href="#h1-0-92" id="h1-0-92" class="i">+    ],
</a><a href="#h1-0-93" id="h1-0-93" class="i">+    hdrs = [
</a><a href="#h1-0-94" id="h1-0-94" class="i">+        &quot;re2/testing/exhaustive_tester.h&quot;,
</a><a href="#h1-0-95" id="h1-0-95" class="i">+        &quot;re2/testing/regexp_generator.h&quot;,
</a><a href="#h1-0-96" id="h1-0-96" class="i">+        &quot;re2/testing/string_generator.h&quot;,
</a><a href="#h1-0-97" id="h1-0-97" class="i">+        &quot;re2/testing/tester.h&quot;,
</a><a href="#h1-0-98" id="h1-0-98" class="i">+        &quot;util/pcre.h&quot;,
</a><a href="#h1-0-99" id="h1-0-99" class="i">+        &quot;util/random.h&quot;,
</a><a href="#h1-0-100" id="h1-0-100" class="i">+        &quot;util/test.h&quot;,
</a><a href="#h1-0-101" id="h1-0-101" class="i">+        &quot;util/thread.h&quot;,
</a><a href="#h1-0-102" id="h1-0-102" class="i">+    ],
</a><a href="#h1-0-103" id="h1-0-103" class="i">+    includes = [&quot;.&quot;],
</a><a href="#h1-0-104" id="h1-0-104" class="i">+    deps = [
</a><a href="#h1-0-105" id="h1-0-105" class="i">+        &quot;:re2&quot;,
</a><a href="#h1-0-106" id="h1-0-106" class="i">+    ],
</a><a href="#h1-0-107" id="h1-0-107" class="i">+)
</a><a href="#h1-0-108" id="h1-0-108" class="i">+
</a><a href="#h1-0-109" id="h1-0-109" class="i">+load(&quot;re2_test&quot;, &quot;re2_test&quot;)
</a><a href="#h1-0-110" id="h1-0-110" class="i">+
</a><a href="#h1-0-111" id="h1-0-111" class="i">+re2_test(&quot;charclass_test&quot;)
</a><a href="#h1-0-112" id="h1-0-112" class="i">+re2_test(&quot;compile_test&quot;)
</a><a href="#h1-0-113" id="h1-0-113" class="i">+re2_test(&quot;filtered_re2_test&quot;)
</a><a href="#h1-0-114" id="h1-0-114" class="i">+re2_test(&quot;mimics_pcre_test&quot;)
</a><a href="#h1-0-115" id="h1-0-115" class="i">+re2_test(&quot;parse_test&quot;)
</a><a href="#h1-0-116" id="h1-0-116" class="i">+re2_test(&quot;possible_match_test&quot;)
</a><a href="#h1-0-117" id="h1-0-117" class="i">+re2_test(&quot;re2_test&quot;)
</a><a href="#h1-0-118" id="h1-0-118" class="i">+re2_test(&quot;re2_arg_test&quot;)
</a><a href="#h1-0-119" id="h1-0-119" class="i">+re2_test(&quot;regexp_test&quot;)
</a><a href="#h1-0-120" id="h1-0-120" class="i">+re2_test(&quot;required_prefix_test&quot;)
</a><a href="#h1-0-121" id="h1-0-121" class="i">+re2_test(&quot;search_test&quot;)
</a><a href="#h1-0-122" id="h1-0-122" class="i">+re2_test(&quot;set_test&quot;)
</a><a href="#h1-0-123" id="h1-0-123" class="i">+re2_test(&quot;simplify_test&quot;)
</a><a href="#h1-0-124" id="h1-0-124" class="i">+re2_test(&quot;string_generator_test&quot;)
</a><a href="#h1-0-125" id="h1-0-125" class="i">+
</a><a href="#h1-0-126" id="h1-0-126" class="i">+re2_test(&quot;dfa_test&quot;)
</a><a href="#h1-0-127" id="h1-0-127" class="i">+re2_test(&quot;exhaustive1_test&quot;)
</a><a href="#h1-0-128" id="h1-0-128" class="i">+re2_test(&quot;exhaustive2_test&quot;)
</a><a href="#h1-0-129" id="h1-0-129" class="i">+re2_test(&quot;exhaustive3_test&quot;)
</a><a href="#h1-0-130" id="h1-0-130" class="i">+re2_test(&quot;exhaustive_test&quot;)
</a><a href="#h1-0-131" id="h1-0-131" class="i">+re2_test(&quot;random_test&quot;)
</a><a href="#h1-0-132" id="h1-0-132" class="i">+
</a><a href="#h1-0-133" id="h1-0-133" class="i">+# TODO: Add support for regexp_benchmark.
</a><b>diff --git a/<a id="h2" href="../file/src/vendor/re2/CMakeLists.txt">src/vendor/re2/CMakeLists.txt</a> b/<a href="../file/src/vendor/re2/CMakeLists.txt">src/vendor/re2/CMakeLists.txt</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -0,0 +1,112 @@
</a><a href="#h2-0-0" id="h2-0-0" class="i">+# Copyright 2015 The RE2 Authors.  All Rights Reserved.
</a><a href="#h2-0-1" id="h2-0-1" class="i">+# Use of this source code is governed by a BSD-style
</a><a href="#h2-0-2" id="h2-0-2" class="i">+# license that can be found in the LICENSE file.
</a><a href="#h2-0-3" id="h2-0-3" class="i">+
</a><a href="#h2-0-4" id="h2-0-4" class="i">+# Old enough to support Ubuntu Precise.
</a><a href="#h2-0-5" id="h2-0-5" class="i">+cmake_minimum_required(VERSION 2.8.7)
</a><a href="#h2-0-6" id="h2-0-6" class="i">+
</a><a href="#h2-0-7" id="h2-0-7" class="i">+project(RE2 CXX)
</a><a href="#h2-0-8" id="h2-0-8" class="i">+option(BUILD_SHARED_LIBS &quot;build shared libraries&quot; OFF)
</a><a href="#h2-0-9" id="h2-0-9" class="i">+option(USEPCRE &quot;use PCRE in tests and benchmarks&quot; OFF)
</a><a href="#h2-0-10" id="h2-0-10" class="i">+
</a><a href="#h2-0-11" id="h2-0-11" class="i">+set(EXTRA_TARGET_LINK_LIBRARIES)
</a><a href="#h2-0-12" id="h2-0-12" class="i">+
</a><a href="#h2-0-13" id="h2-0-13" class="i">+if(WIN32)
</a><a href="#h2-0-14" id="h2-0-14" class="i">+  add_definitions(-DUNICODE -D_UNICODE -DSTRICT -DNOMINMAX)
</a><a href="#h2-0-15" id="h2-0-15" class="i">+  set(THREADING threadwin)
</a><a href="#h2-0-16" id="h2-0-16" class="i">+else()
</a><a href="#h2-0-17" id="h2-0-17" class="i">+  set(THREADING thread)
</a><a href="#h2-0-18" id="h2-0-18" class="i">+  list(APPEND EXTRA_TARGET_LINK_LIBRARIES -pthread)
</a><a href="#h2-0-19" id="h2-0-19" class="i">+endif()
</a><a href="#h2-0-20" id="h2-0-20" class="i">+
</a><a href="#h2-0-21" id="h2-0-21" class="i">+if(USEPCRE)
</a><a href="#h2-0-22" id="h2-0-22" class="i">+  add_definitions(-DUSEPCRE)
</a><a href="#h2-0-23" id="h2-0-23" class="i">+  list(APPEND EXTRA_TARGET_LINK_LIBRARIES pcre)
</a><a href="#h2-0-24" id="h2-0-24" class="i">+endif()
</a><a href="#h2-0-25" id="h2-0-25" class="i">+
</a><a href="#h2-0-26" id="h2-0-26" class="i">+include_directories(${CMAKE_SOURCE_DIR})
</a><a href="#h2-0-27" id="h2-0-27" class="i">+
</a><a href="#h2-0-28" id="h2-0-28" class="i">+set(RE2_LIBRARY_SOURCES
</a><a href="#h2-0-29" id="h2-0-29" class="i">+    re2/bitstate.cc
</a><a href="#h2-0-30" id="h2-0-30" class="i">+    re2/compile.cc
</a><a href="#h2-0-31" id="h2-0-31" class="i">+    re2/dfa.cc
</a><a href="#h2-0-32" id="h2-0-32" class="i">+    re2/filtered_re2.cc
</a><a href="#h2-0-33" id="h2-0-33" class="i">+    re2/mimics_pcre.cc
</a><a href="#h2-0-34" id="h2-0-34" class="i">+    re2/nfa.cc
</a><a href="#h2-0-35" id="h2-0-35" class="i">+    re2/onepass.cc
</a><a href="#h2-0-36" id="h2-0-36" class="i">+    re2/parse.cc
</a><a href="#h2-0-37" id="h2-0-37" class="i">+    re2/perl_groups.cc
</a><a href="#h2-0-38" id="h2-0-38" class="i">+    re2/prefilter.cc
</a><a href="#h2-0-39" id="h2-0-39" class="i">+    re2/prefilter_tree.cc
</a><a href="#h2-0-40" id="h2-0-40" class="i">+    re2/prog.cc
</a><a href="#h2-0-41" id="h2-0-41" class="i">+    re2/re2.cc
</a><a href="#h2-0-42" id="h2-0-42" class="i">+    re2/regexp.cc
</a><a href="#h2-0-43" id="h2-0-43" class="i">+    re2/set.cc
</a><a href="#h2-0-44" id="h2-0-44" class="i">+    re2/simplify.cc
</a><a href="#h2-0-45" id="h2-0-45" class="i">+    re2/stringpiece.cc
</a><a href="#h2-0-46" id="h2-0-46" class="i">+    re2/tostring.cc
</a><a href="#h2-0-47" id="h2-0-47" class="i">+    re2/unicode_casefold.cc
</a><a href="#h2-0-48" id="h2-0-48" class="i">+    re2/unicode_groups.cc
</a><a href="#h2-0-49" id="h2-0-49" class="i">+    util/hash.cc
</a><a href="#h2-0-50" id="h2-0-50" class="i">+    util/logging.cc
</a><a href="#h2-0-51" id="h2-0-51" class="i">+    util/rune.cc
</a><a href="#h2-0-52" id="h2-0-52" class="i">+    util/stringprintf.cc
</a><a href="#h2-0-53" id="h2-0-53" class="i">+    util/strutil.cc
</a><a href="#h2-0-54" id="h2-0-54" class="i">+    util/valgrind.cc
</a><a href="#h2-0-55" id="h2-0-55" class="i">+    )
</a><a href="#h2-0-56" id="h2-0-56" class="i">+
</a><a href="#h2-0-57" id="h2-0-57" class="i">+add_library(re2 ${RE2_LIBRARY_SOURCES})
</a><a href="#h2-0-58" id="h2-0-58" class="i">+
</a><a href="#h2-0-59" id="h2-0-59" class="i">+set(TEST_LIBRARY_SOURCES
</a><a href="#h2-0-60" id="h2-0-60" class="i">+    re2/testing/backtrack.cc
</a><a href="#h2-0-61" id="h2-0-61" class="i">+    re2/testing/dump.cc
</a><a href="#h2-0-62" id="h2-0-62" class="i">+    re2/testing/exhaustive_tester.cc
</a><a href="#h2-0-63" id="h2-0-63" class="i">+    re2/testing/null_walker.cc
</a><a href="#h2-0-64" id="h2-0-64" class="i">+    re2/testing/regexp_generator.cc
</a><a href="#h2-0-65" id="h2-0-65" class="i">+    re2/testing/string_generator.cc
</a><a href="#h2-0-66" id="h2-0-66" class="i">+    re2/testing/tester.cc
</a><a href="#h2-0-67" id="h2-0-67" class="i">+    util/pcre.cc
</a><a href="#h2-0-68" id="h2-0-68" class="i">+    util/random.cc
</a><a href="#h2-0-69" id="h2-0-69" class="i">+    util/${THREADING}.cc
</a><a href="#h2-0-70" id="h2-0-70" class="i">+    )
</a><a href="#h2-0-71" id="h2-0-71" class="i">+
</a><a href="#h2-0-72" id="h2-0-72" class="i">+add_library(test STATIC ${TEST_LIBRARY_SOURCES} util/test.cc)
</a><a href="#h2-0-73" id="h2-0-73" class="i">+add_library(benchmark STATIC ${TEST_LIBRARY_SOURCES} util/benchmark.cc)
</a><a href="#h2-0-74" id="h2-0-74" class="i">+
</a><a href="#h2-0-75" id="h2-0-75" class="i">+set(TEST_TARGETS
</a><a href="#h2-0-76" id="h2-0-76" class="i">+    charclass_test
</a><a href="#h2-0-77" id="h2-0-77" class="i">+    compile_test
</a><a href="#h2-0-78" id="h2-0-78" class="i">+    filtered_re2_test
</a><a href="#h2-0-79" id="h2-0-79" class="i">+    mimics_pcre_test
</a><a href="#h2-0-80" id="h2-0-80" class="i">+    parse_test
</a><a href="#h2-0-81" id="h2-0-81" class="i">+    possible_match_test
</a><a href="#h2-0-82" id="h2-0-82" class="i">+    re2_test
</a><a href="#h2-0-83" id="h2-0-83" class="i">+    re2_arg_test
</a><a href="#h2-0-84" id="h2-0-84" class="i">+    regexp_test
</a><a href="#h2-0-85" id="h2-0-85" class="i">+    required_prefix_test
</a><a href="#h2-0-86" id="h2-0-86" class="i">+    search_test
</a><a href="#h2-0-87" id="h2-0-87" class="i">+    set_test
</a><a href="#h2-0-88" id="h2-0-88" class="i">+    simplify_test
</a><a href="#h2-0-89" id="h2-0-89" class="i">+    string_generator_test
</a><a href="#h2-0-90" id="h2-0-90" class="i">+
</a><a href="#h2-0-91" id="h2-0-91" class="i">+    dfa_test
</a><a href="#h2-0-92" id="h2-0-92" class="i">+    exhaustive1_test
</a><a href="#h2-0-93" id="h2-0-93" class="i">+    exhaustive2_test
</a><a href="#h2-0-94" id="h2-0-94" class="i">+    exhaustive3_test
</a><a href="#h2-0-95" id="h2-0-95" class="i">+    exhaustive_test
</a><a href="#h2-0-96" id="h2-0-96" class="i">+    random_test
</a><a href="#h2-0-97" id="h2-0-97" class="i">+    )
</a><a href="#h2-0-98" id="h2-0-98" class="i">+
</a><a href="#h2-0-99" id="h2-0-99" class="i">+set(BENCHMARK_TARGETS
</a><a href="#h2-0-100" id="h2-0-100" class="i">+    regexp_benchmark
</a><a href="#h2-0-101" id="h2-0-101" class="i">+    )
</a><a href="#h2-0-102" id="h2-0-102" class="i">+
</a><a href="#h2-0-103" id="h2-0-103" class="i">+foreach(target ${TEST_TARGETS})
</a><a href="#h2-0-104" id="h2-0-104" class="i">+  add_executable(${target} re2/testing/${target}.cc)
</a><a href="#h2-0-105" id="h2-0-105" class="i">+  target_link_libraries(${target} test re2 ${EXTRA_TARGET_LINK_LIBRARIES})
</a><a href="#h2-0-106" id="h2-0-106" class="i">+endforeach(target)
</a><a href="#h2-0-107" id="h2-0-107" class="i">+
</a><a href="#h2-0-108" id="h2-0-108" class="i">+foreach(target ${BENCHMARK_TARGETS})
</a><a href="#h2-0-109" id="h2-0-109" class="i">+  add_executable(${target} re2/testing/${target}.cc)
</a><a href="#h2-0-110" id="h2-0-110" class="i">+  target_link_libraries(${target} benchmark re2 ${EXTRA_TARGET_LINK_LIBRARIES})
</a><a href="#h2-0-111" id="h2-0-111" class="i">+endforeach(target)
</a><b>diff --git a/<a id="h3" href="../file/src/vendor/re2/Makefile">src/vendor/re2/Makefile</a> b/<a href="../file/src/vendor/re2/Makefile">src/vendor/re2/Makefile</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -2,8 +2,6 @@
</a> # Use of this source code is governed by a BSD-style
 # license that can be found in the LICENSE file.
 
<a href="#h3-0-3" id="h3-0-3" class="d">-all: obj/libre2.a obj/so/libre2.so
</a><a href="#h3-0-4" id="h3-0-4" class="d">-
</a> # to build against PCRE for testing or benchmarking,
 # uncomment the next two lines
 # CCPCRE=-I/usr/local/include -DUSEPCRE
<a href="#h3-1" id="h3-1" class="h">@@ -12,7 +10,7 @@ all: obj/libre2.a obj/so/libre2.so
</a> CXX?=g++
 CXXFLAGS?=-Wall -O3 -g -pthread # can override
 RE2_CXXFLAGS?=-Wsign-compare -c -I. $(CCPCRE)  # required
<a href="#h3-1-3" id="h3-1-3" class="d">-LDFLAGS?=
</a><a href="#h3-1-4" id="h3-1-4" class="i">+LDFLAGS?=-pthread
</a> AR?=ar
 ARFLAGS?=rsc
 NM?=nm
<a href="#h3-2" id="h3-2" class="h">@@ -38,11 +36,24 @@ SONAME=0
</a> # REBUILD_TABLES=1
 
 ifeq ($(shell uname),Darwin)
<a href="#h3-2-3" id="h3-2-3" class="d">-MAKE_SHARED_LIBRARY=$(CXX) -dynamiclib $(LDFLAGS) -exported_symbols_list libre2.symbols.darwin
</a><a href="#h3-2-4" id="h3-2-4" class="i">+SOEXT=dylib
</a><a href="#h3-2-5" id="h3-2-5" class="i">+SOEXTVER=$(SONAME).$(SOEXT)
</a><a href="#h3-2-6" id="h3-2-6" class="i">+SOEXTVER00=$(SONAME).0.0.$(SOEXT)
</a><a href="#h3-2-7" id="h3-2-7" class="i">+MAKE_SHARED_LIBRARY=$(CXX) -dynamiclib $(LDFLAGS) -Wl,-install_name,@rpath/libre2.$(SOEXTVER) -exported_symbols_list libre2.symbols.darwin
</a><a href="#h3-2-8" id="h3-2-8" class="i">+else ifeq ($(shell uname),SunOS)
</a><a href="#h3-2-9" id="h3-2-9" class="i">+SOEXT=so
</a><a href="#h3-2-10" id="h3-2-10" class="i">+SOEXTVER=$(SOEXT).$(SONAME)
</a><a href="#h3-2-11" id="h3-2-11" class="i">+SOEXTVER00=$(SOEXT).$(SONAME).0.0
</a><a href="#h3-2-12" id="h3-2-12" class="i">+MAKE_SHARED_LIBRARY=$(CXX) -shared -Wl,-soname,libre2.$(SOEXTVER),-M,libre2.symbols $(LDFLAGS)
</a> else
<a href="#h3-2-14" id="h3-2-14" class="d">-MAKE_SHARED_LIBRARY=$(CXX) -shared -Wl,-soname,libre2.so.$(SONAME),--version-script=libre2.symbols $(LDFLAGS)
</a><a href="#h3-2-15" id="h3-2-15" class="i">+SOEXT=so
</a><a href="#h3-2-16" id="h3-2-16" class="i">+SOEXTVER=$(SOEXT).$(SONAME)
</a><a href="#h3-2-17" id="h3-2-17" class="i">+SOEXTVER00=$(SOEXT).$(SONAME).0.0
</a><a href="#h3-2-18" id="h3-2-18" class="i">+MAKE_SHARED_LIBRARY=$(CXX) -shared -Wl,-soname,libre2.$(SOEXTVER),--version-script,libre2.symbols $(LDFLAGS)
</a> endif
 
<a href="#h3-2-21" id="h3-2-21" class="i">+all: obj/libre2.a obj/so/libre2.$(SOEXT)
</a><a href="#h3-2-22" id="h3-2-22" class="i">+
</a> INSTALL_HFILES=\
 	re2/filtered_re2.h\
 	re2/re2.h\
<a href="#h3-3" id="h3-3" class="h">@@ -51,7 +62,6 @@ INSTALL_HFILES=\
</a> 	re2/variadic_function.h\
 
 HFILES=\
<a href="#h3-3-3" id="h3-3-3" class="d">-	util/arena.h\
</a> 	util/atomicops.h\
 	util/benchmark.h\
 	util/flags.h\
<a href="#h3-4" id="h3-4" class="h">@@ -62,6 +72,7 @@ HFILES=\
</a> 	util/sparse_array.h\
 	util/sparse_set.h\
 	util/test.h\
<a href="#h3-4-3" id="h3-4-3" class="i">+	util/thread.h\
</a> 	util/utf.h\
 	util/util.h\
 	util/valgrind.h\
<a href="#h3-5" id="h3-5" class="h">@@ -83,10 +94,9 @@ HFILES=\
</a> 	re2/walker-inl.h\
 
 OFILES=\
<a href="#h3-5-3" id="h3-5-3" class="d">-	obj/util/arena.o\
</a> 	obj/util/hash.o\
<a href="#h3-5-5" id="h3-5-5" class="i">+	obj/util/logging.o\
</a> 	obj/util/rune.o\
<a href="#h3-5-7" id="h3-5-7" class="d">-	obj/util/stringpiece.o\
</a> 	obj/util/stringprintf.o\
 	obj/util/strutil.o\
 	obj/util/valgrind.o\
<a href="#h3-6" id="h3-6" class="h">@@ -106,6 +116,7 @@ OFILES=\
</a> 	obj/re2/regexp.o\
 	obj/re2/set.o\
 	obj/re2/simplify.o\
<a href="#h3-6-3" id="h3-6-3" class="i">+	obj/re2/stringpiece.o\
</a> 	obj/re2/tostring.o\
 	obj/re2/unicode_casefold.o\
 	obj/re2/unicode_groups.o\
<a href="#h3-7" id="h3-7" class="h">@@ -176,10 +187,10 @@ obj/dbg/libre2.a: $(DOFILES)
</a> 	@mkdir -p obj/dbg
 	$(AR) $(ARFLAGS) obj/dbg/libre2.a $(DOFILES)
 
<a href="#h3-7-3" id="h3-7-3" class="d">-obj/so/libre2.so: $(SOFILES)
</a><a href="#h3-7-4" id="h3-7-4" class="i">+obj/so/libre2.$(SOEXT): $(SOFILES)
</a> 	@mkdir -p obj/so
<a href="#h3-7-6" id="h3-7-6" class="d">-	$(MAKE_SHARED_LIBRARY) -o $@.$(SONAME) $(SOFILES)
</a><a href="#h3-7-7" id="h3-7-7" class="d">-	ln -sf libre2.so.$(SONAME) $@
</a><a href="#h3-7-8" id="h3-7-8" class="i">+	$(MAKE_SHARED_LIBRARY) -o obj/so/libre2.$(SOEXTVER) $(SOFILES)
</a><a href="#h3-7-9" id="h3-7-9" class="i">+	ln -sf libre2.$(SOEXTVER) $@
</a> 
 obj/test/%: obj/libre2.a obj/re2/testing/%.o $(TESTOFILES) obj/util/test.o
 	@mkdir -p obj/test
<a href="#h3-8" id="h3-8" class="h">@@ -189,7 +200,7 @@ obj/dbg/test/%: obj/dbg/libre2.a obj/dbg/re2/testing/%.o $(DTESTOFILES) obj/dbg/
</a> 	@mkdir -p obj/dbg/test
 	$(CXX) -o $@ obj/dbg/re2/testing/$*.o $(DTESTOFILES) obj/dbg/util/test.o obj/dbg/libre2.a $(LDFLAGS) $(LDPCRE)
 
<a href="#h3-8-3" id="h3-8-3" class="d">-obj/so/test/%: obj/so/libre2.so obj/libre2.a obj/so/re2/testing/%.o $(STESTOFILES) obj/so/util/test.o
</a><a href="#h3-8-4" id="h3-8-4" class="i">+obj/so/test/%: obj/so/libre2.$(SOEXT) obj/libre2.a obj/so/re2/testing/%.o $(STESTOFILES) obj/so/util/test.o
</a> 	@mkdir -p obj/so/test
 	$(CXX) -o $@ obj/so/re2/testing/$*.o $(STESTOFILES) obj/so/util/test.o -Lobj/so -lre2 obj/libre2.a $(LDFLAGS) $(LDPCRE)
 
<a href="#h3-9" id="h3-9" class="h">@@ -203,6 +214,8 @@ re2/perl_groups.cc: re2/make_perl_groups.pl
</a> 
 re2/unicode_%.cc: re2/make_unicode_%.py
 	python $&lt; &gt; $@
<a href="#h3-9-3" id="h3-9-3" class="i">+
</a><a href="#h3-9-4" id="h3-9-4" class="i">+.PRECIOUS: re2/perl_groups.cc re2/unicode_casefold.cc re2/unicode_groups.cc
</a> endif
 
 distclean: clean
<a href="#h3-10" id="h3-10" class="h">@@ -245,23 +258,28 @@ shared-bigtest: $(STESTS) $(SBIGTESTS)
</a> 
 benchmark: obj/test/regexp_benchmark
 
<a href="#h3-10-3" id="h3-10-3" class="d">-install: obj/libre2.a obj/so/libre2.so
</a><a href="#h3-10-4" id="h3-10-4" class="d">-	mkdir -p $(DESTDIR)$(includedir)/re2 $(DESTDIR)$(libdir)
</a><a href="#h3-10-5" id="h3-10-5" class="i">+install: obj/libre2.a obj/so/libre2.$(SOEXT)
</a><a href="#h3-10-6" id="h3-10-6" class="i">+	mkdir -p $(DESTDIR)$(includedir)/re2 $(DESTDIR)$(libdir)/pkgconfig
</a> 	$(INSTALL_DATA) $(INSTALL_HFILES) $(DESTDIR)$(includedir)/re2
 	$(INSTALL) obj/libre2.a $(DESTDIR)$(libdir)/libre2.a
<a href="#h3-10-9" id="h3-10-9" class="d">-	$(INSTALL) obj/so/libre2.so $(DESTDIR)$(libdir)/libre2.so.$(SONAME).0.0
</a><a href="#h3-10-10" id="h3-10-10" class="d">-	ln -sf libre2.so.$(SONAME).0.0 $(DESTDIR)$(libdir)/libre2.so.$(SONAME)
</a><a href="#h3-10-11" id="h3-10-11" class="d">-	ln -sf libre2.so.$(SONAME).0.0 $(DESTDIR)$(libdir)/libre2.so
</a><a href="#h3-10-12" id="h3-10-12" class="i">+	$(INSTALL) obj/so/libre2.$(SOEXT) $(DESTDIR)$(libdir)/libre2.$(SOEXTVER00)
</a><a href="#h3-10-13" id="h3-10-13" class="i">+	ln -sf libre2.$(SOEXTVER00) $(DESTDIR)$(libdir)/libre2.$(SOEXTVER)
</a><a href="#h3-10-14" id="h3-10-14" class="i">+	ln -sf libre2.$(SOEXTVER00) $(DESTDIR)$(libdir)/libre2.$(SOEXT)
</a><a href="#h3-10-15" id="h3-10-15" class="i">+	sed -e &quot;s#@prefix@#${prefix}#&quot; re2.pc &gt;$(DESTDIR)$(libdir)/pkgconfig/re2.pc
</a> 
 testinstall:
 	@mkdir -p obj
 	cp testinstall.cc obj
<a href="#h3-10-20" id="h3-10-20" class="i">+ifneq ($(shell uname),Darwin)
</a><a href="#h3-10-21" id="h3-10-21" class="i">+	(cd obj &amp;&amp; $(CXX) -I$(DESTDIR)$(includedir) -L$(DESTDIR)$(libdir) testinstall.cc -lre2 -pthread -static -o testinstall)
</a><a href="#h3-10-22" id="h3-10-22" class="i">+	obj/testinstall
</a><a href="#h3-10-23" id="h3-10-23" class="i">+endif
</a> 	(cd obj &amp;&amp; $(CXX) -I$(DESTDIR)$(includedir) -L$(DESTDIR)$(libdir) testinstall.cc -lre2 -pthread -o testinstall)
 	LD_LIBRARY_PATH=$(DESTDIR)$(libdir) obj/testinstall
 
 benchlog: obj/test/regexp_benchmark
 	(echo &#39;==BENCHMARK==&#39; `hostname` `date`; \
<a href="#h3-10-29" id="h3-10-29" class="d">-	  (uname -a; $(CXX) --version; hg identify; file obj/test/regexp_benchmark) | sed &#39;s/^/# /&#39;; \
</a><a href="#h3-10-30" id="h3-10-30" class="i">+	  (uname -a; $(CXX) --version; git rev-parse --short HEAD; file obj/test/regexp_benchmark) | sed &#39;s/^/# /&#39;; \
</a> 	  echo; \
 	  ./obj/test/regexp_benchmark &#39;PCRE|RE2&#39;) | tee -a benchlog.$$(hostname | sed &#39;s/\..*//&#39;)
 
<a href="#h3-11" id="h3-11" class="h">@@ -273,8 +291,9 @@ benchlog: obj/test/regexp_benchmark
</a> 	obj/test/% obj/so/test/% obj/dbg/test/%
 
 log:
<a href="#h3-11-3" id="h3-11-3" class="d">-	make clean
</a><a href="#h3-11-4" id="h3-11-4" class="d">-	make CXXFLAGS=&quot;$(CXXFLAGS) -DLOGGING=1&quot; obj/test/exhaustive{,1,2,3}_test
</a><a href="#h3-11-5" id="h3-11-5" class="i">+	$(MAKE) clean
</a><a href="#h3-11-6" id="h3-11-6" class="i">+	$(MAKE) CXXFLAGS=&quot;$(CXXFLAGS) -DLOGGING=1&quot; \
</a><a href="#h3-11-7" id="h3-11-7" class="i">+		$(filter obj/test/exhaustive%_test,$(BIGTESTS))
</a> 	echo &#39;#&#39; RE2 exhaustive tests built by make log &gt;re2-exhaustive.txt
 	echo &#39;#&#39; $$(date) &gt;&gt;re2-exhaustive.txt
 	obj/test/exhaustive_test |grep -v &#39;^PASS$$&#39; &gt;&gt;re2-exhaustive.txt
<a href="#h3-12" id="h3-12" class="h">@@ -282,7 +301,7 @@ log:
</a> 	obj/test/exhaustive2_test |grep -v &#39;^PASS$$&#39; &gt;&gt;re2-exhaustive.txt
 	obj/test/exhaustive3_test |grep -v &#39;^PASS$$&#39; &gt;&gt;re2-exhaustive.txt
 
<a href="#h3-12-3" id="h3-12-3" class="d">-	make CXXFLAGS=&quot;$(CXXFLAGS) -DLOGGING=1&quot; obj/test/search_test
</a><a href="#h3-12-4" id="h3-12-4" class="i">+	$(MAKE) CXXFLAGS=&quot;$(CXXFLAGS) -DLOGGING=1&quot; obj/test/search_test
</a> 	echo &#39;#&#39; RE2 basic search tests built by make $@ &gt;re2-search.txt
 	echo &#39;#&#39; $$(date) &gt;&gt;re2-search.txt
 	obj/test/search_test |grep -v &#39;^PASS$$&#39; &gt;&gt;re2-search.txt
<b>diff --git a/<a id="h4" href="../file/src/vendor/re2/README">src/vendor/re2/README</a> b/<a href="../file/src/vendor/re2/README">src/vendor/re2/README</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -1,7 +1,7 @@
</a> This is the source code repository for RE2, a regular expression library.
 
 For documentation about how to install and use RE2,
<a href="#h4-0-3" id="h4-0-3" class="d">-visit http://code.google.com/p/re2/.
</a><a href="#h4-0-4" id="h4-0-4" class="i">+visit https://github.com/google/re2/.
</a> 
 The short version is:
 
<a href="#h4-1" id="h4-1" class="h">@@ -10,10 +10,23 @@ make test
</a> make install
 make testinstall
 
<a href="#h4-1-3" id="h4-1-3" class="i">+More information can be found on the wiki:
</a><a href="#h4-1-4" id="h4-1-4" class="i">+https://github.com/google/re2/wiki
</a><a href="#h4-1-5" id="h4-1-5" class="i">+
</a><a href="#h4-1-6" id="h4-1-6" class="i">+Issue tracker:
</a><a href="#h4-1-7" id="h4-1-7" class="i">+https://github.com/google/re2/issues
</a><a href="#h4-1-8" id="h4-1-8" class="i">+
</a><a href="#h4-1-9" id="h4-1-9" class="i">+Mailing list:
</a><a href="#h4-1-10" id="h4-1-10" class="i">+https://groups.google.com/group/re2-dev
</a><a href="#h4-1-11" id="h4-1-11" class="i">+
</a> Unless otherwise noted, the RE2 source files are distributed
 under the BSD-style license found in the LICENSE file.
 
 RE2&#39;s native language is C++.
<a href="#h4-1-16" id="h4-1-16" class="d">-An Inferno wrapper is at http://code.google.com/p/inferno-re2/.
</a><a href="#h4-1-17" id="h4-1-17" class="d">-A Python wrapper is at http://github.com/facebook/pyre2/.
</a><a href="#h4-1-18" id="h4-1-18" class="d">-A Ruby wrapper is at http://github.com/axic/rre2/.
</a><a href="#h4-1-19" id="h4-1-19" class="i">+An Erlang wrapper is at https://github.com/tuncer/re2/.
</a><a href="#h4-1-20" id="h4-1-20" class="i">+An Inferno wrapper is at https://github.com/powerman/inferno-re2/.
</a><a href="#h4-1-21" id="h4-1-21" class="i">+A Node.js wrapper is at https://github.com/uhop/node-re2/ and on NPM.
</a><a href="#h4-1-22" id="h4-1-22" class="i">+An OCaml wrapper is at https://github.com/janestreet/re2/ and on OPAM.
</a><a href="#h4-1-23" id="h4-1-23" class="i">+A Perl wrapper is at https://github.com/dgl/re-engine-RE2/ and on CPAN.
</a><a href="#h4-1-24" id="h4-1-24" class="i">+A Python wrapper is at https://github.com/facebook/pyre2/.
</a><a href="#h4-1-25" id="h4-1-25" class="i">+A Ruby wrapper is at https://github.com/axic/rre2/.
</a><b>diff --git a/<a id="h5" href="../file/src/vendor/re2/benchlog/benchplot.py">src/vendor/re2/benchlog/benchplot.py</a> b/<a href="../file/src/vendor/re2/benchlog/benchplot.py">src/vendor/re2/benchlog/benchplot.py</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -0,0 +1,98 @@
</a><a href="#h5-0-0" id="h5-0-0" class="i">+#!/usr/bin/env python
</a><a href="#h5-0-1" id="h5-0-1" class="i">+
</a><a href="#h5-0-2" id="h5-0-2" class="i">+import argparse     # for ArgumentParser
</a><a href="#h5-0-3" id="h5-0-3" class="i">+import subprocess   # for Popen
</a><a href="#h5-0-4" id="h5-0-4" class="i">+import tempfile     # for NamedTemporaryFile
</a><a href="#h5-0-5" id="h5-0-5" class="i">+import os           # for remove
</a><a href="#h5-0-6" id="h5-0-6" class="i">+
</a><a href="#h5-0-7" id="h5-0-7" class="i">+class gnuplot(object):
</a><a href="#h5-0-8" id="h5-0-8" class="i">+
</a><a href="#h5-0-9" id="h5-0-9" class="i">+    output = &quot;result.png&quot;
</a><a href="#h5-0-10" id="h5-0-10" class="i">+
</a><a href="#h5-0-11" id="h5-0-11" class="i">+    script = &quot;&quot;&quot;
</a><a href="#h5-0-12" id="h5-0-12" class="i">+             set terminal png size 1024, 768
</a><a href="#h5-0-13" id="h5-0-13" class="i">+             set output &quot;{}.png&quot;
</a><a href="#h5-0-14" id="h5-0-14" class="i">+             set title &quot;re2 benchlog&quot;
</a><a href="#h5-0-15" id="h5-0-15" class="i">+             set datafile separator &quot;;&quot;
</a><a href="#h5-0-16" id="h5-0-16" class="i">+             set grid x y
</a><a href="#h5-0-17" id="h5-0-17" class="i">+             set ylabel &quot;MB/s&quot;
</a><a href="#h5-0-18" id="h5-0-18" class="i">+             set autoscale
</a><a href="#h5-0-19" id="h5-0-19" class="i">+             plot &quot;&quot;&quot;
</a><a href="#h5-0-20" id="h5-0-20" class="i">+
</a><a href="#h5-0-21" id="h5-0-21" class="i">+    template = &quot;&quot;&quot;&#39;{}&#39; using 1:5:xticlabels(2) with linespoints linewidth 3 title &quot;{}&quot;,\\\n&quot;&quot;&quot;
</a><a href="#h5-0-22" id="h5-0-22" class="i">+
</a><a href="#h5-0-23" id="h5-0-23" class="i">+    benchdata = dict()
</a><a href="#h5-0-24" id="h5-0-24" class="i">+    tempfiles = []
</a><a href="#h5-0-25" id="h5-0-25" class="i">+
</a><a href="#h5-0-26" id="h5-0-26" class="i">+    def __enter__(self):
</a><a href="#h5-0-27" id="h5-0-27" class="i">+        return self
</a><a href="#h5-0-28" id="h5-0-28" class="i">+
</a><a href="#h5-0-29" id="h5-0-29" class="i">+    def __exit__(self, type, value, traceback):
</a><a href="#h5-0-30" id="h5-0-30" class="i">+        &quot;&quot;&quot;
</a><a href="#h5-0-31" id="h5-0-31" class="i">+        remove all temporary files
</a><a href="#h5-0-32" id="h5-0-32" class="i">+        &quot;&quot;&quot;
</a><a href="#h5-0-33" id="h5-0-33" class="i">+
</a><a href="#h5-0-34" id="h5-0-34" class="i">+        for filename in self.tempfiles:
</a><a href="#h5-0-35" id="h5-0-35" class="i">+            os.remove(filename)
</a><a href="#h5-0-36" id="h5-0-36" class="i">+
</a><a href="#h5-0-37" id="h5-0-37" class="i">+    def parse_re2_benchlog(self, filename):
</a><a href="#h5-0-38" id="h5-0-38" class="i">+        &quot;&quot;&quot;
</a><a href="#h5-0-39" id="h5-0-39" class="i">+        parse the input benchlog and return a dictionary contain bench data
</a><a href="#h5-0-40" id="h5-0-40" class="i">+        &quot;&quot;&quot;
</a><a href="#h5-0-41" id="h5-0-41" class="i">+
</a><a href="#h5-0-42" id="h5-0-42" class="i">+        benchdata = self.benchdata
</a><a href="#h5-0-43" id="h5-0-43" class="i">+
</a><a href="#h5-0-44" id="h5-0-44" class="i">+        with open(filename) as f:
</a><a href="#h5-0-45" id="h5-0-45" class="i">+
</a><a href="#h5-0-46" id="h5-0-46" class="i">+            for raw in f.readlines():
</a><a href="#h5-0-47" id="h5-0-47" class="i">+
</a><a href="#h5-0-48" id="h5-0-48" class="i">+                data = raw.split(&#39;\t&#39;)
</a><a href="#h5-0-49" id="h5-0-49" class="i">+
</a><a href="#h5-0-50" id="h5-0-50" class="i">+                if len(data) == 4:
</a><a href="#h5-0-51" id="h5-0-51" class="i">+
</a><a href="#h5-0-52" id="h5-0-52" class="i">+                    data = data[0].split(&#39;/&#39;) + data[1:]
</a><a href="#h5-0-53" id="h5-0-53" class="i">+                    data = list(map(str.strip, data))
</a><a href="#h5-0-54" id="h5-0-54" class="i">+
</a><a href="#h5-0-55" id="h5-0-55" class="i">+                    if not benchdata.get(data[0]):
</a><a href="#h5-0-56" id="h5-0-56" class="i">+                        benchdata[data[0]] = [ data[1:] ]
</a><a href="#h5-0-57" id="h5-0-57" class="i">+                    else:
</a><a href="#h5-0-58" id="h5-0-58" class="i">+                        benchdata[data[0]].append(data[1:])
</a><a href="#h5-0-59" id="h5-0-59" class="i">+
</a><a href="#h5-0-60" id="h5-0-60" class="i">+    def gen_csv(self):
</a><a href="#h5-0-61" id="h5-0-61" class="i">+        &quot;&quot;&quot;
</a><a href="#h5-0-62" id="h5-0-62" class="i">+        generate temporary csv files
</a><a href="#h5-0-63" id="h5-0-63" class="i">+        &quot;&quot;&quot;
</a><a href="#h5-0-64" id="h5-0-64" class="i">+
</a><a href="#h5-0-65" id="h5-0-65" class="i">+        for name, data in self.benchdata.items():
</a><a href="#h5-0-66" id="h5-0-66" class="i">+
</a><a href="#h5-0-67" id="h5-0-67" class="i">+            with tempfile.NamedTemporaryFile(delete=False) as f:
</a><a href="#h5-0-68" id="h5-0-68" class="i">+
</a><a href="#h5-0-69" id="h5-0-69" class="i">+                for index, line in enumerate(data):
</a><a href="#h5-0-70" id="h5-0-70" class="i">+                    f.write(&#39;{};{}\n&#39;.format(index, &#39;;&#39;.join(line)).encode())
</a><a href="#h5-0-71" id="h5-0-71" class="i">+
</a><a href="#h5-0-72" id="h5-0-72" class="i">+                self.tempfiles.append(f.name)
</a><a href="#h5-0-73" id="h5-0-73" class="i">+                self.script = self.script + self.template.format(f.name, name)
</a><a href="#h5-0-74" id="h5-0-74" class="i">+
</a><a href="#h5-0-75" id="h5-0-75" class="i">+    def run(self):
</a><a href="#h5-0-76" id="h5-0-76" class="i">+        self.gen_csv()
</a><a href="#h5-0-77" id="h5-0-77" class="i">+        script = self.script[:-3].format(self.output)
</a><a href="#h5-0-78" id="h5-0-78" class="i">+        command = subprocess.Popen([&#39;gnuplot&#39;], stdin=subprocess.PIPE)
</a><a href="#h5-0-79" id="h5-0-79" class="i">+        command.communicate(script.encode())
</a><a href="#h5-0-80" id="h5-0-80" class="i">+
</a><a href="#h5-0-81" id="h5-0-81" class="i">+
</a><a href="#h5-0-82" id="h5-0-82" class="i">+if __name__ == &#39;__main__&#39;:
</a><a href="#h5-0-83" id="h5-0-83" class="i">+
</a><a href="#h5-0-84" id="h5-0-84" class="i">+    parser = argparse.ArgumentParser(description=&#39;generate plots for benchlog&#39;)
</a><a href="#h5-0-85" id="h5-0-85" class="i">+    parser.add_argument(&#39;benchlog&#39;, type=str, help=&#39;benchlog generated by re2&#39;)
</a><a href="#h5-0-86" id="h5-0-86" class="i">+    args = parser.parse_args()
</a><a href="#h5-0-87" id="h5-0-87" class="i">+
</a><a href="#h5-0-88" id="h5-0-88" class="i">+    try:
</a><a href="#h5-0-89" id="h5-0-89" class="i">+        subprocess.Popen([&#39;gnuplot&#39;], stdin=subprocess.PIPE)
</a><a href="#h5-0-90" id="h5-0-90" class="i">+    except FileNotFoundError:
</a><a href="#h5-0-91" id="h5-0-91" class="i">+        print(&#39;you can install &quot;gnuplot&quot; to generate plots automatically&#39;)
</a><a href="#h5-0-92" id="h5-0-92" class="i">+        exit(1)
</a><a href="#h5-0-93" id="h5-0-93" class="i">+
</a><a href="#h5-0-94" id="h5-0-94" class="i">+    with gnuplot() as plot:
</a><a href="#h5-0-95" id="h5-0-95" class="i">+        plot.output = args.benchlog
</a><a href="#h5-0-96" id="h5-0-96" class="i">+        plot.parse_re2_benchlog(args.benchlog)
</a><a href="#h5-0-97" id="h5-0-97" class="i">+        plot.run()
</a><b>diff --git a/<a id="h6" href="../file/src/vendor/re2/lib/codereview/codereview.cfg">src/vendor/re2/lib/codereview/codereview.cfg</a> b/<a href="../file/src/vendor/re2/lib/codereview/codereview.cfg">src/vendor/re2/lib/codereview/codereview.cfg</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -1 +0,0 @@
</a><a href="#h6-0-0" id="h6-0-0" class="d">-defaultcc: re2-dev@googlegroups.com
</a><b>diff --git a/<a id="h7" href="../file/src/vendor/re2/lib/codereview/codereview.py">src/vendor/re2/lib/codereview/codereview.py</a> b/<a href="../file/src/vendor/re2/lib/codereview/codereview.py">src/vendor/re2/lib/codereview/codereview.py</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -1,3594 +0,0 @@
</a><a href="#h7-0-0" id="h7-0-0" class="d">-# coding=utf-8
</a><a href="#h7-0-1" id="h7-0-1" class="d">-# (The line above is necessary so that I can use  in the
</a><a href="#h7-0-2" id="h7-0-2" class="d">-# *comment* below without Python getting all bent out of shape.)
</a><a href="#h7-0-3" id="h7-0-3" class="d">-
</a><a href="#h7-0-4" id="h7-0-4" class="d">-# Copyright 2007-2009 Google Inc.
</a><a href="#h7-0-5" id="h7-0-5" class="d">-#
</a><a href="#h7-0-6" id="h7-0-6" class="d">-# Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
</a><a href="#h7-0-7" id="h7-0-7" class="d">-# you may not use this file except in compliance with the License.
</a><a href="#h7-0-8" id="h7-0-8" class="d">-# You may obtain a copy of the License at
</a><a href="#h7-0-9" id="h7-0-9" class="d">-#
</a><a href="#h7-0-10" id="h7-0-10" class="d">-#	http://www.apache.org/licenses/LICENSE-2.0
</a><a href="#h7-0-11" id="h7-0-11" class="d">-#
</a><a href="#h7-0-12" id="h7-0-12" class="d">-# Unless required by applicable law or agreed to in writing, software
</a><a href="#h7-0-13" id="h7-0-13" class="d">-# distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
</a><a href="#h7-0-14" id="h7-0-14" class="d">-# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
</a><a href="#h7-0-15" id="h7-0-15" class="d">-# See the License for the specific language governing permissions and
</a><a href="#h7-0-16" id="h7-0-16" class="d">-# limitations under the License.
</a><a href="#h7-0-17" id="h7-0-17" class="d">-
</a><a href="#h7-0-18" id="h7-0-18" class="d">-&#39;&#39;&#39;Mercurial interface to codereview.appspot.com.
</a><a href="#h7-0-19" id="h7-0-19" class="d">-
</a><a href="#h7-0-20" id="h7-0-20" class="d">-To configure, set the following options in
</a><a href="#h7-0-21" id="h7-0-21" class="d">-your repository&#39;s .hg/hgrc file.
</a><a href="#h7-0-22" id="h7-0-22" class="d">-
</a><a href="#h7-0-23" id="h7-0-23" class="d">-	[extensions]
</a><a href="#h7-0-24" id="h7-0-24" class="d">-	codereview = /path/to/codereview.py
</a><a href="#h7-0-25" id="h7-0-25" class="d">-
</a><a href="#h7-0-26" id="h7-0-26" class="d">-	[codereview]
</a><a href="#h7-0-27" id="h7-0-27" class="d">-	server = codereview.appspot.com
</a><a href="#h7-0-28" id="h7-0-28" class="d">-
</a><a href="#h7-0-29" id="h7-0-29" class="d">-The server should be running Rietveld; see http://code.google.com/p/rietveld/.
</a><a href="#h7-0-30" id="h7-0-30" class="d">-
</a><a href="#h7-0-31" id="h7-0-31" class="d">-In addition to the new commands, this extension introduces
</a><a href="#h7-0-32" id="h7-0-32" class="d">-the file pattern syntax @nnnnnn, where nnnnnn is a change list
</a><a href="#h7-0-33" id="h7-0-33" class="d">-number, to mean the files included in that change list, which
</a><a href="#h7-0-34" id="h7-0-34" class="d">-must be associated with the current client.
</a><a href="#h7-0-35" id="h7-0-35" class="d">-
</a><a href="#h7-0-36" id="h7-0-36" class="d">-For example, if change 123456 contains the files x.go and y.go,
</a><a href="#h7-0-37" id="h7-0-37" class="d">-&quot;hg diff @123456&quot; is equivalent to&quot;hg diff x.go y.go&quot;.
</a><a href="#h7-0-38" id="h7-0-38" class="d">-&#39;&#39;&#39;
</a><a href="#h7-0-39" id="h7-0-39" class="d">-
</a><a href="#h7-0-40" id="h7-0-40" class="d">-import sys
</a><a href="#h7-0-41" id="h7-0-41" class="d">-
</a><a href="#h7-0-42" id="h7-0-42" class="d">-if __name__ == &quot;__main__&quot;:
</a><a href="#h7-0-43" id="h7-0-43" class="d">-	print &gt;&gt;sys.stderr, &quot;This is a Mercurial extension and should not be invoked directly.&quot;
</a><a href="#h7-0-44" id="h7-0-44" class="d">-	sys.exit(2)
</a><a href="#h7-0-45" id="h7-0-45" class="d">-
</a><a href="#h7-0-46" id="h7-0-46" class="d">-# We require Python 2.6 for the json package.
</a><a href="#h7-0-47" id="h7-0-47" class="d">-if sys.version &lt; &#39;2.6&#39;:
</a><a href="#h7-0-48" id="h7-0-48" class="d">-	print &gt;&gt;sys.stderr, &quot;The codereview extension requires Python 2.6 or newer.&quot;
</a><a href="#h7-0-49" id="h7-0-49" class="d">-	print &gt;&gt;sys.stderr, &quot;You are running Python &quot; + sys.version
</a><a href="#h7-0-50" id="h7-0-50" class="d">-	sys.exit(2)
</a><a href="#h7-0-51" id="h7-0-51" class="d">-
</a><a href="#h7-0-52" id="h7-0-52" class="d">-import json
</a><a href="#h7-0-53" id="h7-0-53" class="d">-import os
</a><a href="#h7-0-54" id="h7-0-54" class="d">-import re
</a><a href="#h7-0-55" id="h7-0-55" class="d">-import stat
</a><a href="#h7-0-56" id="h7-0-56" class="d">-import subprocess
</a><a href="#h7-0-57" id="h7-0-57" class="d">-import threading
</a><a href="#h7-0-58" id="h7-0-58" class="d">-import time
</a><a href="#h7-0-59" id="h7-0-59" class="d">-
</a><a href="#h7-0-60" id="h7-0-60" class="d">-from mercurial import commands as hg_commands
</a><a href="#h7-0-61" id="h7-0-61" class="d">-from mercurial import util as hg_util
</a><a href="#h7-0-62" id="h7-0-62" class="d">-
</a><a href="#h7-0-63" id="h7-0-63" class="d">-defaultcc = None
</a><a href="#h7-0-64" id="h7-0-64" class="d">-codereview_disabled = None
</a><a href="#h7-0-65" id="h7-0-65" class="d">-real_rollback = None
</a><a href="#h7-0-66" id="h7-0-66" class="d">-releaseBranch = None
</a><a href="#h7-0-67" id="h7-0-67" class="d">-server = &quot;codereview.appspot.com&quot;
</a><a href="#h7-0-68" id="h7-0-68" class="d">-server_url_base = None
</a><a href="#h7-0-69" id="h7-0-69" class="d">-
</a><a href="#h7-0-70" id="h7-0-70" class="d">-#######################################################################
</a><a href="#h7-0-71" id="h7-0-71" class="d">-# Normally I would split this into multiple files, but it simplifies
</a><a href="#h7-0-72" id="h7-0-72" class="d">-# import path headaches to keep it all in one file.  Sorry.
</a><a href="#h7-0-73" id="h7-0-73" class="d">-# The different parts of the file are separated by banners like this one.
</a><a href="#h7-0-74" id="h7-0-74" class="d">-
</a><a href="#h7-0-75" id="h7-0-75" class="d">-#######################################################################
</a><a href="#h7-0-76" id="h7-0-76" class="d">-# Helpers
</a><a href="#h7-0-77" id="h7-0-77" class="d">-
</a><a href="#h7-0-78" id="h7-0-78" class="d">-def RelativePath(path, cwd):
</a><a href="#h7-0-79" id="h7-0-79" class="d">-	n = len(cwd)
</a><a href="#h7-0-80" id="h7-0-80" class="d">-	if path.startswith(cwd) and path[n] == &#39;/&#39;:
</a><a href="#h7-0-81" id="h7-0-81" class="d">-		return path[n+1:]
</a><a href="#h7-0-82" id="h7-0-82" class="d">-	return path
</a><a href="#h7-0-83" id="h7-0-83" class="d">-
</a><a href="#h7-0-84" id="h7-0-84" class="d">-def Sub(l1, l2):
</a><a href="#h7-0-85" id="h7-0-85" class="d">-	return [l for l in l1 if l not in l2]
</a><a href="#h7-0-86" id="h7-0-86" class="d">-
</a><a href="#h7-0-87" id="h7-0-87" class="d">-def Add(l1, l2):
</a><a href="#h7-0-88" id="h7-0-88" class="d">-	l = l1 + Sub(l2, l1)
</a><a href="#h7-0-89" id="h7-0-89" class="d">-	l.sort()
</a><a href="#h7-0-90" id="h7-0-90" class="d">-	return l
</a><a href="#h7-0-91" id="h7-0-91" class="d">-
</a><a href="#h7-0-92" id="h7-0-92" class="d">-def Intersect(l1, l2):
</a><a href="#h7-0-93" id="h7-0-93" class="d">-	return [l for l in l1 if l in l2]
</a><a href="#h7-0-94" id="h7-0-94" class="d">-
</a><a href="#h7-0-95" id="h7-0-95" class="d">-#######################################################################
</a><a href="#h7-0-96" id="h7-0-96" class="d">-# RE: UNICODE STRING HANDLING
</a><a href="#h7-0-97" id="h7-0-97" class="d">-#
</a><a href="#h7-0-98" id="h7-0-98" class="d">-# Python distinguishes between the str (string of bytes)
</a><a href="#h7-0-99" id="h7-0-99" class="d">-# and unicode (string of code points) types.  Most operations
</a><a href="#h7-0-100" id="h7-0-100" class="d">-# work on either one just fine, but some (like regexp matching)
</a><a href="#h7-0-101" id="h7-0-101" class="d">-# require unicode, and others (like write) require str.
</a><a href="#h7-0-102" id="h7-0-102" class="d">-#
</a><a href="#h7-0-103" id="h7-0-103" class="d">-# As befits the language, Python hides the distinction between
</a><a href="#h7-0-104" id="h7-0-104" class="d">-# unicode and str by converting between them silently, but
</a><a href="#h7-0-105" id="h7-0-105" class="d">-# *only* if all the bytes/code points involved are 7-bit ASCII.
</a><a href="#h7-0-106" id="h7-0-106" class="d">-# This means that if you&#39;re not careful, your program works
</a><a href="#h7-0-107" id="h7-0-107" class="d">-# fine on &quot;hello, world&quot; and fails on &quot;hello, &quot;.  And of course,
</a><a href="#h7-0-108" id="h7-0-108" class="d">-# the obvious way to be careful - use static types - is unavailable.
</a><a href="#h7-0-109" id="h7-0-109" class="d">-# So the only way is trial and error to find where to put explicit
</a><a href="#h7-0-110" id="h7-0-110" class="d">-# conversions.
</a><a href="#h7-0-111" id="h7-0-111" class="d">-#
</a><a href="#h7-0-112" id="h7-0-112" class="d">-# Because more functions do implicit conversion to str (string of bytes)
</a><a href="#h7-0-113" id="h7-0-113" class="d">-# than do implicit conversion to unicode (string of code points),
</a><a href="#h7-0-114" id="h7-0-114" class="d">-# the convention in this module is to represent all text as str,
</a><a href="#h7-0-115" id="h7-0-115" class="d">-# converting to unicode only when calling a unicode-only function
</a><a href="#h7-0-116" id="h7-0-116" class="d">-# and then converting back to str as soon as possible.
</a><a href="#h7-0-117" id="h7-0-117" class="d">-
</a><a href="#h7-0-118" id="h7-0-118" class="d">-def typecheck(s, t):
</a><a href="#h7-0-119" id="h7-0-119" class="d">-	if type(s) != t:
</a><a href="#h7-0-120" id="h7-0-120" class="d">-		raise hg_util.Abort(&quot;type check failed: %s has type %s != %s&quot; % (repr(s), type(s), t))
</a><a href="#h7-0-121" id="h7-0-121" class="d">-
</a><a href="#h7-0-122" id="h7-0-122" class="d">-# If we have to pass unicode instead of str, ustr does that conversion clearly.
</a><a href="#h7-0-123" id="h7-0-123" class="d">-def ustr(s):
</a><a href="#h7-0-124" id="h7-0-124" class="d">-	typecheck(s, str)
</a><a href="#h7-0-125" id="h7-0-125" class="d">-	return s.decode(&quot;utf-8&quot;)
</a><a href="#h7-0-126" id="h7-0-126" class="d">-
</a><a href="#h7-0-127" id="h7-0-127" class="d">-# Even with those, Mercurial still sometimes turns unicode into str
</a><a href="#h7-0-128" id="h7-0-128" class="d">-# and then tries to use it as ascii.  Change Mercurial&#39;s default.
</a><a href="#h7-0-129" id="h7-0-129" class="d">-def set_mercurial_encoding_to_utf8():
</a><a href="#h7-0-130" id="h7-0-130" class="d">-	from mercurial import encoding
</a><a href="#h7-0-131" id="h7-0-131" class="d">-	encoding.encoding = &#39;utf-8&#39;
</a><a href="#h7-0-132" id="h7-0-132" class="d">-
</a><a href="#h7-0-133" id="h7-0-133" class="d">-set_mercurial_encoding_to_utf8()
</a><a href="#h7-0-134" id="h7-0-134" class="d">-
</a><a href="#h7-0-135" id="h7-0-135" class="d">-# Even with those we still run into problems.
</a><a href="#h7-0-136" id="h7-0-136" class="d">-# I tried to do things by the book but could not convince
</a><a href="#h7-0-137" id="h7-0-137" class="d">-# Mercurial to let me check in a change with UTF-8 in the
</a><a href="#h7-0-138" id="h7-0-138" class="d">-# CL description or author field, no matter how many conversions
</a><a href="#h7-0-139" id="h7-0-139" class="d">-# between str and unicode I inserted and despite changing the
</a><a href="#h7-0-140" id="h7-0-140" class="d">-# default encoding.  I&#39;m tired of this game, so set the default
</a><a href="#h7-0-141" id="h7-0-141" class="d">-# encoding for all of Python to &#39;utf-8&#39;, not &#39;ascii&#39;.
</a><a href="#h7-0-142" id="h7-0-142" class="d">-def default_to_utf8():
</a><a href="#h7-0-143" id="h7-0-143" class="d">-	import sys
</a><a href="#h7-0-144" id="h7-0-144" class="d">-	stdout, __stdout__ = sys.stdout, sys.__stdout__
</a><a href="#h7-0-145" id="h7-0-145" class="d">-	reload(sys)  # site.py deleted setdefaultencoding; get it back
</a><a href="#h7-0-146" id="h7-0-146" class="d">-	sys.stdout, sys.__stdout__ = stdout, __stdout__
</a><a href="#h7-0-147" id="h7-0-147" class="d">-	sys.setdefaultencoding(&#39;utf-8&#39;)
</a><a href="#h7-0-148" id="h7-0-148" class="d">-
</a><a href="#h7-0-149" id="h7-0-149" class="d">-default_to_utf8()
</a><a href="#h7-0-150" id="h7-0-150" class="d">-
</a><a href="#h7-0-151" id="h7-0-151" class="d">-#######################################################################
</a><a href="#h7-0-152" id="h7-0-152" class="d">-# Status printer for long-running commands
</a><a href="#h7-0-153" id="h7-0-153" class="d">-
</a><a href="#h7-0-154" id="h7-0-154" class="d">-global_status = None
</a><a href="#h7-0-155" id="h7-0-155" class="d">-
</a><a href="#h7-0-156" id="h7-0-156" class="d">-def set_status(s):
</a><a href="#h7-0-157" id="h7-0-157" class="d">-	if verbosity &gt; 0:
</a><a href="#h7-0-158" id="h7-0-158" class="d">-		print &gt;&gt;sys.stderr, time.asctime(), s
</a><a href="#h7-0-159" id="h7-0-159" class="d">-	global global_status
</a><a href="#h7-0-160" id="h7-0-160" class="d">-	global_status = s
</a><a href="#h7-0-161" id="h7-0-161" class="d">-
</a><a href="#h7-0-162" id="h7-0-162" class="d">-class StatusThread(threading.Thread):
</a><a href="#h7-0-163" id="h7-0-163" class="d">-	def __init__(self):
</a><a href="#h7-0-164" id="h7-0-164" class="d">-		threading.Thread.__init__(self)
</a><a href="#h7-0-165" id="h7-0-165" class="d">-	def run(self):
</a><a href="#h7-0-166" id="h7-0-166" class="d">-		# pause a reasonable amount of time before
</a><a href="#h7-0-167" id="h7-0-167" class="d">-		# starting to display status messages, so that
</a><a href="#h7-0-168" id="h7-0-168" class="d">-		# most hg commands won&#39;t ever see them.
</a><a href="#h7-0-169" id="h7-0-169" class="d">-		time.sleep(30)
</a><a href="#h7-0-170" id="h7-0-170" class="d">-
</a><a href="#h7-0-171" id="h7-0-171" class="d">-		# now show status every 15 seconds
</a><a href="#h7-0-172" id="h7-0-172" class="d">-		while True:
</a><a href="#h7-0-173" id="h7-0-173" class="d">-			time.sleep(15 - time.time() % 15)
</a><a href="#h7-0-174" id="h7-0-174" class="d">-			s = global_status
</a><a href="#h7-0-175" id="h7-0-175" class="d">-			if s is None:
</a><a href="#h7-0-176" id="h7-0-176" class="d">-				continue
</a><a href="#h7-0-177" id="h7-0-177" class="d">-			if s == &quot;&quot;:
</a><a href="#h7-0-178" id="h7-0-178" class="d">-				s = &quot;(unknown status)&quot;
</a><a href="#h7-0-179" id="h7-0-179" class="d">-			print &gt;&gt;sys.stderr, time.asctime(), s
</a><a href="#h7-0-180" id="h7-0-180" class="d">-
</a><a href="#h7-0-181" id="h7-0-181" class="d">-def start_status_thread():
</a><a href="#h7-0-182" id="h7-0-182" class="d">-	t = StatusThread()
</a><a href="#h7-0-183" id="h7-0-183" class="d">-	t.setDaemon(True)  # allowed to exit if t is still running
</a><a href="#h7-0-184" id="h7-0-184" class="d">-	t.start()
</a><a href="#h7-0-185" id="h7-0-185" class="d">-
</a><a href="#h7-0-186" id="h7-0-186" class="d">-#######################################################################
</a><a href="#h7-0-187" id="h7-0-187" class="d">-# Change list parsing.
</a><a href="#h7-0-188" id="h7-0-188" class="d">-#
</a><a href="#h7-0-189" id="h7-0-189" class="d">-# Change lists are stored in .hg/codereview/cl.nnnnnn
</a><a href="#h7-0-190" id="h7-0-190" class="d">-# where nnnnnn is the number assigned by the code review server.
</a><a href="#h7-0-191" id="h7-0-191" class="d">-# Most data about a change list is stored on the code review server
</a><a href="#h7-0-192" id="h7-0-192" class="d">-# too: the description, reviewer, and cc list are all stored there.
</a><a href="#h7-0-193" id="h7-0-193" class="d">-# The only thing in the cl.nnnnnn file is the list of relevant files.
</a><a href="#h7-0-194" id="h7-0-194" class="d">-# Also, the existence of the cl.nnnnnn file marks this repository
</a><a href="#h7-0-195" id="h7-0-195" class="d">-# as the one where the change list lives.
</a><a href="#h7-0-196" id="h7-0-196" class="d">-
</a><a href="#h7-0-197" id="h7-0-197" class="d">-emptydiff = &quot;&quot;&quot;Index: ~rietveld~placeholder~
</a><a href="#h7-0-198" id="h7-0-198" class="d">-===================================================================
</a><a href="#h7-0-199" id="h7-0-199" class="d">-diff --git a/~rietveld~placeholder~ b/~rietveld~placeholder~
</a><a href="#h7-0-200" id="h7-0-200" class="d">-new file mode 100644
</a><a href="#h7-0-201" id="h7-0-201" class="d">-&quot;&quot;&quot;
</a><a href="#h7-0-202" id="h7-0-202" class="d">-
</a><a href="#h7-0-203" id="h7-0-203" class="d">-class CL(object):
</a><a href="#h7-0-204" id="h7-0-204" class="d">-	def __init__(self, name):
</a><a href="#h7-0-205" id="h7-0-205" class="d">-		typecheck(name, str)
</a><a href="#h7-0-206" id="h7-0-206" class="d">-		self.name = name
</a><a href="#h7-0-207" id="h7-0-207" class="d">-		self.desc = &#39;&#39;
</a><a href="#h7-0-208" id="h7-0-208" class="d">-		self.files = []
</a><a href="#h7-0-209" id="h7-0-209" class="d">-		self.reviewer = []
</a><a href="#h7-0-210" id="h7-0-210" class="d">-		self.cc = []
</a><a href="#h7-0-211" id="h7-0-211" class="d">-		self.url = &#39;&#39;
</a><a href="#h7-0-212" id="h7-0-212" class="d">-		self.local = False
</a><a href="#h7-0-213" id="h7-0-213" class="d">-		self.web = False
</a><a href="#h7-0-214" id="h7-0-214" class="d">-		self.copied_from = None	# None means current user
</a><a href="#h7-0-215" id="h7-0-215" class="d">-		self.mailed = False
</a><a href="#h7-0-216" id="h7-0-216" class="d">-		self.private = False
</a><a href="#h7-0-217" id="h7-0-217" class="d">-		self.lgtm = []
</a><a href="#h7-0-218" id="h7-0-218" class="d">-
</a><a href="#h7-0-219" id="h7-0-219" class="d">-	def DiskText(self):
</a><a href="#h7-0-220" id="h7-0-220" class="d">-		cl = self
</a><a href="#h7-0-221" id="h7-0-221" class="d">-		s = &quot;&quot;
</a><a href="#h7-0-222" id="h7-0-222" class="d">-		if cl.copied_from:
</a><a href="#h7-0-223" id="h7-0-223" class="d">-			s += &quot;Author: &quot; + cl.copied_from + &quot;\n\n&quot;
</a><a href="#h7-0-224" id="h7-0-224" class="d">-		if cl.private:
</a><a href="#h7-0-225" id="h7-0-225" class="d">-			s += &quot;Private: &quot; + str(self.private) + &quot;\n&quot;
</a><a href="#h7-0-226" id="h7-0-226" class="d">-		s += &quot;Mailed: &quot; + str(self.mailed) + &quot;\n&quot;
</a><a href="#h7-0-227" id="h7-0-227" class="d">-		s += &quot;Description:\n&quot;
</a><a href="#h7-0-228" id="h7-0-228" class="d">-		s += Indent(cl.desc, &quot;\t&quot;)
</a><a href="#h7-0-229" id="h7-0-229" class="d">-		s += &quot;Files:\n&quot;
</a><a href="#h7-0-230" id="h7-0-230" class="d">-		for f in cl.files:
</a><a href="#h7-0-231" id="h7-0-231" class="d">-			s += &quot;\t&quot; + f + &quot;\n&quot;
</a><a href="#h7-0-232" id="h7-0-232" class="d">-		typecheck(s, str)
</a><a href="#h7-0-233" id="h7-0-233" class="d">-		return s
</a><a href="#h7-0-234" id="h7-0-234" class="d">-
</a><a href="#h7-0-235" id="h7-0-235" class="d">-	def EditorText(self):
</a><a href="#h7-0-236" id="h7-0-236" class="d">-		cl = self
</a><a href="#h7-0-237" id="h7-0-237" class="d">-		s = _change_prolog
</a><a href="#h7-0-238" id="h7-0-238" class="d">-		s += &quot;\n&quot;
</a><a href="#h7-0-239" id="h7-0-239" class="d">-		if cl.copied_from:
</a><a href="#h7-0-240" id="h7-0-240" class="d">-			s += &quot;Author: &quot; + cl.copied_from + &quot;\n&quot;
</a><a href="#h7-0-241" id="h7-0-241" class="d">-		if cl.url != &#39;&#39;:
</a><a href="#h7-0-242" id="h7-0-242" class="d">-			s += &#39;URL: &#39; + cl.url + &#39;	# cannot edit\n\n&#39;
</a><a href="#h7-0-243" id="h7-0-243" class="d">-		if cl.private:
</a><a href="#h7-0-244" id="h7-0-244" class="d">-			s += &quot;Private: True\n&quot;
</a><a href="#h7-0-245" id="h7-0-245" class="d">-		s += &quot;Reviewer: &quot; + JoinComma(cl.reviewer) + &quot;\n&quot;
</a><a href="#h7-0-246" id="h7-0-246" class="d">-		s += &quot;CC: &quot; + JoinComma(cl.cc) + &quot;\n&quot;
</a><a href="#h7-0-247" id="h7-0-247" class="d">-		s += &quot;\n&quot;
</a><a href="#h7-0-248" id="h7-0-248" class="d">-		s += &quot;Description:\n&quot;
</a><a href="#h7-0-249" id="h7-0-249" class="d">-		if cl.desc == &#39;&#39;:
</a><a href="#h7-0-250" id="h7-0-250" class="d">-			s += &quot;\t&lt;enter description here&gt;\n&quot;
</a><a href="#h7-0-251" id="h7-0-251" class="d">-		else:
</a><a href="#h7-0-252" id="h7-0-252" class="d">-			s += Indent(cl.desc, &quot;\t&quot;)
</a><a href="#h7-0-253" id="h7-0-253" class="d">-		s += &quot;\n&quot;
</a><a href="#h7-0-254" id="h7-0-254" class="d">-		if cl.local or cl.name == &quot;new&quot;:
</a><a href="#h7-0-255" id="h7-0-255" class="d">-			s += &quot;Files:\n&quot;
</a><a href="#h7-0-256" id="h7-0-256" class="d">-			for f in cl.files:
</a><a href="#h7-0-257" id="h7-0-257" class="d">-				s += &quot;\t&quot; + f + &quot;\n&quot;
</a><a href="#h7-0-258" id="h7-0-258" class="d">-			s += &quot;\n&quot;
</a><a href="#h7-0-259" id="h7-0-259" class="d">-		typecheck(s, str)
</a><a href="#h7-0-260" id="h7-0-260" class="d">-		return s
</a><a href="#h7-0-261" id="h7-0-261" class="d">-
</a><a href="#h7-0-262" id="h7-0-262" class="d">-	def PendingText(self, quick=False):
</a><a href="#h7-0-263" id="h7-0-263" class="d">-		cl = self
</a><a href="#h7-0-264" id="h7-0-264" class="d">-		s = cl.name + &quot;:&quot; + &quot;\n&quot;
</a><a href="#h7-0-265" id="h7-0-265" class="d">-		s += Indent(cl.desc, &quot;\t&quot;)
</a><a href="#h7-0-266" id="h7-0-266" class="d">-		s += &quot;\n&quot;
</a><a href="#h7-0-267" id="h7-0-267" class="d">-		if cl.copied_from:
</a><a href="#h7-0-268" id="h7-0-268" class="d">-			s += &quot;\tAuthor: &quot; + cl.copied_from + &quot;\n&quot;
</a><a href="#h7-0-269" id="h7-0-269" class="d">-		if not quick:
</a><a href="#h7-0-270" id="h7-0-270" class="d">-			s += &quot;\tReviewer: &quot; + JoinComma(cl.reviewer) + &quot;\n&quot;
</a><a href="#h7-0-271" id="h7-0-271" class="d">-			for (who, line) in cl.lgtm:
</a><a href="#h7-0-272" id="h7-0-272" class="d">-				s += &quot;\t\t&quot; + who + &quot;: &quot; + line + &quot;\n&quot;
</a><a href="#h7-0-273" id="h7-0-273" class="d">-			s += &quot;\tCC: &quot; + JoinComma(cl.cc) + &quot;\n&quot;
</a><a href="#h7-0-274" id="h7-0-274" class="d">-		s += &quot;\tFiles:\n&quot;
</a><a href="#h7-0-275" id="h7-0-275" class="d">-		for f in cl.files:
</a><a href="#h7-0-276" id="h7-0-276" class="d">-			s += &quot;\t\t&quot; + f + &quot;\n&quot;
</a><a href="#h7-0-277" id="h7-0-277" class="d">-		typecheck(s, str)
</a><a href="#h7-0-278" id="h7-0-278" class="d">-		return s
</a><a href="#h7-0-279" id="h7-0-279" class="d">-
</a><a href="#h7-0-280" id="h7-0-280" class="d">-	def Flush(self, ui, repo):
</a><a href="#h7-0-281" id="h7-0-281" class="d">-		if self.name == &quot;new&quot;:
</a><a href="#h7-0-282" id="h7-0-282" class="d">-			self.Upload(ui, repo, gofmt_just_warn=True, creating=True)
</a><a href="#h7-0-283" id="h7-0-283" class="d">-		dir = CodeReviewDir(ui, repo)
</a><a href="#h7-0-284" id="h7-0-284" class="d">-		path = dir + &#39;/cl.&#39; + self.name
</a><a href="#h7-0-285" id="h7-0-285" class="d">-		f = open(path+&#39;!&#39;, &quot;w&quot;)
</a><a href="#h7-0-286" id="h7-0-286" class="d">-		f.write(self.DiskText())
</a><a href="#h7-0-287" id="h7-0-287" class="d">-		f.close()
</a><a href="#h7-0-288" id="h7-0-288" class="d">-		if sys.platform == &quot;win32&quot; and os.path.isfile(path):
</a><a href="#h7-0-289" id="h7-0-289" class="d">-			os.remove(path)
</a><a href="#h7-0-290" id="h7-0-290" class="d">-		os.rename(path+&#39;!&#39;, path)
</a><a href="#h7-0-291" id="h7-0-291" class="d">-		if self.web and not self.copied_from:
</a><a href="#h7-0-292" id="h7-0-292" class="d">-			EditDesc(self.name, desc=self.desc,
</a><a href="#h7-0-293" id="h7-0-293" class="d">-				reviewers=JoinComma(self.reviewer), cc=JoinComma(self.cc),
</a><a href="#h7-0-294" id="h7-0-294" class="d">-				private=self.private)
</a><a href="#h7-0-295" id="h7-0-295" class="d">-
</a><a href="#h7-0-296" id="h7-0-296" class="d">-	def Delete(self, ui, repo):
</a><a href="#h7-0-297" id="h7-0-297" class="d">-		dir = CodeReviewDir(ui, repo)
</a><a href="#h7-0-298" id="h7-0-298" class="d">-		os.unlink(dir + &quot;/cl.&quot; + self.name)
</a><a href="#h7-0-299" id="h7-0-299" class="d">-
</a><a href="#h7-0-300" id="h7-0-300" class="d">-	def Subject(self):
</a><a href="#h7-0-301" id="h7-0-301" class="d">-		s = line1(self.desc)
</a><a href="#h7-0-302" id="h7-0-302" class="d">-		if len(s) &gt; 60:
</a><a href="#h7-0-303" id="h7-0-303" class="d">-			s = s[0:55] + &quot;...&quot;
</a><a href="#h7-0-304" id="h7-0-304" class="d">-		if self.name != &quot;new&quot;:
</a><a href="#h7-0-305" id="h7-0-305" class="d">-			s = &quot;code review %s: %s&quot; % (self.name, s)
</a><a href="#h7-0-306" id="h7-0-306" class="d">-		typecheck(s, str)
</a><a href="#h7-0-307" id="h7-0-307" class="d">-		return s
</a><a href="#h7-0-308" id="h7-0-308" class="d">-
</a><a href="#h7-0-309" id="h7-0-309" class="d">-	def Upload(self, ui, repo, send_mail=False, gofmt=True, gofmt_just_warn=False, creating=False, quiet=False):
</a><a href="#h7-0-310" id="h7-0-310" class="d">-		if not self.files and not creating:
</a><a href="#h7-0-311" id="h7-0-311" class="d">-			ui.warn(&quot;no files in change list\n&quot;)
</a><a href="#h7-0-312" id="h7-0-312" class="d">-		if ui.configbool(&quot;codereview&quot;, &quot;force_gofmt&quot;, True) and gofmt:
</a><a href="#h7-0-313" id="h7-0-313" class="d">-			CheckFormat(ui, repo, self.files, just_warn=gofmt_just_warn)
</a><a href="#h7-0-314" id="h7-0-314" class="d">-		set_status(&quot;uploading CL metadata + diffs&quot;)
</a><a href="#h7-0-315" id="h7-0-315" class="d">-		os.chdir(repo.root)
</a><a href="#h7-0-316" id="h7-0-316" class="d">-		form_fields = [
</a><a href="#h7-0-317" id="h7-0-317" class="d">-			(&quot;content_upload&quot;, &quot;1&quot;),
</a><a href="#h7-0-318" id="h7-0-318" class="d">-			(&quot;reviewers&quot;, JoinComma(self.reviewer)),
</a><a href="#h7-0-319" id="h7-0-319" class="d">-			(&quot;cc&quot;, JoinComma(self.cc)),
</a><a href="#h7-0-320" id="h7-0-320" class="d">-			(&quot;description&quot;, self.desc),
</a><a href="#h7-0-321" id="h7-0-321" class="d">-			(&quot;base_hashes&quot;, &quot;&quot;),
</a><a href="#h7-0-322" id="h7-0-322" class="d">-		]
</a><a href="#h7-0-323" id="h7-0-323" class="d">-
</a><a href="#h7-0-324" id="h7-0-324" class="d">-		if self.name != &quot;new&quot;:
</a><a href="#h7-0-325" id="h7-0-325" class="d">-			form_fields.append((&quot;issue&quot;, self.name))
</a><a href="#h7-0-326" id="h7-0-326" class="d">-		vcs = None
</a><a href="#h7-0-327" id="h7-0-327" class="d">-		# We do not include files when creating the issue,
</a><a href="#h7-0-328" id="h7-0-328" class="d">-		# because we want the patch sets to record the repository
</a><a href="#h7-0-329" id="h7-0-329" class="d">-		# and base revision they are diffs against.  We use the patch
</a><a href="#h7-0-330" id="h7-0-330" class="d">-		# set message for that purpose, but there is no message with
</a><a href="#h7-0-331" id="h7-0-331" class="d">-		# the first patch set.  Instead the message gets used as the
</a><a href="#h7-0-332" id="h7-0-332" class="d">-		# new CL&#39;s overall subject.  So omit the diffs when creating
</a><a href="#h7-0-333" id="h7-0-333" class="d">-		# and then we&#39;ll run an immediate upload.
</a><a href="#h7-0-334" id="h7-0-334" class="d">-		# This has the effect that every CL begins with an empty &quot;Patch set 1&quot;.
</a><a href="#h7-0-335" id="h7-0-335" class="d">-		if self.files and not creating:
</a><a href="#h7-0-336" id="h7-0-336" class="d">-			vcs = MercurialVCS(upload_options, ui, repo)
</a><a href="#h7-0-337" id="h7-0-337" class="d">-			data = vcs.GenerateDiff(self.files)
</a><a href="#h7-0-338" id="h7-0-338" class="d">-			files = vcs.GetBaseFiles(data)
</a><a href="#h7-0-339" id="h7-0-339" class="d">-			if len(data) &gt; MAX_UPLOAD_SIZE:
</a><a href="#h7-0-340" id="h7-0-340" class="d">-				uploaded_diff_file = []
</a><a href="#h7-0-341" id="h7-0-341" class="d">-				form_fields.append((&quot;separate_patches&quot;, &quot;1&quot;))
</a><a href="#h7-0-342" id="h7-0-342" class="d">-			else:
</a><a href="#h7-0-343" id="h7-0-343" class="d">-				uploaded_diff_file = [(&quot;data&quot;, &quot;data.diff&quot;, data)]
</a><a href="#h7-0-344" id="h7-0-344" class="d">-		else:
</a><a href="#h7-0-345" id="h7-0-345" class="d">-			uploaded_diff_file = [(&quot;data&quot;, &quot;data.diff&quot;, emptydiff)]
</a><a href="#h7-0-346" id="h7-0-346" class="d">-		
</a><a href="#h7-0-347" id="h7-0-347" class="d">-		if vcs and self.name != &quot;new&quot;:
</a><a href="#h7-0-348" id="h7-0-348" class="d">-			form_fields.append((&quot;subject&quot;, &quot;diff -r &quot; + vcs.base_rev + &quot; &quot; + ui.expandpath(&quot;default&quot;)))
</a><a href="#h7-0-349" id="h7-0-349" class="d">-		else:
</a><a href="#h7-0-350" id="h7-0-350" class="d">-			# First upload sets the subject for the CL itself.
</a><a href="#h7-0-351" id="h7-0-351" class="d">-			form_fields.append((&quot;subject&quot;, self.Subject()))
</a><a href="#h7-0-352" id="h7-0-352" class="d">-		ctype, body = EncodeMultipartFormData(form_fields, uploaded_diff_file)
</a><a href="#h7-0-353" id="h7-0-353" class="d">-		response_body = MySend(&quot;/upload&quot;, body, content_type=ctype)
</a><a href="#h7-0-354" id="h7-0-354" class="d">-		patchset = None
</a><a href="#h7-0-355" id="h7-0-355" class="d">-		msg = response_body
</a><a href="#h7-0-356" id="h7-0-356" class="d">-		lines = msg.splitlines()
</a><a href="#h7-0-357" id="h7-0-357" class="d">-		if len(lines) &gt;= 2:
</a><a href="#h7-0-358" id="h7-0-358" class="d">-			msg = lines[0]
</a><a href="#h7-0-359" id="h7-0-359" class="d">-			patchset = lines[1].strip()
</a><a href="#h7-0-360" id="h7-0-360" class="d">-			patches = [x.split(&quot; &quot;, 1) for x in lines[2:]]
</a><a href="#h7-0-361" id="h7-0-361" class="d">-		if response_body.startswith(&quot;Issue updated.&quot;) and quiet:
</a><a href="#h7-0-362" id="h7-0-362" class="d">-			pass
</a><a href="#h7-0-363" id="h7-0-363" class="d">-		else:
</a><a href="#h7-0-364" id="h7-0-364" class="d">-			ui.status(msg + &quot;\n&quot;)
</a><a href="#h7-0-365" id="h7-0-365" class="d">-		set_status(&quot;uploaded CL metadata + diffs&quot;)
</a><a href="#h7-0-366" id="h7-0-366" class="d">-		if not response_body.startswith(&quot;Issue created.&quot;) and not response_body.startswith(&quot;Issue updated.&quot;):
</a><a href="#h7-0-367" id="h7-0-367" class="d">-			raise hg_util.Abort(&quot;failed to update issue: &quot; + response_body)
</a><a href="#h7-0-368" id="h7-0-368" class="d">-		issue = msg[msg.rfind(&quot;/&quot;)+1:]
</a><a href="#h7-0-369" id="h7-0-369" class="d">-		self.name = issue
</a><a href="#h7-0-370" id="h7-0-370" class="d">-		if not self.url:
</a><a href="#h7-0-371" id="h7-0-371" class="d">-			self.url = server_url_base + self.name
</a><a href="#h7-0-372" id="h7-0-372" class="d">-		if not uploaded_diff_file:
</a><a href="#h7-0-373" id="h7-0-373" class="d">-			set_status(&quot;uploading patches&quot;)
</a><a href="#h7-0-374" id="h7-0-374" class="d">-			patches = UploadSeparatePatches(issue, rpc, patchset, data, upload_options)
</a><a href="#h7-0-375" id="h7-0-375" class="d">-		if vcs:
</a><a href="#h7-0-376" id="h7-0-376" class="d">-			set_status(&quot;uploading base files&quot;)
</a><a href="#h7-0-377" id="h7-0-377" class="d">-			vcs.UploadBaseFiles(issue, rpc, patches, patchset, upload_options, files)
</a><a href="#h7-0-378" id="h7-0-378" class="d">-		if send_mail:
</a><a href="#h7-0-379" id="h7-0-379" class="d">-			set_status(&quot;sending mail&quot;)
</a><a href="#h7-0-380" id="h7-0-380" class="d">-			MySend(&quot;/&quot; + issue + &quot;/mail&quot;, payload=&quot;&quot;)
</a><a href="#h7-0-381" id="h7-0-381" class="d">-		self.web = True
</a><a href="#h7-0-382" id="h7-0-382" class="d">-		set_status(&quot;flushing changes to disk&quot;)
</a><a href="#h7-0-383" id="h7-0-383" class="d">-		self.Flush(ui, repo)
</a><a href="#h7-0-384" id="h7-0-384" class="d">-		return
</a><a href="#h7-0-385" id="h7-0-385" class="d">-
</a><a href="#h7-0-386" id="h7-0-386" class="d">-	def Mail(self, ui, repo):
</a><a href="#h7-0-387" id="h7-0-387" class="d">-		pmsg = &quot;Hello &quot; + JoinComma(self.reviewer)
</a><a href="#h7-0-388" id="h7-0-388" class="d">-		if self.cc:
</a><a href="#h7-0-389" id="h7-0-389" class="d">-			pmsg += &quot; (cc: %s)&quot; % (&#39;, &#39;.join(self.cc),)
</a><a href="#h7-0-390" id="h7-0-390" class="d">-		pmsg += &quot;,\n&quot;
</a><a href="#h7-0-391" id="h7-0-391" class="d">-		pmsg += &quot;\n&quot;
</a><a href="#h7-0-392" id="h7-0-392" class="d">-		repourl = ui.expandpath(&quot;default&quot;)
</a><a href="#h7-0-393" id="h7-0-393" class="d">-		if not self.mailed:
</a><a href="#h7-0-394" id="h7-0-394" class="d">-			pmsg += &quot;I&#39;d like you to review this change to\n&quot; + repourl + &quot;\n&quot;
</a><a href="#h7-0-395" id="h7-0-395" class="d">-		else:
</a><a href="#h7-0-396" id="h7-0-396" class="d">-			pmsg += &quot;Please take another look.\n&quot;
</a><a href="#h7-0-397" id="h7-0-397" class="d">-		typecheck(pmsg, str)
</a><a href="#h7-0-398" id="h7-0-398" class="d">-		PostMessage(ui, self.name, pmsg, subject=self.Subject())
</a><a href="#h7-0-399" id="h7-0-399" class="d">-		self.mailed = True
</a><a href="#h7-0-400" id="h7-0-400" class="d">-		self.Flush(ui, repo)
</a><a href="#h7-0-401" id="h7-0-401" class="d">-
</a><a href="#h7-0-402" id="h7-0-402" class="d">-def GoodCLName(name):
</a><a href="#h7-0-403" id="h7-0-403" class="d">-	typecheck(name, str)
</a><a href="#h7-0-404" id="h7-0-404" class="d">-	return re.match(&quot;^[0-9]+$&quot;, name)
</a><a href="#h7-0-405" id="h7-0-405" class="d">-
</a><a href="#h7-0-406" id="h7-0-406" class="d">-def ParseCL(text, name):
</a><a href="#h7-0-407" id="h7-0-407" class="d">-	typecheck(text, str)
</a><a href="#h7-0-408" id="h7-0-408" class="d">-	typecheck(name, str)
</a><a href="#h7-0-409" id="h7-0-409" class="d">-	sname = None
</a><a href="#h7-0-410" id="h7-0-410" class="d">-	lineno = 0
</a><a href="#h7-0-411" id="h7-0-411" class="d">-	sections = {
</a><a href="#h7-0-412" id="h7-0-412" class="d">-		&#39;Author&#39;: &#39;&#39;,
</a><a href="#h7-0-413" id="h7-0-413" class="d">-		&#39;Description&#39;: &#39;&#39;,
</a><a href="#h7-0-414" id="h7-0-414" class="d">-		&#39;Files&#39;: &#39;&#39;,
</a><a href="#h7-0-415" id="h7-0-415" class="d">-		&#39;URL&#39;: &#39;&#39;,
</a><a href="#h7-0-416" id="h7-0-416" class="d">-		&#39;Reviewer&#39;: &#39;&#39;,
</a><a href="#h7-0-417" id="h7-0-417" class="d">-		&#39;CC&#39;: &#39;&#39;,
</a><a href="#h7-0-418" id="h7-0-418" class="d">-		&#39;Mailed&#39;: &#39;&#39;,
</a><a href="#h7-0-419" id="h7-0-419" class="d">-		&#39;Private&#39;: &#39;&#39;,
</a><a href="#h7-0-420" id="h7-0-420" class="d">-	}
</a><a href="#h7-0-421" id="h7-0-421" class="d">-	for line in text.split(&#39;\n&#39;):
</a><a href="#h7-0-422" id="h7-0-422" class="d">-		lineno += 1
</a><a href="#h7-0-423" id="h7-0-423" class="d">-		line = line.rstrip()
</a><a href="#h7-0-424" id="h7-0-424" class="d">-		if line != &#39;&#39; and line[0] == &#39;#&#39;:
</a><a href="#h7-0-425" id="h7-0-425" class="d">-			continue
</a><a href="#h7-0-426" id="h7-0-426" class="d">-		if line == &#39;&#39; or line[0] == &#39; &#39; or line[0] == &#39;\t&#39;:
</a><a href="#h7-0-427" id="h7-0-427" class="d">-			if sname == None and line != &#39;&#39;:
</a><a href="#h7-0-428" id="h7-0-428" class="d">-				return None, lineno, &#39;text outside section&#39;
</a><a href="#h7-0-429" id="h7-0-429" class="d">-			if sname != None:
</a><a href="#h7-0-430" id="h7-0-430" class="d">-				sections[sname] += line + &#39;\n&#39;
</a><a href="#h7-0-431" id="h7-0-431" class="d">-			continue
</a><a href="#h7-0-432" id="h7-0-432" class="d">-		p = line.find(&#39;:&#39;)
</a><a href="#h7-0-433" id="h7-0-433" class="d">-		if p &gt;= 0:
</a><a href="#h7-0-434" id="h7-0-434" class="d">-			s, val = line[:p].strip(), line[p+1:].strip()
</a><a href="#h7-0-435" id="h7-0-435" class="d">-			if s in sections:
</a><a href="#h7-0-436" id="h7-0-436" class="d">-				sname = s
</a><a href="#h7-0-437" id="h7-0-437" class="d">-				if val != &#39;&#39;:
</a><a href="#h7-0-438" id="h7-0-438" class="d">-					sections[sname] += val + &#39;\n&#39;
</a><a href="#h7-0-439" id="h7-0-439" class="d">-				continue
</a><a href="#h7-0-440" id="h7-0-440" class="d">-		return None, lineno, &#39;malformed section header&#39;
</a><a href="#h7-0-441" id="h7-0-441" class="d">-
</a><a href="#h7-0-442" id="h7-0-442" class="d">-	for k in sections:
</a><a href="#h7-0-443" id="h7-0-443" class="d">-		sections[k] = StripCommon(sections[k]).rstrip()
</a><a href="#h7-0-444" id="h7-0-444" class="d">-
</a><a href="#h7-0-445" id="h7-0-445" class="d">-	cl = CL(name)
</a><a href="#h7-0-446" id="h7-0-446" class="d">-	if sections[&#39;Author&#39;]:
</a><a href="#h7-0-447" id="h7-0-447" class="d">-		cl.copied_from = sections[&#39;Author&#39;]
</a><a href="#h7-0-448" id="h7-0-448" class="d">-	cl.desc = sections[&#39;Description&#39;]
</a><a href="#h7-0-449" id="h7-0-449" class="d">-	for line in sections[&#39;Files&#39;].split(&#39;\n&#39;):
</a><a href="#h7-0-450" id="h7-0-450" class="d">-		i = line.find(&#39;#&#39;)
</a><a href="#h7-0-451" id="h7-0-451" class="d">-		if i &gt;= 0:
</a><a href="#h7-0-452" id="h7-0-452" class="d">-			line = line[0:i].rstrip()
</a><a href="#h7-0-453" id="h7-0-453" class="d">-		line = line.strip()
</a><a href="#h7-0-454" id="h7-0-454" class="d">-		if line == &#39;&#39;:
</a><a href="#h7-0-455" id="h7-0-455" class="d">-			continue
</a><a href="#h7-0-456" id="h7-0-456" class="d">-		cl.files.append(line)
</a><a href="#h7-0-457" id="h7-0-457" class="d">-	cl.reviewer = SplitCommaSpace(sections[&#39;Reviewer&#39;])
</a><a href="#h7-0-458" id="h7-0-458" class="d">-	cl.cc = SplitCommaSpace(sections[&#39;CC&#39;])
</a><a href="#h7-0-459" id="h7-0-459" class="d">-	cl.url = sections[&#39;URL&#39;]
</a><a href="#h7-0-460" id="h7-0-460" class="d">-	if sections[&#39;Mailed&#39;] != &#39;False&#39;:
</a><a href="#h7-0-461" id="h7-0-461" class="d">-		# Odd default, but avoids spurious mailings when
</a><a href="#h7-0-462" id="h7-0-462" class="d">-		# reading old CLs that do not have a Mailed: line.
</a><a href="#h7-0-463" id="h7-0-463" class="d">-		# CLs created with this update will always have 
</a><a href="#h7-0-464" id="h7-0-464" class="d">-		# Mailed: False on disk.
</a><a href="#h7-0-465" id="h7-0-465" class="d">-		cl.mailed = True
</a><a href="#h7-0-466" id="h7-0-466" class="d">-	if sections[&#39;Private&#39;] in (&#39;True&#39;, &#39;true&#39;, &#39;Yes&#39;, &#39;yes&#39;):
</a><a href="#h7-0-467" id="h7-0-467" class="d">-		cl.private = True
</a><a href="#h7-0-468" id="h7-0-468" class="d">-	if cl.desc == &#39;&lt;enter description here&gt;&#39;:
</a><a href="#h7-0-469" id="h7-0-469" class="d">-		cl.desc = &#39;&#39;
</a><a href="#h7-0-470" id="h7-0-470" class="d">-	return cl, 0, &#39;&#39;
</a><a href="#h7-0-471" id="h7-0-471" class="d">-
</a><a href="#h7-0-472" id="h7-0-472" class="d">-def SplitCommaSpace(s):
</a><a href="#h7-0-473" id="h7-0-473" class="d">-	typecheck(s, str)
</a><a href="#h7-0-474" id="h7-0-474" class="d">-	s = s.strip()
</a><a href="#h7-0-475" id="h7-0-475" class="d">-	if s == &quot;&quot;:
</a><a href="#h7-0-476" id="h7-0-476" class="d">-		return []
</a><a href="#h7-0-477" id="h7-0-477" class="d">-	return re.split(&quot;, *&quot;, s)
</a><a href="#h7-0-478" id="h7-0-478" class="d">-
</a><a href="#h7-0-479" id="h7-0-479" class="d">-def CutDomain(s):
</a><a href="#h7-0-480" id="h7-0-480" class="d">-	typecheck(s, str)
</a><a href="#h7-0-481" id="h7-0-481" class="d">-	i = s.find(&#39;@&#39;)
</a><a href="#h7-0-482" id="h7-0-482" class="d">-	if i &gt;= 0:
</a><a href="#h7-0-483" id="h7-0-483" class="d">-		s = s[0:i]
</a><a href="#h7-0-484" id="h7-0-484" class="d">-	return s
</a><a href="#h7-0-485" id="h7-0-485" class="d">-
</a><a href="#h7-0-486" id="h7-0-486" class="d">-def JoinComma(l):
</a><a href="#h7-0-487" id="h7-0-487" class="d">-	for s in l:
</a><a href="#h7-0-488" id="h7-0-488" class="d">-		typecheck(s, str)
</a><a href="#h7-0-489" id="h7-0-489" class="d">-	return &quot;, &quot;.join(l)
</a><a href="#h7-0-490" id="h7-0-490" class="d">-
</a><a href="#h7-0-491" id="h7-0-491" class="d">-def ExceptionDetail():
</a><a href="#h7-0-492" id="h7-0-492" class="d">-	s = str(sys.exc_info()[0])
</a><a href="#h7-0-493" id="h7-0-493" class="d">-	if s.startswith(&quot;&lt;type &#39;&quot;) and s.endswith(&quot;&#39;&gt;&quot;):
</a><a href="#h7-0-494" id="h7-0-494" class="d">-		s = s[7:-2]
</a><a href="#h7-0-495" id="h7-0-495" class="d">-	elif s.startswith(&quot;&lt;class &#39;&quot;) and s.endswith(&quot;&#39;&gt;&quot;):
</a><a href="#h7-0-496" id="h7-0-496" class="d">-		s = s[8:-2]
</a><a href="#h7-0-497" id="h7-0-497" class="d">-	arg = str(sys.exc_info()[1])
</a><a href="#h7-0-498" id="h7-0-498" class="d">-	if len(arg) &gt; 0:
</a><a href="#h7-0-499" id="h7-0-499" class="d">-		s += &quot;: &quot; + arg
</a><a href="#h7-0-500" id="h7-0-500" class="d">-	return s
</a><a href="#h7-0-501" id="h7-0-501" class="d">-
</a><a href="#h7-0-502" id="h7-0-502" class="d">-def IsLocalCL(ui, repo, name):
</a><a href="#h7-0-503" id="h7-0-503" class="d">-	return GoodCLName(name) and os.access(CodeReviewDir(ui, repo) + &quot;/cl.&quot; + name, 0)
</a><a href="#h7-0-504" id="h7-0-504" class="d">-
</a><a href="#h7-0-505" id="h7-0-505" class="d">-# Load CL from disk and/or the web.
</a><a href="#h7-0-506" id="h7-0-506" class="d">-def LoadCL(ui, repo, name, web=True):
</a><a href="#h7-0-507" id="h7-0-507" class="d">-	typecheck(name, str)
</a><a href="#h7-0-508" id="h7-0-508" class="d">-	set_status(&quot;loading CL &quot; + name)
</a><a href="#h7-0-509" id="h7-0-509" class="d">-	if not GoodCLName(name):
</a><a href="#h7-0-510" id="h7-0-510" class="d">-		return None, &quot;invalid CL name&quot;
</a><a href="#h7-0-511" id="h7-0-511" class="d">-	dir = CodeReviewDir(ui, repo)
</a><a href="#h7-0-512" id="h7-0-512" class="d">-	path = dir + &quot;cl.&quot; + name
</a><a href="#h7-0-513" id="h7-0-513" class="d">-	if os.access(path, 0):
</a><a href="#h7-0-514" id="h7-0-514" class="d">-		ff = open(path)
</a><a href="#h7-0-515" id="h7-0-515" class="d">-		text = ff.read()
</a><a href="#h7-0-516" id="h7-0-516" class="d">-		ff.close()
</a><a href="#h7-0-517" id="h7-0-517" class="d">-		cl, lineno, err = ParseCL(text, name)
</a><a href="#h7-0-518" id="h7-0-518" class="d">-		if err != &quot;&quot;:
</a><a href="#h7-0-519" id="h7-0-519" class="d">-			return None, &quot;malformed CL data: &quot;+err
</a><a href="#h7-0-520" id="h7-0-520" class="d">-		cl.local = True
</a><a href="#h7-0-521" id="h7-0-521" class="d">-	else:
</a><a href="#h7-0-522" id="h7-0-522" class="d">-		cl = CL(name)
</a><a href="#h7-0-523" id="h7-0-523" class="d">-	if web:
</a><a href="#h7-0-524" id="h7-0-524" class="d">-		set_status(&quot;getting issue metadata from web&quot;)
</a><a href="#h7-0-525" id="h7-0-525" class="d">-		d = JSONGet(ui, &quot;/api/&quot; + name + &quot;?messages=true&quot;)
</a><a href="#h7-0-526" id="h7-0-526" class="d">-		set_status(None)
</a><a href="#h7-0-527" id="h7-0-527" class="d">-		if d is None:
</a><a href="#h7-0-528" id="h7-0-528" class="d">-			return None, &quot;cannot load CL %s from server&quot; % (name,)
</a><a href="#h7-0-529" id="h7-0-529" class="d">-		if &#39;owner_email&#39; not in d or &#39;issue&#39; not in d or str(d[&#39;issue&#39;]) != name:
</a><a href="#h7-0-530" id="h7-0-530" class="d">-			return None, &quot;malformed response loading CL data from code review server&quot;
</a><a href="#h7-0-531" id="h7-0-531" class="d">-		cl.dict = d
</a><a href="#h7-0-532" id="h7-0-532" class="d">-		cl.reviewer = d.get(&#39;reviewers&#39;, [])
</a><a href="#h7-0-533" id="h7-0-533" class="d">-		cl.cc = d.get(&#39;cc&#39;, [])
</a><a href="#h7-0-534" id="h7-0-534" class="d">-		if cl.local and cl.copied_from and cl.desc:
</a><a href="#h7-0-535" id="h7-0-535" class="d">-			# local copy of CL written by someone else
</a><a href="#h7-0-536" id="h7-0-536" class="d">-			# and we saved a description.  use that one,
</a><a href="#h7-0-537" id="h7-0-537" class="d">-			# so that committers can edit the description
</a><a href="#h7-0-538" id="h7-0-538" class="d">-			# before doing hg submit.
</a><a href="#h7-0-539" id="h7-0-539" class="d">-			pass
</a><a href="#h7-0-540" id="h7-0-540" class="d">-		else:
</a><a href="#h7-0-541" id="h7-0-541" class="d">-			cl.desc = d.get(&#39;description&#39;, &quot;&quot;)
</a><a href="#h7-0-542" id="h7-0-542" class="d">-		cl.url = server_url_base + name
</a><a href="#h7-0-543" id="h7-0-543" class="d">-		cl.web = True
</a><a href="#h7-0-544" id="h7-0-544" class="d">-		cl.private = d.get(&#39;private&#39;, False) != False
</a><a href="#h7-0-545" id="h7-0-545" class="d">-		cl.lgtm = []
</a><a href="#h7-0-546" id="h7-0-546" class="d">-		for m in d.get(&#39;messages&#39;, []):
</a><a href="#h7-0-547" id="h7-0-547" class="d">-			if m.get(&#39;approval&#39;, False) == True or m.get(&#39;disapproval&#39;, False) == True:
</a><a href="#h7-0-548" id="h7-0-548" class="d">-				who = re.sub(&#39;@.*&#39;, &#39;&#39;, m.get(&#39;sender&#39;, &#39;&#39;))
</a><a href="#h7-0-549" id="h7-0-549" class="d">-				text = re.sub(&quot;\n(.|\n)*&quot;, &#39;&#39;, m.get(&#39;text&#39;, &#39;&#39;))
</a><a href="#h7-0-550" id="h7-0-550" class="d">-				cl.lgtm.append((who, text))
</a><a href="#h7-0-551" id="h7-0-551" class="d">-
</a><a href="#h7-0-552" id="h7-0-552" class="d">-	set_status(&quot;loaded CL &quot; + name)
</a><a href="#h7-0-553" id="h7-0-553" class="d">-	return cl, &#39;&#39;
</a><a href="#h7-0-554" id="h7-0-554" class="d">-
</a><a href="#h7-0-555" id="h7-0-555" class="d">-class LoadCLThread(threading.Thread):
</a><a href="#h7-0-556" id="h7-0-556" class="d">-	def __init__(self, ui, repo, dir, f, web):
</a><a href="#h7-0-557" id="h7-0-557" class="d">-		threading.Thread.__init__(self)
</a><a href="#h7-0-558" id="h7-0-558" class="d">-		self.ui = ui
</a><a href="#h7-0-559" id="h7-0-559" class="d">-		self.repo = repo
</a><a href="#h7-0-560" id="h7-0-560" class="d">-		self.dir = dir
</a><a href="#h7-0-561" id="h7-0-561" class="d">-		self.f = f
</a><a href="#h7-0-562" id="h7-0-562" class="d">-		self.web = web
</a><a href="#h7-0-563" id="h7-0-563" class="d">-		self.cl = None
</a><a href="#h7-0-564" id="h7-0-564" class="d">-	def run(self):
</a><a href="#h7-0-565" id="h7-0-565" class="d">-		cl, err = LoadCL(self.ui, self.repo, self.f[3:], web=self.web)
</a><a href="#h7-0-566" id="h7-0-566" class="d">-		if err != &#39;&#39;:
</a><a href="#h7-0-567" id="h7-0-567" class="d">-			self.ui.warn(&quot;loading &quot;+self.dir+self.f+&quot;: &quot; + err + &quot;\n&quot;)
</a><a href="#h7-0-568" id="h7-0-568" class="d">-			return
</a><a href="#h7-0-569" id="h7-0-569" class="d">-		self.cl = cl
</a><a href="#h7-0-570" id="h7-0-570" class="d">-
</a><a href="#h7-0-571" id="h7-0-571" class="d">-# Load all the CLs from this repository.
</a><a href="#h7-0-572" id="h7-0-572" class="d">-def LoadAllCL(ui, repo, web=True):
</a><a href="#h7-0-573" id="h7-0-573" class="d">-	dir = CodeReviewDir(ui, repo)
</a><a href="#h7-0-574" id="h7-0-574" class="d">-	m = {}
</a><a href="#h7-0-575" id="h7-0-575" class="d">-	files = [f for f in os.listdir(dir) if f.startswith(&#39;cl.&#39;)]
</a><a href="#h7-0-576" id="h7-0-576" class="d">-	if not files:
</a><a href="#h7-0-577" id="h7-0-577" class="d">-		return m
</a><a href="#h7-0-578" id="h7-0-578" class="d">-	active = []
</a><a href="#h7-0-579" id="h7-0-579" class="d">-	first = True
</a><a href="#h7-0-580" id="h7-0-580" class="d">-	for f in files:
</a><a href="#h7-0-581" id="h7-0-581" class="d">-		t = LoadCLThread(ui, repo, dir, f, web)
</a><a href="#h7-0-582" id="h7-0-582" class="d">-		t.start()
</a><a href="#h7-0-583" id="h7-0-583" class="d">-		if web and first:
</a><a href="#h7-0-584" id="h7-0-584" class="d">-			# first request: wait in case it needs to authenticate
</a><a href="#h7-0-585" id="h7-0-585" class="d">-			# otherwise we get lots of user/password prompts
</a><a href="#h7-0-586" id="h7-0-586" class="d">-			# running in parallel.
</a><a href="#h7-0-587" id="h7-0-587" class="d">-			t.join()
</a><a href="#h7-0-588" id="h7-0-588" class="d">-			if t.cl:
</a><a href="#h7-0-589" id="h7-0-589" class="d">-				m[t.cl.name] = t.cl
</a><a href="#h7-0-590" id="h7-0-590" class="d">-			first = False
</a><a href="#h7-0-591" id="h7-0-591" class="d">-		else:
</a><a href="#h7-0-592" id="h7-0-592" class="d">-			active.append(t)
</a><a href="#h7-0-593" id="h7-0-593" class="d">-	for t in active:
</a><a href="#h7-0-594" id="h7-0-594" class="d">-		t.join()
</a><a href="#h7-0-595" id="h7-0-595" class="d">-		if t.cl:
</a><a href="#h7-0-596" id="h7-0-596" class="d">-			m[t.cl.name] = t.cl
</a><a href="#h7-0-597" id="h7-0-597" class="d">-	return m
</a><a href="#h7-0-598" id="h7-0-598" class="d">-
</a><a href="#h7-0-599" id="h7-0-599" class="d">-# Find repository root.  On error, ui.warn and return None
</a><a href="#h7-0-600" id="h7-0-600" class="d">-def RepoDir(ui, repo):
</a><a href="#h7-0-601" id="h7-0-601" class="d">-	url = repo.url();
</a><a href="#h7-0-602" id="h7-0-602" class="d">-	if not url.startswith(&#39;file:&#39;):
</a><a href="#h7-0-603" id="h7-0-603" class="d">-		ui.warn(&quot;repository %s is not in local file system\n&quot; % (url,))
</a><a href="#h7-0-604" id="h7-0-604" class="d">-		return None
</a><a href="#h7-0-605" id="h7-0-605" class="d">-	url = url[5:]
</a><a href="#h7-0-606" id="h7-0-606" class="d">-	if url.endswith(&#39;/&#39;):
</a><a href="#h7-0-607" id="h7-0-607" class="d">-		url = url[:-1]
</a><a href="#h7-0-608" id="h7-0-608" class="d">-	typecheck(url, str)
</a><a href="#h7-0-609" id="h7-0-609" class="d">-	return url
</a><a href="#h7-0-610" id="h7-0-610" class="d">-
</a><a href="#h7-0-611" id="h7-0-611" class="d">-# Find (or make) code review directory.  On error, ui.warn and return None
</a><a href="#h7-0-612" id="h7-0-612" class="d">-def CodeReviewDir(ui, repo):
</a><a href="#h7-0-613" id="h7-0-613" class="d">-	dir = RepoDir(ui, repo)
</a><a href="#h7-0-614" id="h7-0-614" class="d">-	if dir == None:
</a><a href="#h7-0-615" id="h7-0-615" class="d">-		return None
</a><a href="#h7-0-616" id="h7-0-616" class="d">-	dir += &#39;/.hg/codereview/&#39;
</a><a href="#h7-0-617" id="h7-0-617" class="d">-	if not os.path.isdir(dir):
</a><a href="#h7-0-618" id="h7-0-618" class="d">-		try:
</a><a href="#h7-0-619" id="h7-0-619" class="d">-			os.mkdir(dir, 0700)
</a><a href="#h7-0-620" id="h7-0-620" class="d">-		except:
</a><a href="#h7-0-621" id="h7-0-621" class="d">-			ui.warn(&#39;cannot mkdir %s: %s\n&#39; % (dir, ExceptionDetail()))
</a><a href="#h7-0-622" id="h7-0-622" class="d">-			return None
</a><a href="#h7-0-623" id="h7-0-623" class="d">-	typecheck(dir, str)
</a><a href="#h7-0-624" id="h7-0-624" class="d">-	return dir
</a><a href="#h7-0-625" id="h7-0-625" class="d">-
</a><a href="#h7-0-626" id="h7-0-626" class="d">-# Turn leading tabs into spaces, so that the common white space
</a><a href="#h7-0-627" id="h7-0-627" class="d">-# prefix doesn&#39;t get confused when people&#39;s editors write out 
</a><a href="#h7-0-628" id="h7-0-628" class="d">-# some lines with spaces, some with tabs.  Only a heuristic
</a><a href="#h7-0-629" id="h7-0-629" class="d">-# (some editors don&#39;t use 8 spaces either) but a useful one.
</a><a href="#h7-0-630" id="h7-0-630" class="d">-def TabsToSpaces(line):
</a><a href="#h7-0-631" id="h7-0-631" class="d">-	i = 0
</a><a href="#h7-0-632" id="h7-0-632" class="d">-	while i &lt; len(line) and line[i] == &#39;\t&#39;:
</a><a href="#h7-0-633" id="h7-0-633" class="d">-		i += 1
</a><a href="#h7-0-634" id="h7-0-634" class="d">-	return &#39; &#39;*(8*i) + line[i:]
</a><a href="#h7-0-635" id="h7-0-635" class="d">-
</a><a href="#h7-0-636" id="h7-0-636" class="d">-# Strip maximal common leading white space prefix from text
</a><a href="#h7-0-637" id="h7-0-637" class="d">-def StripCommon(text):
</a><a href="#h7-0-638" id="h7-0-638" class="d">-	typecheck(text, str)
</a><a href="#h7-0-639" id="h7-0-639" class="d">-	ws = None
</a><a href="#h7-0-640" id="h7-0-640" class="d">-	for line in text.split(&#39;\n&#39;):
</a><a href="#h7-0-641" id="h7-0-641" class="d">-		line = line.rstrip()
</a><a href="#h7-0-642" id="h7-0-642" class="d">-		if line == &#39;&#39;:
</a><a href="#h7-0-643" id="h7-0-643" class="d">-			continue
</a><a href="#h7-0-644" id="h7-0-644" class="d">-		line = TabsToSpaces(line)
</a><a href="#h7-0-645" id="h7-0-645" class="d">-		white = line[:len(line)-len(line.lstrip())]
</a><a href="#h7-0-646" id="h7-0-646" class="d">-		if ws == None:
</a><a href="#h7-0-647" id="h7-0-647" class="d">-			ws = white
</a><a href="#h7-0-648" id="h7-0-648" class="d">-		else:
</a><a href="#h7-0-649" id="h7-0-649" class="d">-			common = &#39;&#39;
</a><a href="#h7-0-650" id="h7-0-650" class="d">-			for i in range(min(len(white), len(ws))+1):
</a><a href="#h7-0-651" id="h7-0-651" class="d">-				if white[0:i] == ws[0:i]:
</a><a href="#h7-0-652" id="h7-0-652" class="d">-					common = white[0:i]
</a><a href="#h7-0-653" id="h7-0-653" class="d">-			ws = common
</a><a href="#h7-0-654" id="h7-0-654" class="d">-		if ws == &#39;&#39;:
</a><a href="#h7-0-655" id="h7-0-655" class="d">-			break
</a><a href="#h7-0-656" id="h7-0-656" class="d">-	if ws == None:
</a><a href="#h7-0-657" id="h7-0-657" class="d">-		return text
</a><a href="#h7-0-658" id="h7-0-658" class="d">-	t = &#39;&#39;
</a><a href="#h7-0-659" id="h7-0-659" class="d">-	for line in text.split(&#39;\n&#39;):
</a><a href="#h7-0-660" id="h7-0-660" class="d">-		line = line.rstrip()
</a><a href="#h7-0-661" id="h7-0-661" class="d">-		line = TabsToSpaces(line)
</a><a href="#h7-0-662" id="h7-0-662" class="d">-		if line.startswith(ws):
</a><a href="#h7-0-663" id="h7-0-663" class="d">-			line = line[len(ws):]
</a><a href="#h7-0-664" id="h7-0-664" class="d">-		if line == &#39;&#39; and t == &#39;&#39;:
</a><a href="#h7-0-665" id="h7-0-665" class="d">-			continue
</a><a href="#h7-0-666" id="h7-0-666" class="d">-		t += line + &#39;\n&#39;
</a><a href="#h7-0-667" id="h7-0-667" class="d">-	while len(t) &gt;= 2 and t[-2:] == &#39;\n\n&#39;:
</a><a href="#h7-0-668" id="h7-0-668" class="d">-		t = t[:-1]
</a><a href="#h7-0-669" id="h7-0-669" class="d">-	typecheck(t, str)
</a><a href="#h7-0-670" id="h7-0-670" class="d">-	return t
</a><a href="#h7-0-671" id="h7-0-671" class="d">-
</a><a href="#h7-0-672" id="h7-0-672" class="d">-# Indent text with indent.
</a><a href="#h7-0-673" id="h7-0-673" class="d">-def Indent(text, indent):
</a><a href="#h7-0-674" id="h7-0-674" class="d">-	typecheck(text, str)
</a><a href="#h7-0-675" id="h7-0-675" class="d">-	typecheck(indent, str)
</a><a href="#h7-0-676" id="h7-0-676" class="d">-	t = &#39;&#39;
</a><a href="#h7-0-677" id="h7-0-677" class="d">-	for line in text.split(&#39;\n&#39;):
</a><a href="#h7-0-678" id="h7-0-678" class="d">-		t += indent + line + &#39;\n&#39;
</a><a href="#h7-0-679" id="h7-0-679" class="d">-	typecheck(t, str)
</a><a href="#h7-0-680" id="h7-0-680" class="d">-	return t
</a><a href="#h7-0-681" id="h7-0-681" class="d">-
</a><a href="#h7-0-682" id="h7-0-682" class="d">-# Return the first line of l
</a><a href="#h7-0-683" id="h7-0-683" class="d">-def line1(text):
</a><a href="#h7-0-684" id="h7-0-684" class="d">-	typecheck(text, str)
</a><a href="#h7-0-685" id="h7-0-685" class="d">-	return text.split(&#39;\n&#39;)[0]
</a><a href="#h7-0-686" id="h7-0-686" class="d">-
</a><a href="#h7-0-687" id="h7-0-687" class="d">-_change_prolog = &quot;&quot;&quot;# Change list.
</a><a href="#h7-0-688" id="h7-0-688" class="d">-# Lines beginning with # are ignored.
</a><a href="#h7-0-689" id="h7-0-689" class="d">-# Multi-line values should be indented.
</a><a href="#h7-0-690" id="h7-0-690" class="d">-&quot;&quot;&quot;
</a><a href="#h7-0-691" id="h7-0-691" class="d">-
</a><a href="#h7-0-692" id="h7-0-692" class="d">-desc_re = &#39;^(.+: |(tag )?(release|weekly)\.|fix build|undo CL)&#39;
</a><a href="#h7-0-693" id="h7-0-693" class="d">-
</a><a href="#h7-0-694" id="h7-0-694" class="d">-desc_msg = &#39;&#39;&#39;Your CL description appears not to use the standard form.
</a><a href="#h7-0-695" id="h7-0-695" class="d">-
</a><a href="#h7-0-696" id="h7-0-696" class="d">-The first line of your change description is conventionally a
</a><a href="#h7-0-697" id="h7-0-697" class="d">-one-line summary of the change, prefixed by the primary affected package,
</a><a href="#h7-0-698" id="h7-0-698" class="d">-and is used as the subject for code review mail; the rest of the description
</a><a href="#h7-0-699" id="h7-0-699" class="d">-elaborates.
</a><a href="#h7-0-700" id="h7-0-700" class="d">-
</a><a href="#h7-0-701" id="h7-0-701" class="d">-Examples:
</a><a href="#h7-0-702" id="h7-0-702" class="d">-
</a><a href="#h7-0-703" id="h7-0-703" class="d">-	encoding/rot13: new package
</a><a href="#h7-0-704" id="h7-0-704" class="d">-
</a><a href="#h7-0-705" id="h7-0-705" class="d">-	math: add IsInf, IsNaN
</a><a href="#h7-0-706" id="h7-0-706" class="d">-	
</a><a href="#h7-0-707" id="h7-0-707" class="d">-	net: fix cname in LookupHost
</a><a href="#h7-0-708" id="h7-0-708" class="d">-
</a><a href="#h7-0-709" id="h7-0-709" class="d">-	unicode: update to Unicode 5.0.2
</a><a href="#h7-0-710" id="h7-0-710" class="d">-
</a><a href="#h7-0-711" id="h7-0-711" class="d">-&#39;&#39;&#39;
</a><a href="#h7-0-712" id="h7-0-712" class="d">-
</a><a href="#h7-0-713" id="h7-0-713" class="d">-def promptyesno(ui, msg):
</a><a href="#h7-0-714" id="h7-0-714" class="d">-	if hgversion &gt;= &quot;2.7&quot;:
</a><a href="#h7-0-715" id="h7-0-715" class="d">-		return ui.promptchoice(msg + &quot; $$ &amp;yes $$ &amp;no&quot;, 0) == 0
</a><a href="#h7-0-716" id="h7-0-716" class="d">-	else:
</a><a href="#h7-0-717" id="h7-0-717" class="d">-		return ui.promptchoice(msg, [&quot;&amp;yes&quot;, &quot;&amp;no&quot;], 0) == 0
</a><a href="#h7-0-718" id="h7-0-718" class="d">-
</a><a href="#h7-0-719" id="h7-0-719" class="d">-def promptremove(ui, repo, f):
</a><a href="#h7-0-720" id="h7-0-720" class="d">-	if promptyesno(ui, &quot;hg remove %s (y/n)?&quot; % (f,)):
</a><a href="#h7-0-721" id="h7-0-721" class="d">-		if hg_commands.remove(ui, repo, &#39;path:&#39;+f) != 0:
</a><a href="#h7-0-722" id="h7-0-722" class="d">-			ui.warn(&quot;error removing %s&quot; % (f,))
</a><a href="#h7-0-723" id="h7-0-723" class="d">-
</a><a href="#h7-0-724" id="h7-0-724" class="d">-def promptadd(ui, repo, f):
</a><a href="#h7-0-725" id="h7-0-725" class="d">-	if promptyesno(ui, &quot;hg add %s (y/n)?&quot; % (f,)):
</a><a href="#h7-0-726" id="h7-0-726" class="d">-		if hg_commands.add(ui, repo, &#39;path:&#39;+f) != 0:
</a><a href="#h7-0-727" id="h7-0-727" class="d">-			ui.warn(&quot;error adding %s&quot; % (f,))
</a><a href="#h7-0-728" id="h7-0-728" class="d">-
</a><a href="#h7-0-729" id="h7-0-729" class="d">-def EditCL(ui, repo, cl):
</a><a href="#h7-0-730" id="h7-0-730" class="d">-	set_status(None)	# do not show status
</a><a href="#h7-0-731" id="h7-0-731" class="d">-	s = cl.EditorText()
</a><a href="#h7-0-732" id="h7-0-732" class="d">-	while True:
</a><a href="#h7-0-733" id="h7-0-733" class="d">-		s = ui.edit(s, ui.username())
</a><a href="#h7-0-734" id="h7-0-734" class="d">-		
</a><a href="#h7-0-735" id="h7-0-735" class="d">-		# We can&#39;t trust Mercurial + Python not to die before making the change,
</a><a href="#h7-0-736" id="h7-0-736" class="d">-		# so, by popular demand, just scribble the most recent CL edit into
</a><a href="#h7-0-737" id="h7-0-737" class="d">-		# $(hg root)/last-change so that if Mercurial does die, people
</a><a href="#h7-0-738" id="h7-0-738" class="d">-		# can look there for their work.
</a><a href="#h7-0-739" id="h7-0-739" class="d">-		try:
</a><a href="#h7-0-740" id="h7-0-740" class="d">-			f = open(repo.root+&quot;/last-change&quot;, &quot;w&quot;)
</a><a href="#h7-0-741" id="h7-0-741" class="d">-			f.write(s)
</a><a href="#h7-0-742" id="h7-0-742" class="d">-			f.close()
</a><a href="#h7-0-743" id="h7-0-743" class="d">-		except:
</a><a href="#h7-0-744" id="h7-0-744" class="d">-			pass
</a><a href="#h7-0-745" id="h7-0-745" class="d">-
</a><a href="#h7-0-746" id="h7-0-746" class="d">-		clx, line, err = ParseCL(s, cl.name)
</a><a href="#h7-0-747" id="h7-0-747" class="d">-		if err != &#39;&#39;:
</a><a href="#h7-0-748" id="h7-0-748" class="d">-			if not promptyesno(ui, &quot;error parsing change list: line %d: %s\nre-edit (y/n)?&quot; % (line, err)):
</a><a href="#h7-0-749" id="h7-0-749" class="d">-				return &quot;change list not modified&quot;
</a><a href="#h7-0-750" id="h7-0-750" class="d">-			continue
</a><a href="#h7-0-751" id="h7-0-751" class="d">-		
</a><a href="#h7-0-752" id="h7-0-752" class="d">-		# Check description.
</a><a href="#h7-0-753" id="h7-0-753" class="d">-		if clx.desc == &#39;&#39;:
</a><a href="#h7-0-754" id="h7-0-754" class="d">-			if promptyesno(ui, &quot;change list should have a description\nre-edit (y/n)?&quot;):
</a><a href="#h7-0-755" id="h7-0-755" class="d">-				continue
</a><a href="#h7-0-756" id="h7-0-756" class="d">-		elif re.search(&#39;&lt;enter reason for undo&gt;&#39;, clx.desc):
</a><a href="#h7-0-757" id="h7-0-757" class="d">-			if promptyesno(ui, &quot;change list description omits reason for undo\nre-edit (y/n)?&quot;):
</a><a href="#h7-0-758" id="h7-0-758" class="d">-				continue
</a><a href="#h7-0-759" id="h7-0-759" class="d">-		elif not re.match(desc_re, clx.desc.split(&#39;\n&#39;)[0]):
</a><a href="#h7-0-760" id="h7-0-760" class="d">-			if promptyesno(ui, desc_msg + &quot;re-edit (y/n)?&quot;):
</a><a href="#h7-0-761" id="h7-0-761" class="d">-				continue
</a><a href="#h7-0-762" id="h7-0-762" class="d">-
</a><a href="#h7-0-763" id="h7-0-763" class="d">-		# Check file list for files that need to be hg added or hg removed
</a><a href="#h7-0-764" id="h7-0-764" class="d">-		# or simply aren&#39;t understood.
</a><a href="#h7-0-765" id="h7-0-765" class="d">-		pats = [&#39;path:&#39;+f for f in clx.files]
</a><a href="#h7-0-766" id="h7-0-766" class="d">-		changed = hg_matchPattern(ui, repo, *pats, modified=True, added=True, removed=True)
</a><a href="#h7-0-767" id="h7-0-767" class="d">-		deleted = hg_matchPattern(ui, repo, *pats, deleted=True)
</a><a href="#h7-0-768" id="h7-0-768" class="d">-		unknown = hg_matchPattern(ui, repo, *pats, unknown=True)
</a><a href="#h7-0-769" id="h7-0-769" class="d">-		ignored = hg_matchPattern(ui, repo, *pats, ignored=True)
</a><a href="#h7-0-770" id="h7-0-770" class="d">-		clean = hg_matchPattern(ui, repo, *pats, clean=True)
</a><a href="#h7-0-771" id="h7-0-771" class="d">-		files = []
</a><a href="#h7-0-772" id="h7-0-772" class="d">-		for f in clx.files:
</a><a href="#h7-0-773" id="h7-0-773" class="d">-			if f in changed:
</a><a href="#h7-0-774" id="h7-0-774" class="d">-				files.append(f)
</a><a href="#h7-0-775" id="h7-0-775" class="d">-				continue
</a><a href="#h7-0-776" id="h7-0-776" class="d">-			if f in deleted:
</a><a href="#h7-0-777" id="h7-0-777" class="d">-				promptremove(ui, repo, f)
</a><a href="#h7-0-778" id="h7-0-778" class="d">-				files.append(f)
</a><a href="#h7-0-779" id="h7-0-779" class="d">-				continue
</a><a href="#h7-0-780" id="h7-0-780" class="d">-			if f in unknown:
</a><a href="#h7-0-781" id="h7-0-781" class="d">-				promptadd(ui, repo, f)
</a><a href="#h7-0-782" id="h7-0-782" class="d">-				files.append(f)
</a><a href="#h7-0-783" id="h7-0-783" class="d">-				continue
</a><a href="#h7-0-784" id="h7-0-784" class="d">-			if f in ignored:
</a><a href="#h7-0-785" id="h7-0-785" class="d">-				ui.warn(&quot;error: %s is excluded by .hgignore; omitting\n&quot; % (f,))
</a><a href="#h7-0-786" id="h7-0-786" class="d">-				continue
</a><a href="#h7-0-787" id="h7-0-787" class="d">-			if f in clean:
</a><a href="#h7-0-788" id="h7-0-788" class="d">-				ui.warn(&quot;warning: %s is listed in the CL but unchanged\n&quot; % (f,))
</a><a href="#h7-0-789" id="h7-0-789" class="d">-				files.append(f)
</a><a href="#h7-0-790" id="h7-0-790" class="d">-				continue
</a><a href="#h7-0-791" id="h7-0-791" class="d">-			p = repo.root + &#39;/&#39; + f
</a><a href="#h7-0-792" id="h7-0-792" class="d">-			if os.path.isfile(p):
</a><a href="#h7-0-793" id="h7-0-793" class="d">-				ui.warn(&quot;warning: %s is a file but not known to hg\n&quot; % (f,))
</a><a href="#h7-0-794" id="h7-0-794" class="d">-				files.append(f)
</a><a href="#h7-0-795" id="h7-0-795" class="d">-				continue
</a><a href="#h7-0-796" id="h7-0-796" class="d">-			if os.path.isdir(p):
</a><a href="#h7-0-797" id="h7-0-797" class="d">-				ui.warn(&quot;error: %s is a directory, not a file; omitting\n&quot; % (f,))
</a><a href="#h7-0-798" id="h7-0-798" class="d">-				continue
</a><a href="#h7-0-799" id="h7-0-799" class="d">-			ui.warn(&quot;error: %s does not exist; omitting\n&quot; % (f,))
</a><a href="#h7-0-800" id="h7-0-800" class="d">-		clx.files = files
</a><a href="#h7-0-801" id="h7-0-801" class="d">-
</a><a href="#h7-0-802" id="h7-0-802" class="d">-		cl.desc = clx.desc
</a><a href="#h7-0-803" id="h7-0-803" class="d">-		cl.reviewer = clx.reviewer
</a><a href="#h7-0-804" id="h7-0-804" class="d">-		cl.cc = clx.cc
</a><a href="#h7-0-805" id="h7-0-805" class="d">-		cl.files = clx.files
</a><a href="#h7-0-806" id="h7-0-806" class="d">-		cl.private = clx.private
</a><a href="#h7-0-807" id="h7-0-807" class="d">-		break
</a><a href="#h7-0-808" id="h7-0-808" class="d">-	return &quot;&quot;
</a><a href="#h7-0-809" id="h7-0-809" class="d">-
</a><a href="#h7-0-810" id="h7-0-810" class="d">-# For use by submit, etc. (NOT by change)
</a><a href="#h7-0-811" id="h7-0-811" class="d">-# Get change list number or list of files from command line.
</a><a href="#h7-0-812" id="h7-0-812" class="d">-# If files are given, make a new change list.
</a><a href="#h7-0-813" id="h7-0-813" class="d">-def CommandLineCL(ui, repo, pats, opts, op=&quot;verb&quot;, defaultcc=None):
</a><a href="#h7-0-814" id="h7-0-814" class="d">-	if len(pats) &gt; 0 and GoodCLName(pats[0]):
</a><a href="#h7-0-815" id="h7-0-815" class="d">-		if len(pats) != 1:
</a><a href="#h7-0-816" id="h7-0-816" class="d">-			return None, &quot;cannot specify change number and file names&quot;
</a><a href="#h7-0-817" id="h7-0-817" class="d">-		if opts.get(&#39;message&#39;):
</a><a href="#h7-0-818" id="h7-0-818" class="d">-			return None, &quot;cannot use -m with existing CL&quot;
</a><a href="#h7-0-819" id="h7-0-819" class="d">-		cl, err = LoadCL(ui, repo, pats[0], web=True)
</a><a href="#h7-0-820" id="h7-0-820" class="d">-		if err != &quot;&quot;:
</a><a href="#h7-0-821" id="h7-0-821" class="d">-			return None, err
</a><a href="#h7-0-822" id="h7-0-822" class="d">-	else:
</a><a href="#h7-0-823" id="h7-0-823" class="d">-		cl = CL(&quot;new&quot;)
</a><a href="#h7-0-824" id="h7-0-824" class="d">-		cl.local = True
</a><a href="#h7-0-825" id="h7-0-825" class="d">-		cl.files = ChangedFiles(ui, repo, pats, taken=Taken(ui, repo))
</a><a href="#h7-0-826" id="h7-0-826" class="d">-		if not cl.files:
</a><a href="#h7-0-827" id="h7-0-827" class="d">-			return None, &quot;no files changed (use hg %s &lt;number&gt; to use existing CL)&quot; % op
</a><a href="#h7-0-828" id="h7-0-828" class="d">-	if opts.get(&#39;reviewer&#39;):
</a><a href="#h7-0-829" id="h7-0-829" class="d">-		cl.reviewer = Add(cl.reviewer, SplitCommaSpace(opts.get(&#39;reviewer&#39;)))
</a><a href="#h7-0-830" id="h7-0-830" class="d">-	if opts.get(&#39;cc&#39;):
</a><a href="#h7-0-831" id="h7-0-831" class="d">-		cl.cc = Add(cl.cc, SplitCommaSpace(opts.get(&#39;cc&#39;)))
</a><a href="#h7-0-832" id="h7-0-832" class="d">-	if defaultcc:
</a><a href="#h7-0-833" id="h7-0-833" class="d">-		cl.cc = Add(cl.cc, defaultcc)
</a><a href="#h7-0-834" id="h7-0-834" class="d">-	if cl.name == &quot;new&quot;:
</a><a href="#h7-0-835" id="h7-0-835" class="d">-		if opts.get(&#39;message&#39;):
</a><a href="#h7-0-836" id="h7-0-836" class="d">-			cl.desc = opts.get(&#39;message&#39;)
</a><a href="#h7-0-837" id="h7-0-837" class="d">-		else:
</a><a href="#h7-0-838" id="h7-0-838" class="d">-			err = EditCL(ui, repo, cl)
</a><a href="#h7-0-839" id="h7-0-839" class="d">-			if err != &#39;&#39;:
</a><a href="#h7-0-840" id="h7-0-840" class="d">-				return None, err
</a><a href="#h7-0-841" id="h7-0-841" class="d">-	return cl, &quot;&quot;
</a><a href="#h7-0-842" id="h7-0-842" class="d">-
</a><a href="#h7-0-843" id="h7-0-843" class="d">-#######################################################################
</a><a href="#h7-0-844" id="h7-0-844" class="d">-# Change list file management
</a><a href="#h7-0-845" id="h7-0-845" class="d">-
</a><a href="#h7-0-846" id="h7-0-846" class="d">-# Return list of changed files in repository that match pats.
</a><a href="#h7-0-847" id="h7-0-847" class="d">-# The patterns came from the command line, so we warn
</a><a href="#h7-0-848" id="h7-0-848" class="d">-# if they have no effect or cannot be understood.
</a><a href="#h7-0-849" id="h7-0-849" class="d">-def ChangedFiles(ui, repo, pats, taken=None):
</a><a href="#h7-0-850" id="h7-0-850" class="d">-	taken = taken or {}
</a><a href="#h7-0-851" id="h7-0-851" class="d">-	# Run each pattern separately so that we can warn about
</a><a href="#h7-0-852" id="h7-0-852" class="d">-	# patterns that didn&#39;t do anything useful.
</a><a href="#h7-0-853" id="h7-0-853" class="d">-	for p in pats:
</a><a href="#h7-0-854" id="h7-0-854" class="d">-		for f in hg_matchPattern(ui, repo, p, unknown=True):
</a><a href="#h7-0-855" id="h7-0-855" class="d">-			promptadd(ui, repo, f)
</a><a href="#h7-0-856" id="h7-0-856" class="d">-		for f in hg_matchPattern(ui, repo, p, removed=True):
</a><a href="#h7-0-857" id="h7-0-857" class="d">-			promptremove(ui, repo, f)
</a><a href="#h7-0-858" id="h7-0-858" class="d">-		files = hg_matchPattern(ui, repo, p, modified=True, added=True, removed=True)
</a><a href="#h7-0-859" id="h7-0-859" class="d">-		for f in files:
</a><a href="#h7-0-860" id="h7-0-860" class="d">-			if f in taken:
</a><a href="#h7-0-861" id="h7-0-861" class="d">-				ui.warn(&quot;warning: %s already in CL %s\n&quot; % (f, taken[f].name))
</a><a href="#h7-0-862" id="h7-0-862" class="d">-		if not files:
</a><a href="#h7-0-863" id="h7-0-863" class="d">-			ui.warn(&quot;warning: %s did not match any modified files\n&quot; % (p,))
</a><a href="#h7-0-864" id="h7-0-864" class="d">-
</a><a href="#h7-0-865" id="h7-0-865" class="d">-	# Again, all at once (eliminates duplicates)
</a><a href="#h7-0-866" id="h7-0-866" class="d">-	l = hg_matchPattern(ui, repo, *pats, modified=True, added=True, removed=True)
</a><a href="#h7-0-867" id="h7-0-867" class="d">-	l.sort()
</a><a href="#h7-0-868" id="h7-0-868" class="d">-	if taken:
</a><a href="#h7-0-869" id="h7-0-869" class="d">-		l = Sub(l, taken.keys())
</a><a href="#h7-0-870" id="h7-0-870" class="d">-	return l
</a><a href="#h7-0-871" id="h7-0-871" class="d">-
</a><a href="#h7-0-872" id="h7-0-872" class="d">-# Return list of changed files in repository that match pats and still exist.
</a><a href="#h7-0-873" id="h7-0-873" class="d">-def ChangedExistingFiles(ui, repo, pats, opts):
</a><a href="#h7-0-874" id="h7-0-874" class="d">-	l = hg_matchPattern(ui, repo, *pats, modified=True, added=True)
</a><a href="#h7-0-875" id="h7-0-875" class="d">-	l.sort()
</a><a href="#h7-0-876" id="h7-0-876" class="d">-	return l
</a><a href="#h7-0-877" id="h7-0-877" class="d">-
</a><a href="#h7-0-878" id="h7-0-878" class="d">-# Return list of files claimed by existing CLs
</a><a href="#h7-0-879" id="h7-0-879" class="d">-def Taken(ui, repo):
</a><a href="#h7-0-880" id="h7-0-880" class="d">-	all = LoadAllCL(ui, repo, web=False)
</a><a href="#h7-0-881" id="h7-0-881" class="d">-	taken = {}
</a><a href="#h7-0-882" id="h7-0-882" class="d">-	for _, cl in all.items():
</a><a href="#h7-0-883" id="h7-0-883" class="d">-		for f in cl.files:
</a><a href="#h7-0-884" id="h7-0-884" class="d">-			taken[f] = cl
</a><a href="#h7-0-885" id="h7-0-885" class="d">-	return taken
</a><a href="#h7-0-886" id="h7-0-886" class="d">-
</a><a href="#h7-0-887" id="h7-0-887" class="d">-# Return list of changed files that are not claimed by other CLs
</a><a href="#h7-0-888" id="h7-0-888" class="d">-def DefaultFiles(ui, repo, pats):
</a><a href="#h7-0-889" id="h7-0-889" class="d">-	return ChangedFiles(ui, repo, pats, taken=Taken(ui, repo))
</a><a href="#h7-0-890" id="h7-0-890" class="d">-
</a><a href="#h7-0-891" id="h7-0-891" class="d">-#######################################################################
</a><a href="#h7-0-892" id="h7-0-892" class="d">-# File format checking.
</a><a href="#h7-0-893" id="h7-0-893" class="d">-
</a><a href="#h7-0-894" id="h7-0-894" class="d">-def CheckFormat(ui, repo, files, just_warn=False):
</a><a href="#h7-0-895" id="h7-0-895" class="d">-	set_status(&quot;running gofmt&quot;)
</a><a href="#h7-0-896" id="h7-0-896" class="d">-	CheckGofmt(ui, repo, files, just_warn)
</a><a href="#h7-0-897" id="h7-0-897" class="d">-	CheckTabfmt(ui, repo, files, just_warn)
</a><a href="#h7-0-898" id="h7-0-898" class="d">-
</a><a href="#h7-0-899" id="h7-0-899" class="d">-# Check that gofmt run on the list of files does not change them
</a><a href="#h7-0-900" id="h7-0-900" class="d">-def CheckGofmt(ui, repo, files, just_warn):
</a><a href="#h7-0-901" id="h7-0-901" class="d">-	files = gofmt_required(files)
</a><a href="#h7-0-902" id="h7-0-902" class="d">-	if not files:
</a><a href="#h7-0-903" id="h7-0-903" class="d">-		return
</a><a href="#h7-0-904" id="h7-0-904" class="d">-	cwd = os.getcwd()
</a><a href="#h7-0-905" id="h7-0-905" class="d">-	files = [RelativePath(repo.root + &#39;/&#39; + f, cwd) for f in files]
</a><a href="#h7-0-906" id="h7-0-906" class="d">-	files = [f for f in files if os.access(f, 0)]
</a><a href="#h7-0-907" id="h7-0-907" class="d">-	if not files:
</a><a href="#h7-0-908" id="h7-0-908" class="d">-		return
</a><a href="#h7-0-909" id="h7-0-909" class="d">-	try:
</a><a href="#h7-0-910" id="h7-0-910" class="d">-		cmd = subprocess.Popen([&quot;gofmt&quot;, &quot;-l&quot;] + files, shell=False, stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE, close_fds=sys.platform != &quot;win32&quot;)
</a><a href="#h7-0-911" id="h7-0-911" class="d">-		cmd.stdin.close()
</a><a href="#h7-0-912" id="h7-0-912" class="d">-	except:
</a><a href="#h7-0-913" id="h7-0-913" class="d">-		raise hg_util.Abort(&quot;gofmt: &quot; + ExceptionDetail())
</a><a href="#h7-0-914" id="h7-0-914" class="d">-	data = cmd.stdout.read()
</a><a href="#h7-0-915" id="h7-0-915" class="d">-	errors = cmd.stderr.read()
</a><a href="#h7-0-916" id="h7-0-916" class="d">-	cmd.wait()
</a><a href="#h7-0-917" id="h7-0-917" class="d">-	set_status(&quot;done with gofmt&quot;)
</a><a href="#h7-0-918" id="h7-0-918" class="d">-	if len(errors) &gt; 0:
</a><a href="#h7-0-919" id="h7-0-919" class="d">-		ui.warn(&quot;gofmt errors:\n&quot; + errors.rstrip() + &quot;\n&quot;)
</a><a href="#h7-0-920" id="h7-0-920" class="d">-		return
</a><a href="#h7-0-921" id="h7-0-921" class="d">-	if len(data) &gt; 0:
</a><a href="#h7-0-922" id="h7-0-922" class="d">-		msg = &quot;gofmt needs to format these files (run hg gofmt):\n&quot; + Indent(data, &quot;\t&quot;).rstrip()
</a><a href="#h7-0-923" id="h7-0-923" class="d">-		if just_warn:
</a><a href="#h7-0-924" id="h7-0-924" class="d">-			ui.warn(&quot;warning: &quot; + msg + &quot;\n&quot;)
</a><a href="#h7-0-925" id="h7-0-925" class="d">-		else:
</a><a href="#h7-0-926" id="h7-0-926" class="d">-			raise hg_util.Abort(msg)
</a><a href="#h7-0-927" id="h7-0-927" class="d">-	return
</a><a href="#h7-0-928" id="h7-0-928" class="d">-
</a><a href="#h7-0-929" id="h7-0-929" class="d">-# Check that *.[chys] files indent using tabs.
</a><a href="#h7-0-930" id="h7-0-930" class="d">-def CheckTabfmt(ui, repo, files, just_warn):
</a><a href="#h7-0-931" id="h7-0-931" class="d">-	files = [f for f in files if f.startswith(&#39;src/&#39;) and re.search(r&quot;\.[chys]$&quot;, f) and not re.search(r&quot;\.tab\.[ch]$&quot;, f)]
</a><a href="#h7-0-932" id="h7-0-932" class="d">-	if not files:
</a><a href="#h7-0-933" id="h7-0-933" class="d">-		return
</a><a href="#h7-0-934" id="h7-0-934" class="d">-	cwd = os.getcwd()
</a><a href="#h7-0-935" id="h7-0-935" class="d">-	files = [RelativePath(repo.root + &#39;/&#39; + f, cwd) for f in files]
</a><a href="#h7-0-936" id="h7-0-936" class="d">-	files = [f for f in files if os.access(f, 0)]
</a><a href="#h7-0-937" id="h7-0-937" class="d">-	badfiles = []
</a><a href="#h7-0-938" id="h7-0-938" class="d">-	for f in files:
</a><a href="#h7-0-939" id="h7-0-939" class="d">-		try:
</a><a href="#h7-0-940" id="h7-0-940" class="d">-			for line in open(f, &#39;r&#39;):
</a><a href="#h7-0-941" id="h7-0-941" class="d">-				# Four leading spaces is enough to complain about,
</a><a href="#h7-0-942" id="h7-0-942" class="d">-				# except that some Plan 9 code uses four spaces as the label indent,
</a><a href="#h7-0-943" id="h7-0-943" class="d">-				# so allow that.
</a><a href="#h7-0-944" id="h7-0-944" class="d">-				if line.startswith(&#39;    &#39;) and not re.match(&#39;    [A-Za-z0-9_]+:&#39;, line):
</a><a href="#h7-0-945" id="h7-0-945" class="d">-					badfiles.append(f)
</a><a href="#h7-0-946" id="h7-0-946" class="d">-					break
</a><a href="#h7-0-947" id="h7-0-947" class="d">-		except:
</a><a href="#h7-0-948" id="h7-0-948" class="d">-			# ignore cannot open file, etc.
</a><a href="#h7-0-949" id="h7-0-949" class="d">-			pass
</a><a href="#h7-0-950" id="h7-0-950" class="d">-	if len(badfiles) &gt; 0:
</a><a href="#h7-0-951" id="h7-0-951" class="d">-		msg = &quot;these files use spaces for indentation (use tabs instead):\n\t&quot; + &quot;\n\t&quot;.join(badfiles)
</a><a href="#h7-0-952" id="h7-0-952" class="d">-		if just_warn:
</a><a href="#h7-0-953" id="h7-0-953" class="d">-			ui.warn(&quot;warning: &quot; + msg + &quot;\n&quot;)
</a><a href="#h7-0-954" id="h7-0-954" class="d">-		else:
</a><a href="#h7-0-955" id="h7-0-955" class="d">-			raise hg_util.Abort(msg)
</a><a href="#h7-0-956" id="h7-0-956" class="d">-	return
</a><a href="#h7-0-957" id="h7-0-957" class="d">-
</a><a href="#h7-0-958" id="h7-0-958" class="d">-#######################################################################
</a><a href="#h7-0-959" id="h7-0-959" class="d">-# CONTRIBUTORS file parsing
</a><a href="#h7-0-960" id="h7-0-960" class="d">-
</a><a href="#h7-0-961" id="h7-0-961" class="d">-contributorsCache = None
</a><a href="#h7-0-962" id="h7-0-962" class="d">-contributorsURL = None
</a><a href="#h7-0-963" id="h7-0-963" class="d">-
</a><a href="#h7-0-964" id="h7-0-964" class="d">-def ReadContributors(ui, repo):
</a><a href="#h7-0-965" id="h7-0-965" class="d">-	global contributorsCache
</a><a href="#h7-0-966" id="h7-0-966" class="d">-	if contributorsCache is not None:
</a><a href="#h7-0-967" id="h7-0-967" class="d">-		return contributorsCache
</a><a href="#h7-0-968" id="h7-0-968" class="d">-
</a><a href="#h7-0-969" id="h7-0-969" class="d">-	try:
</a><a href="#h7-0-970" id="h7-0-970" class="d">-		if contributorsURL is not None:
</a><a href="#h7-0-971" id="h7-0-971" class="d">-			opening = contributorsURL
</a><a href="#h7-0-972" id="h7-0-972" class="d">-			f = urllib2.urlopen(contributorsURL)
</a><a href="#h7-0-973" id="h7-0-973" class="d">-		else:
</a><a href="#h7-0-974" id="h7-0-974" class="d">-			opening = repo.root + &#39;/CONTRIBUTORS&#39;
</a><a href="#h7-0-975" id="h7-0-975" class="d">-			f = open(repo.root + &#39;/CONTRIBUTORS&#39;, &#39;r&#39;)
</a><a href="#h7-0-976" id="h7-0-976" class="d">-	except:
</a><a href="#h7-0-977" id="h7-0-977" class="d">-		ui.write(&quot;warning: cannot open %s: %s\n&quot; % (opening, ExceptionDetail()))
</a><a href="#h7-0-978" id="h7-0-978" class="d">-		return
</a><a href="#h7-0-979" id="h7-0-979" class="d">-
</a><a href="#h7-0-980" id="h7-0-980" class="d">-	contributors = {}
</a><a href="#h7-0-981" id="h7-0-981" class="d">-	for line in f:
</a><a href="#h7-0-982" id="h7-0-982" class="d">-		# CONTRIBUTORS is a list of lines like:
</a><a href="#h7-0-983" id="h7-0-983" class="d">-		#	Person &lt;email&gt;
</a><a href="#h7-0-984" id="h7-0-984" class="d">-		#	Person &lt;email&gt; &lt;alt-email&gt;
</a><a href="#h7-0-985" id="h7-0-985" class="d">-		# The first email address is the one used in commit logs.
</a><a href="#h7-0-986" id="h7-0-986" class="d">-		if line.startswith(&#39;#&#39;):
</a><a href="#h7-0-987" id="h7-0-987" class="d">-			continue
</a><a href="#h7-0-988" id="h7-0-988" class="d">-		m = re.match(r&quot;([^&lt;&gt;]+\S)\s+(&lt;[^&lt;&gt;\s]+&gt;)((\s+&lt;[^&lt;&gt;\s]+&gt;)*)\s*$&quot;, line)
</a><a href="#h7-0-989" id="h7-0-989" class="d">-		if m:
</a><a href="#h7-0-990" id="h7-0-990" class="d">-			name = m.group(1)
</a><a href="#h7-0-991" id="h7-0-991" class="d">-			email = m.group(2)[1:-1]
</a><a href="#h7-0-992" id="h7-0-992" class="d">-			contributors[email.lower()] = (name, email)
</a><a href="#h7-0-993" id="h7-0-993" class="d">-			for extra in m.group(3).split():
</a><a href="#h7-0-994" id="h7-0-994" class="d">-				contributors[extra[1:-1].lower()] = (name, email)
</a><a href="#h7-0-995" id="h7-0-995" class="d">-
</a><a href="#h7-0-996" id="h7-0-996" class="d">-	contributorsCache = contributors
</a><a href="#h7-0-997" id="h7-0-997" class="d">-	return contributors
</a><a href="#h7-0-998" id="h7-0-998" class="d">-
</a><a href="#h7-0-999" id="h7-0-999" class="d">-def CheckContributor(ui, repo, user=None):
</a><a href="#h7-0-1000" id="h7-0-1000" class="d">-	set_status(&quot;checking CONTRIBUTORS file&quot;)
</a><a href="#h7-0-1001" id="h7-0-1001" class="d">-	user, userline = FindContributor(ui, repo, user, warn=False)
</a><a href="#h7-0-1002" id="h7-0-1002" class="d">-	if not userline:
</a><a href="#h7-0-1003" id="h7-0-1003" class="d">-		raise hg_util.Abort(&quot;cannot find %s in CONTRIBUTORS&quot; % (user,))
</a><a href="#h7-0-1004" id="h7-0-1004" class="d">-	return userline
</a><a href="#h7-0-1005" id="h7-0-1005" class="d">-
</a><a href="#h7-0-1006" id="h7-0-1006" class="d">-def FindContributor(ui, repo, user=None, warn=True):
</a><a href="#h7-0-1007" id="h7-0-1007" class="d">-	if not user:
</a><a href="#h7-0-1008" id="h7-0-1008" class="d">-		user = ui.config(&quot;ui&quot;, &quot;username&quot;)
</a><a href="#h7-0-1009" id="h7-0-1009" class="d">-		if not user:
</a><a href="#h7-0-1010" id="h7-0-1010" class="d">-			raise hg_util.Abort(&quot;[ui] username is not configured in .hgrc&quot;)
</a><a href="#h7-0-1011" id="h7-0-1011" class="d">-	user = user.lower()
</a><a href="#h7-0-1012" id="h7-0-1012" class="d">-	m = re.match(r&quot;.*&lt;(.*)&gt;&quot;, user)
</a><a href="#h7-0-1013" id="h7-0-1013" class="d">-	if m:
</a><a href="#h7-0-1014" id="h7-0-1014" class="d">-		user = m.group(1)
</a><a href="#h7-0-1015" id="h7-0-1015" class="d">-
</a><a href="#h7-0-1016" id="h7-0-1016" class="d">-	contributors = ReadContributors(ui, repo)
</a><a href="#h7-0-1017" id="h7-0-1017" class="d">-	if user not in contributors:
</a><a href="#h7-0-1018" id="h7-0-1018" class="d">-		if warn:
</a><a href="#h7-0-1019" id="h7-0-1019" class="d">-			ui.warn(&quot;warning: cannot find %s in CONTRIBUTORS\n&quot; % (user,))
</a><a href="#h7-0-1020" id="h7-0-1020" class="d">-		return user, None
</a><a href="#h7-0-1021" id="h7-0-1021" class="d">-	
</a><a href="#h7-0-1022" id="h7-0-1022" class="d">-	user, email = contributors[user]
</a><a href="#h7-0-1023" id="h7-0-1023" class="d">-	return email, &quot;%s &lt;%s&gt;&quot; % (user, email)
</a><a href="#h7-0-1024" id="h7-0-1024" class="d">-
</a><a href="#h7-0-1025" id="h7-0-1025" class="d">-#######################################################################
</a><a href="#h7-0-1026" id="h7-0-1026" class="d">-# Mercurial helper functions.
</a><a href="#h7-0-1027" id="h7-0-1027" class="d">-# Read http://mercurial.selenic.com/wiki/MercurialApi before writing any of these.
</a><a href="#h7-0-1028" id="h7-0-1028" class="d">-# We use the ui.pushbuffer/ui.popbuffer + hg_commands.xxx tricks for all interaction
</a><a href="#h7-0-1029" id="h7-0-1029" class="d">-# with Mercurial.  It has proved the most stable as they make changes.
</a><a href="#h7-0-1030" id="h7-0-1030" class="d">-
</a><a href="#h7-0-1031" id="h7-0-1031" class="d">-hgversion = hg_util.version()
</a><a href="#h7-0-1032" id="h7-0-1032" class="d">-
</a><a href="#h7-0-1033" id="h7-0-1033" class="d">-# We require Mercurial 1.9 and suggest Mercurial 2.1.
</a><a href="#h7-0-1034" id="h7-0-1034" class="d">-# The details of the scmutil package changed then,
</a><a href="#h7-0-1035" id="h7-0-1035" class="d">-# so allowing earlier versions would require extra band-aids below.
</a><a href="#h7-0-1036" id="h7-0-1036" class="d">-# Ubuntu 11.10 ships with Mercurial 1.9.1 as the default version.
</a><a href="#h7-0-1037" id="h7-0-1037" class="d">-hg_required = &quot;1.9&quot;
</a><a href="#h7-0-1038" id="h7-0-1038" class="d">-hg_suggested = &quot;2.1&quot;
</a><a href="#h7-0-1039" id="h7-0-1039" class="d">-
</a><a href="#h7-0-1040" id="h7-0-1040" class="d">-old_message = &quot;&quot;&quot;
</a><a href="#h7-0-1041" id="h7-0-1041" class="d">-
</a><a href="#h7-0-1042" id="h7-0-1042" class="d">-The code review extension requires Mercurial &quot;&quot;&quot;+hg_required+&quot;&quot;&quot; or newer.
</a><a href="#h7-0-1043" id="h7-0-1043" class="d">-You are using Mercurial &quot;&quot;&quot;+hgversion+&quot;&quot;&quot;.
</a><a href="#h7-0-1044" id="h7-0-1044" class="d">-
</a><a href="#h7-0-1045" id="h7-0-1045" class="d">-To install a new Mercurial, visit http://mercurial.selenic.com/downloads/.
</a><a href="#h7-0-1046" id="h7-0-1046" class="d">-&quot;&quot;&quot;
</a><a href="#h7-0-1047" id="h7-0-1047" class="d">-
</a><a href="#h7-0-1048" id="h7-0-1048" class="d">-linux_message = &quot;&quot;&quot;
</a><a href="#h7-0-1049" id="h7-0-1049" class="d">-You may need to clear your current Mercurial installation by running:
</a><a href="#h7-0-1050" id="h7-0-1050" class="d">-
</a><a href="#h7-0-1051" id="h7-0-1051" class="d">-	sudo apt-get remove mercurial mercurial-common
</a><a href="#h7-0-1052" id="h7-0-1052" class="d">-	sudo rm -rf /etc/mercurial
</a><a href="#h7-0-1053" id="h7-0-1053" class="d">-&quot;&quot;&quot;
</a><a href="#h7-0-1054" id="h7-0-1054" class="d">-
</a><a href="#h7-0-1055" id="h7-0-1055" class="d">-if hgversion &lt; hg_required:
</a><a href="#h7-0-1056" id="h7-0-1056" class="d">-	msg = old_message
</a><a href="#h7-0-1057" id="h7-0-1057" class="d">-	if os.access(&quot;/etc/mercurial&quot;, 0):
</a><a href="#h7-0-1058" id="h7-0-1058" class="d">-		msg += linux_message
</a><a href="#h7-0-1059" id="h7-0-1059" class="d">-	raise hg_util.Abort(msg)
</a><a href="#h7-0-1060" id="h7-0-1060" class="d">-
</a><a href="#h7-0-1061" id="h7-0-1061" class="d">-from mercurial.hg import clean as hg_clean
</a><a href="#h7-0-1062" id="h7-0-1062" class="d">-from mercurial import cmdutil as hg_cmdutil
</a><a href="#h7-0-1063" id="h7-0-1063" class="d">-from mercurial import error as hg_error
</a><a href="#h7-0-1064" id="h7-0-1064" class="d">-from mercurial import match as hg_match
</a><a href="#h7-0-1065" id="h7-0-1065" class="d">-from mercurial import node as hg_node
</a><a href="#h7-0-1066" id="h7-0-1066" class="d">-
</a><a href="#h7-0-1067" id="h7-0-1067" class="d">-class uiwrap(object):
</a><a href="#h7-0-1068" id="h7-0-1068" class="d">-	def __init__(self, ui):
</a><a href="#h7-0-1069" id="h7-0-1069" class="d">-		self.ui = ui
</a><a href="#h7-0-1070" id="h7-0-1070" class="d">-		ui.pushbuffer()
</a><a href="#h7-0-1071" id="h7-0-1071" class="d">-		self.oldQuiet = ui.quiet
</a><a href="#h7-0-1072" id="h7-0-1072" class="d">-		ui.quiet = True
</a><a href="#h7-0-1073" id="h7-0-1073" class="d">-		self.oldVerbose = ui.verbose
</a><a href="#h7-0-1074" id="h7-0-1074" class="d">-		ui.verbose = False
</a><a href="#h7-0-1075" id="h7-0-1075" class="d">-	def output(self):
</a><a href="#h7-0-1076" id="h7-0-1076" class="d">-		ui = self.ui
</a><a href="#h7-0-1077" id="h7-0-1077" class="d">-		ui.quiet = self.oldQuiet
</a><a href="#h7-0-1078" id="h7-0-1078" class="d">-		ui.verbose = self.oldVerbose
</a><a href="#h7-0-1079" id="h7-0-1079" class="d">-		return ui.popbuffer()
</a><a href="#h7-0-1080" id="h7-0-1080" class="d">-
</a><a href="#h7-0-1081" id="h7-0-1081" class="d">-def to_slash(path):
</a><a href="#h7-0-1082" id="h7-0-1082" class="d">-	if sys.platform == &quot;win32&quot;:
</a><a href="#h7-0-1083" id="h7-0-1083" class="d">-		return path.replace(&#39;\\&#39;, &#39;/&#39;)
</a><a href="#h7-0-1084" id="h7-0-1084" class="d">-	return path
</a><a href="#h7-0-1085" id="h7-0-1085" class="d">-
</a><a href="#h7-0-1086" id="h7-0-1086" class="d">-def hg_matchPattern(ui, repo, *pats, **opts):
</a><a href="#h7-0-1087" id="h7-0-1087" class="d">-	w = uiwrap(ui)
</a><a href="#h7-0-1088" id="h7-0-1088" class="d">-	hg_commands.status(ui, repo, *pats, **opts)
</a><a href="#h7-0-1089" id="h7-0-1089" class="d">-	text = w.output()
</a><a href="#h7-0-1090" id="h7-0-1090" class="d">-	ret = []
</a><a href="#h7-0-1091" id="h7-0-1091" class="d">-	prefix = to_slash(os.path.realpath(repo.root))+&#39;/&#39;
</a><a href="#h7-0-1092" id="h7-0-1092" class="d">-	for line in text.split(&#39;\n&#39;):
</a><a href="#h7-0-1093" id="h7-0-1093" class="d">-		f = line.split()
</a><a href="#h7-0-1094" id="h7-0-1094" class="d">-		if len(f) &gt; 1:
</a><a href="#h7-0-1095" id="h7-0-1095" class="d">-			if len(pats) &gt; 0:
</a><a href="#h7-0-1096" id="h7-0-1096" class="d">-				# Given patterns, Mercurial shows relative to cwd
</a><a href="#h7-0-1097" id="h7-0-1097" class="d">-				p = to_slash(os.path.realpath(f[1]))
</a><a href="#h7-0-1098" id="h7-0-1098" class="d">-				if not p.startswith(prefix):
</a><a href="#h7-0-1099" id="h7-0-1099" class="d">-					print &gt;&gt;sys.stderr, &quot;File %s not in repo root %s.\n&quot; % (p, prefix)
</a><a href="#h7-0-1100" id="h7-0-1100" class="d">-				else:
</a><a href="#h7-0-1101" id="h7-0-1101" class="d">-					ret.append(p[len(prefix):])
</a><a href="#h7-0-1102" id="h7-0-1102" class="d">-			else:
</a><a href="#h7-0-1103" id="h7-0-1103" class="d">-				# Without patterns, Mercurial shows relative to root (what we want)
</a><a href="#h7-0-1104" id="h7-0-1104" class="d">-				ret.append(to_slash(f[1]))
</a><a href="#h7-0-1105" id="h7-0-1105" class="d">-	return ret
</a><a href="#h7-0-1106" id="h7-0-1106" class="d">-
</a><a href="#h7-0-1107" id="h7-0-1107" class="d">-def hg_heads(ui, repo):
</a><a href="#h7-0-1108" id="h7-0-1108" class="d">-	w = uiwrap(ui)
</a><a href="#h7-0-1109" id="h7-0-1109" class="d">-	hg_commands.heads(ui, repo)
</a><a href="#h7-0-1110" id="h7-0-1110" class="d">-	return w.output()
</a><a href="#h7-0-1111" id="h7-0-1111" class="d">-
</a><a href="#h7-0-1112" id="h7-0-1112" class="d">-noise = [
</a><a href="#h7-0-1113" id="h7-0-1113" class="d">-	&quot;&quot;,
</a><a href="#h7-0-1114" id="h7-0-1114" class="d">-	&quot;resolving manifests&quot;,
</a><a href="#h7-0-1115" id="h7-0-1115" class="d">-	&quot;searching for changes&quot;,
</a><a href="#h7-0-1116" id="h7-0-1116" class="d">-	&quot;couldn&#39;t find merge tool hgmerge&quot;,
</a><a href="#h7-0-1117" id="h7-0-1117" class="d">-	&quot;adding changesets&quot;,
</a><a href="#h7-0-1118" id="h7-0-1118" class="d">-	&quot;adding manifests&quot;,
</a><a href="#h7-0-1119" id="h7-0-1119" class="d">-	&quot;adding file changes&quot;,
</a><a href="#h7-0-1120" id="h7-0-1120" class="d">-	&quot;all local heads known remotely&quot;,
</a><a href="#h7-0-1121" id="h7-0-1121" class="d">-]
</a><a href="#h7-0-1122" id="h7-0-1122" class="d">-
</a><a href="#h7-0-1123" id="h7-0-1123" class="d">-def isNoise(line):
</a><a href="#h7-0-1124" id="h7-0-1124" class="d">-	line = str(line)
</a><a href="#h7-0-1125" id="h7-0-1125" class="d">-	for x in noise:
</a><a href="#h7-0-1126" id="h7-0-1126" class="d">-		if line == x:
</a><a href="#h7-0-1127" id="h7-0-1127" class="d">-			return True
</a><a href="#h7-0-1128" id="h7-0-1128" class="d">-	return False
</a><a href="#h7-0-1129" id="h7-0-1129" class="d">-
</a><a href="#h7-0-1130" id="h7-0-1130" class="d">-def hg_incoming(ui, repo):
</a><a href="#h7-0-1131" id="h7-0-1131" class="d">-	w = uiwrap(ui)
</a><a href="#h7-0-1132" id="h7-0-1132" class="d">-	ret = hg_commands.incoming(ui, repo, force=False, bundle=&quot;&quot;)
</a><a href="#h7-0-1133" id="h7-0-1133" class="d">-	if ret and ret != 1:
</a><a href="#h7-0-1134" id="h7-0-1134" class="d">-		raise hg_util.Abort(ret)
</a><a href="#h7-0-1135" id="h7-0-1135" class="d">-	return w.output()
</a><a href="#h7-0-1136" id="h7-0-1136" class="d">-
</a><a href="#h7-0-1137" id="h7-0-1137" class="d">-def hg_log(ui, repo, **opts):
</a><a href="#h7-0-1138" id="h7-0-1138" class="d">-	for k in [&#39;date&#39;, &#39;keyword&#39;, &#39;rev&#39;, &#39;user&#39;]:
</a><a href="#h7-0-1139" id="h7-0-1139" class="d">-		if not opts.has_key(k):
</a><a href="#h7-0-1140" id="h7-0-1140" class="d">-			opts[k] = &quot;&quot;
</a><a href="#h7-0-1141" id="h7-0-1141" class="d">-	w = uiwrap(ui)
</a><a href="#h7-0-1142" id="h7-0-1142" class="d">-	ret = hg_commands.log(ui, repo, **opts)
</a><a href="#h7-0-1143" id="h7-0-1143" class="d">-	if ret:
</a><a href="#h7-0-1144" id="h7-0-1144" class="d">-		raise hg_util.Abort(ret)
</a><a href="#h7-0-1145" id="h7-0-1145" class="d">-	return w.output()
</a><a href="#h7-0-1146" id="h7-0-1146" class="d">-
</a><a href="#h7-0-1147" id="h7-0-1147" class="d">-def hg_outgoing(ui, repo, **opts):
</a><a href="#h7-0-1148" id="h7-0-1148" class="d">-	w = uiwrap(ui)
</a><a href="#h7-0-1149" id="h7-0-1149" class="d">-	ret = hg_commands.outgoing(ui, repo, **opts)
</a><a href="#h7-0-1150" id="h7-0-1150" class="d">-	if ret and ret != 1:
</a><a href="#h7-0-1151" id="h7-0-1151" class="d">-		raise hg_util.Abort(ret)
</a><a href="#h7-0-1152" id="h7-0-1152" class="d">-	return w.output()
</a><a href="#h7-0-1153" id="h7-0-1153" class="d">-
</a><a href="#h7-0-1154" id="h7-0-1154" class="d">-def hg_pull(ui, repo, **opts):
</a><a href="#h7-0-1155" id="h7-0-1155" class="d">-	w = uiwrap(ui)
</a><a href="#h7-0-1156" id="h7-0-1156" class="d">-	ui.quiet = False
</a><a href="#h7-0-1157" id="h7-0-1157" class="d">-	ui.verbose = True  # for file list
</a><a href="#h7-0-1158" id="h7-0-1158" class="d">-	err = hg_commands.pull(ui, repo, **opts)
</a><a href="#h7-0-1159" id="h7-0-1159" class="d">-	for line in w.output().split(&#39;\n&#39;):
</a><a href="#h7-0-1160" id="h7-0-1160" class="d">-		if isNoise(line):
</a><a href="#h7-0-1161" id="h7-0-1161" class="d">-			continue
</a><a href="#h7-0-1162" id="h7-0-1162" class="d">-		if line.startswith(&#39;moving &#39;):
</a><a href="#h7-0-1163" id="h7-0-1163" class="d">-			line = &#39;mv &#39; + line[len(&#39;moving &#39;):]
</a><a href="#h7-0-1164" id="h7-0-1164" class="d">-		if line.startswith(&#39;getting &#39;) and line.find(&#39; to &#39;) &gt;= 0:
</a><a href="#h7-0-1165" id="h7-0-1165" class="d">-			line = &#39;mv &#39; + line[len(&#39;getting &#39;):]
</a><a href="#h7-0-1166" id="h7-0-1166" class="d">-		if line.startswith(&#39;getting &#39;):
</a><a href="#h7-0-1167" id="h7-0-1167" class="d">-			line = &#39;+ &#39; + line[len(&#39;getting &#39;):]
</a><a href="#h7-0-1168" id="h7-0-1168" class="d">-		if line.startswith(&#39;removing &#39;):
</a><a href="#h7-0-1169" id="h7-0-1169" class="d">-			line = &#39;- &#39; + line[len(&#39;removing &#39;):]
</a><a href="#h7-0-1170" id="h7-0-1170" class="d">-		ui.write(line + &#39;\n&#39;)
</a><a href="#h7-0-1171" id="h7-0-1171" class="d">-	return err
</a><a href="#h7-0-1172" id="h7-0-1172" class="d">-
</a><a href="#h7-0-1173" id="h7-0-1173" class="d">-def hg_update(ui, repo, **opts):
</a><a href="#h7-0-1174" id="h7-0-1174" class="d">-	w = uiwrap(ui)
</a><a href="#h7-0-1175" id="h7-0-1175" class="d">-	ui.quiet = False
</a><a href="#h7-0-1176" id="h7-0-1176" class="d">-	ui.verbose = True  # for file list
</a><a href="#h7-0-1177" id="h7-0-1177" class="d">-	err = hg_commands.update(ui, repo, **opts)
</a><a href="#h7-0-1178" id="h7-0-1178" class="d">-	for line in w.output().split(&#39;\n&#39;):
</a><a href="#h7-0-1179" id="h7-0-1179" class="d">-		if isNoise(line):
</a><a href="#h7-0-1180" id="h7-0-1180" class="d">-			continue
</a><a href="#h7-0-1181" id="h7-0-1181" class="d">-		if line.startswith(&#39;moving &#39;):
</a><a href="#h7-0-1182" id="h7-0-1182" class="d">-			line = &#39;mv &#39; + line[len(&#39;moving &#39;):]
</a><a href="#h7-0-1183" id="h7-0-1183" class="d">-		if line.startswith(&#39;getting &#39;) and line.find(&#39; to &#39;) &gt;= 0:
</a><a href="#h7-0-1184" id="h7-0-1184" class="d">-			line = &#39;mv &#39; + line[len(&#39;getting &#39;):]
</a><a href="#h7-0-1185" id="h7-0-1185" class="d">-		if line.startswith(&#39;getting &#39;):
</a><a href="#h7-0-1186" id="h7-0-1186" class="d">-			line = &#39;+ &#39; + line[len(&#39;getting &#39;):]
</a><a href="#h7-0-1187" id="h7-0-1187" class="d">-		if line.startswith(&#39;removing &#39;):
</a><a href="#h7-0-1188" id="h7-0-1188" class="d">-			line = &#39;- &#39; + line[len(&#39;removing &#39;):]
</a><a href="#h7-0-1189" id="h7-0-1189" class="d">-		ui.write(line + &#39;\n&#39;)
</a><a href="#h7-0-1190" id="h7-0-1190" class="d">-	return err
</a><a href="#h7-0-1191" id="h7-0-1191" class="d">-
</a><a href="#h7-0-1192" id="h7-0-1192" class="d">-def hg_push(ui, repo, **opts):
</a><a href="#h7-0-1193" id="h7-0-1193" class="d">-	w = uiwrap(ui)
</a><a href="#h7-0-1194" id="h7-0-1194" class="d">-	ui.quiet = False
</a><a href="#h7-0-1195" id="h7-0-1195" class="d">-	ui.verbose = True
</a><a href="#h7-0-1196" id="h7-0-1196" class="d">-	err = hg_commands.push(ui, repo, **opts)
</a><a href="#h7-0-1197" id="h7-0-1197" class="d">-	for line in w.output().split(&#39;\n&#39;):
</a><a href="#h7-0-1198" id="h7-0-1198" class="d">-		if not isNoise(line):
</a><a href="#h7-0-1199" id="h7-0-1199" class="d">-			ui.write(line + &#39;\n&#39;)
</a><a href="#h7-0-1200" id="h7-0-1200" class="d">-	return err
</a><a href="#h7-0-1201" id="h7-0-1201" class="d">-
</a><a href="#h7-0-1202" id="h7-0-1202" class="d">-def hg_commit(ui, repo, *pats, **opts):
</a><a href="#h7-0-1203" id="h7-0-1203" class="d">-	return hg_commands.commit(ui, repo, *pats, **opts)
</a><a href="#h7-0-1204" id="h7-0-1204" class="d">-
</a><a href="#h7-0-1205" id="h7-0-1205" class="d">-#######################################################################
</a><a href="#h7-0-1206" id="h7-0-1206" class="d">-# Mercurial precommit hook to disable commit except through this interface.
</a><a href="#h7-0-1207" id="h7-0-1207" class="d">-
</a><a href="#h7-0-1208" id="h7-0-1208" class="d">-commit_okay = False
</a><a href="#h7-0-1209" id="h7-0-1209" class="d">-
</a><a href="#h7-0-1210" id="h7-0-1210" class="d">-def precommithook(ui, repo, **opts):
</a><a href="#h7-0-1211" id="h7-0-1211" class="d">-	if hgversion &gt;= &quot;2.1&quot;:
</a><a href="#h7-0-1212" id="h7-0-1212" class="d">-		from mercurial import phases
</a><a href="#h7-0-1213" id="h7-0-1213" class="d">-		if repo.ui.config(&#39;phases&#39;, &#39;new-commit&#39;) &gt;= phases.secret:
</a><a href="#h7-0-1214" id="h7-0-1214" class="d">-			return False
</a><a href="#h7-0-1215" id="h7-0-1215" class="d">-	if commit_okay:
</a><a href="#h7-0-1216" id="h7-0-1216" class="d">-		return False  # False means okay.
</a><a href="#h7-0-1217" id="h7-0-1217" class="d">-	ui.write(&quot;\ncodereview extension enabled; use mail, upload, or submit instead of commit\n\n&quot;)
</a><a href="#h7-0-1218" id="h7-0-1218" class="d">-	return True
</a><a href="#h7-0-1219" id="h7-0-1219" class="d">-
</a><a href="#h7-0-1220" id="h7-0-1220" class="d">-#######################################################################
</a><a href="#h7-0-1221" id="h7-0-1221" class="d">-# @clnumber file pattern support
</a><a href="#h7-0-1222" id="h7-0-1222" class="d">-
</a><a href="#h7-0-1223" id="h7-0-1223" class="d">-# We replace scmutil.match with the MatchAt wrapper to add the @clnumber pattern.
</a><a href="#h7-0-1224" id="h7-0-1224" class="d">-
</a><a href="#h7-0-1225" id="h7-0-1225" class="d">-match_repo = None
</a><a href="#h7-0-1226" id="h7-0-1226" class="d">-match_ui = None
</a><a href="#h7-0-1227" id="h7-0-1227" class="d">-match_orig = None
</a><a href="#h7-0-1228" id="h7-0-1228" class="d">-
</a><a href="#h7-0-1229" id="h7-0-1229" class="d">-def InstallMatch(ui, repo):
</a><a href="#h7-0-1230" id="h7-0-1230" class="d">-	global match_repo
</a><a href="#h7-0-1231" id="h7-0-1231" class="d">-	global match_ui
</a><a href="#h7-0-1232" id="h7-0-1232" class="d">-	global match_orig
</a><a href="#h7-0-1233" id="h7-0-1233" class="d">-
</a><a href="#h7-0-1234" id="h7-0-1234" class="d">-	match_ui = ui
</a><a href="#h7-0-1235" id="h7-0-1235" class="d">-	match_repo = repo
</a><a href="#h7-0-1236" id="h7-0-1236" class="d">-
</a><a href="#h7-0-1237" id="h7-0-1237" class="d">-	from mercurial import scmutil
</a><a href="#h7-0-1238" id="h7-0-1238" class="d">-	match_orig = scmutil.match
</a><a href="#h7-0-1239" id="h7-0-1239" class="d">-	scmutil.match = MatchAt
</a><a href="#h7-0-1240" id="h7-0-1240" class="d">-
</a><a href="#h7-0-1241" id="h7-0-1241" class="d">-def MatchAt(ctx, pats=None, opts=None, globbed=False, default=&#39;relpath&#39;):
</a><a href="#h7-0-1242" id="h7-0-1242" class="d">-	taken = []
</a><a href="#h7-0-1243" id="h7-0-1243" class="d">-	files = []
</a><a href="#h7-0-1244" id="h7-0-1244" class="d">-	pats = pats or []
</a><a href="#h7-0-1245" id="h7-0-1245" class="d">-	opts = opts or {}
</a><a href="#h7-0-1246" id="h7-0-1246" class="d">-	
</a><a href="#h7-0-1247" id="h7-0-1247" class="d">-	for p in pats:
</a><a href="#h7-0-1248" id="h7-0-1248" class="d">-		if p.startswith(&#39;@&#39;):
</a><a href="#h7-0-1249" id="h7-0-1249" class="d">-			taken.append(p)
</a><a href="#h7-0-1250" id="h7-0-1250" class="d">-			clname = p[1:]
</a><a href="#h7-0-1251" id="h7-0-1251" class="d">-			if clname == &quot;default&quot;:
</a><a href="#h7-0-1252" id="h7-0-1252" class="d">-				files = DefaultFiles(match_ui, match_repo, [])
</a><a href="#h7-0-1253" id="h7-0-1253" class="d">-			else:
</a><a href="#h7-0-1254" id="h7-0-1254" class="d">-				if not GoodCLName(clname):
</a><a href="#h7-0-1255" id="h7-0-1255" class="d">-					raise hg_util.Abort(&quot;invalid CL name &quot; + clname)
</a><a href="#h7-0-1256" id="h7-0-1256" class="d">-				cl, err = LoadCL(match_repo.ui, match_repo, clname, web=False)
</a><a href="#h7-0-1257" id="h7-0-1257" class="d">-				if err != &#39;&#39;:
</a><a href="#h7-0-1258" id="h7-0-1258" class="d">-					raise hg_util.Abort(&quot;loading CL &quot; + clname + &quot;: &quot; + err)
</a><a href="#h7-0-1259" id="h7-0-1259" class="d">-				if not cl.files:
</a><a href="#h7-0-1260" id="h7-0-1260" class="d">-					raise hg_util.Abort(&quot;no files in CL &quot; + clname)
</a><a href="#h7-0-1261" id="h7-0-1261" class="d">-				files = Add(files, cl.files)
</a><a href="#h7-0-1262" id="h7-0-1262" class="d">-	pats = Sub(pats, taken) + [&#39;path:&#39;+f for f in files]
</a><a href="#h7-0-1263" id="h7-0-1263" class="d">-
</a><a href="#h7-0-1264" id="h7-0-1264" class="d">-	# work-around for http://selenic.com/hg/rev/785bbc8634f8
</a><a href="#h7-0-1265" id="h7-0-1265" class="d">-	if not hasattr(ctx, &#39;match&#39;):
</a><a href="#h7-0-1266" id="h7-0-1266" class="d">-		ctx = ctx[None]
</a><a href="#h7-0-1267" id="h7-0-1267" class="d">-	return match_orig(ctx, pats=pats, opts=opts, globbed=globbed, default=default)
</a><a href="#h7-0-1268" id="h7-0-1268" class="d">-
</a><a href="#h7-0-1269" id="h7-0-1269" class="d">-#######################################################################
</a><a href="#h7-0-1270" id="h7-0-1270" class="d">-# Commands added by code review extension.
</a><a href="#h7-0-1271" id="h7-0-1271" class="d">-
</a><a href="#h7-0-1272" id="h7-0-1272" class="d">-def hgcommand(f):
</a><a href="#h7-0-1273" id="h7-0-1273" class="d">-	return f
</a><a href="#h7-0-1274" id="h7-0-1274" class="d">-
</a><a href="#h7-0-1275" id="h7-0-1275" class="d">-#######################################################################
</a><a href="#h7-0-1276" id="h7-0-1276" class="d">-# hg change
</a><a href="#h7-0-1277" id="h7-0-1277" class="d">-
</a><a href="#h7-0-1278" id="h7-0-1278" class="d">-@hgcommand
</a><a href="#h7-0-1279" id="h7-0-1279" class="d">-def change(ui, repo, *pats, **opts):
</a><a href="#h7-0-1280" id="h7-0-1280" class="d">-	&quot;&quot;&quot;create, edit or delete a change list
</a><a href="#h7-0-1281" id="h7-0-1281" class="d">-
</a><a href="#h7-0-1282" id="h7-0-1282" class="d">-	Create, edit or delete a change list.
</a><a href="#h7-0-1283" id="h7-0-1283" class="d">-	A change list is a group of files to be reviewed and submitted together,
</a><a href="#h7-0-1284" id="h7-0-1284" class="d">-	plus a textual description of the change.
</a><a href="#h7-0-1285" id="h7-0-1285" class="d">-	Change lists are referred to by simple alphanumeric names.
</a><a href="#h7-0-1286" id="h7-0-1286" class="d">-
</a><a href="#h7-0-1287" id="h7-0-1287" class="d">-	Changes must be reviewed before they can be submitted.
</a><a href="#h7-0-1288" id="h7-0-1288" class="d">-
</a><a href="#h7-0-1289" id="h7-0-1289" class="d">-	In the absence of options, the change command opens the
</a><a href="#h7-0-1290" id="h7-0-1290" class="d">-	change list for editing in the default editor.
</a><a href="#h7-0-1291" id="h7-0-1291" class="d">-
</a><a href="#h7-0-1292" id="h7-0-1292" class="d">-	Deleting a change with the -d or -D flag does not affect
</a><a href="#h7-0-1293" id="h7-0-1293" class="d">-	the contents of the files listed in that change.  To revert
</a><a href="#h7-0-1294" id="h7-0-1294" class="d">-	the files listed in a change, use
</a><a href="#h7-0-1295" id="h7-0-1295" class="d">-
</a><a href="#h7-0-1296" id="h7-0-1296" class="d">-		hg revert @123456
</a><a href="#h7-0-1297" id="h7-0-1297" class="d">-
</a><a href="#h7-0-1298" id="h7-0-1298" class="d">-	before running hg change -d 123456.
</a><a href="#h7-0-1299" id="h7-0-1299" class="d">-	&quot;&quot;&quot;
</a><a href="#h7-0-1300" id="h7-0-1300" class="d">-
</a><a href="#h7-0-1301" id="h7-0-1301" class="d">-	if codereview_disabled:
</a><a href="#h7-0-1302" id="h7-0-1302" class="d">-		raise hg_util.Abort(codereview_disabled)
</a><a href="#h7-0-1303" id="h7-0-1303" class="d">-	
</a><a href="#h7-0-1304" id="h7-0-1304" class="d">-	dirty = {}
</a><a href="#h7-0-1305" id="h7-0-1305" class="d">-	if len(pats) &gt; 0 and GoodCLName(pats[0]):
</a><a href="#h7-0-1306" id="h7-0-1306" class="d">-		name = pats[0]
</a><a href="#h7-0-1307" id="h7-0-1307" class="d">-		if len(pats) != 1:
</a><a href="#h7-0-1308" id="h7-0-1308" class="d">-			raise hg_util.Abort(&quot;cannot specify CL name and file patterns&quot;)
</a><a href="#h7-0-1309" id="h7-0-1309" class="d">-		pats = pats[1:]
</a><a href="#h7-0-1310" id="h7-0-1310" class="d">-		cl, err = LoadCL(ui, repo, name, web=True)
</a><a href="#h7-0-1311" id="h7-0-1311" class="d">-		if err != &#39;&#39;:
</a><a href="#h7-0-1312" id="h7-0-1312" class="d">-			raise hg_util.Abort(err)
</a><a href="#h7-0-1313" id="h7-0-1313" class="d">-		if not cl.local and (opts[&quot;stdin&quot;] or not opts[&quot;stdout&quot;]):
</a><a href="#h7-0-1314" id="h7-0-1314" class="d">-			raise hg_util.Abort(&quot;cannot change non-local CL &quot; + name)
</a><a href="#h7-0-1315" id="h7-0-1315" class="d">-	else:
</a><a href="#h7-0-1316" id="h7-0-1316" class="d">-		name = &quot;new&quot;
</a><a href="#h7-0-1317" id="h7-0-1317" class="d">-		cl = CL(&quot;new&quot;)
</a><a href="#h7-0-1318" id="h7-0-1318" class="d">-		if repo[None].branch() != &quot;default&quot;:
</a><a href="#h7-0-1319" id="h7-0-1319" class="d">-			raise hg_util.Abort(&quot;cannot create CL outside default branch; switch with &#39;hg update default&#39;&quot;)
</a><a href="#h7-0-1320" id="h7-0-1320" class="d">-		dirty[cl] = True
</a><a href="#h7-0-1321" id="h7-0-1321" class="d">-		files = ChangedFiles(ui, repo, pats, taken=Taken(ui, repo))
</a><a href="#h7-0-1322" id="h7-0-1322" class="d">-
</a><a href="#h7-0-1323" id="h7-0-1323" class="d">-	if opts[&quot;delete&quot;] or opts[&quot;deletelocal&quot;]:
</a><a href="#h7-0-1324" id="h7-0-1324" class="d">-		if opts[&quot;delete&quot;] and opts[&quot;deletelocal&quot;]:
</a><a href="#h7-0-1325" id="h7-0-1325" class="d">-			raise hg_util.Abort(&quot;cannot use -d and -D together&quot;)
</a><a href="#h7-0-1326" id="h7-0-1326" class="d">-		flag = &quot;-d&quot;
</a><a href="#h7-0-1327" id="h7-0-1327" class="d">-		if opts[&quot;deletelocal&quot;]:
</a><a href="#h7-0-1328" id="h7-0-1328" class="d">-			flag = &quot;-D&quot;
</a><a href="#h7-0-1329" id="h7-0-1329" class="d">-		if name == &quot;new&quot;:
</a><a href="#h7-0-1330" id="h7-0-1330" class="d">-			raise hg_util.Abort(&quot;cannot use &quot;+flag+&quot; with file patterns&quot;)
</a><a href="#h7-0-1331" id="h7-0-1331" class="d">-		if opts[&quot;stdin&quot;] or opts[&quot;stdout&quot;]:
</a><a href="#h7-0-1332" id="h7-0-1332" class="d">-			raise hg_util.Abort(&quot;cannot use &quot;+flag+&quot; with -i or -o&quot;)
</a><a href="#h7-0-1333" id="h7-0-1333" class="d">-		if not cl.local:
</a><a href="#h7-0-1334" id="h7-0-1334" class="d">-			raise hg_util.Abort(&quot;cannot change non-local CL &quot; + name)
</a><a href="#h7-0-1335" id="h7-0-1335" class="d">-		if opts[&quot;delete&quot;]:
</a><a href="#h7-0-1336" id="h7-0-1336" class="d">-			if cl.copied_from:
</a><a href="#h7-0-1337" id="h7-0-1337" class="d">-				raise hg_util.Abort(&quot;original author must delete CL; hg change -D will remove locally&quot;)
</a><a href="#h7-0-1338" id="h7-0-1338" class="d">-			PostMessage(ui, cl.name, &quot;*** Abandoned ***&quot;, send_mail=cl.mailed)
</a><a href="#h7-0-1339" id="h7-0-1339" class="d">-			EditDesc(cl.name, closed=True, private=cl.private)
</a><a href="#h7-0-1340" id="h7-0-1340" class="d">-		cl.Delete(ui, repo)
</a><a href="#h7-0-1341" id="h7-0-1341" class="d">-		return
</a><a href="#h7-0-1342" id="h7-0-1342" class="d">-
</a><a href="#h7-0-1343" id="h7-0-1343" class="d">-	if opts[&quot;stdin&quot;]:
</a><a href="#h7-0-1344" id="h7-0-1344" class="d">-		s = sys.stdin.read()
</a><a href="#h7-0-1345" id="h7-0-1345" class="d">-		clx, line, err = ParseCL(s, name)
</a><a href="#h7-0-1346" id="h7-0-1346" class="d">-		if err != &#39;&#39;:
</a><a href="#h7-0-1347" id="h7-0-1347" class="d">-			raise hg_util.Abort(&quot;error parsing change list: line %d: %s&quot; % (line, err))
</a><a href="#h7-0-1348" id="h7-0-1348" class="d">-		if clx.desc is not None:
</a><a href="#h7-0-1349" id="h7-0-1349" class="d">-			cl.desc = clx.desc;
</a><a href="#h7-0-1350" id="h7-0-1350" class="d">-			dirty[cl] = True
</a><a href="#h7-0-1351" id="h7-0-1351" class="d">-		if clx.reviewer is not None:
</a><a href="#h7-0-1352" id="h7-0-1352" class="d">-			cl.reviewer = clx.reviewer
</a><a href="#h7-0-1353" id="h7-0-1353" class="d">-			dirty[cl] = True
</a><a href="#h7-0-1354" id="h7-0-1354" class="d">-		if clx.cc is not None:
</a><a href="#h7-0-1355" id="h7-0-1355" class="d">-			cl.cc = clx.cc
</a><a href="#h7-0-1356" id="h7-0-1356" class="d">-			dirty[cl] = True
</a><a href="#h7-0-1357" id="h7-0-1357" class="d">-		if clx.files is not None:
</a><a href="#h7-0-1358" id="h7-0-1358" class="d">-			cl.files = clx.files
</a><a href="#h7-0-1359" id="h7-0-1359" class="d">-			dirty[cl] = True
</a><a href="#h7-0-1360" id="h7-0-1360" class="d">-		if clx.private != cl.private:
</a><a href="#h7-0-1361" id="h7-0-1361" class="d">-			cl.private = clx.private
</a><a href="#h7-0-1362" id="h7-0-1362" class="d">-			dirty[cl] = True
</a><a href="#h7-0-1363" id="h7-0-1363" class="d">-
</a><a href="#h7-0-1364" id="h7-0-1364" class="d">-	if not opts[&quot;stdin&quot;] and not opts[&quot;stdout&quot;]:
</a><a href="#h7-0-1365" id="h7-0-1365" class="d">-		if name == &quot;new&quot;:
</a><a href="#h7-0-1366" id="h7-0-1366" class="d">-			cl.files = files
</a><a href="#h7-0-1367" id="h7-0-1367" class="d">-		err = EditCL(ui, repo, cl)
</a><a href="#h7-0-1368" id="h7-0-1368" class="d">-		if err != &quot;&quot;:
</a><a href="#h7-0-1369" id="h7-0-1369" class="d">-			raise hg_util.Abort(err)
</a><a href="#h7-0-1370" id="h7-0-1370" class="d">-		dirty[cl] = True
</a><a href="#h7-0-1371" id="h7-0-1371" class="d">-
</a><a href="#h7-0-1372" id="h7-0-1372" class="d">-	for d, _ in dirty.items():
</a><a href="#h7-0-1373" id="h7-0-1373" class="d">-		name = d.name
</a><a href="#h7-0-1374" id="h7-0-1374" class="d">-		d.Flush(ui, repo)
</a><a href="#h7-0-1375" id="h7-0-1375" class="d">-		if name == &quot;new&quot;:
</a><a href="#h7-0-1376" id="h7-0-1376" class="d">-			d.Upload(ui, repo, quiet=True)
</a><a href="#h7-0-1377" id="h7-0-1377" class="d">-
</a><a href="#h7-0-1378" id="h7-0-1378" class="d">-	if opts[&quot;stdout&quot;]:
</a><a href="#h7-0-1379" id="h7-0-1379" class="d">-		ui.write(cl.EditorText())
</a><a href="#h7-0-1380" id="h7-0-1380" class="d">-	elif opts[&quot;pending&quot;]:
</a><a href="#h7-0-1381" id="h7-0-1381" class="d">-		ui.write(cl.PendingText())
</a><a href="#h7-0-1382" id="h7-0-1382" class="d">-	elif name == &quot;new&quot;:
</a><a href="#h7-0-1383" id="h7-0-1383" class="d">-		if ui.quiet:
</a><a href="#h7-0-1384" id="h7-0-1384" class="d">-			ui.write(cl.name)
</a><a href="#h7-0-1385" id="h7-0-1385" class="d">-		else:
</a><a href="#h7-0-1386" id="h7-0-1386" class="d">-			ui.write(&quot;CL created: &quot; + cl.url + &quot;\n&quot;)
</a><a href="#h7-0-1387" id="h7-0-1387" class="d">-	return
</a><a href="#h7-0-1388" id="h7-0-1388" class="d">-
</a><a href="#h7-0-1389" id="h7-0-1389" class="d">-#######################################################################
</a><a href="#h7-0-1390" id="h7-0-1390" class="d">-# hg code-login (broken?)
</a><a href="#h7-0-1391" id="h7-0-1391" class="d">-
</a><a href="#h7-0-1392" id="h7-0-1392" class="d">-@hgcommand
</a><a href="#h7-0-1393" id="h7-0-1393" class="d">-def code_login(ui, repo, **opts):
</a><a href="#h7-0-1394" id="h7-0-1394" class="d">-	&quot;&quot;&quot;log in to code review server
</a><a href="#h7-0-1395" id="h7-0-1395" class="d">-
</a><a href="#h7-0-1396" id="h7-0-1396" class="d">-	Logs in to the code review server, saving a cookie in
</a><a href="#h7-0-1397" id="h7-0-1397" class="d">-	a file in your home directory.
</a><a href="#h7-0-1398" id="h7-0-1398" class="d">-	&quot;&quot;&quot;
</a><a href="#h7-0-1399" id="h7-0-1399" class="d">-	if codereview_disabled:
</a><a href="#h7-0-1400" id="h7-0-1400" class="d">-		raise hg_util.Abort(codereview_disabled)
</a><a href="#h7-0-1401" id="h7-0-1401" class="d">-
</a><a href="#h7-0-1402" id="h7-0-1402" class="d">-	MySend(None)
</a><a href="#h7-0-1403" id="h7-0-1403" class="d">-
</a><a href="#h7-0-1404" id="h7-0-1404" class="d">-#######################################################################
</a><a href="#h7-0-1405" id="h7-0-1405" class="d">-# hg clpatch / undo / release-apply / download
</a><a href="#h7-0-1406" id="h7-0-1406" class="d">-# All concerned with applying or unapplying patches to the repository.
</a><a href="#h7-0-1407" id="h7-0-1407" class="d">-
</a><a href="#h7-0-1408" id="h7-0-1408" class="d">-@hgcommand
</a><a href="#h7-0-1409" id="h7-0-1409" class="d">-def clpatch(ui, repo, clname, **opts):
</a><a href="#h7-0-1410" id="h7-0-1410" class="d">-	&quot;&quot;&quot;import a patch from the code review server
</a><a href="#h7-0-1411" id="h7-0-1411" class="d">-
</a><a href="#h7-0-1412" id="h7-0-1412" class="d">-	Imports a patch from the code review server into the local client.
</a><a href="#h7-0-1413" id="h7-0-1413" class="d">-	If the local client has already modified any of the files that the
</a><a href="#h7-0-1414" id="h7-0-1414" class="d">-	patch modifies, this command will refuse to apply the patch.
</a><a href="#h7-0-1415" id="h7-0-1415" class="d">-
</a><a href="#h7-0-1416" id="h7-0-1416" class="d">-	Submitting an imported patch will keep the original author&#39;s
</a><a href="#h7-0-1417" id="h7-0-1417" class="d">-	name as the Author: line but add your own name to a Committer: line.
</a><a href="#h7-0-1418" id="h7-0-1418" class="d">-	&quot;&quot;&quot;
</a><a href="#h7-0-1419" id="h7-0-1419" class="d">-	if repo[None].branch() != &quot;default&quot;:
</a><a href="#h7-0-1420" id="h7-0-1420" class="d">-		raise hg_util.Abort(&quot;cannot run hg clpatch outside default branch&quot;)
</a><a href="#h7-0-1421" id="h7-0-1421" class="d">-	err = clpatch_or_undo(ui, repo, clname, opts, mode=&quot;clpatch&quot;)
</a><a href="#h7-0-1422" id="h7-0-1422" class="d">-	if err:
</a><a href="#h7-0-1423" id="h7-0-1423" class="d">-		raise hg_util.Abort(err)
</a><a href="#h7-0-1424" id="h7-0-1424" class="d">-
</a><a href="#h7-0-1425" id="h7-0-1425" class="d">-@hgcommand
</a><a href="#h7-0-1426" id="h7-0-1426" class="d">-def undo(ui, repo, clname, **opts):
</a><a href="#h7-0-1427" id="h7-0-1427" class="d">-	&quot;&quot;&quot;undo the effect of a CL
</a><a href="#h7-0-1428" id="h7-0-1428" class="d">-	
</a><a href="#h7-0-1429" id="h7-0-1429" class="d">-	Creates a new CL that undoes an earlier CL.
</a><a href="#h7-0-1430" id="h7-0-1430" class="d">-	After creating the CL, opens the CL text for editing so that
</a><a href="#h7-0-1431" id="h7-0-1431" class="d">-	you can add the reason for the undo to the description.
</a><a href="#h7-0-1432" id="h7-0-1432" class="d">-	&quot;&quot;&quot;
</a><a href="#h7-0-1433" id="h7-0-1433" class="d">-	if repo[None].branch() != &quot;default&quot;:
</a><a href="#h7-0-1434" id="h7-0-1434" class="d">-		raise hg_util.Abort(&quot;cannot run hg undo outside default branch&quot;)
</a><a href="#h7-0-1435" id="h7-0-1435" class="d">-	err = clpatch_or_undo(ui, repo, clname, opts, mode=&quot;undo&quot;)
</a><a href="#h7-0-1436" id="h7-0-1436" class="d">-	if err:
</a><a href="#h7-0-1437" id="h7-0-1437" class="d">-		raise hg_util.Abort(err)
</a><a href="#h7-0-1438" id="h7-0-1438" class="d">-
</a><a href="#h7-0-1439" id="h7-0-1439" class="d">-@hgcommand
</a><a href="#h7-0-1440" id="h7-0-1440" class="d">-def release_apply(ui, repo, clname, **opts):
</a><a href="#h7-0-1441" id="h7-0-1441" class="d">-	&quot;&quot;&quot;apply a CL to the release branch
</a><a href="#h7-0-1442" id="h7-0-1442" class="d">-
</a><a href="#h7-0-1443" id="h7-0-1443" class="d">-	Creates a new CL copying a previously committed change
</a><a href="#h7-0-1444" id="h7-0-1444" class="d">-	from the main branch to the release branch.
</a><a href="#h7-0-1445" id="h7-0-1445" class="d">-	The current client must either be clean or already be in
</a><a href="#h7-0-1446" id="h7-0-1446" class="d">-	the release branch.
</a><a href="#h7-0-1447" id="h7-0-1447" class="d">-	
</a><a href="#h7-0-1448" id="h7-0-1448" class="d">-	The release branch must be created by starting with a
</a><a href="#h7-0-1449" id="h7-0-1449" class="d">-	clean client, disabling the code review plugin, and running:
</a><a href="#h7-0-1450" id="h7-0-1450" class="d">-	
</a><a href="#h7-0-1451" id="h7-0-1451" class="d">-		hg update weekly.YYYY-MM-DD
</a><a href="#h7-0-1452" id="h7-0-1452" class="d">-		hg branch release-branch.rNN
</a><a href="#h7-0-1453" id="h7-0-1453" class="d">-		hg commit -m &#39;create release-branch.rNN&#39;
</a><a href="#h7-0-1454" id="h7-0-1454" class="d">-		hg push --new-branch
</a><a href="#h7-0-1455" id="h7-0-1455" class="d">-	
</a><a href="#h7-0-1456" id="h7-0-1456" class="d">-	Then re-enable the code review plugin.
</a><a href="#h7-0-1457" id="h7-0-1457" class="d">-	
</a><a href="#h7-0-1458" id="h7-0-1458" class="d">-	People can test the release branch by running
</a><a href="#h7-0-1459" id="h7-0-1459" class="d">-	
</a><a href="#h7-0-1460" id="h7-0-1460" class="d">-		hg update release-branch.rNN
</a><a href="#h7-0-1461" id="h7-0-1461" class="d">-	
</a><a href="#h7-0-1462" id="h7-0-1462" class="d">-	in a clean client.  To return to the normal tree,
</a><a href="#h7-0-1463" id="h7-0-1463" class="d">-	
</a><a href="#h7-0-1464" id="h7-0-1464" class="d">-		hg update default
</a><a href="#h7-0-1465" id="h7-0-1465" class="d">-	
</a><a href="#h7-0-1466" id="h7-0-1466" class="d">-	Move changes since the weekly into the release branch 
</a><a href="#h7-0-1467" id="h7-0-1467" class="d">-	using hg release-apply followed by the usual code review
</a><a href="#h7-0-1468" id="h7-0-1468" class="d">-	process and hg submit.
</a><a href="#h7-0-1469" id="h7-0-1469" class="d">-
</a><a href="#h7-0-1470" id="h7-0-1470" class="d">-	When it comes time to tag the release, record the
</a><a href="#h7-0-1471" id="h7-0-1471" class="d">-	final long-form tag of the release-branch.rNN
</a><a href="#h7-0-1472" id="h7-0-1472" class="d">-	in the *default* branch&#39;s .hgtags file.  That is, run
</a><a href="#h7-0-1473" id="h7-0-1473" class="d">-	
</a><a href="#h7-0-1474" id="h7-0-1474" class="d">-		hg update default
</a><a href="#h7-0-1475" id="h7-0-1475" class="d">-	
</a><a href="#h7-0-1476" id="h7-0-1476" class="d">-	and then edit .hgtags as you would for a weekly.
</a><a href="#h7-0-1477" id="h7-0-1477" class="d">-		
</a><a href="#h7-0-1478" id="h7-0-1478" class="d">-	&quot;&quot;&quot;
</a><a href="#h7-0-1479" id="h7-0-1479" class="d">-	c = repo[None]
</a><a href="#h7-0-1480" id="h7-0-1480" class="d">-	if not releaseBranch:
</a><a href="#h7-0-1481" id="h7-0-1481" class="d">-		raise hg_util.Abort(&quot;no active release branches&quot;)
</a><a href="#h7-0-1482" id="h7-0-1482" class="d">-	if c.branch() != releaseBranch:
</a><a href="#h7-0-1483" id="h7-0-1483" class="d">-		if c.modified() or c.added() or c.removed():
</a><a href="#h7-0-1484" id="h7-0-1484" class="d">-			raise hg_util.Abort(&quot;uncommitted local changes - cannot switch branches&quot;)
</a><a href="#h7-0-1485" id="h7-0-1485" class="d">-		err = hg_clean(repo, releaseBranch)
</a><a href="#h7-0-1486" id="h7-0-1486" class="d">-		if err:
</a><a href="#h7-0-1487" id="h7-0-1487" class="d">-			raise hg_util.Abort(err)
</a><a href="#h7-0-1488" id="h7-0-1488" class="d">-	try:
</a><a href="#h7-0-1489" id="h7-0-1489" class="d">-		err = clpatch_or_undo(ui, repo, clname, opts, mode=&quot;backport&quot;)
</a><a href="#h7-0-1490" id="h7-0-1490" class="d">-		if err:
</a><a href="#h7-0-1491" id="h7-0-1491" class="d">-			raise hg_util.Abort(err)
</a><a href="#h7-0-1492" id="h7-0-1492" class="d">-	except Exception, e:
</a><a href="#h7-0-1493" id="h7-0-1493" class="d">-		hg_clean(repo, &quot;default&quot;)
</a><a href="#h7-0-1494" id="h7-0-1494" class="d">-		raise e
</a><a href="#h7-0-1495" id="h7-0-1495" class="d">-
</a><a href="#h7-0-1496" id="h7-0-1496" class="d">-def rev2clname(rev):
</a><a href="#h7-0-1497" id="h7-0-1497" class="d">-	# Extract CL name from revision description.
</a><a href="#h7-0-1498" id="h7-0-1498" class="d">-	# The last line in the description that is a codereview URL is the real one.
</a><a href="#h7-0-1499" id="h7-0-1499" class="d">-	# Earlier lines might be part of the user-written description.
</a><a href="#h7-0-1500" id="h7-0-1500" class="d">-	all = re.findall(&#39;(?m)^https?://codereview.appspot.com/([0-9]+)$&#39;, rev.description())
</a><a href="#h7-0-1501" id="h7-0-1501" class="d">-	if len(all) &gt; 0:
</a><a href="#h7-0-1502" id="h7-0-1502" class="d">-		return all[-1]
</a><a href="#h7-0-1503" id="h7-0-1503" class="d">-	return &quot;&quot;
</a><a href="#h7-0-1504" id="h7-0-1504" class="d">-
</a><a href="#h7-0-1505" id="h7-0-1505" class="d">-undoHeader = &quot;&quot;&quot;undo CL %s / %s
</a><a href="#h7-0-1506" id="h7-0-1506" class="d">-
</a><a href="#h7-0-1507" id="h7-0-1507" class="d">-&lt;enter reason for undo&gt;
</a><a href="#h7-0-1508" id="h7-0-1508" class="d">-
</a><a href="#h7-0-1509" id="h7-0-1509" class="d">- original CL description
</a><a href="#h7-0-1510" id="h7-0-1510" class="d">-&quot;&quot;&quot;
</a><a href="#h7-0-1511" id="h7-0-1511" class="d">-
</a><a href="#h7-0-1512" id="h7-0-1512" class="d">-undoFooter = &quot;&quot;&quot;
</a><a href="#h7-0-1513" id="h7-0-1513" class="d">-
</a><a href="#h7-0-1514" id="h7-0-1514" class="d">-&quot;&quot;&quot;
</a><a href="#h7-0-1515" id="h7-0-1515" class="d">-
</a><a href="#h7-0-1516" id="h7-0-1516" class="d">-backportHeader = &quot;&quot;&quot;[%s] %s
</a><a href="#h7-0-1517" id="h7-0-1517" class="d">-
</a><a href="#h7-0-1518" id="h7-0-1518" class="d">- CL %s / %s
</a><a href="#h7-0-1519" id="h7-0-1519" class="d">-&quot;&quot;&quot;
</a><a href="#h7-0-1520" id="h7-0-1520" class="d">-
</a><a href="#h7-0-1521" id="h7-0-1521" class="d">-backportFooter = &quot;&quot;&quot;
</a><a href="#h7-0-1522" id="h7-0-1522" class="d">-
</a><a href="#h7-0-1523" id="h7-0-1523" class="d">-&quot;&quot;&quot;
</a><a href="#h7-0-1524" id="h7-0-1524" class="d">-
</a><a href="#h7-0-1525" id="h7-0-1525" class="d">-# Implementation of clpatch/undo.
</a><a href="#h7-0-1526" id="h7-0-1526" class="d">-def clpatch_or_undo(ui, repo, clname, opts, mode):
</a><a href="#h7-0-1527" id="h7-0-1527" class="d">-	if codereview_disabled:
</a><a href="#h7-0-1528" id="h7-0-1528" class="d">-		return codereview_disabled
</a><a href="#h7-0-1529" id="h7-0-1529" class="d">-
</a><a href="#h7-0-1530" id="h7-0-1530" class="d">-	if mode == &quot;undo&quot; or mode == &quot;backport&quot;:
</a><a href="#h7-0-1531" id="h7-0-1531" class="d">-		# Find revision in Mercurial repository.
</a><a href="#h7-0-1532" id="h7-0-1532" class="d">-		# Assume CL number is 7+ decimal digits.
</a><a href="#h7-0-1533" id="h7-0-1533" class="d">-		# Otherwise is either change log sequence number (fewer decimal digits),
</a><a href="#h7-0-1534" id="h7-0-1534" class="d">-		# hexadecimal hash, or tag name.
</a><a href="#h7-0-1535" id="h7-0-1535" class="d">-		# Mercurial will fall over long before the change log
</a><a href="#h7-0-1536" id="h7-0-1536" class="d">-		# sequence numbers get to be 7 digits long.
</a><a href="#h7-0-1537" id="h7-0-1537" class="d">-		if re.match(&#39;^[0-9]{7,}$&#39;, clname):
</a><a href="#h7-0-1538" id="h7-0-1538" class="d">-			found = False
</a><a href="#h7-0-1539" id="h7-0-1539" class="d">-			for r in hg_log(ui, repo, keyword=&quot;codereview.appspot.com/&quot;+clname, limit=100, template=&quot;{node}\n&quot;).split():
</a><a href="#h7-0-1540" id="h7-0-1540" class="d">-				rev = repo[r]
</a><a href="#h7-0-1541" id="h7-0-1541" class="d">-				# Last line with a code review URL is the actual review URL.
</a><a href="#h7-0-1542" id="h7-0-1542" class="d">-				# Earlier ones might be part of the CL description.
</a><a href="#h7-0-1543" id="h7-0-1543" class="d">-				n = rev2clname(rev)
</a><a href="#h7-0-1544" id="h7-0-1544" class="d">-				if n == clname:
</a><a href="#h7-0-1545" id="h7-0-1545" class="d">-					found = True
</a><a href="#h7-0-1546" id="h7-0-1546" class="d">-					break
</a><a href="#h7-0-1547" id="h7-0-1547" class="d">-			if not found:
</a><a href="#h7-0-1548" id="h7-0-1548" class="d">-				return &quot;cannot find CL %s in local repository&quot; % clname
</a><a href="#h7-0-1549" id="h7-0-1549" class="d">-		else:
</a><a href="#h7-0-1550" id="h7-0-1550" class="d">-			rev = repo[clname]
</a><a href="#h7-0-1551" id="h7-0-1551" class="d">-			if not rev:
</a><a href="#h7-0-1552" id="h7-0-1552" class="d">-				return &quot;unknown revision %s&quot; % clname
</a><a href="#h7-0-1553" id="h7-0-1553" class="d">-			clname = rev2clname(rev)
</a><a href="#h7-0-1554" id="h7-0-1554" class="d">-			if clname == &quot;&quot;:
</a><a href="#h7-0-1555" id="h7-0-1555" class="d">-				return &quot;cannot find CL name in revision description&quot;
</a><a href="#h7-0-1556" id="h7-0-1556" class="d">-		
</a><a href="#h7-0-1557" id="h7-0-1557" class="d">-		# Create fresh CL and start with patch that would reverse the change.
</a><a href="#h7-0-1558" id="h7-0-1558" class="d">-		vers = hg_node.short(rev.node())
</a><a href="#h7-0-1559" id="h7-0-1559" class="d">-		cl = CL(&quot;new&quot;)
</a><a href="#h7-0-1560" id="h7-0-1560" class="d">-		desc = str(rev.description())
</a><a href="#h7-0-1561" id="h7-0-1561" class="d">-		if mode == &quot;undo&quot;:
</a><a href="#h7-0-1562" id="h7-0-1562" class="d">-			cl.desc = (undoHeader % (clname, vers)) + desc + undoFooter
</a><a href="#h7-0-1563" id="h7-0-1563" class="d">-		else:
</a><a href="#h7-0-1564" id="h7-0-1564" class="d">-			cl.desc = (backportHeader % (releaseBranch, line1(desc), clname, vers)) + desc + undoFooter
</a><a href="#h7-0-1565" id="h7-0-1565" class="d">-		v1 = vers
</a><a href="#h7-0-1566" id="h7-0-1566" class="d">-		v0 = hg_node.short(rev.parents()[0].node())
</a><a href="#h7-0-1567" id="h7-0-1567" class="d">-		if mode == &quot;undo&quot;:
</a><a href="#h7-0-1568" id="h7-0-1568" class="d">-			arg = v1 + &quot;:&quot; + v0
</a><a href="#h7-0-1569" id="h7-0-1569" class="d">-		else:
</a><a href="#h7-0-1570" id="h7-0-1570" class="d">-			vers = v0
</a><a href="#h7-0-1571" id="h7-0-1571" class="d">-			arg = v0 + &quot;:&quot; + v1
</a><a href="#h7-0-1572" id="h7-0-1572" class="d">-		patch = RunShell([&quot;hg&quot;, &quot;diff&quot;, &quot;--git&quot;, &quot;-r&quot;, arg])
</a><a href="#h7-0-1573" id="h7-0-1573" class="d">-
</a><a href="#h7-0-1574" id="h7-0-1574" class="d">-	else:  # clpatch
</a><a href="#h7-0-1575" id="h7-0-1575" class="d">-		cl, vers, patch, err = DownloadCL(ui, repo, clname)
</a><a href="#h7-0-1576" id="h7-0-1576" class="d">-		if err != &quot;&quot;:
</a><a href="#h7-0-1577" id="h7-0-1577" class="d">-			return err
</a><a href="#h7-0-1578" id="h7-0-1578" class="d">-		if patch == emptydiff:
</a><a href="#h7-0-1579" id="h7-0-1579" class="d">-			return &quot;codereview issue %s has no diff&quot; % clname
</a><a href="#h7-0-1580" id="h7-0-1580" class="d">-
</a><a href="#h7-0-1581" id="h7-0-1581" class="d">-	# find current hg version (hg identify)
</a><a href="#h7-0-1582" id="h7-0-1582" class="d">-	ctx = repo[None]
</a><a href="#h7-0-1583" id="h7-0-1583" class="d">-	parents = ctx.parents()
</a><a href="#h7-0-1584" id="h7-0-1584" class="d">-	id = &#39;+&#39;.join([hg_node.short(p.node()) for p in parents])
</a><a href="#h7-0-1585" id="h7-0-1585" class="d">-
</a><a href="#h7-0-1586" id="h7-0-1586" class="d">-	# if version does not match the patch version,
</a><a href="#h7-0-1587" id="h7-0-1587" class="d">-	# try to update the patch line numbers.
</a><a href="#h7-0-1588" id="h7-0-1588" class="d">-	if vers != &quot;&quot; and id != vers:
</a><a href="#h7-0-1589" id="h7-0-1589" class="d">-		# &quot;vers in repo&quot; gives the wrong answer
</a><a href="#h7-0-1590" id="h7-0-1590" class="d">-		# on some versions of Mercurial.  Instead, do the actual
</a><a href="#h7-0-1591" id="h7-0-1591" class="d">-		# lookup and catch the exception.
</a><a href="#h7-0-1592" id="h7-0-1592" class="d">-		try:
</a><a href="#h7-0-1593" id="h7-0-1593" class="d">-			repo[vers].description()
</a><a href="#h7-0-1594" id="h7-0-1594" class="d">-		except:
</a><a href="#h7-0-1595" id="h7-0-1595" class="d">-			return &quot;local repository is out of date; sync to get %s&quot; % (vers)
</a><a href="#h7-0-1596" id="h7-0-1596" class="d">-		patch1, err = portPatch(repo, patch, vers, id)
</a><a href="#h7-0-1597" id="h7-0-1597" class="d">-		if err != &quot;&quot;:
</a><a href="#h7-0-1598" id="h7-0-1598" class="d">-			if not opts[&quot;ignore_hgapplydiff_failure&quot;]:
</a><a href="#h7-0-1599" id="h7-0-1599" class="d">-				return &quot;codereview issue %s is out of date: %s (%s-&gt;%s)&quot; % (clname, err, vers, id)
</a><a href="#h7-0-1600" id="h7-0-1600" class="d">-		else:
</a><a href="#h7-0-1601" id="h7-0-1601" class="d">-			patch = patch1
</a><a href="#h7-0-1602" id="h7-0-1602" class="d">-	argv = [&quot;hgapplydiff&quot;]
</a><a href="#h7-0-1603" id="h7-0-1603" class="d">-	if opts[&quot;no_incoming&quot;] or mode == &quot;backport&quot;:
</a><a href="#h7-0-1604" id="h7-0-1604" class="d">-		argv += [&quot;--checksync=false&quot;]
</a><a href="#h7-0-1605" id="h7-0-1605" class="d">-	try:
</a><a href="#h7-0-1606" id="h7-0-1606" class="d">-		cmd = subprocess.Popen(argv, shell=False, stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=None, close_fds=sys.platform != &quot;win32&quot;)
</a><a href="#h7-0-1607" id="h7-0-1607" class="d">-	except:
</a><a href="#h7-0-1608" id="h7-0-1608" class="d">-		return &quot;hgapplydiff: &quot; + ExceptionDetail() + &quot;\nInstall hgapplydiff with:\n$ go get code.google.com/p/go.codereview/cmd/hgapplydiff\n&quot;
</a><a href="#h7-0-1609" id="h7-0-1609" class="d">-
</a><a href="#h7-0-1610" id="h7-0-1610" class="d">-	out, err = cmd.communicate(patch)
</a><a href="#h7-0-1611" id="h7-0-1611" class="d">-	if cmd.returncode != 0 and not opts[&quot;ignore_hgapplydiff_failure&quot;]:
</a><a href="#h7-0-1612" id="h7-0-1612" class="d">-		return &quot;hgapplydiff failed&quot;
</a><a href="#h7-0-1613" id="h7-0-1613" class="d">-	cl.local = True
</a><a href="#h7-0-1614" id="h7-0-1614" class="d">-	cl.files = out.strip().split()
</a><a href="#h7-0-1615" id="h7-0-1615" class="d">-	if not cl.files and not opts[&quot;ignore_hgapplydiff_failure&quot;]:
</a><a href="#h7-0-1616" id="h7-0-1616" class="d">-		return &quot;codereview issue %s has no changed files&quot; % clname
</a><a href="#h7-0-1617" id="h7-0-1617" class="d">-	files = ChangedFiles(ui, repo, [])
</a><a href="#h7-0-1618" id="h7-0-1618" class="d">-	extra = Sub(cl.files, files)
</a><a href="#h7-0-1619" id="h7-0-1619" class="d">-	if extra:
</a><a href="#h7-0-1620" id="h7-0-1620" class="d">-		ui.warn(&quot;warning: these files were listed in the patch but not changed:\n\t&quot; + &quot;\n\t&quot;.join(extra) + &quot;\n&quot;)
</a><a href="#h7-0-1621" id="h7-0-1621" class="d">-	cl.Flush(ui, repo)
</a><a href="#h7-0-1622" id="h7-0-1622" class="d">-	if mode == &quot;undo&quot;:
</a><a href="#h7-0-1623" id="h7-0-1623" class="d">-		err = EditCL(ui, repo, cl)
</a><a href="#h7-0-1624" id="h7-0-1624" class="d">-		if err != &quot;&quot;:
</a><a href="#h7-0-1625" id="h7-0-1625" class="d">-			return &quot;CL created, but error editing: &quot; + err
</a><a href="#h7-0-1626" id="h7-0-1626" class="d">-		cl.Flush(ui, repo)
</a><a href="#h7-0-1627" id="h7-0-1627" class="d">-	else:
</a><a href="#h7-0-1628" id="h7-0-1628" class="d">-		ui.write(cl.PendingText() + &quot;\n&quot;)
</a><a href="#h7-0-1629" id="h7-0-1629" class="d">-
</a><a href="#h7-0-1630" id="h7-0-1630" class="d">-# portPatch rewrites patch from being a patch against
</a><a href="#h7-0-1631" id="h7-0-1631" class="d">-# oldver to being a patch against newver.
</a><a href="#h7-0-1632" id="h7-0-1632" class="d">-def portPatch(repo, patch, oldver, newver):
</a><a href="#h7-0-1633" id="h7-0-1633" class="d">-	lines = patch.splitlines(True) # True = keep \n
</a><a href="#h7-0-1634" id="h7-0-1634" class="d">-	delta = None
</a><a href="#h7-0-1635" id="h7-0-1635" class="d">-	for i in range(len(lines)):
</a><a href="#h7-0-1636" id="h7-0-1636" class="d">-		line = lines[i]
</a><a href="#h7-0-1637" id="h7-0-1637" class="d">-		if line.startswith(&#39;--- a/&#39;):
</a><a href="#h7-0-1638" id="h7-0-1638" class="d">-			file = line[6:-1]
</a><a href="#h7-0-1639" id="h7-0-1639" class="d">-			delta = fileDeltas(repo, file, oldver, newver)
</a><a href="#h7-0-1640" id="h7-0-1640" class="d">-		if not delta or not line.startswith(&#39;@@ &#39;):
</a><a href="#h7-0-1641" id="h7-0-1641" class="d">-			continue
</a><a href="#h7-0-1642" id="h7-0-1642" class="d">-		# @@ -x,y +z,w @@ means the patch chunk replaces
</a><a href="#h7-0-1643" id="h7-0-1643" class="d">-		# the original file&#39;s line numbers x up to x+y with the
</a><a href="#h7-0-1644" id="h7-0-1644" class="d">-		# line numbers z up to z+w in the new file.
</a><a href="#h7-0-1645" id="h7-0-1645" class="d">-		# Find the delta from x in the original to the same
</a><a href="#h7-0-1646" id="h7-0-1646" class="d">-		# line in the current version and add that delta to both
</a><a href="#h7-0-1647" id="h7-0-1647" class="d">-		# x and z.
</a><a href="#h7-0-1648" id="h7-0-1648" class="d">-		m = re.match(&#39;@@ -([0-9]+),([0-9]+) \+([0-9]+),([0-9]+) @@&#39;, line)
</a><a href="#h7-0-1649" id="h7-0-1649" class="d">-		if not m:
</a><a href="#h7-0-1650" id="h7-0-1650" class="d">-			return None, &quot;error parsing patch line numbers&quot;
</a><a href="#h7-0-1651" id="h7-0-1651" class="d">-		n1, len1, n2, len2 = int(m.group(1)), int(m.group(2)), int(m.group(3)), int(m.group(4))
</a><a href="#h7-0-1652" id="h7-0-1652" class="d">-		d, err = lineDelta(delta, n1, len1)
</a><a href="#h7-0-1653" id="h7-0-1653" class="d">-		if err != &quot;&quot;:
</a><a href="#h7-0-1654" id="h7-0-1654" class="d">-			return &quot;&quot;, err
</a><a href="#h7-0-1655" id="h7-0-1655" class="d">-		n1 += d
</a><a href="#h7-0-1656" id="h7-0-1656" class="d">-		n2 += d
</a><a href="#h7-0-1657" id="h7-0-1657" class="d">-		lines[i] = &quot;@@ -%d,%d +%d,%d @@\n&quot; % (n1, len1, n2, len2)
</a><a href="#h7-0-1658" id="h7-0-1658" class="d">-		
</a><a href="#h7-0-1659" id="h7-0-1659" class="d">-	newpatch = &#39;&#39;.join(lines)
</a><a href="#h7-0-1660" id="h7-0-1660" class="d">-	return newpatch, &quot;&quot;
</a><a href="#h7-0-1661" id="h7-0-1661" class="d">-
</a><a href="#h7-0-1662" id="h7-0-1662" class="d">-# fileDelta returns the line number deltas for the given file&#39;s
</a><a href="#h7-0-1663" id="h7-0-1663" class="d">-# changes from oldver to newver.
</a><a href="#h7-0-1664" id="h7-0-1664" class="d">-# The deltas are a list of (n, len, newdelta) triples that say
</a><a href="#h7-0-1665" id="h7-0-1665" class="d">-# lines [n, n+len) were modified, and after that range the
</a><a href="#h7-0-1666" id="h7-0-1666" class="d">-# line numbers are +newdelta from what they were before.
</a><a href="#h7-0-1667" id="h7-0-1667" class="d">-def fileDeltas(repo, file, oldver, newver):
</a><a href="#h7-0-1668" id="h7-0-1668" class="d">-	cmd = [&quot;hg&quot;, &quot;diff&quot;, &quot;--git&quot;, &quot;-r&quot;, oldver + &quot;:&quot; + newver, &quot;path:&quot; + file]
</a><a href="#h7-0-1669" id="h7-0-1669" class="d">-	data = RunShell(cmd, silent_ok=True)
</a><a href="#h7-0-1670" id="h7-0-1670" class="d">-	deltas = []
</a><a href="#h7-0-1671" id="h7-0-1671" class="d">-	for line in data.splitlines():
</a><a href="#h7-0-1672" id="h7-0-1672" class="d">-		m = re.match(&#39;@@ -([0-9]+),([0-9]+) \+([0-9]+),([0-9]+) @@&#39;, line)
</a><a href="#h7-0-1673" id="h7-0-1673" class="d">-		if not m:
</a><a href="#h7-0-1674" id="h7-0-1674" class="d">-			continue
</a><a href="#h7-0-1675" id="h7-0-1675" class="d">-		n1, len1, n2, len2 = int(m.group(1)), int(m.group(2)), int(m.group(3)), int(m.group(4))
</a><a href="#h7-0-1676" id="h7-0-1676" class="d">-		deltas.append((n1, len1, n2+len2-(n1+len1)))
</a><a href="#h7-0-1677" id="h7-0-1677" class="d">-	return deltas
</a><a href="#h7-0-1678" id="h7-0-1678" class="d">-
</a><a href="#h7-0-1679" id="h7-0-1679" class="d">-# lineDelta finds the appropriate line number delta to apply to the lines [n, n+len).
</a><a href="#h7-0-1680" id="h7-0-1680" class="d">-# It returns an error if those lines were rewritten by the patch.
</a><a href="#h7-0-1681" id="h7-0-1681" class="d">-def lineDelta(deltas, n, len):
</a><a href="#h7-0-1682" id="h7-0-1682" class="d">-	d = 0
</a><a href="#h7-0-1683" id="h7-0-1683" class="d">-	for (old, oldlen, newdelta) in deltas:
</a><a href="#h7-0-1684" id="h7-0-1684" class="d">-		if old &gt;= n+len:
</a><a href="#h7-0-1685" id="h7-0-1685" class="d">-			break
</a><a href="#h7-0-1686" id="h7-0-1686" class="d">-		if old+len &gt; n:
</a><a href="#h7-0-1687" id="h7-0-1687" class="d">-			return 0, &quot;patch and recent changes conflict&quot;
</a><a href="#h7-0-1688" id="h7-0-1688" class="d">-		d = newdelta
</a><a href="#h7-0-1689" id="h7-0-1689" class="d">-	return d, &quot;&quot;
</a><a href="#h7-0-1690" id="h7-0-1690" class="d">-
</a><a href="#h7-0-1691" id="h7-0-1691" class="d">-@hgcommand
</a><a href="#h7-0-1692" id="h7-0-1692" class="d">-def download(ui, repo, clname, **opts):
</a><a href="#h7-0-1693" id="h7-0-1693" class="d">-	&quot;&quot;&quot;download a change from the code review server
</a><a href="#h7-0-1694" id="h7-0-1694" class="d">-
</a><a href="#h7-0-1695" id="h7-0-1695" class="d">-	Download prints a description of the given change list
</a><a href="#h7-0-1696" id="h7-0-1696" class="d">-	followed by its diff, downloaded from the code review server.
</a><a href="#h7-0-1697" id="h7-0-1697" class="d">-	&quot;&quot;&quot;
</a><a href="#h7-0-1698" id="h7-0-1698" class="d">-	if codereview_disabled:
</a><a href="#h7-0-1699" id="h7-0-1699" class="d">-		raise hg_util.Abort(codereview_disabled)
</a><a href="#h7-0-1700" id="h7-0-1700" class="d">-
</a><a href="#h7-0-1701" id="h7-0-1701" class="d">-	cl, vers, patch, err = DownloadCL(ui, repo, clname)
</a><a href="#h7-0-1702" id="h7-0-1702" class="d">-	if err != &quot;&quot;:
</a><a href="#h7-0-1703" id="h7-0-1703" class="d">-		return err
</a><a href="#h7-0-1704" id="h7-0-1704" class="d">-	ui.write(cl.EditorText() + &quot;\n&quot;)
</a><a href="#h7-0-1705" id="h7-0-1705" class="d">-	ui.write(patch + &quot;\n&quot;)
</a><a href="#h7-0-1706" id="h7-0-1706" class="d">-	return
</a><a href="#h7-0-1707" id="h7-0-1707" class="d">-
</a><a href="#h7-0-1708" id="h7-0-1708" class="d">-#######################################################################
</a><a href="#h7-0-1709" id="h7-0-1709" class="d">-# hg file
</a><a href="#h7-0-1710" id="h7-0-1710" class="d">-
</a><a href="#h7-0-1711" id="h7-0-1711" class="d">-@hgcommand
</a><a href="#h7-0-1712" id="h7-0-1712" class="d">-def file(ui, repo, clname, pat, *pats, **opts):
</a><a href="#h7-0-1713" id="h7-0-1713" class="d">-	&quot;&quot;&quot;assign files to or remove files from a change list
</a><a href="#h7-0-1714" id="h7-0-1714" class="d">-
</a><a href="#h7-0-1715" id="h7-0-1715" class="d">-	Assign files to or (with -d) remove files from a change list.
</a><a href="#h7-0-1716" id="h7-0-1716" class="d">-
</a><a href="#h7-0-1717" id="h7-0-1717" class="d">-	The -d option only removes files from the change list.
</a><a href="#h7-0-1718" id="h7-0-1718" class="d">-	It does not edit them or remove them from the repository.
</a><a href="#h7-0-1719" id="h7-0-1719" class="d">-	&quot;&quot;&quot;
</a><a href="#h7-0-1720" id="h7-0-1720" class="d">-	if codereview_disabled:
</a><a href="#h7-0-1721" id="h7-0-1721" class="d">-		raise hg_util.Abort(codereview_disabled)
</a><a href="#h7-0-1722" id="h7-0-1722" class="d">-
</a><a href="#h7-0-1723" id="h7-0-1723" class="d">-	pats = tuple([pat] + list(pats))
</a><a href="#h7-0-1724" id="h7-0-1724" class="d">-	if not GoodCLName(clname):
</a><a href="#h7-0-1725" id="h7-0-1725" class="d">-		return &quot;invalid CL name &quot; + clname
</a><a href="#h7-0-1726" id="h7-0-1726" class="d">-
</a><a href="#h7-0-1727" id="h7-0-1727" class="d">-	dirty = {}
</a><a href="#h7-0-1728" id="h7-0-1728" class="d">-	cl, err = LoadCL(ui, repo, clname, web=False)
</a><a href="#h7-0-1729" id="h7-0-1729" class="d">-	if err != &#39;&#39;:
</a><a href="#h7-0-1730" id="h7-0-1730" class="d">-		return err
</a><a href="#h7-0-1731" id="h7-0-1731" class="d">-	if not cl.local:
</a><a href="#h7-0-1732" id="h7-0-1732" class="d">-		return &quot;cannot change non-local CL &quot; + clname
</a><a href="#h7-0-1733" id="h7-0-1733" class="d">-
</a><a href="#h7-0-1734" id="h7-0-1734" class="d">-	files = ChangedFiles(ui, repo, pats)
</a><a href="#h7-0-1735" id="h7-0-1735" class="d">-
</a><a href="#h7-0-1736" id="h7-0-1736" class="d">-	if opts[&quot;delete&quot;]:
</a><a href="#h7-0-1737" id="h7-0-1737" class="d">-		oldfiles = Intersect(files, cl.files)
</a><a href="#h7-0-1738" id="h7-0-1738" class="d">-		if oldfiles:
</a><a href="#h7-0-1739" id="h7-0-1739" class="d">-			if not ui.quiet:
</a><a href="#h7-0-1740" id="h7-0-1740" class="d">-				ui.status(&quot;# Removing files from CL.  To undo:\n&quot;)
</a><a href="#h7-0-1741" id="h7-0-1741" class="d">-				ui.status(&quot;#	cd %s\n&quot; % (repo.root))
</a><a href="#h7-0-1742" id="h7-0-1742" class="d">-				for f in oldfiles:
</a><a href="#h7-0-1743" id="h7-0-1743" class="d">-					ui.status(&quot;#	hg file %s %s\n&quot; % (cl.name, f))
</a><a href="#h7-0-1744" id="h7-0-1744" class="d">-			cl.files = Sub(cl.files, oldfiles)
</a><a href="#h7-0-1745" id="h7-0-1745" class="d">-			cl.Flush(ui, repo)
</a><a href="#h7-0-1746" id="h7-0-1746" class="d">-		else:
</a><a href="#h7-0-1747" id="h7-0-1747" class="d">-			ui.status(&quot;no such files in CL&quot;)
</a><a href="#h7-0-1748" id="h7-0-1748" class="d">-		return
</a><a href="#h7-0-1749" id="h7-0-1749" class="d">-
</a><a href="#h7-0-1750" id="h7-0-1750" class="d">-	if not files:
</a><a href="#h7-0-1751" id="h7-0-1751" class="d">-		return &quot;no such modified files&quot;
</a><a href="#h7-0-1752" id="h7-0-1752" class="d">-
</a><a href="#h7-0-1753" id="h7-0-1753" class="d">-	files = Sub(files, cl.files)
</a><a href="#h7-0-1754" id="h7-0-1754" class="d">-	taken = Taken(ui, repo)
</a><a href="#h7-0-1755" id="h7-0-1755" class="d">-	warned = False
</a><a href="#h7-0-1756" id="h7-0-1756" class="d">-	for f in files:
</a><a href="#h7-0-1757" id="h7-0-1757" class="d">-		if f in taken:
</a><a href="#h7-0-1758" id="h7-0-1758" class="d">-			if not warned and not ui.quiet:
</a><a href="#h7-0-1759" id="h7-0-1759" class="d">-				ui.status(&quot;# Taking files from other CLs.  To undo:\n&quot;)
</a><a href="#h7-0-1760" id="h7-0-1760" class="d">-				ui.status(&quot;#	cd %s\n&quot; % (repo.root))
</a><a href="#h7-0-1761" id="h7-0-1761" class="d">-				warned = True
</a><a href="#h7-0-1762" id="h7-0-1762" class="d">-			ocl = taken[f]
</a><a href="#h7-0-1763" id="h7-0-1763" class="d">-			if not ui.quiet:
</a><a href="#h7-0-1764" id="h7-0-1764" class="d">-				ui.status(&quot;#	hg file %s %s\n&quot; % (ocl.name, f))
</a><a href="#h7-0-1765" id="h7-0-1765" class="d">-			if ocl not in dirty:
</a><a href="#h7-0-1766" id="h7-0-1766" class="d">-				ocl.files = Sub(ocl.files, files)
</a><a href="#h7-0-1767" id="h7-0-1767" class="d">-				dirty[ocl] = True
</a><a href="#h7-0-1768" id="h7-0-1768" class="d">-	cl.files = Add(cl.files, files)
</a><a href="#h7-0-1769" id="h7-0-1769" class="d">-	dirty[cl] = True
</a><a href="#h7-0-1770" id="h7-0-1770" class="d">-	for d, _ in dirty.items():
</a><a href="#h7-0-1771" id="h7-0-1771" class="d">-		d.Flush(ui, repo)
</a><a href="#h7-0-1772" id="h7-0-1772" class="d">-	return
</a><a href="#h7-0-1773" id="h7-0-1773" class="d">-
</a><a href="#h7-0-1774" id="h7-0-1774" class="d">-#######################################################################
</a><a href="#h7-0-1775" id="h7-0-1775" class="d">-# hg gofmt
</a><a href="#h7-0-1776" id="h7-0-1776" class="d">-
</a><a href="#h7-0-1777" id="h7-0-1777" class="d">-@hgcommand
</a><a href="#h7-0-1778" id="h7-0-1778" class="d">-def gofmt(ui, repo, *pats, **opts):
</a><a href="#h7-0-1779" id="h7-0-1779" class="d">-	&quot;&quot;&quot;apply gofmt to modified files
</a><a href="#h7-0-1780" id="h7-0-1780" class="d">-
</a><a href="#h7-0-1781" id="h7-0-1781" class="d">-	Applies gofmt to the modified files in the repository that match
</a><a href="#h7-0-1782" id="h7-0-1782" class="d">-	the given patterns.
</a><a href="#h7-0-1783" id="h7-0-1783" class="d">-	&quot;&quot;&quot;
</a><a href="#h7-0-1784" id="h7-0-1784" class="d">-	if codereview_disabled:
</a><a href="#h7-0-1785" id="h7-0-1785" class="d">-		raise hg_util.Abort(codereview_disabled)
</a><a href="#h7-0-1786" id="h7-0-1786" class="d">-
</a><a href="#h7-0-1787" id="h7-0-1787" class="d">-	files = ChangedExistingFiles(ui, repo, pats, opts)
</a><a href="#h7-0-1788" id="h7-0-1788" class="d">-	files = gofmt_required(files)
</a><a href="#h7-0-1789" id="h7-0-1789" class="d">-	if not files:
</a><a href="#h7-0-1790" id="h7-0-1790" class="d">-		ui.status(&quot;no modified go files\n&quot;)
</a><a href="#h7-0-1791" id="h7-0-1791" class="d">-		return
</a><a href="#h7-0-1792" id="h7-0-1792" class="d">-	cwd = os.getcwd()
</a><a href="#h7-0-1793" id="h7-0-1793" class="d">-	files = [RelativePath(repo.root + &#39;/&#39; + f, cwd) for f in files]
</a><a href="#h7-0-1794" id="h7-0-1794" class="d">-	try:
</a><a href="#h7-0-1795" id="h7-0-1795" class="d">-		cmd = [&quot;gofmt&quot;, &quot;-l&quot;]
</a><a href="#h7-0-1796" id="h7-0-1796" class="d">-		if not opts[&quot;list&quot;]:
</a><a href="#h7-0-1797" id="h7-0-1797" class="d">-			cmd += [&quot;-w&quot;]
</a><a href="#h7-0-1798" id="h7-0-1798" class="d">-		if subprocess.call(cmd + files) != 0:
</a><a href="#h7-0-1799" id="h7-0-1799" class="d">-			raise hg_util.Abort(&quot;gofmt did not exit cleanly&quot;)
</a><a href="#h7-0-1800" id="h7-0-1800" class="d">-	except hg_error.Abort, e:
</a><a href="#h7-0-1801" id="h7-0-1801" class="d">-		raise
</a><a href="#h7-0-1802" id="h7-0-1802" class="d">-	except:
</a><a href="#h7-0-1803" id="h7-0-1803" class="d">-		raise hg_util.Abort(&quot;gofmt: &quot; + ExceptionDetail())
</a><a href="#h7-0-1804" id="h7-0-1804" class="d">-	return
</a><a href="#h7-0-1805" id="h7-0-1805" class="d">-
</a><a href="#h7-0-1806" id="h7-0-1806" class="d">-def gofmt_required(files):
</a><a href="#h7-0-1807" id="h7-0-1807" class="d">-	return [f for f in files if (not f.startswith(&#39;test/&#39;) or f.startswith(&#39;test/bench/&#39;)) and f.endswith(&#39;.go&#39;)]
</a><a href="#h7-0-1808" id="h7-0-1808" class="d">-
</a><a href="#h7-0-1809" id="h7-0-1809" class="d">-#######################################################################
</a><a href="#h7-0-1810" id="h7-0-1810" class="d">-# hg mail
</a><a href="#h7-0-1811" id="h7-0-1811" class="d">-
</a><a href="#h7-0-1812" id="h7-0-1812" class="d">-@hgcommand
</a><a href="#h7-0-1813" id="h7-0-1813" class="d">-def mail(ui, repo, *pats, **opts):
</a><a href="#h7-0-1814" id="h7-0-1814" class="d">-	&quot;&quot;&quot;mail a change for review
</a><a href="#h7-0-1815" id="h7-0-1815" class="d">-
</a><a href="#h7-0-1816" id="h7-0-1816" class="d">-	Uploads a patch to the code review server and then sends mail
</a><a href="#h7-0-1817" id="h7-0-1817" class="d">-	to the reviewer and CC list asking for a review.
</a><a href="#h7-0-1818" id="h7-0-1818" class="d">-	&quot;&quot;&quot;
</a><a href="#h7-0-1819" id="h7-0-1819" class="d">-	if codereview_disabled:
</a><a href="#h7-0-1820" id="h7-0-1820" class="d">-		raise hg_util.Abort(codereview_disabled)
</a><a href="#h7-0-1821" id="h7-0-1821" class="d">-
</a><a href="#h7-0-1822" id="h7-0-1822" class="d">-	cl, err = CommandLineCL(ui, repo, pats, opts, op=&quot;mail&quot;, defaultcc=defaultcc)
</a><a href="#h7-0-1823" id="h7-0-1823" class="d">-	if err != &quot;&quot;:
</a><a href="#h7-0-1824" id="h7-0-1824" class="d">-		raise hg_util.Abort(err)
</a><a href="#h7-0-1825" id="h7-0-1825" class="d">-	cl.Upload(ui, repo, gofmt_just_warn=True)
</a><a href="#h7-0-1826" id="h7-0-1826" class="d">-	if not cl.reviewer:
</a><a href="#h7-0-1827" id="h7-0-1827" class="d">-		# If no reviewer is listed, assign the review to defaultcc.
</a><a href="#h7-0-1828" id="h7-0-1828" class="d">-		# This makes sure that it appears in the 
</a><a href="#h7-0-1829" id="h7-0-1829" class="d">-		# codereview.appspot.com/user/defaultcc
</a><a href="#h7-0-1830" id="h7-0-1830" class="d">-		# page, so that it doesn&#39;t get dropped on the floor.
</a><a href="#h7-0-1831" id="h7-0-1831" class="d">-		if not defaultcc:
</a><a href="#h7-0-1832" id="h7-0-1832" class="d">-			raise hg_util.Abort(&quot;no reviewers listed in CL&quot;)
</a><a href="#h7-0-1833" id="h7-0-1833" class="d">-		cl.cc = Sub(cl.cc, defaultcc)
</a><a href="#h7-0-1834" id="h7-0-1834" class="d">-		cl.reviewer = defaultcc
</a><a href="#h7-0-1835" id="h7-0-1835" class="d">-		cl.Flush(ui, repo)
</a><a href="#h7-0-1836" id="h7-0-1836" class="d">-
</a><a href="#h7-0-1837" id="h7-0-1837" class="d">-	if cl.files == []:
</a><a href="#h7-0-1838" id="h7-0-1838" class="d">-			raise hg_util.Abort(&quot;no changed files, not sending mail&quot;)
</a><a href="#h7-0-1839" id="h7-0-1839" class="d">-
</a><a href="#h7-0-1840" id="h7-0-1840" class="d">-	cl.Mail(ui, repo)
</a><a href="#h7-0-1841" id="h7-0-1841" class="d">-
</a><a href="#h7-0-1842" id="h7-0-1842" class="d">-#######################################################################
</a><a href="#h7-0-1843" id="h7-0-1843" class="d">-# hg p / hg pq / hg ps / hg pending
</a><a href="#h7-0-1844" id="h7-0-1844" class="d">-
</a><a href="#h7-0-1845" id="h7-0-1845" class="d">-@hgcommand
</a><a href="#h7-0-1846" id="h7-0-1846" class="d">-def ps(ui, repo, *pats, **opts):
</a><a href="#h7-0-1847" id="h7-0-1847" class="d">-	&quot;&quot;&quot;alias for hg p --short
</a><a href="#h7-0-1848" id="h7-0-1848" class="d">-	&quot;&quot;&quot;
</a><a href="#h7-0-1849" id="h7-0-1849" class="d">-	opts[&#39;short&#39;] = True
</a><a href="#h7-0-1850" id="h7-0-1850" class="d">-	return pending(ui, repo, *pats, **opts)
</a><a href="#h7-0-1851" id="h7-0-1851" class="d">-
</a><a href="#h7-0-1852" id="h7-0-1852" class="d">-@hgcommand
</a><a href="#h7-0-1853" id="h7-0-1853" class="d">-def pq(ui, repo, *pats, **opts):
</a><a href="#h7-0-1854" id="h7-0-1854" class="d">-	&quot;&quot;&quot;alias for hg p --quick
</a><a href="#h7-0-1855" id="h7-0-1855" class="d">-	&quot;&quot;&quot;
</a><a href="#h7-0-1856" id="h7-0-1856" class="d">-	opts[&#39;quick&#39;] = True
</a><a href="#h7-0-1857" id="h7-0-1857" class="d">-	return pending(ui, repo, *pats, **opts)
</a><a href="#h7-0-1858" id="h7-0-1858" class="d">-
</a><a href="#h7-0-1859" id="h7-0-1859" class="d">-@hgcommand
</a><a href="#h7-0-1860" id="h7-0-1860" class="d">-def pending(ui, repo, *pats, **opts):
</a><a href="#h7-0-1861" id="h7-0-1861" class="d">-	&quot;&quot;&quot;show pending changes
</a><a href="#h7-0-1862" id="h7-0-1862" class="d">-
</a><a href="#h7-0-1863" id="h7-0-1863" class="d">-	Lists pending changes followed by a list of unassigned but modified files.
</a><a href="#h7-0-1864" id="h7-0-1864" class="d">-	&quot;&quot;&quot;
</a><a href="#h7-0-1865" id="h7-0-1865" class="d">-	if codereview_disabled:
</a><a href="#h7-0-1866" id="h7-0-1866" class="d">-		raise hg_util.Abort(codereview_disabled)
</a><a href="#h7-0-1867" id="h7-0-1867" class="d">-
</a><a href="#h7-0-1868" id="h7-0-1868" class="d">-	quick = opts.get(&#39;quick&#39;, False)
</a><a href="#h7-0-1869" id="h7-0-1869" class="d">-	short = opts.get(&#39;short&#39;, False)
</a><a href="#h7-0-1870" id="h7-0-1870" class="d">-	m = LoadAllCL(ui, repo, web=not quick and not short)
</a><a href="#h7-0-1871" id="h7-0-1871" class="d">-	names = m.keys()
</a><a href="#h7-0-1872" id="h7-0-1872" class="d">-	names.sort()
</a><a href="#h7-0-1873" id="h7-0-1873" class="d">-	for name in names:
</a><a href="#h7-0-1874" id="h7-0-1874" class="d">-		cl = m[name]
</a><a href="#h7-0-1875" id="h7-0-1875" class="d">-		if short:
</a><a href="#h7-0-1876" id="h7-0-1876" class="d">-			ui.write(name + &quot;\t&quot; + line1(cl.desc) + &quot;\n&quot;)
</a><a href="#h7-0-1877" id="h7-0-1877" class="d">-		else:
</a><a href="#h7-0-1878" id="h7-0-1878" class="d">-			ui.write(cl.PendingText(quick=quick) + &quot;\n&quot;)
</a><a href="#h7-0-1879" id="h7-0-1879" class="d">-
</a><a href="#h7-0-1880" id="h7-0-1880" class="d">-	if short:
</a><a href="#h7-0-1881" id="h7-0-1881" class="d">-		return 0
</a><a href="#h7-0-1882" id="h7-0-1882" class="d">-	files = DefaultFiles(ui, repo, [])
</a><a href="#h7-0-1883" id="h7-0-1883" class="d">-	if len(files) &gt; 0:
</a><a href="#h7-0-1884" id="h7-0-1884" class="d">-		s = &quot;Changed files not in any CL:\n&quot;
</a><a href="#h7-0-1885" id="h7-0-1885" class="d">-		for f in files:
</a><a href="#h7-0-1886" id="h7-0-1886" class="d">-			s += &quot;\t&quot; + f + &quot;\n&quot;
</a><a href="#h7-0-1887" id="h7-0-1887" class="d">-		ui.write(s)
</a><a href="#h7-0-1888" id="h7-0-1888" class="d">-
</a><a href="#h7-0-1889" id="h7-0-1889" class="d">-#######################################################################
</a><a href="#h7-0-1890" id="h7-0-1890" class="d">-# hg submit
</a><a href="#h7-0-1891" id="h7-0-1891" class="d">-
</a><a href="#h7-0-1892" id="h7-0-1892" class="d">-def need_sync():
</a><a href="#h7-0-1893" id="h7-0-1893" class="d">-	raise hg_util.Abort(&quot;local repository out of date; must sync before submit&quot;)
</a><a href="#h7-0-1894" id="h7-0-1894" class="d">-
</a><a href="#h7-0-1895" id="h7-0-1895" class="d">-@hgcommand
</a><a href="#h7-0-1896" id="h7-0-1896" class="d">-def submit(ui, repo, *pats, **opts):
</a><a href="#h7-0-1897" id="h7-0-1897" class="d">-	&quot;&quot;&quot;submit change to remote repository
</a><a href="#h7-0-1898" id="h7-0-1898" class="d">-
</a><a href="#h7-0-1899" id="h7-0-1899" class="d">-	Submits change to remote repository.
</a><a href="#h7-0-1900" id="h7-0-1900" class="d">-	Bails out if the local repository is not in sync with the remote one.
</a><a href="#h7-0-1901" id="h7-0-1901" class="d">-	&quot;&quot;&quot;
</a><a href="#h7-0-1902" id="h7-0-1902" class="d">-	if codereview_disabled:
</a><a href="#h7-0-1903" id="h7-0-1903" class="d">-		raise hg_util.Abort(codereview_disabled)
</a><a href="#h7-0-1904" id="h7-0-1904" class="d">-
</a><a href="#h7-0-1905" id="h7-0-1905" class="d">-	# We already called this on startup but sometimes Mercurial forgets.
</a><a href="#h7-0-1906" id="h7-0-1906" class="d">-	set_mercurial_encoding_to_utf8()
</a><a href="#h7-0-1907" id="h7-0-1907" class="d">-
</a><a href="#h7-0-1908" id="h7-0-1908" class="d">-	if not opts[&quot;no_incoming&quot;] and hg_incoming(ui, repo):
</a><a href="#h7-0-1909" id="h7-0-1909" class="d">-		need_sync()
</a><a href="#h7-0-1910" id="h7-0-1910" class="d">-
</a><a href="#h7-0-1911" id="h7-0-1911" class="d">-	cl, err = CommandLineCL(ui, repo, pats, opts, op=&quot;submit&quot;, defaultcc=defaultcc)
</a><a href="#h7-0-1912" id="h7-0-1912" class="d">-	if err != &quot;&quot;:
</a><a href="#h7-0-1913" id="h7-0-1913" class="d">-		raise hg_util.Abort(err)
</a><a href="#h7-0-1914" id="h7-0-1914" class="d">-
</a><a href="#h7-0-1915" id="h7-0-1915" class="d">-	user = None
</a><a href="#h7-0-1916" id="h7-0-1916" class="d">-	if cl.copied_from:
</a><a href="#h7-0-1917" id="h7-0-1917" class="d">-		user = cl.copied_from
</a><a href="#h7-0-1918" id="h7-0-1918" class="d">-	userline = CheckContributor(ui, repo, user)
</a><a href="#h7-0-1919" id="h7-0-1919" class="d">-	typecheck(userline, str)
</a><a href="#h7-0-1920" id="h7-0-1920" class="d">-
</a><a href="#h7-0-1921" id="h7-0-1921" class="d">-	about = &quot;&quot;
</a><a href="#h7-0-1922" id="h7-0-1922" class="d">-	if cl.reviewer:
</a><a href="#h7-0-1923" id="h7-0-1923" class="d">-		about += &quot;R=&quot; + JoinComma([CutDomain(s) for s in cl.reviewer]) + &quot;\n&quot;
</a><a href="#h7-0-1924" id="h7-0-1924" class="d">-	if opts.get(&#39;tbr&#39;):
</a><a href="#h7-0-1925" id="h7-0-1925" class="d">-		tbr = SplitCommaSpace(opts.get(&#39;tbr&#39;))
</a><a href="#h7-0-1926" id="h7-0-1926" class="d">-		cl.reviewer = Add(cl.reviewer, tbr)
</a><a href="#h7-0-1927" id="h7-0-1927" class="d">-		about += &quot;TBR=&quot; + JoinComma([CutDomain(s) for s in tbr]) + &quot;\n&quot;
</a><a href="#h7-0-1928" id="h7-0-1928" class="d">-	if cl.cc:
</a><a href="#h7-0-1929" id="h7-0-1929" class="d">-		about += &quot;CC=&quot; + JoinComma([CutDomain(s) for s in cl.cc]) + &quot;\n&quot;
</a><a href="#h7-0-1930" id="h7-0-1930" class="d">-
</a><a href="#h7-0-1931" id="h7-0-1931" class="d">-	if not cl.reviewer:
</a><a href="#h7-0-1932" id="h7-0-1932" class="d">-		raise hg_util.Abort(&quot;no reviewers listed in CL&quot;)
</a><a href="#h7-0-1933" id="h7-0-1933" class="d">-
</a><a href="#h7-0-1934" id="h7-0-1934" class="d">-	if not cl.local:
</a><a href="#h7-0-1935" id="h7-0-1935" class="d">-		raise hg_util.Abort(&quot;cannot submit non-local CL&quot;)
</a><a href="#h7-0-1936" id="h7-0-1936" class="d">-
</a><a href="#h7-0-1937" id="h7-0-1937" class="d">-	# upload, to sync current patch and also get change number if CL is new.
</a><a href="#h7-0-1938" id="h7-0-1938" class="d">-	if not cl.copied_from:
</a><a href="#h7-0-1939" id="h7-0-1939" class="d">-		cl.Upload(ui, repo, gofmt_just_warn=True)
</a><a href="#h7-0-1940" id="h7-0-1940" class="d">-
</a><a href="#h7-0-1941" id="h7-0-1941" class="d">-	# check gofmt for real; allowed upload to warn in order to save CL.
</a><a href="#h7-0-1942" id="h7-0-1942" class="d">-	cl.Flush(ui, repo)
</a><a href="#h7-0-1943" id="h7-0-1943" class="d">-	CheckFormat(ui, repo, cl.files)
</a><a href="#h7-0-1944" id="h7-0-1944" class="d">-
</a><a href="#h7-0-1945" id="h7-0-1945" class="d">-	about += &quot;%s%s\n&quot; % (server_url_base, cl.name)
</a><a href="#h7-0-1946" id="h7-0-1946" class="d">-
</a><a href="#h7-0-1947" id="h7-0-1947" class="d">-	if cl.copied_from:
</a><a href="#h7-0-1948" id="h7-0-1948" class="d">-		about += &quot;\nCommitter: &quot; + CheckContributor(ui, repo, None) + &quot;\n&quot;
</a><a href="#h7-0-1949" id="h7-0-1949" class="d">-	typecheck(about, str)
</a><a href="#h7-0-1950" id="h7-0-1950" class="d">-
</a><a href="#h7-0-1951" id="h7-0-1951" class="d">-	if not cl.mailed and not cl.copied_from:		# in case this is TBR
</a><a href="#h7-0-1952" id="h7-0-1952" class="d">-		cl.Mail(ui, repo)
</a><a href="#h7-0-1953" id="h7-0-1953" class="d">-
</a><a href="#h7-0-1954" id="h7-0-1954" class="d">-	# submit changes locally
</a><a href="#h7-0-1955" id="h7-0-1955" class="d">-	message = cl.desc.rstrip() + &quot;\n\n&quot; + about
</a><a href="#h7-0-1956" id="h7-0-1956" class="d">-	typecheck(message, str)
</a><a href="#h7-0-1957" id="h7-0-1957" class="d">-
</a><a href="#h7-0-1958" id="h7-0-1958" class="d">-	set_status(&quot;pushing &quot; + cl.name + &quot; to remote server&quot;)
</a><a href="#h7-0-1959" id="h7-0-1959" class="d">-
</a><a href="#h7-0-1960" id="h7-0-1960" class="d">-	if hg_outgoing(ui, repo):
</a><a href="#h7-0-1961" id="h7-0-1961" class="d">-		raise hg_util.Abort(&quot;local repository corrupt or out-of-phase with remote: found outgoing changes&quot;)
</a><a href="#h7-0-1962" id="h7-0-1962" class="d">-	
</a><a href="#h7-0-1963" id="h7-0-1963" class="d">-	old_heads = len(hg_heads(ui, repo).split())
</a><a href="#h7-0-1964" id="h7-0-1964" class="d">-
</a><a href="#h7-0-1965" id="h7-0-1965" class="d">-	global commit_okay
</a><a href="#h7-0-1966" id="h7-0-1966" class="d">-	commit_okay = True
</a><a href="#h7-0-1967" id="h7-0-1967" class="d">-	ret = hg_commit(ui, repo, *[&#39;path:&#39;+f for f in cl.files], message=message, user=userline)
</a><a href="#h7-0-1968" id="h7-0-1968" class="d">-	commit_okay = False
</a><a href="#h7-0-1969" id="h7-0-1969" class="d">-	if ret:
</a><a href="#h7-0-1970" id="h7-0-1970" class="d">-		raise hg_util.Abort(&quot;nothing changed&quot;)
</a><a href="#h7-0-1971" id="h7-0-1971" class="d">-	node = repo[&quot;-1&quot;].node()
</a><a href="#h7-0-1972" id="h7-0-1972" class="d">-	# push to remote; if it fails for any reason, roll back
</a><a href="#h7-0-1973" id="h7-0-1973" class="d">-	try:
</a><a href="#h7-0-1974" id="h7-0-1974" class="d">-		new_heads = len(hg_heads(ui, repo).split())
</a><a href="#h7-0-1975" id="h7-0-1975" class="d">-		if old_heads != new_heads and not (old_heads == 0 and new_heads == 1):
</a><a href="#h7-0-1976" id="h7-0-1976" class="d">-			# Created new head, so we weren&#39;t up to date.
</a><a href="#h7-0-1977" id="h7-0-1977" class="d">-			need_sync()
</a><a href="#h7-0-1978" id="h7-0-1978" class="d">-
</a><a href="#h7-0-1979" id="h7-0-1979" class="d">-		# Push changes to remote.  If it works, we&#39;re committed.  If not, roll back.
</a><a href="#h7-0-1980" id="h7-0-1980" class="d">-		try:
</a><a href="#h7-0-1981" id="h7-0-1981" class="d">-			if hg_push(ui, repo):
</a><a href="#h7-0-1982" id="h7-0-1982" class="d">-				raise hg_util.Abort(&quot;push error&quot;)
</a><a href="#h7-0-1983" id="h7-0-1983" class="d">-		except hg_error.Abort, e:
</a><a href="#h7-0-1984" id="h7-0-1984" class="d">-			if e.message.find(&quot;push creates new heads&quot;) &gt;= 0:
</a><a href="#h7-0-1985" id="h7-0-1985" class="d">-				# Remote repository had changes we missed.
</a><a href="#h7-0-1986" id="h7-0-1986" class="d">-				need_sync()
</a><a href="#h7-0-1987" id="h7-0-1987" class="d">-			raise
</a><a href="#h7-0-1988" id="h7-0-1988" class="d">-		except urllib2.HTTPError, e:
</a><a href="#h7-0-1989" id="h7-0-1989" class="d">-			print &gt;&gt;sys.stderr, &quot;pushing to remote server failed; do you have commit permissions?&quot;
</a><a href="#h7-0-1990" id="h7-0-1990" class="d">-			raise
</a><a href="#h7-0-1991" id="h7-0-1991" class="d">-	except:
</a><a href="#h7-0-1992" id="h7-0-1992" class="d">-		real_rollback()
</a><a href="#h7-0-1993" id="h7-0-1993" class="d">-		raise
</a><a href="#h7-0-1994" id="h7-0-1994" class="d">-
</a><a href="#h7-0-1995" id="h7-0-1995" class="d">-	# We&#39;re committed. Upload final patch, close review, add commit message.
</a><a href="#h7-0-1996" id="h7-0-1996" class="d">-	changeURL = hg_node.short(node)
</a><a href="#h7-0-1997" id="h7-0-1997" class="d">-	url = ui.expandpath(&quot;default&quot;)
</a><a href="#h7-0-1998" id="h7-0-1998" class="d">-	m = re.match(&quot;(^https?://([^@/]+@)?([^.]+)\.googlecode\.com/hg/?)&quot; + &quot;|&quot; +
</a><a href="#h7-0-1999" id="h7-0-1999" class="d">-		&quot;(^https?://([^@/]+@)?code\.google\.com/p/([^/.]+)(\.[^./]+)?/?)&quot;, url)
</a><a href="#h7-0-2000" id="h7-0-2000" class="d">-	if m:
</a><a href="#h7-0-2001" id="h7-0-2001" class="d">-		if m.group(1): # prj.googlecode.com/hg/ case
</a><a href="#h7-0-2002" id="h7-0-2002" class="d">-			changeURL = &quot;https://code.google.com/p/%s/source/detail?r=%s&quot; % (m.group(3), changeURL)
</a><a href="#h7-0-2003" id="h7-0-2003" class="d">-		elif m.group(4) and m.group(7): # code.google.com/p/prj.subrepo/ case
</a><a href="#h7-0-2004" id="h7-0-2004" class="d">-			changeURL = &quot;https://code.google.com/p/%s/source/detail?r=%s&amp;repo=%s&quot; % (m.group(6), changeURL, m.group(7)[1:])
</a><a href="#h7-0-2005" id="h7-0-2005" class="d">-		elif m.group(4): # code.google.com/p/prj/ case
</a><a href="#h7-0-2006" id="h7-0-2006" class="d">-			changeURL = &quot;https://code.google.com/p/%s/source/detail?r=%s&quot; % (m.group(6), changeURL)
</a><a href="#h7-0-2007" id="h7-0-2007" class="d">-		else:
</a><a href="#h7-0-2008" id="h7-0-2008" class="d">-			print &gt;&gt;sys.stderr, &quot;URL: &quot;, url
</a><a href="#h7-0-2009" id="h7-0-2009" class="d">-	else:
</a><a href="#h7-0-2010" id="h7-0-2010" class="d">-		print &gt;&gt;sys.stderr, &quot;URL: &quot;, url
</a><a href="#h7-0-2011" id="h7-0-2011" class="d">-	pmsg = &quot;*** Submitted as &quot; + changeURL + &quot; ***\n\n&quot; + message
</a><a href="#h7-0-2012" id="h7-0-2012" class="d">-
</a><a href="#h7-0-2013" id="h7-0-2013" class="d">-	# When posting, move reviewers to CC line,
</a><a href="#h7-0-2014" id="h7-0-2014" class="d">-	# so that the issue stops showing up in their &quot;My Issues&quot; page.
</a><a href="#h7-0-2015" id="h7-0-2015" class="d">-	PostMessage(ui, cl.name, pmsg, reviewers=&quot;&quot;, cc=JoinComma(cl.reviewer+cl.cc))
</a><a href="#h7-0-2016" id="h7-0-2016" class="d">-
</a><a href="#h7-0-2017" id="h7-0-2017" class="d">-	if not cl.copied_from:
</a><a href="#h7-0-2018" id="h7-0-2018" class="d">-		EditDesc(cl.name, closed=True, private=cl.private)
</a><a href="#h7-0-2019" id="h7-0-2019" class="d">-	cl.Delete(ui, repo)
</a><a href="#h7-0-2020" id="h7-0-2020" class="d">-
</a><a href="#h7-0-2021" id="h7-0-2021" class="d">-	c = repo[None]
</a><a href="#h7-0-2022" id="h7-0-2022" class="d">-	if c.branch() == releaseBranch and not c.modified() and not c.added() and not c.removed():
</a><a href="#h7-0-2023" id="h7-0-2023" class="d">-		ui.write(&quot;switching from %s to default branch.\n&quot; % releaseBranch)
</a><a href="#h7-0-2024" id="h7-0-2024" class="d">-		err = hg_clean(repo, &quot;default&quot;)
</a><a href="#h7-0-2025" id="h7-0-2025" class="d">-		if err:
</a><a href="#h7-0-2026" id="h7-0-2026" class="d">-			return err
</a><a href="#h7-0-2027" id="h7-0-2027" class="d">-	return 0
</a><a href="#h7-0-2028" id="h7-0-2028" class="d">-
</a><a href="#h7-0-2029" id="h7-0-2029" class="d">-#######################################################################
</a><a href="#h7-0-2030" id="h7-0-2030" class="d">-# hg sync
</a><a href="#h7-0-2031" id="h7-0-2031" class="d">-
</a><a href="#h7-0-2032" id="h7-0-2032" class="d">-@hgcommand
</a><a href="#h7-0-2033" id="h7-0-2033" class="d">-def sync(ui, repo, **opts):
</a><a href="#h7-0-2034" id="h7-0-2034" class="d">-	&quot;&quot;&quot;synchronize with remote repository
</a><a href="#h7-0-2035" id="h7-0-2035" class="d">-
</a><a href="#h7-0-2036" id="h7-0-2036" class="d">-	Incorporates recent changes from the remote repository
</a><a href="#h7-0-2037" id="h7-0-2037" class="d">-	into the local repository.
</a><a href="#h7-0-2038" id="h7-0-2038" class="d">-	&quot;&quot;&quot;
</a><a href="#h7-0-2039" id="h7-0-2039" class="d">-	if codereview_disabled:
</a><a href="#h7-0-2040" id="h7-0-2040" class="d">-		raise hg_util.Abort(codereview_disabled)
</a><a href="#h7-0-2041" id="h7-0-2041" class="d">-
</a><a href="#h7-0-2042" id="h7-0-2042" class="d">-	if not opts[&quot;local&quot;]:
</a><a href="#h7-0-2043" id="h7-0-2043" class="d">-		# If there are incoming CLs, pull -u will do the update.
</a><a href="#h7-0-2044" id="h7-0-2044" class="d">-		# If there are no incoming CLs, do hg update to make sure
</a><a href="#h7-0-2045" id="h7-0-2045" class="d">-		# that an update always happens regardless. This is less
</a><a href="#h7-0-2046" id="h7-0-2046" class="d">-		# surprising than update depending on incoming CLs.
</a><a href="#h7-0-2047" id="h7-0-2047" class="d">-		# It is important not to do both hg pull -u and hg update
</a><a href="#h7-0-2048" id="h7-0-2048" class="d">-		# in the same command, because the hg update will end
</a><a href="#h7-0-2049" id="h7-0-2049" class="d">-		# up marking resolve conflicts from the hg pull -u as resolved,
</a><a href="#h7-0-2050" id="h7-0-2050" class="d">-		# causing files with &lt;&lt;&lt; &gt;&gt;&gt; markers to not show up in 
</a><a href="#h7-0-2051" id="h7-0-2051" class="d">-		# hg resolve -l. Yay Mercurial.
</a><a href="#h7-0-2052" id="h7-0-2052" class="d">-		if hg_incoming(ui, repo):
</a><a href="#h7-0-2053" id="h7-0-2053" class="d">-			err = hg_pull(ui, repo, update=True)
</a><a href="#h7-0-2054" id="h7-0-2054" class="d">-		else:
</a><a href="#h7-0-2055" id="h7-0-2055" class="d">-			err = hg_update(ui, repo)
</a><a href="#h7-0-2056" id="h7-0-2056" class="d">-		if err:
</a><a href="#h7-0-2057" id="h7-0-2057" class="d">-			return err
</a><a href="#h7-0-2058" id="h7-0-2058" class="d">-	sync_changes(ui, repo)
</a><a href="#h7-0-2059" id="h7-0-2059" class="d">-
</a><a href="#h7-0-2060" id="h7-0-2060" class="d">-def sync_changes(ui, repo):
</a><a href="#h7-0-2061" id="h7-0-2061" class="d">-	# Look through recent change log descriptions to find
</a><a href="#h7-0-2062" id="h7-0-2062" class="d">-	# potential references to http://.*/our-CL-number.
</a><a href="#h7-0-2063" id="h7-0-2063" class="d">-	# Double-check them by looking at the Rietveld log.
</a><a href="#h7-0-2064" id="h7-0-2064" class="d">-	for rev in hg_log(ui, repo, limit=100, template=&quot;{node}\n&quot;).split():
</a><a href="#h7-0-2065" id="h7-0-2065" class="d">-		desc = repo[rev].description().strip()
</a><a href="#h7-0-2066" id="h7-0-2066" class="d">-		for clname in re.findall(&#39;(?m)^https?://(?:[^\n]+)/([0-9]+)$&#39;, desc):
</a><a href="#h7-0-2067" id="h7-0-2067" class="d">-			if IsLocalCL(ui, repo, clname) and IsRietveldSubmitted(ui, clname, repo[rev].hex()):
</a><a href="#h7-0-2068" id="h7-0-2068" class="d">-				ui.warn(&quot;CL %s submitted as %s; closing\n&quot; % (clname, repo[rev]))
</a><a href="#h7-0-2069" id="h7-0-2069" class="d">-				cl, err = LoadCL(ui, repo, clname, web=False)
</a><a href="#h7-0-2070" id="h7-0-2070" class="d">-				if err != &quot;&quot;:
</a><a href="#h7-0-2071" id="h7-0-2071" class="d">-					ui.warn(&quot;loading CL %s: %s\n&quot; % (clname, err))
</a><a href="#h7-0-2072" id="h7-0-2072" class="d">-					continue
</a><a href="#h7-0-2073" id="h7-0-2073" class="d">-				if not cl.copied_from:
</a><a href="#h7-0-2074" id="h7-0-2074" class="d">-					EditDesc(cl.name, closed=True, private=cl.private)
</a><a href="#h7-0-2075" id="h7-0-2075" class="d">-				cl.Delete(ui, repo)
</a><a href="#h7-0-2076" id="h7-0-2076" class="d">-
</a><a href="#h7-0-2077" id="h7-0-2077" class="d">-	# Remove files that are not modified from the CLs in which they appear.
</a><a href="#h7-0-2078" id="h7-0-2078" class="d">-	all = LoadAllCL(ui, repo, web=False)
</a><a href="#h7-0-2079" id="h7-0-2079" class="d">-	changed = ChangedFiles(ui, repo, [])
</a><a href="#h7-0-2080" id="h7-0-2080" class="d">-	for cl in all.values():
</a><a href="#h7-0-2081" id="h7-0-2081" class="d">-		extra = Sub(cl.files, changed)
</a><a href="#h7-0-2082" id="h7-0-2082" class="d">-		if extra:
</a><a href="#h7-0-2083" id="h7-0-2083" class="d">-			ui.warn(&quot;Removing unmodified files from CL %s:\n&quot; % (cl.name,))
</a><a href="#h7-0-2084" id="h7-0-2084" class="d">-			for f in extra:
</a><a href="#h7-0-2085" id="h7-0-2085" class="d">-				ui.warn(&quot;\t%s\n&quot; % (f,))
</a><a href="#h7-0-2086" id="h7-0-2086" class="d">-			cl.files = Sub(cl.files, extra)
</a><a href="#h7-0-2087" id="h7-0-2087" class="d">-			cl.Flush(ui, repo)
</a><a href="#h7-0-2088" id="h7-0-2088" class="d">-		if not cl.files:
</a><a href="#h7-0-2089" id="h7-0-2089" class="d">-			if not cl.copied_from:
</a><a href="#h7-0-2090" id="h7-0-2090" class="d">-				ui.warn(&quot;CL %s has no files; delete (abandon) with hg change -d %s\n&quot; % (cl.name, cl.name))
</a><a href="#h7-0-2091" id="h7-0-2091" class="d">-			else:
</a><a href="#h7-0-2092" id="h7-0-2092" class="d">-				ui.warn(&quot;CL %s has no files; delete locally with hg change -D %s\n&quot; % (cl.name, cl.name))
</a><a href="#h7-0-2093" id="h7-0-2093" class="d">-	return 0
</a><a href="#h7-0-2094" id="h7-0-2094" class="d">-
</a><a href="#h7-0-2095" id="h7-0-2095" class="d">-#######################################################################
</a><a href="#h7-0-2096" id="h7-0-2096" class="d">-# hg upload
</a><a href="#h7-0-2097" id="h7-0-2097" class="d">-
</a><a href="#h7-0-2098" id="h7-0-2098" class="d">-@hgcommand
</a><a href="#h7-0-2099" id="h7-0-2099" class="d">-def upload(ui, repo, name, **opts):
</a><a href="#h7-0-2100" id="h7-0-2100" class="d">-	&quot;&quot;&quot;upload diffs to the code review server
</a><a href="#h7-0-2101" id="h7-0-2101" class="d">-
</a><a href="#h7-0-2102" id="h7-0-2102" class="d">-	Uploads the current modifications for a given change to the server.
</a><a href="#h7-0-2103" id="h7-0-2103" class="d">-	&quot;&quot;&quot;
</a><a href="#h7-0-2104" id="h7-0-2104" class="d">-	if codereview_disabled:
</a><a href="#h7-0-2105" id="h7-0-2105" class="d">-		raise hg_util.Abort(codereview_disabled)
</a><a href="#h7-0-2106" id="h7-0-2106" class="d">-
</a><a href="#h7-0-2107" id="h7-0-2107" class="d">-	repo.ui.quiet = True
</a><a href="#h7-0-2108" id="h7-0-2108" class="d">-	cl, err = LoadCL(ui, repo, name, web=True)
</a><a href="#h7-0-2109" id="h7-0-2109" class="d">-	if err != &quot;&quot;:
</a><a href="#h7-0-2110" id="h7-0-2110" class="d">-		raise hg_util.Abort(err)
</a><a href="#h7-0-2111" id="h7-0-2111" class="d">-	if not cl.local:
</a><a href="#h7-0-2112" id="h7-0-2112" class="d">-		raise hg_util.Abort(&quot;cannot upload non-local change&quot;)
</a><a href="#h7-0-2113" id="h7-0-2113" class="d">-	cl.Upload(ui, repo)
</a><a href="#h7-0-2114" id="h7-0-2114" class="d">-	print &quot;%s%s\n&quot; % (server_url_base, cl.name)
</a><a href="#h7-0-2115" id="h7-0-2115" class="d">-	return 0
</a><a href="#h7-0-2116" id="h7-0-2116" class="d">-
</a><a href="#h7-0-2117" id="h7-0-2117" class="d">-#######################################################################
</a><a href="#h7-0-2118" id="h7-0-2118" class="d">-# Table of commands, supplied to Mercurial for installation.
</a><a href="#h7-0-2119" id="h7-0-2119" class="d">-
</a><a href="#h7-0-2120" id="h7-0-2120" class="d">-review_opts = [
</a><a href="#h7-0-2121" id="h7-0-2121" class="d">-	(&#39;r&#39;, &#39;reviewer&#39;, &#39;&#39;, &#39;add reviewer&#39;),
</a><a href="#h7-0-2122" id="h7-0-2122" class="d">-	(&#39;&#39;, &#39;cc&#39;, &#39;&#39;, &#39;add cc&#39;),
</a><a href="#h7-0-2123" id="h7-0-2123" class="d">-	(&#39;&#39;, &#39;tbr&#39;, &#39;&#39;, &#39;add future reviewer&#39;),
</a><a href="#h7-0-2124" id="h7-0-2124" class="d">-	(&#39;m&#39;, &#39;message&#39;, &#39;&#39;, &#39;change description (for new change)&#39;),
</a><a href="#h7-0-2125" id="h7-0-2125" class="d">-]
</a><a href="#h7-0-2126" id="h7-0-2126" class="d">-
</a><a href="#h7-0-2127" id="h7-0-2127" class="d">-cmdtable = {
</a><a href="#h7-0-2128" id="h7-0-2128" class="d">-	# The ^ means to show this command in the help text that
</a><a href="#h7-0-2129" id="h7-0-2129" class="d">-	# is printed when running hg with no arguments.
</a><a href="#h7-0-2130" id="h7-0-2130" class="d">-	&quot;^change&quot;: (
</a><a href="#h7-0-2131" id="h7-0-2131" class="d">-		change,
</a><a href="#h7-0-2132" id="h7-0-2132" class="d">-		[
</a><a href="#h7-0-2133" id="h7-0-2133" class="d">-			(&#39;d&#39;, &#39;delete&#39;, None, &#39;delete existing change list&#39;),
</a><a href="#h7-0-2134" id="h7-0-2134" class="d">-			(&#39;D&#39;, &#39;deletelocal&#39;, None, &#39;delete locally, but do not change CL on server&#39;),
</a><a href="#h7-0-2135" id="h7-0-2135" class="d">-			(&#39;i&#39;, &#39;stdin&#39;, None, &#39;read change list from standard input&#39;),
</a><a href="#h7-0-2136" id="h7-0-2136" class="d">-			(&#39;o&#39;, &#39;stdout&#39;, None, &#39;print change list to standard output&#39;),
</a><a href="#h7-0-2137" id="h7-0-2137" class="d">-			(&#39;p&#39;, &#39;pending&#39;, None, &#39;print pending summary to standard output&#39;),
</a><a href="#h7-0-2138" id="h7-0-2138" class="d">-		],
</a><a href="#h7-0-2139" id="h7-0-2139" class="d">-		&quot;[-d | -D] [-i] [-o] change# or FILE ...&quot;
</a><a href="#h7-0-2140" id="h7-0-2140" class="d">-	),
</a><a href="#h7-0-2141" id="h7-0-2141" class="d">-	&quot;^clpatch&quot;: (
</a><a href="#h7-0-2142" id="h7-0-2142" class="d">-		clpatch,
</a><a href="#h7-0-2143" id="h7-0-2143" class="d">-		[
</a><a href="#h7-0-2144" id="h7-0-2144" class="d">-			(&#39;&#39;, &#39;ignore_hgapplydiff_failure&#39;, None, &#39;create CL metadata even if hgapplydiff fails&#39;),
</a><a href="#h7-0-2145" id="h7-0-2145" class="d">-			(&#39;&#39;, &#39;no_incoming&#39;, None, &#39;disable check for incoming changes&#39;),
</a><a href="#h7-0-2146" id="h7-0-2146" class="d">-		],
</a><a href="#h7-0-2147" id="h7-0-2147" class="d">-		&quot;change#&quot;
</a><a href="#h7-0-2148" id="h7-0-2148" class="d">-	),
</a><a href="#h7-0-2149" id="h7-0-2149" class="d">-	# Would prefer to call this codereview-login, but then
</a><a href="#h7-0-2150" id="h7-0-2150" class="d">-	# hg help codereview prints the help for this command
</a><a href="#h7-0-2151" id="h7-0-2151" class="d">-	# instead of the help for the extension.
</a><a href="#h7-0-2152" id="h7-0-2152" class="d">-	&quot;code-login&quot;: (
</a><a href="#h7-0-2153" id="h7-0-2153" class="d">-		code_login,
</a><a href="#h7-0-2154" id="h7-0-2154" class="d">-		[],
</a><a href="#h7-0-2155" id="h7-0-2155" class="d">-		&quot;&quot;,
</a><a href="#h7-0-2156" id="h7-0-2156" class="d">-	),
</a><a href="#h7-0-2157" id="h7-0-2157" class="d">-	&quot;^download&quot;: (
</a><a href="#h7-0-2158" id="h7-0-2158" class="d">-		download,
</a><a href="#h7-0-2159" id="h7-0-2159" class="d">-		[],
</a><a href="#h7-0-2160" id="h7-0-2160" class="d">-		&quot;change#&quot;
</a><a href="#h7-0-2161" id="h7-0-2161" class="d">-	),
</a><a href="#h7-0-2162" id="h7-0-2162" class="d">-	&quot;^file&quot;: (
</a><a href="#h7-0-2163" id="h7-0-2163" class="d">-		file,
</a><a href="#h7-0-2164" id="h7-0-2164" class="d">-		[
</a><a href="#h7-0-2165" id="h7-0-2165" class="d">-			(&#39;d&#39;, &#39;delete&#39;, None, &#39;delete files from change list (but not repository)&#39;),
</a><a href="#h7-0-2166" id="h7-0-2166" class="d">-		],
</a><a href="#h7-0-2167" id="h7-0-2167" class="d">-		&quot;[-d] change# FILE ...&quot;
</a><a href="#h7-0-2168" id="h7-0-2168" class="d">-	),
</a><a href="#h7-0-2169" id="h7-0-2169" class="d">-	&quot;^gofmt&quot;: (
</a><a href="#h7-0-2170" id="h7-0-2170" class="d">-		gofmt,
</a><a href="#h7-0-2171" id="h7-0-2171" class="d">-		[
</a><a href="#h7-0-2172" id="h7-0-2172" class="d">-			(&#39;l&#39;, &#39;list&#39;, None, &#39;list files that would change, but do not edit them&#39;),
</a><a href="#h7-0-2173" id="h7-0-2173" class="d">-		],
</a><a href="#h7-0-2174" id="h7-0-2174" class="d">-		&quot;FILE ...&quot;
</a><a href="#h7-0-2175" id="h7-0-2175" class="d">-	),
</a><a href="#h7-0-2176" id="h7-0-2176" class="d">-	&quot;^pending|p&quot;: (
</a><a href="#h7-0-2177" id="h7-0-2177" class="d">-		pending,
</a><a href="#h7-0-2178" id="h7-0-2178" class="d">-		[
</a><a href="#h7-0-2179" id="h7-0-2179" class="d">-			(&#39;s&#39;, &#39;short&#39;, False, &#39;show short result form&#39;),
</a><a href="#h7-0-2180" id="h7-0-2180" class="d">-			(&#39;&#39;, &#39;quick&#39;, False, &#39;do not consult codereview server&#39;),
</a><a href="#h7-0-2181" id="h7-0-2181" class="d">-		],
</a><a href="#h7-0-2182" id="h7-0-2182" class="d">-		&quot;[FILE ...]&quot;
</a><a href="#h7-0-2183" id="h7-0-2183" class="d">-	),
</a><a href="#h7-0-2184" id="h7-0-2184" class="d">-	&quot;^ps&quot;: (
</a><a href="#h7-0-2185" id="h7-0-2185" class="d">-		ps,
</a><a href="#h7-0-2186" id="h7-0-2186" class="d">-		[],
</a><a href="#h7-0-2187" id="h7-0-2187" class="d">-		&quot;[FILE ...]&quot;
</a><a href="#h7-0-2188" id="h7-0-2188" class="d">-	),
</a><a href="#h7-0-2189" id="h7-0-2189" class="d">-	&quot;^pq&quot;: (
</a><a href="#h7-0-2190" id="h7-0-2190" class="d">-		pq,
</a><a href="#h7-0-2191" id="h7-0-2191" class="d">-		[],
</a><a href="#h7-0-2192" id="h7-0-2192" class="d">-		&quot;[FILE ...]&quot;
</a><a href="#h7-0-2193" id="h7-0-2193" class="d">-	),
</a><a href="#h7-0-2194" id="h7-0-2194" class="d">-	&quot;^mail&quot;: (
</a><a href="#h7-0-2195" id="h7-0-2195" class="d">-		mail,
</a><a href="#h7-0-2196" id="h7-0-2196" class="d">-		review_opts + [
</a><a href="#h7-0-2197" id="h7-0-2197" class="d">-		] + hg_commands.walkopts,
</a><a href="#h7-0-2198" id="h7-0-2198" class="d">-		&quot;[-r reviewer] [--cc cc] [change# | file ...]&quot;
</a><a href="#h7-0-2199" id="h7-0-2199" class="d">-	),
</a><a href="#h7-0-2200" id="h7-0-2200" class="d">-	&quot;^release-apply&quot;: (
</a><a href="#h7-0-2201" id="h7-0-2201" class="d">-		release_apply,
</a><a href="#h7-0-2202" id="h7-0-2202" class="d">-		[
</a><a href="#h7-0-2203" id="h7-0-2203" class="d">-			(&#39;&#39;, &#39;ignore_hgapplydiff_failure&#39;, None, &#39;create CL metadata even if hgapplydiff fails&#39;),
</a><a href="#h7-0-2204" id="h7-0-2204" class="d">-			(&#39;&#39;, &#39;no_incoming&#39;, None, &#39;disable check for incoming changes&#39;),
</a><a href="#h7-0-2205" id="h7-0-2205" class="d">-		],
</a><a href="#h7-0-2206" id="h7-0-2206" class="d">-		&quot;change#&quot;
</a><a href="#h7-0-2207" id="h7-0-2207" class="d">-	),
</a><a href="#h7-0-2208" id="h7-0-2208" class="d">-	# TODO: release-start, release-tag, weekly-tag
</a><a href="#h7-0-2209" id="h7-0-2209" class="d">-	&quot;^submit&quot;: (
</a><a href="#h7-0-2210" id="h7-0-2210" class="d">-		submit,
</a><a href="#h7-0-2211" id="h7-0-2211" class="d">-		review_opts + [
</a><a href="#h7-0-2212" id="h7-0-2212" class="d">-			(&#39;&#39;, &#39;no_incoming&#39;, None, &#39;disable initial incoming check (for testing)&#39;),
</a><a href="#h7-0-2213" id="h7-0-2213" class="d">-		] + hg_commands.walkopts + hg_commands.commitopts + hg_commands.commitopts2,
</a><a href="#h7-0-2214" id="h7-0-2214" class="d">-		&quot;[-r reviewer] [--cc cc] [change# | file ...]&quot;
</a><a href="#h7-0-2215" id="h7-0-2215" class="d">-	),
</a><a href="#h7-0-2216" id="h7-0-2216" class="d">-	&quot;^sync&quot;: (
</a><a href="#h7-0-2217" id="h7-0-2217" class="d">-		sync,
</a><a href="#h7-0-2218" id="h7-0-2218" class="d">-		[
</a><a href="#h7-0-2219" id="h7-0-2219" class="d">-			(&#39;&#39;, &#39;local&#39;, None, &#39;do not pull changes from remote repository&#39;)
</a><a href="#h7-0-2220" id="h7-0-2220" class="d">-		],
</a><a href="#h7-0-2221" id="h7-0-2221" class="d">-		&quot;[--local]&quot;,
</a><a href="#h7-0-2222" id="h7-0-2222" class="d">-	),
</a><a href="#h7-0-2223" id="h7-0-2223" class="d">-	&quot;^undo&quot;: (
</a><a href="#h7-0-2224" id="h7-0-2224" class="d">-		undo,
</a><a href="#h7-0-2225" id="h7-0-2225" class="d">-		[
</a><a href="#h7-0-2226" id="h7-0-2226" class="d">-			(&#39;&#39;, &#39;ignore_hgapplydiff_failure&#39;, None, &#39;create CL metadata even if hgapplydiff fails&#39;),
</a><a href="#h7-0-2227" id="h7-0-2227" class="d">-			(&#39;&#39;, &#39;no_incoming&#39;, None, &#39;disable check for incoming changes&#39;),
</a><a href="#h7-0-2228" id="h7-0-2228" class="d">-		],
</a><a href="#h7-0-2229" id="h7-0-2229" class="d">-		&quot;change#&quot;
</a><a href="#h7-0-2230" id="h7-0-2230" class="d">-	),
</a><a href="#h7-0-2231" id="h7-0-2231" class="d">-	&quot;^upload&quot;: (
</a><a href="#h7-0-2232" id="h7-0-2232" class="d">-		upload,
</a><a href="#h7-0-2233" id="h7-0-2233" class="d">-		[],
</a><a href="#h7-0-2234" id="h7-0-2234" class="d">-		&quot;change#&quot;
</a><a href="#h7-0-2235" id="h7-0-2235" class="d">-	),
</a><a href="#h7-0-2236" id="h7-0-2236" class="d">-}
</a><a href="#h7-0-2237" id="h7-0-2237" class="d">-
</a><a href="#h7-0-2238" id="h7-0-2238" class="d">-#######################################################################
</a><a href="#h7-0-2239" id="h7-0-2239" class="d">-# Mercurial extension initialization
</a><a href="#h7-0-2240" id="h7-0-2240" class="d">-
</a><a href="#h7-0-2241" id="h7-0-2241" class="d">-def norollback(*pats, **opts):
</a><a href="#h7-0-2242" id="h7-0-2242" class="d">-	&quot;&quot;&quot;(disabled when using this extension)&quot;&quot;&quot;
</a><a href="#h7-0-2243" id="h7-0-2243" class="d">-	raise hg_util.Abort(&quot;codereview extension enabled; use undo instead of rollback&quot;)
</a><a href="#h7-0-2244" id="h7-0-2244" class="d">-
</a><a href="#h7-0-2245" id="h7-0-2245" class="d">-codereview_init = False
</a><a href="#h7-0-2246" id="h7-0-2246" class="d">-
</a><a href="#h7-0-2247" id="h7-0-2247" class="d">-def reposetup(ui, repo):
</a><a href="#h7-0-2248" id="h7-0-2248" class="d">-	global codereview_disabled
</a><a href="#h7-0-2249" id="h7-0-2249" class="d">-	global defaultcc
</a><a href="#h7-0-2250" id="h7-0-2250" class="d">-	
</a><a href="#h7-0-2251" id="h7-0-2251" class="d">-	# reposetup gets called both for the local repository
</a><a href="#h7-0-2252" id="h7-0-2252" class="d">-	# and also for any repository we are pulling or pushing to.
</a><a href="#h7-0-2253" id="h7-0-2253" class="d">-	# Only initialize the first time.
</a><a href="#h7-0-2254" id="h7-0-2254" class="d">-	global codereview_init
</a><a href="#h7-0-2255" id="h7-0-2255" class="d">-	if codereview_init:
</a><a href="#h7-0-2256" id="h7-0-2256" class="d">-		return
</a><a href="#h7-0-2257" id="h7-0-2257" class="d">-	codereview_init = True
</a><a href="#h7-0-2258" id="h7-0-2258" class="d">-	start_status_thread()
</a><a href="#h7-0-2259" id="h7-0-2259" class="d">-
</a><a href="#h7-0-2260" id="h7-0-2260" class="d">-	# Read repository-specific options from lib/codereview/codereview.cfg or codereview.cfg.
</a><a href="#h7-0-2261" id="h7-0-2261" class="d">-	root = &#39;&#39;
</a><a href="#h7-0-2262" id="h7-0-2262" class="d">-	try:
</a><a href="#h7-0-2263" id="h7-0-2263" class="d">-		root = repo.root
</a><a href="#h7-0-2264" id="h7-0-2264" class="d">-	except:
</a><a href="#h7-0-2265" id="h7-0-2265" class="d">-		# Yes, repo might not have root; see issue 959.
</a><a href="#h7-0-2266" id="h7-0-2266" class="d">-		codereview_disabled = &#39;codereview disabled: repository has no root&#39;
</a><a href="#h7-0-2267" id="h7-0-2267" class="d">-		return
</a><a href="#h7-0-2268" id="h7-0-2268" class="d">-	
</a><a href="#h7-0-2269" id="h7-0-2269" class="d">-	repo_config_path = &#39;&#39;
</a><a href="#h7-0-2270" id="h7-0-2270" class="d">-	p1 = root + &#39;/lib/codereview/codereview.cfg&#39;
</a><a href="#h7-0-2271" id="h7-0-2271" class="d">-	p2 = root + &#39;/codereview.cfg&#39;
</a><a href="#h7-0-2272" id="h7-0-2272" class="d">-	if os.access(p1, os.F_OK):
</a><a href="#h7-0-2273" id="h7-0-2273" class="d">-		repo_config_path = p1
</a><a href="#h7-0-2274" id="h7-0-2274" class="d">-	else:
</a><a href="#h7-0-2275" id="h7-0-2275" class="d">-		repo_config_path = p2
</a><a href="#h7-0-2276" id="h7-0-2276" class="d">-	try:
</a><a href="#h7-0-2277" id="h7-0-2277" class="d">-		f = open(repo_config_path)
</a><a href="#h7-0-2278" id="h7-0-2278" class="d">-		for line in f:
</a><a href="#h7-0-2279" id="h7-0-2279" class="d">-			if line.startswith(&#39;defaultcc:&#39;):
</a><a href="#h7-0-2280" id="h7-0-2280" class="d">-				defaultcc = SplitCommaSpace(line[len(&#39;defaultcc:&#39;):])
</a><a href="#h7-0-2281" id="h7-0-2281" class="d">-			if line.startswith(&#39;contributors:&#39;):
</a><a href="#h7-0-2282" id="h7-0-2282" class="d">-				global contributorsURL
</a><a href="#h7-0-2283" id="h7-0-2283" class="d">-				contributorsURL = line[len(&#39;contributors:&#39;):].strip()
</a><a href="#h7-0-2284" id="h7-0-2284" class="d">-	except:
</a><a href="#h7-0-2285" id="h7-0-2285" class="d">-		codereview_disabled = &#39;codereview disabled: cannot open &#39; + repo_config_path
</a><a href="#h7-0-2286" id="h7-0-2286" class="d">-		return
</a><a href="#h7-0-2287" id="h7-0-2287" class="d">-
</a><a href="#h7-0-2288" id="h7-0-2288" class="d">-	remote = ui.config(&quot;paths&quot;, &quot;default&quot;, &quot;&quot;)
</a><a href="#h7-0-2289" id="h7-0-2289" class="d">-	if remote.find(&quot;://&quot;) &lt; 0:
</a><a href="#h7-0-2290" id="h7-0-2290" class="d">-		raise hg_util.Abort(&quot;codereview: default path &#39;%s&#39; is not a URL&quot; % (remote,))
</a><a href="#h7-0-2291" id="h7-0-2291" class="d">-
</a><a href="#h7-0-2292" id="h7-0-2292" class="d">-	InstallMatch(ui, repo)
</a><a href="#h7-0-2293" id="h7-0-2293" class="d">-	RietveldSetup(ui, repo)
</a><a href="#h7-0-2294" id="h7-0-2294" class="d">-
</a><a href="#h7-0-2295" id="h7-0-2295" class="d">-	# Disable the Mercurial commands that might change the repository.
</a><a href="#h7-0-2296" id="h7-0-2296" class="d">-	# Only commands in this extension are supposed to do that.
</a><a href="#h7-0-2297" id="h7-0-2297" class="d">-	ui.setconfig(&quot;hooks&quot;, &quot;precommit.codereview&quot;, precommithook)
</a><a href="#h7-0-2298" id="h7-0-2298" class="d">-
</a><a href="#h7-0-2299" id="h7-0-2299" class="d">-	# Rollback removes an existing commit.  Don&#39;t do that either.
</a><a href="#h7-0-2300" id="h7-0-2300" class="d">-	global real_rollback
</a><a href="#h7-0-2301" id="h7-0-2301" class="d">-	real_rollback = repo.rollback
</a><a href="#h7-0-2302" id="h7-0-2302" class="d">-	repo.rollback = norollback
</a><a href="#h7-0-2303" id="h7-0-2303" class="d">-	
</a><a href="#h7-0-2304" id="h7-0-2304" class="d">-
</a><a href="#h7-0-2305" id="h7-0-2305" class="d">-#######################################################################
</a><a href="#h7-0-2306" id="h7-0-2306" class="d">-# Wrappers around upload.py for interacting with Rietveld
</a><a href="#h7-0-2307" id="h7-0-2307" class="d">-
</a><a href="#h7-0-2308" id="h7-0-2308" class="d">-from HTMLParser import HTMLParser
</a><a href="#h7-0-2309" id="h7-0-2309" class="d">-
</a><a href="#h7-0-2310" id="h7-0-2310" class="d">-# HTML form parser
</a><a href="#h7-0-2311" id="h7-0-2311" class="d">-class FormParser(HTMLParser):
</a><a href="#h7-0-2312" id="h7-0-2312" class="d">-	def __init__(self):
</a><a href="#h7-0-2313" id="h7-0-2313" class="d">-		self.map = {}
</a><a href="#h7-0-2314" id="h7-0-2314" class="d">-		self.curtag = None
</a><a href="#h7-0-2315" id="h7-0-2315" class="d">-		self.curdata = None
</a><a href="#h7-0-2316" id="h7-0-2316" class="d">-		HTMLParser.__init__(self)
</a><a href="#h7-0-2317" id="h7-0-2317" class="d">-	def handle_starttag(self, tag, attrs):
</a><a href="#h7-0-2318" id="h7-0-2318" class="d">-		if tag == &quot;input&quot;:
</a><a href="#h7-0-2319" id="h7-0-2319" class="d">-			key = None
</a><a href="#h7-0-2320" id="h7-0-2320" class="d">-			value = &#39;&#39;
</a><a href="#h7-0-2321" id="h7-0-2321" class="d">-			for a in attrs:
</a><a href="#h7-0-2322" id="h7-0-2322" class="d">-				if a[0] == &#39;name&#39;:
</a><a href="#h7-0-2323" id="h7-0-2323" class="d">-					key = a[1]
</a><a href="#h7-0-2324" id="h7-0-2324" class="d">-				if a[0] == &#39;value&#39;:
</a><a href="#h7-0-2325" id="h7-0-2325" class="d">-					value = a[1]
</a><a href="#h7-0-2326" id="h7-0-2326" class="d">-			if key is not None:
</a><a href="#h7-0-2327" id="h7-0-2327" class="d">-				self.map[key] = value
</a><a href="#h7-0-2328" id="h7-0-2328" class="d">-		if tag == &quot;textarea&quot;:
</a><a href="#h7-0-2329" id="h7-0-2329" class="d">-			key = None
</a><a href="#h7-0-2330" id="h7-0-2330" class="d">-			for a in attrs:
</a><a href="#h7-0-2331" id="h7-0-2331" class="d">-				if a[0] == &#39;name&#39;:
</a><a href="#h7-0-2332" id="h7-0-2332" class="d">-					key = a[1]
</a><a href="#h7-0-2333" id="h7-0-2333" class="d">-			if key is not None:
</a><a href="#h7-0-2334" id="h7-0-2334" class="d">-				self.curtag = key
</a><a href="#h7-0-2335" id="h7-0-2335" class="d">-				self.curdata = &#39;&#39;
</a><a href="#h7-0-2336" id="h7-0-2336" class="d">-	def handle_endtag(self, tag):
</a><a href="#h7-0-2337" id="h7-0-2337" class="d">-		if tag == &quot;textarea&quot; and self.curtag is not None:
</a><a href="#h7-0-2338" id="h7-0-2338" class="d">-			self.map[self.curtag] = self.curdata
</a><a href="#h7-0-2339" id="h7-0-2339" class="d">-			self.curtag = None
</a><a href="#h7-0-2340" id="h7-0-2340" class="d">-			self.curdata = None
</a><a href="#h7-0-2341" id="h7-0-2341" class="d">-	def handle_charref(self, name):
</a><a href="#h7-0-2342" id="h7-0-2342" class="d">-		self.handle_data(unichr(int(name)))
</a><a href="#h7-0-2343" id="h7-0-2343" class="d">-	def handle_entityref(self, name):
</a><a href="#h7-0-2344" id="h7-0-2344" class="d">-		import htmlentitydefs
</a><a href="#h7-0-2345" id="h7-0-2345" class="d">-		if name in htmlentitydefs.entitydefs:
</a><a href="#h7-0-2346" id="h7-0-2346" class="d">-			self.handle_data(htmlentitydefs.entitydefs[name])
</a><a href="#h7-0-2347" id="h7-0-2347" class="d">-		else:
</a><a href="#h7-0-2348" id="h7-0-2348" class="d">-			self.handle_data(&quot;&amp;&quot; + name + &quot;;&quot;)
</a><a href="#h7-0-2349" id="h7-0-2349" class="d">-	def handle_data(self, data):
</a><a href="#h7-0-2350" id="h7-0-2350" class="d">-		if self.curdata is not None:
</a><a href="#h7-0-2351" id="h7-0-2351" class="d">-			self.curdata += data
</a><a href="#h7-0-2352" id="h7-0-2352" class="d">-
</a><a href="#h7-0-2353" id="h7-0-2353" class="d">-def JSONGet(ui, path):
</a><a href="#h7-0-2354" id="h7-0-2354" class="d">-	try:
</a><a href="#h7-0-2355" id="h7-0-2355" class="d">-		data = MySend(path, force_auth=False)
</a><a href="#h7-0-2356" id="h7-0-2356" class="d">-		typecheck(data, str)
</a><a href="#h7-0-2357" id="h7-0-2357" class="d">-		d = fix_json(json.loads(data))
</a><a href="#h7-0-2358" id="h7-0-2358" class="d">-	except:
</a><a href="#h7-0-2359" id="h7-0-2359" class="d">-		ui.warn(&quot;JSONGet %s: %s\n&quot; % (path, ExceptionDetail()))
</a><a href="#h7-0-2360" id="h7-0-2360" class="d">-		return None
</a><a href="#h7-0-2361" id="h7-0-2361" class="d">-	return d
</a><a href="#h7-0-2362" id="h7-0-2362" class="d">-
</a><a href="#h7-0-2363" id="h7-0-2363" class="d">-# Clean up json parser output to match our expectations:
</a><a href="#h7-0-2364" id="h7-0-2364" class="d">-#   * all strings are UTF-8-encoded str, not unicode.
</a><a href="#h7-0-2365" id="h7-0-2365" class="d">-#   * missing fields are missing, not None,
</a><a href="#h7-0-2366" id="h7-0-2366" class="d">-#     so that d.get(&quot;foo&quot;, defaultvalue) works.
</a><a href="#h7-0-2367" id="h7-0-2367" class="d">-def fix_json(x):
</a><a href="#h7-0-2368" id="h7-0-2368" class="d">-	if type(x) in [str, int, float, bool, type(None)]:
</a><a href="#h7-0-2369" id="h7-0-2369" class="d">-		pass
</a><a href="#h7-0-2370" id="h7-0-2370" class="d">-	elif type(x) is unicode:
</a><a href="#h7-0-2371" id="h7-0-2371" class="d">-		x = x.encode(&quot;utf-8&quot;)
</a><a href="#h7-0-2372" id="h7-0-2372" class="d">-	elif type(x) is list:
</a><a href="#h7-0-2373" id="h7-0-2373" class="d">-		for i in range(len(x)):
</a><a href="#h7-0-2374" id="h7-0-2374" class="d">-			x[i] = fix_json(x[i])
</a><a href="#h7-0-2375" id="h7-0-2375" class="d">-	elif type(x) is dict:
</a><a href="#h7-0-2376" id="h7-0-2376" class="d">-		todel = []
</a><a href="#h7-0-2377" id="h7-0-2377" class="d">-		for k in x:
</a><a href="#h7-0-2378" id="h7-0-2378" class="d">-			if x[k] is None:
</a><a href="#h7-0-2379" id="h7-0-2379" class="d">-				todel.append(k)
</a><a href="#h7-0-2380" id="h7-0-2380" class="d">-			else:
</a><a href="#h7-0-2381" id="h7-0-2381" class="d">-				x[k] = fix_json(x[k])
</a><a href="#h7-0-2382" id="h7-0-2382" class="d">-		for k in todel:
</a><a href="#h7-0-2383" id="h7-0-2383" class="d">-			del x[k]
</a><a href="#h7-0-2384" id="h7-0-2384" class="d">-	else:
</a><a href="#h7-0-2385" id="h7-0-2385" class="d">-		raise hg_util.Abort(&quot;unknown type &quot; + str(type(x)) + &quot; in fix_json&quot;)
</a><a href="#h7-0-2386" id="h7-0-2386" class="d">-	if type(x) is str:
</a><a href="#h7-0-2387" id="h7-0-2387" class="d">-		x = x.replace(&#39;\r\n&#39;, &#39;\n&#39;)
</a><a href="#h7-0-2388" id="h7-0-2388" class="d">-	return x
</a><a href="#h7-0-2389" id="h7-0-2389" class="d">-
</a><a href="#h7-0-2390" id="h7-0-2390" class="d">-def IsRietveldSubmitted(ui, clname, hex):
</a><a href="#h7-0-2391" id="h7-0-2391" class="d">-	dict = JSONGet(ui, &quot;/api/&quot; + clname + &quot;?messages=true&quot;)
</a><a href="#h7-0-2392" id="h7-0-2392" class="d">-	if dict is None:
</a><a href="#h7-0-2393" id="h7-0-2393" class="d">-		return False
</a><a href="#h7-0-2394" id="h7-0-2394" class="d">-	for msg in dict.get(&quot;messages&quot;, []):
</a><a href="#h7-0-2395" id="h7-0-2395" class="d">-		text = msg.get(&quot;text&quot;, &quot;&quot;)
</a><a href="#h7-0-2396" id="h7-0-2396" class="d">-		m = re.match(&#39;\*\*\* Submitted as [^*]*?([0-9a-f]+) \*\*\*&#39;, text)
</a><a href="#h7-0-2397" id="h7-0-2397" class="d">-		if m is not None and len(m.group(1)) &gt;= 8 and hex.startswith(m.group(1)):
</a><a href="#h7-0-2398" id="h7-0-2398" class="d">-			return True
</a><a href="#h7-0-2399" id="h7-0-2399" class="d">-	return False
</a><a href="#h7-0-2400" id="h7-0-2400" class="d">-
</a><a href="#h7-0-2401" id="h7-0-2401" class="d">-def IsRietveldMailed(cl):
</a><a href="#h7-0-2402" id="h7-0-2402" class="d">-	for msg in cl.dict.get(&quot;messages&quot;, []):
</a><a href="#h7-0-2403" id="h7-0-2403" class="d">-		if msg.get(&quot;text&quot;, &quot;&quot;).find(&quot;I&#39;d like you to review this change&quot;) &gt;= 0:
</a><a href="#h7-0-2404" id="h7-0-2404" class="d">-			return True
</a><a href="#h7-0-2405" id="h7-0-2405" class="d">-	return False
</a><a href="#h7-0-2406" id="h7-0-2406" class="d">-
</a><a href="#h7-0-2407" id="h7-0-2407" class="d">-def DownloadCL(ui, repo, clname):
</a><a href="#h7-0-2408" id="h7-0-2408" class="d">-	set_status(&quot;downloading CL &quot; + clname)
</a><a href="#h7-0-2409" id="h7-0-2409" class="d">-	cl, err = LoadCL(ui, repo, clname, web=True)
</a><a href="#h7-0-2410" id="h7-0-2410" class="d">-	if err != &quot;&quot;:
</a><a href="#h7-0-2411" id="h7-0-2411" class="d">-		return None, None, None, &quot;error loading CL %s: %s&quot; % (clname, err)
</a><a href="#h7-0-2412" id="h7-0-2412" class="d">-
</a><a href="#h7-0-2413" id="h7-0-2413" class="d">-	# Find most recent diff
</a><a href="#h7-0-2414" id="h7-0-2414" class="d">-	diffs = cl.dict.get(&quot;patchsets&quot;, [])
</a><a href="#h7-0-2415" id="h7-0-2415" class="d">-	if not diffs:
</a><a href="#h7-0-2416" id="h7-0-2416" class="d">-		return None, None, None, &quot;CL has no patch sets&quot;
</a><a href="#h7-0-2417" id="h7-0-2417" class="d">-	patchid = diffs[-1]
</a><a href="#h7-0-2418" id="h7-0-2418" class="d">-
</a><a href="#h7-0-2419" id="h7-0-2419" class="d">-	patchset = JSONGet(ui, &quot;/api/&quot; + clname + &quot;/&quot; + str(patchid))
</a><a href="#h7-0-2420" id="h7-0-2420" class="d">-	if patchset is None:
</a><a href="#h7-0-2421" id="h7-0-2421" class="d">-		return None, None, None, &quot;error loading CL patchset %s/%d&quot; % (clname, patchid)
</a><a href="#h7-0-2422" id="h7-0-2422" class="d">-	if patchset.get(&quot;patchset&quot;, 0) != patchid:
</a><a href="#h7-0-2423" id="h7-0-2423" class="d">-		return None, None, None, &quot;malformed patchset information&quot;
</a><a href="#h7-0-2424" id="h7-0-2424" class="d">-	
</a><a href="#h7-0-2425" id="h7-0-2425" class="d">-	vers = &quot;&quot;
</a><a href="#h7-0-2426" id="h7-0-2426" class="d">-	msg = patchset.get(&quot;message&quot;, &quot;&quot;).split()
</a><a href="#h7-0-2427" id="h7-0-2427" class="d">-	if len(msg) &gt;= 3 and msg[0] == &quot;diff&quot; and msg[1] == &quot;-r&quot;:
</a><a href="#h7-0-2428" id="h7-0-2428" class="d">-		vers = msg[2]
</a><a href="#h7-0-2429" id="h7-0-2429" class="d">-	diff = &quot;/download/issue&quot; + clname + &quot;_&quot; + str(patchid) + &quot;.diff&quot;
</a><a href="#h7-0-2430" id="h7-0-2430" class="d">-
</a><a href="#h7-0-2431" id="h7-0-2431" class="d">-	diffdata = MySend(diff, force_auth=False)
</a><a href="#h7-0-2432" id="h7-0-2432" class="d">-	
</a><a href="#h7-0-2433" id="h7-0-2433" class="d">-	# Print warning if email is not in CONTRIBUTORS file.
</a><a href="#h7-0-2434" id="h7-0-2434" class="d">-	email = cl.dict.get(&quot;owner_email&quot;, &quot;&quot;)
</a><a href="#h7-0-2435" id="h7-0-2435" class="d">-	if not email:
</a><a href="#h7-0-2436" id="h7-0-2436" class="d">-		return None, None, None, &quot;cannot find owner for %s&quot; % (clname)
</a><a href="#h7-0-2437" id="h7-0-2437" class="d">-	him = FindContributor(ui, repo, email)
</a><a href="#h7-0-2438" id="h7-0-2438" class="d">-	me = FindContributor(ui, repo, None)
</a><a href="#h7-0-2439" id="h7-0-2439" class="d">-	if him == me:
</a><a href="#h7-0-2440" id="h7-0-2440" class="d">-		cl.mailed = IsRietveldMailed(cl)
</a><a href="#h7-0-2441" id="h7-0-2441" class="d">-	else:
</a><a href="#h7-0-2442" id="h7-0-2442" class="d">-		cl.copied_from = email
</a><a href="#h7-0-2443" id="h7-0-2443" class="d">-
</a><a href="#h7-0-2444" id="h7-0-2444" class="d">-	return cl, vers, diffdata, &quot;&quot;
</a><a href="#h7-0-2445" id="h7-0-2445" class="d">-
</a><a href="#h7-0-2446" id="h7-0-2446" class="d">-def MySend(request_path, payload=None,
</a><a href="#h7-0-2447" id="h7-0-2447" class="d">-		content_type=&quot;application/octet-stream&quot;,
</a><a href="#h7-0-2448" id="h7-0-2448" class="d">-		timeout=None, force_auth=True,
</a><a href="#h7-0-2449" id="h7-0-2449" class="d">-		**kwargs):
</a><a href="#h7-0-2450" id="h7-0-2450" class="d">-	&quot;&quot;&quot;Run MySend1 maybe twice, because Rietveld is unreliable.&quot;&quot;&quot;
</a><a href="#h7-0-2451" id="h7-0-2451" class="d">-	try:
</a><a href="#h7-0-2452" id="h7-0-2452" class="d">-		return MySend1(request_path, payload, content_type, timeout, force_auth, **kwargs)
</a><a href="#h7-0-2453" id="h7-0-2453" class="d">-	except Exception, e:
</a><a href="#h7-0-2454" id="h7-0-2454" class="d">-		if type(e) != urllib2.HTTPError or e.code != 500:	# only retry on HTTP 500 error
</a><a href="#h7-0-2455" id="h7-0-2455" class="d">-			raise
</a><a href="#h7-0-2456" id="h7-0-2456" class="d">-		print &gt;&gt;sys.stderr, &quot;Loading &quot;+request_path+&quot;: &quot;+ExceptionDetail()+&quot;; trying again in 2 seconds.&quot;
</a><a href="#h7-0-2457" id="h7-0-2457" class="d">-		time.sleep(2)
</a><a href="#h7-0-2458" id="h7-0-2458" class="d">-		return MySend1(request_path, payload, content_type, timeout, force_auth, **kwargs)
</a><a href="#h7-0-2459" id="h7-0-2459" class="d">-
</a><a href="#h7-0-2460" id="h7-0-2460" class="d">-# Like upload.py Send but only authenticates when the
</a><a href="#h7-0-2461" id="h7-0-2461" class="d">-# redirect is to www.google.com/accounts.  This keeps
</a><a href="#h7-0-2462" id="h7-0-2462" class="d">-# unnecessary redirects from happening during testing.
</a><a href="#h7-0-2463" id="h7-0-2463" class="d">-def MySend1(request_path, payload=None,
</a><a href="#h7-0-2464" id="h7-0-2464" class="d">-				content_type=&quot;application/octet-stream&quot;,
</a><a href="#h7-0-2465" id="h7-0-2465" class="d">-				timeout=None, force_auth=True,
</a><a href="#h7-0-2466" id="h7-0-2466" class="d">-				**kwargs):
</a><a href="#h7-0-2467" id="h7-0-2467" class="d">-	&quot;&quot;&quot;Sends an RPC and returns the response.
</a><a href="#h7-0-2468" id="h7-0-2468" class="d">-
</a><a href="#h7-0-2469" id="h7-0-2469" class="d">-	Args:
</a><a href="#h7-0-2470" id="h7-0-2470" class="d">-		request_path: The path to send the request to, eg /api/appversion/create.
</a><a href="#h7-0-2471" id="h7-0-2471" class="d">-		payload: The body of the request, or None to send an empty request.
</a><a href="#h7-0-2472" id="h7-0-2472" class="d">-		content_type: The Content-Type header to use.
</a><a href="#h7-0-2473" id="h7-0-2473" class="d">-		timeout: timeout in seconds; default None i.e. no timeout.
</a><a href="#h7-0-2474" id="h7-0-2474" class="d">-			(Note: for large requests on OS X, the timeout doesn&#39;t work right.)
</a><a href="#h7-0-2475" id="h7-0-2475" class="d">-		kwargs: Any keyword arguments are converted into query string parameters.
</a><a href="#h7-0-2476" id="h7-0-2476" class="d">-
</a><a href="#h7-0-2477" id="h7-0-2477" class="d">-	Returns:
</a><a href="#h7-0-2478" id="h7-0-2478" class="d">-		The response body, as a string.
</a><a href="#h7-0-2479" id="h7-0-2479" class="d">-	&quot;&quot;&quot;
</a><a href="#h7-0-2480" id="h7-0-2480" class="d">-	# TODO: Don&#39;t require authentication.  Let the server say
</a><a href="#h7-0-2481" id="h7-0-2481" class="d">-	# whether it is necessary.
</a><a href="#h7-0-2482" id="h7-0-2482" class="d">-	global rpc
</a><a href="#h7-0-2483" id="h7-0-2483" class="d">-	if rpc == None:
</a><a href="#h7-0-2484" id="h7-0-2484" class="d">-		rpc = GetRpcServer(upload_options)
</a><a href="#h7-0-2485" id="h7-0-2485" class="d">-	self = rpc
</a><a href="#h7-0-2486" id="h7-0-2486" class="d">-	if not self.authenticated and force_auth:
</a><a href="#h7-0-2487" id="h7-0-2487" class="d">-		self._Authenticate()
</a><a href="#h7-0-2488" id="h7-0-2488" class="d">-	if request_path is None:
</a><a href="#h7-0-2489" id="h7-0-2489" class="d">-		return
</a><a href="#h7-0-2490" id="h7-0-2490" class="d">-	if timeout is None:
</a><a href="#h7-0-2491" id="h7-0-2491" class="d">-		timeout = 30 # seconds
</a><a href="#h7-0-2492" id="h7-0-2492" class="d">-
</a><a href="#h7-0-2493" id="h7-0-2493" class="d">-	old_timeout = socket.getdefaulttimeout()
</a><a href="#h7-0-2494" id="h7-0-2494" class="d">-	socket.setdefaulttimeout(timeout)
</a><a href="#h7-0-2495" id="h7-0-2495" class="d">-	try:
</a><a href="#h7-0-2496" id="h7-0-2496" class="d">-		tries = 0
</a><a href="#h7-0-2497" id="h7-0-2497" class="d">-		while True:
</a><a href="#h7-0-2498" id="h7-0-2498" class="d">-			tries += 1
</a><a href="#h7-0-2499" id="h7-0-2499" class="d">-			args = dict(kwargs)
</a><a href="#h7-0-2500" id="h7-0-2500" class="d">-			url = &quot;https://%s%s&quot; % (self.host, request_path)
</a><a href="#h7-0-2501" id="h7-0-2501" class="d">-			if args:
</a><a href="#h7-0-2502" id="h7-0-2502" class="d">-				url += &quot;?&quot; + urllib.urlencode(args)
</a><a href="#h7-0-2503" id="h7-0-2503" class="d">-			req = self._CreateRequest(url=url, data=payload)
</a><a href="#h7-0-2504" id="h7-0-2504" class="d">-			req.add_header(&quot;Content-Type&quot;, content_type)
</a><a href="#h7-0-2505" id="h7-0-2505" class="d">-			try:
</a><a href="#h7-0-2506" id="h7-0-2506" class="d">-				f = self.opener.open(req)
</a><a href="#h7-0-2507" id="h7-0-2507" class="d">-				response = f.read()
</a><a href="#h7-0-2508" id="h7-0-2508" class="d">-				f.close()
</a><a href="#h7-0-2509" id="h7-0-2509" class="d">-				# Translate \r\n into \n, because Rietveld doesn&#39;t.
</a><a href="#h7-0-2510" id="h7-0-2510" class="d">-				response = response.replace(&#39;\r\n&#39;, &#39;\n&#39;)
</a><a href="#h7-0-2511" id="h7-0-2511" class="d">-				# who knows what urllib will give us
</a><a href="#h7-0-2512" id="h7-0-2512" class="d">-				if type(response) == unicode:
</a><a href="#h7-0-2513" id="h7-0-2513" class="d">-					response = response.encode(&quot;utf-8&quot;)
</a><a href="#h7-0-2514" id="h7-0-2514" class="d">-				typecheck(response, str)
</a><a href="#h7-0-2515" id="h7-0-2515" class="d">-				return response
</a><a href="#h7-0-2516" id="h7-0-2516" class="d">-			except urllib2.HTTPError, e:
</a><a href="#h7-0-2517" id="h7-0-2517" class="d">-				if tries &gt; 3:
</a><a href="#h7-0-2518" id="h7-0-2518" class="d">-					raise
</a><a href="#h7-0-2519" id="h7-0-2519" class="d">-				elif e.code == 401:
</a><a href="#h7-0-2520" id="h7-0-2520" class="d">-					self._Authenticate()
</a><a href="#h7-0-2521" id="h7-0-2521" class="d">-				elif e.code == 302:
</a><a href="#h7-0-2522" id="h7-0-2522" class="d">-					loc = e.info()[&quot;location&quot;]
</a><a href="#h7-0-2523" id="h7-0-2523" class="d">-					if not loc.startswith(&#39;https://www.google.com/a&#39;) or loc.find(&#39;/ServiceLogin&#39;) &lt; 0:
</a><a href="#h7-0-2524" id="h7-0-2524" class="d">-						return &#39;&#39;
</a><a href="#h7-0-2525" id="h7-0-2525" class="d">-					self._Authenticate()
</a><a href="#h7-0-2526" id="h7-0-2526" class="d">-				else:
</a><a href="#h7-0-2527" id="h7-0-2527" class="d">-					raise
</a><a href="#h7-0-2528" id="h7-0-2528" class="d">-	finally:
</a><a href="#h7-0-2529" id="h7-0-2529" class="d">-		socket.setdefaulttimeout(old_timeout)
</a><a href="#h7-0-2530" id="h7-0-2530" class="d">-
</a><a href="#h7-0-2531" id="h7-0-2531" class="d">-def GetForm(url):
</a><a href="#h7-0-2532" id="h7-0-2532" class="d">-	f = FormParser()
</a><a href="#h7-0-2533" id="h7-0-2533" class="d">-	f.feed(ustr(MySend(url)))	# f.feed wants unicode
</a><a href="#h7-0-2534" id="h7-0-2534" class="d">-	f.close()
</a><a href="#h7-0-2535" id="h7-0-2535" class="d">-	# convert back to utf-8 to restore sanity
</a><a href="#h7-0-2536" id="h7-0-2536" class="d">-	m = {}
</a><a href="#h7-0-2537" id="h7-0-2537" class="d">-	for k,v in f.map.items():
</a><a href="#h7-0-2538" id="h7-0-2538" class="d">-		m[k.encode(&quot;utf-8&quot;)] = v.replace(&quot;\r\n&quot;, &quot;\n&quot;).encode(&quot;utf-8&quot;)
</a><a href="#h7-0-2539" id="h7-0-2539" class="d">-	return m
</a><a href="#h7-0-2540" id="h7-0-2540" class="d">-
</a><a href="#h7-0-2541" id="h7-0-2541" class="d">-def EditDesc(issue, subject=None, desc=None, reviewers=None, cc=None, closed=False, private=False):
</a><a href="#h7-0-2542" id="h7-0-2542" class="d">-	set_status(&quot;uploading change to description&quot;)
</a><a href="#h7-0-2543" id="h7-0-2543" class="d">-	form_fields = GetForm(&quot;/&quot; + issue + &quot;/edit&quot;)
</a><a href="#h7-0-2544" id="h7-0-2544" class="d">-	if subject is not None:
</a><a href="#h7-0-2545" id="h7-0-2545" class="d">-		form_fields[&#39;subject&#39;] = subject
</a><a href="#h7-0-2546" id="h7-0-2546" class="d">-	if desc is not None:
</a><a href="#h7-0-2547" id="h7-0-2547" class="d">-		form_fields[&#39;description&#39;] = desc
</a><a href="#h7-0-2548" id="h7-0-2548" class="d">-	if reviewers is not None:
</a><a href="#h7-0-2549" id="h7-0-2549" class="d">-		form_fields[&#39;reviewers&#39;] = reviewers
</a><a href="#h7-0-2550" id="h7-0-2550" class="d">-	if cc is not None:
</a><a href="#h7-0-2551" id="h7-0-2551" class="d">-		form_fields[&#39;cc&#39;] = cc
</a><a href="#h7-0-2552" id="h7-0-2552" class="d">-	if closed:
</a><a href="#h7-0-2553" id="h7-0-2553" class="d">-		form_fields[&#39;closed&#39;] = &quot;checked&quot;
</a><a href="#h7-0-2554" id="h7-0-2554" class="d">-	if private:
</a><a href="#h7-0-2555" id="h7-0-2555" class="d">-		form_fields[&#39;private&#39;] = &quot;checked&quot;
</a><a href="#h7-0-2556" id="h7-0-2556" class="d">-	ctype, body = EncodeMultipartFormData(form_fields.items(), [])
</a><a href="#h7-0-2557" id="h7-0-2557" class="d">-	response = MySend(&quot;/&quot; + issue + &quot;/edit&quot;, body, content_type=ctype)
</a><a href="#h7-0-2558" id="h7-0-2558" class="d">-	if response != &quot;&quot;:
</a><a href="#h7-0-2559" id="h7-0-2559" class="d">-		print &gt;&gt;sys.stderr, &quot;Error editing description:\n&quot; + &quot;Sent form: \n&quot;, form_fields, &quot;\n&quot;, response
</a><a href="#h7-0-2560" id="h7-0-2560" class="d">-		sys.exit(2)
</a><a href="#h7-0-2561" id="h7-0-2561" class="d">-
</a><a href="#h7-0-2562" id="h7-0-2562" class="d">-def PostMessage(ui, issue, message, reviewers=None, cc=None, send_mail=True, subject=None):
</a><a href="#h7-0-2563" id="h7-0-2563" class="d">-	set_status(&quot;uploading message&quot;)
</a><a href="#h7-0-2564" id="h7-0-2564" class="d">-	form_fields = GetForm(&quot;/&quot; + issue + &quot;/publish&quot;)
</a><a href="#h7-0-2565" id="h7-0-2565" class="d">-	if reviewers is not None:
</a><a href="#h7-0-2566" id="h7-0-2566" class="d">-		form_fields[&#39;reviewers&#39;] = reviewers
</a><a href="#h7-0-2567" id="h7-0-2567" class="d">-	if cc is not None:
</a><a href="#h7-0-2568" id="h7-0-2568" class="d">-		form_fields[&#39;cc&#39;] = cc
</a><a href="#h7-0-2569" id="h7-0-2569" class="d">-	if send_mail:
</a><a href="#h7-0-2570" id="h7-0-2570" class="d">-		form_fields[&#39;send_mail&#39;] = &quot;checked&quot;
</a><a href="#h7-0-2571" id="h7-0-2571" class="d">-	else:
</a><a href="#h7-0-2572" id="h7-0-2572" class="d">-		del form_fields[&#39;send_mail&#39;]
</a><a href="#h7-0-2573" id="h7-0-2573" class="d">-	if subject is not None:
</a><a href="#h7-0-2574" id="h7-0-2574" class="d">-		form_fields[&#39;subject&#39;] = subject
</a><a href="#h7-0-2575" id="h7-0-2575" class="d">-	form_fields[&#39;message&#39;] = message
</a><a href="#h7-0-2576" id="h7-0-2576" class="d">-	
</a><a href="#h7-0-2577" id="h7-0-2577" class="d">-	form_fields[&#39;message_only&#39;] = &#39;1&#39;	# Don&#39;t include draft comments
</a><a href="#h7-0-2578" id="h7-0-2578" class="d">-	if reviewers is not None or cc is not None:
</a><a href="#h7-0-2579" id="h7-0-2579" class="d">-		form_fields[&#39;message_only&#39;] = &#39;&#39;	# Must set &#39;&#39; in order to override cc/reviewer
</a><a href="#h7-0-2580" id="h7-0-2580" class="d">-	ctype = &quot;applications/x-www-form-urlencoded&quot;
</a><a href="#h7-0-2581" id="h7-0-2581" class="d">-	body = urllib.urlencode(form_fields)
</a><a href="#h7-0-2582" id="h7-0-2582" class="d">-	response = MySend(&quot;/&quot; + issue + &quot;/publish&quot;, body, content_type=ctype)
</a><a href="#h7-0-2583" id="h7-0-2583" class="d">-	if response != &quot;&quot;:
</a><a href="#h7-0-2584" id="h7-0-2584" class="d">-		print response
</a><a href="#h7-0-2585" id="h7-0-2585" class="d">-		sys.exit(2)
</a><a href="#h7-0-2586" id="h7-0-2586" class="d">-
</a><a href="#h7-0-2587" id="h7-0-2587" class="d">-class opt(object):
</a><a href="#h7-0-2588" id="h7-0-2588" class="d">-	pass
</a><a href="#h7-0-2589" id="h7-0-2589" class="d">-
</a><a href="#h7-0-2590" id="h7-0-2590" class="d">-def RietveldSetup(ui, repo):
</a><a href="#h7-0-2591" id="h7-0-2591" class="d">-	global force_google_account
</a><a href="#h7-0-2592" id="h7-0-2592" class="d">-	global rpc
</a><a href="#h7-0-2593" id="h7-0-2593" class="d">-	global server
</a><a href="#h7-0-2594" id="h7-0-2594" class="d">-	global server_url_base
</a><a href="#h7-0-2595" id="h7-0-2595" class="d">-	global upload_options
</a><a href="#h7-0-2596" id="h7-0-2596" class="d">-	global verbosity
</a><a href="#h7-0-2597" id="h7-0-2597" class="d">-
</a><a href="#h7-0-2598" id="h7-0-2598" class="d">-	if not ui.verbose:
</a><a href="#h7-0-2599" id="h7-0-2599" class="d">-		verbosity = 0
</a><a href="#h7-0-2600" id="h7-0-2600" class="d">-
</a><a href="#h7-0-2601" id="h7-0-2601" class="d">-	# Config options.
</a><a href="#h7-0-2602" id="h7-0-2602" class="d">-	x = ui.config(&quot;codereview&quot;, &quot;server&quot;)
</a><a href="#h7-0-2603" id="h7-0-2603" class="d">-	if x is not None:
</a><a href="#h7-0-2604" id="h7-0-2604" class="d">-		server = x
</a><a href="#h7-0-2605" id="h7-0-2605" class="d">-
</a><a href="#h7-0-2606" id="h7-0-2606" class="d">-	# TODO(rsc): Take from ui.username?
</a><a href="#h7-0-2607" id="h7-0-2607" class="d">-	email = None
</a><a href="#h7-0-2608" id="h7-0-2608" class="d">-	x = ui.config(&quot;codereview&quot;, &quot;email&quot;)
</a><a href="#h7-0-2609" id="h7-0-2609" class="d">-	if x is not None:
</a><a href="#h7-0-2610" id="h7-0-2610" class="d">-		email = x
</a><a href="#h7-0-2611" id="h7-0-2611" class="d">-
</a><a href="#h7-0-2612" id="h7-0-2612" class="d">-	server_url_base = &quot;https://&quot; + server + &quot;/&quot;
</a><a href="#h7-0-2613" id="h7-0-2613" class="d">-
</a><a href="#h7-0-2614" id="h7-0-2614" class="d">-	testing = ui.config(&quot;codereview&quot;, &quot;testing&quot;)
</a><a href="#h7-0-2615" id="h7-0-2615" class="d">-	force_google_account = ui.configbool(&quot;codereview&quot;, &quot;force_google_account&quot;, False)
</a><a href="#h7-0-2616" id="h7-0-2616" class="d">-
</a><a href="#h7-0-2617" id="h7-0-2617" class="d">-	upload_options = opt()
</a><a href="#h7-0-2618" id="h7-0-2618" class="d">-	upload_options.email = email
</a><a href="#h7-0-2619" id="h7-0-2619" class="d">-	upload_options.host = None
</a><a href="#h7-0-2620" id="h7-0-2620" class="d">-	upload_options.verbose = 0
</a><a href="#h7-0-2621" id="h7-0-2621" class="d">-	upload_options.description = None
</a><a href="#h7-0-2622" id="h7-0-2622" class="d">-	upload_options.description_file = None
</a><a href="#h7-0-2623" id="h7-0-2623" class="d">-	upload_options.reviewers = None
</a><a href="#h7-0-2624" id="h7-0-2624" class="d">-	upload_options.cc = None
</a><a href="#h7-0-2625" id="h7-0-2625" class="d">-	upload_options.message = None
</a><a href="#h7-0-2626" id="h7-0-2626" class="d">-	upload_options.issue = None
</a><a href="#h7-0-2627" id="h7-0-2627" class="d">-	upload_options.download_base = False
</a><a href="#h7-0-2628" id="h7-0-2628" class="d">-	upload_options.revision = None
</a><a href="#h7-0-2629" id="h7-0-2629" class="d">-	upload_options.send_mail = False
</a><a href="#h7-0-2630" id="h7-0-2630" class="d">-	upload_options.vcs = None
</a><a href="#h7-0-2631" id="h7-0-2631" class="d">-	upload_options.server = server
</a><a href="#h7-0-2632" id="h7-0-2632" class="d">-	upload_options.save_cookies = True
</a><a href="#h7-0-2633" id="h7-0-2633" class="d">-
</a><a href="#h7-0-2634" id="h7-0-2634" class="d">-	if testing:
</a><a href="#h7-0-2635" id="h7-0-2635" class="d">-		upload_options.save_cookies = False
</a><a href="#h7-0-2636" id="h7-0-2636" class="d">-		upload_options.email = &quot;test@example.com&quot;
</a><a href="#h7-0-2637" id="h7-0-2637" class="d">-
</a><a href="#h7-0-2638" id="h7-0-2638" class="d">-	rpc = None
</a><a href="#h7-0-2639" id="h7-0-2639" class="d">-	
</a><a href="#h7-0-2640" id="h7-0-2640" class="d">-	global releaseBranch
</a><a href="#h7-0-2641" id="h7-0-2641" class="d">-	tags = repo.branchmap().keys()
</a><a href="#h7-0-2642" id="h7-0-2642" class="d">-	if &#39;release-branch.go10&#39; in tags:
</a><a href="#h7-0-2643" id="h7-0-2643" class="d">-		# NOTE(rsc): This tags.sort is going to get the wrong
</a><a href="#h7-0-2644" id="h7-0-2644" class="d">-		# answer when comparing release-branch.go9 with
</a><a href="#h7-0-2645" id="h7-0-2645" class="d">-		# release-branch.go10.  It will be a while before we care.
</a><a href="#h7-0-2646" id="h7-0-2646" class="d">-		raise hg_util.Abort(&#39;tags.sort needs to be fixed for release-branch.go10&#39;)
</a><a href="#h7-0-2647" id="h7-0-2647" class="d">-	tags.sort()
</a><a href="#h7-0-2648" id="h7-0-2648" class="d">-	for t in tags:
</a><a href="#h7-0-2649" id="h7-0-2649" class="d">-		if t.startswith(&#39;release-branch.go&#39;):
</a><a href="#h7-0-2650" id="h7-0-2650" class="d">-			releaseBranch = t			
</a><a href="#h7-0-2651" id="h7-0-2651" class="d">-
</a><a href="#h7-0-2652" id="h7-0-2652" class="d">-#######################################################################
</a><a href="#h7-0-2653" id="h7-0-2653" class="d">-# http://codereview.appspot.com/static/upload.py, heavily edited.
</a><a href="#h7-0-2654" id="h7-0-2654" class="d">-
</a><a href="#h7-0-2655" id="h7-0-2655" class="d">-#!/usr/bin/env python
</a><a href="#h7-0-2656" id="h7-0-2656" class="d">-#
</a><a href="#h7-0-2657" id="h7-0-2657" class="d">-# Copyright 2007 Google Inc.
</a><a href="#h7-0-2658" id="h7-0-2658" class="d">-#
</a><a href="#h7-0-2659" id="h7-0-2659" class="d">-# Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
</a><a href="#h7-0-2660" id="h7-0-2660" class="d">-# you may not use this file except in compliance with the License.
</a><a href="#h7-0-2661" id="h7-0-2661" class="d">-# You may obtain a copy of the License at
</a><a href="#h7-0-2662" id="h7-0-2662" class="d">-#
</a><a href="#h7-0-2663" id="h7-0-2663" class="d">-#	http://www.apache.org/licenses/LICENSE-2.0
</a><a href="#h7-0-2664" id="h7-0-2664" class="d">-#
</a><a href="#h7-0-2665" id="h7-0-2665" class="d">-# Unless required by applicable law or agreed to in writing, software
</a><a href="#h7-0-2666" id="h7-0-2666" class="d">-# distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
</a><a href="#h7-0-2667" id="h7-0-2667" class="d">-# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
</a><a href="#h7-0-2668" id="h7-0-2668" class="d">-# See the License for the specific language governing permissions and
</a><a href="#h7-0-2669" id="h7-0-2669" class="d">-# limitations under the License.
</a><a href="#h7-0-2670" id="h7-0-2670" class="d">-
</a><a href="#h7-0-2671" id="h7-0-2671" class="d">-&quot;&quot;&quot;Tool for uploading diffs from a version control system to the codereview app.
</a><a href="#h7-0-2672" id="h7-0-2672" class="d">-
</a><a href="#h7-0-2673" id="h7-0-2673" class="d">-Usage summary: upload.py [options] [-- diff_options]
</a><a href="#h7-0-2674" id="h7-0-2674" class="d">-
</a><a href="#h7-0-2675" id="h7-0-2675" class="d">-Diff options are passed to the diff command of the underlying system.
</a><a href="#h7-0-2676" id="h7-0-2676" class="d">-
</a><a href="#h7-0-2677" id="h7-0-2677" class="d">-Supported version control systems:
</a><a href="#h7-0-2678" id="h7-0-2678" class="d">-	Git
</a><a href="#h7-0-2679" id="h7-0-2679" class="d">-	Mercurial
</a><a href="#h7-0-2680" id="h7-0-2680" class="d">-	Subversion
</a><a href="#h7-0-2681" id="h7-0-2681" class="d">-
</a><a href="#h7-0-2682" id="h7-0-2682" class="d">-It is important for Git/Mercurial users to specify a tree/node/branch to diff
</a><a href="#h7-0-2683" id="h7-0-2683" class="d">-against by using the &#39;--rev&#39; option.
</a><a href="#h7-0-2684" id="h7-0-2684" class="d">-&quot;&quot;&quot;
</a><a href="#h7-0-2685" id="h7-0-2685" class="d">-# This code is derived from appcfg.py in the App Engine SDK (open source),
</a><a href="#h7-0-2686" id="h7-0-2686" class="d">-# and from ASPN recipe #146306.
</a><a href="#h7-0-2687" id="h7-0-2687" class="d">-
</a><a href="#h7-0-2688" id="h7-0-2688" class="d">-import cookielib
</a><a href="#h7-0-2689" id="h7-0-2689" class="d">-import getpass
</a><a href="#h7-0-2690" id="h7-0-2690" class="d">-import logging
</a><a href="#h7-0-2691" id="h7-0-2691" class="d">-import mimetypes
</a><a href="#h7-0-2692" id="h7-0-2692" class="d">-import optparse
</a><a href="#h7-0-2693" id="h7-0-2693" class="d">-import os
</a><a href="#h7-0-2694" id="h7-0-2694" class="d">-import re
</a><a href="#h7-0-2695" id="h7-0-2695" class="d">-import socket
</a><a href="#h7-0-2696" id="h7-0-2696" class="d">-import subprocess
</a><a href="#h7-0-2697" id="h7-0-2697" class="d">-import sys
</a><a href="#h7-0-2698" id="h7-0-2698" class="d">-import urllib
</a><a href="#h7-0-2699" id="h7-0-2699" class="d">-import urllib2
</a><a href="#h7-0-2700" id="h7-0-2700" class="d">-import urlparse
</a><a href="#h7-0-2701" id="h7-0-2701" class="d">-
</a><a href="#h7-0-2702" id="h7-0-2702" class="d">-# The md5 module was deprecated in Python 2.5.
</a><a href="#h7-0-2703" id="h7-0-2703" class="d">-try:
</a><a href="#h7-0-2704" id="h7-0-2704" class="d">-	from hashlib import md5
</a><a href="#h7-0-2705" id="h7-0-2705" class="d">-except ImportError:
</a><a href="#h7-0-2706" id="h7-0-2706" class="d">-	from md5 import md5
</a><a href="#h7-0-2707" id="h7-0-2707" class="d">-
</a><a href="#h7-0-2708" id="h7-0-2708" class="d">-try:
</a><a href="#h7-0-2709" id="h7-0-2709" class="d">-	import readline
</a><a href="#h7-0-2710" id="h7-0-2710" class="d">-except ImportError:
</a><a href="#h7-0-2711" id="h7-0-2711" class="d">-	pass
</a><a href="#h7-0-2712" id="h7-0-2712" class="d">-
</a><a href="#h7-0-2713" id="h7-0-2713" class="d">-# The logging verbosity:
</a><a href="#h7-0-2714" id="h7-0-2714" class="d">-#  0: Errors only.
</a><a href="#h7-0-2715" id="h7-0-2715" class="d">-#  1: Status messages.
</a><a href="#h7-0-2716" id="h7-0-2716" class="d">-#  2: Info logs.
</a><a href="#h7-0-2717" id="h7-0-2717" class="d">-#  3: Debug logs.
</a><a href="#h7-0-2718" id="h7-0-2718" class="d">-verbosity = 1
</a><a href="#h7-0-2719" id="h7-0-2719" class="d">-
</a><a href="#h7-0-2720" id="h7-0-2720" class="d">-# Max size of patch or base file.
</a><a href="#h7-0-2721" id="h7-0-2721" class="d">-MAX_UPLOAD_SIZE = 900 * 1024
</a><a href="#h7-0-2722" id="h7-0-2722" class="d">-
</a><a href="#h7-0-2723" id="h7-0-2723" class="d">-# whitelist for non-binary filetypes which do not start with &quot;text/&quot;
</a><a href="#h7-0-2724" id="h7-0-2724" class="d">-# .mm (Objective-C) shows up as application/x-freemind on my Linux box.
</a><a href="#h7-0-2725" id="h7-0-2725" class="d">-TEXT_MIMETYPES = [
</a><a href="#h7-0-2726" id="h7-0-2726" class="d">-	&#39;application/javascript&#39;,
</a><a href="#h7-0-2727" id="h7-0-2727" class="d">-	&#39;application/x-javascript&#39;,
</a><a href="#h7-0-2728" id="h7-0-2728" class="d">-	&#39;application/x-freemind&#39;
</a><a href="#h7-0-2729" id="h7-0-2729" class="d">-]
</a><a href="#h7-0-2730" id="h7-0-2730" class="d">-
</a><a href="#h7-0-2731" id="h7-0-2731" class="d">-def GetEmail(prompt):
</a><a href="#h7-0-2732" id="h7-0-2732" class="d">-	&quot;&quot;&quot;Prompts the user for their email address and returns it.
</a><a href="#h7-0-2733" id="h7-0-2733" class="d">-
</a><a href="#h7-0-2734" id="h7-0-2734" class="d">-	The last used email address is saved to a file and offered up as a suggestion
</a><a href="#h7-0-2735" id="h7-0-2735" class="d">-	to the user. If the user presses enter without typing in anything the last
</a><a href="#h7-0-2736" id="h7-0-2736" class="d">-	used email address is used. If the user enters a new address, it is saved
</a><a href="#h7-0-2737" id="h7-0-2737" class="d">-	for next time we prompt.
</a><a href="#h7-0-2738" id="h7-0-2738" class="d">-
</a><a href="#h7-0-2739" id="h7-0-2739" class="d">-	&quot;&quot;&quot;
</a><a href="#h7-0-2740" id="h7-0-2740" class="d">-	last_email_file_name = os.path.expanduser(&quot;~/.last_codereview_email_address&quot;)
</a><a href="#h7-0-2741" id="h7-0-2741" class="d">-	last_email = &quot;&quot;
</a><a href="#h7-0-2742" id="h7-0-2742" class="d">-	if os.path.exists(last_email_file_name):
</a><a href="#h7-0-2743" id="h7-0-2743" class="d">-		try:
</a><a href="#h7-0-2744" id="h7-0-2744" class="d">-			last_email_file = open(last_email_file_name, &quot;r&quot;)
</a><a href="#h7-0-2745" id="h7-0-2745" class="d">-			last_email = last_email_file.readline().strip(&quot;\n&quot;)
</a><a href="#h7-0-2746" id="h7-0-2746" class="d">-			last_email_file.close()
</a><a href="#h7-0-2747" id="h7-0-2747" class="d">-			prompt += &quot; [%s]&quot; % last_email
</a><a href="#h7-0-2748" id="h7-0-2748" class="d">-		except IOError, e:
</a><a href="#h7-0-2749" id="h7-0-2749" class="d">-			pass
</a><a href="#h7-0-2750" id="h7-0-2750" class="d">-	email = raw_input(prompt + &quot;: &quot;).strip()
</a><a href="#h7-0-2751" id="h7-0-2751" class="d">-	if email:
</a><a href="#h7-0-2752" id="h7-0-2752" class="d">-		try:
</a><a href="#h7-0-2753" id="h7-0-2753" class="d">-			last_email_file = open(last_email_file_name, &quot;w&quot;)
</a><a href="#h7-0-2754" id="h7-0-2754" class="d">-			last_email_file.write(email)
</a><a href="#h7-0-2755" id="h7-0-2755" class="d">-			last_email_file.close()
</a><a href="#h7-0-2756" id="h7-0-2756" class="d">-		except IOError, e:
</a><a href="#h7-0-2757" id="h7-0-2757" class="d">-			pass
</a><a href="#h7-0-2758" id="h7-0-2758" class="d">-	else:
</a><a href="#h7-0-2759" id="h7-0-2759" class="d">-		email = last_email
</a><a href="#h7-0-2760" id="h7-0-2760" class="d">-	return email
</a><a href="#h7-0-2761" id="h7-0-2761" class="d">-
</a><a href="#h7-0-2762" id="h7-0-2762" class="d">-
</a><a href="#h7-0-2763" id="h7-0-2763" class="d">-def StatusUpdate(msg):
</a><a href="#h7-0-2764" id="h7-0-2764" class="d">-	&quot;&quot;&quot;Print a status message to stdout.
</a><a href="#h7-0-2765" id="h7-0-2765" class="d">-
</a><a href="#h7-0-2766" id="h7-0-2766" class="d">-	If &#39;verbosity&#39; is greater than 0, print the message.
</a><a href="#h7-0-2767" id="h7-0-2767" class="d">-
</a><a href="#h7-0-2768" id="h7-0-2768" class="d">-	Args:
</a><a href="#h7-0-2769" id="h7-0-2769" class="d">-		msg: The string to print.
</a><a href="#h7-0-2770" id="h7-0-2770" class="d">-	&quot;&quot;&quot;
</a><a href="#h7-0-2771" id="h7-0-2771" class="d">-	if verbosity &gt; 0:
</a><a href="#h7-0-2772" id="h7-0-2772" class="d">-		print msg
</a><a href="#h7-0-2773" id="h7-0-2773" class="d">-
</a><a href="#h7-0-2774" id="h7-0-2774" class="d">-
</a><a href="#h7-0-2775" id="h7-0-2775" class="d">-def ErrorExit(msg):
</a><a href="#h7-0-2776" id="h7-0-2776" class="d">-	&quot;&quot;&quot;Print an error message to stderr and exit.&quot;&quot;&quot;
</a><a href="#h7-0-2777" id="h7-0-2777" class="d">-	print &gt;&gt;sys.stderr, msg
</a><a href="#h7-0-2778" id="h7-0-2778" class="d">-	sys.exit(1)
</a><a href="#h7-0-2779" id="h7-0-2779" class="d">-
</a><a href="#h7-0-2780" id="h7-0-2780" class="d">-
</a><a href="#h7-0-2781" id="h7-0-2781" class="d">-class ClientLoginError(urllib2.HTTPError):
</a><a href="#h7-0-2782" id="h7-0-2782" class="d">-	&quot;&quot;&quot;Raised to indicate there was an error authenticating with ClientLogin.&quot;&quot;&quot;
</a><a href="#h7-0-2783" id="h7-0-2783" class="d">-
</a><a href="#h7-0-2784" id="h7-0-2784" class="d">-	def __init__(self, url, code, msg, headers, args):
</a><a href="#h7-0-2785" id="h7-0-2785" class="d">-		urllib2.HTTPError.__init__(self, url, code, msg, headers, None)
</a><a href="#h7-0-2786" id="h7-0-2786" class="d">-		self.args = args
</a><a href="#h7-0-2787" id="h7-0-2787" class="d">-		# .reason is now a read-only property based on .msg
</a><a href="#h7-0-2788" id="h7-0-2788" class="d">-		# this means we ignore &#39;msg&#39;, but that seems to work fine.
</a><a href="#h7-0-2789" id="h7-0-2789" class="d">-		self.msg = args[&quot;Error&quot;] 
</a><a href="#h7-0-2790" id="h7-0-2790" class="d">-
</a><a href="#h7-0-2791" id="h7-0-2791" class="d">-
</a><a href="#h7-0-2792" id="h7-0-2792" class="d">-class AbstractRpcServer(object):
</a><a href="#h7-0-2793" id="h7-0-2793" class="d">-	&quot;&quot;&quot;Provides a common interface for a simple RPC server.&quot;&quot;&quot;
</a><a href="#h7-0-2794" id="h7-0-2794" class="d">-
</a><a href="#h7-0-2795" id="h7-0-2795" class="d">-	def __init__(self, host, auth_function, host_override=None, extra_headers={}, save_cookies=False):
</a><a href="#h7-0-2796" id="h7-0-2796" class="d">-		&quot;&quot;&quot;Creates a new HttpRpcServer.
</a><a href="#h7-0-2797" id="h7-0-2797" class="d">-
</a><a href="#h7-0-2798" id="h7-0-2798" class="d">-		Args:
</a><a href="#h7-0-2799" id="h7-0-2799" class="d">-			host: The host to send requests to.
</a><a href="#h7-0-2800" id="h7-0-2800" class="d">-			auth_function: A function that takes no arguments and returns an
</a><a href="#h7-0-2801" id="h7-0-2801" class="d">-				(email, password) tuple when called. Will be called if authentication
</a><a href="#h7-0-2802" id="h7-0-2802" class="d">-				is required.
</a><a href="#h7-0-2803" id="h7-0-2803" class="d">-			host_override: The host header to send to the server (defaults to host).
</a><a href="#h7-0-2804" id="h7-0-2804" class="d">-			extra_headers: A dict of extra headers to append to every request.
</a><a href="#h7-0-2805" id="h7-0-2805" class="d">-			save_cookies: If True, save the authentication cookies to local disk.
</a><a href="#h7-0-2806" id="h7-0-2806" class="d">-				If False, use an in-memory cookiejar instead.  Subclasses must
</a><a href="#h7-0-2807" id="h7-0-2807" class="d">-				implement this functionality.  Defaults to False.
</a><a href="#h7-0-2808" id="h7-0-2808" class="d">-		&quot;&quot;&quot;
</a><a href="#h7-0-2809" id="h7-0-2809" class="d">-		self.host = host
</a><a href="#h7-0-2810" id="h7-0-2810" class="d">-		self.host_override = host_override
</a><a href="#h7-0-2811" id="h7-0-2811" class="d">-		self.auth_function = auth_function
</a><a href="#h7-0-2812" id="h7-0-2812" class="d">-		self.authenticated = False
</a><a href="#h7-0-2813" id="h7-0-2813" class="d">-		self.extra_headers = extra_headers
</a><a href="#h7-0-2814" id="h7-0-2814" class="d">-		self.save_cookies = save_cookies
</a><a href="#h7-0-2815" id="h7-0-2815" class="d">-		self.opener = self._GetOpener()
</a><a href="#h7-0-2816" id="h7-0-2816" class="d">-		if self.host_override:
</a><a href="#h7-0-2817" id="h7-0-2817" class="d">-			logging.info(&quot;Server: %s; Host: %s&quot;, self.host, self.host_override)
</a><a href="#h7-0-2818" id="h7-0-2818" class="d">-		else:
</a><a href="#h7-0-2819" id="h7-0-2819" class="d">-			logging.info(&quot;Server: %s&quot;, self.host)
</a><a href="#h7-0-2820" id="h7-0-2820" class="d">-
</a><a href="#h7-0-2821" id="h7-0-2821" class="d">-	def _GetOpener(self):
</a><a href="#h7-0-2822" id="h7-0-2822" class="d">-		&quot;&quot;&quot;Returns an OpenerDirector for making HTTP requests.
</a><a href="#h7-0-2823" id="h7-0-2823" class="d">-
</a><a href="#h7-0-2824" id="h7-0-2824" class="d">-		Returns:
</a><a href="#h7-0-2825" id="h7-0-2825" class="d">-			A urllib2.OpenerDirector object.
</a><a href="#h7-0-2826" id="h7-0-2826" class="d">-		&quot;&quot;&quot;
</a><a href="#h7-0-2827" id="h7-0-2827" class="d">-		raise NotImplementedError()
</a><a href="#h7-0-2828" id="h7-0-2828" class="d">-
</a><a href="#h7-0-2829" id="h7-0-2829" class="d">-	def _CreateRequest(self, url, data=None):
</a><a href="#h7-0-2830" id="h7-0-2830" class="d">-		&quot;&quot;&quot;Creates a new urllib request.&quot;&quot;&quot;
</a><a href="#h7-0-2831" id="h7-0-2831" class="d">-		logging.debug(&quot;Creating request for: &#39;%s&#39; with payload:\n%s&quot;, url, data)
</a><a href="#h7-0-2832" id="h7-0-2832" class="d">-		req = urllib2.Request(url, data=data)
</a><a href="#h7-0-2833" id="h7-0-2833" class="d">-		if self.host_override:
</a><a href="#h7-0-2834" id="h7-0-2834" class="d">-			req.add_header(&quot;Host&quot;, self.host_override)
</a><a href="#h7-0-2835" id="h7-0-2835" class="d">-		for key, value in self.extra_headers.iteritems():
</a><a href="#h7-0-2836" id="h7-0-2836" class="d">-			req.add_header(key, value)
</a><a href="#h7-0-2837" id="h7-0-2837" class="d">-		return req
</a><a href="#h7-0-2838" id="h7-0-2838" class="d">-
</a><a href="#h7-0-2839" id="h7-0-2839" class="d">-	def _GetAuthToken(self, email, password):
</a><a href="#h7-0-2840" id="h7-0-2840" class="d">-		&quot;&quot;&quot;Uses ClientLogin to authenticate the user, returning an auth token.
</a><a href="#h7-0-2841" id="h7-0-2841" class="d">-
</a><a href="#h7-0-2842" id="h7-0-2842" class="d">-		Args:
</a><a href="#h7-0-2843" id="h7-0-2843" class="d">-			email:    The user&#39;s email address
</a><a href="#h7-0-2844" id="h7-0-2844" class="d">-			password: The user&#39;s password
</a><a href="#h7-0-2845" id="h7-0-2845" class="d">-
</a><a href="#h7-0-2846" id="h7-0-2846" class="d">-		Raises:
</a><a href="#h7-0-2847" id="h7-0-2847" class="d">-			ClientLoginError: If there was an error authenticating with ClientLogin.
</a><a href="#h7-0-2848" id="h7-0-2848" class="d">-			HTTPError: If there was some other form of HTTP error.
</a><a href="#h7-0-2849" id="h7-0-2849" class="d">-
</a><a href="#h7-0-2850" id="h7-0-2850" class="d">-		Returns:
</a><a href="#h7-0-2851" id="h7-0-2851" class="d">-			The authentication token returned by ClientLogin.
</a><a href="#h7-0-2852" id="h7-0-2852" class="d">-		&quot;&quot;&quot;
</a><a href="#h7-0-2853" id="h7-0-2853" class="d">-		account_type = &quot;GOOGLE&quot;
</a><a href="#h7-0-2854" id="h7-0-2854" class="d">-		if self.host.endswith(&quot;.google.com&quot;) and not force_google_account:
</a><a href="#h7-0-2855" id="h7-0-2855" class="d">-			# Needed for use inside Google.
</a><a href="#h7-0-2856" id="h7-0-2856" class="d">-			account_type = &quot;HOSTED&quot;
</a><a href="#h7-0-2857" id="h7-0-2857" class="d">-		req = self._CreateRequest(
</a><a href="#h7-0-2858" id="h7-0-2858" class="d">-				url=&quot;https://www.google.com/accounts/ClientLogin&quot;,
</a><a href="#h7-0-2859" id="h7-0-2859" class="d">-				data=urllib.urlencode({
</a><a href="#h7-0-2860" id="h7-0-2860" class="d">-						&quot;Email&quot;: email,
</a><a href="#h7-0-2861" id="h7-0-2861" class="d">-						&quot;Passwd&quot;: password,
</a><a href="#h7-0-2862" id="h7-0-2862" class="d">-						&quot;service&quot;: &quot;ah&quot;,
</a><a href="#h7-0-2863" id="h7-0-2863" class="d">-						&quot;source&quot;: &quot;rietveld-codereview-upload&quot;,
</a><a href="#h7-0-2864" id="h7-0-2864" class="d">-						&quot;accountType&quot;: account_type,
</a><a href="#h7-0-2865" id="h7-0-2865" class="d">-				}),
</a><a href="#h7-0-2866" id="h7-0-2866" class="d">-		)
</a><a href="#h7-0-2867" id="h7-0-2867" class="d">-		try:
</a><a href="#h7-0-2868" id="h7-0-2868" class="d">-			response = self.opener.open(req)
</a><a href="#h7-0-2869" id="h7-0-2869" class="d">-			response_body = response.read()
</a><a href="#h7-0-2870" id="h7-0-2870" class="d">-			response_dict = dict(x.split(&quot;=&quot;) for x in response_body.split(&quot;\n&quot;) if x)
</a><a href="#h7-0-2871" id="h7-0-2871" class="d">-			return response_dict[&quot;Auth&quot;]
</a><a href="#h7-0-2872" id="h7-0-2872" class="d">-		except urllib2.HTTPError, e:
</a><a href="#h7-0-2873" id="h7-0-2873" class="d">-			if e.code == 403:
</a><a href="#h7-0-2874" id="h7-0-2874" class="d">-				body = e.read()
</a><a href="#h7-0-2875" id="h7-0-2875" class="d">-				response_dict = dict(x.split(&quot;=&quot;, 1) for x in body.split(&quot;\n&quot;) if x)
</a><a href="#h7-0-2876" id="h7-0-2876" class="d">-				raise ClientLoginError(req.get_full_url(), e.code, e.msg, e.headers, response_dict)
</a><a href="#h7-0-2877" id="h7-0-2877" class="d">-			else:
</a><a href="#h7-0-2878" id="h7-0-2878" class="d">-				raise
</a><a href="#h7-0-2879" id="h7-0-2879" class="d">-
</a><a href="#h7-0-2880" id="h7-0-2880" class="d">-	def _GetAuthCookie(self, auth_token):
</a><a href="#h7-0-2881" id="h7-0-2881" class="d">-		&quot;&quot;&quot;Fetches authentication cookies for an authentication token.
</a><a href="#h7-0-2882" id="h7-0-2882" class="d">-
</a><a href="#h7-0-2883" id="h7-0-2883" class="d">-		Args:
</a><a href="#h7-0-2884" id="h7-0-2884" class="d">-			auth_token: The authentication token returned by ClientLogin.
</a><a href="#h7-0-2885" id="h7-0-2885" class="d">-
</a><a href="#h7-0-2886" id="h7-0-2886" class="d">-		Raises:
</a><a href="#h7-0-2887" id="h7-0-2887" class="d">-			HTTPError: If there was an error fetching the authentication cookies.
</a><a href="#h7-0-2888" id="h7-0-2888" class="d">-		&quot;&quot;&quot;
</a><a href="#h7-0-2889" id="h7-0-2889" class="d">-		# This is a dummy value to allow us to identify when we&#39;re successful.
</a><a href="#h7-0-2890" id="h7-0-2890" class="d">-		continue_location = &quot;http://localhost/&quot;
</a><a href="#h7-0-2891" id="h7-0-2891" class="d">-		args = {&quot;continue&quot;: continue_location, &quot;auth&quot;: auth_token}
</a><a href="#h7-0-2892" id="h7-0-2892" class="d">-		req = self._CreateRequest(&quot;https://%s/_ah/login?%s&quot; % (self.host, urllib.urlencode(args)))
</a><a href="#h7-0-2893" id="h7-0-2893" class="d">-		try:
</a><a href="#h7-0-2894" id="h7-0-2894" class="d">-			response = self.opener.open(req)
</a><a href="#h7-0-2895" id="h7-0-2895" class="d">-		except urllib2.HTTPError, e:
</a><a href="#h7-0-2896" id="h7-0-2896" class="d">-			response = e
</a><a href="#h7-0-2897" id="h7-0-2897" class="d">-		if (response.code != 302 or
</a><a href="#h7-0-2898" id="h7-0-2898" class="d">-				response.info()[&quot;location&quot;] != continue_location):
</a><a href="#h7-0-2899" id="h7-0-2899" class="d">-			raise urllib2.HTTPError(req.get_full_url(), response.code, response.msg, response.headers, response.fp)
</a><a href="#h7-0-2900" id="h7-0-2900" class="d">-		self.authenticated = True
</a><a href="#h7-0-2901" id="h7-0-2901" class="d">-
</a><a href="#h7-0-2902" id="h7-0-2902" class="d">-	def _Authenticate(self):
</a><a href="#h7-0-2903" id="h7-0-2903" class="d">-		&quot;&quot;&quot;Authenticates the user.
</a><a href="#h7-0-2904" id="h7-0-2904" class="d">-
</a><a href="#h7-0-2905" id="h7-0-2905" class="d">-		The authentication process works as follows:
</a><a href="#h7-0-2906" id="h7-0-2906" class="d">-		1) We get a username and password from the user
</a><a href="#h7-0-2907" id="h7-0-2907" class="d">-		2) We use ClientLogin to obtain an AUTH token for the user
</a><a href="#h7-0-2908" id="h7-0-2908" class="d">-				(see http://code.google.com/apis/accounts/AuthForInstalledApps.html).
</a><a href="#h7-0-2909" id="h7-0-2909" class="d">-		3) We pass the auth token to /_ah/login on the server to obtain an
</a><a href="#h7-0-2910" id="h7-0-2910" class="d">-				authentication cookie. If login was successful, it tries to redirect
</a><a href="#h7-0-2911" id="h7-0-2911" class="d">-				us to the URL we provided.
</a><a href="#h7-0-2912" id="h7-0-2912" class="d">-
</a><a href="#h7-0-2913" id="h7-0-2913" class="d">-		If we attempt to access the upload API without first obtaining an
</a><a href="#h7-0-2914" id="h7-0-2914" class="d">-		authentication cookie, it returns a 401 response (or a 302) and
</a><a href="#h7-0-2915" id="h7-0-2915" class="d">-		directs us to authenticate ourselves with ClientLogin.
</a><a href="#h7-0-2916" id="h7-0-2916" class="d">-		&quot;&quot;&quot;
</a><a href="#h7-0-2917" id="h7-0-2917" class="d">-		for i in range(3):
</a><a href="#h7-0-2918" id="h7-0-2918" class="d">-			credentials = self.auth_function()
</a><a href="#h7-0-2919" id="h7-0-2919" class="d">-			try:
</a><a href="#h7-0-2920" id="h7-0-2920" class="d">-				auth_token = self._GetAuthToken(credentials[0], credentials[1])
</a><a href="#h7-0-2921" id="h7-0-2921" class="d">-			except ClientLoginError, e:
</a><a href="#h7-0-2922" id="h7-0-2922" class="d">-				if e.msg == &quot;BadAuthentication&quot;:
</a><a href="#h7-0-2923" id="h7-0-2923" class="d">-					print &gt;&gt;sys.stderr, &quot;Invalid username or password.&quot;
</a><a href="#h7-0-2924" id="h7-0-2924" class="d">-					continue
</a><a href="#h7-0-2925" id="h7-0-2925" class="d">-				if e.msg == &quot;CaptchaRequired&quot;:
</a><a href="#h7-0-2926" id="h7-0-2926" class="d">-					print &gt;&gt;sys.stderr, (
</a><a href="#h7-0-2927" id="h7-0-2927" class="d">-						&quot;Please go to\n&quot;
</a><a href="#h7-0-2928" id="h7-0-2928" class="d">-						&quot;https://www.google.com/accounts/DisplayUnlockCaptcha\n&quot;
</a><a href="#h7-0-2929" id="h7-0-2929" class="d">-						&quot;and verify you are a human.  Then try again.&quot;)
</a><a href="#h7-0-2930" id="h7-0-2930" class="d">-					break
</a><a href="#h7-0-2931" id="h7-0-2931" class="d">-				if e.msg == &quot;NotVerified&quot;:
</a><a href="#h7-0-2932" id="h7-0-2932" class="d">-					print &gt;&gt;sys.stderr, &quot;Account not verified.&quot;
</a><a href="#h7-0-2933" id="h7-0-2933" class="d">-					break
</a><a href="#h7-0-2934" id="h7-0-2934" class="d">-				if e.msg == &quot;TermsNotAgreed&quot;:
</a><a href="#h7-0-2935" id="h7-0-2935" class="d">-					print &gt;&gt;sys.stderr, &quot;User has not agreed to TOS.&quot;
</a><a href="#h7-0-2936" id="h7-0-2936" class="d">-					break
</a><a href="#h7-0-2937" id="h7-0-2937" class="d">-				if e.msg == &quot;AccountDeleted&quot;:
</a><a href="#h7-0-2938" id="h7-0-2938" class="d">-					print &gt;&gt;sys.stderr, &quot;The user account has been deleted.&quot;
</a><a href="#h7-0-2939" id="h7-0-2939" class="d">-					break
</a><a href="#h7-0-2940" id="h7-0-2940" class="d">-				if e.msg == &quot;AccountDisabled&quot;:
</a><a href="#h7-0-2941" id="h7-0-2941" class="d">-					print &gt;&gt;sys.stderr, &quot;The user account has been disabled.&quot;
</a><a href="#h7-0-2942" id="h7-0-2942" class="d">-					break
</a><a href="#h7-0-2943" id="h7-0-2943" class="d">-				if e.msg == &quot;ServiceDisabled&quot;:
</a><a href="#h7-0-2944" id="h7-0-2944" class="d">-					print &gt;&gt;sys.stderr, &quot;The user&#39;s access to the service has been disabled.&quot;
</a><a href="#h7-0-2945" id="h7-0-2945" class="d">-					break
</a><a href="#h7-0-2946" id="h7-0-2946" class="d">-				if e.msg == &quot;ServiceUnavailable&quot;:
</a><a href="#h7-0-2947" id="h7-0-2947" class="d">-					print &gt;&gt;sys.stderr, &quot;The service is not available; try again later.&quot;
</a><a href="#h7-0-2948" id="h7-0-2948" class="d">-					break
</a><a href="#h7-0-2949" id="h7-0-2949" class="d">-				raise
</a><a href="#h7-0-2950" id="h7-0-2950" class="d">-			self._GetAuthCookie(auth_token)
</a><a href="#h7-0-2951" id="h7-0-2951" class="d">-			return
</a><a href="#h7-0-2952" id="h7-0-2952" class="d">-
</a><a href="#h7-0-2953" id="h7-0-2953" class="d">-	def Send(self, request_path, payload=None,
</a><a href="#h7-0-2954" id="h7-0-2954" class="d">-					content_type=&quot;application/octet-stream&quot;,
</a><a href="#h7-0-2955" id="h7-0-2955" class="d">-					timeout=None,
</a><a href="#h7-0-2956" id="h7-0-2956" class="d">-					**kwargs):
</a><a href="#h7-0-2957" id="h7-0-2957" class="d">-		&quot;&quot;&quot;Sends an RPC and returns the response.
</a><a href="#h7-0-2958" id="h7-0-2958" class="d">-
</a><a href="#h7-0-2959" id="h7-0-2959" class="d">-		Args:
</a><a href="#h7-0-2960" id="h7-0-2960" class="d">-			request_path: The path to send the request to, eg /api/appversion/create.
</a><a href="#h7-0-2961" id="h7-0-2961" class="d">-			payload: The body of the request, or None to send an empty request.
</a><a href="#h7-0-2962" id="h7-0-2962" class="d">-			content_type: The Content-Type header to use.
</a><a href="#h7-0-2963" id="h7-0-2963" class="d">-			timeout: timeout in seconds; default None i.e. no timeout.
</a><a href="#h7-0-2964" id="h7-0-2964" class="d">-				(Note: for large requests on OS X, the timeout doesn&#39;t work right.)
</a><a href="#h7-0-2965" id="h7-0-2965" class="d">-			kwargs: Any keyword arguments are converted into query string parameters.
</a><a href="#h7-0-2966" id="h7-0-2966" class="d">-
</a><a href="#h7-0-2967" id="h7-0-2967" class="d">-		Returns:
</a><a href="#h7-0-2968" id="h7-0-2968" class="d">-			The response body, as a string.
</a><a href="#h7-0-2969" id="h7-0-2969" class="d">-		&quot;&quot;&quot;
</a><a href="#h7-0-2970" id="h7-0-2970" class="d">-		# TODO: Don&#39;t require authentication.  Let the server say
</a><a href="#h7-0-2971" id="h7-0-2971" class="d">-		# whether it is necessary.
</a><a href="#h7-0-2972" id="h7-0-2972" class="d">-		if not self.authenticated:
</a><a href="#h7-0-2973" id="h7-0-2973" class="d">-			self._Authenticate()
</a><a href="#h7-0-2974" id="h7-0-2974" class="d">-
</a><a href="#h7-0-2975" id="h7-0-2975" class="d">-		old_timeout = socket.getdefaulttimeout()
</a><a href="#h7-0-2976" id="h7-0-2976" class="d">-		socket.setdefaulttimeout(timeout)
</a><a href="#h7-0-2977" id="h7-0-2977" class="d">-		try:
</a><a href="#h7-0-2978" id="h7-0-2978" class="d">-			tries = 0
</a><a href="#h7-0-2979" id="h7-0-2979" class="d">-			while True:
</a><a href="#h7-0-2980" id="h7-0-2980" class="d">-				tries += 1
</a><a href="#h7-0-2981" id="h7-0-2981" class="d">-				args = dict(kwargs)
</a><a href="#h7-0-2982" id="h7-0-2982" class="d">-				url = &quot;https://%s%s&quot; % (self.host, request_path)
</a><a href="#h7-0-2983" id="h7-0-2983" class="d">-				if args:
</a><a href="#h7-0-2984" id="h7-0-2984" class="d">-					url += &quot;?&quot; + urllib.urlencode(args)
</a><a href="#h7-0-2985" id="h7-0-2985" class="d">-				req = self._CreateRequest(url=url, data=payload)
</a><a href="#h7-0-2986" id="h7-0-2986" class="d">-				req.add_header(&quot;Content-Type&quot;, content_type)
</a><a href="#h7-0-2987" id="h7-0-2987" class="d">-				try:
</a><a href="#h7-0-2988" id="h7-0-2988" class="d">-					f = self.opener.open(req)
</a><a href="#h7-0-2989" id="h7-0-2989" class="d">-					response = f.read()
</a><a href="#h7-0-2990" id="h7-0-2990" class="d">-					f.close()
</a><a href="#h7-0-2991" id="h7-0-2991" class="d">-					return response
</a><a href="#h7-0-2992" id="h7-0-2992" class="d">-				except urllib2.HTTPError, e:
</a><a href="#h7-0-2993" id="h7-0-2993" class="d">-					if tries &gt; 3:
</a><a href="#h7-0-2994" id="h7-0-2994" class="d">-						raise
</a><a href="#h7-0-2995" id="h7-0-2995" class="d">-					elif e.code == 401 or e.code == 302:
</a><a href="#h7-0-2996" id="h7-0-2996" class="d">-						self._Authenticate()
</a><a href="#h7-0-2997" id="h7-0-2997" class="d">-					else:
</a><a href="#h7-0-2998" id="h7-0-2998" class="d">-						raise
</a><a href="#h7-0-2999" id="h7-0-2999" class="d">-		finally:
</a><a href="#h7-0-3000" id="h7-0-3000" class="d">-			socket.setdefaulttimeout(old_timeout)
</a><a href="#h7-0-3001" id="h7-0-3001" class="d">-
</a><a href="#h7-0-3002" id="h7-0-3002" class="d">-
</a><a href="#h7-0-3003" id="h7-0-3003" class="d">-class HttpRpcServer(AbstractRpcServer):
</a><a href="#h7-0-3004" id="h7-0-3004" class="d">-	&quot;&quot;&quot;Provides a simplified RPC-style interface for HTTP requests.&quot;&quot;&quot;
</a><a href="#h7-0-3005" id="h7-0-3005" class="d">-
</a><a href="#h7-0-3006" id="h7-0-3006" class="d">-	def _Authenticate(self):
</a><a href="#h7-0-3007" id="h7-0-3007" class="d">-		&quot;&quot;&quot;Save the cookie jar after authentication.&quot;&quot;&quot;
</a><a href="#h7-0-3008" id="h7-0-3008" class="d">-		super(HttpRpcServer, self)._Authenticate()
</a><a href="#h7-0-3009" id="h7-0-3009" class="d">-		if self.save_cookies:
</a><a href="#h7-0-3010" id="h7-0-3010" class="d">-			StatusUpdate(&quot;Saving authentication cookies to %s&quot; % self.cookie_file)
</a><a href="#h7-0-3011" id="h7-0-3011" class="d">-			self.cookie_jar.save()
</a><a href="#h7-0-3012" id="h7-0-3012" class="d">-
</a><a href="#h7-0-3013" id="h7-0-3013" class="d">-	def _GetOpener(self):
</a><a href="#h7-0-3014" id="h7-0-3014" class="d">-		&quot;&quot;&quot;Returns an OpenerDirector that supports cookies and ignores redirects.
</a><a href="#h7-0-3015" id="h7-0-3015" class="d">-
</a><a href="#h7-0-3016" id="h7-0-3016" class="d">-		Returns:
</a><a href="#h7-0-3017" id="h7-0-3017" class="d">-			A urllib2.OpenerDirector object.
</a><a href="#h7-0-3018" id="h7-0-3018" class="d">-		&quot;&quot;&quot;
</a><a href="#h7-0-3019" id="h7-0-3019" class="d">-		opener = urllib2.OpenerDirector()
</a><a href="#h7-0-3020" id="h7-0-3020" class="d">-		opener.add_handler(urllib2.ProxyHandler())
</a><a href="#h7-0-3021" id="h7-0-3021" class="d">-		opener.add_handler(urllib2.UnknownHandler())
</a><a href="#h7-0-3022" id="h7-0-3022" class="d">-		opener.add_handler(urllib2.HTTPHandler())
</a><a href="#h7-0-3023" id="h7-0-3023" class="d">-		opener.add_handler(urllib2.HTTPDefaultErrorHandler())
</a><a href="#h7-0-3024" id="h7-0-3024" class="d">-		opener.add_handler(urllib2.HTTPSHandler())
</a><a href="#h7-0-3025" id="h7-0-3025" class="d">-		opener.add_handler(urllib2.HTTPErrorProcessor())
</a><a href="#h7-0-3026" id="h7-0-3026" class="d">-		if self.save_cookies:
</a><a href="#h7-0-3027" id="h7-0-3027" class="d">-			self.cookie_file = os.path.expanduser(&quot;~/.codereview_upload_cookies_&quot; + server)
</a><a href="#h7-0-3028" id="h7-0-3028" class="d">-			self.cookie_jar = cookielib.MozillaCookieJar(self.cookie_file)
</a><a href="#h7-0-3029" id="h7-0-3029" class="d">-			if os.path.exists(self.cookie_file):
</a><a href="#h7-0-3030" id="h7-0-3030" class="d">-				try:
</a><a href="#h7-0-3031" id="h7-0-3031" class="d">-					self.cookie_jar.load()
</a><a href="#h7-0-3032" id="h7-0-3032" class="d">-					self.authenticated = True
</a><a href="#h7-0-3033" id="h7-0-3033" class="d">-					StatusUpdate(&quot;Loaded authentication cookies from %s&quot; % self.cookie_file)
</a><a href="#h7-0-3034" id="h7-0-3034" class="d">-				except (cookielib.LoadError, IOError):
</a><a href="#h7-0-3035" id="h7-0-3035" class="d">-					# Failed to load cookies - just ignore them.
</a><a href="#h7-0-3036" id="h7-0-3036" class="d">-					pass
</a><a href="#h7-0-3037" id="h7-0-3037" class="d">-			else:
</a><a href="#h7-0-3038" id="h7-0-3038" class="d">-				# Create an empty cookie file with mode 600
</a><a href="#h7-0-3039" id="h7-0-3039" class="d">-				fd = os.open(self.cookie_file, os.O_CREAT, 0600)
</a><a href="#h7-0-3040" id="h7-0-3040" class="d">-				os.close(fd)
</a><a href="#h7-0-3041" id="h7-0-3041" class="d">-			# Always chmod the cookie file
</a><a href="#h7-0-3042" id="h7-0-3042" class="d">-			os.chmod(self.cookie_file, 0600)
</a><a href="#h7-0-3043" id="h7-0-3043" class="d">-		else:
</a><a href="#h7-0-3044" id="h7-0-3044" class="d">-			# Don&#39;t save cookies across runs of update.py.
</a><a href="#h7-0-3045" id="h7-0-3045" class="d">-			self.cookie_jar = cookielib.CookieJar()
</a><a href="#h7-0-3046" id="h7-0-3046" class="d">-		opener.add_handler(urllib2.HTTPCookieProcessor(self.cookie_jar))
</a><a href="#h7-0-3047" id="h7-0-3047" class="d">-		return opener
</a><a href="#h7-0-3048" id="h7-0-3048" class="d">-
</a><a href="#h7-0-3049" id="h7-0-3049" class="d">-
</a><a href="#h7-0-3050" id="h7-0-3050" class="d">-def GetRpcServer(options):
</a><a href="#h7-0-3051" id="h7-0-3051" class="d">-	&quot;&quot;&quot;Returns an instance of an AbstractRpcServer.
</a><a href="#h7-0-3052" id="h7-0-3052" class="d">-
</a><a href="#h7-0-3053" id="h7-0-3053" class="d">-	Returns:
</a><a href="#h7-0-3054" id="h7-0-3054" class="d">-		A new AbstractRpcServer, on which RPC calls can be made.
</a><a href="#h7-0-3055" id="h7-0-3055" class="d">-	&quot;&quot;&quot;
</a><a href="#h7-0-3056" id="h7-0-3056" class="d">-
</a><a href="#h7-0-3057" id="h7-0-3057" class="d">-	rpc_server_class = HttpRpcServer
</a><a href="#h7-0-3058" id="h7-0-3058" class="d">-
</a><a href="#h7-0-3059" id="h7-0-3059" class="d">-	def GetUserCredentials():
</a><a href="#h7-0-3060" id="h7-0-3060" class="d">-		&quot;&quot;&quot;Prompts the user for a username and password.&quot;&quot;&quot;
</a><a href="#h7-0-3061" id="h7-0-3061" class="d">-		# Disable status prints so they don&#39;t obscure the password prompt.
</a><a href="#h7-0-3062" id="h7-0-3062" class="d">-		global global_status
</a><a href="#h7-0-3063" id="h7-0-3063" class="d">-		st = global_status
</a><a href="#h7-0-3064" id="h7-0-3064" class="d">-		global_status = None
</a><a href="#h7-0-3065" id="h7-0-3065" class="d">-
</a><a href="#h7-0-3066" id="h7-0-3066" class="d">-		email = options.email
</a><a href="#h7-0-3067" id="h7-0-3067" class="d">-		if email is None:
</a><a href="#h7-0-3068" id="h7-0-3068" class="d">-			email = GetEmail(&quot;Email (login for uploading to %s)&quot; % options.server)
</a><a href="#h7-0-3069" id="h7-0-3069" class="d">-		password = getpass.getpass(&quot;Password for %s: &quot; % email)
</a><a href="#h7-0-3070" id="h7-0-3070" class="d">-
</a><a href="#h7-0-3071" id="h7-0-3071" class="d">-		# Put status back.
</a><a href="#h7-0-3072" id="h7-0-3072" class="d">-		global_status = st
</a><a href="#h7-0-3073" id="h7-0-3073" class="d">-		return (email, password)
</a><a href="#h7-0-3074" id="h7-0-3074" class="d">-
</a><a href="#h7-0-3075" id="h7-0-3075" class="d">-	# If this is the dev_appserver, use fake authentication.
</a><a href="#h7-0-3076" id="h7-0-3076" class="d">-	host = (options.host or options.server).lower()
</a><a href="#h7-0-3077" id="h7-0-3077" class="d">-	if host == &quot;localhost&quot; or host.startswith(&quot;localhost:&quot;):
</a><a href="#h7-0-3078" id="h7-0-3078" class="d">-		email = options.email
</a><a href="#h7-0-3079" id="h7-0-3079" class="d">-		if email is None:
</a><a href="#h7-0-3080" id="h7-0-3080" class="d">-			email = &quot;test@example.com&quot;
</a><a href="#h7-0-3081" id="h7-0-3081" class="d">-			logging.info(&quot;Using debug user %s.  Override with --email&quot; % email)
</a><a href="#h7-0-3082" id="h7-0-3082" class="d">-		server = rpc_server_class(
</a><a href="#h7-0-3083" id="h7-0-3083" class="d">-				options.server,
</a><a href="#h7-0-3084" id="h7-0-3084" class="d">-				lambda: (email, &quot;password&quot;),
</a><a href="#h7-0-3085" id="h7-0-3085" class="d">-				host_override=options.host,
</a><a href="#h7-0-3086" id="h7-0-3086" class="d">-				extra_headers={&quot;Cookie&quot;: &#39;dev_appserver_login=&quot;%s:False&quot;&#39; % email},
</a><a href="#h7-0-3087" id="h7-0-3087" class="d">-				save_cookies=options.save_cookies)
</a><a href="#h7-0-3088" id="h7-0-3088" class="d">-		# Don&#39;t try to talk to ClientLogin.
</a><a href="#h7-0-3089" id="h7-0-3089" class="d">-		server.authenticated = True
</a><a href="#h7-0-3090" id="h7-0-3090" class="d">-		return server
</a><a href="#h7-0-3091" id="h7-0-3091" class="d">-
</a><a href="#h7-0-3092" id="h7-0-3092" class="d">-	return rpc_server_class(options.server, GetUserCredentials,
</a><a href="#h7-0-3093" id="h7-0-3093" class="d">-		host_override=options.host, save_cookies=options.save_cookies)
</a><a href="#h7-0-3094" id="h7-0-3094" class="d">-
</a><a href="#h7-0-3095" id="h7-0-3095" class="d">-
</a><a href="#h7-0-3096" id="h7-0-3096" class="d">-def EncodeMultipartFormData(fields, files):
</a><a href="#h7-0-3097" id="h7-0-3097" class="d">-	&quot;&quot;&quot;Encode form fields for multipart/form-data.
</a><a href="#h7-0-3098" id="h7-0-3098" class="d">-
</a><a href="#h7-0-3099" id="h7-0-3099" class="d">-	Args:
</a><a href="#h7-0-3100" id="h7-0-3100" class="d">-		fields: A sequence of (name, value) elements for regular form fields.
</a><a href="#h7-0-3101" id="h7-0-3101" class="d">-		files: A sequence of (name, filename, value) elements for data to be
</a><a href="#h7-0-3102" id="h7-0-3102" class="d">-					uploaded as files.
</a><a href="#h7-0-3103" id="h7-0-3103" class="d">-	Returns:
</a><a href="#h7-0-3104" id="h7-0-3104" class="d">-		(content_type, body) ready for httplib.HTTP instance.
</a><a href="#h7-0-3105" id="h7-0-3105" class="d">-
</a><a href="#h7-0-3106" id="h7-0-3106" class="d">-	Source:
</a><a href="#h7-0-3107" id="h7-0-3107" class="d">-		http://aspn.activestate.com/ASPN/Cookbook/Python/Recipe/146306
</a><a href="#h7-0-3108" id="h7-0-3108" class="d">-	&quot;&quot;&quot;
</a><a href="#h7-0-3109" id="h7-0-3109" class="d">-	BOUNDARY = &#39;-M-A-G-I-C---B-O-U-N-D-A-R-Y-&#39;
</a><a href="#h7-0-3110" id="h7-0-3110" class="d">-	CRLF = &#39;\r\n&#39;
</a><a href="#h7-0-3111" id="h7-0-3111" class="d">-	lines = []
</a><a href="#h7-0-3112" id="h7-0-3112" class="d">-	for (key, value) in fields:
</a><a href="#h7-0-3113" id="h7-0-3113" class="d">-		typecheck(key, str)
</a><a href="#h7-0-3114" id="h7-0-3114" class="d">-		typecheck(value, str)
</a><a href="#h7-0-3115" id="h7-0-3115" class="d">-		lines.append(&#39;--&#39; + BOUNDARY)
</a><a href="#h7-0-3116" id="h7-0-3116" class="d">-		lines.append(&#39;Content-Disposition: form-data; name=&quot;%s&quot;&#39; % key)
</a><a href="#h7-0-3117" id="h7-0-3117" class="d">-		lines.append(&#39;&#39;)
</a><a href="#h7-0-3118" id="h7-0-3118" class="d">-		lines.append(value)
</a><a href="#h7-0-3119" id="h7-0-3119" class="d">-	for (key, filename, value) in files:
</a><a href="#h7-0-3120" id="h7-0-3120" class="d">-		typecheck(key, str)
</a><a href="#h7-0-3121" id="h7-0-3121" class="d">-		typecheck(filename, str)
</a><a href="#h7-0-3122" id="h7-0-3122" class="d">-		typecheck(value, str)
</a><a href="#h7-0-3123" id="h7-0-3123" class="d">-		lines.append(&#39;--&#39; + BOUNDARY)
</a><a href="#h7-0-3124" id="h7-0-3124" class="d">-		lines.append(&#39;Content-Disposition: form-data; name=&quot;%s&quot;; filename=&quot;%s&quot;&#39; % (key, filename))
</a><a href="#h7-0-3125" id="h7-0-3125" class="d">-		lines.append(&#39;Content-Type: %s&#39; % GetContentType(filename))
</a><a href="#h7-0-3126" id="h7-0-3126" class="d">-		lines.append(&#39;&#39;)
</a><a href="#h7-0-3127" id="h7-0-3127" class="d">-		lines.append(value)
</a><a href="#h7-0-3128" id="h7-0-3128" class="d">-	lines.append(&#39;--&#39; + BOUNDARY + &#39;--&#39;)
</a><a href="#h7-0-3129" id="h7-0-3129" class="d">-	lines.append(&#39;&#39;)
</a><a href="#h7-0-3130" id="h7-0-3130" class="d">-	body = CRLF.join(lines)
</a><a href="#h7-0-3131" id="h7-0-3131" class="d">-	content_type = &#39;multipart/form-data; boundary=%s&#39; % BOUNDARY
</a><a href="#h7-0-3132" id="h7-0-3132" class="d">-	return content_type, body
</a><a href="#h7-0-3133" id="h7-0-3133" class="d">-
</a><a href="#h7-0-3134" id="h7-0-3134" class="d">-
</a><a href="#h7-0-3135" id="h7-0-3135" class="d">-def GetContentType(filename):
</a><a href="#h7-0-3136" id="h7-0-3136" class="d">-	&quot;&quot;&quot;Helper to guess the content-type from the filename.&quot;&quot;&quot;
</a><a href="#h7-0-3137" id="h7-0-3137" class="d">-	return mimetypes.guess_type(filename)[0] or &#39;application/octet-stream&#39;
</a><a href="#h7-0-3138" id="h7-0-3138" class="d">-
</a><a href="#h7-0-3139" id="h7-0-3139" class="d">-
</a><a href="#h7-0-3140" id="h7-0-3140" class="d">-# Use a shell for subcommands on Windows to get a PATH search.
</a><a href="#h7-0-3141" id="h7-0-3141" class="d">-use_shell = sys.platform.startswith(&quot;win&quot;)
</a><a href="#h7-0-3142" id="h7-0-3142" class="d">-
</a><a href="#h7-0-3143" id="h7-0-3143" class="d">-def RunShellWithReturnCode(command, print_output=False,
</a><a href="#h7-0-3144" id="h7-0-3144" class="d">-		universal_newlines=True, env=os.environ):
</a><a href="#h7-0-3145" id="h7-0-3145" class="d">-	&quot;&quot;&quot;Executes a command and returns the output from stdout and the return code.
</a><a href="#h7-0-3146" id="h7-0-3146" class="d">-
</a><a href="#h7-0-3147" id="h7-0-3147" class="d">-	Args:
</a><a href="#h7-0-3148" id="h7-0-3148" class="d">-		command: Command to execute.
</a><a href="#h7-0-3149" id="h7-0-3149" class="d">-		print_output: If True, the output is printed to stdout.
</a><a href="#h7-0-3150" id="h7-0-3150" class="d">-			If False, both stdout and stderr are ignored.
</a><a href="#h7-0-3151" id="h7-0-3151" class="d">-		universal_newlines: Use universal_newlines flag (default: True).
</a><a href="#h7-0-3152" id="h7-0-3152" class="d">-
</a><a href="#h7-0-3153" id="h7-0-3153" class="d">-	Returns:
</a><a href="#h7-0-3154" id="h7-0-3154" class="d">-		Tuple (output, return code)
</a><a href="#h7-0-3155" id="h7-0-3155" class="d">-	&quot;&quot;&quot;
</a><a href="#h7-0-3156" id="h7-0-3156" class="d">-	logging.info(&quot;Running %s&quot;, command)
</a><a href="#h7-0-3157" id="h7-0-3157" class="d">-	p = subprocess.Popen(command, stdout=subprocess.PIPE, stderr=subprocess.PIPE,
</a><a href="#h7-0-3158" id="h7-0-3158" class="d">-		shell=use_shell, universal_newlines=universal_newlines, env=env)
</a><a href="#h7-0-3159" id="h7-0-3159" class="d">-	if print_output:
</a><a href="#h7-0-3160" id="h7-0-3160" class="d">-		output_array = []
</a><a href="#h7-0-3161" id="h7-0-3161" class="d">-		while True:
</a><a href="#h7-0-3162" id="h7-0-3162" class="d">-			line = p.stdout.readline()
</a><a href="#h7-0-3163" id="h7-0-3163" class="d">-			if not line:
</a><a href="#h7-0-3164" id="h7-0-3164" class="d">-				break
</a><a href="#h7-0-3165" id="h7-0-3165" class="d">-			print line.strip(&quot;\n&quot;)
</a><a href="#h7-0-3166" id="h7-0-3166" class="d">-			output_array.append(line)
</a><a href="#h7-0-3167" id="h7-0-3167" class="d">-		output = &quot;&quot;.join(output_array)
</a><a href="#h7-0-3168" id="h7-0-3168" class="d">-	else:
</a><a href="#h7-0-3169" id="h7-0-3169" class="d">-		output = p.stdout.read()
</a><a href="#h7-0-3170" id="h7-0-3170" class="d">-	p.wait()
</a><a href="#h7-0-3171" id="h7-0-3171" class="d">-	errout = p.stderr.read()
</a><a href="#h7-0-3172" id="h7-0-3172" class="d">-	if print_output and errout:
</a><a href="#h7-0-3173" id="h7-0-3173" class="d">-		print &gt;&gt;sys.stderr, errout
</a><a href="#h7-0-3174" id="h7-0-3174" class="d">-	p.stdout.close()
</a><a href="#h7-0-3175" id="h7-0-3175" class="d">-	p.stderr.close()
</a><a href="#h7-0-3176" id="h7-0-3176" class="d">-	return output, p.returncode
</a><a href="#h7-0-3177" id="h7-0-3177" class="d">-
</a><a href="#h7-0-3178" id="h7-0-3178" class="d">-
</a><a href="#h7-0-3179" id="h7-0-3179" class="d">-def RunShell(command, silent_ok=False, universal_newlines=True,
</a><a href="#h7-0-3180" id="h7-0-3180" class="d">-		print_output=False, env=os.environ):
</a><a href="#h7-0-3181" id="h7-0-3181" class="d">-	data, retcode = RunShellWithReturnCode(command, print_output, universal_newlines, env)
</a><a href="#h7-0-3182" id="h7-0-3182" class="d">-	if retcode:
</a><a href="#h7-0-3183" id="h7-0-3183" class="d">-		ErrorExit(&quot;Got error status from %s:\n%s&quot; % (command, data))
</a><a href="#h7-0-3184" id="h7-0-3184" class="d">-	if not silent_ok and not data:
</a><a href="#h7-0-3185" id="h7-0-3185" class="d">-		ErrorExit(&quot;No output from %s&quot; % command)
</a><a href="#h7-0-3186" id="h7-0-3186" class="d">-	return data
</a><a href="#h7-0-3187" id="h7-0-3187" class="d">-
</a><a href="#h7-0-3188" id="h7-0-3188" class="d">-
</a><a href="#h7-0-3189" id="h7-0-3189" class="d">-class VersionControlSystem(object):
</a><a href="#h7-0-3190" id="h7-0-3190" class="d">-	&quot;&quot;&quot;Abstract base class providing an interface to the VCS.&quot;&quot;&quot;
</a><a href="#h7-0-3191" id="h7-0-3191" class="d">-
</a><a href="#h7-0-3192" id="h7-0-3192" class="d">-	def __init__(self, options):
</a><a href="#h7-0-3193" id="h7-0-3193" class="d">-		&quot;&quot;&quot;Constructor.
</a><a href="#h7-0-3194" id="h7-0-3194" class="d">-
</a><a href="#h7-0-3195" id="h7-0-3195" class="d">-		Args:
</a><a href="#h7-0-3196" id="h7-0-3196" class="d">-			options: Command line options.
</a><a href="#h7-0-3197" id="h7-0-3197" class="d">-		&quot;&quot;&quot;
</a><a href="#h7-0-3198" id="h7-0-3198" class="d">-		self.options = options
</a><a href="#h7-0-3199" id="h7-0-3199" class="d">-
</a><a href="#h7-0-3200" id="h7-0-3200" class="d">-	def GenerateDiff(self, args):
</a><a href="#h7-0-3201" id="h7-0-3201" class="d">-		&quot;&quot;&quot;Return the current diff as a string.
</a><a href="#h7-0-3202" id="h7-0-3202" class="d">-
</a><a href="#h7-0-3203" id="h7-0-3203" class="d">-		Args:
</a><a href="#h7-0-3204" id="h7-0-3204" class="d">-			args: Extra arguments to pass to the diff command.
</a><a href="#h7-0-3205" id="h7-0-3205" class="d">-		&quot;&quot;&quot;
</a><a href="#h7-0-3206" id="h7-0-3206" class="d">-		raise NotImplementedError(
</a><a href="#h7-0-3207" id="h7-0-3207" class="d">-				&quot;abstract method -- subclass %s must override&quot; % self.__class__)
</a><a href="#h7-0-3208" id="h7-0-3208" class="d">-
</a><a href="#h7-0-3209" id="h7-0-3209" class="d">-	def GetUnknownFiles(self):
</a><a href="#h7-0-3210" id="h7-0-3210" class="d">-		&quot;&quot;&quot;Return a list of files unknown to the VCS.&quot;&quot;&quot;
</a><a href="#h7-0-3211" id="h7-0-3211" class="d">-		raise NotImplementedError(
</a><a href="#h7-0-3212" id="h7-0-3212" class="d">-				&quot;abstract method -- subclass %s must override&quot; % self.__class__)
</a><a href="#h7-0-3213" id="h7-0-3213" class="d">-
</a><a href="#h7-0-3214" id="h7-0-3214" class="d">-	def CheckForUnknownFiles(self):
</a><a href="#h7-0-3215" id="h7-0-3215" class="d">-		&quot;&quot;&quot;Show an &quot;are you sure?&quot; prompt if there are unknown files.&quot;&quot;&quot;
</a><a href="#h7-0-3216" id="h7-0-3216" class="d">-		unknown_files = self.GetUnknownFiles()
</a><a href="#h7-0-3217" id="h7-0-3217" class="d">-		if unknown_files:
</a><a href="#h7-0-3218" id="h7-0-3218" class="d">-			print &quot;The following files are not added to version control:&quot;
</a><a href="#h7-0-3219" id="h7-0-3219" class="d">-			for line in unknown_files:
</a><a href="#h7-0-3220" id="h7-0-3220" class="d">-				print line
</a><a href="#h7-0-3221" id="h7-0-3221" class="d">-			prompt = &quot;Are you sure to continue?(y/N) &quot;
</a><a href="#h7-0-3222" id="h7-0-3222" class="d">-			answer = raw_input(prompt).strip()
</a><a href="#h7-0-3223" id="h7-0-3223" class="d">-			if answer != &quot;y&quot;:
</a><a href="#h7-0-3224" id="h7-0-3224" class="d">-				ErrorExit(&quot;User aborted&quot;)
</a><a href="#h7-0-3225" id="h7-0-3225" class="d">-
</a><a href="#h7-0-3226" id="h7-0-3226" class="d">-	def GetBaseFile(self, filename):
</a><a href="#h7-0-3227" id="h7-0-3227" class="d">-		&quot;&quot;&quot;Get the content of the upstream version of a file.
</a><a href="#h7-0-3228" id="h7-0-3228" class="d">-
</a><a href="#h7-0-3229" id="h7-0-3229" class="d">-		Returns:
</a><a href="#h7-0-3230" id="h7-0-3230" class="d">-			A tuple (base_content, new_content, is_binary, status)
</a><a href="#h7-0-3231" id="h7-0-3231" class="d">-				base_content: The contents of the base file.
</a><a href="#h7-0-3232" id="h7-0-3232" class="d">-				new_content: For text files, this is empty.  For binary files, this is
</a><a href="#h7-0-3233" id="h7-0-3233" class="d">-					the contents of the new file, since the diff output won&#39;t contain
</a><a href="#h7-0-3234" id="h7-0-3234" class="d">-					information to reconstruct the current file.
</a><a href="#h7-0-3235" id="h7-0-3235" class="d">-				is_binary: True iff the file is binary.
</a><a href="#h7-0-3236" id="h7-0-3236" class="d">-				status: The status of the file.
</a><a href="#h7-0-3237" id="h7-0-3237" class="d">-		&quot;&quot;&quot;
</a><a href="#h7-0-3238" id="h7-0-3238" class="d">-
</a><a href="#h7-0-3239" id="h7-0-3239" class="d">-		raise NotImplementedError(
</a><a href="#h7-0-3240" id="h7-0-3240" class="d">-				&quot;abstract method -- subclass %s must override&quot; % self.__class__)
</a><a href="#h7-0-3241" id="h7-0-3241" class="d">-
</a><a href="#h7-0-3242" id="h7-0-3242" class="d">-
</a><a href="#h7-0-3243" id="h7-0-3243" class="d">-	def GetBaseFiles(self, diff):
</a><a href="#h7-0-3244" id="h7-0-3244" class="d">-		&quot;&quot;&quot;Helper that calls GetBase file for each file in the patch.
</a><a href="#h7-0-3245" id="h7-0-3245" class="d">-
</a><a href="#h7-0-3246" id="h7-0-3246" class="d">-		Returns:
</a><a href="#h7-0-3247" id="h7-0-3247" class="d">-			A dictionary that maps from filename to GetBaseFile&#39;s tuple.  Filenames
</a><a href="#h7-0-3248" id="h7-0-3248" class="d">-			are retrieved based on lines that start with &quot;Index:&quot; or
</a><a href="#h7-0-3249" id="h7-0-3249" class="d">-			&quot;Property changes on:&quot;.
</a><a href="#h7-0-3250" id="h7-0-3250" class="d">-		&quot;&quot;&quot;
</a><a href="#h7-0-3251" id="h7-0-3251" class="d">-		files = {}
</a><a href="#h7-0-3252" id="h7-0-3252" class="d">-		for line in diff.splitlines(True):
</a><a href="#h7-0-3253" id="h7-0-3253" class="d">-			if line.startswith(&#39;Index:&#39;) or line.startswith(&#39;Property changes on:&#39;):
</a><a href="#h7-0-3254" id="h7-0-3254" class="d">-				unused, filename = line.split(&#39;:&#39;, 1)
</a><a href="#h7-0-3255" id="h7-0-3255" class="d">-				# On Windows if a file has property changes its filename uses &#39;\&#39;
</a><a href="#h7-0-3256" id="h7-0-3256" class="d">-				# instead of &#39;/&#39;.
</a><a href="#h7-0-3257" id="h7-0-3257" class="d">-				filename = to_slash(filename.strip())
</a><a href="#h7-0-3258" id="h7-0-3258" class="d">-				files[filename] = self.GetBaseFile(filename)
</a><a href="#h7-0-3259" id="h7-0-3259" class="d">-		return files
</a><a href="#h7-0-3260" id="h7-0-3260" class="d">-
</a><a href="#h7-0-3261" id="h7-0-3261" class="d">-
</a><a href="#h7-0-3262" id="h7-0-3262" class="d">-	def UploadBaseFiles(self, issue, rpc_server, patch_list, patchset, options,
</a><a href="#h7-0-3263" id="h7-0-3263" class="d">-											files):
</a><a href="#h7-0-3264" id="h7-0-3264" class="d">-		&quot;&quot;&quot;Uploads the base files (and if necessary, the current ones as well).&quot;&quot;&quot;
</a><a href="#h7-0-3265" id="h7-0-3265" class="d">-
</a><a href="#h7-0-3266" id="h7-0-3266" class="d">-		def UploadFile(filename, file_id, content, is_binary, status, is_base):
</a><a href="#h7-0-3267" id="h7-0-3267" class="d">-			&quot;&quot;&quot;Uploads a file to the server.&quot;&quot;&quot;
</a><a href="#h7-0-3268" id="h7-0-3268" class="d">-			set_status(&quot;uploading &quot; + filename)
</a><a href="#h7-0-3269" id="h7-0-3269" class="d">-			file_too_large = False
</a><a href="#h7-0-3270" id="h7-0-3270" class="d">-			if is_base:
</a><a href="#h7-0-3271" id="h7-0-3271" class="d">-				type = &quot;base&quot;
</a><a href="#h7-0-3272" id="h7-0-3272" class="d">-			else:
</a><a href="#h7-0-3273" id="h7-0-3273" class="d">-				type = &quot;current&quot;
</a><a href="#h7-0-3274" id="h7-0-3274" class="d">-			if len(content) &gt; MAX_UPLOAD_SIZE:
</a><a href="#h7-0-3275" id="h7-0-3275" class="d">-				print (&quot;Not uploading the %s file for %s because it&#39;s too large.&quot; %
</a><a href="#h7-0-3276" id="h7-0-3276" class="d">-							(type, filename))
</a><a href="#h7-0-3277" id="h7-0-3277" class="d">-				file_too_large = True
</a><a href="#h7-0-3278" id="h7-0-3278" class="d">-				content = &quot;&quot;
</a><a href="#h7-0-3279" id="h7-0-3279" class="d">-			checksum = md5(content).hexdigest()
</a><a href="#h7-0-3280" id="h7-0-3280" class="d">-			if options.verbose &gt; 0 and not file_too_large:
</a><a href="#h7-0-3281" id="h7-0-3281" class="d">-				print &quot;Uploading %s file for %s&quot; % (type, filename)
</a><a href="#h7-0-3282" id="h7-0-3282" class="d">-			url = &quot;/%d/upload_content/%d/%d&quot; % (int(issue), int(patchset), file_id)
</a><a href="#h7-0-3283" id="h7-0-3283" class="d">-			form_fields = [
</a><a href="#h7-0-3284" id="h7-0-3284" class="d">-				(&quot;filename&quot;, filename),
</a><a href="#h7-0-3285" id="h7-0-3285" class="d">-				(&quot;status&quot;, status),
</a><a href="#h7-0-3286" id="h7-0-3286" class="d">-				(&quot;checksum&quot;, checksum),
</a><a href="#h7-0-3287" id="h7-0-3287" class="d">-				(&quot;is_binary&quot;, str(is_binary)),
</a><a href="#h7-0-3288" id="h7-0-3288" class="d">-				(&quot;is_current&quot;, str(not is_base)),
</a><a href="#h7-0-3289" id="h7-0-3289" class="d">-			]
</a><a href="#h7-0-3290" id="h7-0-3290" class="d">-			if file_too_large:
</a><a href="#h7-0-3291" id="h7-0-3291" class="d">-				form_fields.append((&quot;file_too_large&quot;, &quot;1&quot;))
</a><a href="#h7-0-3292" id="h7-0-3292" class="d">-			if options.email:
</a><a href="#h7-0-3293" id="h7-0-3293" class="d">-				form_fields.append((&quot;user&quot;, options.email))
</a><a href="#h7-0-3294" id="h7-0-3294" class="d">-			ctype, body = EncodeMultipartFormData(form_fields, [(&quot;data&quot;, filename, content)])
</a><a href="#h7-0-3295" id="h7-0-3295" class="d">-			response_body = rpc_server.Send(url, body, content_type=ctype)
</a><a href="#h7-0-3296" id="h7-0-3296" class="d">-			if not response_body.startswith(&quot;OK&quot;):
</a><a href="#h7-0-3297" id="h7-0-3297" class="d">-				StatusUpdate(&quot;  --&gt; %s&quot; % response_body)
</a><a href="#h7-0-3298" id="h7-0-3298" class="d">-				sys.exit(1)
</a><a href="#h7-0-3299" id="h7-0-3299" class="d">-
</a><a href="#h7-0-3300" id="h7-0-3300" class="d">-		# Don&#39;t want to spawn too many threads, nor do we want to
</a><a href="#h7-0-3301" id="h7-0-3301" class="d">-		# hit Rietveld too hard, or it will start serving 500 errors.
</a><a href="#h7-0-3302" id="h7-0-3302" class="d">-		# When 8 works, it&#39;s no better than 4, and sometimes 8 is
</a><a href="#h7-0-3303" id="h7-0-3303" class="d">-		# too many for Rietveld to handle.
</a><a href="#h7-0-3304" id="h7-0-3304" class="d">-		MAX_PARALLEL_UPLOADS = 4
</a><a href="#h7-0-3305" id="h7-0-3305" class="d">-
</a><a href="#h7-0-3306" id="h7-0-3306" class="d">-		sema = threading.BoundedSemaphore(MAX_PARALLEL_UPLOADS)
</a><a href="#h7-0-3307" id="h7-0-3307" class="d">-		upload_threads = []
</a><a href="#h7-0-3308" id="h7-0-3308" class="d">-		finished_upload_threads = []
</a><a href="#h7-0-3309" id="h7-0-3309" class="d">-		
</a><a href="#h7-0-3310" id="h7-0-3310" class="d">-		class UploadFileThread(threading.Thread):
</a><a href="#h7-0-3311" id="h7-0-3311" class="d">-			def __init__(self, args):
</a><a href="#h7-0-3312" id="h7-0-3312" class="d">-				threading.Thread.__init__(self)
</a><a href="#h7-0-3313" id="h7-0-3313" class="d">-				self.args = args
</a><a href="#h7-0-3314" id="h7-0-3314" class="d">-			def run(self):
</a><a href="#h7-0-3315" id="h7-0-3315" class="d">-				UploadFile(*self.args)
</a><a href="#h7-0-3316" id="h7-0-3316" class="d">-				finished_upload_threads.append(self)
</a><a href="#h7-0-3317" id="h7-0-3317" class="d">-				sema.release()
</a><a href="#h7-0-3318" id="h7-0-3318" class="d">-
</a><a href="#h7-0-3319" id="h7-0-3319" class="d">-		def StartUploadFile(*args):
</a><a href="#h7-0-3320" id="h7-0-3320" class="d">-			sema.acquire()
</a><a href="#h7-0-3321" id="h7-0-3321" class="d">-			while len(finished_upload_threads) &gt; 0:
</a><a href="#h7-0-3322" id="h7-0-3322" class="d">-				t = finished_upload_threads.pop()
</a><a href="#h7-0-3323" id="h7-0-3323" class="d">-				upload_threads.remove(t)
</a><a href="#h7-0-3324" id="h7-0-3324" class="d">-				t.join()
</a><a href="#h7-0-3325" id="h7-0-3325" class="d">-			t = UploadFileThread(args)
</a><a href="#h7-0-3326" id="h7-0-3326" class="d">-			upload_threads.append(t)
</a><a href="#h7-0-3327" id="h7-0-3327" class="d">-			t.start()
</a><a href="#h7-0-3328" id="h7-0-3328" class="d">-
</a><a href="#h7-0-3329" id="h7-0-3329" class="d">-		def WaitForUploads():			
</a><a href="#h7-0-3330" id="h7-0-3330" class="d">-			for t in upload_threads:
</a><a href="#h7-0-3331" id="h7-0-3331" class="d">-				t.join()
</a><a href="#h7-0-3332" id="h7-0-3332" class="d">-
</a><a href="#h7-0-3333" id="h7-0-3333" class="d">-		patches = dict()
</a><a href="#h7-0-3334" id="h7-0-3334" class="d">-		[patches.setdefault(v, k) for k, v in patch_list]
</a><a href="#h7-0-3335" id="h7-0-3335" class="d">-		for filename in patches.keys():
</a><a href="#h7-0-3336" id="h7-0-3336" class="d">-			base_content, new_content, is_binary, status = files[filename]
</a><a href="#h7-0-3337" id="h7-0-3337" class="d">-			file_id_str = patches.get(filename)
</a><a href="#h7-0-3338" id="h7-0-3338" class="d">-			if file_id_str.find(&quot;nobase&quot;) != -1:
</a><a href="#h7-0-3339" id="h7-0-3339" class="d">-				base_content = None
</a><a href="#h7-0-3340" id="h7-0-3340" class="d">-				file_id_str = file_id_str[file_id_str.rfind(&quot;_&quot;) + 1:]
</a><a href="#h7-0-3341" id="h7-0-3341" class="d">-			file_id = int(file_id_str)
</a><a href="#h7-0-3342" id="h7-0-3342" class="d">-			if base_content != None:
</a><a href="#h7-0-3343" id="h7-0-3343" class="d">-				StartUploadFile(filename, file_id, base_content, is_binary, status, True)
</a><a href="#h7-0-3344" id="h7-0-3344" class="d">-			if new_content != None:
</a><a href="#h7-0-3345" id="h7-0-3345" class="d">-				StartUploadFile(filename, file_id, new_content, is_binary, status, False)
</a><a href="#h7-0-3346" id="h7-0-3346" class="d">-		WaitForUploads()
</a><a href="#h7-0-3347" id="h7-0-3347" class="d">-
</a><a href="#h7-0-3348" id="h7-0-3348" class="d">-	def IsImage(self, filename):
</a><a href="#h7-0-3349" id="h7-0-3349" class="d">-		&quot;&quot;&quot;Returns true if the filename has an image extension.&quot;&quot;&quot;
</a><a href="#h7-0-3350" id="h7-0-3350" class="d">-		mimetype =  mimetypes.guess_type(filename)[0]
</a><a href="#h7-0-3351" id="h7-0-3351" class="d">-		if not mimetype:
</a><a href="#h7-0-3352" id="h7-0-3352" class="d">-			return False
</a><a href="#h7-0-3353" id="h7-0-3353" class="d">-		return mimetype.startswith(&quot;image/&quot;)
</a><a href="#h7-0-3354" id="h7-0-3354" class="d">-
</a><a href="#h7-0-3355" id="h7-0-3355" class="d">-	def IsBinary(self, filename):
</a><a href="#h7-0-3356" id="h7-0-3356" class="d">-		&quot;&quot;&quot;Returns true if the guessed mimetyped isnt&#39;t in text group.&quot;&quot;&quot;
</a><a href="#h7-0-3357" id="h7-0-3357" class="d">-		mimetype = mimetypes.guess_type(filename)[0]
</a><a href="#h7-0-3358" id="h7-0-3358" class="d">-		if not mimetype:
</a><a href="#h7-0-3359" id="h7-0-3359" class="d">-			return False  # e.g. README, &quot;real&quot; binaries usually have an extension
</a><a href="#h7-0-3360" id="h7-0-3360" class="d">-		# special case for text files which don&#39;t start with text/
</a><a href="#h7-0-3361" id="h7-0-3361" class="d">-		if mimetype in TEXT_MIMETYPES:
</a><a href="#h7-0-3362" id="h7-0-3362" class="d">-			return False
</a><a href="#h7-0-3363" id="h7-0-3363" class="d">-		return not mimetype.startswith(&quot;text/&quot;)
</a><a href="#h7-0-3364" id="h7-0-3364" class="d">-
</a><a href="#h7-0-3365" id="h7-0-3365" class="d">-
</a><a href="#h7-0-3366" id="h7-0-3366" class="d">-class FakeMercurialUI(object):
</a><a href="#h7-0-3367" id="h7-0-3367" class="d">-	def __init__(self):
</a><a href="#h7-0-3368" id="h7-0-3368" class="d">-		self.quiet = True
</a><a href="#h7-0-3369" id="h7-0-3369" class="d">-		self.output = &#39;&#39;
</a><a href="#h7-0-3370" id="h7-0-3370" class="d">-	
</a><a href="#h7-0-3371" id="h7-0-3371" class="d">-	def write(self, *args, **opts):
</a><a href="#h7-0-3372" id="h7-0-3372" class="d">-		self.output += &#39; &#39;.join(args)
</a><a href="#h7-0-3373" id="h7-0-3373" class="d">-	def copy(self):
</a><a href="#h7-0-3374" id="h7-0-3374" class="d">-		return self
</a><a href="#h7-0-3375" id="h7-0-3375" class="d">-	def status(self, *args, **opts):
</a><a href="#h7-0-3376" id="h7-0-3376" class="d">-		pass
</a><a href="#h7-0-3377" id="h7-0-3377" class="d">-
</a><a href="#h7-0-3378" id="h7-0-3378" class="d">-	def formatter(self, topic, opts):
</a><a href="#h7-0-3379" id="h7-0-3379" class="d">-		from mercurial.formatter import plainformatter
</a><a href="#h7-0-3380" id="h7-0-3380" class="d">-		return plainformatter(self, topic, opts)
</a><a href="#h7-0-3381" id="h7-0-3381" class="d">-	
</a><a href="#h7-0-3382" id="h7-0-3382" class="d">-	def readconfig(self, *args, **opts):
</a><a href="#h7-0-3383" id="h7-0-3383" class="d">-		pass
</a><a href="#h7-0-3384" id="h7-0-3384" class="d">-	def expandpath(self, *args, **opts):
</a><a href="#h7-0-3385" id="h7-0-3385" class="d">-		return global_ui.expandpath(*args, **opts)
</a><a href="#h7-0-3386" id="h7-0-3386" class="d">-	def configitems(self, *args, **opts):
</a><a href="#h7-0-3387" id="h7-0-3387" class="d">-		return global_ui.configitems(*args, **opts)
</a><a href="#h7-0-3388" id="h7-0-3388" class="d">-	def config(self, *args, **opts):
</a><a href="#h7-0-3389" id="h7-0-3389" class="d">-		return global_ui.config(*args, **opts)
</a><a href="#h7-0-3390" id="h7-0-3390" class="d">-
</a><a href="#h7-0-3391" id="h7-0-3391" class="d">-use_hg_shell = False	# set to True to shell out to hg always; slower
</a><a href="#h7-0-3392" id="h7-0-3392" class="d">-
</a><a href="#h7-0-3393" id="h7-0-3393" class="d">-class MercurialVCS(VersionControlSystem):
</a><a href="#h7-0-3394" id="h7-0-3394" class="d">-	&quot;&quot;&quot;Implementation of the VersionControlSystem interface for Mercurial.&quot;&quot;&quot;
</a><a href="#h7-0-3395" id="h7-0-3395" class="d">-
</a><a href="#h7-0-3396" id="h7-0-3396" class="d">-	def __init__(self, options, ui, repo):
</a><a href="#h7-0-3397" id="h7-0-3397" class="d">-		super(MercurialVCS, self).__init__(options)
</a><a href="#h7-0-3398" id="h7-0-3398" class="d">-		self.ui = ui
</a><a href="#h7-0-3399" id="h7-0-3399" class="d">-		self.repo = repo
</a><a href="#h7-0-3400" id="h7-0-3400" class="d">-		self.status = None
</a><a href="#h7-0-3401" id="h7-0-3401" class="d">-		# Absolute path to repository (we can be in a subdir)
</a><a href="#h7-0-3402" id="h7-0-3402" class="d">-		self.repo_dir = os.path.normpath(repo.root)
</a><a href="#h7-0-3403" id="h7-0-3403" class="d">-		# Compute the subdir
</a><a href="#h7-0-3404" id="h7-0-3404" class="d">-		cwd = os.path.normpath(os.getcwd())
</a><a href="#h7-0-3405" id="h7-0-3405" class="d">-		assert cwd.startswith(self.repo_dir)
</a><a href="#h7-0-3406" id="h7-0-3406" class="d">-		self.subdir = cwd[len(self.repo_dir):].lstrip(r&quot;\/&quot;)
</a><a href="#h7-0-3407" id="h7-0-3407" class="d">-		if self.options.revision:
</a><a href="#h7-0-3408" id="h7-0-3408" class="d">-			self.base_rev = self.options.revision
</a><a href="#h7-0-3409" id="h7-0-3409" class="d">-		else:
</a><a href="#h7-0-3410" id="h7-0-3410" class="d">-			mqparent, err = RunShellWithReturnCode([&#39;hg&#39;, &#39;log&#39;, &#39;--rev&#39;, &#39;qparent&#39;, &#39;--template={node}&#39;])
</a><a href="#h7-0-3411" id="h7-0-3411" class="d">-			if not err and mqparent != &quot;&quot;:
</a><a href="#h7-0-3412" id="h7-0-3412" class="d">-				self.base_rev = mqparent
</a><a href="#h7-0-3413" id="h7-0-3413" class="d">-			else:
</a><a href="#h7-0-3414" id="h7-0-3414" class="d">-				out = RunShell([&quot;hg&quot;, &quot;parents&quot;, &quot;-q&quot;], silent_ok=True).strip()
</a><a href="#h7-0-3415" id="h7-0-3415" class="d">-				if not out:
</a><a href="#h7-0-3416" id="h7-0-3416" class="d">-					# No revisions; use 0 to mean a repository with nothing.
</a><a href="#h7-0-3417" id="h7-0-3417" class="d">-					out = &quot;0:0&quot;
</a><a href="#h7-0-3418" id="h7-0-3418" class="d">-				self.base_rev = out.split(&#39;:&#39;)[1].strip()
</a><a href="#h7-0-3419" id="h7-0-3419" class="d">-	def _GetRelPath(self, filename):
</a><a href="#h7-0-3420" id="h7-0-3420" class="d">-		&quot;&quot;&quot;Get relative path of a file according to the current directory,
</a><a href="#h7-0-3421" id="h7-0-3421" class="d">-		given its logical path in the repo.&quot;&quot;&quot;
</a><a href="#h7-0-3422" id="h7-0-3422" class="d">-		assert filename.startswith(self.subdir), (filename, self.subdir)
</a><a href="#h7-0-3423" id="h7-0-3423" class="d">-		return filename[len(self.subdir):].lstrip(r&quot;\/&quot;)
</a><a href="#h7-0-3424" id="h7-0-3424" class="d">-
</a><a href="#h7-0-3425" id="h7-0-3425" class="d">-	def GenerateDiff(self, extra_args):
</a><a href="#h7-0-3426" id="h7-0-3426" class="d">-		# If no file specified, restrict to the current subdir
</a><a href="#h7-0-3427" id="h7-0-3427" class="d">-		extra_args = extra_args or [&quot;.&quot;]
</a><a href="#h7-0-3428" id="h7-0-3428" class="d">-		cmd = [&quot;hg&quot;, &quot;diff&quot;, &quot;--git&quot;, &quot;-r&quot;, self.base_rev] + extra_args
</a><a href="#h7-0-3429" id="h7-0-3429" class="d">-		data = RunShell(cmd, silent_ok=True)
</a><a href="#h7-0-3430" id="h7-0-3430" class="d">-		svndiff = []
</a><a href="#h7-0-3431" id="h7-0-3431" class="d">-		filecount = 0
</a><a href="#h7-0-3432" id="h7-0-3432" class="d">-		for line in data.splitlines():
</a><a href="#h7-0-3433" id="h7-0-3433" class="d">-			m = re.match(&quot;diff --git a/(\S+) b/(\S+)&quot;, line)
</a><a href="#h7-0-3434" id="h7-0-3434" class="d">-			if m:
</a><a href="#h7-0-3435" id="h7-0-3435" class="d">-				# Modify line to make it look like as it comes from svn diff.
</a><a href="#h7-0-3436" id="h7-0-3436" class="d">-				# With this modification no changes on the server side are required
</a><a href="#h7-0-3437" id="h7-0-3437" class="d">-				# to make upload.py work with Mercurial repos.
</a><a href="#h7-0-3438" id="h7-0-3438" class="d">-				# NOTE: for proper handling of moved/copied files, we have to use
</a><a href="#h7-0-3439" id="h7-0-3439" class="d">-				# the second filename.
</a><a href="#h7-0-3440" id="h7-0-3440" class="d">-				filename = m.group(2)
</a><a href="#h7-0-3441" id="h7-0-3441" class="d">-				svndiff.append(&quot;Index: %s&quot; % filename)
</a><a href="#h7-0-3442" id="h7-0-3442" class="d">-				svndiff.append(&quot;=&quot; * 67)
</a><a href="#h7-0-3443" id="h7-0-3443" class="d">-				filecount += 1
</a><a href="#h7-0-3444" id="h7-0-3444" class="d">-				logging.info(line)
</a><a href="#h7-0-3445" id="h7-0-3445" class="d">-			else:
</a><a href="#h7-0-3446" id="h7-0-3446" class="d">-				svndiff.append(line)
</a><a href="#h7-0-3447" id="h7-0-3447" class="d">-		if not filecount:
</a><a href="#h7-0-3448" id="h7-0-3448" class="d">-			ErrorExit(&quot;No valid patches found in output from hg diff&quot;)
</a><a href="#h7-0-3449" id="h7-0-3449" class="d">-		return &quot;\n&quot;.join(svndiff) + &quot;\n&quot;
</a><a href="#h7-0-3450" id="h7-0-3450" class="d">-
</a><a href="#h7-0-3451" id="h7-0-3451" class="d">-	def GetUnknownFiles(self):
</a><a href="#h7-0-3452" id="h7-0-3452" class="d">-		&quot;&quot;&quot;Return a list of files unknown to the VCS.&quot;&quot;&quot;
</a><a href="#h7-0-3453" id="h7-0-3453" class="d">-		args = []
</a><a href="#h7-0-3454" id="h7-0-3454" class="d">-		status = RunShell([&quot;hg&quot;, &quot;status&quot;, &quot;--rev&quot;, self.base_rev, &quot;-u&quot;, &quot;.&quot;],
</a><a href="#h7-0-3455" id="h7-0-3455" class="d">-				silent_ok=True)
</a><a href="#h7-0-3456" id="h7-0-3456" class="d">-		unknown_files = []
</a><a href="#h7-0-3457" id="h7-0-3457" class="d">-		for line in status.splitlines():
</a><a href="#h7-0-3458" id="h7-0-3458" class="d">-			st, fn = line.split(&quot; &quot;, 1)
</a><a href="#h7-0-3459" id="h7-0-3459" class="d">-			if st == &quot;?&quot;:
</a><a href="#h7-0-3460" id="h7-0-3460" class="d">-				unknown_files.append(fn)
</a><a href="#h7-0-3461" id="h7-0-3461" class="d">-		return unknown_files
</a><a href="#h7-0-3462" id="h7-0-3462" class="d">-
</a><a href="#h7-0-3463" id="h7-0-3463" class="d">-	def get_hg_status(self, rev, path):
</a><a href="#h7-0-3464" id="h7-0-3464" class="d">-		# We&#39;d like to use &#39;hg status -C path&#39;, but that is buggy
</a><a href="#h7-0-3465" id="h7-0-3465" class="d">-		# (see http://mercurial.selenic.com/bts/issue3023).
</a><a href="#h7-0-3466" id="h7-0-3466" class="d">-		# Instead, run &#39;hg status -C&#39; without a path
</a><a href="#h7-0-3467" id="h7-0-3467" class="d">-		# and skim the output for the path we want.
</a><a href="#h7-0-3468" id="h7-0-3468" class="d">-		if self.status is None:
</a><a href="#h7-0-3469" id="h7-0-3469" class="d">-			if use_hg_shell:
</a><a href="#h7-0-3470" id="h7-0-3470" class="d">-				out = RunShell([&quot;hg&quot;, &quot;status&quot;, &quot;-C&quot;, &quot;--rev&quot;, rev])
</a><a href="#h7-0-3471" id="h7-0-3471" class="d">-			else:
</a><a href="#h7-0-3472" id="h7-0-3472" class="d">-				fui = FakeMercurialUI()
</a><a href="#h7-0-3473" id="h7-0-3473" class="d">-				ret = hg_commands.status(fui, self.repo, *[], **{&#39;rev&#39;: [rev], &#39;copies&#39;: True})
</a><a href="#h7-0-3474" id="h7-0-3474" class="d">-				if ret:
</a><a href="#h7-0-3475" id="h7-0-3475" class="d">-					raise hg_util.Abort(ret)
</a><a href="#h7-0-3476" id="h7-0-3476" class="d">-				out = fui.output
</a><a href="#h7-0-3477" id="h7-0-3477" class="d">-			self.status = out.splitlines()
</a><a href="#h7-0-3478" id="h7-0-3478" class="d">-		for i in range(len(self.status)):
</a><a href="#h7-0-3479" id="h7-0-3479" class="d">-			# line is
</a><a href="#h7-0-3480" id="h7-0-3480" class="d">-			#	A path
</a><a href="#h7-0-3481" id="h7-0-3481" class="d">-			#	M path
</a><a href="#h7-0-3482" id="h7-0-3482" class="d">-			# etc
</a><a href="#h7-0-3483" id="h7-0-3483" class="d">-			line = to_slash(self.status[i])
</a><a href="#h7-0-3484" id="h7-0-3484" class="d">-			if line[2:] == path:
</a><a href="#h7-0-3485" id="h7-0-3485" class="d">-				if i+1 &lt; len(self.status) and self.status[i+1][:2] == &#39;  &#39;:
</a><a href="#h7-0-3486" id="h7-0-3486" class="d">-					return self.status[i:i+2]
</a><a href="#h7-0-3487" id="h7-0-3487" class="d">-				return self.status[i:i+1]
</a><a href="#h7-0-3488" id="h7-0-3488" class="d">-		raise hg_util.Abort(&quot;no status for &quot; + path)
</a><a href="#h7-0-3489" id="h7-0-3489" class="d">-	
</a><a href="#h7-0-3490" id="h7-0-3490" class="d">-	def GetBaseFile(self, filename):
</a><a href="#h7-0-3491" id="h7-0-3491" class="d">-		set_status(&quot;inspecting &quot; + filename)
</a><a href="#h7-0-3492" id="h7-0-3492" class="d">-		# &quot;hg status&quot; and &quot;hg cat&quot; both take a path relative to the current subdir
</a><a href="#h7-0-3493" id="h7-0-3493" class="d">-		# rather than to the repo root, but &quot;hg diff&quot; has given us the full path
</a><a href="#h7-0-3494" id="h7-0-3494" class="d">-		# to the repo root.
</a><a href="#h7-0-3495" id="h7-0-3495" class="d">-		base_content = &quot;&quot;
</a><a href="#h7-0-3496" id="h7-0-3496" class="d">-		new_content = None
</a><a href="#h7-0-3497" id="h7-0-3497" class="d">-		is_binary = False
</a><a href="#h7-0-3498" id="h7-0-3498" class="d">-		oldrelpath = relpath = self._GetRelPath(filename)
</a><a href="#h7-0-3499" id="h7-0-3499" class="d">-		out = self.get_hg_status(self.base_rev, relpath)
</a><a href="#h7-0-3500" id="h7-0-3500" class="d">-		status, what = out[0].split(&#39; &#39;, 1)
</a><a href="#h7-0-3501" id="h7-0-3501" class="d">-		if len(out) &gt; 1 and status == &quot;A&quot; and what == relpath:
</a><a href="#h7-0-3502" id="h7-0-3502" class="d">-			oldrelpath = out[1].strip()
</a><a href="#h7-0-3503" id="h7-0-3503" class="d">-			status = &quot;M&quot;
</a><a href="#h7-0-3504" id="h7-0-3504" class="d">-		if &quot;:&quot; in self.base_rev:
</a><a href="#h7-0-3505" id="h7-0-3505" class="d">-			base_rev = self.base_rev.split(&quot;:&quot;, 1)[0]
</a><a href="#h7-0-3506" id="h7-0-3506" class="d">-		else:
</a><a href="#h7-0-3507" id="h7-0-3507" class="d">-			base_rev = self.base_rev
</a><a href="#h7-0-3508" id="h7-0-3508" class="d">-		if status != &quot;A&quot;:
</a><a href="#h7-0-3509" id="h7-0-3509" class="d">-			if use_hg_shell:
</a><a href="#h7-0-3510" id="h7-0-3510" class="d">-				base_content = RunShell([&quot;hg&quot;, &quot;cat&quot;, &quot;-r&quot;, base_rev, oldrelpath], silent_ok=True)
</a><a href="#h7-0-3511" id="h7-0-3511" class="d">-			else:
</a><a href="#h7-0-3512" id="h7-0-3512" class="d">-				base_content = str(self.repo[base_rev][oldrelpath].data())
</a><a href="#h7-0-3513" id="h7-0-3513" class="d">-			is_binary = &quot;\0&quot; in base_content  # Mercurial&#39;s heuristic
</a><a href="#h7-0-3514" id="h7-0-3514" class="d">-		if status != &quot;R&quot;:
</a><a href="#h7-0-3515" id="h7-0-3515" class="d">-			new_content = open(relpath, &quot;rb&quot;).read()
</a><a href="#h7-0-3516" id="h7-0-3516" class="d">-			is_binary = is_binary or &quot;\0&quot; in new_content
</a><a href="#h7-0-3517" id="h7-0-3517" class="d">-		if is_binary and base_content and use_hg_shell:
</a><a href="#h7-0-3518" id="h7-0-3518" class="d">-			# Fetch again without converting newlines
</a><a href="#h7-0-3519" id="h7-0-3519" class="d">-			base_content = RunShell([&quot;hg&quot;, &quot;cat&quot;, &quot;-r&quot;, base_rev, oldrelpath],
</a><a href="#h7-0-3520" id="h7-0-3520" class="d">-				silent_ok=True, universal_newlines=False)
</a><a href="#h7-0-3521" id="h7-0-3521" class="d">-		if not is_binary or not self.IsImage(relpath):
</a><a href="#h7-0-3522" id="h7-0-3522" class="d">-			new_content = None
</a><a href="#h7-0-3523" id="h7-0-3523" class="d">-		return base_content, new_content, is_binary, status
</a><a href="#h7-0-3524" id="h7-0-3524" class="d">-
</a><a href="#h7-0-3525" id="h7-0-3525" class="d">-
</a><a href="#h7-0-3526" id="h7-0-3526" class="d">-# NOTE: The SplitPatch function is duplicated in engine.py, keep them in sync.
</a><a href="#h7-0-3527" id="h7-0-3527" class="d">-def SplitPatch(data):
</a><a href="#h7-0-3528" id="h7-0-3528" class="d">-	&quot;&quot;&quot;Splits a patch into separate pieces for each file.
</a><a href="#h7-0-3529" id="h7-0-3529" class="d">-
</a><a href="#h7-0-3530" id="h7-0-3530" class="d">-	Args:
</a><a href="#h7-0-3531" id="h7-0-3531" class="d">-		data: A string containing the output of svn diff.
</a><a href="#h7-0-3532" id="h7-0-3532" class="d">-
</a><a href="#h7-0-3533" id="h7-0-3533" class="d">-	Returns:
</a><a href="#h7-0-3534" id="h7-0-3534" class="d">-		A list of 2-tuple (filename, text) where text is the svn diff output
</a><a href="#h7-0-3535" id="h7-0-3535" class="d">-			pertaining to filename.
</a><a href="#h7-0-3536" id="h7-0-3536" class="d">-	&quot;&quot;&quot;
</a><a href="#h7-0-3537" id="h7-0-3537" class="d">-	patches = []
</a><a href="#h7-0-3538" id="h7-0-3538" class="d">-	filename = None
</a><a href="#h7-0-3539" id="h7-0-3539" class="d">-	diff = []
</a><a href="#h7-0-3540" id="h7-0-3540" class="d">-	for line in data.splitlines(True):
</a><a href="#h7-0-3541" id="h7-0-3541" class="d">-		new_filename = None
</a><a href="#h7-0-3542" id="h7-0-3542" class="d">-		if line.startswith(&#39;Index:&#39;):
</a><a href="#h7-0-3543" id="h7-0-3543" class="d">-			unused, new_filename = line.split(&#39;:&#39;, 1)
</a><a href="#h7-0-3544" id="h7-0-3544" class="d">-			new_filename = new_filename.strip()
</a><a href="#h7-0-3545" id="h7-0-3545" class="d">-		elif line.startswith(&#39;Property changes on:&#39;):
</a><a href="#h7-0-3546" id="h7-0-3546" class="d">-			unused, temp_filename = line.split(&#39;:&#39;, 1)
</a><a href="#h7-0-3547" id="h7-0-3547" class="d">-			# When a file is modified, paths use &#39;/&#39; between directories, however
</a><a href="#h7-0-3548" id="h7-0-3548" class="d">-			# when a property is modified &#39;\&#39; is used on Windows.  Make them the same
</a><a href="#h7-0-3549" id="h7-0-3549" class="d">-			# otherwise the file shows up twice.
</a><a href="#h7-0-3550" id="h7-0-3550" class="d">-			temp_filename = to_slash(temp_filename.strip())
</a><a href="#h7-0-3551" id="h7-0-3551" class="d">-			if temp_filename != filename:
</a><a href="#h7-0-3552" id="h7-0-3552" class="d">-				# File has property changes but no modifications, create a new diff.
</a><a href="#h7-0-3553" id="h7-0-3553" class="d">-				new_filename = temp_filename
</a><a href="#h7-0-3554" id="h7-0-3554" class="d">-		if new_filename:
</a><a href="#h7-0-3555" id="h7-0-3555" class="d">-			if filename and diff:
</a><a href="#h7-0-3556" id="h7-0-3556" class="d">-				patches.append((filename, &#39;&#39;.join(diff)))
</a><a href="#h7-0-3557" id="h7-0-3557" class="d">-			filename = new_filename
</a><a href="#h7-0-3558" id="h7-0-3558" class="d">-			diff = [line]
</a><a href="#h7-0-3559" id="h7-0-3559" class="d">-			continue
</a><a href="#h7-0-3560" id="h7-0-3560" class="d">-		if diff is not None:
</a><a href="#h7-0-3561" id="h7-0-3561" class="d">-			diff.append(line)
</a><a href="#h7-0-3562" id="h7-0-3562" class="d">-	if filename and diff:
</a><a href="#h7-0-3563" id="h7-0-3563" class="d">-		patches.append((filename, &#39;&#39;.join(diff)))
</a><a href="#h7-0-3564" id="h7-0-3564" class="d">-	return patches
</a><a href="#h7-0-3565" id="h7-0-3565" class="d">-
</a><a href="#h7-0-3566" id="h7-0-3566" class="d">-
</a><a href="#h7-0-3567" id="h7-0-3567" class="d">-def UploadSeparatePatches(issue, rpc_server, patchset, data, options):
</a><a href="#h7-0-3568" id="h7-0-3568" class="d">-	&quot;&quot;&quot;Uploads a separate patch for each file in the diff output.
</a><a href="#h7-0-3569" id="h7-0-3569" class="d">-
</a><a href="#h7-0-3570" id="h7-0-3570" class="d">-	Returns a list of [patch_key, filename] for each file.
</a><a href="#h7-0-3571" id="h7-0-3571" class="d">-	&quot;&quot;&quot;
</a><a href="#h7-0-3572" id="h7-0-3572" class="d">-	patches = SplitPatch(data)
</a><a href="#h7-0-3573" id="h7-0-3573" class="d">-	rv = []
</a><a href="#h7-0-3574" id="h7-0-3574" class="d">-	for patch in patches:
</a><a href="#h7-0-3575" id="h7-0-3575" class="d">-		set_status(&quot;uploading patch for &quot; + patch[0])
</a><a href="#h7-0-3576" id="h7-0-3576" class="d">-		if len(patch[1]) &gt; MAX_UPLOAD_SIZE:
</a><a href="#h7-0-3577" id="h7-0-3577" class="d">-			print (&quot;Not uploading the patch for &quot; + patch[0] +
</a><a href="#h7-0-3578" id="h7-0-3578" class="d">-				&quot; because the file is too large.&quot;)
</a><a href="#h7-0-3579" id="h7-0-3579" class="d">-			continue
</a><a href="#h7-0-3580" id="h7-0-3580" class="d">-		form_fields = [(&quot;filename&quot;, patch[0])]
</a><a href="#h7-0-3581" id="h7-0-3581" class="d">-		if not options.download_base:
</a><a href="#h7-0-3582" id="h7-0-3582" class="d">-			form_fields.append((&quot;content_upload&quot;, &quot;1&quot;))
</a><a href="#h7-0-3583" id="h7-0-3583" class="d">-		files = [(&quot;data&quot;, &quot;data.diff&quot;, patch[1])]
</a><a href="#h7-0-3584" id="h7-0-3584" class="d">-		ctype, body = EncodeMultipartFormData(form_fields, files)
</a><a href="#h7-0-3585" id="h7-0-3585" class="d">-		url = &quot;/%d/upload_patch/%d&quot; % (int(issue), int(patchset))
</a><a href="#h7-0-3586" id="h7-0-3586" class="d">-		print &quot;Uploading patch for &quot; + patch[0]
</a><a href="#h7-0-3587" id="h7-0-3587" class="d">-		response_body = rpc_server.Send(url, body, content_type=ctype)
</a><a href="#h7-0-3588" id="h7-0-3588" class="d">-		lines = response_body.splitlines()
</a><a href="#h7-0-3589" id="h7-0-3589" class="d">-		if not lines or lines[0] != &quot;OK&quot;:
</a><a href="#h7-0-3590" id="h7-0-3590" class="d">-			StatusUpdate(&quot;  --&gt; %s&quot; % response_body)
</a><a href="#h7-0-3591" id="h7-0-3591" class="d">-			sys.exit(1)
</a><a href="#h7-0-3592" id="h7-0-3592" class="d">-		rv.append([lines[1], patch[0]])
</a><a href="#h7-0-3593" id="h7-0-3593" class="d">-	return rv
</a><b>diff --git a/<a id="h8" href="../file/src/vendor/re2/libre2.symbols">src/vendor/re2/libre2.symbols</a> b/<a href="../file/src/vendor/re2/libre2.symbols">src/vendor/re2/libre2.symbols</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -10,7 +10,9 @@
</a> 		_ZlsRSoRKN3re211StringPieceE;
 		# re2::FilteredRE2*
 		_ZN3re211FilteredRE2*;
<a href="#h8-0-3" id="h8-0-3" class="d">-		_ZNK3re211FilteredRE210AllMatches*;
</a><a href="#h8-0-4" id="h8-0-4" class="i">+		_ZNK3re211FilteredRE2*;
</a><a href="#h8-0-5" id="h8-0-5" class="i">+		# flags
</a><a href="#h8-0-6" id="h8-0-6" class="i">+		_ZN3re2*FLAGS_*;
</a> 	local:
 		*;
 };
<b>diff --git a/<a id="h9" href="../file/src/vendor/re2/libre2.symbols.darwin">src/vendor/re2/libre2.symbols.darwin</a> b/<a href="../file/src/vendor/re2/libre2.symbols.darwin">src/vendor/re2/libre2.symbols.darwin</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -6,8 +6,14 @@ __ZNK3re23RE2*
</a> __ZN3re211StringPiece*
 __ZNK3re211StringPiece*
 # operator&lt;&lt;(std::ostream&amp;, re2::StringPiece const&amp;)
<a href="#h9-0-3" id="h9-0-3" class="d">-__ZlsRNSt3__113basic_ostreamIcNS_11char_traitsIcEEEERKN3re211StringPieceE
</a><a href="#h9-0-4" id="h9-0-4" class="i">+# Seen with libstdc++ on 10.8 and below:
</a><a href="#h9-0-5" id="h9-0-5" class="i">+# __ZlsRSoRKN3re211StringPieceE
</a><a href="#h9-0-6" id="h9-0-6" class="i">+# Seen with libc++ on 10.9 and above:
</a><a href="#h9-0-7" id="h9-0-7" class="i">+# __ZlsRNSt3__113basic_ostreamIcNS_11char_traitsIcEEEERKN3re211StringPieceE
</a><a href="#h9-0-8" id="h9-0-8" class="i">+# Note that &quot;ls&quot; means operator&lt;&lt;, so this is not overly broad.
</a><a href="#h9-0-9" id="h9-0-9" class="i">+__Zls*RKN3re211StringPieceE
</a> # re2::FilteredRE2*
 __ZN3re211FilteredRE2*
<a href="#h9-0-12" id="h9-0-12" class="d">-__ZNK3re211FilteredRE210AllMatches*
</a><a href="#h9-0-13" id="h9-0-13" class="d">-
</a><a href="#h9-0-14" id="h9-0-14" class="i">+__ZNK3re211FilteredRE2*
</a><a href="#h9-0-15" id="h9-0-15" class="i">+# flags
</a><a href="#h9-0-16" id="h9-0-16" class="i">+__ZN3re2*FLAGS_*
</a><b>diff --git a/<a id="h10" href="../file/src/vendor/re2/re2.pc">src/vendor/re2/re2.pc</a> b/<a href="../file/src/vendor/re2/re2.pc">src/vendor/re2/re2.pc</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -0,0 +1,10 @@
</a><a href="#h10-0-0" id="h10-0-0" class="i">+prefix=@prefix@
</a><a href="#h10-0-1" id="h10-0-1" class="i">+exec_prefix=${prefix}
</a><a href="#h10-0-2" id="h10-0-2" class="i">+includedir=${prefix}/include
</a><a href="#h10-0-3" id="h10-0-3" class="i">+libdir=${exec_prefix}/lib
</a><a href="#h10-0-4" id="h10-0-4" class="i">+
</a><a href="#h10-0-5" id="h10-0-5" class="i">+Name: re2
</a><a href="#h10-0-6" id="h10-0-6" class="i">+Description: RE2 is a fast, safe, thread-friendly regular expression engine.
</a><a href="#h10-0-7" id="h10-0-7" class="i">+Version: 0.0.0
</a><a href="#h10-0-8" id="h10-0-8" class="i">+Cflags: -I${includedir}
</a><a href="#h10-0-9" id="h10-0-9" class="i">+Libs: -L${libdir} -lre2 -pthread
</a><b>diff --git a/<a id="h11" href="../file/src/vendor/re2/re2/Makefile">src/vendor/re2/re2/Makefile</a> b/<a href="../file/src/vendor/re2/re2/Makefile">src/vendor/re2/re2/Makefile</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -1 +0,0 @@
</a><a href="#h11-0-0" id="h11-0-0" class="d">-
</a><b>diff --git a/<a id="h12" href="../file/src/vendor/re2/re2/compile.cc">src/vendor/re2/re2/compile.cc</a> b/<a href="../file/src/vendor/re2/re2/compile.cc">src/vendor/re2/re2/compile.cc</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -435,7 +435,10 @@ Frag Compiler::EmptyWidth(EmptyOp empty) {
</a>   if (empty &amp; (kEmptyWordBoundary|kEmptyNonWordBoundary)) {
     int j;
     for (int i = 0; i &lt; 256; i = j) {
<a href="#h12-0-3" id="h12-0-3" class="d">-      for (j = i+1; j &lt; 256 &amp;&amp; Prog::IsWordChar(i) == Prog::IsWordChar(j); j++)
</a><a href="#h12-0-4" id="h12-0-4" class="i">+      for (j = i + 1; j &lt; 256 &amp;&amp;
</a><a href="#h12-0-5" id="h12-0-5" class="i">+                      Prog::IsWordChar(static_cast&lt;uint8&gt;(i)) ==
</a><a href="#h12-0-6" id="h12-0-6" class="i">+                          Prog::IsWordChar(static_cast&lt;uint8&gt;(j));
</a><a href="#h12-0-7" id="h12-0-7" class="i">+           j++)
</a>         ;
       prog_-&gt;MarkByteRange(i, j-1);
     }
<a href="#h12-1" id="h12-1" class="h">@@ -503,7 +506,10 @@ int Compiler::RuneByteSuffix(uint8 lo, uint8 hi, bool foldcase, int next) {
</a>     return UncachedRuneByteSuffix(lo, hi, foldcase, next);
   }
 
<a href="#h12-1-3" id="h12-1-3" class="d">-  uint64 key = ((uint64)next &lt;&lt; 17) | (lo&lt;&lt;9) | (hi&lt;&lt;1) | foldcase;
</a><a href="#h12-1-4" id="h12-1-4" class="i">+  uint64 key = (uint64)next &lt;&lt; 17 |
</a><a href="#h12-1-5" id="h12-1-5" class="i">+               (uint64)lo   &lt;&lt;  9 |
</a><a href="#h12-1-6" id="h12-1-6" class="i">+               (uint64)hi   &lt;&lt;  1 |
</a><a href="#h12-1-7" id="h12-1-7" class="i">+               (uint64)foldcase;
</a>   map&lt;uint64, int&gt;::iterator it = rune_cache_.find(key);
   if (it != rune_cache_.end())
     return it-&gt;second;
<a href="#h12-2" id="h12-2" class="h">@@ -555,7 +561,8 @@ void Compiler::AddRuneRangeLatin1(Rune lo, Rune hi, bool foldcase) {
</a>     return;
   if (hi &gt; 0xFF)
     hi = 0xFF;
<a href="#h12-2-3" id="h12-2-3" class="d">-  AddSuffix(RuneByteSuffix(lo, hi, foldcase, 0));
</a><a href="#h12-2-4" id="h12-2-4" class="i">+  AddSuffix(RuneByteSuffix(static_cast&lt;uint8&gt;(lo), static_cast&lt;uint8&gt;(hi),
</a><a href="#h12-2-5" id="h12-2-5" class="i">+                           foldcase, 0));
</a> }
 
 // Table describing how to make a UTF-8 matching machine
<a href="#h12-3" id="h12-3" class="h">@@ -596,7 +603,8 @@ void Compiler::Add_80_10ffff() {
</a>     int next = 0;
     if (p.next &gt;= 0)
       next = inst[p.next];
<a href="#h12-3-3" id="h12-3-3" class="d">-    inst[i] = UncachedRuneByteSuffix(p.lo, p.hi, false, next);
</a><a href="#h12-3-4" id="h12-3-4" class="i">+    inst[i] = UncachedRuneByteSuffix(static_cast&lt;uint8&gt;(p.lo),
</a><a href="#h12-3-5" id="h12-3-5" class="i">+                                     static_cast&lt;uint8&gt;(p.hi), false, next);
</a>     if ((p.lo &amp; 0xC0) != 0x80)
       AddSuffix(inst[i]);
   }
<a href="#h12-4" id="h12-4" class="h">@@ -625,7 +633,8 @@ void Compiler::AddRuneRangeUTF8(Rune lo, Rune hi, bool foldcase) {
</a> 
   // ASCII range is always a special case.
   if (hi &lt; Runeself) {
<a href="#h12-4-3" id="h12-4-3" class="d">-    AddSuffix(RuneByteSuffix(lo, hi, foldcase, 0));
</a><a href="#h12-4-4" id="h12-4-4" class="i">+    AddSuffix(RuneByteSuffix(static_cast&lt;uint8&gt;(lo), static_cast&lt;uint8&gt;(hi),
</a><a href="#h12-4-5" id="h12-4-5" class="i">+                             foldcase, 0));
</a>     return;
   }
 
<a href="#h12-5" id="h12-5" class="h">@@ -815,7 +824,8 @@ Frag Compiler::PostVisit(Regexp* re, Frag, Frag, Frag* child_frags,
</a>         // If this range contains all of A-Za-z or none of it,
         // the fold flag is unnecessary; don&#39;t bother.
         bool fold = foldascii;
<a href="#h12-5-3" id="h12-5-3" class="d">-        if ((i-&gt;lo &lt;= &#39;A&#39; &amp;&amp; &#39;z&#39; &lt;= i-&gt;hi) || i-&gt;hi &lt; &#39;A&#39; || &#39;z&#39; &lt; i-&gt;lo)
</a><a href="#h12-5-4" id="h12-5-4" class="i">+        if ((i-&gt;lo &lt;= &#39;A&#39; &amp;&amp; &#39;z&#39; &lt;= i-&gt;hi) || i-&gt;hi &lt; &#39;A&#39; || &#39;z&#39; &lt; i-&gt;lo ||
</a><a href="#h12-5-5" id="h12-5-5" class="i">+            (&#39;Z&#39; &lt; i-&gt;lo &amp;&amp; i-&gt;hi &lt; &#39;a&#39;))
</a>           fold = false;
 
         AddRuneRange(i-&gt;lo, i-&gt;hi, fold);
<a href="#h12-6" id="h12-6" class="h">@@ -978,7 +988,7 @@ void Compiler::Setup(Regexp::ParseFlags flags, int64 max_mem,
</a>     if (m &gt; Prog::Inst::kMaxInst)
       m = Prog::Inst::kMaxInst;
 
<a href="#h12-6-3" id="h12-6-3" class="d">-    max_inst_ = m;
</a><a href="#h12-6-4" id="h12-6-4" class="i">+    max_inst_ = static_cast&lt;int&gt;(m);
</a>   }
 
   anchor_ = anchor;
<b>diff --git a/<a id="h13" href="../file/src/vendor/re2/re2/dfa.cc">src/vendor/re2/re2/dfa.cc</a> b/<a href="../file/src/vendor/re2/re2/dfa.cc">src/vendor/re2/re2/dfa.cc</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -21,11 +21,11 @@
</a> //
 // See http://swtch.com/~rsc/regexp/ for a very bare-bones equivalent.
 
<a href="#h13-0-3" id="h13-0-3" class="d">-#include &quot;re2/prog.h&quot;
</a><a href="#h13-0-4" id="h13-0-4" class="d">-#include &quot;re2/stringpiece.h&quot;
</a> #include &quot;util/atomicops.h&quot;
 #include &quot;util/flags.h&quot;
 #include &quot;util/sparse_set.h&quot;
<a href="#h13-0-8" id="h13-0-8" class="i">+#include &quot;re2/prog.h&quot;
</a><a href="#h13-0-9" id="h13-0-9" class="i">+#include &quot;re2/stringpiece.h&quot;
</a> 
 DEFINE_bool(re2_dfa_bail_when_slow, true,
             &quot;Whether the RE2 DFA should bail out early &quot;
<a href="#h13-1" id="h13-1" class="h">@@ -143,7 +143,7 @@ class DFA {
</a>       if (sizeof(size_t) == sizeof(uint32))
         return Hash32StringWithSeed(s, len, a-&gt;flag_);
       else
<a href="#h13-1-3" id="h13-1-3" class="d">-        return Hash64StringWithSeed(s, len, a-&gt;flag_);
</a><a href="#h13-1-4" id="h13-1-4" class="i">+        return static_cast&lt;size_t&gt;(Hash64StringWithSeed(s, len, a-&gt;flag_));
</a>     }
 #ifdef STL_MSVC
     // Less than operator.
<a href="#h13-2" id="h13-2" class="h">@@ -228,9 +228,8 @@ class DFA {
</a>   // sets *ismatch to true.
   // L &gt;= mutex_
   void RunWorkqOnByte(Workq* q, Workq* nq,
<a href="#h13-2-3" id="h13-2-3" class="d">-                             int c, uint flag, bool* ismatch,
</a><a href="#h13-2-4" id="h13-2-4" class="d">-                             Prog::MatchKind kind,
</a><a href="#h13-2-5" id="h13-2-5" class="d">-                             int new_byte_loop);
</a><a href="#h13-2-6" id="h13-2-6" class="i">+                      int c, uint flag, bool* ismatch,
</a><a href="#h13-2-7" id="h13-2-7" class="i">+                      Prog::MatchKind kind);
</a> 
   // Runs a Workq on a set of empty-string flags, producing a new Workq in nq.
   // L &gt;= mutex_
<a href="#h13-3" id="h13-3" class="h">@@ -340,7 +339,6 @@ class DFA {
</a>   // Constant after initialization.
   Prog* prog_;              // The regular expression program to run.
   Prog::MatchKind kind_;    // The kind of DFA.
<a href="#h13-3-3" id="h13-3-3" class="d">-  int start_unanchored_;  // start of unanchored program
</a>   bool init_failed_;        // initialization failed (out of memory)
 
   Mutex mutex_;  // mutex_ &gt;= cache_mutex_.r
<a href="#h13-4" id="h13-4" class="h">@@ -443,11 +441,8 @@ DFA::DFA(Prog* prog, Prog::MatchKind kind, int64 max_mem)
</a>   if (DebugDFA)
     fprintf(stderr, &quot;\nkind %d\n%s\n&quot;, (int)kind_, prog_-&gt;DumpUnanchored().c_str());
   int nmark = 0;
<a href="#h13-4-3" id="h13-4-3" class="d">-  start_unanchored_ = 0;
</a><a href="#h13-4-4" id="h13-4-4" class="d">-  if (kind_ == Prog::kLongestMatch) {
</a><a href="#h13-4-5" id="h13-4-5" class="i">+  if (kind_ == Prog::kLongestMatch)
</a>     nmark = prog-&gt;size();
<a href="#h13-4-7" id="h13-4-7" class="d">-    start_unanchored_ = prog-&gt;start_unanchored();
</a><a href="#h13-4-8" id="h13-4-8" class="d">-  }
</a>   nastack_ = 2 * prog-&gt;size() + nmark;
 
   // Account for space needed for DFA, q0, q1, astack.
<a href="#h13-5" id="h13-5" class="h">@@ -456,7 +451,7 @@ DFA::DFA(Prog* prog, Prog::MatchKind kind, int64 max_mem)
</a>                  (sizeof(int)+sizeof(int)) * 2;  // q0, q1
   mem_budget_ -= nastack_ * sizeof(int);  // astack
   if (mem_budget_ &lt; 0) {
<a href="#h13-5-3" id="h13-5-3" class="d">-    LOG(INFO) &lt;&lt; StringPrintf(&quot;DFA out of memory: prog size %lld mem %lld&quot;,
</a><a href="#h13-5-4" id="h13-5-4" class="i">+    LOG(INFO) &lt;&lt; StringPrintf(&quot;DFA out of memory: prog size %d mem %lld&quot;,
</a>                               prog_-&gt;size(), max_mem);
     init_failed_ = true;
     return;
<a href="#h13-6" id="h13-6" class="h">@@ -471,7 +466,7 @@ DFA::DFA(Prog* prog, Prog::MatchKind kind, int64 max_mem)
</a>   int64 one_state = sizeof(State) + (prog_-&gt;size()+nmark)*sizeof(int) +
                     (prog_-&gt;bytemap_range()+1)*sizeof(State*);
   if (state_budget_ &lt; 20*one_state) {
<a href="#h13-6-3" id="h13-6-3" class="d">-    LOG(INFO) &lt;&lt; StringPrintf(&quot;DFA out of memory: prog size %lld mem %lld&quot;,
</a><a href="#h13-6-4" id="h13-6-4" class="i">+    LOG(INFO) &lt;&lt; StringPrintf(&quot;DFA out of memory: prog size %d mem %lld&quot;,
</a>                               prog_-&gt;size(), max_mem);
     init_failed_ = true;
     return;
<a href="#h13-7" id="h13-7" class="h">@@ -869,8 +864,10 @@ void DFA::AddToQueue(Workq* q, int id, uint flag) {
</a>         break;
 
       case kInstEmptyWidth:
<a href="#h13-7-3" id="h13-7-3" class="d">-        if ((ip-&gt;empty() &amp; flag) == ip-&gt;empty())
</a><a href="#h13-7-4" id="h13-7-4" class="d">-          stk[nstk++] = ip-&gt;out();
</a><a href="#h13-7-5" id="h13-7-5" class="i">+        // Continue on if we have all the right flag bits.
</a><a href="#h13-7-6" id="h13-7-6" class="i">+        if (ip-&gt;empty() &amp; ~flag)
</a><a href="#h13-7-7" id="h13-7-7" class="i">+          break;
</a><a href="#h13-7-8" id="h13-7-8" class="i">+        stk[nstk++] = ip-&gt;out();
</a>         break;
     }
   }
<a href="#h13-8" id="h13-8" class="h">@@ -908,8 +905,7 @@ void DFA::RunWorkqOnEmptyString(Workq* oldq, Workq* newq, uint flag) {
</a> // regular expression program has been reached (the regexp has matched).
 void DFA::RunWorkqOnByte(Workq* oldq, Workq* newq,
                          int c, uint flag, bool* ismatch,
<a href="#h13-8-3" id="h13-8-3" class="d">-                         Prog::MatchKind kind,
</a><a href="#h13-8-4" id="h13-8-4" class="d">-                         int new_byte_loop) {
</a><a href="#h13-8-5" id="h13-8-5" class="i">+                         Prog::MatchKind kind) {
</a>   if (DEBUG_MODE)
     mutex_.AssertHeld();
 
<a href="#h13-9" id="h13-9" class="h">@@ -1020,7 +1016,7 @@ DFA::State* DFA::RunStateOnByte(State* state, int c) {
</a>   // byte processed was a word character.  Use that info to
   // insert empty-width (non-)word boundaries.
   bool islastword = state-&gt;flag_ &amp; kFlagLastWord;
<a href="#h13-9-3" id="h13-9-3" class="d">-  bool isword = (c != kByteEndText &amp;&amp; Prog::IsWordChar(c));
</a><a href="#h13-9-4" id="h13-9-4" class="i">+  bool isword = (c != kByteEndText &amp;&amp; Prog::IsWordChar(static_cast&lt;uint8&gt;(c)));
</a>   if (isword == islastword)
     beforeflag |= kEmptyNonWordBoundary;
   else
<a href="#h13-10" id="h13-10" class="h">@@ -1033,8 +1029,8 @@ DFA::State* DFA::RunStateOnByte(State* state, int c) {
</a>     swap(q0_, q1_);
   }
   bool ismatch = false;
<a href="#h13-10-3" id="h13-10-3" class="d">-  RunWorkqOnByte(q0_, q1_, c, afterflag, &amp;ismatch, kind_, start_unanchored_);
</a><a href="#h13-10-4" id="h13-10-4" class="d">-  
</a><a href="#h13-10-5" id="h13-10-5" class="i">+  RunWorkqOnByte(q0_, q1_, c, afterflag, &amp;ismatch, kind_);
</a><a href="#h13-10-6" id="h13-10-6" class="i">+
</a>   // Most of the time, we build the state from the output of
   // RunWorkqOnByte, so swap q0_ and q1_ here.  However, so that
   // RE2::Set can tell exactly which match instructions
<a href="#h13-11" id="h13-11" class="h">@@ -2040,7 +2036,7 @@ bool DFA::PossibleMatchRange(string* min, string* max, int maxlen) {
</a>       if (ns == FullMatchState ||
           (ns &gt; SpecialStateMax &amp;&amp; ns-&gt;ninst_ &gt; 0)) {
         extended = true;
<a href="#h13-11-3" id="h13-11-3" class="d">-        min-&gt;append(1, j);
</a><a href="#h13-11-4" id="h13-11-4" class="i">+        min-&gt;append(1, static_cast&lt;char&gt;(j));
</a>         s = ns;
         break;
       }
<a href="#h13-12" id="h13-12" class="h">@@ -2070,7 +2066,7 @@ bool DFA::PossibleMatchRange(string* min, string* max, int maxlen) {
</a>       if (ns == FullMatchState ||
           (ns &gt; SpecialStateMax &amp;&amp; ns-&gt;ninst_ &gt; 0)) {
         extended = true;
<a href="#h13-12-3" id="h13-12-3" class="d">-        max-&gt;append(1, j);
</a><a href="#h13-12-4" id="h13-12-4" class="i">+        max-&gt;append(1, static_cast&lt;char&gt;(j));
</a>         s = ns;
         break;
       }
<b>diff --git a/<a id="h14" href="../file/src/vendor/re2/re2/filtered_re2.cc">src/vendor/re2/re2/filtered_re2.cc</a> b/<a href="../file/src/vendor/re2/re2/filtered_re2.cc">src/vendor/re2/re2/filtered_re2.cc</a></b>
<a href="#h14-0" id="h14-0" class="h">@@ -58,7 +58,7 @@ void FilteredRE2::Compile(vector&lt;string&gt;* atoms) {
</a> int FilteredRE2::SlowFirstMatch(const StringPiece&amp; text) const {
   for (size_t i = 0; i &lt; re2_vec_.size(); i++)
     if (RE2::PartialMatch(text, *re2_vec_[i]))
<a href="#h14-0-3" id="h14-0-3" class="d">-      return i;
</a><a href="#h14-0-4" id="h14-0-4" class="i">+      return static_cast&lt;int&gt;(i);
</a>   return -1;
 }
 
<b>diff --git a/<a id="h15" href="../file/src/vendor/re2/re2/make_perl_groups.pl">src/vendor/re2/re2/make_perl_groups.pl</a> b/<a href="../file/src/vendor/re2/re2/make_perl_groups.pl">src/vendor/re2/re2/make_perl_groups.pl</a></b>
<a href="#h15-0" id="h15-0" class="h">@@ -32,14 +32,20 @@
</a> 	&quot;\\w&quot;,
 );
 
<a href="#h15-0-3" id="h15-0-3" class="i">+%overrides = (
</a><a href="#h15-0-4" id="h15-0-4" class="i">+	# Prior to Perl 5.18, \s did not match vertical tab.
</a><a href="#h15-0-5" id="h15-0-5" class="i">+	# RE2 preserves that original behaviour.
</a><a href="#h15-0-6" id="h15-0-6" class="i">+	&quot;\\s:11&quot; =&gt; 0,
</a><a href="#h15-0-7" id="h15-0-7" class="i">+);
</a><a href="#h15-0-8" id="h15-0-8" class="i">+
</a> sub ComputeClass($) {
<a href="#h15-0-10" id="h15-0-10" class="i">+  my ($cname) = @_;
</a>   my @ranges;
<a href="#h15-0-12" id="h15-0-12" class="d">-  my ($class) = @_;
</a><a href="#h15-0-13" id="h15-0-13" class="d">-  my $regexp = &quot;[$class]&quot;;
</a><a href="#h15-0-14" id="h15-0-14" class="i">+  my $regexp = qr/[$cname]/;
</a>   my $start = -1;
   for (my $i=0; $i&lt;=129; $i++) {
     if ($i == 129) { $i = 256; }
<a href="#h15-0-18" id="h15-0-18" class="d">-    if ($i &lt;= 128 &amp;&amp; chr($i) =~ $regexp) {
</a><a href="#h15-0-19" id="h15-0-19" class="i">+    if ($i &lt;= 128 &amp;&amp; ($overrides{&quot;$cname:$i&quot;} // chr($i) =~ $regexp)) {
</a>       if ($start &lt; 0) {
         $start = $i;
       }
<a href="#h15-1" id="h15-1" class="h">@@ -54,15 +60,15 @@ sub ComputeClass($) {
</a> }
 
 sub PrintClass($$@) {
<a href="#h15-1-3" id="h15-1-3" class="d">-  my ($cname, $name, @ranges) = @_;
</a><a href="#h15-1-4" id="h15-1-4" class="d">-  print &quot;static const URange16 code${cname}[] = {  /* $name */\n&quot;;
</a><a href="#h15-1-5" id="h15-1-5" class="i">+  my ($cnum, $cname, @ranges) = @_;
</a><a href="#h15-1-6" id="h15-1-6" class="i">+  print &quot;static const URange16 code${cnum}[] = {  /* $cname */\n&quot;;
</a>   for (my $i=0; $i&lt;@ranges; $i++) {
     my @a = @{$ranges[$i]};
     printf &quot;\t{ 0x%x, 0x%x },\n&quot;, $a[0], $a[1];
   }
   print &quot;};\n&quot;;
   my $n = @ranges;
<a href="#h15-1-13" id="h15-1-13" class="d">-  my $escname = $name;
</a><a href="#h15-1-14" id="h15-1-14" class="i">+  my $escname = $cname;
</a>   $escname =~ s/\\/\\\\/g;
   $negname = $escname;
   if ($negname =~ /:/) {
<a href="#h15-2" id="h15-2" class="h">@@ -70,25 +76,25 @@ sub PrintClass($$@) {
</a>   } else {
     $negname =~ y/a-z/A-Z/;
   }
<a href="#h15-2-3" id="h15-2-3" class="d">-  return &quot;{ \&quot;$escname\&quot;, +1, code$cname, $n }&quot;, &quot;{ \&quot;$negname\&quot;, -1, code$cname, $n }&quot;;
</a><a href="#h15-2-4" id="h15-2-4" class="i">+  return &quot;{ \&quot;$escname\&quot;, +1, code$cnum, $n }&quot;, &quot;{ \&quot;$negname\&quot;, -1, code$cnum, $n }&quot;;
</a> }
 
<a href="#h15-2-7" id="h15-2-7" class="d">-my $gen = 0;
</a><a href="#h15-2-8" id="h15-2-8" class="i">+my $cnum = 0;
</a> 
 sub PrintClasses($@) {
<a href="#h15-2-11" id="h15-2-11" class="d">-  my ($cname, @classes) = @_;
</a><a href="#h15-2-12" id="h15-2-12" class="i">+  my ($pname, @classes) = @_;
</a>   my @entries;
<a href="#h15-2-14" id="h15-2-14" class="d">-  foreach my $cl (@classes) {
</a><a href="#h15-2-15" id="h15-2-15" class="d">-    my @ranges = ComputeClass($cl);
</a><a href="#h15-2-16" id="h15-2-16" class="d">-    push @entries, PrintClass(++$gen, $cl, @ranges);
</a><a href="#h15-2-17" id="h15-2-17" class="i">+  foreach my $cname (@classes) {
</a><a href="#h15-2-18" id="h15-2-18" class="i">+    my @ranges = ComputeClass($cname);
</a><a href="#h15-2-19" id="h15-2-19" class="i">+    push @entries, PrintClass(++$cnum, $cname, @ranges);
</a>   }
<a href="#h15-2-21" id="h15-2-21" class="d">-  print &quot;const UGroup ${cname}_groups[] = {\n&quot;;
</a><a href="#h15-2-22" id="h15-2-22" class="i">+  print &quot;const UGroup ${pname}_groups[] = {\n&quot;;
</a>   foreach my $e (@entries) {
     print &quot;\t$e,\n&quot;;
   }
   print &quot;};\n&quot;;
   my $count = @entries;
<a href="#h15-2-28" id="h15-2-28" class="d">-  print &quot;const int num_${cname}_groups = $count;\n&quot;;
</a><a href="#h15-2-29" id="h15-2-29" class="i">+  print &quot;const int num_${pname}_groups = $count;\n&quot;;
</a> }
 
 print &lt;&lt;EOF;
<b>diff --git a/<a id="h16" href="../file/src/vendor/re2/re2/make_unicode_casefold.py">src/vendor/re2/re2/make_unicode_casefold.py</a> b/<a href="../file/src/vendor/re2/re2/make_unicode_casefold.py">src/vendor/re2/re2/make_unicode_casefold.py</a></b>
<a href="#h16-0" id="h16-0" class="h">@@ -9,7 +9,8 @@
</a> 
 &quot;&quot;&quot;Generate C++ table for Unicode case folding.&quot;&quot;&quot;
 
<a href="#h16-0-3" id="h16-0-3" class="d">-import unicode, sys
</a><a href="#h16-0-4" id="h16-0-4" class="i">+import sys
</a><a href="#h16-0-5" id="h16-0-5" class="i">+import unicode
</a> 
 _header = &quot;&quot;&quot;
 // GENERATED BY make_unicode_casefold.py; DO NOT EDIT.
<b>diff --git a/<a id="h17" href="../file/src/vendor/re2/re2/nfa.cc">src/vendor/re2/re2/nfa.cc</a> b/<a href="../file/src/vendor/re2/re2/nfa.cc">src/vendor/re2/re2/nfa.cc</a></b>
<a href="#h17-0" id="h17-0" class="h">@@ -468,7 +468,7 @@ bool NFA::Search(const StringPiece&amp; text, const StringPiece&amp; const_context,
</a> 
   if (text.begin() &gt; context.begin()) {
     c = text.begin()[-1] &amp; 0xFF;
<a href="#h17-0-3" id="h17-0-3" class="d">-    wasword = Prog::IsWordChar(c);
</a><a href="#h17-0-4" id="h17-0-4" class="i">+    wasword = Prog::IsWordChar(static_cast&lt;uint8&gt;(c));
</a>   }
 
   // Loop over the text, stepping the machine.
<a href="#h17-1" id="h17-1" class="h">@@ -706,5 +706,52 @@ Prog::SearchNFA(const StringPiece&amp; text, const StringPiece&amp; context,
</a>   return true;
 }
 
<a href="#h17-1-3" id="h17-1-3" class="d">-}  // namespace re2
</a><a href="#h17-1-4" id="h17-1-4" class="i">+// For each instruction i in the program reachable from the start, compute the
</a><a href="#h17-1-5" id="h17-1-5" class="i">+// number of instructions reachable from i by following only empty transitions
</a><a href="#h17-1-6" id="h17-1-6" class="i">+// and record that count as fanout[i].
</a><a href="#h17-1-7" id="h17-1-7" class="i">+//
</a><a href="#h17-1-8" id="h17-1-8" class="i">+// fanout holds the results and is also the work queue for the outer iteration.
</a><a href="#h17-1-9" id="h17-1-9" class="i">+// reachable holds the reached nodes for the inner iteration.
</a><a href="#h17-1-10" id="h17-1-10" class="i">+void Prog::Fanout(SparseArray&lt;int&gt;* fanout) {
</a><a href="#h17-1-11" id="h17-1-11" class="i">+  DCHECK_EQ(fanout-&gt;max_size(), size());
</a><a href="#h17-1-12" id="h17-1-12" class="i">+  SparseSet reachable(size());
</a><a href="#h17-1-13" id="h17-1-13" class="i">+  fanout-&gt;clear();
</a><a href="#h17-1-14" id="h17-1-14" class="i">+  fanout-&gt;set_new(start(), 0);
</a><a href="#h17-1-15" id="h17-1-15" class="i">+  for (SparseArray&lt;int&gt;::iterator i = fanout-&gt;begin(); i != fanout-&gt;end(); ++i) {
</a><a href="#h17-1-16" id="h17-1-16" class="i">+    int* count = &amp;i-&gt;second;
</a><a href="#h17-1-17" id="h17-1-17" class="i">+    reachable.clear();
</a><a href="#h17-1-18" id="h17-1-18" class="i">+    reachable.insert(i-&gt;index());
</a><a href="#h17-1-19" id="h17-1-19" class="i">+    for (SparseSet::iterator j = reachable.begin(); j != reachable.end(); ++j) {
</a><a href="#h17-1-20" id="h17-1-20" class="i">+      Prog::Inst* ip = inst(*j);
</a><a href="#h17-1-21" id="h17-1-21" class="i">+      switch (ip-&gt;opcode()) {
</a><a href="#h17-1-22" id="h17-1-22" class="i">+        default:
</a><a href="#h17-1-23" id="h17-1-23" class="i">+          LOG(DFATAL) &lt;&lt; &quot;unhandled &quot; &lt;&lt; ip-&gt;opcode() &lt;&lt; &quot; in Prog::Fanout()&quot;;
</a><a href="#h17-1-24" id="h17-1-24" class="i">+          break;
</a><a href="#h17-1-25" id="h17-1-25" class="i">+
</a><a href="#h17-1-26" id="h17-1-26" class="i">+        case kInstByteRange:
</a><a href="#h17-1-27" id="h17-1-27" class="i">+          (*count)++;
</a><a href="#h17-1-28" id="h17-1-28" class="i">+          if (!fanout-&gt;has_index(ip-&gt;out())) {
</a><a href="#h17-1-29" id="h17-1-29" class="i">+            fanout-&gt;set_new(ip-&gt;out(), 0);
</a><a href="#h17-1-30" id="h17-1-30" class="i">+          }
</a><a href="#h17-1-31" id="h17-1-31" class="i">+          break;
</a><a href="#h17-1-32" id="h17-1-32" class="i">+
</a><a href="#h17-1-33" id="h17-1-33" class="i">+        case kInstAlt:
</a><a href="#h17-1-34" id="h17-1-34" class="i">+        case kInstAltMatch:
</a><a href="#h17-1-35" id="h17-1-35" class="i">+          reachable.insert(ip-&gt;out1());
</a><a href="#h17-1-36" id="h17-1-36" class="i">+          // fall through
</a><a href="#h17-1-37" id="h17-1-37" class="i">+
</a><a href="#h17-1-38" id="h17-1-38" class="i">+        case kInstCapture:
</a><a href="#h17-1-39" id="h17-1-39" class="i">+        case kInstEmptyWidth:
</a><a href="#h17-1-40" id="h17-1-40" class="i">+        case kInstNop:
</a><a href="#h17-1-41" id="h17-1-41" class="i">+          reachable.insert(ip-&gt;out());
</a><a href="#h17-1-42" id="h17-1-42" class="i">+          break;
</a> 
<a href="#h17-1-44" id="h17-1-44" class="i">+        case kInstMatch:
</a><a href="#h17-1-45" id="h17-1-45" class="i">+        case kInstFail:
</a><a href="#h17-1-46" id="h17-1-46" class="i">+          break;
</a><a href="#h17-1-47" id="h17-1-47" class="i">+      }
</a><a href="#h17-1-48" id="h17-1-48" class="i">+    }
</a><a href="#h17-1-49" id="h17-1-49" class="i">+  }
</a><a href="#h17-1-50" id="h17-1-50" class="i">+}
</a><a href="#h17-1-51" id="h17-1-51" class="i">+
</a><a href="#h17-1-52" id="h17-1-52" class="i">+}  // namespace re2
</a><b>diff --git a/<a id="h18" href="../file/src/vendor/re2/re2/onepass.cc">src/vendor/re2/re2/onepass.cc</a> b/<a href="../file/src/vendor/re2/re2/onepass.cc">src/vendor/re2/re2/onepass.cc</a></b>
<a href="#h18-0" id="h18-0" class="h">@@ -53,7 +53,6 @@
</a> #include &lt;string.h&gt;
 #include &lt;map&gt;
 #include &quot;util/util.h&quot;
<a href="#h18-0-3" id="h18-0-3" class="d">-#include &quot;util/arena.h&quot;
</a> #include &quot;util/sparse_set.h&quot;
 #include &quot;re2/prog.h&quot;
 #include &quot;re2/stringpiece.h&quot;
<a href="#h18-1" id="h18-1" class="h">@@ -126,9 +125,6 @@ static const int Debug = 0;
</a> // whether a set of conditions required to finish a match at that
 // point in the input rather than process the next byte.
 
<a href="#h18-1-3" id="h18-1-3" class="d">-// A state in the one-pass NFA (aka DFA) - just an array of actions.
</a><a href="#h18-1-4" id="h18-1-4" class="d">-struct OneState;
</a><a href="#h18-1-5" id="h18-1-5" class="d">-
</a> // A state in the one-pass NFA - just an array of actions indexed
 // by the bytemap_[] of the next input byte.  (The bytemap
 // maps next input bytes into equivalence classes, to reduce
<b>diff --git a/<a id="h19" href="../file/src/vendor/re2/re2/parse.cc">src/vendor/re2/re2/parse.cc</a> b/<a href="../file/src/vendor/re2/re2/parse.cc">src/vendor/re2/re2/parse.cc</a></b>
<a href="#h19-0" id="h19-0" class="h">@@ -21,6 +21,7 @@
</a> #include &quot;re2/stringpiece.h&quot;
 #include &quot;re2/unicode_casefold.h&quot;
 #include &quot;re2/unicode_groups.h&quot;
<a href="#h19-0-3" id="h19-0-3" class="i">+#include &quot;re2/walker-inl.h&quot;
</a> 
 namespace re2 {
 
<a href="#h19-1" id="h19-1" class="h">@@ -214,7 +215,8 @@ bool Regexp::ParseState::PushRegexp(Regexp* re) {
</a>   // single characters (e.g., [.] instead of \.), and some
   // analysis does better with fewer character classes.
   // Similarly, [Aa] can be rewritten as a literal A with ASCII case folding.
<a href="#h19-1-3" id="h19-1-3" class="d">-  if (re-&gt;op_ == kRegexpCharClass) {
</a><a href="#h19-1-4" id="h19-1-4" class="i">+  if (re-&gt;op_ == kRegexpCharClass &amp;&amp; re-&gt;ccb_ != NULL) {
</a><a href="#h19-1-5" id="h19-1-5" class="i">+    re-&gt;ccb_-&gt;RemoveAbove(rune_max_);
</a>     if (re-&gt;ccb_-&gt;size() == 1) {
       Rune r = re-&gt;ccb_-&gt;begin()-&gt;lo;
       re-&gt;Decref();
<a href="#h19-2" id="h19-2" class="h">@@ -377,7 +379,6 @@ bool Regexp::ParseState::PushLiteral(Rune r) {
</a>       }
       r = CycleFoldRune(r);
     } while (r != r1);
<a href="#h19-2-3" id="h19-2-3" class="d">-    re-&gt;ccb_-&gt;RemoveAbove(rune_max_);
</a>     return PushRegexp(re);
   }
 
<a href="#h19-3" id="h19-3" class="h">@@ -463,6 +464,59 @@ bool Regexp::ParseState::PushRepeatOp(RegexpOp op, const StringPiece&amp; s,
</a>   return true;
 }
 
<a href="#h19-3-3" id="h19-3-3" class="i">+// RepetitionWalker reports whether the repetition regexp is valid.
</a><a href="#h19-3-4" id="h19-3-4" class="i">+// Valid means that the combination of the top-level repetition
</a><a href="#h19-3-5" id="h19-3-5" class="i">+// and any inner repetitions does not exceed n copies of the
</a><a href="#h19-3-6" id="h19-3-6" class="i">+// innermost thing.
</a><a href="#h19-3-7" id="h19-3-7" class="i">+// This rewalks the regexp tree and is called for every repetition,
</a><a href="#h19-3-8" id="h19-3-8" class="i">+// so we have to worry about inducing quadratic behavior in the parser.
</a><a href="#h19-3-9" id="h19-3-9" class="i">+// We avoid this by only using RepetitionWalker when min or max &gt;= 2.
</a><a href="#h19-3-10" id="h19-3-10" class="i">+// In that case the depth of any &gt;= 2 nesting can only get to 9 without
</a><a href="#h19-3-11" id="h19-3-11" class="i">+// triggering a parse error, so each subtree can only be rewalked 9 times.
</a><a href="#h19-3-12" id="h19-3-12" class="i">+class RepetitionWalker : public Regexp::Walker&lt;int&gt; {
</a><a href="#h19-3-13" id="h19-3-13" class="i">+ public:
</a><a href="#h19-3-14" id="h19-3-14" class="i">+  RepetitionWalker() {}
</a><a href="#h19-3-15" id="h19-3-15" class="i">+  virtual int PreVisit(Regexp* re, int parent_arg, bool* stop);
</a><a href="#h19-3-16" id="h19-3-16" class="i">+  virtual int PostVisit(Regexp* re, int parent_arg, int pre_arg,
</a><a href="#h19-3-17" id="h19-3-17" class="i">+                        int* child_args, int nchild_args);
</a><a href="#h19-3-18" id="h19-3-18" class="i">+  virtual int ShortVisit(Regexp* re, int parent_arg);
</a><a href="#h19-3-19" id="h19-3-19" class="i">+
</a><a href="#h19-3-20" id="h19-3-20" class="i">+ private:
</a><a href="#h19-3-21" id="h19-3-21" class="i">+  DISALLOW_COPY_AND_ASSIGN(RepetitionWalker);
</a><a href="#h19-3-22" id="h19-3-22" class="i">+};
</a><a href="#h19-3-23" id="h19-3-23" class="i">+
</a><a href="#h19-3-24" id="h19-3-24" class="i">+int RepetitionWalker::PreVisit(Regexp* re, int parent_arg, bool* stop) {
</a><a href="#h19-3-25" id="h19-3-25" class="i">+  int arg = parent_arg;
</a><a href="#h19-3-26" id="h19-3-26" class="i">+  if (re-&gt;op() == kRegexpRepeat) {
</a><a href="#h19-3-27" id="h19-3-27" class="i">+    int m = re-&gt;max();
</a><a href="#h19-3-28" id="h19-3-28" class="i">+    if (m &lt; 0) {
</a><a href="#h19-3-29" id="h19-3-29" class="i">+      m = re-&gt;min();
</a><a href="#h19-3-30" id="h19-3-30" class="i">+    }
</a><a href="#h19-3-31" id="h19-3-31" class="i">+    if (m &gt; 0) {
</a><a href="#h19-3-32" id="h19-3-32" class="i">+      arg /= m;
</a><a href="#h19-3-33" id="h19-3-33" class="i">+    }
</a><a href="#h19-3-34" id="h19-3-34" class="i">+  }
</a><a href="#h19-3-35" id="h19-3-35" class="i">+  return arg;
</a><a href="#h19-3-36" id="h19-3-36" class="i">+}
</a><a href="#h19-3-37" id="h19-3-37" class="i">+
</a><a href="#h19-3-38" id="h19-3-38" class="i">+int RepetitionWalker::PostVisit(Regexp* re, int parent_arg, int pre_arg,
</a><a href="#h19-3-39" id="h19-3-39" class="i">+                                int* child_args, int nchild_args) {
</a><a href="#h19-3-40" id="h19-3-40" class="i">+  int arg = pre_arg;
</a><a href="#h19-3-41" id="h19-3-41" class="i">+  for (int i = 0; i &lt; nchild_args; i++) {
</a><a href="#h19-3-42" id="h19-3-42" class="i">+    if (child_args[i] &lt; arg) {
</a><a href="#h19-3-43" id="h19-3-43" class="i">+      arg = child_args[i];
</a><a href="#h19-3-44" id="h19-3-44" class="i">+    }
</a><a href="#h19-3-45" id="h19-3-45" class="i">+  }
</a><a href="#h19-3-46" id="h19-3-46" class="i">+  return arg;
</a><a href="#h19-3-47" id="h19-3-47" class="i">+}
</a><a href="#h19-3-48" id="h19-3-48" class="i">+
</a><a href="#h19-3-49" id="h19-3-49" class="i">+int RepetitionWalker::ShortVisit(Regexp* re, int parent_arg) {
</a><a href="#h19-3-50" id="h19-3-50" class="i">+  // This should never be called, since we use Walk and not
</a><a href="#h19-3-51" id="h19-3-51" class="i">+  // WalkExponential.
</a><a href="#h19-3-52" id="h19-3-52" class="i">+  LOG(DFATAL) &lt;&lt; &quot;RepetitionWalker::ShortVisit called&quot;;
</a><a href="#h19-3-53" id="h19-3-53" class="i">+  return 0;
</a><a href="#h19-3-54" id="h19-3-54" class="i">+}
</a><a href="#h19-3-55" id="h19-3-55" class="i">+
</a> // Pushes a repetition regexp onto the stack.
 // A valid argument for the operator must already be on the stack.
 bool Regexp::ParseState::PushRepetition(int min, int max,
<a href="#h19-4" id="h19-4" class="h">@@ -488,8 +542,15 @@ bool Regexp::ParseState::PushRepetition(int min, int max,
</a>   re-&gt;down_ = stacktop_-&gt;down_;
   re-&gt;sub()[0] = FinishRegexp(stacktop_);
   re-&gt;simple_ = re-&gt;ComputeSimple();
<a href="#h19-4-3" id="h19-4-3" class="d">-
</a>   stacktop_ = re;
<a href="#h19-4-5" id="h19-4-5" class="i">+  if (min &gt;= 2 || max &gt;= 2) {
</a><a href="#h19-4-6" id="h19-4-6" class="i">+    RepetitionWalker w;
</a><a href="#h19-4-7" id="h19-4-7" class="i">+    if (w.Walk(stacktop_, 1000) == 0) {
</a><a href="#h19-4-8" id="h19-4-8" class="i">+      status_-&gt;set_code(kRegexpRepeatSize);
</a><a href="#h19-4-9" id="h19-4-9" class="i">+      status_-&gt;set_error_arg(s);
</a><a href="#h19-4-10" id="h19-4-10" class="i">+      return false;
</a><a href="#h19-4-11" id="h19-4-11" class="i">+    }
</a><a href="#h19-4-12" id="h19-4-12" class="i">+  }
</a>   return true;
 }
 
<a href="#h19-5" id="h19-5" class="h">@@ -515,13 +576,6 @@ bool Regexp::ParseState::DoLeftParenNoCapture() {
</a>   return PushRegexp(re);
 }
 
<a href="#h19-5-3" id="h19-5-3" class="d">-// Adds r to cc, along with r&#39;s upper case if foldascii is set.
</a><a href="#h19-5-4" id="h19-5-4" class="d">-static void AddLiteral(CharClassBuilder* cc, Rune r, bool foldascii) {
</a><a href="#h19-5-5" id="h19-5-5" class="d">-  cc-&gt;AddRange(r, r);
</a><a href="#h19-5-6" id="h19-5-6" class="d">-  if (foldascii &amp;&amp; &#39;a&#39; &lt;= r &amp;&amp; r &lt;= &#39;z&#39;)
</a><a href="#h19-5-7" id="h19-5-7" class="d">-    cc-&gt;AddRange(r + &#39;A&#39; - &#39;a&#39;, r + &#39;A&#39; - &#39;a&#39;);
</a><a href="#h19-5-8" id="h19-5-8" class="d">-}
</a><a href="#h19-5-9" id="h19-5-9" class="d">-
</a> // Processes a vertical bar in the input.
 bool Regexp::ParseState::DoVerticalBar() {
   MaybeConcatString(-1, NoParseFlags);
<a href="#h19-6" id="h19-6" class="h">@@ -535,46 +589,34 @@ bool Regexp::ParseState::DoVerticalBar() {
</a>   Regexp* r1;
   Regexp* r2;
   if ((r1 = stacktop_) != NULL &amp;&amp;
<a href="#h19-6-3" id="h19-6-3" class="d">-      (r2 = stacktop_-&gt;down_) != NULL &amp;&amp;
</a><a href="#h19-6-4" id="h19-6-4" class="i">+      (r2 = r1-&gt;down_) != NULL &amp;&amp;
</a>       r2-&gt;op() == kVerticalBar) {
<a href="#h19-6-6" id="h19-6-6" class="d">-    // If above and below vertical bar are literal or char class,
</a><a href="#h19-6-7" id="h19-6-7" class="d">-    // can merge into a single char class.
</a>     Regexp* r3;
<a href="#h19-6-9" id="h19-6-9" class="d">-    if ((r1-&gt;op() == kRegexpLiteral ||
</a><a href="#h19-6-10" id="h19-6-10" class="d">-         r1-&gt;op() == kRegexpCharClass ||
</a><a href="#h19-6-11" id="h19-6-11" class="d">-         r1-&gt;op() == kRegexpAnyChar) &amp;&amp;
</a><a href="#h19-6-12" id="h19-6-12" class="d">-        (r3 = r2-&gt;down_) != NULL) {
</a><a href="#h19-6-13" id="h19-6-13" class="d">-      Rune rune;
</a><a href="#h19-6-14" id="h19-6-14" class="d">-      switch (r3-&gt;op()) {
</a><a href="#h19-6-15" id="h19-6-15" class="d">-        case kRegexpLiteral:  // convert to char class
</a><a href="#h19-6-16" id="h19-6-16" class="d">-          rune = r3-&gt;rune_;
</a><a href="#h19-6-17" id="h19-6-17" class="d">-          r3-&gt;op_ = kRegexpCharClass;
</a><a href="#h19-6-18" id="h19-6-18" class="d">-          r3-&gt;cc_ = NULL;
</a><a href="#h19-6-19" id="h19-6-19" class="d">-          r3-&gt;ccb_ = new CharClassBuilder;
</a><a href="#h19-6-20" id="h19-6-20" class="d">-          AddLiteral(r3-&gt;ccb_, rune, r3-&gt;parse_flags_ &amp; Regexp::FoldCase);
</a><a href="#h19-6-21" id="h19-6-21" class="d">-          // fall through
</a><a href="#h19-6-22" id="h19-6-22" class="d">-        case kRegexpCharClass:
</a><a href="#h19-6-23" id="h19-6-23" class="d">-          if (r1-&gt;op() == kRegexpLiteral)
</a><a href="#h19-6-24" id="h19-6-24" class="d">-            AddLiteral(r3-&gt;ccb_, r1-&gt;rune_,
</a><a href="#h19-6-25" id="h19-6-25" class="d">-                       r1-&gt;parse_flags_ &amp; Regexp::FoldCase);
</a><a href="#h19-6-26" id="h19-6-26" class="d">-          else if (r1-&gt;op() == kRegexpCharClass)
</a><a href="#h19-6-27" id="h19-6-27" class="d">-            r3-&gt;ccb_-&gt;AddCharClass(r1-&gt;ccb_);
</a><a href="#h19-6-28" id="h19-6-28" class="d">-          if (r1-&gt;op() == kRegexpAnyChar || r3-&gt;ccb_-&gt;full()) {
</a><a href="#h19-6-29" id="h19-6-29" class="d">-            delete r3-&gt;ccb_;
</a><a href="#h19-6-30" id="h19-6-30" class="d">-            r3-&gt;ccb_ = NULL;
</a><a href="#h19-6-31" id="h19-6-31" class="d">-            r3-&gt;op_ = kRegexpAnyChar;
</a><a href="#h19-6-32" id="h19-6-32" class="d">-          }
</a><a href="#h19-6-33" id="h19-6-33" class="d">-          // fall through
</a><a href="#h19-6-34" id="h19-6-34" class="d">-        case kRegexpAnyChar:
</a><a href="#h19-6-35" id="h19-6-35" class="d">-          // pop r1
</a><a href="#h19-6-36" id="h19-6-36" class="d">-          stacktop_ = r2;
</a><a href="#h19-6-37" id="h19-6-37" class="d">-          r1-&gt;Decref();
</a><a href="#h19-6-38" id="h19-6-38" class="d">-          return true;
</a><a href="#h19-6-39" id="h19-6-39" class="d">-        default:
</a><a href="#h19-6-40" id="h19-6-40" class="d">-          break;
</a><a href="#h19-6-41" id="h19-6-41" class="i">+    if ((r3 = r2-&gt;down_) != NULL &amp;&amp;
</a><a href="#h19-6-42" id="h19-6-42" class="i">+        (r1-&gt;op() == kRegexpAnyChar || r3-&gt;op() == kRegexpAnyChar)) {
</a><a href="#h19-6-43" id="h19-6-43" class="i">+      // AnyChar is above or below the vertical bar. Let it subsume
</a><a href="#h19-6-44" id="h19-6-44" class="i">+      // the other when the other is Literal, CharClass or AnyChar.
</a><a href="#h19-6-45" id="h19-6-45" class="i">+      if (r3-&gt;op() == kRegexpAnyChar &amp;&amp;
</a><a href="#h19-6-46" id="h19-6-46" class="i">+          (r1-&gt;op() == kRegexpLiteral ||
</a><a href="#h19-6-47" id="h19-6-47" class="i">+           r1-&gt;op() == kRegexpCharClass ||
</a><a href="#h19-6-48" id="h19-6-48" class="i">+           r1-&gt;op() == kRegexpAnyChar)) {
</a><a href="#h19-6-49" id="h19-6-49" class="i">+        // Discard r1.
</a><a href="#h19-6-50" id="h19-6-50" class="i">+        stacktop_ = r2;
</a><a href="#h19-6-51" id="h19-6-51" class="i">+        r1-&gt;Decref();
</a><a href="#h19-6-52" id="h19-6-52" class="i">+        return true;
</a><a href="#h19-6-53" id="h19-6-53" class="i">+      }
</a><a href="#h19-6-54" id="h19-6-54" class="i">+      if (r1-&gt;op() == kRegexpAnyChar &amp;&amp;
</a><a href="#h19-6-55" id="h19-6-55" class="i">+          (r3-&gt;op() == kRegexpLiteral ||
</a><a href="#h19-6-56" id="h19-6-56" class="i">+           r3-&gt;op() == kRegexpCharClass ||
</a><a href="#h19-6-57" id="h19-6-57" class="i">+           r3-&gt;op() == kRegexpAnyChar)) {
</a><a href="#h19-6-58" id="h19-6-58" class="i">+        // Rearrange the stack and discard r3.
</a><a href="#h19-6-59" id="h19-6-59" class="i">+        r1-&gt;down_ = r3-&gt;down_;
</a><a href="#h19-6-60" id="h19-6-60" class="i">+        r2-&gt;down_ = r1;
</a><a href="#h19-6-61" id="h19-6-61" class="i">+        stacktop_ = r2;
</a><a href="#h19-6-62" id="h19-6-62" class="i">+        r3-&gt;Decref();
</a><a href="#h19-6-63" id="h19-6-63" class="i">+        return true;
</a>       }
     }
<a href="#h19-6-66" id="h19-6-66" class="d">-
</a>     // Swap r1 below vertical bar (r2).
     r1-&gt;down_ = r2-&gt;down_;
     r2-&gt;down_ = r1;
<a href="#h19-7" id="h19-7" class="h">@@ -1105,7 +1147,7 @@ bool Regexp::ParseState::MaybeConcatString(int r, ParseFlags flags) {
</a>   if (r &gt;= 0) {
     re1-&gt;op_ = kRegexpLiteral;
     re1-&gt;rune_ = r;
<a href="#h19-7-3" id="h19-7-3" class="d">-    re1-&gt;parse_flags_ = flags;
</a><a href="#h19-7-4" id="h19-7-4" class="i">+    re1-&gt;parse_flags_ = static_cast&lt;uint16&gt;(flags);
</a>     return true;
   }
 
<a href="#h19-8" id="h19-8" class="h">@@ -1771,7 +1813,6 @@ bool Regexp::ParseState::ParseCharClass(StringPiece* s,
</a> 
   if (negated)
     re-&gt;ccb_-&gt;Negate();
<a href="#h19-8-3" id="h19-8-3" class="d">-  re-&gt;ccb_-&gt;RemoveAbove(rune_max_);
</a> 
   *out_re = re;
   return true;
<b>diff --git a/<a id="h20" href="../file/src/vendor/re2/re2/prefilter.cc">src/vendor/re2/re2/prefilter.cc</a> b/<a href="../file/src/vendor/re2/re2/prefilter.cc">src/vendor/re2/re2/prefilter.cc</a></b>
<a href="#h20-0" id="h20-0" class="h">@@ -15,6 +15,7 @@ static const int Trace = false;
</a> typedef set&lt;string&gt;::iterator SSIter;
 typedef set&lt;string&gt;::const_iterator ConstSSIter;
 
<a href="#h20-0-3" id="h20-0-3" class="i">+GLOBAL_MUTEX(alloc_id_mutex);
</a> static int alloc_id = 100000;  // Used for debugging.
 // Initializes a Prefilter, allocating subs_ as necessary.
 Prefilter::Prefilter(Op op) {
<a href="#h20-1" id="h20-1" class="h">@@ -23,7 +24,9 @@ Prefilter::Prefilter(Op op) {
</a>   if (op_ == AND || op_ == OR)
     subs_ = new vector&lt;Prefilter*&gt;;
 
<a href="#h20-1-3" id="h20-1-3" class="i">+  GLOBAL_MUTEX_LOCK(alloc_id_mutex);
</a>   alloc_id_ = alloc_id++;
<a href="#h20-1-5" id="h20-1-5" class="i">+  GLOBAL_MUTEX_UNLOCK(alloc_id_mutex);
</a>   VLOG(10) &lt;&lt; &quot;alloc_id: &quot; &lt;&lt; alloc_id_;
 }
 
<b>diff --git a/<a id="h21" href="../file/src/vendor/re2/re2/prefilter_tree.cc">src/vendor/re2/re2/prefilter_tree.cc</a> b/<a href="../file/src/vendor/re2/re2/prefilter_tree.cc">src/vendor/re2/re2/prefilter_tree.cc</a></b>
<a href="#h21-0" id="h21-0" class="h">@@ -278,7 +278,7 @@ void PrefilterTree::AssignUniqueIds(vector&lt;string&gt;* atom_vec) {
</a>     int id = CanonicalNode(prefilter_vec_[i])-&gt;unique_id();
     DCHECK_LE(0, id);
     Entry* entry = &amp;entries_[id];
<a href="#h21-0-3" id="h21-0-3" class="d">-    entry-&gt;regexps.push_back(i);
</a><a href="#h21-0-4" id="h21-0-4" class="i">+    entry-&gt;regexps.push_back(static_cast&lt;int&gt;(i));
</a>   }
 }
 
<b>diff --git a/<a id="h22" href="../file/src/vendor/re2/re2/prefilter_tree.h">src/vendor/re2/re2/prefilter_tree.h</a> b/<a href="../file/src/vendor/re2/re2/prefilter_tree.h">src/vendor/re2/re2/prefilter_tree.h</a></b>
<a href="#h22-0" id="h22-0" class="h">@@ -22,7 +22,7 @@
</a> namespace re2 {
 
 typedef SparseArray&lt;int&gt; IntMap;
<a href="#h22-0-3" id="h22-0-3" class="d">-typedef map&lt;int,int&gt; StdIntMap;
</a><a href="#h22-0-4" id="h22-0-4" class="i">+typedef map&lt;int, int&gt; StdIntMap;
</a> 
 class Prefilter;
 
<b>diff --git a/<a id="h23" href="../file/src/vendor/re2/re2/prog.cc">src/vendor/re2/re2/prog.cc</a> b/<a href="../file/src/vendor/re2/re2/prog.cc">src/vendor/re2/re2/prog.cc</a></b>
<a href="#h23-0" id="h23-0" class="h">@@ -25,7 +25,7 @@ void Prog::Inst::InitByteRange(int lo, int hi, int foldcase, uint32 out) {
</a>   set_out_opcode(out, kInstByteRange);
   lo_ = lo &amp; 0xFF;
   hi_ = hi &amp; 0xFF;
<a href="#h23-0-3" id="h23-0-3" class="d">-  foldcase_ = foldcase;
</a><a href="#h23-0-4" id="h23-0-4" class="i">+  foldcase_ = foldcase &amp; 0xFF;
</a> }
 
 void Prog::Inst::InitCapture(int cap, uint32 out) {
<a href="#h23-1" id="h23-1" class="h">@@ -327,12 +327,12 @@ void Prog::ComputeByteMap() {
</a>   bytemap_range_ = bytemap_[255] + 1;
   unbytemap_ = new uint8[bytemap_range_];
   for (int i = 0; i &lt; 256; i++)
<a href="#h23-1-3" id="h23-1-3" class="d">-    unbytemap_[bytemap_[i]] = i;
</a><a href="#h23-1-4" id="h23-1-4" class="i">+    unbytemap_[bytemap_[i]] = static_cast&lt;uint8&gt;(i);
</a> 
   if (0) {  // For debugging: use trivial byte map.
     for (int i = 0; i &lt; 256; i++) {
<a href="#h23-1-8" id="h23-1-8" class="d">-      bytemap_[i] = i;
</a><a href="#h23-1-9" id="h23-1-9" class="d">-      unbytemap_[i] = i;
</a><a href="#h23-1-10" id="h23-1-10" class="i">+      bytemap_[i] = static_cast&lt;uint8&gt;(i);
</a><a href="#h23-1-11" id="h23-1-11" class="i">+      unbytemap_[i] = static_cast&lt;uint8&gt;(i);
</a>     }
     bytemap_range_ = 256;
     LOG(INFO) &lt;&lt; &quot;Using trivial bytemap.&quot;;
<b>diff --git a/<a id="h24" href="../file/src/vendor/re2/re2/prog.h">src/vendor/re2/re2/prog.h</a> b/<a href="../file/src/vendor/re2/re2/prog.h">src/vendor/re2/re2/prog.h</a></b>
<a href="#h24-0" id="h24-0" class="h">@@ -10,6 +10,7 @@
</a> #define RE2_PROG_H__
 
 #include &quot;util/util.h&quot;
<a href="#h24-0-3" id="h24-0-3" class="i">+#include &quot;util/sparse_array.h&quot;
</a> #include &quot;re2/re2.h&quot;
 
 namespace re2 {
<a href="#h24-1" id="h24-1" class="h">@@ -200,10 +201,10 @@ class Prog {
</a>   int start_unanchored() { return start_unanchored_; }
   void set_start(int start) { start_ = start; }
   void set_start_unanchored(int start) { start_unanchored_ = start; }
<a href="#h24-1-3" id="h24-1-3" class="d">-  int64 size() { return size_; }
</a><a href="#h24-1-4" id="h24-1-4" class="i">+  int size() { return size_; }
</a>   bool reversed() { return reversed_; }
   void set_reversed(bool reversed) { reversed_ = reversed; }
<a href="#h24-1-7" id="h24-1-7" class="d">-  int64 byte_inst_count() { return byte_inst_count_; }
</a><a href="#h24-1-8" id="h24-1-8" class="i">+  int byte_inst_count() { return byte_inst_count_; }
</a>   const Bitmap&lt;256&gt;&amp; byterange() { return byterange_; }
   void set_dfa_mem(int64 dfa_mem) { dfa_mem_ = dfa_mem; }
   int64 dfa_mem() { return dfa_mem_; }
<a href="#h24-2" id="h24-2" class="h">@@ -329,6 +330,10 @@ class Prog {
</a>   // Returns true on success, false on error.
   bool PossibleMatchRange(string* min, string* max, int maxlen);
 
<a href="#h24-2-3" id="h24-2-3" class="i">+  // EXPERIMENTAL! SUBJECT TO CHANGE!
</a><a href="#h24-2-4" id="h24-2-4" class="i">+  // Outputs the program fanout into the given sparse array.
</a><a href="#h24-2-5" id="h24-2-5" class="i">+  void Fanout(SparseArray&lt;int&gt;* fanout);
</a><a href="#h24-2-6" id="h24-2-6" class="i">+
</a>   // Compiles a collection of regexps to Prog.  Each regexp will have
   // its own Match instruction recording the index in the vector.
   static Prog* CompileSet(const RE2::Options&amp; options, RE2::Anchor anchor,
<b>diff --git a/<a id="h25" href="../file/src/vendor/re2/re2/re2.cc">src/vendor/re2/re2/re2.cc</a> b/<a href="../file/src/vendor/re2/re2/re2.cc">src/vendor/re2/re2/re2.cc</a></b>
<a href="#h25-0" id="h25-0" class="h">@@ -11,11 +11,10 @@
</a> 
 #include &lt;stdio.h&gt;
 #include &lt;string&gt;
<a href="#h25-0-3" id="h25-0-3" class="d">-#include &lt;pthread.h&gt;
</a> #include &lt;errno.h&gt;
<a href="#h25-0-5" id="h25-0-5" class="d">-#include &quot;util/atomicops.h&quot;
</a> #include &quot;util/util.h&quot;
 #include &quot;util/flags.h&quot;
<a href="#h25-0-8" id="h25-0-8" class="i">+#include &quot;util/sparse_array.h&quot;
</a> #include &quot;re2/prog.h&quot;
 #include &quot;re2/regexp.h&quot;
 
<a href="#h25-1" id="h25-1" class="h">@@ -33,9 +32,9 @@ const VariadicFunction2&lt;bool, StringPiece*, const RE2&amp;, RE2::Arg, RE2::ConsumeN&gt;
</a> const VariadicFunction2&lt;bool, StringPiece*, const RE2&amp;, RE2::Arg, RE2::FindAndConsumeN&gt; RE2::FindAndConsume = {};
 
 // This will trigger LNK2005 error in MSVC.
<a href="#h25-1-3" id="h25-1-3" class="d">-#ifndef COMPILER_MSVC
</a><a href="#h25-1-4" id="h25-1-4" class="i">+#ifndef _MSC_VER
</a> const int RE2::Options::kDefaultMaxMem;  // initialized in re2.h
<a href="#h25-1-6" id="h25-1-6" class="d">-#endif  // COMPILER_MSVC
</a><a href="#h25-1-7" id="h25-1-7" class="i">+#endif
</a> 
 RE2::Options::Options(RE2::CannedOptions opt)
   : encoding_(opt == RE2::Latin1 ? EncodingLatin1 : EncodingUTF8),
<a href="#h25-2" id="h25-2" class="h">@@ -272,8 +271,36 @@ int RE2::ProgramSize() const {
</a>   return prog_-&gt;size();
 }
 
<a href="#h25-2-3" id="h25-2-3" class="i">+int RE2::ProgramFanout(map&lt;int, int&gt;* histogram) const {
</a><a href="#h25-2-4" id="h25-2-4" class="i">+  if (prog_ == NULL)
</a><a href="#h25-2-5" id="h25-2-5" class="i">+    return -1;
</a><a href="#h25-2-6" id="h25-2-6" class="i">+  SparseArray&lt;int&gt; fanout(prog_-&gt;size());
</a><a href="#h25-2-7" id="h25-2-7" class="i">+  prog_-&gt;Fanout(&amp;fanout);
</a><a href="#h25-2-8" id="h25-2-8" class="i">+  histogram-&gt;clear();
</a><a href="#h25-2-9" id="h25-2-9" class="i">+  for (SparseArray&lt;int&gt;::iterator i = fanout.begin(); i != fanout.end(); ++i) {
</a><a href="#h25-2-10" id="h25-2-10" class="i">+    // TODO(junyer): Optimise this?
</a><a href="#h25-2-11" id="h25-2-11" class="i">+    int bucket = 0;
</a><a href="#h25-2-12" id="h25-2-12" class="i">+    while (1 &lt;&lt; bucket &lt; i-&gt;second) {
</a><a href="#h25-2-13" id="h25-2-13" class="i">+      bucket++;
</a><a href="#h25-2-14" id="h25-2-14" class="i">+    }
</a><a href="#h25-2-15" id="h25-2-15" class="i">+    (*histogram)[bucket]++;
</a><a href="#h25-2-16" id="h25-2-16" class="i">+  }
</a><a href="#h25-2-17" id="h25-2-17" class="i">+  return histogram-&gt;rbegin()-&gt;first;
</a><a href="#h25-2-18" id="h25-2-18" class="i">+}
</a><a href="#h25-2-19" id="h25-2-19" class="i">+
</a><a href="#h25-2-20" id="h25-2-20" class="i">+// Returns num_captures_, computing it if needed, or -1 if the
</a><a href="#h25-2-21" id="h25-2-21" class="i">+// regexp wasn&#39;t valid on construction.
</a><a href="#h25-2-22" id="h25-2-22" class="i">+int RE2::NumberOfCapturingGroups() const {
</a><a href="#h25-2-23" id="h25-2-23" class="i">+  MutexLock l(mutex_);
</a><a href="#h25-2-24" id="h25-2-24" class="i">+  if (suffix_regexp_ == NULL)
</a><a href="#h25-2-25" id="h25-2-25" class="i">+    return -1;
</a><a href="#h25-2-26" id="h25-2-26" class="i">+  if (num_captures_ == -1)
</a><a href="#h25-2-27" id="h25-2-27" class="i">+    num_captures_ = suffix_regexp_-&gt;NumCaptures();
</a><a href="#h25-2-28" id="h25-2-28" class="i">+  return num_captures_;
</a><a href="#h25-2-29" id="h25-2-29" class="i">+}
</a><a href="#h25-2-30" id="h25-2-30" class="i">+
</a> // Returns named_groups_, computing it if needed.
<a href="#h25-2-32" id="h25-2-32" class="d">-const map&lt;string, int&gt;&amp;  RE2::NamedCapturingGroups() const {
</a><a href="#h25-2-33" id="h25-2-33" class="i">+const map&lt;string, int&gt;&amp; RE2::NamedCapturingGroups() const {
</a>   MutexLock l(mutex_);
   if (!ok())
     return *empty_named_groups;
<a href="#h25-3" id="h25-3" class="h">@@ -286,7 +313,7 @@ const map&lt;string, int&gt;&amp;  RE2::NamedCapturingGroups() const {
</a> }
 
 // Returns group_names_, computing it if needed.
<a href="#h25-3-3" id="h25-3-3" class="d">-const map&lt;int, string&gt;&amp;  RE2::CapturingGroupNames() const {
</a><a href="#h25-3-4" id="h25-3-4" class="i">+const map&lt;int, string&gt;&amp; RE2::CapturingGroupNames() const {
</a>   MutexLock l(mutex_);
   if (!ok())
     return *empty_group_names;
<a href="#h25-4" id="h25-4" class="h">@@ -541,7 +568,10 @@ bool RE2::Match(const StringPiece&amp; text,
</a> 
   if (startpos &lt; 0 || startpos &gt; endpos || endpos &gt; text.size()) {
     if (options_.log_errors())
<a href="#h25-4-3" id="h25-4-3" class="d">-      LOG(ERROR) &lt;&lt; &quot;RE2: invalid startpos, endpos pair.&quot;;
</a><a href="#h25-4-4" id="h25-4-4" class="i">+      LOG(ERROR) &lt;&lt; &quot;RE2: invalid startpos, endpos pair. [&quot;
</a><a href="#h25-4-5" id="h25-4-5" class="i">+                 &lt;&lt; &quot;startpos: &quot; &lt;&lt; startpos &lt;&lt; &quot;, &quot;
</a><a href="#h25-4-6" id="h25-4-6" class="i">+                 &lt;&lt; &quot;endpos: &quot; &lt;&lt; endpos &lt;&lt; &quot;, &quot;
</a><a href="#h25-4-7" id="h25-4-7" class="i">+                 &lt;&lt; &quot;text size: &quot; &lt;&lt; text.size() &lt;&lt; &quot;]&quot;;
</a>     return false;
   }
 
<a href="#h25-5" id="h25-5" class="h">@@ -842,7 +872,7 @@ bool RE2::DoMatch(const StringPiece&amp; text,
</a>     if (!args[i]-&gt;Parse(s.data(), s.size())) {
       // TODO: Should we indicate what the error was?
       VLOG(1) &lt;&lt; &quot;Parse error on #&quot; &lt;&lt; i &lt;&lt; &quot; &quot; &lt;&lt; s &lt;&lt; &quot; &quot;
<a href="#h25-5-3" id="h25-5-3" class="d">-	      &lt;&lt; (void*)s.data() &lt;&lt; &quot;/&quot; &lt;&lt; s.size();
</a><a href="#h25-5-4" id="h25-5-4" class="i">+              &lt;&lt; (void*)s.data() &lt;&lt; &quot;/&quot; &lt;&lt; s.size();
</a>       delete[] heapvec;
       return false;
     }
<a href="#h25-6" id="h25-6" class="h">@@ -858,50 +888,35 @@ bool RE2::Rewrite(string *out, const StringPiece &amp;rewrite,
</a>                  const StringPiece *vec, int veclen) const {
   for (const char *s = rewrite.data(), *end = s + rewrite.size();
        s &lt; end; s++) {
<a href="#h25-6-3" id="h25-6-3" class="d">-    int c = *s;
</a><a href="#h25-6-4" id="h25-6-4" class="d">-    if (c == &#39;\\&#39;) {
</a><a href="#h25-6-5" id="h25-6-5" class="d">-      s++;
</a><a href="#h25-6-6" id="h25-6-6" class="d">-      c = (s &lt; end) ? *s : -1;
</a><a href="#h25-6-7" id="h25-6-7" class="d">-      if (isdigit(c)) {
</a><a href="#h25-6-8" id="h25-6-8" class="d">-        int n = (c - &#39;0&#39;);
</a><a href="#h25-6-9" id="h25-6-9" class="d">-        if (n &gt;= veclen) {
</a><a href="#h25-6-10" id="h25-6-10" class="d">-          if (options_.log_errors()) {
</a><a href="#h25-6-11" id="h25-6-11" class="d">-            LOG(ERROR) &lt;&lt; &quot;requested group &quot; &lt;&lt; n
</a><a href="#h25-6-12" id="h25-6-12" class="d">-                       &lt;&lt; &quot; in regexp &quot; &lt;&lt; rewrite.data();
</a><a href="#h25-6-13" id="h25-6-13" class="d">-          }
</a><a href="#h25-6-14" id="h25-6-14" class="d">-          return false;
</a><a href="#h25-6-15" id="h25-6-15" class="i">+    if (*s != &#39;\\&#39;) {
</a><a href="#h25-6-16" id="h25-6-16" class="i">+      out-&gt;push_back(*s);
</a><a href="#h25-6-17" id="h25-6-17" class="i">+      continue;
</a><a href="#h25-6-18" id="h25-6-18" class="i">+    }
</a><a href="#h25-6-19" id="h25-6-19" class="i">+    s++;
</a><a href="#h25-6-20" id="h25-6-20" class="i">+    int c = (s &lt; end) ? *s : -1;
</a><a href="#h25-6-21" id="h25-6-21" class="i">+    if (isdigit(c)) {
</a><a href="#h25-6-22" id="h25-6-22" class="i">+      int n = (c - &#39;0&#39;);
</a><a href="#h25-6-23" id="h25-6-23" class="i">+      if (n &gt;= veclen) {
</a><a href="#h25-6-24" id="h25-6-24" class="i">+        if (options_.log_errors()) {
</a><a href="#h25-6-25" id="h25-6-25" class="i">+          LOG(ERROR) &lt;&lt; &quot;requested group &quot; &lt;&lt; n
</a><a href="#h25-6-26" id="h25-6-26" class="i">+                     &lt;&lt; &quot; in regexp &quot; &lt;&lt; rewrite.data();
</a>         }
<a href="#h25-6-28" id="h25-6-28" class="d">-        StringPiece snip = vec[n];
</a><a href="#h25-6-29" id="h25-6-29" class="d">-        if (snip.size() &gt; 0)
</a><a href="#h25-6-30" id="h25-6-30" class="d">-          out-&gt;append(snip.data(), snip.size());
</a><a href="#h25-6-31" id="h25-6-31" class="d">-      } else if (c == &#39;\\&#39;) {
</a><a href="#h25-6-32" id="h25-6-32" class="d">-        out-&gt;push_back(&#39;\\&#39;);
</a><a href="#h25-6-33" id="h25-6-33" class="d">-      } else {
</a><a href="#h25-6-34" id="h25-6-34" class="d">-        if (options_.log_errors())
</a><a href="#h25-6-35" id="h25-6-35" class="d">-          LOG(ERROR) &lt;&lt; &quot;invalid rewrite pattern: &quot; &lt;&lt; rewrite.data();
</a>         return false;
       }
<a href="#h25-6-38" id="h25-6-38" class="i">+      StringPiece snip = vec[n];
</a><a href="#h25-6-39" id="h25-6-39" class="i">+      if (snip.size() &gt; 0)
</a><a href="#h25-6-40" id="h25-6-40" class="i">+        out-&gt;append(snip.data(), snip.size());
</a><a href="#h25-6-41" id="h25-6-41" class="i">+    } else if (c == &#39;\\&#39;) {
</a><a href="#h25-6-42" id="h25-6-42" class="i">+      out-&gt;push_back(&#39;\\&#39;);
</a>     } else {
<a href="#h25-6-44" id="h25-6-44" class="d">-      out-&gt;push_back(c);
</a><a href="#h25-6-45" id="h25-6-45" class="i">+      if (options_.log_errors())
</a><a href="#h25-6-46" id="h25-6-46" class="i">+        LOG(ERROR) &lt;&lt; &quot;invalid rewrite pattern: &quot; &lt;&lt; rewrite.data();
</a><a href="#h25-6-47" id="h25-6-47" class="i">+      return false;
</a>     }
   }
   return true;
 }
 
<a href="#h25-6-53" id="h25-6-53" class="d">-// Return the number of capturing subpatterns, or -1 if the
</a><a href="#h25-6-54" id="h25-6-54" class="d">-// regexp wasn&#39;t valid on construction.
</a><a href="#h25-6-55" id="h25-6-55" class="d">-int RE2::NumberOfCapturingGroups() const {
</a><a href="#h25-6-56" id="h25-6-56" class="d">-  if (suffix_regexp_ == NULL)
</a><a href="#h25-6-57" id="h25-6-57" class="d">-    return -1;
</a><a href="#h25-6-58" id="h25-6-58" class="d">-  int n;
</a><a href="#h25-6-59" id="h25-6-59" class="d">-  ATOMIC_LOAD_RELAXED(n, &amp;num_captures_);
</a><a href="#h25-6-60" id="h25-6-60" class="d">-  if (n == -1) {
</a><a href="#h25-6-61" id="h25-6-61" class="d">-    n = suffix_regexp_-&gt;NumCaptures();
</a><a href="#h25-6-62" id="h25-6-62" class="d">-    ATOMIC_STORE_RELAXED(&amp;num_captures_, n);
</a><a href="#h25-6-63" id="h25-6-63" class="d">-  }
</a><a href="#h25-6-64" id="h25-6-64" class="d">-  return n;
</a><a href="#h25-6-65" id="h25-6-65" class="d">-}
</a><a href="#h25-6-66" id="h25-6-66" class="d">-
</a> // Checks that the rewrite string is well-formed with respect to this
 // regular expression.
 bool RE2::CheckRewriteString(const StringPiece&amp; rewrite, string* error) const {
<a href="#h25-7" id="h25-7" class="h">@@ -1081,7 +1096,7 @@ bool RE2::Arg::parse_short_radix(const char* str,
</a>   if (!parse_long_radix(str, n, &amp;r, radix)) return false; // Could not parse
   if ((short)r != r) return false;       // Out of range
   if (dest == NULL) return true;
<a href="#h25-7-3" id="h25-7-3" class="d">-  *(reinterpret_cast&lt;short*&gt;(dest)) = r;
</a><a href="#h25-7-4" id="h25-7-4" class="i">+  *(reinterpret_cast&lt;short*&gt;(dest)) = (short)r;
</a>   return true;
 }
 
<a href="#h25-8" id="h25-8" class="h">@@ -1093,7 +1108,7 @@ bool RE2::Arg::parse_ushort_radix(const char* str,
</a>   if (!parse_ulong_radix(str, n, &amp;r, radix)) return false; // Could not parse
   if ((ushort)r != r) return false;                      // Out of range
   if (dest == NULL) return true;
<a href="#h25-8-3" id="h25-8-3" class="d">-  *(reinterpret_cast&lt;unsigned short*&gt;(dest)) = r;
</a><a href="#h25-8-4" id="h25-8-4" class="i">+  *(reinterpret_cast&lt;unsigned short*&gt;(dest)) = (ushort)r;
</a>   return true;
 }
 
<a href="#h25-9" id="h25-9" class="h">@@ -1121,7 +1136,7 @@ bool RE2::Arg::parse_uint_radix(const char* str,
</a>   return true;
 }
 
<a href="#h25-9-3" id="h25-9-3" class="d">-#ifdef RE2_HAVE_LONGLONG
</a><a href="#h25-9-4" id="h25-9-4" class="i">+#if RE2_HAVE_LONGLONG
</a> bool RE2::Arg::parse_longlong_radix(const char* str,
                                    int n,
                                    void* dest,
<a href="#h25-10" id="h25-10" class="h">@@ -1179,7 +1194,7 @@ static bool parse_double_float(const char* str, int n, bool isfloat, void *dest)
</a>   if (errno) return false;
   if (dest == NULL) return true;
   if (isfloat) {
<a href="#h25-10-3" id="h25-10-3" class="d">-    *(reinterpret_cast&lt;float*&gt;(dest)) = r;
</a><a href="#h25-10-4" id="h25-10-4" class="i">+    *(reinterpret_cast&lt;float*&gt;(dest)) = (float)r;
</a>   } else {
     *(reinterpret_cast&lt;double*&gt;(dest)) = r;
   }
<b>diff --git a/<a id="h26" href="../file/src/vendor/re2/re2/re2.h">src/vendor/re2/re2/re2.h</a> b/<a href="../file/src/vendor/re2/re2/re2.h">src/vendor/re2/re2/re2.h</a></b>
<a href="#h26-0" id="h26-0" class="h">@@ -17,7 +17,7 @@
</a> // some of the more complicated things thrown away.  In particular,
 // backreferences and generalized assertions are not available, nor is \Z.
 //
<a href="#h26-0-3" id="h26-0-3" class="d">-// See http://code.google.com/p/re2/wiki/Syntax for the syntax
</a><a href="#h26-0-4" id="h26-0-4" class="i">+// See https://github.com/google/re2/wiki/Syntax for the syntax
</a> // supported by RE2, and a comparison with PCRE and PERL regexps.
 //
 // For those not familiar with Perl&#39;s regular expressions,
<a href="#h26-1" id="h26-1" class="h">@@ -293,6 +293,11 @@ class RE2 {
</a>   // Larger numbers are more expensive than smaller numbers.
   int ProgramSize() const;
 
<a href="#h26-1-3" id="h26-1-3" class="i">+  // EXPERIMENTAL! SUBJECT TO CHANGE!
</a><a href="#h26-1-4" id="h26-1-4" class="i">+  // Outputs the program fanout as a histogram bucketed by powers of 2.
</a><a href="#h26-1-5" id="h26-1-5" class="i">+  // Returns the number of the largest non-empty bucket.
</a><a href="#h26-1-6" id="h26-1-6" class="i">+  int ProgramFanout(map&lt;int, int&gt;* histogram) const;
</a><a href="#h26-1-7" id="h26-1-7" class="i">+
</a>   // Returns the underlying Regexp; not for general use.
   // Returns entire_regexp_ so that callers don&#39;t need
   // to know about prefix_ and prefix_foldcase_.
<a href="#h26-2" id="h26-2" class="h">@@ -442,7 +447,6 @@ class RE2 {
</a>   // does not count: if the regexp is &quot;(a)(b)&quot;, returns 2.
   int NumberOfCapturingGroups() const;
 
<a href="#h26-2-3" id="h26-2-3" class="d">-
</a>   // Return a map from names to capturing indices.
   // The map records the index of the leftmost group
   // with the given name.
<a href="#h26-3" id="h26-3" class="h">@@ -681,7 +685,7 @@ class RE2 {
</a>   static inline Arg CRadix(unsigned int* x);
   static inline Arg CRadix(long* x);
   static inline Arg CRadix(unsigned long* x);
<a href="#h26-3-3" id="h26-3-3" class="d">-  #ifdef RE2_HAVE_LONGLONG
</a><a href="#h26-3-4" id="h26-3-4" class="i">+  #if RE2_HAVE_LONGLONG
</a>   static inline Arg CRadix(long long* x);
   static inline Arg CRadix(unsigned long long* x);
   #endif
<a href="#h26-4" id="h26-4" class="h">@@ -692,7 +696,7 @@ class RE2 {
</a>   static inline Arg Hex(unsigned int* x);
   static inline Arg Hex(long* x);
   static inline Arg Hex(unsigned long* x);
<a href="#h26-4-3" id="h26-4-3" class="d">-  #ifdef RE2_HAVE_LONGLONG
</a><a href="#h26-4-4" id="h26-4-4" class="i">+  #if RE2_HAVE_LONGLONG
</a>   static inline Arg Hex(long long* x);
   static inline Arg Hex(unsigned long long* x);
   #endif
<a href="#h26-5" id="h26-5" class="h">@@ -703,7 +707,7 @@ class RE2 {
</a>   static inline Arg Octal(unsigned int* x);
   static inline Arg Octal(long* x);
   static inline Arg Octal(unsigned long* x);
<a href="#h26-5-3" id="h26-5-3" class="d">-  #ifdef RE2_HAVE_LONGLONG
</a><a href="#h26-5-4" id="h26-5-4" class="i">+  #if RE2_HAVE_LONGLONG
</a>   static inline Arg Octal(long long* x);
   static inline Arg Octal(unsigned long long* x);
   #endif
<a href="#h26-6" id="h26-6" class="h">@@ -786,7 +790,7 @@ class RE2::Arg {
</a>   MAKE_PARSER(unsigned int,       parse_uint);
   MAKE_PARSER(long,               parse_long);
   MAKE_PARSER(unsigned long,      parse_ulong);
<a href="#h26-6-3" id="h26-6-3" class="d">-  #ifdef RE2_HAVE_LONGLONG
</a><a href="#h26-6-4" id="h26-6-4" class="i">+  #if RE2_HAVE_LONGLONG
</a>   MAKE_PARSER(long long,          parse_longlong);
   MAKE_PARSER(unsigned long long, parse_ulonglong);
   #endif
<a href="#h26-7" id="h26-7" class="h">@@ -797,12 +801,11 @@ class RE2::Arg {
</a> 
 #undef MAKE_PARSER
 
<a href="#h26-7-3" id="h26-7-3" class="d">-  // Generic constructor
</a><a href="#h26-7-4" id="h26-7-4" class="d">-  template &lt;class T&gt; Arg(T*, Parser parser);
</a><a href="#h26-7-5" id="h26-7-5" class="d">-  // Generic constructor template
</a><a href="#h26-7-6" id="h26-7-6" class="i">+  // Generic constructor templates
</a>   template &lt;class T&gt; Arg(T* p)
<a href="#h26-7-8" id="h26-7-8" class="d">-    : arg_(p), parser_(_RE2_MatchObject&lt;T&gt;::Parse) {
</a><a href="#h26-7-9" id="h26-7-9" class="d">-  }
</a><a href="#h26-7-10" id="h26-7-10" class="i">+      : arg_(p), parser_(_RE2_MatchObject&lt;T&gt;::Parse) { }
</a><a href="#h26-7-11" id="h26-7-11" class="i">+  template &lt;class T&gt; Arg(T* p, Parser parser)
</a><a href="#h26-7-12" id="h26-7-12" class="i">+      : arg_(p), parser_(parser) { }
</a> 
   // Parse the data
   bool Parse(const char* str, int n) const;
<a href="#h26-8" id="h26-8" class="h">@@ -835,7 +838,7 @@ class RE2::Arg {
</a>   DECLARE_INTEGER_PARSER(uint);
   DECLARE_INTEGER_PARSER(long);
   DECLARE_INTEGER_PARSER(ulong);
<a href="#h26-8-3" id="h26-8-3" class="d">-  #ifdef RE2_HAVE_LONGLONG
</a><a href="#h26-8-4" id="h26-8-4" class="i">+  #if RE2_HAVE_LONGLONG
</a>   DECLARE_INTEGER_PARSER(longlong);
   DECLARE_INTEGER_PARSER(ulonglong);
   #endif
<a href="#h26-9" id="h26-9" class="h">@@ -865,7 +868,7 @@ MAKE_INTEGER_PARSER(int,                int)
</a> MAKE_INTEGER_PARSER(unsigned int,       uint)
 MAKE_INTEGER_PARSER(long,               long)
 MAKE_INTEGER_PARSER(unsigned long,      ulong)
<a href="#h26-9-3" id="h26-9-3" class="d">-#ifdef RE2_HAVE_LONGLONG
</a><a href="#h26-9-4" id="h26-9-4" class="i">+#if RE2_HAVE_LONGLONG
</a> MAKE_INTEGER_PARSER(long long,          longlong)
 MAKE_INTEGER_PARSER(unsigned long long, ulonglong)
 #endif
<b>diff --git a/<a id="h27" href="../file/src/vendor/re2/re2/regexp.cc">src/vendor/re2/re2/regexp.cc</a> b/<a href="../file/src/vendor/re2/re2/regexp.cc">src/vendor/re2/re2/regexp.cc</a></b>
<a href="#h27-0" id="h27-0" class="h">@@ -14,7 +14,7 @@ namespace re2 {
</a> 
 // Constructor.  Allocates vectors as appropriate for operator.
 Regexp::Regexp(RegexpOp op, ParseFlags parse_flags)
<a href="#h27-0-3" id="h27-0-3" class="d">-  : op_(op),
</a><a href="#h27-0-4" id="h27-0-4" class="i">+  : op_(static_cast&lt;uint8&gt;(op)),
</a>     simple_(false),
     parse_flags_(static_cast&lt;uint16&gt;(parse_flags)),
     ref_(1),
<a href="#h27-1" id="h27-1" class="h">@@ -107,7 +107,7 @@ void Regexp::Decref() {
</a>     GLOBAL_MUTEX_LOCK(ref_mutex);
     int r = (*ref_map)[this] - 1;
     if (r &lt; kMaxRef) {
<a href="#h27-1-3" id="h27-1-3" class="d">-      ref_ = r;
</a><a href="#h27-1-4" id="h27-1-4" class="i">+      ref_ = static_cast&lt;uint16&gt;(r);
</a>       ref_map-&gt;erase(this);
     } else {
       (*ref_map)[this] = r;
<a href="#h27-2" id="h27-2" class="h">@@ -651,7 +651,7 @@ bool Regexp::RequiredPrefix(string *prefix, bool *foldcase, Regexp** suffix) {
</a>       if (re-&gt;parse_flags() &amp; Latin1) {
         prefix-&gt;resize(re-&gt;nrunes_);
         for (int j = 0; j &lt; re-&gt;nrunes_; j++)
<a href="#h27-2-3" id="h27-2-3" class="d">-          (*prefix)[j] = re-&gt;runes_[j];
</a><a href="#h27-2-4" id="h27-2-4" class="i">+          (*prefix)[j] = static_cast&lt;char&gt;(re-&gt;runes_[j]);
</a>       } else {
         // Convert to UTF-8 in place.
         // Assume worst-case space and then trim.
<a href="#h27-3" id="h27-3" class="h">@@ -660,7 +660,7 @@ bool Regexp::RequiredPrefix(string *prefix, bool *foldcase, Regexp** suffix) {
</a>         for (int j = 0; j &lt; re-&gt;nrunes_; j++) {
           Rune r = re-&gt;runes_[j];
           if (r &lt; Runeself)
<a href="#h27-3-3" id="h27-3-3" class="d">-            *p++ = r;
</a><a href="#h27-3-4" id="h27-3-4" class="i">+            *p++ = static_cast&lt;char&gt;(r);
</a>           else
             p += runetochar(p, &amp;r);
         }
<a href="#h27-4" id="h27-4" class="h">@@ -670,7 +670,7 @@ bool Regexp::RequiredPrefix(string *prefix, bool *foldcase, Regexp** suffix) {
</a> 
     case kRegexpLiteral:
       if ((re-&gt;parse_flags() &amp; Latin1) || re-&gt;rune_ &lt; Runeself) {
<a href="#h27-4-3" id="h27-4-3" class="d">-        prefix-&gt;append(1, re-&gt;rune_);
</a><a href="#h27-4-4" id="h27-4-4" class="i">+        prefix-&gt;append(1, static_cast&lt;char&gt;(re-&gt;rune_));
</a>       } else {
         char buf[UTFmax];
         prefix-&gt;append(buf, runetochar(buf, &amp;re-&gt;rune_));
<a href="#h27-5" id="h27-5" class="h">@@ -923,12 +923,12 @@ bool CharClass::Contains(Rune r) {
</a> }
 
 CharClass* CharClassBuilder::GetCharClass() {
<a href="#h27-5-3" id="h27-5-3" class="d">-  CharClass* cc = CharClass::New(ranges_.size());
</a><a href="#h27-5-4" id="h27-5-4" class="d">-  size_t n = 0;
</a><a href="#h27-5-5" id="h27-5-5" class="i">+  CharClass* cc = CharClass::New(static_cast&lt;int&gt;(ranges_.size()));
</a><a href="#h27-5-6" id="h27-5-6" class="i">+  int n = 0;
</a>   for (iterator it = begin(); it != end(); ++it)
     cc-&gt;ranges_[n++] = *it;
   cc-&gt;nranges_ = n;
<a href="#h27-5-10" id="h27-5-10" class="d">-  DCHECK_LE(static_cast&lt;size_t&gt;(n), ranges_.size());
</a><a href="#h27-5-11" id="h27-5-11" class="i">+  DCHECK_LE(n, static_cast&lt;int&gt;(ranges_.size()));
</a>   cc-&gt;nrunes_ = nrunes_;
   cc-&gt;folds_ascii_ = FoldsASCII();
   return cc;
<b>diff --git a/<a id="h28" href="../file/src/vendor/re2/re2/regexp.h">src/vendor/re2/re2/regexp.h</a> b/<a href="../file/src/vendor/re2/re2/regexp.h">src/vendor/re2/re2/regexp.h</a></b>
<a href="#h28-0" id="h28-0" class="h">@@ -211,7 +211,8 @@ class RegexpStatus {
</a>   DISALLOW_COPY_AND_ASSIGN(RegexpStatus);
 };
 
<a href="#h28-0-3" id="h28-0-3" class="d">-// Walker to implement Simplify.
</a><a href="#h28-0-4" id="h28-0-4" class="i">+// Walkers to implement Simplify.
</a><a href="#h28-0-5" id="h28-0-5" class="i">+class CoalesceWalker;
</a> class SimplifyWalker;
 
 // Compiled form; see prog.h
<a href="#h28-1" id="h28-1" class="h">@@ -353,6 +354,7 @@ class Regexp {
</a>   // removed.  The result will capture exactly the same
   // subexpressions the original did, unless formatted with ToString.
   Regexp* Simplify();
<a href="#h28-1-3" id="h28-1-3" class="i">+  friend class CoalesceWalker;
</a>   friend class SimplifyWalker;
 
   // Parses the regexp src and then simplifies it and sets *dst to the
<b>diff --git a/<a id="h29" href="../file/src/vendor/re2/re2/set.cc">src/vendor/re2/re2/set.cc</a> b/<a href="../file/src/vendor/re2/re2/set.cc">src/vendor/re2/re2/set.cc</a></b>
<a href="#h29-0" id="h29-0" class="h">@@ -75,7 +75,7 @@ bool RE2::Set::Compile() {
</a> 
   Regexp::ParseFlags pf = static_cast&lt;Regexp::ParseFlags&gt;(
     options_.ParseFlags());
<a href="#h29-0-3" id="h29-0-3" class="d">-  re2::Regexp* re = re2::Regexp::Alternate(const_cast&lt;re2::Regexp**&gt;(&amp;re_[0]),
</a><a href="#h29-0-4" id="h29-0-4" class="i">+  re2::Regexp* re = re2::Regexp::Alternate(const_cast&lt;re2::Regexp**&gt;(re_.data()),
</a>                                            re_.size(), pf);
   re_.clear();
   re2::Regexp* sre = re-&gt;Simplify();
<b>diff --git a/<a id="h30" href="../file/src/vendor/re2/re2/simplify.cc">src/vendor/re2/re2/simplify.cc</a> b/<a href="../file/src/vendor/re2/re2/simplify.cc">src/vendor/re2/re2/simplify.cc</a></b>
<a href="#h30-0" id="h30-0" class="h">@@ -97,6 +97,36 @@ bool Regexp::ComputeSimple() {
</a> }
 
 // Walker subclass used by Simplify.
<a href="#h30-0-3" id="h30-0-3" class="i">+// Coalesces runs of star/plus/quest/repeat of the same literal along with any
</a><a href="#h30-0-4" id="h30-0-4" class="i">+// occurrences of that literal into repeats of that literal. It also works for
</a><a href="#h30-0-5" id="h30-0-5" class="i">+// char classes, any char and any byte.
</a><a href="#h30-0-6" id="h30-0-6" class="i">+// PostVisit creates the coalesced result, which should then be simplified.
</a><a href="#h30-0-7" id="h30-0-7" class="i">+class CoalesceWalker : public Regexp::Walker&lt;Regexp*&gt; {
</a><a href="#h30-0-8" id="h30-0-8" class="i">+ public:
</a><a href="#h30-0-9" id="h30-0-9" class="i">+  CoalesceWalker() {}
</a><a href="#h30-0-10" id="h30-0-10" class="i">+  virtual Regexp* PostVisit(Regexp* re, Regexp* parent_arg, Regexp* pre_arg,
</a><a href="#h30-0-11" id="h30-0-11" class="i">+                            Regexp** child_args, int nchild_args);
</a><a href="#h30-0-12" id="h30-0-12" class="i">+  virtual Regexp* Copy(Regexp* re);
</a><a href="#h30-0-13" id="h30-0-13" class="i">+  virtual Regexp* ShortVisit(Regexp* re, Regexp* parent_arg);
</a><a href="#h30-0-14" id="h30-0-14" class="i">+
</a><a href="#h30-0-15" id="h30-0-15" class="i">+ private:
</a><a href="#h30-0-16" id="h30-0-16" class="i">+  // These functions are declared inside CoalesceWalker so that
</a><a href="#h30-0-17" id="h30-0-17" class="i">+  // they can edit the private fields of the Regexps they construct.
</a><a href="#h30-0-18" id="h30-0-18" class="i">+
</a><a href="#h30-0-19" id="h30-0-19" class="i">+  // Returns true if r1 and r2 can be coalesced. In particular, ensures that
</a><a href="#h30-0-20" id="h30-0-20" class="i">+  // the parse flags are consistent. (They will not be checked again later.)
</a><a href="#h30-0-21" id="h30-0-21" class="i">+  static bool CanCoalesce(Regexp* r1, Regexp* r2);
</a><a href="#h30-0-22" id="h30-0-22" class="i">+
</a><a href="#h30-0-23" id="h30-0-23" class="i">+  // Coalesces *r1ptr and *r2ptr. In most cases, the array elements afterwards
</a><a href="#h30-0-24" id="h30-0-24" class="i">+  // will be empty match and the coalesced op. In other cases, where part of a
</a><a href="#h30-0-25" id="h30-0-25" class="i">+  // literal string was removed to be coalesced, the array elements afterwards
</a><a href="#h30-0-26" id="h30-0-26" class="i">+  // will be the coalesced op and the remainder of the literal string.
</a><a href="#h30-0-27" id="h30-0-27" class="i">+  static void DoCoalesce(Regexp** r1ptr, Regexp** r2ptr);
</a><a href="#h30-0-28" id="h30-0-28" class="i">+
</a><a href="#h30-0-29" id="h30-0-29" class="i">+  DISALLOW_COPY_AND_ASSIGN(CoalesceWalker);
</a><a href="#h30-0-30" id="h30-0-30" class="i">+};
</a><a href="#h30-0-31" id="h30-0-31" class="i">+
</a><a href="#h30-0-32" id="h30-0-32" class="i">+// Walker subclass used by Simplify.
</a> // The simplify walk is purely post-recursive: given the simplified children,
 // PostVisit creates the simplified result.
 // The child_args are simplified Regexp*s.
<a href="#h30-1" id="h30-1" class="h">@@ -104,9 +134,7 @@ class SimplifyWalker : public Regexp::Walker&lt;Regexp*&gt; {
</a>  public:
   SimplifyWalker() {}
   virtual Regexp* PreVisit(Regexp* re, Regexp* parent_arg, bool* stop);
<a href="#h30-1-3" id="h30-1-3" class="d">-  virtual Regexp* PostVisit(Regexp* re,
</a><a href="#h30-1-4" id="h30-1-4" class="d">-                            Regexp* parent_arg,
</a><a href="#h30-1-5" id="h30-1-5" class="d">-                            Regexp* pre_arg,
</a><a href="#h30-1-6" id="h30-1-6" class="i">+  virtual Regexp* PostVisit(Regexp* re, Regexp* parent_arg, Regexp* pre_arg,
</a>                             Regexp** child_args, int nchild_args);
   virtual Regexp* Copy(Regexp* re);
   virtual Regexp* ShortVisit(Regexp* re, Regexp* parent_arg);
<a href="#h30-2" id="h30-2" class="h">@@ -143,14 +171,261 @@ class SimplifyWalker : public Regexp::Walker&lt;Regexp*&gt; {
</a> // Caller must Decref() return value when done with it.
 
 Regexp* Regexp::Simplify() {
<a href="#h30-2-3" id="h30-2-3" class="d">-  if (simple_)
</a><a href="#h30-2-4" id="h30-2-4" class="d">-    return Incref();
</a><a href="#h30-2-5" id="h30-2-5" class="d">-  SimplifyWalker w;
</a><a href="#h30-2-6" id="h30-2-6" class="d">-  return w.Walk(this, NULL);
</a><a href="#h30-2-7" id="h30-2-7" class="i">+  CoalesceWalker cw;
</a><a href="#h30-2-8" id="h30-2-8" class="i">+  Regexp* cre = cw.Walk(this, NULL);
</a><a href="#h30-2-9" id="h30-2-9" class="i">+  if (cre == NULL)
</a><a href="#h30-2-10" id="h30-2-10" class="i">+    return cre;
</a><a href="#h30-2-11" id="h30-2-11" class="i">+  SimplifyWalker sw;
</a><a href="#h30-2-12" id="h30-2-12" class="i">+  Regexp* sre = sw.Walk(cre, NULL);
</a><a href="#h30-2-13" id="h30-2-13" class="i">+  cre-&gt;Decref();
</a><a href="#h30-2-14" id="h30-2-14" class="i">+  return sre;
</a> }
 
 #define Simplify DontCallSimplify  // Avoid accidental recursion
 
<a href="#h30-2-19" id="h30-2-19" class="i">+// Utility function for PostVisit implementations that compares re-&gt;sub() with
</a><a href="#h30-2-20" id="h30-2-20" class="i">+// child_args to determine whether any child_args changed. In the common case,
</a><a href="#h30-2-21" id="h30-2-21" class="i">+// where nothing changed, calls Decref() for all child_args and returns false,
</a><a href="#h30-2-22" id="h30-2-22" class="i">+// so PostVisit must return re-&gt;Incref(). Otherwise, returns true.
</a><a href="#h30-2-23" id="h30-2-23" class="i">+static bool ChildArgsChanged(Regexp* re, Regexp** child_args) {
</a><a href="#h30-2-24" id="h30-2-24" class="i">+  for (int i = 0; i &lt; re-&gt;nsub(); i++) {
</a><a href="#h30-2-25" id="h30-2-25" class="i">+    Regexp* sub = re-&gt;sub()[i];
</a><a href="#h30-2-26" id="h30-2-26" class="i">+    Regexp* newsub = child_args[i];
</a><a href="#h30-2-27" id="h30-2-27" class="i">+    if (newsub != sub)
</a><a href="#h30-2-28" id="h30-2-28" class="i">+      return true;
</a><a href="#h30-2-29" id="h30-2-29" class="i">+  }
</a><a href="#h30-2-30" id="h30-2-30" class="i">+  for (int i = 0; i &lt; re-&gt;nsub(); i++) {
</a><a href="#h30-2-31" id="h30-2-31" class="i">+    Regexp* newsub = child_args[i];
</a><a href="#h30-2-32" id="h30-2-32" class="i">+    newsub-&gt;Decref();
</a><a href="#h30-2-33" id="h30-2-33" class="i">+  }
</a><a href="#h30-2-34" id="h30-2-34" class="i">+  return false;
</a><a href="#h30-2-35" id="h30-2-35" class="i">+}
</a><a href="#h30-2-36" id="h30-2-36" class="i">+
</a><a href="#h30-2-37" id="h30-2-37" class="i">+Regexp* CoalesceWalker::Copy(Regexp* re) {
</a><a href="#h30-2-38" id="h30-2-38" class="i">+  return re-&gt;Incref();
</a><a href="#h30-2-39" id="h30-2-39" class="i">+}
</a><a href="#h30-2-40" id="h30-2-40" class="i">+
</a><a href="#h30-2-41" id="h30-2-41" class="i">+Regexp* CoalesceWalker::ShortVisit(Regexp* re, Regexp* parent_arg) {
</a><a href="#h30-2-42" id="h30-2-42" class="i">+  // This should never be called, since we use Walk and not
</a><a href="#h30-2-43" id="h30-2-43" class="i">+  // WalkExponential.
</a><a href="#h30-2-44" id="h30-2-44" class="i">+  LOG(DFATAL) &lt;&lt; &quot;CoalesceWalker::ShortVisit called&quot;;
</a><a href="#h30-2-45" id="h30-2-45" class="i">+  return re-&gt;Incref();
</a><a href="#h30-2-46" id="h30-2-46" class="i">+}
</a><a href="#h30-2-47" id="h30-2-47" class="i">+
</a><a href="#h30-2-48" id="h30-2-48" class="i">+Regexp* CoalesceWalker::PostVisit(Regexp* re,
</a><a href="#h30-2-49" id="h30-2-49" class="i">+                                  Regexp* parent_arg,
</a><a href="#h30-2-50" id="h30-2-50" class="i">+                                  Regexp* pre_arg,
</a><a href="#h30-2-51" id="h30-2-51" class="i">+                                  Regexp** child_args,
</a><a href="#h30-2-52" id="h30-2-52" class="i">+                                  int nchild_args) {
</a><a href="#h30-2-53" id="h30-2-53" class="i">+  if (re-&gt;nsub() == 0)
</a><a href="#h30-2-54" id="h30-2-54" class="i">+    return re-&gt;Incref();
</a><a href="#h30-2-55" id="h30-2-55" class="i">+
</a><a href="#h30-2-56" id="h30-2-56" class="i">+  if (re-&gt;op() != kRegexpConcat) {
</a><a href="#h30-2-57" id="h30-2-57" class="i">+    if (!ChildArgsChanged(re, child_args))
</a><a href="#h30-2-58" id="h30-2-58" class="i">+      return re-&gt;Incref();
</a><a href="#h30-2-59" id="h30-2-59" class="i">+
</a><a href="#h30-2-60" id="h30-2-60" class="i">+    // Something changed. Build a new op.
</a><a href="#h30-2-61" id="h30-2-61" class="i">+    Regexp* nre = new Regexp(re-&gt;op(), re-&gt;parse_flags());
</a><a href="#h30-2-62" id="h30-2-62" class="i">+    nre-&gt;AllocSub(re-&gt;nsub());
</a><a href="#h30-2-63" id="h30-2-63" class="i">+    Regexp** nre_subs = nre-&gt;sub();
</a><a href="#h30-2-64" id="h30-2-64" class="i">+    for (int i = 0; i &lt; re-&gt;nsub(); i++)
</a><a href="#h30-2-65" id="h30-2-65" class="i">+      nre_subs[i] = child_args[i];
</a><a href="#h30-2-66" id="h30-2-66" class="i">+    // Repeats and Captures have additional data that must be copied.
</a><a href="#h30-2-67" id="h30-2-67" class="i">+    if (re-&gt;op() == kRegexpRepeat) {
</a><a href="#h30-2-68" id="h30-2-68" class="i">+      nre-&gt;min_ = re-&gt;min();
</a><a href="#h30-2-69" id="h30-2-69" class="i">+      nre-&gt;max_ = re-&gt;max();
</a><a href="#h30-2-70" id="h30-2-70" class="i">+    } else if (re-&gt;op() == kRegexpCapture) {
</a><a href="#h30-2-71" id="h30-2-71" class="i">+      nre-&gt;cap_ = re-&gt;cap();
</a><a href="#h30-2-72" id="h30-2-72" class="i">+    }
</a><a href="#h30-2-73" id="h30-2-73" class="i">+    return nre;
</a><a href="#h30-2-74" id="h30-2-74" class="i">+  }
</a><a href="#h30-2-75" id="h30-2-75" class="i">+
</a><a href="#h30-2-76" id="h30-2-76" class="i">+  bool can_coalesce = false;
</a><a href="#h30-2-77" id="h30-2-77" class="i">+  for (int i = 0; i &lt; re-&gt;nsub(); i++) {
</a><a href="#h30-2-78" id="h30-2-78" class="i">+    if (i+1 &lt; re-&gt;nsub() &amp;&amp;
</a><a href="#h30-2-79" id="h30-2-79" class="i">+        CanCoalesce(child_args[i], child_args[i+1])) {
</a><a href="#h30-2-80" id="h30-2-80" class="i">+      can_coalesce = true;
</a><a href="#h30-2-81" id="h30-2-81" class="i">+      break;
</a><a href="#h30-2-82" id="h30-2-82" class="i">+    }
</a><a href="#h30-2-83" id="h30-2-83" class="i">+  }
</a><a href="#h30-2-84" id="h30-2-84" class="i">+  if (!can_coalesce) {
</a><a href="#h30-2-85" id="h30-2-85" class="i">+    if (!ChildArgsChanged(re, child_args))
</a><a href="#h30-2-86" id="h30-2-86" class="i">+      return re-&gt;Incref();
</a><a href="#h30-2-87" id="h30-2-87" class="i">+
</a><a href="#h30-2-88" id="h30-2-88" class="i">+    // Something changed. Build a new op.
</a><a href="#h30-2-89" id="h30-2-89" class="i">+    Regexp* nre = new Regexp(re-&gt;op(), re-&gt;parse_flags());
</a><a href="#h30-2-90" id="h30-2-90" class="i">+    nre-&gt;AllocSub(re-&gt;nsub());
</a><a href="#h30-2-91" id="h30-2-91" class="i">+    Regexp** nre_subs = nre-&gt;sub();
</a><a href="#h30-2-92" id="h30-2-92" class="i">+    for (int i = 0; i &lt; re-&gt;nsub(); i++)
</a><a href="#h30-2-93" id="h30-2-93" class="i">+      nre_subs[i] = child_args[i];
</a><a href="#h30-2-94" id="h30-2-94" class="i">+    return nre;
</a><a href="#h30-2-95" id="h30-2-95" class="i">+  }
</a><a href="#h30-2-96" id="h30-2-96" class="i">+
</a><a href="#h30-2-97" id="h30-2-97" class="i">+  for (int i = 0; i &lt; re-&gt;nsub(); i++) {
</a><a href="#h30-2-98" id="h30-2-98" class="i">+    if (i+1 &lt; re-&gt;nsub() &amp;&amp;
</a><a href="#h30-2-99" id="h30-2-99" class="i">+        CanCoalesce(child_args[i], child_args[i+1]))
</a><a href="#h30-2-100" id="h30-2-100" class="i">+      DoCoalesce(&amp;child_args[i], &amp;child_args[i+1]);
</a><a href="#h30-2-101" id="h30-2-101" class="i">+  }
</a><a href="#h30-2-102" id="h30-2-102" class="i">+  // Determine how many empty matches were left by DoCoalesce.
</a><a href="#h30-2-103" id="h30-2-103" class="i">+  int n = 0;
</a><a href="#h30-2-104" id="h30-2-104" class="i">+  for (int i = n; i &lt; re-&gt;nsub(); i++) {
</a><a href="#h30-2-105" id="h30-2-105" class="i">+    if (child_args[i]-&gt;op() == kRegexpEmptyMatch)
</a><a href="#h30-2-106" id="h30-2-106" class="i">+      n++;
</a><a href="#h30-2-107" id="h30-2-107" class="i">+  }
</a><a href="#h30-2-108" id="h30-2-108" class="i">+  // Build a new op.
</a><a href="#h30-2-109" id="h30-2-109" class="i">+  Regexp* nre = new Regexp(re-&gt;op(), re-&gt;parse_flags());
</a><a href="#h30-2-110" id="h30-2-110" class="i">+  nre-&gt;AllocSub(re-&gt;nsub() - n);
</a><a href="#h30-2-111" id="h30-2-111" class="i">+  Regexp** nre_subs = nre-&gt;sub();
</a><a href="#h30-2-112" id="h30-2-112" class="i">+  for (int i = 0, j = 0; i &lt; re-&gt;nsub(); i++) {
</a><a href="#h30-2-113" id="h30-2-113" class="i">+    if (child_args[i]-&gt;op() == kRegexpEmptyMatch) {
</a><a href="#h30-2-114" id="h30-2-114" class="i">+      child_args[i]-&gt;Decref();
</a><a href="#h30-2-115" id="h30-2-115" class="i">+      continue;
</a><a href="#h30-2-116" id="h30-2-116" class="i">+    }
</a><a href="#h30-2-117" id="h30-2-117" class="i">+    nre_subs[j] = child_args[i];
</a><a href="#h30-2-118" id="h30-2-118" class="i">+    j++;
</a><a href="#h30-2-119" id="h30-2-119" class="i">+  }
</a><a href="#h30-2-120" id="h30-2-120" class="i">+  return nre;
</a><a href="#h30-2-121" id="h30-2-121" class="i">+}
</a><a href="#h30-2-122" id="h30-2-122" class="i">+
</a><a href="#h30-2-123" id="h30-2-123" class="i">+bool CoalesceWalker::CanCoalesce(Regexp* r1, Regexp* r2) {
</a><a href="#h30-2-124" id="h30-2-124" class="i">+  // r1 must be a star/plus/quest/repeat of a literal, char class, any char or
</a><a href="#h30-2-125" id="h30-2-125" class="i">+  // any byte.
</a><a href="#h30-2-126" id="h30-2-126" class="i">+  if ((r1-&gt;op() == kRegexpStar ||
</a><a href="#h30-2-127" id="h30-2-127" class="i">+       r1-&gt;op() == kRegexpPlus ||
</a><a href="#h30-2-128" id="h30-2-128" class="i">+       r1-&gt;op() == kRegexpQuest ||
</a><a href="#h30-2-129" id="h30-2-129" class="i">+       r1-&gt;op() == kRegexpRepeat) &amp;&amp;
</a><a href="#h30-2-130" id="h30-2-130" class="i">+      (r1-&gt;sub()[0]-&gt;op() == kRegexpLiteral ||
</a><a href="#h30-2-131" id="h30-2-131" class="i">+       r1-&gt;sub()[0]-&gt;op() == kRegexpCharClass ||
</a><a href="#h30-2-132" id="h30-2-132" class="i">+       r1-&gt;sub()[0]-&gt;op() == kRegexpAnyChar ||
</a><a href="#h30-2-133" id="h30-2-133" class="i">+       r1-&gt;sub()[0]-&gt;op() == kRegexpAnyByte)) {
</a><a href="#h30-2-134" id="h30-2-134" class="i">+    // r2 must be a star/plus/quest/repeat of the same literal, char class,
</a><a href="#h30-2-135" id="h30-2-135" class="i">+    // any char or any byte.
</a><a href="#h30-2-136" id="h30-2-136" class="i">+    if ((r2-&gt;op() == kRegexpStar ||
</a><a href="#h30-2-137" id="h30-2-137" class="i">+         r2-&gt;op() == kRegexpPlus ||
</a><a href="#h30-2-138" id="h30-2-138" class="i">+         r2-&gt;op() == kRegexpQuest ||
</a><a href="#h30-2-139" id="h30-2-139" class="i">+         r2-&gt;op() == kRegexpRepeat) &amp;&amp;
</a><a href="#h30-2-140" id="h30-2-140" class="i">+        Regexp::Equal(r1-&gt;sub()[0], r2-&gt;sub()[0]) &amp;&amp;
</a><a href="#h30-2-141" id="h30-2-141" class="i">+        // The parse flags must be consistent.
</a><a href="#h30-2-142" id="h30-2-142" class="i">+        ((r1-&gt;parse_flags() &amp; Regexp::NonGreedy) ==
</a><a href="#h30-2-143" id="h30-2-143" class="i">+         (r2-&gt;parse_flags() &amp; Regexp::NonGreedy))) {
</a><a href="#h30-2-144" id="h30-2-144" class="i">+      return true;
</a><a href="#h30-2-145" id="h30-2-145" class="i">+    }
</a><a href="#h30-2-146" id="h30-2-146" class="i">+    // ... OR an occurrence of that literal, char class, any char or any byte
</a><a href="#h30-2-147" id="h30-2-147" class="i">+    if (Regexp::Equal(r1-&gt;sub()[0], r2)) {
</a><a href="#h30-2-148" id="h30-2-148" class="i">+      return true;
</a><a href="#h30-2-149" id="h30-2-149" class="i">+    }
</a><a href="#h30-2-150" id="h30-2-150" class="i">+    // ... OR a literal string that begins with that literal.
</a><a href="#h30-2-151" id="h30-2-151" class="i">+    if (r1-&gt;sub()[0]-&gt;op() == kRegexpLiteral &amp;&amp;
</a><a href="#h30-2-152" id="h30-2-152" class="i">+        r2-&gt;op() == kRegexpLiteralString &amp;&amp;
</a><a href="#h30-2-153" id="h30-2-153" class="i">+        r2-&gt;runes()[0] == r1-&gt;sub()[0]-&gt;rune() &amp;&amp;
</a><a href="#h30-2-154" id="h30-2-154" class="i">+        // The parse flags must be consistent.
</a><a href="#h30-2-155" id="h30-2-155" class="i">+        ((r1-&gt;sub()[0]-&gt;parse_flags() &amp; Regexp::FoldCase) ==
</a><a href="#h30-2-156" id="h30-2-156" class="i">+         (r2-&gt;parse_flags() &amp; Regexp::FoldCase))) {
</a><a href="#h30-2-157" id="h30-2-157" class="i">+      return true;
</a><a href="#h30-2-158" id="h30-2-158" class="i">+    }
</a><a href="#h30-2-159" id="h30-2-159" class="i">+  }
</a><a href="#h30-2-160" id="h30-2-160" class="i">+  return false;
</a><a href="#h30-2-161" id="h30-2-161" class="i">+}
</a><a href="#h30-2-162" id="h30-2-162" class="i">+
</a><a href="#h30-2-163" id="h30-2-163" class="i">+void CoalesceWalker::DoCoalesce(Regexp** r1ptr, Regexp** r2ptr) {
</a><a href="#h30-2-164" id="h30-2-164" class="i">+  Regexp* r1 = *r1ptr;
</a><a href="#h30-2-165" id="h30-2-165" class="i">+  Regexp* r2 = *r2ptr;
</a><a href="#h30-2-166" id="h30-2-166" class="i">+
</a><a href="#h30-2-167" id="h30-2-167" class="i">+  Regexp* nre = Regexp::Repeat(
</a><a href="#h30-2-168" id="h30-2-168" class="i">+      r1-&gt;sub()[0]-&gt;Incref(), r1-&gt;parse_flags(), 0, 0);
</a><a href="#h30-2-169" id="h30-2-169" class="i">+
</a><a href="#h30-2-170" id="h30-2-170" class="i">+  switch (r1-&gt;op()) {
</a><a href="#h30-2-171" id="h30-2-171" class="i">+    case kRegexpStar:
</a><a href="#h30-2-172" id="h30-2-172" class="i">+      nre-&gt;min_ = 0;
</a><a href="#h30-2-173" id="h30-2-173" class="i">+      nre-&gt;max_ = -1;
</a><a href="#h30-2-174" id="h30-2-174" class="i">+      break;
</a><a href="#h30-2-175" id="h30-2-175" class="i">+
</a><a href="#h30-2-176" id="h30-2-176" class="i">+    case kRegexpPlus:
</a><a href="#h30-2-177" id="h30-2-177" class="i">+      nre-&gt;min_ = 1;
</a><a href="#h30-2-178" id="h30-2-178" class="i">+      nre-&gt;max_ = -1;
</a><a href="#h30-2-179" id="h30-2-179" class="i">+      break;
</a><a href="#h30-2-180" id="h30-2-180" class="i">+
</a><a href="#h30-2-181" id="h30-2-181" class="i">+    case kRegexpQuest:
</a><a href="#h30-2-182" id="h30-2-182" class="i">+      nre-&gt;min_ = 0;
</a><a href="#h30-2-183" id="h30-2-183" class="i">+      nre-&gt;max_ = 1;
</a><a href="#h30-2-184" id="h30-2-184" class="i">+      break;
</a><a href="#h30-2-185" id="h30-2-185" class="i">+
</a><a href="#h30-2-186" id="h30-2-186" class="i">+    case kRegexpRepeat:
</a><a href="#h30-2-187" id="h30-2-187" class="i">+      nre-&gt;min_ = r1-&gt;min();
</a><a href="#h30-2-188" id="h30-2-188" class="i">+      nre-&gt;max_ = r1-&gt;max();
</a><a href="#h30-2-189" id="h30-2-189" class="i">+      break;
</a><a href="#h30-2-190" id="h30-2-190" class="i">+
</a><a href="#h30-2-191" id="h30-2-191" class="i">+    default:
</a><a href="#h30-2-192" id="h30-2-192" class="i">+      LOG(DFATAL) &lt;&lt; &quot;DoCoalesce failed: r1-&gt;op() is &quot; &lt;&lt; r1-&gt;op();
</a><a href="#h30-2-193" id="h30-2-193" class="i">+      nre-&gt;Decref();
</a><a href="#h30-2-194" id="h30-2-194" class="i">+      return;
</a><a href="#h30-2-195" id="h30-2-195" class="i">+  }
</a><a href="#h30-2-196" id="h30-2-196" class="i">+
</a><a href="#h30-2-197" id="h30-2-197" class="i">+  switch (r2-&gt;op()) {
</a><a href="#h30-2-198" id="h30-2-198" class="i">+    case kRegexpStar:
</a><a href="#h30-2-199" id="h30-2-199" class="i">+      nre-&gt;max_ = -1;
</a><a href="#h30-2-200" id="h30-2-200" class="i">+      goto LeaveEmpty;
</a><a href="#h30-2-201" id="h30-2-201" class="i">+
</a><a href="#h30-2-202" id="h30-2-202" class="i">+    case kRegexpPlus:
</a><a href="#h30-2-203" id="h30-2-203" class="i">+      nre-&gt;min_++;
</a><a href="#h30-2-204" id="h30-2-204" class="i">+      nre-&gt;max_ = -1;
</a><a href="#h30-2-205" id="h30-2-205" class="i">+      goto LeaveEmpty;
</a><a href="#h30-2-206" id="h30-2-206" class="i">+
</a><a href="#h30-2-207" id="h30-2-207" class="i">+    case kRegexpQuest:
</a><a href="#h30-2-208" id="h30-2-208" class="i">+      if (nre-&gt;max() != -1)
</a><a href="#h30-2-209" id="h30-2-209" class="i">+        nre-&gt;max_++;
</a><a href="#h30-2-210" id="h30-2-210" class="i">+      goto LeaveEmpty;
</a><a href="#h30-2-211" id="h30-2-211" class="i">+
</a><a href="#h30-2-212" id="h30-2-212" class="i">+    case kRegexpRepeat:
</a><a href="#h30-2-213" id="h30-2-213" class="i">+      nre-&gt;min_ += r2-&gt;min();
</a><a href="#h30-2-214" id="h30-2-214" class="i">+      if (r2-&gt;max() == -1)
</a><a href="#h30-2-215" id="h30-2-215" class="i">+        nre-&gt;max_ = -1;
</a><a href="#h30-2-216" id="h30-2-216" class="i">+      else if (nre-&gt;max() != -1)
</a><a href="#h30-2-217" id="h30-2-217" class="i">+        nre-&gt;max_ += r2-&gt;max();
</a><a href="#h30-2-218" id="h30-2-218" class="i">+      goto LeaveEmpty;
</a><a href="#h30-2-219" id="h30-2-219" class="i">+
</a><a href="#h30-2-220" id="h30-2-220" class="i">+    case kRegexpLiteral:
</a><a href="#h30-2-221" id="h30-2-221" class="i">+    case kRegexpCharClass:
</a><a href="#h30-2-222" id="h30-2-222" class="i">+    case kRegexpAnyChar:
</a><a href="#h30-2-223" id="h30-2-223" class="i">+    case kRegexpAnyByte:
</a><a href="#h30-2-224" id="h30-2-224" class="i">+      nre-&gt;min_++;
</a><a href="#h30-2-225" id="h30-2-225" class="i">+      if (nre-&gt;max() != -1)
</a><a href="#h30-2-226" id="h30-2-226" class="i">+        nre-&gt;max_++;
</a><a href="#h30-2-227" id="h30-2-227" class="i">+      goto LeaveEmpty;
</a><a href="#h30-2-228" id="h30-2-228" class="i">+
</a><a href="#h30-2-229" id="h30-2-229" class="i">+    LeaveEmpty:
</a><a href="#h30-2-230" id="h30-2-230" class="i">+      *r1ptr = new Regexp(kRegexpEmptyMatch, Regexp::NoParseFlags);
</a><a href="#h30-2-231" id="h30-2-231" class="i">+      *r2ptr = nre;
</a><a href="#h30-2-232" id="h30-2-232" class="i">+      break;
</a><a href="#h30-2-233" id="h30-2-233" class="i">+
</a><a href="#h30-2-234" id="h30-2-234" class="i">+    case kRegexpLiteralString: {
</a><a href="#h30-2-235" id="h30-2-235" class="i">+      Rune r = r1-&gt;sub()[0]-&gt;rune();
</a><a href="#h30-2-236" id="h30-2-236" class="i">+      // Determine how much of the literal string is removed.
</a><a href="#h30-2-237" id="h30-2-237" class="i">+      // We know that we have at least one rune. :)
</a><a href="#h30-2-238" id="h30-2-238" class="i">+      int n = 1;
</a><a href="#h30-2-239" id="h30-2-239" class="i">+      while (n &lt; r2-&gt;nrunes() &amp;&amp; r2-&gt;runes()[n] == r)
</a><a href="#h30-2-240" id="h30-2-240" class="i">+        n++;
</a><a href="#h30-2-241" id="h30-2-241" class="i">+      nre-&gt;min_ += n;
</a><a href="#h30-2-242" id="h30-2-242" class="i">+      if (nre-&gt;max() != -1)
</a><a href="#h30-2-243" id="h30-2-243" class="i">+        nre-&gt;max_ += n;
</a><a href="#h30-2-244" id="h30-2-244" class="i">+      if (n == r2-&gt;nrunes())
</a><a href="#h30-2-245" id="h30-2-245" class="i">+        goto LeaveEmpty;
</a><a href="#h30-2-246" id="h30-2-246" class="i">+      *r1ptr = nre;
</a><a href="#h30-2-247" id="h30-2-247" class="i">+      *r2ptr = Regexp::LiteralString(
</a><a href="#h30-2-248" id="h30-2-248" class="i">+          &amp;r2-&gt;runes()[n], r2-&gt;nrunes() - n, r2-&gt;parse_flags());
</a><a href="#h30-2-249" id="h30-2-249" class="i">+      break;
</a><a href="#h30-2-250" id="h30-2-250" class="i">+    }
</a><a href="#h30-2-251" id="h30-2-251" class="i">+
</a><a href="#h30-2-252" id="h30-2-252" class="i">+    default:
</a><a href="#h30-2-253" id="h30-2-253" class="i">+      LOG(DFATAL) &lt;&lt; &quot;DoCoalesce failed: r2-&gt;op() is &quot; &lt;&lt; r2-&gt;op();
</a><a href="#h30-2-254" id="h30-2-254" class="i">+      nre-&gt;Decref();
</a><a href="#h30-2-255" id="h30-2-255" class="i">+      return;
</a><a href="#h30-2-256" id="h30-2-256" class="i">+  }
</a><a href="#h30-2-257" id="h30-2-257" class="i">+
</a><a href="#h30-2-258" id="h30-2-258" class="i">+  r1-&gt;Decref();
</a><a href="#h30-2-259" id="h30-2-259" class="i">+  r2-&gt;Decref();
</a><a href="#h30-2-260" id="h30-2-260" class="i">+}
</a><a href="#h30-2-261" id="h30-2-261" class="i">+
</a> Regexp* SimplifyWalker::Copy(Regexp* re) {
   return re-&gt;Incref();
 }
<a href="#h30-3" id="h30-3" class="h">@@ -196,29 +471,14 @@ Regexp* SimplifyWalker::PostVisit(Regexp* re,
</a>     case kRegexpConcat:
     case kRegexpAlternate: {
       // These are simple as long as the subpieces are simple.
<a href="#h30-3-3" id="h30-3-3" class="d">-      // Two passes to avoid allocation in the common case.
</a><a href="#h30-3-4" id="h30-3-4" class="d">-      bool changed = false;
</a><a href="#h30-3-5" id="h30-3-5" class="d">-      Regexp** subs = re-&gt;sub();
</a><a href="#h30-3-6" id="h30-3-6" class="d">-      for (int i = 0; i &lt; re-&gt;nsub_; i++) {
</a><a href="#h30-3-7" id="h30-3-7" class="d">-        Regexp* sub = subs[i];
</a><a href="#h30-3-8" id="h30-3-8" class="d">-        Regexp* newsub = child_args[i];
</a><a href="#h30-3-9" id="h30-3-9" class="d">-        if (newsub != sub) {
</a><a href="#h30-3-10" id="h30-3-10" class="d">-          changed = true;
</a><a href="#h30-3-11" id="h30-3-11" class="d">-          break;
</a><a href="#h30-3-12" id="h30-3-12" class="d">-        }
</a><a href="#h30-3-13" id="h30-3-13" class="d">-      }
</a><a href="#h30-3-14" id="h30-3-14" class="d">-      if (!changed) {
</a><a href="#h30-3-15" id="h30-3-15" class="d">-        for (int i = 0; i &lt; re-&gt;nsub_; i++) {
</a><a href="#h30-3-16" id="h30-3-16" class="d">-          Regexp* newsub = child_args[i];
</a><a href="#h30-3-17" id="h30-3-17" class="d">-          newsub-&gt;Decref();
</a><a href="#h30-3-18" id="h30-3-18" class="d">-        }
</a><a href="#h30-3-19" id="h30-3-19" class="i">+      if (!ChildArgsChanged(re, child_args)) {
</a>         re-&gt;simple_ = true;
         return re-&gt;Incref();
       }
       Regexp* nre = new Regexp(re-&gt;op(), re-&gt;parse_flags());
<a href="#h30-3-24" id="h30-3-24" class="d">-      nre-&gt;AllocSub(re-&gt;nsub_);
</a><a href="#h30-3-25" id="h30-3-25" class="i">+      nre-&gt;AllocSub(re-&gt;nsub());
</a>       Regexp** nre_subs = nre-&gt;sub();
<a href="#h30-3-27" id="h30-3-27" class="d">-      for (int i = 0; i &lt;re-&gt;nsub_; i++)
</a><a href="#h30-3-28" id="h30-3-28" class="i">+      for (int i = 0; i &lt; re-&gt;nsub(); i++)
</a>         nre_subs[i] = child_args[i];
       nre-&gt;simple_ = true;
       return nre;
<a href="#h30-4" id="h30-4" class="h">@@ -234,7 +494,7 @@ Regexp* SimplifyWalker::PostVisit(Regexp* re,
</a>       Regexp* nre = new Regexp(kRegexpCapture, re-&gt;parse_flags());
       nre-&gt;AllocSub(1);
       nre-&gt;sub()[0] = newsub;
<a href="#h30-4-3" id="h30-4-3" class="d">-      nre-&gt;cap_ = re-&gt;cap_;
</a><a href="#h30-4-4" id="h30-4-4" class="i">+      nre-&gt;cap_ = re-&gt;cap();
</a>       nre-&gt;simple_ = true;
       return nre;
     }
<b>diff --git a/<a id="h31" href="../file/src/vendor/re2/re2/stringpiece.cc">src/vendor/re2/re2/stringpiece.cc</a> b/<a href="../file/src/vendor/re2/re2/stringpiece.cc">src/vendor/re2/re2/stringpiece.cc</a></b>
<a href="#h31-0" id="h31-0" class="h">@@ -0,0 +1,95 @@
</a><a href="#h31-0-0" id="h31-0-0" class="i">+// Copyright 2004 The RE2 Authors.  All Rights Reserved.
</a><a href="#h31-0-1" id="h31-0-1" class="i">+// Use of this source code is governed by a BSD-style
</a><a href="#h31-0-2" id="h31-0-2" class="i">+// license that can be found in the LICENSE file.
</a><a href="#h31-0-3" id="h31-0-3" class="i">+
</a><a href="#h31-0-4" id="h31-0-4" class="i">+#include &quot;re2/stringpiece.h&quot;
</a><a href="#h31-0-5" id="h31-0-5" class="i">+#include &quot;util/util.h&quot;
</a><a href="#h31-0-6" id="h31-0-6" class="i">+
</a><a href="#h31-0-7" id="h31-0-7" class="i">+using re2::StringPiece;
</a><a href="#h31-0-8" id="h31-0-8" class="i">+
</a><a href="#h31-0-9" id="h31-0-9" class="i">+std::ostream&amp; operator&lt;&lt;(std::ostream&amp; o, const StringPiece&amp; piece) {
</a><a href="#h31-0-10" id="h31-0-10" class="i">+  o.write(piece.data(), piece.size());
</a><a href="#h31-0-11" id="h31-0-11" class="i">+  return o;
</a><a href="#h31-0-12" id="h31-0-12" class="i">+}
</a><a href="#h31-0-13" id="h31-0-13" class="i">+
</a><a href="#h31-0-14" id="h31-0-14" class="i">+bool StringPiece::_equal(const StringPiece&amp; x, const StringPiece&amp; y) {
</a><a href="#h31-0-15" id="h31-0-15" class="i">+  int len = x.size();
</a><a href="#h31-0-16" id="h31-0-16" class="i">+  if (len != y.size()) {
</a><a href="#h31-0-17" id="h31-0-17" class="i">+    return false;
</a><a href="#h31-0-18" id="h31-0-18" class="i">+  }
</a><a href="#h31-0-19" id="h31-0-19" class="i">+  const char* p = x.data();
</a><a href="#h31-0-20" id="h31-0-20" class="i">+  const char* p2 = y.data();
</a><a href="#h31-0-21" id="h31-0-21" class="i">+  // Test last byte in case strings share large common prefix
</a><a href="#h31-0-22" id="h31-0-22" class="i">+  if ((len &gt; 0) &amp;&amp; (p[len-1] != p2[len-1])) return false;
</a><a href="#h31-0-23" id="h31-0-23" class="i">+  const char* p_limit = p + len;
</a><a href="#h31-0-24" id="h31-0-24" class="i">+  for (; p &lt; p_limit; p++, p2++) {
</a><a href="#h31-0-25" id="h31-0-25" class="i">+    if (*p != *p2)
</a><a href="#h31-0-26" id="h31-0-26" class="i">+      return false;
</a><a href="#h31-0-27" id="h31-0-27" class="i">+  }
</a><a href="#h31-0-28" id="h31-0-28" class="i">+  return true;
</a><a href="#h31-0-29" id="h31-0-29" class="i">+}
</a><a href="#h31-0-30" id="h31-0-30" class="i">+
</a><a href="#h31-0-31" id="h31-0-31" class="i">+void StringPiece::CopyToString(string* target) const {
</a><a href="#h31-0-32" id="h31-0-32" class="i">+  target-&gt;assign(ptr_, length_);
</a><a href="#h31-0-33" id="h31-0-33" class="i">+}
</a><a href="#h31-0-34" id="h31-0-34" class="i">+
</a><a href="#h31-0-35" id="h31-0-35" class="i">+void StringPiece::AppendToString(string* target) const {
</a><a href="#h31-0-36" id="h31-0-36" class="i">+  target-&gt;append(ptr_, length_);
</a><a href="#h31-0-37" id="h31-0-37" class="i">+}
</a><a href="#h31-0-38" id="h31-0-38" class="i">+
</a><a href="#h31-0-39" id="h31-0-39" class="i">+int StringPiece::copy(char* buf, size_type n, size_type pos) const {
</a><a href="#h31-0-40" id="h31-0-40" class="i">+  int ret = min(length_ - pos, n);
</a><a href="#h31-0-41" id="h31-0-41" class="i">+  memcpy(buf, ptr_ + pos, ret);
</a><a href="#h31-0-42" id="h31-0-42" class="i">+  return ret;
</a><a href="#h31-0-43" id="h31-0-43" class="i">+}
</a><a href="#h31-0-44" id="h31-0-44" class="i">+
</a><a href="#h31-0-45" id="h31-0-45" class="i">+bool StringPiece::contains(StringPiece s) const {
</a><a href="#h31-0-46" id="h31-0-46" class="i">+  return (size_t)find(s, 0) != npos;
</a><a href="#h31-0-47" id="h31-0-47" class="i">+}
</a><a href="#h31-0-48" id="h31-0-48" class="i">+
</a><a href="#h31-0-49" id="h31-0-49" class="i">+int StringPiece::find(const StringPiece&amp; s, size_type pos) const {
</a><a href="#h31-0-50" id="h31-0-50" class="i">+  if (length_ &lt; 0 || pos &gt; static_cast&lt;size_type&gt;(length_))
</a><a href="#h31-0-51" id="h31-0-51" class="i">+    return npos;
</a><a href="#h31-0-52" id="h31-0-52" class="i">+
</a><a href="#h31-0-53" id="h31-0-53" class="i">+  const char* result = std::search(ptr_ + pos, ptr_ + length_,
</a><a href="#h31-0-54" id="h31-0-54" class="i">+                                   s.ptr_, s.ptr_ + s.length_);
</a><a href="#h31-0-55" id="h31-0-55" class="i">+  const size_type xpos = result - ptr_;
</a><a href="#h31-0-56" id="h31-0-56" class="i">+  return xpos + s.length_ &lt;= static_cast&lt;size_type&gt;(length_) ? xpos : npos;
</a><a href="#h31-0-57" id="h31-0-57" class="i">+}
</a><a href="#h31-0-58" id="h31-0-58" class="i">+
</a><a href="#h31-0-59" id="h31-0-59" class="i">+int StringPiece::find(char c, size_type pos) const {
</a><a href="#h31-0-60" id="h31-0-60" class="i">+  if (length_ &lt;= 0 || pos &gt;= static_cast&lt;size_type&gt;(length_)) {
</a><a href="#h31-0-61" id="h31-0-61" class="i">+    return npos;
</a><a href="#h31-0-62" id="h31-0-62" class="i">+  }
</a><a href="#h31-0-63" id="h31-0-63" class="i">+  const char* result = std::find(ptr_ + pos, ptr_ + length_, c);
</a><a href="#h31-0-64" id="h31-0-64" class="i">+  return result != ptr_ + length_ ? result - ptr_ : npos;
</a><a href="#h31-0-65" id="h31-0-65" class="i">+}
</a><a href="#h31-0-66" id="h31-0-66" class="i">+
</a><a href="#h31-0-67" id="h31-0-67" class="i">+int StringPiece::rfind(const StringPiece&amp; s, size_type pos) const {
</a><a href="#h31-0-68" id="h31-0-68" class="i">+  if (length_ &lt; s.length_) return npos;
</a><a href="#h31-0-69" id="h31-0-69" class="i">+  const size_t ulen = length_;
</a><a href="#h31-0-70" id="h31-0-70" class="i">+  if (s.length_ == 0) return min(ulen, pos);
</a><a href="#h31-0-71" id="h31-0-71" class="i">+
</a><a href="#h31-0-72" id="h31-0-72" class="i">+  const char* last = ptr_ + min(ulen - s.length_, pos) + s.length_;
</a><a href="#h31-0-73" id="h31-0-73" class="i">+  const char* result = std::find_end(ptr_, last, s.ptr_, s.ptr_ + s.length_);
</a><a href="#h31-0-74" id="h31-0-74" class="i">+  return result != last ? result - ptr_ : npos;
</a><a href="#h31-0-75" id="h31-0-75" class="i">+}
</a><a href="#h31-0-76" id="h31-0-76" class="i">+
</a><a href="#h31-0-77" id="h31-0-77" class="i">+int StringPiece::rfind(char c, size_type pos) const {
</a><a href="#h31-0-78" id="h31-0-78" class="i">+  if (length_ &lt;= 0) return npos;
</a><a href="#h31-0-79" id="h31-0-79" class="i">+  for (int i = min(pos, static_cast&lt;size_type&gt;(length_ - 1));
</a><a href="#h31-0-80" id="h31-0-80" class="i">+       i &gt;= 0; --i) {
</a><a href="#h31-0-81" id="h31-0-81" class="i">+    if (ptr_[i] == c) {
</a><a href="#h31-0-82" id="h31-0-82" class="i">+      return i;
</a><a href="#h31-0-83" id="h31-0-83" class="i">+    }
</a><a href="#h31-0-84" id="h31-0-84" class="i">+  }
</a><a href="#h31-0-85" id="h31-0-85" class="i">+  return npos;
</a><a href="#h31-0-86" id="h31-0-86" class="i">+}
</a><a href="#h31-0-87" id="h31-0-87" class="i">+
</a><a href="#h31-0-88" id="h31-0-88" class="i">+StringPiece StringPiece::substr(size_type pos, size_type n) const {
</a><a href="#h31-0-89" id="h31-0-89" class="i">+  if (pos &gt; static_cast&lt;size_type&gt;(length_)) pos = static_cast&lt;size_type&gt;(length_);
</a><a href="#h31-0-90" id="h31-0-90" class="i">+  if (n &gt; length_ - pos) n = length_ - pos;
</a><a href="#h31-0-91" id="h31-0-91" class="i">+  return StringPiece(ptr_ + pos, n);
</a><a href="#h31-0-92" id="h31-0-92" class="i">+}
</a><a href="#h31-0-93" id="h31-0-93" class="i">+
</a><a href="#h31-0-94" id="h31-0-94" class="i">+const StringPiece::size_type StringPiece::npos = size_type(-1);
</a><b>diff --git a/<a id="h32" href="../file/src/vendor/re2/re2/stringpiece.h">src/vendor/re2/re2/stringpiece.h</a> b/<a href="../file/src/vendor/re2/re2/stringpiece.h">src/vendor/re2/re2/stringpiece.h</a></b>
<a href="#h32-0" id="h32-0" class="h">@@ -20,6 +20,7 @@
</a> #define STRINGS_STRINGPIECE_H__
 
 #include &lt;string.h&gt;
<a href="#h32-0-3" id="h32-0-3" class="i">+#include &lt;algorithm&gt;
</a> #include &lt;cstddef&gt;
 #include &lt;iosfwd&gt;
 #include &lt;string&gt;
<b>diff --git a/<a id="h33" href="../file/src/vendor/re2/re2/testing/compile_test.cc">src/vendor/re2/re2/testing/compile_test.cc</a> b/<a href="../file/src/vendor/re2/re2/testing/compile_test.cc">src/vendor/re2/re2/testing/compile_test.cc</a></b>
<a href="#h33-0" id="h33-0" class="h">@@ -99,6 +99,10 @@ static Test tests[] = {
</a>   { &quot;[Aa]&quot;,
     &quot;1. byte/i [61-61] -&gt; 2\n&quot;
     &quot;2. match! 0\n&quot; },
<a href="#h33-0-3" id="h33-0-3" class="i">+  // Issue 20992936
</a><a href="#h33-0-4" id="h33-0-4" class="i">+  { &quot;[[-`]&quot;,
</a><a href="#h33-0-5" id="h33-0-5" class="i">+    &quot;1. byte [5b-60] -&gt; 2\n&quot;
</a><a href="#h33-0-6" id="h33-0-6" class="i">+    &quot;2. match! 0\n&quot; },
</a> };
 
 TEST(TestRegexpCompileToProg, Simple) {
<b>diff --git a/<a id="h34" href="../file/src/vendor/re2/re2/testing/dfa_test.cc">src/vendor/re2/re2/testing/dfa_test.cc</a> b/<a href="../file/src/vendor/re2/re2/testing/dfa_test.cc">src/vendor/re2/re2/testing/dfa_test.cc</a></b>
<a href="#h34-0" id="h34-0" class="h">@@ -2,14 +2,16 @@
</a> // Use of this source code is governed by a BSD-style
 // license that can be found in the LICENSE file.
 
<a href="#h34-0-3" id="h34-0-3" class="d">-#include &quot;util/test.h&quot;
</a> #include &quot;util/thread.h&quot;
<a href="#h34-0-5" id="h34-0-5" class="i">+#include &quot;util/test.h&quot;
</a> #include &quot;re2/prog.h&quot;
 #include &quot;re2/re2.h&quot;
 #include &quot;re2/regexp.h&quot;
 #include &quot;re2/testing/regexp_generator.h&quot;
 #include &quot;re2/testing/string_generator.h&quot;
 
<a href="#h34-0-12" id="h34-0-12" class="i">+const bool UsingMallocCounter = false;
</a><a href="#h34-0-13" id="h34-0-13" class="i">+
</a> DECLARE_bool(re2_dfa_bail_when_slow);
 
 DEFINE_int32(size, 8, &quot;log2(number of DFA nodes)&quot;);
<a href="#h34-1" id="h34-1" class="h">@@ -92,14 +94,13 @@ TEST(SingleThreaded, BuildEntireDFA) {
</a>     s += &quot;[ab]&quot;;
   s += &quot;b&quot;;
 
<a href="#h34-1-3" id="h34-1-3" class="d">-  //LOG(INFO) &lt;&lt; s;
</a>   Regexp* re = Regexp::Parse(s, Regexp::LikePerl, NULL);
   CHECK(re);
   int max = 24;
   for (int i = 17; i &lt; max; i++) {
<a href="#h34-1-8" id="h34-1-8" class="d">-    int limit = 1&lt;&lt;i;
</a><a href="#h34-1-9" id="h34-1-9" class="d">-    int usage;
</a><a href="#h34-1-10" id="h34-1-10" class="d">-    //int progusage, dfamem;
</a><a href="#h34-1-11" id="h34-1-11" class="i">+    int64 limit = 1&lt;&lt;i;
</a><a href="#h34-1-12" id="h34-1-12" class="i">+    int64 usage;
</a><a href="#h34-1-13" id="h34-1-13" class="i">+    //int64 progusage, dfamem;
</a>     {
       testing::MallocCounter m(testing::MallocCounter::THIS_THREAD_ONLY);
       Prog* prog = re-&gt;CompileToProg(limit);
<a href="#h34-2" id="h34-2" class="h">@@ -113,10 +114,13 @@ TEST(SingleThreaded, BuildEntireDFA) {
</a>     }
     if (!UsingMallocCounter)
       continue;
<a href="#h34-2-3" id="h34-2-3" class="d">-    //LOG(INFO) &lt;&lt; StringPrintf(&quot;Limit %d: prog used %d, DFA budget %d, total %d\n&quot;,
</a><a href="#h34-2-4" id="h34-2-4" class="d">-    //                          limit, progusage, dfamem, usage);
</a><a href="#h34-2-5" id="h34-2-5" class="d">-    CHECK_GT(usage, limit*8/10);
</a><a href="#h34-2-6" id="h34-2-6" class="d">-    CHECK_LT(usage, limit + (16&lt;&lt;10));  // 16kB of slop okay
</a><a href="#h34-2-7" id="h34-2-7" class="i">+    //LOG(INFO) &lt;&lt; &quot;limit &quot; &lt;&lt; limit &lt;&lt; &quot;, &quot;
</a><a href="#h34-2-8" id="h34-2-8" class="i">+    //          &lt;&lt; &quot;prog usage &quot; &lt;&lt; progusage &lt;&lt; &quot;, &quot;
</a><a href="#h34-2-9" id="h34-2-9" class="i">+    //          &lt;&lt; &quot;DFA budget &quot; &lt;&lt; dfamem &lt;&lt; &quot;, &quot;
</a><a href="#h34-2-10" id="h34-2-10" class="i">+    //          &lt;&lt; &quot;total &quot; &lt;&lt; usage;
</a><a href="#h34-2-11" id="h34-2-11" class="i">+    // Tolerate +/- 10%.
</a><a href="#h34-2-12" id="h34-2-12" class="i">+    CHECK_GT(usage, limit*9/10);
</a><a href="#h34-2-13" id="h34-2-13" class="i">+    CHECK_LT(usage, limit*11/10);
</a>   }
   re-&gt;Decref();
 }
<a href="#h34-3" id="h34-3" class="h">@@ -221,13 +225,13 @@ TEST(SingleThreaded, SearchDFA) {
</a>     peak_usage = m.PeakHeapGrowth();
     delete prog;
   }
<a href="#h34-3-3" id="h34-3-3" class="d">-  re-&gt;Decref();
</a><a href="#h34-3-4" id="h34-3-4" class="d">-
</a>   if (!UsingMallocCounter)
     return;
<a href="#h34-3-7" id="h34-3-7" class="d">-  //LOG(INFO) &lt;&lt; &quot;usage &quot; &lt;&lt; usage &lt;&lt; &quot; &quot; &lt;&lt; peak_usage;
</a><a href="#h34-3-8" id="h34-3-8" class="i">+  //LOG(INFO) &lt;&lt; &quot;usage &quot; &lt;&lt; usage &lt;&lt; &quot;, &quot;
</a><a href="#h34-3-9" id="h34-3-9" class="i">+  //          &lt;&lt; &quot;peak usage &quot; &lt;&lt; peak_usage;
</a>   CHECK_LT(usage, 1&lt;&lt;n);
   CHECK_LT(peak_usage, 1&lt;&lt;n);
<a href="#h34-3-12" id="h34-3-12" class="i">+  re-&gt;Decref();
</a> }
 
 // Helper thread: searches for match, which should match,
<b>diff --git a/<a id="h35" href="../file/src/vendor/re2/re2/testing/dump.cc">src/vendor/re2/re2/testing/dump.cc</a> b/<a href="../file/src/vendor/re2/re2/testing/dump.cc">src/vendor/re2/re2/testing/dump.cc</a></b>
<a href="#h35-0" id="h35-0" class="h">@@ -120,6 +120,8 @@ static void DumpRegexpAppending(Regexp* re, string* s) {
</a>       DumpRegexpAppending(re-&gt;sub()[0], s);
       break;
     case kRegexpCapture:
<a href="#h35-0-3" id="h35-0-3" class="i">+      if (re-&gt;cap() == 0)
</a><a href="#h35-0-4" id="h35-0-4" class="i">+        LOG(DFATAL) &lt;&lt; &quot;kRegexpCapture cap() == 0&quot;;
</a>       if (re-&gt;name()) {
         s-&gt;append(*re-&gt;name());
         s-&gt;append(&quot;:&quot;);
<b>diff --git a/<a id="h36" href="../file/src/vendor/re2/re2/testing/filtered_re2_test.cc">src/vendor/re2/re2/testing/filtered_re2_test.cc</a> b/<a href="../file/src/vendor/re2/re2/testing/filtered_re2_test.cc">src/vendor/re2/re2/testing/filtered_re2_test.cc</a></b>
<a href="#h36-0" id="h36-0" class="h">@@ -44,7 +44,7 @@ TEST(FilteredRE2Test, SmallLatinTest) {
</a>   FilterTestVars v;
   int id;
 
<a href="#h36-0-3" id="h36-0-3" class="d">-  v.opts.set_utf8(false);
</a><a href="#h36-0-4" id="h36-0-4" class="i">+  v.opts.set_encoding(RE2::Options::EncodingLatin1);
</a>   v.f.Add(&quot;\xde\xadQ\xbe\xef&quot;, v.opts, &amp;id);
   v.f.Compile(&amp;v.atoms);
   EXPECT_EQ(1, v.atoms.size());
<a href="#h36-1" id="h36-1" class="h">@@ -189,18 +189,16 @@ TEST(FilteredRE2Test, AtomTests) {
</a>   EXPECT_EQ(0, nfail);
 }
 
<a href="#h36-1-3" id="h36-1-3" class="d">-void FindAtomIndices(const vector&lt;string&gt; atoms,
</a><a href="#h36-1-4" id="h36-1-4" class="d">-                     const vector&lt;string&gt; matched_atoms,
</a><a href="#h36-1-5" id="h36-1-5" class="i">+void FindAtomIndices(const vector&lt;string&gt;&amp; atoms,
</a><a href="#h36-1-6" id="h36-1-6" class="i">+                     const vector&lt;string&gt;&amp; matched_atoms,
</a>                      vector&lt;int&gt;* atom_indices) {
   atom_indices-&gt;clear();
   for (size_t i = 0; i &lt; matched_atoms.size(); i++) {
<a href="#h36-1-10" id="h36-1-10" class="d">-    size_t j = 0;
</a><a href="#h36-1-11" id="h36-1-11" class="d">-    for (; j &lt; atoms.size(); j++) {
</a><a href="#h36-1-12" id="h36-1-12" class="i">+    for (size_t j = 0; j &lt; atoms.size(); j++) {
</a>       if (matched_atoms[i] == atoms[j]) {
<a href="#h36-1-14" id="h36-1-14" class="d">-        atom_indices-&gt;push_back(j);
</a><a href="#h36-1-15" id="h36-1-15" class="i">+        atom_indices-&gt;push_back(static_cast&lt;int&gt;(j));
</a>         break;
       }
<a href="#h36-1-18" id="h36-1-18" class="d">-      EXPECT_LT(j, atoms.size());
</a>     }
   }
 }
<b>diff --git a/<a id="h37" href="../file/src/vendor/re2/re2/testing/parse_test.cc">src/vendor/re2/re2/testing/parse_test.cc</a> b/<a href="../file/src/vendor/re2/re2/testing/parse_test.cc">src/vendor/re2/re2/testing/parse_test.cc</a></b>
<a href="#h37-0" id="h37-0" class="h">@@ -118,8 +118,15 @@ static Test tests[] = {
</a>   { &quot;(?:a)&quot;, &quot;lit{a}&quot; },
   { &quot;(?:ab)(?:cd)&quot;, &quot;str{abcd}&quot; },
   { &quot;(?:a|b)|(?:c|d)&quot;, &quot;cc{0x61-0x64}&quot; },
<a href="#h37-0-3" id="h37-0-3" class="i">+  { &quot;a|c&quot;, &quot;cc{0x61 0x63}&quot; },
</a><a href="#h37-0-4" id="h37-0-4" class="i">+  { &quot;a|[cd]&quot;, &quot;cc{0x61 0x63-0x64}&quot; },
</a>   { &quot;a|.&quot;, &quot;dot{}&quot; },
<a href="#h37-0-6" id="h37-0-6" class="d">-  { &quot;.|a&quot;, &quot;dot{}&quot; },
</a><a href="#h37-0-7" id="h37-0-7" class="i">+  { &quot;[ab]|c&quot;, &quot;cc{0x61-0x63}&quot; },
</a><a href="#h37-0-8" id="h37-0-8" class="i">+  { &quot;[ab]|[cd]&quot;, &quot;cc{0x61-0x64}&quot; },
</a><a href="#h37-0-9" id="h37-0-9" class="i">+  { &quot;[ab]|.&quot;, &quot;dot{}&quot; },
</a><a href="#h37-0-10" id="h37-0-10" class="i">+  { &quot;.|c&quot;, &quot;dot{}&quot; },
</a><a href="#h37-0-11" id="h37-0-11" class="i">+  { &quot;.|[cd]&quot;, &quot;dot{}&quot; },
</a><a href="#h37-0-12" id="h37-0-12" class="i">+  { &quot;.|.&quot;, &quot;dot{}&quot; },
</a> 
   // Test Perl quoted literals
   { &quot;\\Q+|*?{[\\E&quot;, &quot;str{+|*?{[}&quot; },
<a href="#h37-1" id="h37-1" class="h">@@ -212,12 +219,12 @@ void TestParse(const Test* tests, int ntests, Regexp::ParseFlags flags,
</a>                          &lt;&lt; status.Text();
     string s = re[i]-&gt;Dump();
     EXPECT_EQ(string(tests[i].parse), s) &lt;&lt; &quot;Regexp: &quot; &lt;&lt; tests[i].regexp
<a href="#h37-1-3" id="h37-1-3" class="d">-      &lt;&lt; &quot;\nparse: &quot; &lt;&lt; tests[i].parse &lt;&lt; &quot; s: &quot; &lt;&lt; s &lt;&lt; &quot; flag=&quot; &lt;&lt; f;
</a><a href="#h37-1-4" id="h37-1-4" class="i">+      &lt;&lt; &quot;\nparse: &quot; &lt;&lt; string(tests[i].parse) &lt;&lt; &quot; s: &quot; &lt;&lt; s &lt;&lt; &quot; flag=&quot; &lt;&lt; f;
</a>   }
 
   for (int i = 0; i &lt; ntests; i++) {
     for (int j = 0; j &lt; ntests; j++) {
<a href="#h37-1-9" id="h37-1-9" class="d">-      EXPECT_EQ(string(tests[i].parse) == tests[j].parse,
</a><a href="#h37-1-10" id="h37-1-10" class="i">+      EXPECT_EQ(string(tests[i].parse) == string(tests[j].parse),
</a>                 RegexpEqualTestingOnly(re[i], re[j]))
         &lt;&lt; &quot;Regexp: &quot; &lt;&lt; tests[i].regexp &lt;&lt; &quot; &quot; &lt;&lt; tests[j].regexp;
     }
<a href="#h37-2" id="h37-2" class="h">@@ -299,6 +306,14 @@ Test prefix_tests[] = {
</a>     &quot;cat{rep{2,2 lit{x}}alt{emp{}cc{0x30-0x39}}}&quot; },
   { &quot;x{2}y|x{2}[0-9]y&quot;,
     &quot;cat{rep{2,2 lit{x}}alt{lit{y}cat{cc{0x30-0x39}lit{y}}}}&quot; },
<a href="#h37-2-3" id="h37-2-3" class="i">+  { &quot;n|r|rs&quot;,
</a><a href="#h37-2-4" id="h37-2-4" class="i">+    &quot;alt{lit{n}cat{lit{r}alt{emp{}lit{s}}}}&quot; },
</a><a href="#h37-2-5" id="h37-2-5" class="i">+  { &quot;n|rs|r&quot;,
</a><a href="#h37-2-6" id="h37-2-6" class="i">+    &quot;alt{lit{n}cat{lit{r}alt{lit{s}emp{}}}}&quot; },
</a><a href="#h37-2-7" id="h37-2-7" class="i">+  { &quot;r|rs|n&quot;,
</a><a href="#h37-2-8" id="h37-2-8" class="i">+    &quot;alt{cat{lit{r}alt{emp{}lit{s}}}lit{n}}&quot; },
</a><a href="#h37-2-9" id="h37-2-9" class="i">+  { &quot;rs|r|n&quot;,
</a><a href="#h37-2-10" id="h37-2-10" class="i">+    &quot;alt{cat{lit{r}alt{lit{s}emp{}}}lit{n}}&quot; },
</a> };
 
 // Test that prefix factoring works.
<a href="#h37-3" id="h37-3" class="h">@@ -306,6 +321,22 @@ TEST(TestParse, Prefix) {
</a>   TestParse(prefix_tests, arraysize(prefix_tests), Regexp::PerlX, &quot;prefix&quot;);
 }
 
<a href="#h37-3-3" id="h37-3-3" class="i">+Test nested_tests[] = {
</a><a href="#h37-3-4" id="h37-3-4" class="i">+  { &quot;((((((((((x{2}){2}){2}){2}){2}){2}){2}){2}){2}))&quot;,
</a><a href="#h37-3-5" id="h37-3-5" class="i">+    &quot;cap{cap{rep{2,2 cap{rep{2,2 cap{rep{2,2 cap{rep{2,2 cap{rep{2,2 cap{rep{2,2 cap{rep{2,2 cap{rep{2,2 cap{rep{2,2 lit{x}}}}}}}}}}}}}}}}}}}}&quot; },
</a><a href="#h37-3-6" id="h37-3-6" class="i">+  { &quot;((((((((((x{1}){2}){2}){2}){2}){2}){2}){2}){2}){2})&quot;,
</a><a href="#h37-3-7" id="h37-3-7" class="i">+    &quot;cap{rep{2,2 cap{rep{2,2 cap{rep{2,2 cap{rep{2,2 cap{rep{2,2 cap{rep{2,2 cap{rep{2,2 cap{rep{2,2 cap{rep{2,2 cap{rep{1,1 lit{x}}}}}}}}}}}}}}}}}}}}}&quot; },
</a><a href="#h37-3-8" id="h37-3-8" class="i">+  { &quot;((((((((((x{0}){2}){2}){2}){2}){2}){2}){2}){2}){2})&quot;,
</a><a href="#h37-3-9" id="h37-3-9" class="i">+    &quot;cap{rep{2,2 cap{rep{2,2 cap{rep{2,2 cap{rep{2,2 cap{rep{2,2 cap{rep{2,2 cap{rep{2,2 cap{rep{2,2 cap{rep{2,2 cap{rep{0,0 lit{x}}}}}}}}}}}}}}}}}}}}}&quot; },
</a><a href="#h37-3-10" id="h37-3-10" class="i">+  { &quot;((((((x{2}){2}){2}){5}){5}){5})&quot;,
</a><a href="#h37-3-11" id="h37-3-11" class="i">+    &quot;cap{rep{5,5 cap{rep{5,5 cap{rep{5,5 cap{rep{2,2 cap{rep{2,2 cap{rep{2,2 lit{x}}}}}}}}}}}}}&quot; },
</a><a href="#h37-3-12" id="h37-3-12" class="i">+};
</a><a href="#h37-3-13" id="h37-3-13" class="i">+
</a><a href="#h37-3-14" id="h37-3-14" class="i">+// Test that nested repetition works.
</a><a href="#h37-3-15" id="h37-3-15" class="i">+TEST(TestParse, Nested) {
</a><a href="#h37-3-16" id="h37-3-16" class="i">+  TestParse(nested_tests, arraysize(nested_tests), Regexp::PerlX, &quot;nested&quot;);
</a><a href="#h37-3-17" id="h37-3-17" class="i">+}
</a><a href="#h37-3-18" id="h37-3-18" class="i">+
</a> // Invalid regular expressions
 const char* badtests[] = {
   &quot;(&quot;,
<a href="#h37-4" id="h37-4" class="h">@@ -329,6 +360,8 @@ const char* badtests[] = {
</a>   &quot;(?i)[a-Z]&quot;,
   &quot;a{100000}&quot;,
   &quot;a{100000,}&quot;,
<a href="#h37-4-3" id="h37-4-3" class="i">+  &quot;((((((((((x{2}){2}){2}){2}){2}){2}){2}){2}){2}){2})&quot;,
</a><a href="#h37-4-4" id="h37-4-4" class="i">+  &quot;(((x{7}){11}){13})&quot;,
</a> };
 
 // Valid in Perl, bad in POSIX
<b>diff --git a/<a id="h38" href="../file/src/vendor/re2/re2/testing/re2_arg_test.cc">src/vendor/re2/re2/testing/re2_arg_test.cc</a> b/<a href="../file/src/vendor/re2/re2/testing/re2_arg_test.cc">src/vendor/re2/re2/testing/re2_arg_test.cc</a></b>
<a href="#h38-0" id="h38-0" class="h">@@ -86,22 +86,22 @@ const SuccessTable kSuccessTable[] = {
</a> 
 const int kNumStrings = arraysize(kSuccessTable);
 
<a href="#h38-0-3" id="h38-0-3" class="d">-// It&#39;s ugly to use a macro, but we apparently can&#39;t use the ASSERT_TRUE_M
</a><a href="#h38-0-4" id="h38-0-4" class="i">+// It&#39;s ugly to use a macro, but we apparently can&#39;t use the EXPECT_EQ
</a> // macro outside of a TEST block and this seems to be the only way to
 // avoid code duplication.  I can also pull off a couple nice tricks
 // using concatenation for the type I&#39;m checking against.
 #define PARSE_FOR_TYPE(type, column) {                                   \
   type r;                                                                \
<a href="#h38-0-10" id="h38-0-10" class="d">-  for ( int i = 0; i &lt; kNumStrings; ++i ) {                              \
</a><a href="#h38-0-11" id="h38-0-11" class="i">+  for (int i = 0; i &lt; kNumStrings; ++i) {                                \
</a>     RE2::Arg arg(&amp;r);                                                    \
     const char* const p = kSuccessTable[i].value_string;                 \
<a href="#h38-0-14" id="h38-0-14" class="d">-    bool retval = arg.Parse(p, strlen(p));                               \
</a><a href="#h38-0-15" id="h38-0-15" class="i">+    bool retval = arg.Parse(p, static_cast&lt;int&gt;(strlen(p)));             \
</a>     bool success = kSuccessTable[i].success[column];                     \
<a href="#h38-0-17" id="h38-0-17" class="d">-    ASSERT_TRUE_M(retval == success,                                     \
</a><a href="#h38-0-18" id="h38-0-18" class="d">-      StringPrintf(&quot;Parsing &#39;%s&#39; for type &quot; #type &quot; should return %d&quot;,   \
</a><a href="#h38-0-19" id="h38-0-19" class="d">-                   p, success).c_str());                                 \
</a><a href="#h38-0-20" id="h38-0-20" class="d">-    if ( success ) {                                                     \
</a><a href="#h38-0-21" id="h38-0-21" class="d">-      ASSERT_EQUALS(r, (type)kSuccessTable[i].value);                          \
</a><a href="#h38-0-22" id="h38-0-22" class="i">+    EXPECT_EQ(retval, success)                                           \
</a><a href="#h38-0-23" id="h38-0-23" class="i">+        &lt;&lt; &quot;Parsing &#39;&quot; &lt;&lt; p &lt;&lt; &quot;&#39; for type &quot; #type &quot; should return &quot;     \
</a><a href="#h38-0-24" id="h38-0-24" class="i">+        &lt;&lt; success;                                                      \
</a><a href="#h38-0-25" id="h38-0-25" class="i">+    if (success) {                                                       \
</a><a href="#h38-0-26" id="h38-0-26" class="i">+      EXPECT_EQ(r, (type)kSuccessTable[i].value);                        \
</a>     }                                                                    \
   }                                                                      \
 }
<b>diff --git a/<a id="h39" href="../file/src/vendor/re2/re2/testing/re2_test.cc">src/vendor/re2/re2/testing/re2_test.cc</a> b/<a href="../file/src/vendor/re2/re2/testing/re2_test.cc">src/vendor/re2/re2/testing/re2_test.cc</a></b>
<a href="#h39-0" id="h39-0" class="h">@@ -5,10 +5,13 @@
</a> 
 // TODO: Test extractions for PartialMatch/Consume
 
<a href="#h39-0-3" id="h39-0-3" class="d">-#include &lt;sys/types.h&gt;
</a><a href="#h39-0-4" id="h39-0-4" class="i">+#include &lt;errno.h&gt;
</a><a href="#h39-0-5" id="h39-0-5" class="i">+#ifndef _MSC_VER
</a><a href="#h39-0-6" id="h39-0-6" class="i">+#include &lt;unistd.h&gt;  /* for sysconf */
</a> #include &lt;sys/mman.h&gt;
<a href="#h39-0-8" id="h39-0-8" class="i">+#endif
</a> #include &lt;sys/stat.h&gt;
<a href="#h39-0-10" id="h39-0-10" class="d">-#include &lt;errno.h&gt;
</a><a href="#h39-0-11" id="h39-0-11" class="i">+#include &lt;sys/types.h&gt;
</a> #include &lt;vector&gt;
 #include &quot;util/test.h&quot;
 #include &quot;re2/re2.h&quot;
<a href="#h39-1" id="h39-1" class="h">@@ -173,7 +176,7 @@ TEST(RE2, Replace) {
</a>     { &quot;&quot;, NULL, NULL, NULL, NULL, 0 }
   };
 
<a href="#h39-1-3" id="h39-1-3" class="d">-  for (const ReplaceTest *t = tests; t-&gt;original != NULL; ++t) {
</a><a href="#h39-1-4" id="h39-1-4" class="i">+  for (const ReplaceTest* t = tests; t-&gt;original != NULL; t++) {
</a>     VLOG(1) &lt;&lt; StringPrintf(&quot;\&quot;%s\&quot; =~ s/%s/%s/g&quot;, t-&gt;original, t-&gt;regexp, t-&gt;rewrite);
     string one(t-&gt;original);
     CHECK(RE2::Replace(&amp;one, t-&gt;regexp, t-&gt;rewrite));
<a href="#h39-2" id="h39-2" class="h">@@ -366,12 +369,12 @@ TEST(RE2, Match) {
</a>   CHECK_EQ(port, 9000);
 }
 
<a href="#h39-2-3" id="h39-2-3" class="d">-static void TestRecursion(int size, const char *pattern) {
</a><a href="#h39-2-4" id="h39-2-4" class="i">+static void TestRecursion(int size, const char* pattern) {
</a>   // Fill up a string repeating the pattern given
   string domain;
   domain.resize(size);
<a href="#h39-2-8" id="h39-2-8" class="d">-  int patlen = strlen(pattern);
</a><a href="#h39-2-9" id="h39-2-9" class="d">-  for (int i = 0; i &lt; size; ++i) {
</a><a href="#h39-2-10" id="h39-2-10" class="i">+  size_t patlen = strlen(pattern);
</a><a href="#h39-2-11" id="h39-2-11" class="i">+  for (int i = 0; i &lt; size; i++) {
</a>     domain[i] = pattern[i % patlen];
   }
   // Just make sure it doesn&#39;t crash due to too much recursion.
<a href="#h39-3" id="h39-3" class="h">@@ -385,8 +388,8 @@ static void TestQuoteMeta(string unquoted,
</a>                           const RE2::Options&amp; options = RE2::DefaultOptions) {
   string quoted = RE2::QuoteMeta(unquoted);
   RE2 re(quoted, options);
<a href="#h39-3-3" id="h39-3-3" class="d">-  EXPECT_TRUE_M(RE2::FullMatch(unquoted, re),
</a><a href="#h39-3-4" id="h39-3-4" class="d">-                &quot;Unquoted=&#39;&quot; + unquoted + &quot;&#39;, quoted=&#39;&quot; + quoted + &quot;&#39;.&quot;);
</a><a href="#h39-3-5" id="h39-3-5" class="i">+  EXPECT_TRUE(RE2::FullMatch(unquoted, re))
</a><a href="#h39-3-6" id="h39-3-6" class="i">+      &lt;&lt; &quot;Unquoted=&#39;&quot; &lt;&lt; unquoted &lt;&lt; &quot;&#39;, quoted=&#39;&quot; &lt;&lt; quoted &lt;&lt; &quot;&#39;.&quot;;
</a> }
 
 // A meta-quoted string, interpreted as a pattern, should always match
<a href="#h39-4" id="h39-4" class="h">@@ -395,8 +398,8 @@ static void NegativeTestQuoteMeta(string unquoted, string should_not_match,
</a>                                   const RE2::Options&amp; options = RE2::DefaultOptions) {
   string quoted = RE2::QuoteMeta(unquoted);
   RE2 re(quoted, options);
<a href="#h39-4-3" id="h39-4-3" class="d">-  EXPECT_FALSE_M(RE2::FullMatch(should_not_match, re),
</a><a href="#h39-4-4" id="h39-4-4" class="d">-                 &quot;Unquoted=&#39;&quot; + unquoted + &quot;&#39;, quoted=&#39;&quot; + quoted + &quot;&#39;.&quot;);
</a><a href="#h39-4-5" id="h39-4-5" class="i">+  EXPECT_FALSE(RE2::FullMatch(should_not_match, re))
</a><a href="#h39-4-6" id="h39-4-6" class="i">+      &lt;&lt; &quot;Unquoted=&#39;&quot; &lt;&lt; unquoted &lt;&lt; &quot;&#39;, quoted=&#39;&quot; &lt;&lt; quoted &lt;&lt; &quot;&#39;.&quot;;
</a> }
 
 // Tests that quoted meta characters match their original strings,
<a href="#h39-5" id="h39-5" class="h">@@ -462,13 +465,38 @@ TEST(QuoteMeta, HasNull) {
</a> TEST(ProgramSize, BigProgram) {
   RE2 re_simple(&quot;simple regexp&quot;);
   RE2 re_medium(&quot;medium.*regexp&quot;);
<a href="#h39-5-3" id="h39-5-3" class="d">-  RE2 re_complex(&quot;hard.{1,128}regexp&quot;);
</a><a href="#h39-5-4" id="h39-5-4" class="i">+  RE2 re_complex(&quot;complex.{1,128}regexp&quot;);
</a> 
   CHECK_GT(re_simple.ProgramSize(), 0);
   CHECK_GT(re_medium.ProgramSize(), re_simple.ProgramSize());
   CHECK_GT(re_complex.ProgramSize(), re_medium.ProgramSize());
 }
 
<a href="#h39-5-11" id="h39-5-11" class="i">+TEST(ProgramFanout, BigProgram) {
</a><a href="#h39-5-12" id="h39-5-12" class="i">+  RE2 re1(&quot;(?:(?:(?:(?:(?:.)?){1})*)+)&quot;);
</a><a href="#h39-5-13" id="h39-5-13" class="i">+  RE2 re10(&quot;(?:(?:(?:(?:(?:.)?){10})*)+)&quot;);
</a><a href="#h39-5-14" id="h39-5-14" class="i">+  RE2 re100(&quot;(?:(?:(?:(?:(?:.)?){100})*)+)&quot;);
</a><a href="#h39-5-15" id="h39-5-15" class="i">+  RE2 re1000(&quot;(?:(?:(?:(?:(?:.)?){1000})*)+)&quot;);
</a><a href="#h39-5-16" id="h39-5-16" class="i">+
</a><a href="#h39-5-17" id="h39-5-17" class="i">+  map&lt;int, int&gt; histogram;
</a><a href="#h39-5-18" id="h39-5-18" class="i">+
</a><a href="#h39-5-19" id="h39-5-19" class="i">+  // 3 is the largest non-empty bucket and has 1 element.
</a><a href="#h39-5-20" id="h39-5-20" class="i">+  CHECK_EQ(3, re1.ProgramFanout(&amp;histogram));
</a><a href="#h39-5-21" id="h39-5-21" class="i">+  CHECK_EQ(1, histogram[3]);
</a><a href="#h39-5-22" id="h39-5-22" class="i">+
</a><a href="#h39-5-23" id="h39-5-23" class="i">+  // 7 is the largest non-empty bucket and has 10 elements.
</a><a href="#h39-5-24" id="h39-5-24" class="i">+  CHECK_EQ(7, re10.ProgramFanout(&amp;histogram));
</a><a href="#h39-5-25" id="h39-5-25" class="i">+  CHECK_EQ(10, histogram[7]);
</a><a href="#h39-5-26" id="h39-5-26" class="i">+
</a><a href="#h39-5-27" id="h39-5-27" class="i">+  // 10 is the largest non-empty bucket and has 100 elements.
</a><a href="#h39-5-28" id="h39-5-28" class="i">+  CHECK_EQ(10, re100.ProgramFanout(&amp;histogram));
</a><a href="#h39-5-29" id="h39-5-29" class="i">+  CHECK_EQ(100, histogram[10]);
</a><a href="#h39-5-30" id="h39-5-30" class="i">+
</a><a href="#h39-5-31" id="h39-5-31" class="i">+  // 13 is the largest non-empty bucket and has 1000 elements.
</a><a href="#h39-5-32" id="h39-5-32" class="i">+  CHECK_EQ(13, re1000.ProgramFanout(&amp;histogram));
</a><a href="#h39-5-33" id="h39-5-33" class="i">+  CHECK_EQ(1000, histogram[13]);
</a><a href="#h39-5-34" id="h39-5-34" class="i">+}
</a><a href="#h39-5-35" id="h39-5-35" class="i">+
</a> // Issue 956519: handling empty character sets was
 // causing NULL dereference.  This tests a few empty character sets.
 // (The way to get an empty character set is to negate a full one.)
<a href="#h39-6" id="h39-6" class="h">@@ -702,7 +730,10 @@ TEST(RE2, FullMatchTypedNullArg) {
</a> 
 // Check that numeric parsing code does not read past the end of
 // the number being parsed.
<a href="#h39-6-3" id="h39-6-3" class="i">+// This implementation requires mmap(2) et al. and thus cannot
</a><a href="#h39-6-4" id="h39-6-4" class="i">+// be used unless they are available.
</a> TEST(RE2, NULTerminated) {
<a href="#h39-6-6" id="h39-6-6" class="i">+#if defined(_POSIX_MAPPED_FILES) &amp;&amp; _POSIX_MAPPED_FILES &gt; 0
</a>   char *v;
   int x;
   long pagesize = sysconf(_SC_PAGE_SIZE);
<a href="#h39-7" id="h39-7" class="h">@@ -720,6 +751,7 @@ TEST(RE2, NULTerminated) {
</a>   x = 0;
   CHECK(RE2::FullMatch(StringPiece(v + pagesize - 1, 1), &quot;(.*)&quot;, &amp;x));
   CHECK_EQ(x, 1);
<a href="#h39-7-3" id="h39-7-3" class="i">+#endif
</a> }
 
 TEST(RE2, FullMatchTypeTests) {
<a href="#h39-8" id="h39-8" class="h">@@ -1432,10 +1464,14 @@ TEST(RE2, Bug10131674) {
</a> 
 TEST(RE2, Bug18391750) {
   // Stray write past end of match_ in nfa.cc, caught by fuzzing + address sanitizer.
<a href="#h39-8-3" id="h39-8-3" class="d">-  char t[] = {0x28, 0x28, 0xfc, 0xfc, 0x8,  0x8,  0x26, 0x26, 0x28, 0xc2, 0x9b,
</a><a href="#h39-8-4" id="h39-8-4" class="d">-              0xc5, 0xc5, 0xd4, 0x8f, 0x8f, 0x69, 0x69, 0xe7, 0x29, 0x7b, 0x37,
</a><a href="#h39-8-5" id="h39-8-5" class="d">-              0x31, 0x31, 0x7d, 0xae, 0x7c, 0x7c, 0xf3, 0x29, 0xae, 0xae, 0x2e,
</a><a href="#h39-8-6" id="h39-8-6" class="d">-              0x2a, 0x29, 0x0};
</a><a href="#h39-8-7" id="h39-8-7" class="i">+  const char t[] = {
</a><a href="#h39-8-8" id="h39-8-8" class="i">+      (char)0x28, (char)0x28, (char)0xfc, (char)0xfc, (char)0x08, (char)0x08,
</a><a href="#h39-8-9" id="h39-8-9" class="i">+      (char)0x26, (char)0x26, (char)0x28, (char)0xc2, (char)0x9b, (char)0xc5,
</a><a href="#h39-8-10" id="h39-8-10" class="i">+      (char)0xc5, (char)0xd4, (char)0x8f, (char)0x8f, (char)0x69, (char)0x69,
</a><a href="#h39-8-11" id="h39-8-11" class="i">+      (char)0xe7, (char)0x29, (char)0x7b, (char)0x37, (char)0x31, (char)0x31,
</a><a href="#h39-8-12" id="h39-8-12" class="i">+      (char)0x7d, (char)0xae, (char)0x7c, (char)0x7c, (char)0xf3, (char)0x29,
</a><a href="#h39-8-13" id="h39-8-13" class="i">+      (char)0xae, (char)0xae, (char)0x2e, (char)0x2a, (char)0x29, (char)0x00,
</a><a href="#h39-8-14" id="h39-8-14" class="i">+  };
</a>   RE2::Options opt;
   opt.set_encoding(RE2::Options::EncodingLatin1);
   opt.set_longest_match(true);
<a href="#h39-9" id="h39-9" class="h">@@ -1450,8 +1486,11 @@ TEST(RE2, Bug18458852) {
</a>   // Bug in parser accepting invalid (too large) rune,
   // causing compiler to fail in DCHECK in UTF-8
   // character class code.
<a href="#h39-9-3" id="h39-9-3" class="d">-  char b[] = {0x28, 0x5,  0x5,  0x41, 0x41, 0x28, 0x24, 0x5b, 0x5e,
</a><a href="#h39-9-4" id="h39-9-4" class="d">-              0xf5, 0x87, 0x87, 0x90, 0x29, 0x5d, 0x29, 0x29, 0x0};
</a><a href="#h39-9-5" id="h39-9-5" class="i">+  const char b[] = {
</a><a href="#h39-9-6" id="h39-9-6" class="i">+      (char)0x28, (char)0x05, (char)0x05, (char)0x41, (char)0x41, (char)0x28,
</a><a href="#h39-9-7" id="h39-9-7" class="i">+      (char)0x24, (char)0x5b, (char)0x5e, (char)0xf5, (char)0x87, (char)0x87,
</a><a href="#h39-9-8" id="h39-9-8" class="i">+      (char)0x90, (char)0x29, (char)0x5d, (char)0x29, (char)0x29, (char)0x00,
</a><a href="#h39-9-9" id="h39-9-9" class="i">+  };
</a>   RE2 re(b);
   CHECK(!re.ok());
 }
<a href="#h39-10" id="h39-10" class="h">@@ -1460,8 +1499,12 @@ TEST(RE2, Bug18523943) {
</a>   // Bug in bitstate: case kFailInst was merged into the default with LOG(DFATAL).
 
   RE2::Options opt;
<a href="#h39-10-3" id="h39-10-3" class="d">-  char a[] = {0x29, 0x29, 0x24, 0x0};
</a><a href="#h39-10-4" id="h39-10-4" class="d">-  char b[] = {0x28, 0xa, 0x2a, 0x2a, 0x29, 0x0};
</a><a href="#h39-10-5" id="h39-10-5" class="i">+  const char a[] = {
</a><a href="#h39-10-6" id="h39-10-6" class="i">+      (char)0x29, (char)0x29, (char)0x24, (char)0x00,
</a><a href="#h39-10-7" id="h39-10-7" class="i">+  };
</a><a href="#h39-10-8" id="h39-10-8" class="i">+  const char b[] = {
</a><a href="#h39-10-9" id="h39-10-9" class="i">+      (char)0x28, (char)0x0a, (char)0x2a, (char)0x2a, (char)0x29, (char)0x00,
</a><a href="#h39-10-10" id="h39-10-10" class="i">+  };
</a>   opt.set_log_errors(false);
   opt.set_encoding(RE2::Options::EncodingLatin1);
   opt.set_posix_syntax(true);
<a href="#h39-11" id="h39-11" class="h">@@ -1475,4 +1518,15 @@ TEST(RE2, Bug18523943) {
</a>   CHECK(!RE2::PartialMatch((const char*)a, re, &amp;s1));
 }
 
<a href="#h39-11-3" id="h39-11-3" class="i">+TEST(RE2, Bug21371806) {
</a><a href="#h39-11-4" id="h39-11-4" class="i">+  // Bug in parser accepting Unicode groups in Latin-1 mode,
</a><a href="#h39-11-5" id="h39-11-5" class="i">+  // causing compiler to fail in DCHECK in prog.cc.
</a><a href="#h39-11-6" id="h39-11-6" class="i">+
</a><a href="#h39-11-7" id="h39-11-7" class="i">+  RE2::Options opt;
</a><a href="#h39-11-8" id="h39-11-8" class="i">+  opt.set_encoding(RE2::Options::EncodingLatin1);
</a><a href="#h39-11-9" id="h39-11-9" class="i">+
</a><a href="#h39-11-10" id="h39-11-10" class="i">+  RE2 re(&quot;g\\p{Zl}]&quot;, opt);
</a><a href="#h39-11-11" id="h39-11-11" class="i">+  CHECK(re.ok());
</a><a href="#h39-11-12" id="h39-11-12" class="i">+}
</a><a href="#h39-11-13" id="h39-11-13" class="i">+
</a> }  // namespace re2
<b>diff --git a/<a id="h40" href="../file/src/vendor/re2/re2/testing/regexp_benchmark.cc">src/vendor/re2/re2/testing/regexp_benchmark.cc</a> b/<a href="../file/src/vendor/re2/re2/testing/regexp_benchmark.cc">src/vendor/re2/re2/testing/regexp_benchmark.cc</a></b>
<a href="#h40-0" id="h40-0" class="h">@@ -135,13 +135,15 @@ ParseImpl SearchParse1CachedPCRE, SearchParse1CachedRE2;
</a> // Generate random text that won&#39;t contain the search string,
 // to test worst-case search behavior.
 void MakeText(string* text, int nbytes) {
<a href="#h40-0-3" id="h40-0-3" class="i">+  srand(1);
</a>   text-&gt;resize(nbytes);
<a href="#h40-0-5" id="h40-0-5" class="d">-  srand(0);
</a>   for (int i = 0; i &lt; nbytes; i++) {
<a href="#h40-0-7" id="h40-0-7" class="d">-    if (!rand()%30)
</a><a href="#h40-0-8" id="h40-0-8" class="d">-      (*text)[i] = &#39;\n&#39;;
</a><a href="#h40-0-9" id="h40-0-9" class="d">-    else
</a><a href="#h40-0-10" id="h40-0-10" class="d">-      (*text)[i] = rand()%(0x7E + 1 - 0x20)+0x20;
</a><a href="#h40-0-11" id="h40-0-11" class="i">+    // Generate a one-byte rune that isn&#39;t a control character (e.g. &#39;\n&#39;).
</a><a href="#h40-0-12" id="h40-0-12" class="i">+    // Clipping to 0x20 introduces some bias, but we don&#39;t need uniformity.
</a><a href="#h40-0-13" id="h40-0-13" class="i">+    int byte = rand() &amp; 0x7F;
</a><a href="#h40-0-14" id="h40-0-14" class="i">+    if (byte &lt; 0x20)
</a><a href="#h40-0-15" id="h40-0-15" class="i">+      byte = 0x20;
</a><a href="#h40-0-16" id="h40-0-16" class="i">+    (*text)[i] = byte;
</a>   }
 }
 
<a href="#h40-1" id="h40-1" class="h">@@ -263,6 +265,7 @@ BENCHMARK_RANGE(Search_BigFixed_CachedPCRE,    8, 32&lt;&lt;10)-&gt;ThreadRange(1, NumCPU
</a> BENCHMARK_RANGE(Search_BigFixed_CachedRE2,     8, 1&lt;&lt;20)-&gt;ThreadRange(1, NumCPUs());
 
 // Benchmark: FindAndConsume
<a href="#h40-1-3" id="h40-1-3" class="i">+
</a> void FindAndConsume(int iters, int nbytes) {
   StopBenchmarkTiming();
   string s;
<a href="#h40-2" id="h40-2" class="h">@@ -284,9 +287,11 @@ BENCHMARK_RANGE(FindAndConsume, 8, 16&lt;&lt;20)-&gt;ThreadRange(1, NumCPUs());
</a> // Benchmark: successful anchored search.
 
 void SearchSuccess(int iters, int nbytes, const char* regexp, SearchImpl* search) {
<a href="#h40-2-3" id="h40-2-3" class="i">+  StopBenchmarkTiming();
</a>   string s;
   MakeText(&amp;s, nbytes);
   BenchmarkMemoryUsage();
<a href="#h40-2-7" id="h40-2-7" class="i">+  StartBenchmarkTiming();
</a>   search(iters, regexp, s, Prog::kAnchored, true);
   SetBenchmarkBytesProcessed(static_cast&lt;int64&gt;(iters)*nbytes);
 }
<a href="#h40-3" id="h40-3" class="h">@@ -344,11 +349,9 @@ BENCHMARK_RANGE(Search_Success1_Cached_RE2,     8, 16&lt;&lt;20)-&gt;ThreadRange(1, NumCP
</a> // Benchmark: use regexp to find phone number.
 
 void SearchDigits(int iters, SearchImpl* search) {
<a href="#h40-3-3" id="h40-3-3" class="d">-  const char *text = &quot;650-253-0001&quot;;
</a><a href="#h40-3-4" id="h40-3-4" class="d">-  int len = strlen(text);
</a><a href="#h40-3-5" id="h40-3-5" class="i">+  StringPiece s(&quot;650-253-0001&quot;);
</a>   BenchmarkMemoryUsage();
<a href="#h40-3-7" id="h40-3-7" class="d">-  search(iters, &quot;([0-9]+)-([0-9]+)-([0-9]+)&quot;,
</a><a href="#h40-3-8" id="h40-3-8" class="d">-         StringPiece(text, len), Prog::kAnchored, true);
</a><a href="#h40-3-9" id="h40-3-9" class="i">+  search(iters, &quot;([0-9]+)-([0-9]+)-([0-9]+)&quot;, s, Prog::kAnchored, true);
</a>   SetBenchmarkItemsProcessed(iters);
 }
 
<a href="#h40-4" id="h40-4" class="h">@@ -686,7 +689,6 @@ BENCHMARK(BM_Regexp_SimplifyCompile)-&gt;ThreadRange(1, NumCPUs());
</a> BENCHMARK(BM_Regexp_NullWalk)-&gt;ThreadRange(1, NumCPUs());
 BENCHMARK(BM_RE2_Compile)-&gt;ThreadRange(1, NumCPUs());
 
<a href="#h40-4-3" id="h40-4-3" class="d">-
</a> // Makes text of size nbytes, then calls run to search
 // the text for regexp iters times.
 void SearchPhone(int iters, int nbytes, ParseImpl* search) {
<b>diff --git a/<a id="h41" href="../file/src/vendor/re2/re2/testing/regexp_generator.cc">src/vendor/re2/re2/testing/regexp_generator.cc</a> b/<a href="../file/src/vendor/re2/re2/testing/regexp_generator.cc">src/vendor/re2/re2/testing/regexp_generator.cc</a></b>
<a href="#h41-0" id="h41-0" class="h">@@ -134,7 +134,7 @@ void RegexpGenerator::GeneratePostfix(vector&lt;string&gt;* post, int nstk,
</a> 
 // Generates a random postfix command sequence.
 // Stops and returns true once a single sequence has been generated.
<a href="#h41-0-3" id="h41-0-3" class="d">-bool RegexpGenerator::GenerateRandomPostfix(vector&lt;string&gt; *post, int nstk,
</a><a href="#h41-0-4" id="h41-0-4" class="i">+bool RegexpGenerator::GenerateRandomPostfix(vector&lt;string&gt;* post, int nstk,
</a>                                             int ops, int atoms) {
   for (;;) {
     // Stop if we get to a single element, but only sometimes.
<a href="#h41-1" id="h41-1" class="h">@@ -151,7 +151,7 @@ bool RegexpGenerator::GenerateRandomPostfix(vector&lt;string&gt; *post, int nstk,
</a> 
     // Add operators if there are enough arguments.
     if (ops &lt; maxops_ &amp;&amp; acm_-&gt;Uniform(2) == 0) {
<a href="#h41-1-3" id="h41-1-3" class="d">-      const string&amp; fmt = ops_[acm_-&gt;Uniform(ops_.size())];
</a><a href="#h41-1-4" id="h41-1-4" class="i">+      const string&amp; fmt = ops_[acm_-&gt;Uniform(static_cast&lt;int32&gt;(ops_.size()))];
</a>       int nargs = CountArgs(fmt);
       if (nargs &lt;= nstk) {
         post-&gt;push_back(fmt);
<a href="#h41-2" id="h41-2" class="h">@@ -165,7 +165,7 @@ bool RegexpGenerator::GenerateRandomPostfix(vector&lt;string&gt; *post, int nstk,
</a> 
     // Add atoms if there is room.
     if (atoms &lt; maxatoms_ &amp;&amp; acm_-&gt;Uniform(2) == 0) {
<a href="#h41-2-3" id="h41-2-3" class="d">-      post-&gt;push_back(atoms_[acm_-&gt;Uniform(atoms_.size())]);
</a><a href="#h41-2-4" id="h41-2-4" class="i">+      post-&gt;push_back(atoms_[acm_-&gt;Uniform(static_cast&lt;int32&gt;(atoms_.size()))]);
</a>       bool ret = GenerateRandomPostfix(post, nstk + 1, ops, atoms + 1);
       post-&gt;pop_back();
       if (ret)
<b>diff --git a/<a id="h42" href="../file/src/vendor/re2/re2/testing/regexp_test.cc">src/vendor/re2/re2/testing/regexp_test.cc</a> b/<a href="../file/src/vendor/re2/re2/testing/regexp_test.cc">src/vendor/re2/re2/testing/regexp_test.cc</a></b>
<a href="#h42-0" id="h42-0" class="h">@@ -32,7 +32,8 @@ TEST(Regexp, BigConcat) {
</a>   for (size_t i = 0; i &lt; v.size(); i++)
     x-&gt;Incref();
   CHECK_EQ(x-&gt;Ref(), 1 + static_cast&lt;int&gt;(v.size())) &lt;&lt; x-&gt;Ref();
<a href="#h42-0-3" id="h42-0-3" class="d">-  Regexp* re = Regexp::Concat(&amp;v[0], v.size(), Regexp::NoParseFlags);
</a><a href="#h42-0-4" id="h42-0-4" class="i">+  Regexp* re = Regexp::Concat(v.data(), static_cast&lt;int&gt;(v.size()),
</a><a href="#h42-0-5" id="h42-0-5" class="i">+                              Regexp::NoParseFlags);
</a>   CHECK_EQ(re-&gt;ToString(), string(v.size(), &#39;x&#39;));
   re-&gt;Decref();
   CHECK_EQ(x-&gt;Ref(), 1) &lt;&lt; x-&gt;Ref();
<b>diff --git a/<a id="h43" href="../file/src/vendor/re2/re2/testing/set_test.cc">src/vendor/re2/re2/testing/set_test.cc</a> b/<a href="../file/src/vendor/re2/re2/testing/set_test.cc">src/vendor/re2/re2/testing/set_test.cc</a></b>
<a href="#h43-0" id="h43-0" class="h">@@ -71,10 +71,10 @@ TEST(Set, UnanchoredFactored) {
</a> 
 TEST(Set, UnanchoredDollar) {
   RE2::Set s(RE2::DefaultOptions, RE2::UNANCHORED);
<a href="#h43-0-3" id="h43-0-3" class="d">-  
</a><a href="#h43-0-4" id="h43-0-4" class="i">+
</a>   CHECK_EQ(s.Add(&quot;foo$&quot;, NULL), 0);
   CHECK_EQ(s.Compile(), true);
<a href="#h43-0-7" id="h43-0-7" class="d">-  
</a><a href="#h43-0-8" id="h43-0-8" class="i">+
</a>   vector&lt;int&gt; v;
   CHECK_EQ(s.Match(&quot;foo&quot;, &amp;v), true);
   CHECK_EQ(v.size(), 1);
<a href="#h43-1" id="h43-1" class="h">@@ -107,8 +107,34 @@ TEST(Set, Anchored) {
</a>   CHECK_EQ(s.Match(&quot;bar&quot;, &amp;v), true);
   CHECK_EQ(v.size(), 1);
   CHECK_EQ(v[0], 1);
<a href="#h43-1-3" id="h43-1-3" class="i">+}
</a><a href="#h43-1-4" id="h43-1-4" class="i">+
</a><a href="#h43-1-5" id="h43-1-5" class="i">+TEST(Set, EmptyUnanchored) {
</a><a href="#h43-1-6" id="h43-1-6" class="i">+  RE2::Set s(RE2::DefaultOptions, RE2::UNANCHORED);
</a><a href="#h43-1-7" id="h43-1-7" class="i">+
</a><a href="#h43-1-8" id="h43-1-8" class="i">+  CHECK_EQ(s.Compile(), true);
</a><a href="#h43-1-9" id="h43-1-9" class="i">+
</a><a href="#h43-1-10" id="h43-1-10" class="i">+  vector&lt;int&gt; v;
</a><a href="#h43-1-11" id="h43-1-11" class="i">+  CHECK_EQ(s.Match(&quot;&quot;, &amp;v), false);
</a><a href="#h43-1-12" id="h43-1-12" class="i">+  CHECK_EQ(v.size(), 0);
</a><a href="#h43-1-13" id="h43-1-13" class="i">+
</a><a href="#h43-1-14" id="h43-1-14" class="i">+  v.clear();
</a><a href="#h43-1-15" id="h43-1-15" class="i">+  CHECK_EQ(s.Match(&quot;foobar&quot;, &amp;v), false);
</a><a href="#h43-1-16" id="h43-1-16" class="i">+  CHECK_EQ(v.size(), 0);
</a><a href="#h43-1-17" id="h43-1-17" class="i">+}
</a><a href="#h43-1-18" id="h43-1-18" class="i">+
</a><a href="#h43-1-19" id="h43-1-19" class="i">+TEST(Set, EmptyAnchored) {
</a><a href="#h43-1-20" id="h43-1-20" class="i">+  RE2::Set s(RE2::DefaultOptions, RE2::ANCHOR_BOTH);
</a> 
<a href="#h43-1-22" id="h43-1-22" class="i">+  CHECK_EQ(s.Compile(), true);
</a><a href="#h43-1-23" id="h43-1-23" class="i">+
</a><a href="#h43-1-24" id="h43-1-24" class="i">+  vector&lt;int&gt; v;
</a><a href="#h43-1-25" id="h43-1-25" class="i">+  CHECK_EQ(s.Match(&quot;&quot;, &amp;v), false);
</a><a href="#h43-1-26" id="h43-1-26" class="i">+  CHECK_EQ(v.size(), 0);
</a><a href="#h43-1-27" id="h43-1-27" class="i">+
</a><a href="#h43-1-28" id="h43-1-28" class="i">+  v.clear();
</a><a href="#h43-1-29" id="h43-1-29" class="i">+  CHECK_EQ(s.Match(&quot;foobar&quot;, &amp;v), false);
</a><a href="#h43-1-30" id="h43-1-30" class="i">+  CHECK_EQ(v.size(), 0);
</a> }
 
 }  // namespace re2
<a href="#h43-1-34" id="h43-1-34" class="d">-
</a><b>diff --git a/<a id="h44" href="../file/src/vendor/re2/re2/testing/simplify_test.cc">src/vendor/re2/re2/testing/simplify_test.cc</a> b/<a href="../file/src/vendor/re2/re2/testing/simplify_test.cc">src/vendor/re2/re2/testing/simplify_test.cc</a></b>
<a href="#h44-0" id="h44-0" class="h">@@ -136,6 +136,99 @@ static Test tests[] = {
</a>   { &quot;(){1}&quot;, &quot;()&quot; },
   { &quot;(){1,}&quot;, &quot;()+&quot; },
   { &quot;(){0,2}&quot;, &quot;(?:()()?)?&quot; },
<a href="#h44-0-3" id="h44-0-3" class="i">+
</a><a href="#h44-0-4" id="h44-0-4" class="i">+  // Test that coalescing occurs and that the resulting repeats are simplified.
</a><a href="#h44-0-5" id="h44-0-5" class="i">+  // Two-op combinations of *, +, ?, {n}, {n,} and {n,m} with a literal:
</a><a href="#h44-0-6" id="h44-0-6" class="i">+  { &quot;a*a*&quot;, &quot;a*&quot; },
</a><a href="#h44-0-7" id="h44-0-7" class="i">+  { &quot;a*a+&quot;, &quot;a+&quot; },
</a><a href="#h44-0-8" id="h44-0-8" class="i">+  { &quot;a*a?&quot;, &quot;a*&quot; },
</a><a href="#h44-0-9" id="h44-0-9" class="i">+  { &quot;a*a{2}&quot;, &quot;aa+&quot; },
</a><a href="#h44-0-10" id="h44-0-10" class="i">+  { &quot;a*a{2,}&quot;, &quot;aa+&quot; },
</a><a href="#h44-0-11" id="h44-0-11" class="i">+  { &quot;a*a{2,3}&quot;, &quot;aa+&quot; },
</a><a href="#h44-0-12" id="h44-0-12" class="i">+  { &quot;a+a*&quot;, &quot;a+&quot; },
</a><a href="#h44-0-13" id="h44-0-13" class="i">+  { &quot;a+a+&quot;, &quot;aa+&quot; },
</a><a href="#h44-0-14" id="h44-0-14" class="i">+  { &quot;a+a?&quot;, &quot;a+&quot; },
</a><a href="#h44-0-15" id="h44-0-15" class="i">+  { &quot;a+a{2}&quot;, &quot;aaa+&quot; },
</a><a href="#h44-0-16" id="h44-0-16" class="i">+  { &quot;a+a{2,}&quot;, &quot;aaa+&quot; },
</a><a href="#h44-0-17" id="h44-0-17" class="i">+  { &quot;a+a{2,3}&quot;, &quot;aaa+&quot; },
</a><a href="#h44-0-18" id="h44-0-18" class="i">+  { &quot;a?a*&quot;, &quot;a*&quot; },
</a><a href="#h44-0-19" id="h44-0-19" class="i">+  { &quot;a?a+&quot;, &quot;a+&quot; },
</a><a href="#h44-0-20" id="h44-0-20" class="i">+  { &quot;a?a?&quot;, &quot;(?:aa?)?&quot; },
</a><a href="#h44-0-21" id="h44-0-21" class="i">+  { &quot;a?a{2}&quot;, &quot;aaa?&quot; },
</a><a href="#h44-0-22" id="h44-0-22" class="i">+  { &quot;a?a{2,}&quot;, &quot;aa+&quot; },
</a><a href="#h44-0-23" id="h44-0-23" class="i">+  { &quot;a?a{2,3}&quot;, &quot;aa(?:aa?)?&quot; },
</a><a href="#h44-0-24" id="h44-0-24" class="i">+  { &quot;a{2}a*&quot;, &quot;aa+&quot; },
</a><a href="#h44-0-25" id="h44-0-25" class="i">+  { &quot;a{2}a+&quot;, &quot;aaa+&quot; },
</a><a href="#h44-0-26" id="h44-0-26" class="i">+  { &quot;a{2}a?&quot;, &quot;aaa?&quot; },
</a><a href="#h44-0-27" id="h44-0-27" class="i">+  { &quot;a{2}a{2}&quot;, &quot;aaaa&quot; },
</a><a href="#h44-0-28" id="h44-0-28" class="i">+  { &quot;a{2}a{2,}&quot;, &quot;aaaa+&quot; },
</a><a href="#h44-0-29" id="h44-0-29" class="i">+  { &quot;a{2}a{2,3}&quot;, &quot;aaaaa?&quot; },
</a><a href="#h44-0-30" id="h44-0-30" class="i">+  { &quot;a{2,}a*&quot;, &quot;aa+&quot; },
</a><a href="#h44-0-31" id="h44-0-31" class="i">+  { &quot;a{2,}a+&quot;, &quot;aaa+&quot; },
</a><a href="#h44-0-32" id="h44-0-32" class="i">+  { &quot;a{2,}a?&quot;, &quot;aa+&quot; },
</a><a href="#h44-0-33" id="h44-0-33" class="i">+  { &quot;a{2,}a{2}&quot;, &quot;aaaa+&quot; },
</a><a href="#h44-0-34" id="h44-0-34" class="i">+  { &quot;a{2,}a{2,}&quot;, &quot;aaaa+&quot; },
</a><a href="#h44-0-35" id="h44-0-35" class="i">+  { &quot;a{2,}a{2,3}&quot;, &quot;aaaa+&quot; },
</a><a href="#h44-0-36" id="h44-0-36" class="i">+  { &quot;a{2,3}a*&quot;, &quot;aa+&quot; },
</a><a href="#h44-0-37" id="h44-0-37" class="i">+  { &quot;a{2,3}a+&quot;, &quot;aaa+&quot; },
</a><a href="#h44-0-38" id="h44-0-38" class="i">+  { &quot;a{2,3}a?&quot;, &quot;aa(?:aa?)?&quot; },
</a><a href="#h44-0-39" id="h44-0-39" class="i">+  { &quot;a{2,3}a{2}&quot;, &quot;aaaaa?&quot; },
</a><a href="#h44-0-40" id="h44-0-40" class="i">+  { &quot;a{2,3}a{2,}&quot;, &quot;aaaa+&quot; },
</a><a href="#h44-0-41" id="h44-0-41" class="i">+  { &quot;a{2,3}a{2,3}&quot;, &quot;aaaa(?:aa?)?&quot; },
</a><a href="#h44-0-42" id="h44-0-42" class="i">+  // With a char class, any char and any byte:
</a><a href="#h44-0-43" id="h44-0-43" class="i">+  { &quot;\\d*\\d*&quot;, &quot;[0-9]*&quot; },
</a><a href="#h44-0-44" id="h44-0-44" class="i">+  { &quot;.*.*&quot;, &quot;.*&quot; },
</a><a href="#h44-0-45" id="h44-0-45" class="i">+  { &quot;\\C*\\C*&quot;, &quot;\\C*&quot; },
</a><a href="#h44-0-46" id="h44-0-46" class="i">+  // FoldCase works, but must be consistent:
</a><a href="#h44-0-47" id="h44-0-47" class="i">+  { &quot;(?i)A*a*&quot;, &quot;[Aa]*&quot; },
</a><a href="#h44-0-48" id="h44-0-48" class="i">+  { &quot;(?i)a+A+&quot;, &quot;[Aa][Aa]+&quot; },
</a><a href="#h44-0-49" id="h44-0-49" class="i">+  { &quot;(?i)A*(?-i)a*&quot;, &quot;[Aa]*a*&quot; },
</a><a href="#h44-0-50" id="h44-0-50" class="i">+  { &quot;(?i)a+(?-i)A+&quot;, &quot;[Aa]+A+&quot; },
</a><a href="#h44-0-51" id="h44-0-51" class="i">+  // NonGreedy works, but must be consistent:
</a><a href="#h44-0-52" id="h44-0-52" class="i">+  { &quot;a*?a*?&quot;, &quot;a*?&quot; },
</a><a href="#h44-0-53" id="h44-0-53" class="i">+  { &quot;a+?a+?&quot;, &quot;aa+?&quot; },
</a><a href="#h44-0-54" id="h44-0-54" class="i">+  { &quot;a*?a*&quot;, &quot;a*?a*&quot; },
</a><a href="#h44-0-55" id="h44-0-55" class="i">+  { &quot;a+a+?&quot;, &quot;a+a+?&quot; },
</a><a href="#h44-0-56" id="h44-0-56" class="i">+  // The second element is the literal, char class, any char or any byte:
</a><a href="#h44-0-57" id="h44-0-57" class="i">+  { &quot;a*a&quot;, &quot;a+&quot; },
</a><a href="#h44-0-58" id="h44-0-58" class="i">+  { &quot;\\d*\\d&quot;, &quot;[0-9]+&quot; },
</a><a href="#h44-0-59" id="h44-0-59" class="i">+  { &quot;.*.&quot;, &quot;.+&quot; },
</a><a href="#h44-0-60" id="h44-0-60" class="i">+  { &quot;\\C*\\C&quot;, &quot;\\C+&quot; },
</a><a href="#h44-0-61" id="h44-0-61" class="i">+  // FoldCase works, but must be consistent:
</a><a href="#h44-0-62" id="h44-0-62" class="i">+  { &quot;(?i)A*a&quot;, &quot;[Aa]+&quot; },
</a><a href="#h44-0-63" id="h44-0-63" class="i">+  { &quot;(?i)a+A&quot;, &quot;[Aa][Aa]+&quot; },
</a><a href="#h44-0-64" id="h44-0-64" class="i">+  { &quot;(?i)A*(?-i)a&quot;, &quot;[Aa]*a&quot; },
</a><a href="#h44-0-65" id="h44-0-65" class="i">+  { &quot;(?i)a+(?-i)A&quot;, &quot;[Aa]+A&quot; },
</a><a href="#h44-0-66" id="h44-0-66" class="i">+  // The second element is a literal string that begins with the literal:
</a><a href="#h44-0-67" id="h44-0-67" class="i">+  { &quot;a*aa&quot;, &quot;aa+&quot; },
</a><a href="#h44-0-68" id="h44-0-68" class="i">+  { &quot;a*aab&quot;, &quot;aa+b&quot; },
</a><a href="#h44-0-69" id="h44-0-69" class="i">+  // FoldCase works, but must be consistent:
</a><a href="#h44-0-70" id="h44-0-70" class="i">+  { &quot;(?i)a*aa&quot;, &quot;[Aa][Aa]+&quot; },
</a><a href="#h44-0-71" id="h44-0-71" class="i">+  { &quot;(?i)a*aab&quot;, &quot;[Aa][Aa]+[Bb]&quot; },
</a><a href="#h44-0-72" id="h44-0-72" class="i">+  { &quot;(?i)a*(?-i)aa&quot;, &quot;[Aa]*aa&quot; },
</a><a href="#h44-0-73" id="h44-0-73" class="i">+  { &quot;(?i)a*(?-i)aab&quot;, &quot;[Aa]*aab&quot; },
</a><a href="#h44-0-74" id="h44-0-74" class="i">+  // Negative tests with mismatching ops:
</a><a href="#h44-0-75" id="h44-0-75" class="i">+  { &quot;a*b*&quot;, &quot;a*b*&quot; },
</a><a href="#h44-0-76" id="h44-0-76" class="i">+  { &quot;\\d*\\D*&quot;, &quot;[0-9]*[^0-9]*&quot; },
</a><a href="#h44-0-77" id="h44-0-77" class="i">+  { &quot;a+b&quot;, &quot;a+b&quot; },
</a><a href="#h44-0-78" id="h44-0-78" class="i">+  { &quot;\\d+\\D&quot;, &quot;[0-9]+[^0-9]&quot; },
</a><a href="#h44-0-79" id="h44-0-79" class="i">+  { &quot;a?bb&quot;, &quot;a?bb&quot; },
</a><a href="#h44-0-80" id="h44-0-80" class="i">+  // Negative tests with capturing groups:
</a><a href="#h44-0-81" id="h44-0-81" class="i">+  { &quot;(a*)a*&quot;, &quot;(a*)a*&quot; },
</a><a href="#h44-0-82" id="h44-0-82" class="i">+  { &quot;a+(a)&quot;, &quot;a+(a)&quot; },
</a><a href="#h44-0-83" id="h44-0-83" class="i">+  { &quot;(a?)(aa)&quot;, &quot;(a?)(aa)&quot; },
</a><a href="#h44-0-84" id="h44-0-84" class="i">+  // Just for fun:
</a><a href="#h44-0-85" id="h44-0-85" class="i">+  { &quot;aa*aa+aa?aa{2}aaa{2,}aaa{2,3}a&quot;, &quot;aaaaaaaaaaaaaaaa+&quot; },
</a><a href="#h44-0-86" id="h44-0-86" class="i">+
</a><a href="#h44-0-87" id="h44-0-87" class="i">+  // During coalescing, the child of the repeat changes, so we build a new
</a><a href="#h44-0-88" id="h44-0-88" class="i">+  // repeat. The new repeat must have the min and max of the old repeat.
</a><a href="#h44-0-89" id="h44-0-89" class="i">+  // Failure to copy them results in min=0 and max=0 -&gt; empty match.
</a><a href="#h44-0-90" id="h44-0-90" class="i">+  { &quot;(?:a*aab){2}&quot;, &quot;aa+baa+b&quot; },
</a><a href="#h44-0-91" id="h44-0-91" class="i">+
</a><a href="#h44-0-92" id="h44-0-92" class="i">+  // During coalescing, the child of the capture changes, so we build a new
</a><a href="#h44-0-93" id="h44-0-93" class="i">+  // capture. The new capture must have the cap of the old capture.
</a><a href="#h44-0-94" id="h44-0-94" class="i">+  // Failure to copy it results in cap=0 -&gt; ToString() logs a fatal error.
</a><a href="#h44-0-95" id="h44-0-95" class="i">+  { &quot;(a*aab)&quot;, &quot;(aa+b)&quot; },
</a> };
 
 TEST(TestSimplify, SimpleRegexps) {
<b>diff --git a/<a id="h45" href="../file/src/vendor/re2/re2/testing/string_generator.cc">src/vendor/re2/re2/testing/string_generator.cc</a> b/<a href="../file/src/vendor/re2/re2/testing/string_generator.cc">src/vendor/re2/re2/testing/string_generator.cc</a></b>
<a href="#h45-0" id="h45-0" class="h">@@ -43,14 +43,14 @@ void StringGenerator::Reset() {
</a> // Returns false if all the numbers have been used.
 bool StringGenerator::IncrementDigits() {
   // First try to increment the current number.
<a href="#h45-0-3" id="h45-0-3" class="d">-  for (int i = digits_.size() - 1; i &gt;= 0; i--) {
</a><a href="#h45-0-4" id="h45-0-4" class="i">+  for (int i = static_cast&lt;int&gt;(digits_.size()) - 1; i &gt;= 0; i--) {
</a>     if (++digits_[i] &lt; static_cast&lt;int&gt;(alphabet_.size()))
       return true;
     digits_[i] = 0;
   }
 
   // If that failed, make a longer number.
<a href="#h45-0-11" id="h45-0-11" class="d">-  if (digits_.size() &lt; static_cast&lt;size_t&gt;(maxlen_)) {
</a><a href="#h45-0-12" id="h45-0-12" class="i">+  if (static_cast&lt;int&gt;(digits_.size()) &lt; maxlen_) {
</a>     digits_.push_back(0);
     return true;
   }
<a href="#h45-1" id="h45-1" class="h">@@ -68,7 +68,7 @@ bool StringGenerator::RandomDigits() {
</a>   int len = acm_-&gt;Uniform(maxlen_+1);
   digits_.resize(len);
   for (int i = 0; i &lt; len; i++)
<a href="#h45-1-3" id="h45-1-3" class="d">-    digits_[i] = acm_-&gt;Uniform(alphabet_.size());
</a><a href="#h45-1-4" id="h45-1-4" class="i">+    digits_[i] = acm_-&gt;Uniform(static_cast&lt;int32&gt;(alphabet_.size()));
</a>   return true;
 }
 
<a href="#h45-2" id="h45-2" class="h">@@ -110,4 +110,3 @@ void StringGenerator::GenerateNULL() {
</a> }
 
 }  // namespace re2
<a href="#h45-2-3" id="h45-2-3" class="d">-
</a><b>diff --git a/<a id="h46" href="../file/src/vendor/re2/re2/testing/tester.cc">src/vendor/re2/re2/testing/tester.cc</a> b/<a href="../file/src/vendor/re2/re2/testing/tester.cc">src/vendor/re2/re2/testing/tester.cc</a></b>
<a href="#h46-0" id="h46-0" class="h">@@ -392,10 +392,13 @@ void TestInstance::RunSearch(Engine type,
</a>       if (kind_ == Prog::kFullMatch)
         re_anchor = RE2::ANCHOR_BOTH;
 
<a href="#h46-0-3" id="h46-0-3" class="d">-      result-&gt;matched = re2_-&gt;Match(context,
</a><a href="#h46-0-4" id="h46-0-4" class="d">-                                    text.begin() - context.begin(),
</a><a href="#h46-0-5" id="h46-0-5" class="d">-                                    text.end() - context.begin(),
</a><a href="#h46-0-6" id="h46-0-6" class="d">-                                    re_anchor, result-&gt;submatch, nsubmatch);
</a><a href="#h46-0-7" id="h46-0-7" class="i">+      result-&gt;matched = re2_-&gt;Match(
</a><a href="#h46-0-8" id="h46-0-8" class="i">+          context,
</a><a href="#h46-0-9" id="h46-0-9" class="i">+          static_cast&lt;int&gt;(text.begin() - context.begin()),
</a><a href="#h46-0-10" id="h46-0-10" class="i">+          static_cast&lt;int&gt;(text.end() - context.begin()),
</a><a href="#h46-0-11" id="h46-0-11" class="i">+          re_anchor,
</a><a href="#h46-0-12" id="h46-0-12" class="i">+          result-&gt;submatch,
</a><a href="#h46-0-13" id="h46-0-13" class="i">+          nsubmatch);
</a>       result-&gt;have_submatch = nsubmatch &gt; 0;
       break;
     }
<a href="#h46-1" id="h46-1" class="h">@@ -515,7 +518,7 @@ bool TestInstance::RunCase(const StringPiece&amp; text, const StringPiece&amp; context,
</a>     }
 
     // We disagree with PCRE on the meaning of some Unicode matches.
<a href="#h46-1-3" id="h46-1-3" class="d">-    // In particular, we treat all non-ASCII UTF-8 as word characters.
</a><a href="#h46-1-4" id="h46-1-4" class="i">+    // In particular, we treat non-ASCII UTF-8 as non-word characters.
</a>     // We also treat &quot;empty&quot; character sets like [^\w\W] as being
     // impossible to match, while PCRE apparently excludes some code
     // points (e.g., 0x0080) from both \w and \W.
<b>diff --git a/<a id="h47" href="../file/src/vendor/re2/re2/testing/unicode_test.py">src/vendor/re2/re2/testing/unicode_test.py</a> b/<a href="../file/src/vendor/re2/re2/testing/unicode_test.py">src/vendor/re2/re2/testing/unicode_test.py</a></b>
<a href="#h47-0" id="h47-0" class="h">@@ -1,207 +0,0 @@
</a><a href="#h47-0-0" id="h47-0-0" class="d">-#!/usr/bin/python2.4
</a><a href="#h47-0-1" id="h47-0-1" class="d">-#
</a><a href="#h47-0-2" id="h47-0-2" class="d">-# Copyright 2008 The RE2 Authors.  All Rights Reserved.
</a><a href="#h47-0-3" id="h47-0-3" class="d">-# Use of this source code is governed by a BSD-style
</a><a href="#h47-0-4" id="h47-0-4" class="d">-# license that can be found in the LICENSE file.
</a><a href="#h47-0-5" id="h47-0-5" class="d">-
</a><a href="#h47-0-6" id="h47-0-6" class="d">-&quot;&quot;&quot;Unittest for the util/regexp/re2/unicode.py module.&quot;&quot;&quot;
</a><a href="#h47-0-7" id="h47-0-7" class="d">-
</a><a href="#h47-0-8" id="h47-0-8" class="d">-import os
</a><a href="#h47-0-9" id="h47-0-9" class="d">-import StringIO
</a><a href="#h47-0-10" id="h47-0-10" class="d">-from google3.pyglib import flags
</a><a href="#h47-0-11" id="h47-0-11" class="d">-from google3.testing.pybase import googletest
</a><a href="#h47-0-12" id="h47-0-12" class="d">-from google3.util.regexp.re2 import unicode
</a><a href="#h47-0-13" id="h47-0-13" class="d">-
</a><a href="#h47-0-14" id="h47-0-14" class="d">-_UNICODE_DIR = os.path.join(flags.FLAGS.test_srcdir, &quot;google3&quot;, &quot;third_party&quot;,
</a><a href="#h47-0-15" id="h47-0-15" class="d">-                            &quot;unicode&quot;, &quot;ucd-5.1.0&quot;)
</a><a href="#h47-0-16" id="h47-0-16" class="d">-
</a><a href="#h47-0-17" id="h47-0-17" class="d">-
</a><a href="#h47-0-18" id="h47-0-18" class="d">-class ConvertTest(googletest.TestCase):
</a><a href="#h47-0-19" id="h47-0-19" class="d">-  &quot;&quot;&quot;Test the conversion functions.&quot;&quot;&quot;
</a><a href="#h47-0-20" id="h47-0-20" class="d">-
</a><a href="#h47-0-21" id="h47-0-21" class="d">-  def testUInt(self):
</a><a href="#h47-0-22" id="h47-0-22" class="d">-    self.assertEquals(0x0000, unicode._UInt(&quot;0000&quot;))
</a><a href="#h47-0-23" id="h47-0-23" class="d">-    self.assertEquals(0x263A, unicode._UInt(&quot;263A&quot;))
</a><a href="#h47-0-24" id="h47-0-24" class="d">-    self.assertEquals(0x10FFFF, unicode._UInt(&quot;10FFFF&quot;))
</a><a href="#h47-0-25" id="h47-0-25" class="d">-    self.assertRaises(unicode.InputError, unicode._UInt, &quot;263&quot;)
</a><a href="#h47-0-26" id="h47-0-26" class="d">-    self.assertRaises(unicode.InputError, unicode._UInt, &quot;263AAAA&quot;)
</a><a href="#h47-0-27" id="h47-0-27" class="d">-    self.assertRaises(unicode.InputError, unicode._UInt, &quot;110000&quot;)
</a><a href="#h47-0-28" id="h47-0-28" class="d">-
</a><a href="#h47-0-29" id="h47-0-29" class="d">-  def testURange(self):
</a><a href="#h47-0-30" id="h47-0-30" class="d">-    self.assertEquals([1, 2, 3], unicode._URange(&quot;0001..0003&quot;))
</a><a href="#h47-0-31" id="h47-0-31" class="d">-    self.assertEquals([1], unicode._URange(&quot;0001&quot;))
</a><a href="#h47-0-32" id="h47-0-32" class="d">-    self.assertRaises(unicode.InputError, unicode._URange, &quot;0001..0003..0005&quot;)
</a><a href="#h47-0-33" id="h47-0-33" class="d">-    self.assertRaises(unicode.InputError, unicode._URange, &quot;0003..0001&quot;)
</a><a href="#h47-0-34" id="h47-0-34" class="d">-    self.assertRaises(unicode.InputError, unicode._URange, &quot;0001..0001&quot;)
</a><a href="#h47-0-35" id="h47-0-35" class="d">-
</a><a href="#h47-0-36" id="h47-0-36" class="d">-  def testUStr(self):
</a><a href="#h47-0-37" id="h47-0-37" class="d">-    self.assertEquals(&quot;0x263A&quot;, unicode._UStr(0x263a))
</a><a href="#h47-0-38" id="h47-0-38" class="d">-    self.assertEquals(&quot;0x10FFFF&quot;, unicode._UStr(0x10FFFF))
</a><a href="#h47-0-39" id="h47-0-39" class="d">-    self.assertRaises(unicode.InputError, unicode._UStr, 0x110000)
</a><a href="#h47-0-40" id="h47-0-40" class="d">-    self.assertRaises(unicode.InputError, unicode._UStr, -1)
</a><a href="#h47-0-41" id="h47-0-41" class="d">-
</a><a href="#h47-0-42" id="h47-0-42" class="d">-
</a><a href="#h47-0-43" id="h47-0-43" class="d">-_UNICODE_TABLE = &quot;&quot;&quot;# Commented line, should be ignored.
</a><a href="#h47-0-44" id="h47-0-44" class="d">-# The next line is blank and should be ignored.
</a><a href="#h47-0-45" id="h47-0-45" class="d">-
</a><a href="#h47-0-46" id="h47-0-46" class="d">-0041;Capital A;Line 1
</a><a href="#h47-0-47" id="h47-0-47" class="d">-0061..007A;Lowercase;Line 2
</a><a href="#h47-0-48" id="h47-0-48" class="d">-1F00;&lt;Greek, First&gt;;Ignored
</a><a href="#h47-0-49" id="h47-0-49" class="d">-1FFE;&lt;Greek, Last&gt;;Line 3
</a><a href="#h47-0-50" id="h47-0-50" class="d">-10FFFF;Runemax;Line 4
</a><a href="#h47-0-51" id="h47-0-51" class="d">-0000;Zero;Line 5
</a><a href="#h47-0-52" id="h47-0-52" class="d">-&quot;&quot;&quot;
</a><a href="#h47-0-53" id="h47-0-53" class="d">-
</a><a href="#h47-0-54" id="h47-0-54" class="d">-_BAD_TABLE1 = &quot;&quot;&quot;
</a><a href="#h47-0-55" id="h47-0-55" class="d">-111111;Not a code point;
</a><a href="#h47-0-56" id="h47-0-56" class="d">-&quot;&quot;&quot;
</a><a href="#h47-0-57" id="h47-0-57" class="d">-
</a><a href="#h47-0-58" id="h47-0-58" class="d">-_BAD_TABLE2 = &quot;&quot;&quot;
</a><a href="#h47-0-59" id="h47-0-59" class="d">-0000;&lt;Zero, First&gt;;Missing &lt;Zero, Last&gt;
</a><a href="#h47-0-60" id="h47-0-60" class="d">-&quot;&quot;&quot;
</a><a href="#h47-0-61" id="h47-0-61" class="d">-
</a><a href="#h47-0-62" id="h47-0-62" class="d">-_BAD_TABLE3 = &quot;&quot;&quot;
</a><a href="#h47-0-63" id="h47-0-63" class="d">-0010..0001;Bad range;
</a><a href="#h47-0-64" id="h47-0-64" class="d">-&quot;&quot;&quot;
</a><a href="#h47-0-65" id="h47-0-65" class="d">-
</a><a href="#h47-0-66" id="h47-0-66" class="d">-
</a><a href="#h47-0-67" id="h47-0-67" class="d">-class AbortError(Exception):
</a><a href="#h47-0-68" id="h47-0-68" class="d">-  &quot;&quot;&quot;Function should not have been called.&quot;&quot;&quot;
</a><a href="#h47-0-69" id="h47-0-69" class="d">-
</a><a href="#h47-0-70" id="h47-0-70" class="d">-
</a><a href="#h47-0-71" id="h47-0-71" class="d">-def Abort():
</a><a href="#h47-0-72" id="h47-0-72" class="d">-  raise AbortError(&quot;Abort&quot;)
</a><a href="#h47-0-73" id="h47-0-73" class="d">-
</a><a href="#h47-0-74" id="h47-0-74" class="d">-
</a><a href="#h47-0-75" id="h47-0-75" class="d">-def StringTable(s, n, f):
</a><a href="#h47-0-76" id="h47-0-76" class="d">-  unicode.ReadUnicodeTable(StringIO.StringIO(s), n, f)
</a><a href="#h47-0-77" id="h47-0-77" class="d">-
</a><a href="#h47-0-78" id="h47-0-78" class="d">-
</a><a href="#h47-0-79" id="h47-0-79" class="d">-class ReadUnicodeTableTest(googletest.TestCase):
</a><a href="#h47-0-80" id="h47-0-80" class="d">-  &quot;&quot;&quot;Test the ReadUnicodeTable function.&quot;&quot;&quot;
</a><a href="#h47-0-81" id="h47-0-81" class="d">-
</a><a href="#h47-0-82" id="h47-0-82" class="d">-  def testSimpleTable(self):
</a><a href="#h47-0-83" id="h47-0-83" class="d">-
</a><a href="#h47-0-84" id="h47-0-84" class="d">-    ncall = [0]  # can&#39;t assign to ordinary int in DoLine
</a><a href="#h47-0-85" id="h47-0-85" class="d">-
</a><a href="#h47-0-86" id="h47-0-86" class="d">-    def DoLine(codes, fields):
</a><a href="#h47-0-87" id="h47-0-87" class="d">-      self.assertEquals(3, len(fields))
</a><a href="#h47-0-88" id="h47-0-88" class="d">-      ncall[0] += 1
</a><a href="#h47-0-89" id="h47-0-89" class="d">-      self.assertEquals(&quot;Line %d&quot; % (ncall[0],), fields[2])
</a><a href="#h47-0-90" id="h47-0-90" class="d">-      if ncall[0] == 1:
</a><a href="#h47-0-91" id="h47-0-91" class="d">-        self.assertEquals([0x0041], codes)
</a><a href="#h47-0-92" id="h47-0-92" class="d">-        self.assertEquals(&quot;0041&quot;, fields[0])
</a><a href="#h47-0-93" id="h47-0-93" class="d">-        self.assertEquals(&quot;Capital A&quot;, fields[1])
</a><a href="#h47-0-94" id="h47-0-94" class="d">-      elif ncall[0] == 2:
</a><a href="#h47-0-95" id="h47-0-95" class="d">-        self.assertEquals(range(0x0061, 0x007A + 1), codes)
</a><a href="#h47-0-96" id="h47-0-96" class="d">-        self.assertEquals(&quot;0061..007A&quot;, fields[0])
</a><a href="#h47-0-97" id="h47-0-97" class="d">-        self.assertEquals(&quot;Lowercase&quot;, fields[1])
</a><a href="#h47-0-98" id="h47-0-98" class="d">-      elif ncall[0] == 3:
</a><a href="#h47-0-99" id="h47-0-99" class="d">-        self.assertEquals(range(0x1F00, 0x1FFE + 1), codes)
</a><a href="#h47-0-100" id="h47-0-100" class="d">-        self.assertEquals(&quot;1F00..1FFE&quot;, fields[0])
</a><a href="#h47-0-101" id="h47-0-101" class="d">-        self.assertEquals(&quot;Greek&quot;, fields[1])
</a><a href="#h47-0-102" id="h47-0-102" class="d">-      elif ncall[0] == 4:
</a><a href="#h47-0-103" id="h47-0-103" class="d">-        self.assertEquals([0x10FFFF], codes)
</a><a href="#h47-0-104" id="h47-0-104" class="d">-        self.assertEquals(&quot;10FFFF&quot;, fields[0])
</a><a href="#h47-0-105" id="h47-0-105" class="d">-        self.assertEquals(&quot;Runemax&quot;, fields[1])
</a><a href="#h47-0-106" id="h47-0-106" class="d">-      elif ncall[0] == 5:
</a><a href="#h47-0-107" id="h47-0-107" class="d">-        self.assertEquals([0x0000], codes)
</a><a href="#h47-0-108" id="h47-0-108" class="d">-        self.assertEquals(&quot;0000&quot;, fields[0])
</a><a href="#h47-0-109" id="h47-0-109" class="d">-        self.assertEquals(&quot;Zero&quot;, fields[1])
</a><a href="#h47-0-110" id="h47-0-110" class="d">-
</a><a href="#h47-0-111" id="h47-0-111" class="d">-    StringTable(_UNICODE_TABLE, 3, DoLine)
</a><a href="#h47-0-112" id="h47-0-112" class="d">-    self.assertEquals(5, ncall[0])
</a><a href="#h47-0-113" id="h47-0-113" class="d">-
</a><a href="#h47-0-114" id="h47-0-114" class="d">-  def testErrorTables(self):
</a><a href="#h47-0-115" id="h47-0-115" class="d">-    self.assertRaises(unicode.InputError, StringTable, _UNICODE_TABLE, 4, Abort)
</a><a href="#h47-0-116" id="h47-0-116" class="d">-    self.assertRaises(unicode.InputError, StringTable, _UNICODE_TABLE, 2, Abort)
</a><a href="#h47-0-117" id="h47-0-117" class="d">-    self.assertRaises(unicode.InputError, StringTable, _BAD_TABLE1, 3, Abort)
</a><a href="#h47-0-118" id="h47-0-118" class="d">-    self.assertRaises(unicode.InputError, StringTable, _BAD_TABLE2, 3, Abort)
</a><a href="#h47-0-119" id="h47-0-119" class="d">-    self.assertRaises(unicode.InputError, StringTable, _BAD_TABLE3, 3, Abort)
</a><a href="#h47-0-120" id="h47-0-120" class="d">-
</a><a href="#h47-0-121" id="h47-0-121" class="d">-
</a><a href="#h47-0-122" id="h47-0-122" class="d">-class ParseContinueTest(googletest.TestCase):
</a><a href="#h47-0-123" id="h47-0-123" class="d">-  &quot;&quot;&quot;Test the ParseContinue function.&quot;&quot;&quot;
</a><a href="#h47-0-124" id="h47-0-124" class="d">-
</a><a href="#h47-0-125" id="h47-0-125" class="d">-  def testParseContinue(self):
</a><a href="#h47-0-126" id="h47-0-126" class="d">-    self.assertEquals((&quot;Private Use&quot;, &quot;First&quot;),
</a><a href="#h47-0-127" id="h47-0-127" class="d">-                      unicode._ParseContinue(&quot;&lt;Private Use, First&gt;&quot;))
</a><a href="#h47-0-128" id="h47-0-128" class="d">-    self.assertEquals((&quot;Private Use&quot;, &quot;Last&quot;),
</a><a href="#h47-0-129" id="h47-0-129" class="d">-                      unicode._ParseContinue(&quot;&lt;Private Use, Last&gt;&quot;))
</a><a href="#h47-0-130" id="h47-0-130" class="d">-    self.assertEquals((&quot;&lt;Private Use, Blah&gt;&quot;, None),
</a><a href="#h47-0-131" id="h47-0-131" class="d">-                      unicode._ParseContinue(&quot;&lt;Private Use, Blah&gt;&quot;))
</a><a href="#h47-0-132" id="h47-0-132" class="d">-
</a><a href="#h47-0-133" id="h47-0-133" class="d">-
</a><a href="#h47-0-134" id="h47-0-134" class="d">-class CaseGroupsTest(googletest.TestCase):
</a><a href="#h47-0-135" id="h47-0-135" class="d">-  &quot;&quot;&quot;Test the CaseGroups function (and the CaseFoldingReader).&quot;&quot;&quot;
</a><a href="#h47-0-136" id="h47-0-136" class="d">-
</a><a href="#h47-0-137" id="h47-0-137" class="d">-  def FindGroup(self, c):
</a><a href="#h47-0-138" id="h47-0-138" class="d">-    if type(c) == str:
</a><a href="#h47-0-139" id="h47-0-139" class="d">-      c = ord(c)
</a><a href="#h47-0-140" id="h47-0-140" class="d">-    for g in self.groups:
</a><a href="#h47-0-141" id="h47-0-141" class="d">-      if c in g:
</a><a href="#h47-0-142" id="h47-0-142" class="d">-        return g
</a><a href="#h47-0-143" id="h47-0-143" class="d">-    return None
</a><a href="#h47-0-144" id="h47-0-144" class="d">-
</a><a href="#h47-0-145" id="h47-0-145" class="d">-  def testCaseGroups(self):
</a><a href="#h47-0-146" id="h47-0-146" class="d">-    self.groups = unicode.CaseGroups(unicode_dir=_UNICODE_DIR)
</a><a href="#h47-0-147" id="h47-0-147" class="d">-    self.assertEquals([ord(&quot;A&quot;), ord(&quot;a&quot;)], self.FindGroup(&quot;a&quot;))
</a><a href="#h47-0-148" id="h47-0-148" class="d">-    self.assertEquals(None, self.FindGroup(&quot;0&quot;))
</a><a href="#h47-0-149" id="h47-0-149" class="d">-
</a><a href="#h47-0-150" id="h47-0-150" class="d">-
</a><a href="#h47-0-151" id="h47-0-151" class="d">-class ScriptsTest(googletest.TestCase):
</a><a href="#h47-0-152" id="h47-0-152" class="d">-  &quot;&quot;&quot;Test the Scripts function (and the ScriptsReader).&quot;&quot;&quot;
</a><a href="#h47-0-153" id="h47-0-153" class="d">-
</a><a href="#h47-0-154" id="h47-0-154" class="d">-  def FindScript(self, c):
</a><a href="#h47-0-155" id="h47-0-155" class="d">-    if type(c) == str:
</a><a href="#h47-0-156" id="h47-0-156" class="d">-      c = ord(c)
</a><a href="#h47-0-157" id="h47-0-157" class="d">-    for script, codes in self.scripts.items():
</a><a href="#h47-0-158" id="h47-0-158" class="d">-      for code in codes:
</a><a href="#h47-0-159" id="h47-0-159" class="d">-        if c == code:
</a><a href="#h47-0-160" id="h47-0-160" class="d">-          return script
</a><a href="#h47-0-161" id="h47-0-161" class="d">-    return None
</a><a href="#h47-0-162" id="h47-0-162" class="d">-
</a><a href="#h47-0-163" id="h47-0-163" class="d">-  def testScripts(self):
</a><a href="#h47-0-164" id="h47-0-164" class="d">-    self.scripts = unicode.Scripts(unicode_dir=_UNICODE_DIR)
</a><a href="#h47-0-165" id="h47-0-165" class="d">-    self.assertEquals(&quot;Latin&quot;, self.FindScript(&quot;a&quot;))
</a><a href="#h47-0-166" id="h47-0-166" class="d">-    self.assertEquals(&quot;Common&quot;, self.FindScript(&quot;0&quot;))
</a><a href="#h47-0-167" id="h47-0-167" class="d">-    self.assertEquals(None, self.FindScript(0xFFFE))
</a><a href="#h47-0-168" id="h47-0-168" class="d">-
</a><a href="#h47-0-169" id="h47-0-169" class="d">-
</a><a href="#h47-0-170" id="h47-0-170" class="d">-class CategoriesTest(googletest.TestCase):
</a><a href="#h47-0-171" id="h47-0-171" class="d">-  &quot;&quot;&quot;Test the Categories function (and the UnicodeDataReader).&quot;&quot;&quot;
</a><a href="#h47-0-172" id="h47-0-172" class="d">-
</a><a href="#h47-0-173" id="h47-0-173" class="d">-  def FindCategory(self, c):
</a><a href="#h47-0-174" id="h47-0-174" class="d">-    if type(c) == str:
</a><a href="#h47-0-175" id="h47-0-175" class="d">-      c = ord(c)
</a><a href="#h47-0-176" id="h47-0-176" class="d">-    short = None
</a><a href="#h47-0-177" id="h47-0-177" class="d">-    for category, codes in self.categories.items():
</a><a href="#h47-0-178" id="h47-0-178" class="d">-      for code in codes:
</a><a href="#h47-0-179" id="h47-0-179" class="d">-        if code == c:
</a><a href="#h47-0-180" id="h47-0-180" class="d">-          # prefer category Nd over N
</a><a href="#h47-0-181" id="h47-0-181" class="d">-          if len(category) &gt; 1:
</a><a href="#h47-0-182" id="h47-0-182" class="d">-            return category
</a><a href="#h47-0-183" id="h47-0-183" class="d">-          if short == None:
</a><a href="#h47-0-184" id="h47-0-184" class="d">-            short = category
</a><a href="#h47-0-185" id="h47-0-185" class="d">-    return short
</a><a href="#h47-0-186" id="h47-0-186" class="d">-
</a><a href="#h47-0-187" id="h47-0-187" class="d">-  def testCategories(self):
</a><a href="#h47-0-188" id="h47-0-188" class="d">-    self.categories = unicode.Categories(unicode_dir=_UNICODE_DIR)
</a><a href="#h47-0-189" id="h47-0-189" class="d">-    self.assertEquals(&quot;Ll&quot;, self.FindCategory(&quot;a&quot;))
</a><a href="#h47-0-190" id="h47-0-190" class="d">-    self.assertEquals(&quot;Nd&quot;, self.FindCategory(&quot;0&quot;))
</a><a href="#h47-0-191" id="h47-0-191" class="d">-    self.assertEquals(&quot;Lo&quot;, self.FindCategory(0xAD00))  # in First, Last range
</a><a href="#h47-0-192" id="h47-0-192" class="d">-    self.assertEquals(None, self.FindCategory(0xFFFE))
</a><a href="#h47-0-193" id="h47-0-193" class="d">-    self.assertEquals(&quot;Lo&quot;, self.FindCategory(0x8B5A))
</a><a href="#h47-0-194" id="h47-0-194" class="d">-    self.assertEquals(&quot;Lo&quot;, self.FindCategory(0x6C38))
</a><a href="#h47-0-195" id="h47-0-195" class="d">-    self.assertEquals(&quot;Lo&quot;, self.FindCategory(0x92D2))
</a><a href="#h47-0-196" id="h47-0-196" class="d">-    self.assertTrue(ord(&quot;a&quot;) in self.categories[&quot;L&quot;])
</a><a href="#h47-0-197" id="h47-0-197" class="d">-    self.assertTrue(ord(&quot;0&quot;) in self.categories[&quot;N&quot;])
</a><a href="#h47-0-198" id="h47-0-198" class="d">-    self.assertTrue(0x8B5A in self.categories[&quot;L&quot;])
</a><a href="#h47-0-199" id="h47-0-199" class="d">-    self.assertTrue(0x6C38 in self.categories[&quot;L&quot;])
</a><a href="#h47-0-200" id="h47-0-200" class="d">-    self.assertTrue(0x92D2 in self.categories[&quot;L&quot;])
</a><a href="#h47-0-201" id="h47-0-201" class="d">-
</a><a href="#h47-0-202" id="h47-0-202" class="d">-def main():
</a><a href="#h47-0-203" id="h47-0-203" class="d">-  googletest.main()
</a><a href="#h47-0-204" id="h47-0-204" class="d">-
</a><a href="#h47-0-205" id="h47-0-205" class="d">-if __name__ == &quot;__main__&quot;:
</a><a href="#h47-0-206" id="h47-0-206" class="d">-  main()
</a><b>diff --git a/<a id="h48" href="../file/src/vendor/re2/re2/tostring.cc">src/vendor/re2/re2/tostring.cc</a> b/<a href="../file/src/vendor/re2/re2/tostring.cc">src/vendor/re2/re2/tostring.cc</a></b>
<a href="#h48-0" id="h48-0" class="h">@@ -94,6 +94,8 @@ int ToStringWalker::PreVisit(Regexp* re, int parent_arg, bool* stop) {
</a> 
     case kRegexpCapture:
       t_-&gt;append(&quot;(&quot;);
<a href="#h48-0-3" id="h48-0-3" class="i">+      if (re-&gt;cap() == 0)
</a><a href="#h48-0-4" id="h48-0-4" class="i">+        LOG(DFATAL) &lt;&lt; &quot;kRegexpCapture cap() == 0&quot;;
</a>       if (re-&gt;name()) {
         t_-&gt;append(&quot;?P&lt;&quot;);
         t_-&gt;append(*re-&gt;name());
<a href="#h48-1" id="h48-1" class="h">@@ -120,13 +122,13 @@ int ToStringWalker::PreVisit(Regexp* re, int parent_arg, bool* stop) {
</a> static void AppendLiteral(string *t, Rune r, bool foldcase) {
   if (r != 0 &amp;&amp; r &lt; 0x80 &amp;&amp; strchr(&quot;(){}[]*+?|.^$\\&quot;, r)) {
     t-&gt;append(1, &#39;\\&#39;);
<a href="#h48-1-3" id="h48-1-3" class="d">-    t-&gt;append(1, r);
</a><a href="#h48-1-4" id="h48-1-4" class="i">+    t-&gt;append(1, static_cast&lt;char&gt;(r));
</a>   } else if (foldcase &amp;&amp; &#39;a&#39; &lt;= r &amp;&amp; r &lt;= &#39;z&#39;) {
     if (&#39;a&#39; &lt;= r &amp;&amp; r &lt;= &#39;z&#39;)
       r += &#39;A&#39; - &#39;a&#39;;
     t-&gt;append(1, &#39;[&#39;);
<a href="#h48-1-9" id="h48-1-9" class="d">-    t-&gt;append(1, r);
</a><a href="#h48-1-10" id="h48-1-10" class="d">-    t-&gt;append(1, r + &#39;a&#39; - &#39;A&#39;);
</a><a href="#h48-1-11" id="h48-1-11" class="i">+    t-&gt;append(1, static_cast&lt;char&gt;(r));
</a><a href="#h48-1-12" id="h48-1-12" class="i">+    t-&gt;append(1, static_cast&lt;char&gt;(r) + &#39;a&#39; - &#39;A&#39;);
</a>     t-&gt;append(1, &#39;]&#39;);
   } else {
     AppendCCRange(t, r, r);
<a href="#h48-2" id="h48-2" class="h">@@ -297,7 +299,7 @@ static void AppendCCChar(string* t, Rune r) {
</a>   if (0x20 &lt;= r &amp;&amp; r &lt;= 0x7E) {
     if (strchr(&quot;[]^-\\&quot;, r))
       t-&gt;append(&quot;\\&quot;);
<a href="#h48-2-3" id="h48-2-3" class="d">-    t-&gt;append(1, r);
</a><a href="#h48-2-4" id="h48-2-4" class="i">+    t-&gt;append(1, static_cast&lt;char&gt;(r));
</a>     return;
   }
   switch (r) {
<b>diff --git a/<a id="h49" href="../file/src/vendor/re2/re2_test.bzl">src/vendor/re2/re2_test.bzl</a> b/<a href="../file/src/vendor/re2/re2_test.bzl">src/vendor/re2/re2_test.bzl</a></b>
<a href="#h49-0" id="h49-0" class="h">@@ -0,0 +1,14 @@
</a><a href="#h49-0-0" id="h49-0-0" class="i">+# Copyright 2009 The RE2 Authors.  All Rights Reserved.
</a><a href="#h49-0-1" id="h49-0-1" class="i">+# Use of this source code is governed by a BSD-style
</a><a href="#h49-0-2" id="h49-0-2" class="i">+# license that can be found in the LICENSE file.
</a><a href="#h49-0-3" id="h49-0-3" class="i">+
</a><a href="#h49-0-4" id="h49-0-4" class="i">+# Define a bazel macro that creates cc_test for re2.
</a><a href="#h49-0-5" id="h49-0-5" class="i">+def re2_test(name, deps=[]):
</a><a href="#h49-0-6" id="h49-0-6" class="i">+  native.cc_test(
</a><a href="#h49-0-7" id="h49-0-7" class="i">+      name=name,
</a><a href="#h49-0-8" id="h49-0-8" class="i">+      srcs=[&quot;re2/testing/%s.cc&quot; % (name)],
</a><a href="#h49-0-9" id="h49-0-9" class="i">+      deps=[
</a><a href="#h49-0-10" id="h49-0-10" class="i">+          &quot;:re2&quot;,
</a><a href="#h49-0-11" id="h49-0-11" class="i">+          &quot;:test&quot;,
</a><a href="#h49-0-12" id="h49-0-12" class="i">+      ] + deps
</a><a href="#h49-0-13" id="h49-0-13" class="i">+  )
</a><b>diff --git a/<a id="h50" href="../file/src/vendor/re2/util/arena.cc">src/vendor/re2/util/arena.cc</a> b/<a href="../file/src/vendor/re2/util/arena.cc">src/vendor/re2/util/arena.cc</a></b>
<a href="#h50-0" id="h50-0" class="h">@@ -1,168 +0,0 @@
</a><a href="#h50-0-0" id="h50-0-0" class="d">-// Copyright 2000 The RE2 Authors.  All Rights Reserved.
</a><a href="#h50-0-1" id="h50-0-1" class="d">-// Use of this source code is governed by a BSD-style
</a><a href="#h50-0-2" id="h50-0-2" class="d">-// license that can be found in the LICENSE file.
</a><a href="#h50-0-3" id="h50-0-3" class="d">-
</a><a href="#h50-0-4" id="h50-0-4" class="d">-#include &quot;util/util.h&quot;
</a><a href="#h50-0-5" id="h50-0-5" class="d">-
</a><a href="#h50-0-6" id="h50-0-6" class="d">-namespace re2 {
</a><a href="#h50-0-7" id="h50-0-7" class="d">-
</a><a href="#h50-0-8" id="h50-0-8" class="d">-// ----------------------------------------------------------------------
</a><a href="#h50-0-9" id="h50-0-9" class="d">-// UnsafeArena::UnsafeArena()
</a><a href="#h50-0-10" id="h50-0-10" class="d">-// UnsafeArena::~UnsafeArena()
</a><a href="#h50-0-11" id="h50-0-11" class="d">-//    Destroying the arena automatically calls Reset()
</a><a href="#h50-0-12" id="h50-0-12" class="d">-// ----------------------------------------------------------------------
</a><a href="#h50-0-13" id="h50-0-13" class="d">-
</a><a href="#h50-0-14" id="h50-0-14" class="d">-
</a><a href="#h50-0-15" id="h50-0-15" class="d">-UnsafeArena::UnsafeArena(const size_t block_size)
</a><a href="#h50-0-16" id="h50-0-16" class="d">-  : block_size_(block_size),
</a><a href="#h50-0-17" id="h50-0-17" class="d">-    freestart_(NULL),                   // set for real in Reset()
</a><a href="#h50-0-18" id="h50-0-18" class="d">-    last_alloc_(NULL),
</a><a href="#h50-0-19" id="h50-0-19" class="d">-    remaining_(0),
</a><a href="#h50-0-20" id="h50-0-20" class="d">-    blocks_alloced_(1),
</a><a href="#h50-0-21" id="h50-0-21" class="d">-    overflow_blocks_(NULL) {
</a><a href="#h50-0-22" id="h50-0-22" class="d">-  assert(block_size &gt; kDefaultAlignment);
</a><a href="#h50-0-23" id="h50-0-23" class="d">-
</a><a href="#h50-0-24" id="h50-0-24" class="d">-  first_blocks_[0].mem = reinterpret_cast&lt;char*&gt;(malloc(block_size_));
</a><a href="#h50-0-25" id="h50-0-25" class="d">-  first_blocks_[0].size = block_size_;
</a><a href="#h50-0-26" id="h50-0-26" class="d">-
</a><a href="#h50-0-27" id="h50-0-27" class="d">-  Reset();
</a><a href="#h50-0-28" id="h50-0-28" class="d">-}
</a><a href="#h50-0-29" id="h50-0-29" class="d">-
</a><a href="#h50-0-30" id="h50-0-30" class="d">-UnsafeArena::~UnsafeArena() {
</a><a href="#h50-0-31" id="h50-0-31" class="d">-  FreeBlocks();
</a><a href="#h50-0-32" id="h50-0-32" class="d">-  assert(overflow_blocks_ == NULL);    // FreeBlocks() should do that
</a><a href="#h50-0-33" id="h50-0-33" class="d">-  // The first X blocks stay allocated always by default.  Delete them now.
</a><a href="#h50-0-34" id="h50-0-34" class="d">-  for (int i = 0; i &lt; blocks_alloced_; i++)
</a><a href="#h50-0-35" id="h50-0-35" class="d">-    free(first_blocks_[i].mem);
</a><a href="#h50-0-36" id="h50-0-36" class="d">-}
</a><a href="#h50-0-37" id="h50-0-37" class="d">-
</a><a href="#h50-0-38" id="h50-0-38" class="d">-// ----------------------------------------------------------------------
</a><a href="#h50-0-39" id="h50-0-39" class="d">-// UnsafeArena::Reset()
</a><a href="#h50-0-40" id="h50-0-40" class="d">-//    Clears all the memory an arena is using.
</a><a href="#h50-0-41" id="h50-0-41" class="d">-// ----------------------------------------------------------------------
</a><a href="#h50-0-42" id="h50-0-42" class="d">-
</a><a href="#h50-0-43" id="h50-0-43" class="d">-void UnsafeArena::Reset() {
</a><a href="#h50-0-44" id="h50-0-44" class="d">-  FreeBlocks();
</a><a href="#h50-0-45" id="h50-0-45" class="d">-  freestart_ = first_blocks_[0].mem;
</a><a href="#h50-0-46" id="h50-0-46" class="d">-  remaining_ = first_blocks_[0].size;
</a><a href="#h50-0-47" id="h50-0-47" class="d">-  last_alloc_ = NULL;
</a><a href="#h50-0-48" id="h50-0-48" class="d">-
</a><a href="#h50-0-49" id="h50-0-49" class="d">-  // We do not know for sure whether or not the first block is aligned,
</a><a href="#h50-0-50" id="h50-0-50" class="d">-  // so we fix that right now.
</a><a href="#h50-0-51" id="h50-0-51" class="d">-  const int overage = reinterpret_cast&lt;uintptr_t&gt;(freestart_) &amp;
</a><a href="#h50-0-52" id="h50-0-52" class="d">-                      (kDefaultAlignment-1);
</a><a href="#h50-0-53" id="h50-0-53" class="d">-  if (overage &gt; 0) {
</a><a href="#h50-0-54" id="h50-0-54" class="d">-    const int waste = kDefaultAlignment - overage;
</a><a href="#h50-0-55" id="h50-0-55" class="d">-    freestart_ += waste;
</a><a href="#h50-0-56" id="h50-0-56" class="d">-    remaining_ -= waste;
</a><a href="#h50-0-57" id="h50-0-57" class="d">-  }
</a><a href="#h50-0-58" id="h50-0-58" class="d">-  freestart_when_empty_ = freestart_;
</a><a href="#h50-0-59" id="h50-0-59" class="d">-  assert(!(reinterpret_cast&lt;uintptr_t&gt;(freestart_)&amp;(kDefaultAlignment-1)));
</a><a href="#h50-0-60" id="h50-0-60" class="d">-}
</a><a href="#h50-0-61" id="h50-0-61" class="d">-
</a><a href="#h50-0-62" id="h50-0-62" class="d">-// -------------------------------------------------------------
</a><a href="#h50-0-63" id="h50-0-63" class="d">-// UnsafeArena::AllocNewBlock()
</a><a href="#h50-0-64" id="h50-0-64" class="d">-//    Adds and returns an AllocatedBlock.
</a><a href="#h50-0-65" id="h50-0-65" class="d">-//    The returned AllocatedBlock* is valid until the next call
</a><a href="#h50-0-66" id="h50-0-66" class="d">-//    to AllocNewBlock or Reset.  (i.e. anything that might
</a><a href="#h50-0-67" id="h50-0-67" class="d">-//    affect overflow_blocks_).
</a><a href="#h50-0-68" id="h50-0-68" class="d">-// -------------------------------------------------------------
</a><a href="#h50-0-69" id="h50-0-69" class="d">-
</a><a href="#h50-0-70" id="h50-0-70" class="d">-UnsafeArena::AllocatedBlock* UnsafeArena::AllocNewBlock(const size_t block_size) {
</a><a href="#h50-0-71" id="h50-0-71" class="d">-  AllocatedBlock *block;
</a><a href="#h50-0-72" id="h50-0-72" class="d">-  // Find the next block.
</a><a href="#h50-0-73" id="h50-0-73" class="d">-  if ( blocks_alloced_ &lt; arraysize(first_blocks_) ) {
</a><a href="#h50-0-74" id="h50-0-74" class="d">-    // Use one of the pre-allocated blocks
</a><a href="#h50-0-75" id="h50-0-75" class="d">-    block = &amp;first_blocks_[blocks_alloced_++];
</a><a href="#h50-0-76" id="h50-0-76" class="d">-  } else {                   // oops, out of space, move to the vector
</a><a href="#h50-0-77" id="h50-0-77" class="d">-    if (overflow_blocks_ == NULL) overflow_blocks_ = new vector&lt;AllocatedBlock&gt;;
</a><a href="#h50-0-78" id="h50-0-78" class="d">-    // Adds another block to the vector.
</a><a href="#h50-0-79" id="h50-0-79" class="d">-    overflow_blocks_-&gt;resize(overflow_blocks_-&gt;size()+1);
</a><a href="#h50-0-80" id="h50-0-80" class="d">-    // block points to the last block of the vector.
</a><a href="#h50-0-81" id="h50-0-81" class="d">-    block = &amp;overflow_blocks_-&gt;back();
</a><a href="#h50-0-82" id="h50-0-82" class="d">-  }
</a><a href="#h50-0-83" id="h50-0-83" class="d">-
</a><a href="#h50-0-84" id="h50-0-84" class="d">-  block-&gt;mem = reinterpret_cast&lt;char*&gt;(malloc(block_size));
</a><a href="#h50-0-85" id="h50-0-85" class="d">-  block-&gt;size = block_size;
</a><a href="#h50-0-86" id="h50-0-86" class="d">-
</a><a href="#h50-0-87" id="h50-0-87" class="d">-  return block;
</a><a href="#h50-0-88" id="h50-0-88" class="d">-}
</a><a href="#h50-0-89" id="h50-0-89" class="d">-
</a><a href="#h50-0-90" id="h50-0-90" class="d">-// ----------------------------------------------------------------------
</a><a href="#h50-0-91" id="h50-0-91" class="d">-// UnsafeArena::GetMemoryFallback()
</a><a href="#h50-0-92" id="h50-0-92" class="d">-//    We take memory out of our pool, aligned on the byte boundary
</a><a href="#h50-0-93" id="h50-0-93" class="d">-//    requested.  If we don&#39;t have space in our current pool, we
</a><a href="#h50-0-94" id="h50-0-94" class="d">-//    allocate a new block (wasting the remaining space in the
</a><a href="#h50-0-95" id="h50-0-95" class="d">-//    current block) and give you that.  If your memory needs are
</a><a href="#h50-0-96" id="h50-0-96" class="d">-//    too big for a single block, we make a special your-memory-only
</a><a href="#h50-0-97" id="h50-0-97" class="d">-//    allocation -- this is equivalent to not using the arena at all.
</a><a href="#h50-0-98" id="h50-0-98" class="d">-// ----------------------------------------------------------------------
</a><a href="#h50-0-99" id="h50-0-99" class="d">-
</a><a href="#h50-0-100" id="h50-0-100" class="d">-void* UnsafeArena::GetMemoryFallback(const size_t size, const int align) {
</a><a href="#h50-0-101" id="h50-0-101" class="d">-  if (size == 0)
</a><a href="#h50-0-102" id="h50-0-102" class="d">-    return NULL;             // stl/stl_alloc.h says this is okay
</a><a href="#h50-0-103" id="h50-0-103" class="d">-
</a><a href="#h50-0-104" id="h50-0-104" class="d">-  assert(align &gt; 0 &amp;&amp; 0 == (align &amp; (align - 1)));  // must be power of 2
</a><a href="#h50-0-105" id="h50-0-105" class="d">-
</a><a href="#h50-0-106" id="h50-0-106" class="d">-  // If the object is more than a quarter of the block size, allocate
</a><a href="#h50-0-107" id="h50-0-107" class="d">-  // it separately to avoid wasting too much space in leftover bytes
</a><a href="#h50-0-108" id="h50-0-108" class="d">-  if (block_size_ == 0 || size &gt; block_size_/4) {
</a><a href="#h50-0-109" id="h50-0-109" class="d">-    // then it gets its own block in the arena
</a><a href="#h50-0-110" id="h50-0-110" class="d">-    assert(align &lt;= kDefaultAlignment);   // because that&#39;s what new gives us
</a><a href="#h50-0-111" id="h50-0-111" class="d">-    // This block stays separate from the rest of the world; in particular
</a><a href="#h50-0-112" id="h50-0-112" class="d">-    // we don&#39;t update last_alloc_ so you can&#39;t reclaim space on this block.
</a><a href="#h50-0-113" id="h50-0-113" class="d">-    return AllocNewBlock(size)-&gt;mem;
</a><a href="#h50-0-114" id="h50-0-114" class="d">-  }
</a><a href="#h50-0-115" id="h50-0-115" class="d">-
</a><a href="#h50-0-116" id="h50-0-116" class="d">-  const size_t overage =
</a><a href="#h50-0-117" id="h50-0-117" class="d">-    (reinterpret_cast&lt;uintptr_t&gt;(freestart_) &amp; (align-1));
</a><a href="#h50-0-118" id="h50-0-118" class="d">-  if (overage) {
</a><a href="#h50-0-119" id="h50-0-119" class="d">-    const size_t waste = align - overage;
</a><a href="#h50-0-120" id="h50-0-120" class="d">-    freestart_ += waste;
</a><a href="#h50-0-121" id="h50-0-121" class="d">-    if (waste &lt; remaining_) {
</a><a href="#h50-0-122" id="h50-0-122" class="d">-      remaining_ -= waste;
</a><a href="#h50-0-123" id="h50-0-123" class="d">-    } else {
</a><a href="#h50-0-124" id="h50-0-124" class="d">-      remaining_ = 0;
</a><a href="#h50-0-125" id="h50-0-125" class="d">-    }
</a><a href="#h50-0-126" id="h50-0-126" class="d">-  }
</a><a href="#h50-0-127" id="h50-0-127" class="d">-  if (size &gt; remaining_) {
</a><a href="#h50-0-128" id="h50-0-128" class="d">-    AllocatedBlock *block = AllocNewBlock(block_size_);
</a><a href="#h50-0-129" id="h50-0-129" class="d">-    freestart_ = block-&gt;mem;
</a><a href="#h50-0-130" id="h50-0-130" class="d">-    remaining_ = block-&gt;size;
</a><a href="#h50-0-131" id="h50-0-131" class="d">-  }
</a><a href="#h50-0-132" id="h50-0-132" class="d">-  remaining_ -= size;
</a><a href="#h50-0-133" id="h50-0-133" class="d">-  last_alloc_ = freestart_;
</a><a href="#h50-0-134" id="h50-0-134" class="d">-  freestart_ += size;
</a><a href="#h50-0-135" id="h50-0-135" class="d">-  assert((reinterpret_cast&lt;uintptr_t&gt;(last_alloc_) &amp; (align-1)) == 0);
</a><a href="#h50-0-136" id="h50-0-136" class="d">-  return reinterpret_cast&lt;void*&gt;(last_alloc_);
</a><a href="#h50-0-137" id="h50-0-137" class="d">-}
</a><a href="#h50-0-138" id="h50-0-138" class="d">-
</a><a href="#h50-0-139" id="h50-0-139" class="d">-// ----------------------------------------------------------------------
</a><a href="#h50-0-140" id="h50-0-140" class="d">-// UnsafeArena::FreeBlocks()
</a><a href="#h50-0-141" id="h50-0-141" class="d">-//    Unlike GetMemory(), which does actual work, ReturnMemory() is a
</a><a href="#h50-0-142" id="h50-0-142" class="d">-//    no-op: we don&#39;t &quot;free&quot; memory until Reset() is called.  We do
</a><a href="#h50-0-143" id="h50-0-143" class="d">-//    update some stats, though.  Note we do no checking that the
</a><a href="#h50-0-144" id="h50-0-144" class="d">-//    pointer you pass in was actually allocated by us, or that it
</a><a href="#h50-0-145" id="h50-0-145" class="d">-//    was allocated for the size you say, so be careful here!
</a><a href="#h50-0-146" id="h50-0-146" class="d">-//       FreeBlocks() does the work for Reset(), actually freeing all
</a><a href="#h50-0-147" id="h50-0-147" class="d">-//    memory allocated in one fell swoop.
</a><a href="#h50-0-148" id="h50-0-148" class="d">-// ----------------------------------------------------------------------
</a><a href="#h50-0-149" id="h50-0-149" class="d">-
</a><a href="#h50-0-150" id="h50-0-150" class="d">-void UnsafeArena::FreeBlocks() {
</a><a href="#h50-0-151" id="h50-0-151" class="d">-  for ( int i = 1; i &lt; blocks_alloced_; ++i ) {  // keep first block alloced
</a><a href="#h50-0-152" id="h50-0-152" class="d">-    free(first_blocks_[i].mem);
</a><a href="#h50-0-153" id="h50-0-153" class="d">-    first_blocks_[i].mem = NULL;
</a><a href="#h50-0-154" id="h50-0-154" class="d">-    first_blocks_[i].size = 0;
</a><a href="#h50-0-155" id="h50-0-155" class="d">-  }
</a><a href="#h50-0-156" id="h50-0-156" class="d">-  blocks_alloced_ = 1;
</a><a href="#h50-0-157" id="h50-0-157" class="d">-  if (overflow_blocks_ != NULL) {
</a><a href="#h50-0-158" id="h50-0-158" class="d">-    vector&lt;AllocatedBlock&gt;::iterator it;
</a><a href="#h50-0-159" id="h50-0-159" class="d">-    for (it = overflow_blocks_-&gt;begin(); it != overflow_blocks_-&gt;end(); ++it) {
</a><a href="#h50-0-160" id="h50-0-160" class="d">-      free(it-&gt;mem);
</a><a href="#h50-0-161" id="h50-0-161" class="d">-    }
</a><a href="#h50-0-162" id="h50-0-162" class="d">-    delete overflow_blocks_;             // These should be used very rarely
</a><a href="#h50-0-163" id="h50-0-163" class="d">-    overflow_blocks_ = NULL;
</a><a href="#h50-0-164" id="h50-0-164" class="d">-  }
</a><a href="#h50-0-165" id="h50-0-165" class="d">-}
</a><a href="#h50-0-166" id="h50-0-166" class="d">-
</a><a href="#h50-0-167" id="h50-0-167" class="d">-}  // namespace re2
</a><b>diff --git a/<a id="h51" href="../file/src/vendor/re2/util/arena.h">src/vendor/re2/util/arena.h</a> b/<a href="../file/src/vendor/re2/util/arena.h">src/vendor/re2/util/arena.h</a></b>
<a href="#h51-0" id="h51-0" class="h">@@ -1,103 +0,0 @@
</a><a href="#h51-0-0" id="h51-0-0" class="d">-// Copyright 2000 The RE2 Authors.  All Rights Reserved.
</a><a href="#h51-0-1" id="h51-0-1" class="d">-// Use of this source code is governed by a BSD-style
</a><a href="#h51-0-2" id="h51-0-2" class="d">-// license that can be found in the LICENSE file.
</a><a href="#h51-0-3" id="h51-0-3" class="d">-
</a><a href="#h51-0-4" id="h51-0-4" class="d">-// Sometimes it is necessary to allocate a large number of small
</a><a href="#h51-0-5" id="h51-0-5" class="d">-// objects.  Doing this the usual way (malloc, new) is slow,
</a><a href="#h51-0-6" id="h51-0-6" class="d">-// especially for multithreaded programs.  An UnsafeArena provides a
</a><a href="#h51-0-7" id="h51-0-7" class="d">-// mark/release method of memory management: it asks for a large chunk
</a><a href="#h51-0-8" id="h51-0-8" class="d">-// from the operating system and doles it out bit by bit as required.
</a><a href="#h51-0-9" id="h51-0-9" class="d">-// Then you free all the memory at once by calling UnsafeArena::Reset().
</a><a href="#h51-0-10" id="h51-0-10" class="d">-// The &quot;Unsafe&quot; refers to the fact that UnsafeArena is not safe to
</a><a href="#h51-0-11" id="h51-0-11" class="d">-// call from multiple threads.
</a><a href="#h51-0-12" id="h51-0-12" class="d">-//
</a><a href="#h51-0-13" id="h51-0-13" class="d">-// The global operator new that can be used as follows:
</a><a href="#h51-0-14" id="h51-0-14" class="d">-//
</a><a href="#h51-0-15" id="h51-0-15" class="d">-//   #include &quot;lib/arena-inl.h&quot;
</a><a href="#h51-0-16" id="h51-0-16" class="d">-//
</a><a href="#h51-0-17" id="h51-0-17" class="d">-//   UnsafeArena arena(1000);
</a><a href="#h51-0-18" id="h51-0-18" class="d">-//   Foo* foo = new (AllocateInArena, &amp;arena) Foo;
</a><a href="#h51-0-19" id="h51-0-19" class="d">-//
</a><a href="#h51-0-20" id="h51-0-20" class="d">-
</a><a href="#h51-0-21" id="h51-0-21" class="d">-#ifndef RE2_UTIL_ARENA_H_
</a><a href="#h51-0-22" id="h51-0-22" class="d">-#define RE2_UTIL_ARENA_H_
</a><a href="#h51-0-23" id="h51-0-23" class="d">-
</a><a href="#h51-0-24" id="h51-0-24" class="d">-namespace re2 {
</a><a href="#h51-0-25" id="h51-0-25" class="d">-
</a><a href="#h51-0-26" id="h51-0-26" class="d">-// This class is thread-compatible.
</a><a href="#h51-0-27" id="h51-0-27" class="d">-class UnsafeArena {
</a><a href="#h51-0-28" id="h51-0-28" class="d">- public:
</a><a href="#h51-0-29" id="h51-0-29" class="d">-  UnsafeArena(const size_t block_size);
</a><a href="#h51-0-30" id="h51-0-30" class="d">-  virtual ~UnsafeArena();
</a><a href="#h51-0-31" id="h51-0-31" class="d">-
</a><a href="#h51-0-32" id="h51-0-32" class="d">-  void Reset();
</a><a href="#h51-0-33" id="h51-0-33" class="d">-
</a><a href="#h51-0-34" id="h51-0-34" class="d">-  // This should be the worst-case alignment for any type.  This is
</a><a href="#h51-0-35" id="h51-0-35" class="d">-  // good for IA-32, SPARC version 7 (the last one I know), and
</a><a href="#h51-0-36" id="h51-0-36" class="d">-  // supposedly Alpha.  i386 would be more time-efficient with a
</a><a href="#h51-0-37" id="h51-0-37" class="d">-  // default alignment of 8, but ::operator new() uses alignment of 4,
</a><a href="#h51-0-38" id="h51-0-38" class="d">-  // and an assertion will fail below after the call to MakeNewBlock()
</a><a href="#h51-0-39" id="h51-0-39" class="d">-  // if you try to use a larger alignment.
</a><a href="#h51-0-40" id="h51-0-40" class="d">-#ifdef __i386__
</a><a href="#h51-0-41" id="h51-0-41" class="d">-  static const int kDefaultAlignment = 4;
</a><a href="#h51-0-42" id="h51-0-42" class="d">-#else
</a><a href="#h51-0-43" id="h51-0-43" class="d">-  static const int kDefaultAlignment = 8;
</a><a href="#h51-0-44" id="h51-0-44" class="d">-#endif
</a><a href="#h51-0-45" id="h51-0-45" class="d">-
</a><a href="#h51-0-46" id="h51-0-46" class="d">- private:
</a><a href="#h51-0-47" id="h51-0-47" class="d">-  void* GetMemoryFallback(const size_t size, const int align);
</a><a href="#h51-0-48" id="h51-0-48" class="d">-
</a><a href="#h51-0-49" id="h51-0-49" class="d">- public:
</a><a href="#h51-0-50" id="h51-0-50" class="d">-  void* GetMemory(const size_t size, const int align) {
</a><a href="#h51-0-51" id="h51-0-51" class="d">-    if ( size &gt; 0 &amp;&amp; size &lt; remaining_ &amp;&amp; align == 1 ) {       // common case
</a><a href="#h51-0-52" id="h51-0-52" class="d">-      last_alloc_ = freestart_;
</a><a href="#h51-0-53" id="h51-0-53" class="d">-      freestart_ += size;
</a><a href="#h51-0-54" id="h51-0-54" class="d">-      remaining_ -= size;
</a><a href="#h51-0-55" id="h51-0-55" class="d">-      return reinterpret_cast&lt;void*&gt;(last_alloc_);
</a><a href="#h51-0-56" id="h51-0-56" class="d">-    }
</a><a href="#h51-0-57" id="h51-0-57" class="d">-    return GetMemoryFallback(size, align);
</a><a href="#h51-0-58" id="h51-0-58" class="d">-  }
</a><a href="#h51-0-59" id="h51-0-59" class="d">-
</a><a href="#h51-0-60" id="h51-0-60" class="d">- private:
</a><a href="#h51-0-61" id="h51-0-61" class="d">-  struct AllocatedBlock {
</a><a href="#h51-0-62" id="h51-0-62" class="d">-    char *mem;
</a><a href="#h51-0-63" id="h51-0-63" class="d">-    size_t size;
</a><a href="#h51-0-64" id="h51-0-64" class="d">-  };
</a><a href="#h51-0-65" id="h51-0-65" class="d">-
</a><a href="#h51-0-66" id="h51-0-66" class="d">-  // The returned AllocatedBlock* is valid until the next call to AllocNewBlock
</a><a href="#h51-0-67" id="h51-0-67" class="d">-  // or Reset (i.e. anything that might affect overflow_blocks_).
</a><a href="#h51-0-68" id="h51-0-68" class="d">-  AllocatedBlock *AllocNewBlock(const size_t block_size);
</a><a href="#h51-0-69" id="h51-0-69" class="d">-
</a><a href="#h51-0-70" id="h51-0-70" class="d">-  const AllocatedBlock *IndexToBlock(int index) const;
</a><a href="#h51-0-71" id="h51-0-71" class="d">-
</a><a href="#h51-0-72" id="h51-0-72" class="d">-  const size_t block_size_;
</a><a href="#h51-0-73" id="h51-0-73" class="d">-  char* freestart_;         // beginning of the free space in most recent block
</a><a href="#h51-0-74" id="h51-0-74" class="d">-  char* freestart_when_empty_;  // beginning of the free space when we&#39;re empty
</a><a href="#h51-0-75" id="h51-0-75" class="d">-  char* last_alloc_;         // used to make sure ReturnBytes() is safe
</a><a href="#h51-0-76" id="h51-0-76" class="d">-  size_t remaining_;
</a><a href="#h51-0-77" id="h51-0-77" class="d">-  // STL vector isn&#39;t as efficient as it could be, so we use an array at first
</a><a href="#h51-0-78" id="h51-0-78" class="d">-  int blocks_alloced_;       // how many of the first_blocks_ have been alloced
</a><a href="#h51-0-79" id="h51-0-79" class="d">-  AllocatedBlock first_blocks_[16];   // the length of this array is arbitrary
</a><a href="#h51-0-80" id="h51-0-80" class="d">-  // if the first_blocks_ aren&#39;t enough, expand into overflow_blocks_.
</a><a href="#h51-0-81" id="h51-0-81" class="d">-  vector&lt;AllocatedBlock&gt;* overflow_blocks_;
</a><a href="#h51-0-82" id="h51-0-82" class="d">-
</a><a href="#h51-0-83" id="h51-0-83" class="d">-  void FreeBlocks();         // Frees all except first block
</a><a href="#h51-0-84" id="h51-0-84" class="d">-
</a><a href="#h51-0-85" id="h51-0-85" class="d">-  DISALLOW_COPY_AND_ASSIGN(UnsafeArena);
</a><a href="#h51-0-86" id="h51-0-86" class="d">-};
</a><a href="#h51-0-87" id="h51-0-87" class="d">-
</a><a href="#h51-0-88" id="h51-0-88" class="d">-// Operators for allocation on the arena
</a><a href="#h51-0-89" id="h51-0-89" class="d">-// Syntax: new (AllocateInArena, arena) MyClass;
</a><a href="#h51-0-90" id="h51-0-90" class="d">-// STL containers, etc.
</a><a href="#h51-0-91" id="h51-0-91" class="d">-enum AllocateInArenaType { AllocateInArena };
</a><a href="#h51-0-92" id="h51-0-92" class="d">-
</a><a href="#h51-0-93" id="h51-0-93" class="d">-}  // namespace re2
</a><a href="#h51-0-94" id="h51-0-94" class="d">-
</a><a href="#h51-0-95" id="h51-0-95" class="d">-inline void* operator new(size_t size,
</a><a href="#h51-0-96" id="h51-0-96" class="d">-                          re2::AllocateInArenaType /* unused */,
</a><a href="#h51-0-97" id="h51-0-97" class="d">-                          re2::UnsafeArena *arena) {
</a><a href="#h51-0-98" id="h51-0-98" class="d">-  return reinterpret_cast&lt;char*&gt;(arena-&gt;GetMemory(size, 1));
</a><a href="#h51-0-99" id="h51-0-99" class="d">-}
</a><a href="#h51-0-100" id="h51-0-100" class="d">-
</a><a href="#h51-0-101" id="h51-0-101" class="d">-#endif  // RE2_UTIL_ARENA_H_
</a><a href="#h51-0-102" id="h51-0-102" class="d">-
</a><b>diff --git a/<a id="h52" href="../file/src/vendor/re2/util/atomicops.h">src/vendor/re2/util/atomicops.h</a> b/<a href="../file/src/vendor/re2/util/atomicops.h">src/vendor/re2/util/atomicops.h</a></b>
<a href="#h52-0" id="h52-0" class="h">@@ -53,19 +53,19 @@ static inline void WriteMemoryBarrier() {
</a> #elif defined(__ppc__) || defined(__powerpc64__)
 
 static inline void WriteMemoryBarrier() {
<a href="#h52-0-3" id="h52-0-3" class="d">-  __asm__ __volatile__(&quot;eieio&quot; : : : &quot;memory&quot;);
</a><a href="#h52-0-4" id="h52-0-4" class="i">+  __asm__ __volatile__(&quot;lwsync&quot; : : : &quot;memory&quot;);
</a> }
 
<a href="#h52-0-7" id="h52-0-7" class="d">-#elif defined(__alpha__)
</a><a href="#h52-0-8" id="h52-0-8" class="i">+#elif defined(__aarch64__)
</a> 
 static inline void WriteMemoryBarrier() {
<a href="#h52-0-11" id="h52-0-11" class="d">-  __asm__ __volatile__(&quot;wmb&quot; : : : &quot;memory&quot;);
</a><a href="#h52-0-12" id="h52-0-12" class="i">+  __asm__ __volatile__(&quot;dmb st&quot; : : : &quot;memory&quot;);
</a> }
 
<a href="#h52-0-15" id="h52-0-15" class="d">-#elif defined(__aarch64__)
</a><a href="#h52-0-16" id="h52-0-16" class="i">+#elif defined(__alpha__)
</a> 
 static inline void WriteMemoryBarrier() {
<a href="#h52-0-19" id="h52-0-19" class="d">-  __asm__ __volatile__(&quot;dmb st&quot; : : : &quot;memory&quot;);
</a><a href="#h52-0-20" id="h52-0-20" class="i">+  __asm__ __volatile__(&quot;wmb&quot; : : : &quot;memory&quot;);
</a> }
 
 #elif defined(__arm__) &amp;&amp; defined(__linux__)
<a href="#h52-1" id="h52-1" class="h">@@ -75,24 +75,33 @@ static inline void WriteMemoryBarrier() {
</a>   ((void(*)(void))0xffff0fa0)();
 }
 
<a href="#h52-1-3" id="h52-1-3" class="d">-#elif defined(__windows__)
</a><a href="#h52-1-4" id="h52-1-4" class="i">+#elif defined(__windows__) || defined(_WIN32)
</a><a href="#h52-1-5" id="h52-1-5" class="i">+
</a><a href="#h52-1-6" id="h52-1-6" class="i">+#include &lt;intrin.h&gt;
</a><a href="#h52-1-7" id="h52-1-7" class="i">+#include &lt;windows.h&gt;
</a> 
<a href="#h52-1-9" id="h52-1-9" class="d">-// Windows
</a><a href="#h52-1-10" id="h52-1-10" class="d">-inline void WriteMemoryBarrier() {
</a><a href="#h52-1-11" id="h52-1-11" class="i">+static inline void WriteMemoryBarrier() {
</a><a href="#h52-1-12" id="h52-1-12" class="i">+#if defined(_M_IX86) || defined(_M_X64)
</a><a href="#h52-1-13" id="h52-1-13" class="i">+  // x86 and x64 CPUs have a strong memory model that prohibits most types of
</a><a href="#h52-1-14" id="h52-1-14" class="i">+  // reordering, so a non-instruction intrinsic to suppress compiler reordering
</a><a href="#h52-1-15" id="h52-1-15" class="i">+  // is sufficient. _WriteBarrier is deprecated, but is still appropriate for
</a><a href="#h52-1-16" id="h52-1-16" class="i">+  // the &quot;old compiler&quot; path (pre C++11).
</a><a href="#h52-1-17" id="h52-1-17" class="i">+  _WriteBarrier();
</a><a href="#h52-1-18" id="h52-1-18" class="i">+#else
</a>   LONG x;
   ::InterlockedExchange(&amp;x, 0);
<a href="#h52-1-21" id="h52-1-21" class="i">+#endif
</a> }
 
 #elif defined(OS_NACL)
 
<a href="#h52-1-26" id="h52-1-26" class="d">-// Native Client
</a><a href="#h52-1-27" id="h52-1-27" class="d">-inline void WriteMemoryBarrier() {
</a><a href="#h52-1-28" id="h52-1-28" class="i">+static inline void WriteMemoryBarrier() {
</a>   __sync_synchronize();
 }
 
 #elif defined(__mips__)
 
<a href="#h52-1-34" id="h52-1-34" class="d">-inline void WriteMemoryBarrier() {
</a><a href="#h52-1-35" id="h52-1-35" class="i">+static inline void WriteMemoryBarrier() {
</a>   __asm__ __volatile__(&quot;sync&quot; : : : &quot;memory&quot;);
 }
 
<a href="#h52-2" id="h52-2" class="h">@@ -113,16 +122,6 @@ static inline void WriteMemoryBarrier() {
</a>   re2::MutexLock l(&amp;mu);
 }
 
<a href="#h52-2-3" id="h52-2-3" class="d">-/*
</a><a href="#h52-2-4" id="h52-2-4" class="d">-#error Need WriteMemoryBarrier for architecture.
</a><a href="#h52-2-5" id="h52-2-5" class="d">-
</a><a href="#h52-2-6" id="h52-2-6" class="d">-// Windows
</a><a href="#h52-2-7" id="h52-2-7" class="d">-inline void WriteMemoryBarrier() {
</a><a href="#h52-2-8" id="h52-2-8" class="d">-  LONG x;
</a><a href="#h52-2-9" id="h52-2-9" class="d">-  ::InterlockedExchange(&amp;x, 0);
</a><a href="#h52-2-10" id="h52-2-10" class="d">-}
</a><a href="#h52-2-11" id="h52-2-11" class="d">-*/
</a><a href="#h52-2-12" id="h52-2-12" class="d">-
</a> #endif
 
 // Alpha has very weak memory ordering. If relying on WriteBarriers, one must
<a href="#h52-3" id="h52-3" class="h">@@ -141,7 +140,13 @@ static inline void MaybeReadMemoryBarrier() {}
</a> 
 // Read barrier for various targets.
 
<a href="#h52-3-3" id="h52-3-3" class="d">-#if defined(__aarch64__)
</a><a href="#h52-3-4" id="h52-3-4" class="i">+#if defined(__ppc__) || defined(__powerpc64__)
</a><a href="#h52-3-5" id="h52-3-5" class="i">+
</a><a href="#h52-3-6" id="h52-3-6" class="i">+static inline void ReadMemoryBarrier() {
</a><a href="#h52-3-7" id="h52-3-7" class="i">+  __asm__ __volatile__(&quot;lwsync&quot; : : : &quot;memory&quot;);
</a><a href="#h52-3-8" id="h52-3-8" class="i">+}
</a><a href="#h52-3-9" id="h52-3-9" class="i">+
</a><a href="#h52-3-10" id="h52-3-10" class="i">+#elif defined(__aarch64__)
</a> 
 static inline void ReadMemoryBarrier() {
   __asm__ __volatile__(&quot;dmb ld&quot; : : : &quot;memory&quot;);
<a href="#h52-4" id="h52-4" class="h">@@ -155,7 +160,7 @@ static inline void ReadMemoryBarrier() {
</a> 
 #elif defined(__mips__)
 
<a href="#h52-4-3" id="h52-4-3" class="d">-inline void ReadMemoryBarrier() {
</a><a href="#h52-4-4" id="h52-4-4" class="i">+static inline void ReadMemoryBarrier() {
</a>   __asm__ __volatile__(&quot;sync&quot; : : : &quot;memory&quot;);
 }
 
<b>diff --git a/<a id="h53" href="../file/src/vendor/re2/util/benchmark.cc">src/vendor/re2/util/benchmark.cc</a> b/<a href="../file/src/vendor/re2/util/benchmark.cc">src/vendor/re2/util/benchmark.cc</a></b>
<a href="#h53-0" id="h53-0" class="h">@@ -25,10 +25,29 @@ void Benchmark::Register() {
</a> }
 
 static int64 nsec() {
<a href="#h53-0-3" id="h53-0-3" class="i">+#if defined(__APPLE__)
</a> 	struct timeval tv;
 	if(gettimeofday(&amp;tv, 0) &lt; 0)
 		return -1;
 	return (int64)tv.tv_sec*1000*1000*1000 + tv.tv_usec*1000;
<a href="#h53-0-8" id="h53-0-8" class="i">+#elif defined(_WIN32)
</a><a href="#h53-0-9" id="h53-0-9" class="i">+	// https://msdn.microsoft.com/en-us/library/windows/desktop/dn553408.aspx
</a><a href="#h53-0-10" id="h53-0-10" class="i">+	// describes how to query ticks and convert to microseconds. Of course,
</a><a href="#h53-0-11" id="h53-0-11" class="i">+	// what we want in this case are nanoseconds. Also, note that .QuadPart
</a><a href="#h53-0-12" id="h53-0-12" class="i">+	// is a signed 64-bit integer, so casting to int64 shouldn&#39;t be needed.
</a><a href="#h53-0-13" id="h53-0-13" class="i">+	LARGE_INTEGER freq;
</a><a href="#h53-0-14" id="h53-0-14" class="i">+	QueryPerformanceFrequency(&amp;freq);
</a><a href="#h53-0-15" id="h53-0-15" class="i">+	LARGE_INTEGER ticks;
</a><a href="#h53-0-16" id="h53-0-16" class="i">+	QueryPerformanceCounter(&amp;ticks);
</a><a href="#h53-0-17" id="h53-0-17" class="i">+	ticks.QuadPart *= 1000*1000*1000;
</a><a href="#h53-0-18" id="h53-0-18" class="i">+	ticks.QuadPart /= freq.QuadPart;
</a><a href="#h53-0-19" id="h53-0-19" class="i">+	return ticks.QuadPart;
</a><a href="#h53-0-20" id="h53-0-20" class="i">+#else
</a><a href="#h53-0-21" id="h53-0-21" class="i">+	struct timespec tp;
</a><a href="#h53-0-22" id="h53-0-22" class="i">+	if(clock_gettime(CLOCK_REALTIME, &amp;tp) &lt; 0)
</a><a href="#h53-0-23" id="h53-0-23" class="i">+		return -1;
</a><a href="#h53-0-24" id="h53-0-24" class="i">+	return (int64)tp.tv_sec*1000*1000*1000 + tp.tv_nsec;
</a><a href="#h53-0-25" id="h53-0-25" class="i">+#endif
</a> }
 
 static int64 bytes;
<a href="#h53-1" id="h53-1" class="h">@@ -105,9 +124,9 @@ void RunBench(Benchmark* b, int nthread, int siz) {
</a> 	while(ns &lt; (int)1e9 &amp;&amp; n &lt; (int)1e9) {
 		last = n;
 		if(ns/n == 0)
<a href="#h53-1-3" id="h53-1-3" class="d">-			n = 1e9;
</a><a href="#h53-1-4" id="h53-1-4" class="i">+			n = (int)1e9;
</a> 		else
<a href="#h53-1-6" id="h53-1-6" class="d">-			n = 1e9 / (ns/n);
</a><a href="#h53-1-7" id="h53-1-7" class="i">+			n = (int)1e9 / (ns/n);
</a> 		
 		n = max(last+1, min(n+n/2, 100*last));
 		n = round(n);
<b>diff --git a/<a id="h54" href="../file/src/vendor/re2/util/flags.h">src/vendor/re2/util/flags.h</a> b/<a href="../file/src/vendor/re2/util/flags.h">src/vendor/re2/util/flags.h</a></b>
<a href="#h54-0" id="h54-0" class="h">@@ -5,7 +5,7 @@
</a> // Simplified version of Google&#39;s command line flags.
 // Does not support parsing the command line.
 // If you want to do that, see
<a href="#h54-0-3" id="h54-0-3" class="d">-// http://code.google.com/p/google-gflags
</a><a href="#h54-0-4" id="h54-0-4" class="i">+// https://gflags.github.io/gflags/
</a> 
 #ifndef RE2_UTIL_FLAGS_H__
 #define RE2_UTIL_FLAGS_H__
<b>diff --git a/<a id="h55" href="../file/src/vendor/re2/util/logging.cc">src/vendor/re2/util/logging.cc</a> b/<a href="../file/src/vendor/re2/util/logging.cc">src/vendor/re2/util/logging.cc</a></b>
<a href="#h55-0" id="h55-0" class="h">@@ -0,0 +1,9 @@
</a><a href="#h55-0-0" id="h55-0-0" class="i">+// Copyright 2015 The RE2 Authors.  All Rights Reserved.
</a><a href="#h55-0-1" id="h55-0-1" class="i">+// Use of this source code is governed by a BSD-style
</a><a href="#h55-0-2" id="h55-0-2" class="i">+// license that can be found in the LICENSE file.
</a><a href="#h55-0-3" id="h55-0-3" class="i">+
</a><a href="#h55-0-4" id="h55-0-4" class="i">+#include &quot;util/logging.h&quot;
</a><a href="#h55-0-5" id="h55-0-5" class="i">+
</a><a href="#h55-0-6" id="h55-0-6" class="i">+DEFINE_int32(minloglevel, 0,  // INFO
</a><a href="#h55-0-7" id="h55-0-7" class="i">+             &quot;Messages logged at a lower level than this don&#39;t actually get &quot;
</a><a href="#h55-0-8" id="h55-0-8" class="i">+             &quot;logged anywhere&quot;);
</a><b>diff --git a/<a id="h56" href="../file/src/vendor/re2/util/logging.h">src/vendor/re2/util/logging.h</a> b/<a href="../file/src/vendor/re2/util/logging.h">src/vendor/re2/util/logging.h</a></b>
<a href="#h56-0" id="h56-0" class="h">@@ -7,9 +7,14 @@
</a> #ifndef RE2_UTIL_LOGGING_H__
 #define RE2_UTIL_LOGGING_H__
 
<a href="#h56-0-3" id="h56-0-3" class="d">-#include &lt;unistd.h&gt;  /* for write */
</a><a href="#h56-0-4" id="h56-0-4" class="i">+#include &lt;stdio.h&gt;  /* for fwrite */
</a> #include &lt;sstream&gt;
 
<a href="#h56-0-7" id="h56-0-7" class="i">+#include &quot;util/util.h&quot;
</a><a href="#h56-0-8" id="h56-0-8" class="i">+#include &quot;util/flags.h&quot;
</a><a href="#h56-0-9" id="h56-0-9" class="i">+
</a><a href="#h56-0-10" id="h56-0-10" class="i">+DECLARE_int32(minloglevel);
</a><a href="#h56-0-11" id="h56-0-11" class="i">+
</a> // Debug-only checking.
 #define DCHECK(condition) assert(condition)
 #define DCHECK_EQ(val1, val2) assert((val1) == (val2))
<a href="#h56-1" id="h56-1" class="h">@@ -28,13 +33,16 @@
</a> #define CHECK_EQ(x, y)	CHECK((x) == (y))
 #define CHECK_NE(x, y)	CHECK((x) != (y))
 
<a href="#h56-1-3" id="h56-1-3" class="d">-#define LOG_INFO LogMessage(__FILE__, __LINE__)
</a><a href="#h56-1-4" id="h56-1-4" class="d">-#define LOG_ERROR LOG_INFO
</a><a href="#h56-1-5" id="h56-1-5" class="d">-#define LOG_WARNING LOG_INFO
</a><a href="#h56-1-6" id="h56-1-6" class="i">+#define LOG_INFO LogMessage(__FILE__, __LINE__, 0)
</a><a href="#h56-1-7" id="h56-1-7" class="i">+#define LOG_WARNING LogMessage(__FILE__, __LINE__, 1)
</a><a href="#h56-1-8" id="h56-1-8" class="i">+#define LOG_ERROR LogMessage(__FILE__, __LINE__, 2)
</a> #define LOG_FATAL LogMessageFatal(__FILE__, __LINE__)
 #define LOG_QFATAL LOG_FATAL
 
<a href="#h56-1-12" id="h56-1-12" class="d">-#define VLOG(x) if((x)&gt;0){}else LOG_INFO.stream()
</a><a href="#h56-1-13" id="h56-1-13" class="i">+// It seems that one of the Windows header files defines ERROR as 0.
</a><a href="#h56-1-14" id="h56-1-14" class="i">+#ifdef _WIN32
</a><a href="#h56-1-15" id="h56-1-15" class="i">+#define LOG_0 LOG_INFO
</a><a href="#h56-1-16" id="h56-1-16" class="i">+#endif
</a> 
 #ifdef NDEBUG
 #define DEBUG_MODE 0
<a href="#h56-2" id="h56-2" class="h">@@ -46,16 +54,21 @@
</a> 
 #define LOG(severity) LOG_ ## severity.stream()
 
<a href="#h56-2-3" id="h56-2-3" class="i">+#define VLOG(x) if((x)&gt;0){}else LOG_INFO.stream()
</a><a href="#h56-2-4" id="h56-2-4" class="i">+
</a> class LogMessage {
  public:
<a href="#h56-2-7" id="h56-2-7" class="d">-  LogMessage(const char* file, int line) : flushed_(false) {
</a><a href="#h56-2-8" id="h56-2-8" class="i">+  LogMessage(const char* file, int line, int severity)
</a><a href="#h56-2-9" id="h56-2-9" class="i">+      : severity_(severity), flushed_(false) {
</a>     stream() &lt;&lt; file &lt;&lt; &quot;:&quot; &lt;&lt; line &lt;&lt; &quot;: &quot;;
   }
   void Flush() {
     stream() &lt;&lt; &quot;\n&quot;;
<a href="#h56-2-14" id="h56-2-14" class="d">-    string s = str_.str();
</a><a href="#h56-2-15" id="h56-2-15" class="d">-    int n = (int)s.size(); // shut up msvc
</a><a href="#h56-2-16" id="h56-2-16" class="d">-    if(write(2, s.data(), n) &lt; 0) {}  // shut up gcc
</a><a href="#h56-2-17" id="h56-2-17" class="i">+    if (severity_ &gt;= re2::FLAGS_minloglevel) {
</a><a href="#h56-2-18" id="h56-2-18" class="i">+      string s = str_.str();
</a><a href="#h56-2-19" id="h56-2-19" class="i">+      size_t n = s.size();
</a><a href="#h56-2-20" id="h56-2-20" class="i">+      if (fwrite(s.data(), 1, n, stderr) &lt; n) {}  // shut up gcc
</a><a href="#h56-2-21" id="h56-2-21" class="i">+    }
</a>     flushed_ = true;
   }
   ~LogMessage() {
<a href="#h56-3" id="h56-3" class="h">@@ -64,17 +77,23 @@ class LogMessage {
</a>     }
   }
   ostream&amp; stream() { return str_; }
<a href="#h56-3-3" id="h56-3-3" class="d">- 
</a><a href="#h56-3-4" id="h56-3-4" class="i">+
</a>  private:
<a href="#h56-3-6" id="h56-3-6" class="i">+  const int severity_;
</a>   bool flushed_;
   std::ostringstream str_;
   DISALLOW_COPY_AND_ASSIGN(LogMessage);
 };
 
<a href="#h56-3-12" id="h56-3-12" class="i">+#ifdef _WIN32
</a><a href="#h56-3-13" id="h56-3-13" class="i">+#pragma warning(push)
</a><a href="#h56-3-14" id="h56-3-14" class="i">+#pragma warning(disable: 4722) // destructor never returns
</a><a href="#h56-3-15" id="h56-3-15" class="i">+#endif
</a><a href="#h56-3-16" id="h56-3-16" class="i">+
</a> class LogMessageFatal : public LogMessage {
  public:
   LogMessageFatal(const char* file, int line)
<a href="#h56-3-20" id="h56-3-20" class="d">-    : LogMessage(file, line) { }
</a><a href="#h56-3-21" id="h56-3-21" class="i">+      : LogMessage(file, line, 3) {}
</a>   ~LogMessageFatal() {
     Flush();
     abort();
<a href="#h56-4" id="h56-4" class="h">@@ -83,4 +102,8 @@ class LogMessageFatal : public LogMessage {
</a>   DISALLOW_COPY_AND_ASSIGN(LogMessageFatal);
 };
 
<a href="#h56-4-3" id="h56-4-3" class="i">+#ifdef _WIN32
</a><a href="#h56-4-4" id="h56-4-4" class="i">+#pragma warning(pop)
</a><a href="#h56-4-5" id="h56-4-5" class="i">+#endif
</a><a href="#h56-4-6" id="h56-4-6" class="i">+
</a> #endif  // RE2_UTIL_LOGGING_H__
<b>diff --git a/<a id="h57" href="../file/src/vendor/re2/util/mutex.h">src/vendor/re2/util/mutex.h</a> b/<a href="../file/src/vendor/re2/util/mutex.h">src/vendor/re2/util/mutex.h</a></b>
<a href="#h57-0" id="h57-0" class="h">@@ -12,17 +12,38 @@
</a> 
 #include &lt;stdlib.h&gt;
 
<a href="#h57-0-3" id="h57-0-3" class="i">+#if !defined(_WIN32)
</a><a href="#h57-0-4" id="h57-0-4" class="i">+#include &lt;unistd.h&gt;  // For POSIX options
</a><a href="#h57-0-5" id="h57-0-5" class="i">+#endif
</a><a href="#h57-0-6" id="h57-0-6" class="i">+
</a> namespace re2 {
 
<a href="#h57-0-9" id="h57-0-9" class="d">-#define HAVE_PTHREAD 1
</a><a href="#h57-0-10" id="h57-0-10" class="d">-#define HAVE_RWLOCK 1
</a><a href="#h57-0-11" id="h57-0-11" class="i">+#if !defined(_WIN32)
</a><a href="#h57-0-12" id="h57-0-12" class="i">+  // Possible values of POSIX options:
</a><a href="#h57-0-13" id="h57-0-13" class="i">+  //   -1 means not supported,
</a><a href="#h57-0-14" id="h57-0-14" class="i">+  //    0 means maybe supported (query at runtime),
</a><a href="#h57-0-15" id="h57-0-15" class="i">+  //   &gt;0 means supported.
</a><a href="#h57-0-16" id="h57-0-16" class="i">+# if defined(_POSIX_THREADS) &amp;&amp; _POSIX_THREADS &gt; 0
</a><a href="#h57-0-17" id="h57-0-17" class="i">+#   define HAVE_PTHREAD 1
</a><a href="#h57-0-18" id="h57-0-18" class="i">+# else
</a><a href="#h57-0-19" id="h57-0-19" class="i">+#   define HAVE_PTHREAD 0
</a><a href="#h57-0-20" id="h57-0-20" class="i">+# endif
</a><a href="#h57-0-21" id="h57-0-21" class="i">+# if defined(_POSIX_READER_WRITER_LOCKS) &amp;&amp; _POSIX_READER_WRITER_LOCKS &gt; 0
</a><a href="#h57-0-22" id="h57-0-22" class="i">+#   define HAVE_RWLOCK 1
</a><a href="#h57-0-23" id="h57-0-23" class="i">+# else
</a><a href="#h57-0-24" id="h57-0-24" class="i">+#   define HAVE_RWLOCK 0
</a><a href="#h57-0-25" id="h57-0-25" class="i">+# endif
</a><a href="#h57-0-26" id="h57-0-26" class="i">+#else
</a><a href="#h57-0-27" id="h57-0-27" class="i">+# define HAVE_PTHREAD 0
</a><a href="#h57-0-28" id="h57-0-28" class="i">+# define HAVE_RWLOCK 0
</a><a href="#h57-0-29" id="h57-0-29" class="i">+#endif
</a> 
 #if defined(NO_THREADS)
   typedef int MutexType;      // to keep a lock-count
<a href="#h57-0-33" id="h57-0-33" class="d">-#elif defined(HAVE_PTHREAD) &amp;&amp; defined(HAVE_RWLOCK)
</a><a href="#h57-0-34" id="h57-0-34" class="i">+#elif HAVE_PTHREAD &amp;&amp; HAVE_RWLOCK
</a>   // Needed for pthread_rwlock_*.  If it causes problems, you could take it
<a href="#h57-0-36" id="h57-0-36" class="d">-  // out, but then you&#39;d have to unset HAVE_RWLOCK (at least on linux -- it
</a><a href="#h57-0-37" id="h57-0-37" class="d">-  // *does* cause problems for FreeBSD, or MacOSX, but isn&#39;t needed
</a><a href="#h57-0-38" id="h57-0-38" class="i">+  // out, but then you&#39;d have to set HAVE_RWLOCK to 0 (at least on linux --
</a><a href="#h57-0-39" id="h57-0-39" class="i">+  // it *does* cause problems for FreeBSD, or MacOSX, but isn&#39;t needed
</a>   // for locking there.)
 # ifdef __linux__
 #   undef _XOPEN_SOURCE
<a href="#h57-1" id="h57-1" class="h">@@ -30,10 +51,10 @@ namespace re2 {
</a> # endif
 # include &lt;pthread.h&gt;
   typedef pthread_rwlock_t MutexType;
<a href="#h57-1-3" id="h57-1-3" class="d">-#elif defined(HAVE_PTHREAD)
</a><a href="#h57-1-4" id="h57-1-4" class="i">+#elif HAVE_PTHREAD
</a> # include &lt;pthread.h&gt;
   typedef pthread_mutex_t MutexType;
<a href="#h57-1-7" id="h57-1-7" class="d">-#elif defined(WIN32)
</a><a href="#h57-1-8" id="h57-1-8" class="i">+#elif defined(_WIN32)
</a> # define WIN32_LEAN_AND_MEAN  // We only need minimal includes
 # ifdef GMUTEX_TRYLOCK
   // We need Windows NT or later for TryEnterCriticalSection().  If you
<a href="#h57-2" id="h57-2" class="h">@@ -102,7 +123,7 @@ bool Mutex::TryLock()      { if (mutex_) return false; Lock(); return true; }
</a> void Mutex::ReaderLock()   { assert(++mutex_ &gt; 0); }
 void Mutex::ReaderUnlock() { assert(mutex_-- &gt; 0); }
 
<a href="#h57-2-3" id="h57-2-3" class="d">-#elif defined(HAVE_PTHREAD) &amp;&amp; defined(HAVE_RWLOCK)
</a><a href="#h57-2-4" id="h57-2-4" class="i">+#elif HAVE_PTHREAD &amp;&amp; HAVE_RWLOCK
</a> 
 #define SAFE_PTHREAD(fncall)  do { if ((fncall) != 0) abort(); } while (0)
 
<a href="#h57-3" id="h57-3" class="h">@@ -116,7 +137,7 @@ void Mutex::ReaderUnlock() { SAFE_PTHREAD(pthread_rwlock_unlock(&amp;mutex_)); }
</a> 
 #undef SAFE_PTHREAD
 
<a href="#h57-3-3" id="h57-3-3" class="d">-#elif defined(HAVE_PTHREAD)
</a><a href="#h57-3-4" id="h57-3-4" class="i">+#elif HAVE_PTHREAD
</a> 
 #define SAFE_PTHREAD(fncall)  do { if ((fncall) != 0) abort(); } while (0)
 
<a href="#h57-4" id="h57-4" class="h">@@ -129,7 +150,7 @@ void Mutex::ReaderLock()   { Lock(); }      // we don&#39;t have read-write locks
</a> void Mutex::ReaderUnlock() { Unlock(); }
 #undef SAFE_PTHREAD
 
<a href="#h57-4-3" id="h57-4-3" class="d">-#elif defined(WIN32)
</a><a href="#h57-4-4" id="h57-4-4" class="i">+#elif defined(_WIN32)
</a> 
 Mutex::Mutex()             { InitializeCriticalSection(&amp;mutex_); }
 Mutex::~Mutex()            { DeleteCriticalSection(&amp;mutex_); }
<a href="#h57-5" id="h57-5" class="h">@@ -186,7 +207,7 @@ class WriterMutexLock {
</a> #define WriterMutexLock(x) COMPILE_ASSERT(0, wmutex_lock_decl_missing_var_name)
 
 // Provide safe way to declare and use global, linker-initialized mutex. Sigh.
<a href="#h57-5-3" id="h57-5-3" class="d">-#ifdef HAVE_PTHREAD
</a><a href="#h57-5-4" id="h57-5-4" class="i">+#if HAVE_PTHREAD
</a> 
 #define GLOBAL_MUTEX(name) \
 	static pthread_mutex_t (name) = PTHREAD_MUTEX_INITIALIZER
<b>diff --git a/<a id="h58" href="../file/src/vendor/re2/util/pcre.cc">src/vendor/re2/util/pcre.cc</a> b/<a href="../file/src/vendor/re2/util/pcre.cc">src/vendor/re2/util/pcre.cc</a></b>
<a href="#h58-0" id="h58-0" class="h">@@ -7,6 +7,7 @@
</a> // compilation as PCRE in namespace re2.
 
 #include &lt;errno.h&gt;
<a href="#h58-0-3" id="h58-0-3" class="i">+#include &lt;limits&gt;
</a> #include &quot;util/util.h&quot;
 #include &quot;util/flags.h&quot;
 #include &quot;util/pcre.h&quot;
<a href="#h58-1" id="h58-1" class="h">@@ -22,6 +23,42 @@ DEFINE_int32(regexp_stack_limit, 256&lt;&lt;10, &quot;default PCRE stack limit (bytes)&quot;);
</a> DEFINE_int32(regexp_match_limit, 1000000,
              &quot;default PCRE match limit (function calls)&quot;);
 
<a href="#h58-1-3" id="h58-1-3" class="i">+#ifndef USEPCRE
</a><a href="#h58-1-4" id="h58-1-4" class="i">+
</a><a href="#h58-1-5" id="h58-1-5" class="i">+// Fake just enough of the PCRE API to allow this file to build. :)
</a><a href="#h58-1-6" id="h58-1-6" class="i">+
</a><a href="#h58-1-7" id="h58-1-7" class="i">+struct pcre_extra {
</a><a href="#h58-1-8" id="h58-1-8" class="i">+  int flags;
</a><a href="#h58-1-9" id="h58-1-9" class="i">+  int match_limit;
</a><a href="#h58-1-10" id="h58-1-10" class="i">+  int match_limit_recursion;
</a><a href="#h58-1-11" id="h58-1-11" class="i">+};
</a><a href="#h58-1-12" id="h58-1-12" class="i">+
</a><a href="#h58-1-13" id="h58-1-13" class="i">+#define PCRE_EXTRA_MATCH_LIMIT 0
</a><a href="#h58-1-14" id="h58-1-14" class="i">+#define PCRE_EXTRA_MATCH_LIMIT_RECURSION 0
</a><a href="#h58-1-15" id="h58-1-15" class="i">+#define PCRE_ANCHORED 0
</a><a href="#h58-1-16" id="h58-1-16" class="i">+#define PCRE_NOTEMPTY 0
</a><a href="#h58-1-17" id="h58-1-17" class="i">+#define PCRE_ERROR_NOMATCH 1
</a><a href="#h58-1-18" id="h58-1-18" class="i">+#define PCRE_ERROR_MATCHLIMIT 2
</a><a href="#h58-1-19" id="h58-1-19" class="i">+#define PCRE_ERROR_RECURSIONLIMIT 3
</a><a href="#h58-1-20" id="h58-1-20" class="i">+#define PCRE_INFO_CAPTURECOUNT 0
</a><a href="#h58-1-21" id="h58-1-21" class="i">+
</a><a href="#h58-1-22" id="h58-1-22" class="i">+void pcre_free(void*) {
</a><a href="#h58-1-23" id="h58-1-23" class="i">+}
</a><a href="#h58-1-24" id="h58-1-24" class="i">+
</a><a href="#h58-1-25" id="h58-1-25" class="i">+pcre* pcre_compile(const char*, int, const char**, int*, const unsigned char*) {
</a><a href="#h58-1-26" id="h58-1-26" class="i">+  return NULL;
</a><a href="#h58-1-27" id="h58-1-27" class="i">+}
</a><a href="#h58-1-28" id="h58-1-28" class="i">+
</a><a href="#h58-1-29" id="h58-1-29" class="i">+int pcre_exec(const pcre*, const pcre_extra*, const char*, int, int, int, int*, int) {
</a><a href="#h58-1-30" id="h58-1-30" class="i">+  return 0;
</a><a href="#h58-1-31" id="h58-1-31" class="i">+}
</a><a href="#h58-1-32" id="h58-1-32" class="i">+
</a><a href="#h58-1-33" id="h58-1-33" class="i">+int pcre_fullinfo(const pcre*, const pcre_extra*, int, void*) {
</a><a href="#h58-1-34" id="h58-1-34" class="i">+  return 0;
</a><a href="#h58-1-35" id="h58-1-35" class="i">+}
</a><a href="#h58-1-36" id="h58-1-36" class="i">+
</a><a href="#h58-1-37" id="h58-1-37" class="i">+#endif
</a><a href="#h58-1-38" id="h58-1-38" class="i">+
</a> namespace re2 {
 
 // Maximum number of args we can set
<a href="#h58-2" id="h58-2" class="h">@@ -113,7 +150,7 @@ pcre* PCRE::Compile(Anchor anchor) {
</a>   //    ANCHOR_BOTH     Tack a &quot;\z&quot; to the end of the original pattern
   //                    and use a pcre anchored match.
 
<a href="#h58-2-3" id="h58-2-3" class="d">-  const char* error;
</a><a href="#h58-2-4" id="h58-2-4" class="i">+  const char* error = &quot;&quot;;
</a>   int eoffset;
   pcre* re;
   if (anchor != ANCHOR_BOTH) {
<a href="#h58-3" id="h58-3" class="h">@@ -178,7 +215,7 @@ bool PCRE::FullMatchFunctor::operator ()(const StringPiece&amp; text,
</a> done:
 
   int consumed;
<a href="#h58-3-3" id="h58-3-3" class="d">-  int vec[kVecSize];
</a><a href="#h58-3-4" id="h58-3-4" class="i">+  int vec[kVecSize] = {};
</a>   return re.DoMatchImpl(text, ANCHOR_BOTH, &amp;consumed, args, n, vec, kVecSize);
 }
 
<a href="#h58-4" id="h58-4" class="h">@@ -221,7 +258,7 @@ bool PCRE::PartialMatchFunctor::operator ()(const StringPiece&amp; text,
</a> done:
 
   int consumed;
<a href="#h58-4-3" id="h58-4-3" class="d">-  int vec[kVecSize];
</a><a href="#h58-4-4" id="h58-4-4" class="i">+  int vec[kVecSize] = {};
</a>   return re.DoMatchImpl(text, UNANCHORED, &amp;consumed, args, n, vec, kVecSize);
 }
 
<a href="#h58-5" id="h58-5" class="h">@@ -264,7 +301,7 @@ bool PCRE::ConsumeFunctor::operator ()(StringPiece* input,
</a> done:
 
   int consumed;
<a href="#h58-5-3" id="h58-5-3" class="d">-  int vec[kVecSize];
</a><a href="#h58-5-4" id="h58-5-4" class="i">+  int vec[kVecSize] = {};
</a>   if (pattern.DoMatchImpl(*input, ANCHOR_START, &amp;consumed,
                           args, n, vec, kVecSize)) {
     input-&gt;remove_prefix(consumed);
<a href="#h58-6" id="h58-6" class="h">@@ -313,7 +350,7 @@ bool PCRE::FindAndConsumeFunctor::operator ()(StringPiece* input,
</a> done:
 
   int consumed;
<a href="#h58-6-3" id="h58-6-3" class="d">-  int vec[kVecSize];
</a><a href="#h58-6-4" id="h58-6-4" class="i">+  int vec[kVecSize] = {};
</a>   if (pattern.DoMatchImpl(*input, UNANCHORED, &amp;consumed,
                           args, n, vec, kVecSize)) {
     input-&gt;remove_prefix(consumed);
<a href="#h58-7" id="h58-7" class="h">@@ -326,7 +363,7 @@ done:
</a> bool PCRE::Replace(string *str,
                  const PCRE&amp; pattern,
                  const StringPiece&amp; rewrite) {
<a href="#h58-7-3" id="h58-7-3" class="d">-  int vec[kVecSize];
</a><a href="#h58-7-4" id="h58-7-4" class="i">+  int vec[kVecSize] = {};
</a>   int matches = pattern.TryMatch(*str, 0, UNANCHORED, true, vec, kVecSize);
   if (matches == 0)
     return false;
<a href="#h58-8" id="h58-8" class="h">@@ -345,12 +382,12 @@ int PCRE::GlobalReplace(string *str,
</a>                       const PCRE&amp; pattern,
                       const StringPiece&amp; rewrite) {
   int count = 0;
<a href="#h58-8-3" id="h58-8-3" class="d">-  int vec[kVecSize];
</a><a href="#h58-8-4" id="h58-8-4" class="i">+  int vec[kVecSize] = {};
</a>   string out;
<a href="#h58-8-6" id="h58-8-6" class="d">-  size_t start = 0;
</a><a href="#h58-8-7" id="h58-8-7" class="i">+  int start = 0;
</a>   bool last_match_was_empty_string = false;
 
<a href="#h58-8-10" id="h58-8-10" class="d">-  for (; start &lt;= str-&gt;length();) {
</a><a href="#h58-8-11" id="h58-8-11" class="i">+  while (start &lt;= static_cast&lt;int&gt;(str-&gt;size())) {
</a>     // If the previous match was for the empty string, we shouldn&#39;t
     // just match again: we&#39;ll match in the same way and get an
     // infinite loop.  Instead, we do the match in a special way:
<a href="#h58-9" id="h58-9" class="h">@@ -366,18 +403,19 @@ int PCRE::GlobalReplace(string *str,
</a>       matches = pattern.TryMatch(*str, start, ANCHOR_START, false,
                                  vec, kVecSize);
       if (matches &lt;= 0) {
<a href="#h58-9-3" id="h58-9-3" class="d">-        if (start &lt; str-&gt;length())
</a><a href="#h58-9-4" id="h58-9-4" class="i">+        if (start &lt; static_cast&lt;int&gt;(str-&gt;size()))
</a>           out.push_back((*str)[start]);
         start++;
         last_match_was_empty_string = false;
         continue;
       }
     } else {
<a href="#h58-9-11" id="h58-9-11" class="d">-      matches = pattern.TryMatch(*str, start, UNANCHORED, true, vec, kVecSize);
</a><a href="#h58-9-12" id="h58-9-12" class="i">+      matches = pattern.TryMatch(*str, start, UNANCHORED, true,
</a><a href="#h58-9-13" id="h58-9-13" class="i">+                                 vec, kVecSize);
</a>       if (matches &lt;= 0)
         break;
     }
<a href="#h58-9-17" id="h58-9-17" class="d">-    size_t matchstart = vec[0], matchend = vec[1];
</a><a href="#h58-9-18" id="h58-9-18" class="i">+    int matchstart = vec[0], matchend = vec[1];
</a>     assert(matchstart &gt;= start);
     assert(matchend &gt;= matchstart);
 
<a href="#h58-10" id="h58-10" class="h">@@ -391,8 +429,8 @@ int PCRE::GlobalReplace(string *str,
</a>   if (count == 0)
     return 0;
 
<a href="#h58-10-3" id="h58-10-3" class="d">-  if (start &lt; str-&gt;length())
</a><a href="#h58-10-4" id="h58-10-4" class="d">-    out.append(*str, start, str-&gt;length() - start);
</a><a href="#h58-10-5" id="h58-10-5" class="i">+  if (start &lt; static_cast&lt;int&gt;(str-&gt;size()))
</a><a href="#h58-10-6" id="h58-10-6" class="i">+    out.append(*str, start, static_cast&lt;int&gt;(str-&gt;size()) - start);
</a>   swap(out, *str);
   return count;
 }
<a href="#h58-11" id="h58-11" class="h">@@ -401,7 +439,7 @@ bool PCRE::Extract(const StringPiece &amp;text,
</a>                  const PCRE&amp; pattern,
                  const StringPiece &amp;rewrite,
                  string *out) {
<a href="#h58-11-3" id="h58-11-3" class="d">-  int vec[kVecSize];
</a><a href="#h58-11-4" id="h58-11-4" class="i">+  int vec[kVecSize] = {};
</a>   int matches = pattern.TryMatch(text, 0, UNANCHORED, true, vec, kVecSize);
   if (matches == 0)
     return false;
<a href="#h58-12" id="h58-12" class="h">@@ -595,9 +633,9 @@ bool PCRE::DoMatch(const StringPiece&amp; text,
</a>                  const Arg* const args[],
                  int n) const {
   assert(n &gt;= 0);
<a href="#h58-12-3" id="h58-12-3" class="d">-  size_t const vecsize = (1 + n) * 3;  // results + PCRE workspace
</a><a href="#h58-12-4" id="h58-12-4" class="d">-                                       // (as for kVecSize)
</a><a href="#h58-12-5" id="h58-12-5" class="d">-  int *vec = new int[vecsize];
</a><a href="#h58-12-6" id="h58-12-6" class="i">+  const int vecsize = (1 + n) * 3;  // results + PCRE workspace
</a><a href="#h58-12-7" id="h58-12-7" class="i">+                                    // (as for kVecSize)
</a><a href="#h58-12-8" id="h58-12-8" class="i">+  int* vec = new int[vecsize];
</a>   bool b = DoMatchImpl(text, anchor, consumed, args, n, vec, vecsize);
   delete[] vec;
   return b;
<a href="#h58-13" id="h58-13" class="h">@@ -803,7 +841,7 @@ bool PCRE::Arg::parse_short_radix(const char* str,
</a>   if (!parse_long_radix(str, n, &amp;r, radix)) return false; // Could not parse
   if ((short)r != r) return false;       // Out of range
   if (dest == NULL) return true;
<a href="#h58-13-3" id="h58-13-3" class="d">-  *(reinterpret_cast&lt;short*&gt;(dest)) = r;
</a><a href="#h58-13-4" id="h58-13-4" class="i">+  *(reinterpret_cast&lt;short*&gt;(dest)) = (short)r;
</a>   return true;
 }
 
<a href="#h58-14" id="h58-14" class="h">@@ -815,7 +853,7 @@ bool PCRE::Arg::parse_ushort_radix(const char* str,
</a>   if (!parse_ulong_radix(str, n, &amp;r, radix)) return false; // Could not parse
   if ((ushort)r != r) return false;                      // Out of range
   if (dest == NULL) return true;
<a href="#h58-14-3" id="h58-14-3" class="d">-  *(reinterpret_cast&lt;unsigned short*&gt;(dest)) = r;
</a><a href="#h58-14-4" id="h58-14-4" class="i">+  *(reinterpret_cast&lt;unsigned short*&gt;(dest)) = (ushort)r;
</a>   return true;
 }
 
<a href="#h58-15" id="h58-15" class="h">@@ -893,7 +931,7 @@ bool PCRE::Arg::parse_double(const char* str, int n, void* dest) {
</a>   char* end;
   double r = strtod(buf, &amp;end);
   if (end != buf + n) {
<a href="#h58-15-3" id="h58-15-3" class="d">-#ifdef COMPILER_MSVC
</a><a href="#h58-15-4" id="h58-15-4" class="i">+#ifdef _WIN32
</a>     // Microsoft&#39;s strtod() doesn&#39;t handle inf and nan, so we have to
     // handle it explicitly.  Speed is not important here because this
     // code is only called in unit tests.
<a href="#h58-16" id="h58-16" class="h">@@ -906,11 +944,11 @@ bool PCRE::Arg::parse_double(const char* str, int n, void* dest) {
</a>       ++i;
     }
     if (0 == stricmp(i, &quot;inf&quot;) || 0 == stricmp(i, &quot;infinity&quot;)) {
<a href="#h58-16-3" id="h58-16-3" class="d">-      r = numeric_limits&lt;double&gt;::infinity();
</a><a href="#h58-16-4" id="h58-16-4" class="i">+      r = std::numeric_limits&lt;double&gt;::infinity();
</a>       if (!pos)
         r = -r;
     } else if (0 == stricmp(i, &quot;nan&quot;)) {
<a href="#h58-16-8" id="h58-16-8" class="d">-      r = numeric_limits&lt;double&gt;::quiet_NaN();
</a><a href="#h58-16-9" id="h58-16-9" class="i">+      r = std::numeric_limits&lt;double&gt;::quiet_NaN();
</a>     } else {
       return false;
     }
<b>diff --git a/<a id="h59" href="../file/src/vendor/re2/util/pcre.h">src/vendor/re2/util/pcre.h</a> b/<a href="../file/src/vendor/re2/util/pcre.h">src/vendor/re2/util/pcre.h</a></b>
<a href="#h59-0" id="h59-0" class="h">@@ -167,22 +167,9 @@ namespace re2 {
</a> const bool UsingPCRE = true;
 }  // namespace re2
 #else
<a href="#h59-0-3" id="h59-0-3" class="i">+struct pcre;  // opaque
</a> namespace re2 {
 const bool UsingPCRE = false;
<a href="#h59-0-6" id="h59-0-6" class="d">-struct pcre;
</a><a href="#h59-0-7" id="h59-0-7" class="d">-struct pcre_extra { int flags, match_limit, match_limit_recursion; };
</a><a href="#h59-0-8" id="h59-0-8" class="d">-#define pcre_free(x) {}
</a><a href="#h59-0-9" id="h59-0-9" class="d">-#define PCRE_EXTRA_MATCH_LIMIT 0
</a><a href="#h59-0-10" id="h59-0-10" class="d">-#define PCRE_EXTRA_MATCH_LIMIT_RECURSION 0
</a><a href="#h59-0-11" id="h59-0-11" class="d">-#define PCRE_ANCHORED 0
</a><a href="#h59-0-12" id="h59-0-12" class="d">-#define PCRE_NOTEMPTY 0
</a><a href="#h59-0-13" id="h59-0-13" class="d">-#define PCRE_ERROR_NOMATCH 1
</a><a href="#h59-0-14" id="h59-0-14" class="d">-#define PCRE_ERROR_MATCHLIMIT 2
</a><a href="#h59-0-15" id="h59-0-15" class="d">-#define PCRE_ERROR_RECURSIONLIMIT 3
</a><a href="#h59-0-16" id="h59-0-16" class="d">-#define PCRE_INFO_CAPTURECOUNT 0
</a><a href="#h59-0-17" id="h59-0-17" class="d">-#define pcre_compile(a,b,c,d,e) ({ (void)(a); (void)(b); *(c)=&quot;&quot;; *(d)=0; (void)(e); ((pcre*)0); })
</a><a href="#h59-0-18" id="h59-0-18" class="d">-#define pcre_exec(a, b, c, d, e, f, g, h) ({ (void)(a); (void)(b); (void)(c); (void)(d); (void)(e); (void)(f); (void)(g); (void)(h); 0; })
</a><a href="#h59-0-19" id="h59-0-19" class="d">-#define pcre_fullinfo(a, b, c, d) ({ (void)(a); (void)(b); (void)(c); *(d) = 0; 0; })
</a> }  // namespace re2
 #endif
 
<b>diff --git a/<a id="h60" href="../file/src/vendor/re2/util/rune.cc">src/vendor/re2/util/rune.cc</a> b/<a href="../file/src/vendor/re2/util/rune.cc">src/vendor/re2/util/rune.cc</a></b>
<a href="#h60-0" id="h60-0" class="h">@@ -133,7 +133,7 @@ runetochar(char *str, const Rune *rune)
</a> 	 */
 	c = *rune;
 	if(c &lt;= Rune1) {
<a href="#h60-0-3" id="h60-0-3" class="d">-		str[0] = c;
</a><a href="#h60-0-4" id="h60-0-4" class="i">+		str[0] = static_cast&lt;char&gt;(c);
</a> 		return 1;
 	}
 
<a href="#h60-1" id="h60-1" class="h">@@ -142,7 +142,7 @@ runetochar(char *str, const Rune *rune)
</a> 	 *	0080-07FF =&gt; T2 Tx
 	 */
 	if(c &lt;= Rune2) {
<a href="#h60-1-3" id="h60-1-3" class="d">-		str[0] = T2 | (c &gt;&gt; 1*Bitx);
</a><a href="#h60-1-4" id="h60-1-4" class="i">+		str[0] = T2 | static_cast&lt;char&gt;(c &gt;&gt; 1*Bitx);
</a> 		str[1] = Tx | (c &amp; Maskx);
 		return 2;
 	}
<a href="#h60-2" id="h60-2" class="h">@@ -161,9 +161,9 @@ runetochar(char *str, const Rune *rune)
</a> 	 *	0800-FFFF =&gt; T3 Tx Tx
 	 */
 	if (c &lt;= Rune3) {
<a href="#h60-2-3" id="h60-2-3" class="d">-		str[0] = T3 |  (c &gt;&gt; 2*Bitx);
</a><a href="#h60-2-4" id="h60-2-4" class="i">+		str[0] = T3 | static_cast&lt;char&gt;(c &gt;&gt; 2*Bitx);
</a> 		str[1] = Tx | ((c &gt;&gt; 1*Bitx) &amp; Maskx);
<a href="#h60-2-6" id="h60-2-6" class="d">-		str[2] = Tx |  (c &amp; Maskx);
</a><a href="#h60-2-7" id="h60-2-7" class="i">+		str[2] = Tx | (c &amp; Maskx);
</a> 		return 3;
 	}
 
<a href="#h60-3" id="h60-3" class="h">@@ -171,7 +171,7 @@ runetochar(char *str, const Rune *rune)
</a> 	 * four character sequence (21-bit value)
 	 *     10000-1FFFFF =&gt; T4 Tx Tx Tx
 	 */
<a href="#h60-3-3" id="h60-3-3" class="d">-	str[0] = T4 | (c &gt;&gt; 3*Bitx);
</a><a href="#h60-3-4" id="h60-3-4" class="i">+	str[0] = T4 | static_cast&lt;char&gt;(c &gt;&gt; 3*Bitx);
</a> 	str[1] = Tx | ((c &gt;&gt; 2*Bitx) &amp; Maskx);
 	str[2] = Tx | ((c &gt;&gt; 1*Bitx) &amp; Maskx);
 	str[3] = Tx | (c &amp; Maskx);
<b>diff --git a/<a id="h61" href="../file/src/vendor/re2/util/sparse_array_test.cc">src/vendor/re2/util/sparse_array_test.cc</a> b/<a href="../file/src/vendor/re2/util/sparse_array_test.cc">src/vendor/re2/util/sparse_array_test.cc</a></b>
<a href="#h61-0" id="h61-0" class="h">@@ -1,150 +0,0 @@
</a><a href="#h61-0-0" id="h61-0-0" class="d">-// Copyright 2006 The RE2 Authors.  All Rights Reserved.
</a><a href="#h61-0-1" id="h61-0-1" class="d">-// Use of this source code is governed by a BSD-style
</a><a href="#h61-0-2" id="h61-0-2" class="d">-// license that can be found in the LICENSE file.
</a><a href="#h61-0-3" id="h61-0-3" class="d">-
</a><a href="#h61-0-4" id="h61-0-4" class="d">-// Simple tests that SparseArray behaves.
</a><a href="#h61-0-5" id="h61-0-5" class="d">-
</a><a href="#h61-0-6" id="h61-0-6" class="d">-#include &quot;util/util.h&quot;
</a><a href="#h61-0-7" id="h61-0-7" class="d">-#include &quot;utest/utest.h&quot;
</a><a href="#h61-0-8" id="h61-0-8" class="d">-
</a><a href="#h61-0-9" id="h61-0-9" class="d">-namespace re2 {
</a><a href="#h61-0-10" id="h61-0-10" class="d">-
</a><a href="#h61-0-11" id="h61-0-11" class="d">-static const string kNotFound = &quot;NOT FOUND&quot;;
</a><a href="#h61-0-12" id="h61-0-12" class="d">-
</a><a href="#h61-0-13" id="h61-0-13" class="d">-TEST(SparseArray, BasicOperations) {
</a><a href="#h61-0-14" id="h61-0-14" class="d">-  static const int n = 50;
</a><a href="#h61-0-15" id="h61-0-15" class="d">-  SparseArray&lt;int&gt; set(n);
</a><a href="#h61-0-16" id="h61-0-16" class="d">-
</a><a href="#h61-0-17" id="h61-0-17" class="d">-  int order[n];
</a><a href="#h61-0-18" id="h61-0-18" class="d">-  int value[n];
</a><a href="#h61-0-19" id="h61-0-19" class="d">-  for (int i = 0; i &lt; n; i++)
</a><a href="#h61-0-20" id="h61-0-20" class="d">-    order[i] = i;
</a><a href="#h61-0-21" id="h61-0-21" class="d">-  for (int i = 0; i &lt; n; i++)
</a><a href="#h61-0-22" id="h61-0-22" class="d">-    value[i] = rand()%1000 + 1;
</a><a href="#h61-0-23" id="h61-0-23" class="d">-  for (int i = 1; i &lt; n; i++) {
</a><a href="#h61-0-24" id="h61-0-24" class="d">-    int j = rand()%i;
</a><a href="#h61-0-25" id="h61-0-25" class="d">-    int t = order[i];
</a><a href="#h61-0-26" id="h61-0-26" class="d">-    order[i] = order[j];
</a><a href="#h61-0-27" id="h61-0-27" class="d">-    order[j] = t;
</a><a href="#h61-0-28" id="h61-0-28" class="d">-  }
</a><a href="#h61-0-29" id="h61-0-29" class="d">-
</a><a href="#h61-0-30" id="h61-0-30" class="d">-  for (int i = 0;; i++) {
</a><a href="#h61-0-31" id="h61-0-31" class="d">-    for (int j = 0; j &lt; i; j++) {
</a><a href="#h61-0-32" id="h61-0-32" class="d">-      ASSERT_TRUE(set.has_index(order[j]));
</a><a href="#h61-0-33" id="h61-0-33" class="d">-      ASSERT_EQ(value[order[j]], set.get(order[j], -1));
</a><a href="#h61-0-34" id="h61-0-34" class="d">-    }
</a><a href="#h61-0-35" id="h61-0-35" class="d">-    if (i &gt;= n)
</a><a href="#h61-0-36" id="h61-0-36" class="d">-      break;
</a><a href="#h61-0-37" id="h61-0-37" class="d">-    for (int j = i; j &lt; n; j++)
</a><a href="#h61-0-38" id="h61-0-38" class="d">-      ASSERT_FALSE(set.has_index(order[j]));
</a><a href="#h61-0-39" id="h61-0-39" class="d">-    set.set(order[i], value[order[i]]);
</a><a href="#h61-0-40" id="h61-0-40" class="d">-  }
</a><a href="#h61-0-41" id="h61-0-41" class="d">-
</a><a href="#h61-0-42" id="h61-0-42" class="d">-  int nn = 0;
</a><a href="#h61-0-43" id="h61-0-43" class="d">-  for (SparseArray&lt;int&gt;::iterator i = set.begin(); i != set.end(); ++i) {
</a><a href="#h61-0-44" id="h61-0-44" class="d">-    ASSERT_EQ(order[nn++], i-&gt;index());
</a><a href="#h61-0-45" id="h61-0-45" class="d">-    ASSERT_EQ(value[i-&gt;index()], i-&gt;value());
</a><a href="#h61-0-46" id="h61-0-46" class="d">-  }
</a><a href="#h61-0-47" id="h61-0-47" class="d">-  ASSERT_EQ(nn, n);
</a><a href="#h61-0-48" id="h61-0-48" class="d">-
</a><a href="#h61-0-49" id="h61-0-49" class="d">-  set.clear();
</a><a href="#h61-0-50" id="h61-0-50" class="d">-  for (int i = 0; i &lt; n; i++)
</a><a href="#h61-0-51" id="h61-0-51" class="d">-    ASSERT_FALSE(set.has_index(i));
</a><a href="#h61-0-52" id="h61-0-52" class="d">-
</a><a href="#h61-0-53" id="h61-0-53" class="d">-  ASSERT_EQ(0, set.size());
</a><a href="#h61-0-54" id="h61-0-54" class="d">-  ASSERT_EQ(0, distance(set.begin(), set.end()));
</a><a href="#h61-0-55" id="h61-0-55" class="d">-}
</a><a href="#h61-0-56" id="h61-0-56" class="d">-
</a><a href="#h61-0-57" id="h61-0-57" class="d">-class SparseArrayStringTest : public testing::Test {
</a><a href="#h61-0-58" id="h61-0-58" class="d">- protected:
</a><a href="#h61-0-59" id="h61-0-59" class="d">-  SparseArrayStringTest()
</a><a href="#h61-0-60" id="h61-0-60" class="d">-      : str_map_(10) {
</a><a href="#h61-0-61" id="h61-0-61" class="d">-    InsertOrUpdate(&amp;str_map_, 1, &quot;a&quot;);
</a><a href="#h61-0-62" id="h61-0-62" class="d">-    InsertOrUpdate(&amp;str_map_, 5, &quot;b&quot;);
</a><a href="#h61-0-63" id="h61-0-63" class="d">-    InsertOrUpdate(&amp;str_map_, 2, &quot;c&quot;);
</a><a href="#h61-0-64" id="h61-0-64" class="d">-    InsertOrUpdate(&amp;str_map_, 7, &quot;d&quot;);
</a><a href="#h61-0-65" id="h61-0-65" class="d">-  }
</a><a href="#h61-0-66" id="h61-0-66" class="d">-
</a><a href="#h61-0-67" id="h61-0-67" class="d">-  SparseArray&lt;string&gt; str_map_;
</a><a href="#h61-0-68" id="h61-0-68" class="d">-  typedef SparseArray&lt;string&gt;::iterator iterator;
</a><a href="#h61-0-69" id="h61-0-69" class="d">-};
</a><a href="#h61-0-70" id="h61-0-70" class="d">-
</a><a href="#h61-0-71" id="h61-0-71" class="d">-TEST_F(SparseArrayStringTest, FindGetsPresentElement) {
</a><a href="#h61-0-72" id="h61-0-72" class="d">-  iterator it = str_map_.find(2);
</a><a href="#h61-0-73" id="h61-0-73" class="d">-  ASSERT_TRUE(str_map_.end() != it);
</a><a href="#h61-0-74" id="h61-0-74" class="d">-  EXPECT_EQ(&quot;c&quot;, it-&gt;second);
</a><a href="#h61-0-75" id="h61-0-75" class="d">-}
</a><a href="#h61-0-76" id="h61-0-76" class="d">-
</a><a href="#h61-0-77" id="h61-0-77" class="d">-TEST_F(SparseArrayStringTest, FindDoesNotFindAbsentElement) {
</a><a href="#h61-0-78" id="h61-0-78" class="d">-  iterator it = str_map_.find(3);
</a><a href="#h61-0-79" id="h61-0-79" class="d">-  ASSERT_TRUE(str_map_.end() == it);
</a><a href="#h61-0-80" id="h61-0-80" class="d">-}
</a><a href="#h61-0-81" id="h61-0-81" class="d">-
</a><a href="#h61-0-82" id="h61-0-82" class="d">-TEST_F(SparseArrayStringTest, ContainsKey) {
</a><a href="#h61-0-83" id="h61-0-83" class="d">-  EXPECT_TRUE(ContainsKey(str_map_, 1));
</a><a href="#h61-0-84" id="h61-0-84" class="d">-  EXPECT_TRUE(ContainsKey(str_map_, 2));
</a><a href="#h61-0-85" id="h61-0-85" class="d">-  EXPECT_FALSE(ContainsKey(str_map_, 3));
</a><a href="#h61-0-86" id="h61-0-86" class="d">-}
</a><a href="#h61-0-87" id="h61-0-87" class="d">-
</a><a href="#h61-0-88" id="h61-0-88" class="d">-TEST_F(SparseArrayStringTest, InsertIfNotPresent) {
</a><a href="#h61-0-89" id="h61-0-89" class="d">-  EXPECT_FALSE(ContainsKey(str_map_, 3));
</a><a href="#h61-0-90" id="h61-0-90" class="d">-  EXPECT_TRUE(InsertIfNotPresent(&amp;str_map_, 3, &quot;r&quot;));
</a><a href="#h61-0-91" id="h61-0-91" class="d">-  EXPECT_EQ(&quot;r&quot;, FindWithDefault(str_map_, 3, kNotFound));
</a><a href="#h61-0-92" id="h61-0-92" class="d">-  EXPECT_FALSE(InsertIfNotPresent(&amp;str_map_, 3, &quot;other value&quot;));
</a><a href="#h61-0-93" id="h61-0-93" class="d">-  EXPECT_EQ(&quot;r&quot;, FindWithDefault(str_map_, 3, kNotFound));
</a><a href="#h61-0-94" id="h61-0-94" class="d">-}
</a><a href="#h61-0-95" id="h61-0-95" class="d">-
</a><a href="#h61-0-96" id="h61-0-96" class="d">-TEST(SparseArrayTest, Erase) {
</a><a href="#h61-0-97" id="h61-0-97" class="d">-  SparseArray&lt;string&gt; str_map(5);
</a><a href="#h61-0-98" id="h61-0-98" class="d">-  str_map.set(1, &quot;a&quot;);
</a><a href="#h61-0-99" id="h61-0-99" class="d">-  str_map.set(2, &quot;b&quot;);
</a><a href="#h61-0-100" id="h61-0-100" class="d">-  EXPECT_EQ(&quot;a&quot;, FindWithDefault(str_map, 1, kNotFound));
</a><a href="#h61-0-101" id="h61-0-101" class="d">-  EXPECT_EQ(&quot;b&quot;, FindWithDefault(str_map, 2, kNotFound));
</a><a href="#h61-0-102" id="h61-0-102" class="d">-  str_map.erase(1);
</a><a href="#h61-0-103" id="h61-0-103" class="d">-  EXPECT_EQ(&quot;NOT FOUND&quot;, FindWithDefault(str_map, 1, kNotFound));
</a><a href="#h61-0-104" id="h61-0-104" class="d">-  EXPECT_EQ(&quot;b&quot;, FindWithDefault(str_map, 2, kNotFound));
</a><a href="#h61-0-105" id="h61-0-105" class="d">-}
</a><a href="#h61-0-106" id="h61-0-106" class="d">-
</a><a href="#h61-0-107" id="h61-0-107" class="d">-typedef SparseArrayStringTest SparseArrayStringSurvivesInvalidIndexTest;
</a><a href="#h61-0-108" id="h61-0-108" class="d">-// TODO(jyasskin): Cover invalid arguments to every method.
</a><a href="#h61-0-109" id="h61-0-109" class="d">-
</a><a href="#h61-0-110" id="h61-0-110" class="d">-TEST_F(SparseArrayStringSurvivesInvalidIndexTest, SetNegative) {
</a><a href="#h61-0-111" id="h61-0-111" class="d">-  EXPECT_DEBUG_DEATH(str_map_.set(-123456789, &quot;hi&quot;),
</a><a href="#h61-0-112" id="h61-0-112" class="d">-                     &quot;\\(jyasskin\\) Illegal index -123456789 passed to&quot;
</a><a href="#h61-0-113" id="h61-0-113" class="d">-                     &quot; SparseArray\\(10\\).set\\(\\).&quot;);
</a><a href="#h61-0-114" id="h61-0-114" class="d">-  EXPECT_EQ(4, str_map_.size());
</a><a href="#h61-0-115" id="h61-0-115" class="d">-}
</a><a href="#h61-0-116" id="h61-0-116" class="d">-
</a><a href="#h61-0-117" id="h61-0-117" class="d">-TEST_F(SparseArrayStringSurvivesInvalidIndexTest, SetTooBig) {
</a><a href="#h61-0-118" id="h61-0-118" class="d">-  EXPECT_DEBUG_DEATH(str_map_.set(12345678, &quot;hi&quot;),
</a><a href="#h61-0-119" id="h61-0-119" class="d">-                     &quot;\\(jyasskin\\) Illegal index 12345678 passed to&quot;
</a><a href="#h61-0-120" id="h61-0-120" class="d">-                     &quot; SparseArray\\(10\\).set\\(\\).&quot;);
</a><a href="#h61-0-121" id="h61-0-121" class="d">-  EXPECT_EQ(4, str_map_.size());
</a><a href="#h61-0-122" id="h61-0-122" class="d">-}
</a><a href="#h61-0-123" id="h61-0-123" class="d">-
</a><a href="#h61-0-124" id="h61-0-124" class="d">-TEST_F(SparseArrayStringSurvivesInvalidIndexTest, SetNew_Negative) {
</a><a href="#h61-0-125" id="h61-0-125" class="d">-  EXPECT_DEBUG_DEATH(str_map_.set_new(-123456789, &quot;hi&quot;),
</a><a href="#h61-0-126" id="h61-0-126" class="d">-                     &quot;\\(jyasskin\\) Illegal index -123456789 passed to&quot;
</a><a href="#h61-0-127" id="h61-0-127" class="d">-                     &quot; SparseArray\\(10\\).set_new\\(\\).&quot;);
</a><a href="#h61-0-128" id="h61-0-128" class="d">-  EXPECT_EQ(4, str_map_.size());
</a><a href="#h61-0-129" id="h61-0-129" class="d">-}
</a><a href="#h61-0-130" id="h61-0-130" class="d">-
</a><a href="#h61-0-131" id="h61-0-131" class="d">-TEST_F(SparseArrayStringSurvivesInvalidIndexTest, SetNew_Existing) {
</a><a href="#h61-0-132" id="h61-0-132" class="d">-  EXPECT_DEBUG_DEATH({
</a><a href="#h61-0-133" id="h61-0-133" class="d">-    str_map_.set_new(2, &quot;hi&quot;);
</a><a href="#h61-0-134" id="h61-0-134" class="d">-    EXPECT_EQ(&quot;hi&quot;, FindWithDefault(str_map_, 2, kNotFound));
</a><a href="#h61-0-135" id="h61-0-135" class="d">-
</a><a href="#h61-0-136" id="h61-0-136" class="d">-    // The old value for 2 is still present, but can never be removed.
</a><a href="#h61-0-137" id="h61-0-137" class="d">-    // This risks crashing later, if the map fills up.
</a><a href="#h61-0-138" id="h61-0-138" class="d">-    EXPECT_EQ(5, str_map_.size());
</a><a href="#h61-0-139" id="h61-0-139" class="d">-  }, &quot;Check failed: !has_index\\(i\\)&quot;);
</a><a href="#h61-0-140" id="h61-0-140" class="d">-}
</a><a href="#h61-0-141" id="h61-0-141" class="d">-
</a><a href="#h61-0-142" id="h61-0-142" class="d">-TEST_F(SparseArrayStringSurvivesInvalidIndexTest, SetNew_TooBig) {
</a><a href="#h61-0-143" id="h61-0-143" class="d">-  EXPECT_DEBUG_DEATH(str_map_.set_new(12345678, &quot;hi&quot;),
</a><a href="#h61-0-144" id="h61-0-144" class="d">-                     &quot;\\(jyasskin\\) Illegal index 12345678 passed to&quot;
</a><a href="#h61-0-145" id="h61-0-145" class="d">-                     &quot; SparseArray\\(10\\).set_new\\(\\).&quot;);
</a><a href="#h61-0-146" id="h61-0-146" class="d">-  EXPECT_EQ(4, str_map_.size());
</a><a href="#h61-0-147" id="h61-0-147" class="d">-}
</a><a href="#h61-0-148" id="h61-0-148" class="d">-
</a><a href="#h61-0-149" id="h61-0-149" class="d">-}  // namespace re2
</a><b>diff --git a/<a id="h62" href="../file/src/vendor/re2/util/stringpiece.cc">src/vendor/re2/util/stringpiece.cc</a> b/<a href="../file/src/vendor/re2/util/stringpiece.cc">src/vendor/re2/util/stringpiece.cc</a></b>
<a href="#h62-0" id="h62-0" class="h">@@ -1,91 +0,0 @@
</a><a href="#h62-0-0" id="h62-0-0" class="d">-// Copyright 2004 The RE2 Authors.  All Rights Reserved.
</a><a href="#h62-0-1" id="h62-0-1" class="d">-// Use of this source code is governed by a BSD-style
</a><a href="#h62-0-2" id="h62-0-2" class="d">-// license that can be found in the LICENSE file.
</a><a href="#h62-0-3" id="h62-0-3" class="d">-
</a><a href="#h62-0-4" id="h62-0-4" class="d">-#include &quot;re2/stringpiece.h&quot;
</a><a href="#h62-0-5" id="h62-0-5" class="d">-#include &quot;util/util.h&quot;
</a><a href="#h62-0-6" id="h62-0-6" class="d">-
</a><a href="#h62-0-7" id="h62-0-7" class="d">-using re2::StringPiece;
</a><a href="#h62-0-8" id="h62-0-8" class="d">-
</a><a href="#h62-0-9" id="h62-0-9" class="d">-std::ostream&amp; operator&lt;&lt;(std::ostream&amp; o, const StringPiece&amp; piece) {
</a><a href="#h62-0-10" id="h62-0-10" class="d">-  o.write(piece.data(), piece.size());
</a><a href="#h62-0-11" id="h62-0-11" class="d">-  return o;
</a><a href="#h62-0-12" id="h62-0-12" class="d">-}
</a><a href="#h62-0-13" id="h62-0-13" class="d">-
</a><a href="#h62-0-14" id="h62-0-14" class="d">-bool StringPiece::_equal(const StringPiece&amp; x, const StringPiece&amp; y) {
</a><a href="#h62-0-15" id="h62-0-15" class="d">-  int len = x.size();
</a><a href="#h62-0-16" id="h62-0-16" class="d">-  if (len != y.size()) {
</a><a href="#h62-0-17" id="h62-0-17" class="d">-    return false;
</a><a href="#h62-0-18" id="h62-0-18" class="d">-  }
</a><a href="#h62-0-19" id="h62-0-19" class="d">-  const char* p = x.data();
</a><a href="#h62-0-20" id="h62-0-20" class="d">-  const char* p2 = y.data();
</a><a href="#h62-0-21" id="h62-0-21" class="d">-  // Test last byte in case strings share large common prefix
</a><a href="#h62-0-22" id="h62-0-22" class="d">-  if ((len &gt; 0) &amp;&amp; (p[len-1] != p2[len-1])) return false;
</a><a href="#h62-0-23" id="h62-0-23" class="d">-  const char* p_limit = p + len;
</a><a href="#h62-0-24" id="h62-0-24" class="d">-  for (; p &lt; p_limit; p++, p2++) {
</a><a href="#h62-0-25" id="h62-0-25" class="d">-    if (*p != *p2)
</a><a href="#h62-0-26" id="h62-0-26" class="d">-      return false;
</a><a href="#h62-0-27" id="h62-0-27" class="d">-  }
</a><a href="#h62-0-28" id="h62-0-28" class="d">-  return true;
</a><a href="#h62-0-29" id="h62-0-29" class="d">-}
</a><a href="#h62-0-30" id="h62-0-30" class="d">-
</a><a href="#h62-0-31" id="h62-0-31" class="d">-void StringPiece::CopyToString(string* target) const {
</a><a href="#h62-0-32" id="h62-0-32" class="d">-  target-&gt;assign(ptr_, length_);
</a><a href="#h62-0-33" id="h62-0-33" class="d">-}
</a><a href="#h62-0-34" id="h62-0-34" class="d">-
</a><a href="#h62-0-35" id="h62-0-35" class="d">-int StringPiece::copy(char* buf, size_type n, size_type pos) const {
</a><a href="#h62-0-36" id="h62-0-36" class="d">-  int ret = min(length_ - pos, n);
</a><a href="#h62-0-37" id="h62-0-37" class="d">-  memcpy(buf, ptr_ + pos, ret);
</a><a href="#h62-0-38" id="h62-0-38" class="d">-  return ret;
</a><a href="#h62-0-39" id="h62-0-39" class="d">-}
</a><a href="#h62-0-40" id="h62-0-40" class="d">-
</a><a href="#h62-0-41" id="h62-0-41" class="d">-bool StringPiece::contains(StringPiece s) const {
</a><a href="#h62-0-42" id="h62-0-42" class="d">-  return (size_t)find(s, 0) != npos;
</a><a href="#h62-0-43" id="h62-0-43" class="d">-}
</a><a href="#h62-0-44" id="h62-0-44" class="d">-
</a><a href="#h62-0-45" id="h62-0-45" class="d">-int StringPiece::find(const StringPiece&amp; s, size_type pos) const {
</a><a href="#h62-0-46" id="h62-0-46" class="d">-  if (length_ &lt; 0 || pos &gt; static_cast&lt;size_type&gt;(length_))
</a><a href="#h62-0-47" id="h62-0-47" class="d">-    return npos;
</a><a href="#h62-0-48" id="h62-0-48" class="d">-
</a><a href="#h62-0-49" id="h62-0-49" class="d">-  const char* result = std::search(ptr_ + pos, ptr_ + length_,
</a><a href="#h62-0-50" id="h62-0-50" class="d">-                                   s.ptr_, s.ptr_ + s.length_);
</a><a href="#h62-0-51" id="h62-0-51" class="d">-  const size_type xpos = result - ptr_;
</a><a href="#h62-0-52" id="h62-0-52" class="d">-  return xpos + s.length_ &lt;= static_cast&lt;size_type&gt;(length_) ? xpos : npos;
</a><a href="#h62-0-53" id="h62-0-53" class="d">-}
</a><a href="#h62-0-54" id="h62-0-54" class="d">-
</a><a href="#h62-0-55" id="h62-0-55" class="d">-int StringPiece::find(char c, size_type pos) const {
</a><a href="#h62-0-56" id="h62-0-56" class="d">-  if (length_ &lt;= 0 || pos &gt;= static_cast&lt;size_type&gt;(length_)) {
</a><a href="#h62-0-57" id="h62-0-57" class="d">-    return npos;
</a><a href="#h62-0-58" id="h62-0-58" class="d">-  }
</a><a href="#h62-0-59" id="h62-0-59" class="d">-  const char* result = std::find(ptr_ + pos, ptr_ + length_, c);
</a><a href="#h62-0-60" id="h62-0-60" class="d">-  return result != ptr_ + length_ ? result - ptr_ : npos;
</a><a href="#h62-0-61" id="h62-0-61" class="d">-}
</a><a href="#h62-0-62" id="h62-0-62" class="d">-
</a><a href="#h62-0-63" id="h62-0-63" class="d">-int StringPiece::rfind(const StringPiece&amp; s, size_type pos) const {
</a><a href="#h62-0-64" id="h62-0-64" class="d">-  if (length_ &lt; s.length_) return npos;
</a><a href="#h62-0-65" id="h62-0-65" class="d">-  const size_t ulen = length_;
</a><a href="#h62-0-66" id="h62-0-66" class="d">-  if (s.length_ == 0) return min(ulen, pos);
</a><a href="#h62-0-67" id="h62-0-67" class="d">-
</a><a href="#h62-0-68" id="h62-0-68" class="d">-  const char* last = ptr_ + min(ulen - s.length_, pos) + s.length_;
</a><a href="#h62-0-69" id="h62-0-69" class="d">-  const char* result = std::find_end(ptr_, last, s.ptr_, s.ptr_ + s.length_);
</a><a href="#h62-0-70" id="h62-0-70" class="d">-  return result != last ? result - ptr_ : npos;
</a><a href="#h62-0-71" id="h62-0-71" class="d">-}
</a><a href="#h62-0-72" id="h62-0-72" class="d">-
</a><a href="#h62-0-73" id="h62-0-73" class="d">-int StringPiece::rfind(char c, size_type pos) const {
</a><a href="#h62-0-74" id="h62-0-74" class="d">-  if (length_ &lt;= 0) return npos;
</a><a href="#h62-0-75" id="h62-0-75" class="d">-  for (int i = min(pos, static_cast&lt;size_type&gt;(length_ - 1));
</a><a href="#h62-0-76" id="h62-0-76" class="d">-       i &gt;= 0; --i) {
</a><a href="#h62-0-77" id="h62-0-77" class="d">-    if (ptr_[i] == c) {
</a><a href="#h62-0-78" id="h62-0-78" class="d">-      return i;
</a><a href="#h62-0-79" id="h62-0-79" class="d">-    }
</a><a href="#h62-0-80" id="h62-0-80" class="d">-  }
</a><a href="#h62-0-81" id="h62-0-81" class="d">-  return npos;
</a><a href="#h62-0-82" id="h62-0-82" class="d">-}
</a><a href="#h62-0-83" id="h62-0-83" class="d">-
</a><a href="#h62-0-84" id="h62-0-84" class="d">-StringPiece StringPiece::substr(size_type pos, size_type n) const {
</a><a href="#h62-0-85" id="h62-0-85" class="d">-  if (pos &gt; static_cast&lt;size_type&gt;(length_)) pos = static_cast&lt;size_type&gt;(length_);
</a><a href="#h62-0-86" id="h62-0-86" class="d">-  if (n &gt; length_ - pos) n = length_ - pos;
</a><a href="#h62-0-87" id="h62-0-87" class="d">-  return StringPiece(ptr_ + pos, n);
</a><a href="#h62-0-88" id="h62-0-88" class="d">-}
</a><a href="#h62-0-89" id="h62-0-89" class="d">-
</a><a href="#h62-0-90" id="h62-0-90" class="d">-const StringPiece::size_type StringPiece::npos = size_type(-1);
</a><b>diff --git a/<a id="h63" href="../file/src/vendor/re2/util/stringprintf.cc">src/vendor/re2/util/stringprintf.cc</a> b/<a href="../file/src/vendor/re2/util/stringprintf.cc">src/vendor/re2/util/stringprintf.cc</a></b>
<a href="#h63-0" id="h63-0" class="h">@@ -4,7 +4,7 @@
</a> 
 #include &quot;util/util.h&quot;
 
<a href="#h63-0-3" id="h63-0-3" class="d">-namespace re2 { 
</a><a href="#h63-0-4" id="h63-0-4" class="i">+namespace re2 {
</a> 
 static void StringAppendV(string* dst, const char* format, va_list ap) {
   // First try with a small fixed size buffer
<a href="#h63-1" id="h63-1" class="h">@@ -38,7 +38,14 @@ static void StringAppendV(string* dst, const char* format, va_list ap) {
</a> 
     // Restore the va_list before we use it again
     va_copy(backup_ap, ap);
<a href="#h63-1-3" id="h63-1-3" class="i">+#if !defined(_WIN32)
</a>     result = vsnprintf(buf, length, format, backup_ap);
<a href="#h63-1-5" id="h63-1-5" class="i">+#else
</a><a href="#h63-1-6" id="h63-1-6" class="i">+    // On Windows, the function takes five arguments, not four. With an array,
</a><a href="#h63-1-7" id="h63-1-7" class="i">+    // the buffer size will be inferred, but not with a pointer. C&#39;est la vie.
</a><a href="#h63-1-8" id="h63-1-8" class="i">+    // (See https://github.com/google/re2/issues/40 for more details.)
</a><a href="#h63-1-9" id="h63-1-9" class="i">+    result = vsnprintf(buf, length, _TRUNCATE, format, backup_ap);
</a><a href="#h63-1-10" id="h63-1-10" class="i">+#endif
</a>     va_end(backup_ap);
 
     if ((result &gt;= 0) &amp;&amp; (result &lt; length)) {
<b>diff --git a/<a id="h64" href="../file/src/vendor/re2/util/strutil.cc">src/vendor/re2/util/strutil.cc</a> b/<a href="../file/src/vendor/re2/util/strutil.cc">src/vendor/re2/util/strutil.cc</a></b>
<a href="#h64-0" id="h64-0" class="h">@@ -20,7 +20,7 @@ int CEscapeString(const char* src, int src_len, char* dest,
</a>   int used = 0;
 
   for (; src &lt; src_end; src++) {
<a href="#h64-0-3" id="h64-0-3" class="d">-    if (dest_len - used &lt; 2)   // Need space for two letter escape
</a><a href="#h64-0-4" id="h64-0-4" class="i">+    if (dest_len - used &lt; 2)   // space for two-character escape
</a>       return -1;
 
     unsigned char c = *src;
<a href="#h64-1" id="h64-1" class="h">@@ -36,9 +36,15 @@ int CEscapeString(const char* src, int src_len, char* dest,
</a>         // digit then that digit must be escaped too to prevent it being
         // interpreted as part of the character code by C.
         if (c &lt; &#39; &#39; || c &gt; &#39;~&#39;) {
<a href="#h64-1-3" id="h64-1-3" class="d">-          if (dest_len - used &lt; 4) // need space for 4 letter escape
</a><a href="#h64-1-4" id="h64-1-4" class="i">+          if (dest_len - used &lt; 5)   // space for four-character escape + \0
</a>             return -1;
<a href="#h64-1-6" id="h64-1-6" class="d">-          sprintf(dest + used, &quot;\\%03o&quot;, c);
</a><a href="#h64-1-7" id="h64-1-7" class="i">+#if !defined(_WIN32)
</a><a href="#h64-1-8" id="h64-1-8" class="i">+          snprintf(dest + used, 5, &quot;\\%03o&quot;, c);
</a><a href="#h64-1-9" id="h64-1-9" class="i">+#else
</a><a href="#h64-1-10" id="h64-1-10" class="i">+          // On Windows, the function takes 4+VA arguments, not 3+VA. With an
</a><a href="#h64-1-11" id="h64-1-11" class="i">+          // array, the buffer size will be inferred, but not with a pointer.
</a><a href="#h64-1-12" id="h64-1-12" class="i">+          snprintf(dest + used, 5, _TRUNCATE, &quot;\\%03o&quot;, c);
</a><a href="#h64-1-13" id="h64-1-13" class="i">+#endif
</a>           used += 4;
         } else {
           dest[used++] = c; break;
<a href="#h64-2" id="h64-2" class="h">@@ -57,7 +63,7 @@ int CEscapeString(const char* src, int src_len, char* dest,
</a> // ----------------------------------------------------------------------
 // CEscape()
 //    Copies &#39;src&#39; to result, escaping dangerous characters using
<a href="#h64-2-3" id="h64-2-3" class="d">-//    C-style escape sequences.  &#39;src&#39; and &#39;dest&#39; should not overlap. 
</a><a href="#h64-2-4" id="h64-2-4" class="i">+//    C-style escape sequences.  &#39;src&#39; and &#39;dest&#39; should not overlap.
</a> // ----------------------------------------------------------------------
 string CEscape(const StringPiece&amp; src) {
   const int dest_length = src.size() * 4 + 1; // Maximum possible expansion
<a href="#h64-3" id="h64-3" class="h">@@ -77,7 +83,7 @@ string PrefixSuccessor(const StringPiece&amp; prefix) {
</a>   // 255&#39;s, we just return the empty string.
   bool done = false;
   string limit(prefix.data(), prefix.size());
<a href="#h64-3-3" id="h64-3-3" class="d">-  int index = limit.length() - 1;
</a><a href="#h64-3-4" id="h64-3-4" class="i">+  int index = static_cast&lt;int&gt;(limit.size()) - 1;
</a>   while (!done &amp;&amp; index &gt;= 0) {
     if ((limit[index]&amp;255) == 255) {
       limit.erase(index);
<b>diff --git a/<a id="h65" href="../file/src/vendor/re2/util/test.cc">src/vendor/re2/util/test.cc</a> b/<a href="../file/src/vendor/re2/util/test.cc">src/vendor/re2/util/test.cc</a></b>
<a href="#h65-0" id="h65-0" class="h">@@ -3,7 +3,7 @@
</a> // license that can be found in the LICENSE file.
 
 #include &lt;stdio.h&gt;
<a href="#h65-0-3" id="h65-0-3" class="d">-#ifndef WIN32
</a><a href="#h65-0-4" id="h65-0-4" class="i">+#ifndef _WIN32
</a> #include &lt;sys/resource.h&gt;
 #endif
 #include &quot;util/test.h&quot;
<a href="#h65-1" id="h65-1" class="h">@@ -23,18 +23,6 @@ void RegisterTest(void (*fn)(void), const char *name) {
</a>   tests[ntests++].name = name;
 }
 
<a href="#h65-1-3" id="h65-1-3" class="d">-namespace re2 {
</a><a href="#h65-1-4" id="h65-1-4" class="d">-int64 VirtualProcessSize() {
</a><a href="#h65-1-5" id="h65-1-5" class="d">-#ifdef WIN32
</a><a href="#h65-1-6" id="h65-1-6" class="d">-  return 0;
</a><a href="#h65-1-7" id="h65-1-7" class="d">-#else
</a><a href="#h65-1-8" id="h65-1-8" class="d">-  struct rusage ru;
</a><a href="#h65-1-9" id="h65-1-9" class="d">-  getrusage(RUSAGE_SELF, &amp;ru);
</a><a href="#h65-1-10" id="h65-1-10" class="d">-  return (int64)ru.ru_maxrss*1024;
</a><a href="#h65-1-11" id="h65-1-11" class="d">-#endif
</a><a href="#h65-1-12" id="h65-1-12" class="d">-}
</a><a href="#h65-1-13" id="h65-1-13" class="d">-}  // namespace re2
</a><a href="#h65-1-14" id="h65-1-14" class="d">-
</a> int main(int argc, char **argv) {
   for (int i = 0; i &lt; ntests; i++) {
     printf(&quot;%s\n&quot;, tests[i].name);
<b>diff --git a/<a id="h66" href="../file/src/vendor/re2/util/test.h">src/vendor/re2/util/test.h</a> b/<a href="../file/src/vendor/re2/util/test.h">src/vendor/re2/util/test.h</a></b>
<a href="#h66-0" id="h66-0" class="h">@@ -31,25 +31,15 @@ class TestRegisterer {
</a> #define EXPECT_GE CHECK_GE
 #define EXPECT_FALSE(x) CHECK(!(x))
 
<a href="#h66-0-3" id="h66-0-3" class="d">-#define EXPECT_TRUE_M(x, y) CHECK(x) &lt;&lt; (y)
</a><a href="#h66-0-4" id="h66-0-4" class="d">-#define EXPECT_FALSE_M(x, y) CHECK(!(x)) &lt;&lt; (y)
</a><a href="#h66-0-5" id="h66-0-5" class="d">-#define ASSERT_TRUE_M(x, y) CHECK(x) &lt;&lt; (y)
</a><a href="#h66-0-6" id="h66-0-6" class="d">-#define ASSERT_EQUALS(x, y) CHECK_EQ(x, y)
</a><a href="#h66-0-7" id="h66-0-7" class="d">-
</a><a href="#h66-0-8" id="h66-0-8" class="d">-const bool UsingMallocCounter = false;
</a> namespace testing {
 class MallocCounter {
  public:
<a href="#h66-0-12" id="h66-0-12" class="d">-  MallocCounter(int x) { } 
</a><a href="#h66-0-13" id="h66-0-13" class="i">+  MallocCounter(int x) {}
</a>   static const int THIS_THREAD_ONLY = 0;
   long long HeapGrowth() { return 0; }
   long long PeakHeapGrowth() { return 0; }
<a href="#h66-0-17" id="h66-0-17" class="d">-  void Reset() { }
</a><a href="#h66-0-18" id="h66-0-18" class="i">+  void Reset() {}
</a> };
 }  // namespace testing
 
<a href="#h66-0-22" id="h66-0-22" class="d">-namespace re2 {
</a><a href="#h66-0-23" id="h66-0-23" class="d">-int64 VirtualProcessSize();
</a><a href="#h66-0-24" id="h66-0-24" class="d">-} // namespace re2
</a><a href="#h66-0-25" id="h66-0-25" class="d">-
</a> #endif  // RE2_UTIL_TEST_H__
<b>diff --git a/<a id="h67" href="../file/src/vendor/re2/util/thread.cc">src/vendor/re2/util/thread.cc</a> b/<a href="../file/src/vendor/re2/util/thread.cc">src/vendor/re2/util/thread.cc</a></b>
<a href="#h67-0" id="h67-0" class="h">@@ -2,10 +2,8 @@
</a> // Use of this source code is governed by a BSD-style
 // license that can be found in the LICENSE file.
 
<a href="#h67-0-3" id="h67-0-3" class="d">-#include &lt;pthread.h&gt;
</a><a href="#h67-0-4" id="h67-0-4" class="d">-
</a><a href="#h67-0-5" id="h67-0-5" class="d">-#include &quot;util/util.h&quot;
</a> #include &quot;util/thread.h&quot;
<a href="#h67-0-7" id="h67-0-7" class="i">+#include &quot;util/util.h&quot;
</a> 
 Thread::Thread() {
   pid_ = 0;
<b>diff --git a/<a id="h68" href="../file/src/vendor/re2/util/thread.h">src/vendor/re2/util/thread.h</a> b/<a href="../file/src/vendor/re2/util/thread.h">src/vendor/re2/util/thread.h</a></b>
<a href="#h68-0" id="h68-0" class="h">@@ -5,7 +5,11 @@
</a> #ifndef RE2_UTIL_THREAD_H__
 #define RE2_UTIL_THREAD_H__
 
<a href="#h68-0-3" id="h68-0-3" class="i">+#ifdef _WIN32
</a><a href="#h68-0-4" id="h68-0-4" class="i">+#include &lt;windows.h&gt;
</a><a href="#h68-0-5" id="h68-0-5" class="i">+#else
</a> #include &lt;pthread.h&gt;
<a href="#h68-0-7" id="h68-0-7" class="i">+#endif
</a> 
 class Thread {
  public:
<a href="#h68-1" id="h68-1" class="h">@@ -15,12 +19,15 @@ class Thread {
</a>   void Join();
   void SetJoinable(bool);
   virtual void Run() = 0;
<a href="#h68-1-3" id="h68-1-3" class="d">- 
</a><a href="#h68-1-4" id="h68-1-4" class="i">+
</a>  private:
<a href="#h68-1-6" id="h68-1-6" class="i">+#ifdef _WIN32
</a><a href="#h68-1-7" id="h68-1-7" class="i">+  HANDLE pid_;
</a><a href="#h68-1-8" id="h68-1-8" class="i">+#else
</a>   pthread_t pid_;
<a href="#h68-1-10" id="h68-1-10" class="i">+#endif
</a>   bool running_;
   bool joinable_;
 };
 
 #endif  // RE2_UTIL_THREAD_H__
<a href="#h68-1-16" id="h68-1-16" class="d">-
</a><b>diff --git a/<a id="h69" href="../file/src/vendor/re2/util/threadwin.cc">src/vendor/re2/util/threadwin.cc</a> b/<a href="../file/src/vendor/re2/util/threadwin.cc">src/vendor/re2/util/threadwin.cc</a></b>
<a href="#h69-0" id="h69-0" class="h">@@ -2,10 +2,8 @@
</a> // Use of this source code is governed by a BSD-style
 // license that can be found in the LICENSE file.
 
<a href="#h69-0-3" id="h69-0-3" class="d">-#include &lt;windows.h&gt;
</a><a href="#h69-0-4" id="h69-0-4" class="d">-
</a><a href="#h69-0-5" id="h69-0-5" class="d">-#include &quot;util/util.h&quot;
</a> #include &quot;util/thread.h&quot;
<a href="#h69-0-7" id="h69-0-7" class="i">+#include &quot;util/util.h&quot;
</a> 
 Thread::Thread() {
   pid_ = 0;
<a href="#h69-1" id="h69-1" class="h">@@ -26,8 +24,7 @@ void Thread::Start() {
</a>   CHECK(!running_);
   pid_ = CreateThread(NULL, 0, startThread, this, 0, NULL);
   running_ = true;
<a href="#h69-1-3" id="h69-1-3" class="d">-  if (!joinable_)
</a><a href="#h69-1-4" id="h69-1-4" class="d">-  {
</a><a href="#h69-1-5" id="h69-1-5" class="i">+  if (!joinable_) {
</a>     CloseHandle(pid_);
     pid_ = 0;
   }
<a href="#h69-2" id="h69-2" class="h">@@ -36,10 +33,8 @@ void Thread::Start() {
</a> void Thread::Join() {
   CHECK(running_);
   CHECK(joinable_);
<a href="#h69-2-3" id="h69-2-3" class="d">-  if (0 != pid_)
</a><a href="#h69-2-4" id="h69-2-4" class="d">-  {
</a><a href="#h69-2-5" id="h69-2-5" class="d">-      WaitForSingleObject(pid_, INFINITE);
</a><a href="#h69-2-6" id="h69-2-6" class="d">-  }
</a><a href="#h69-2-7" id="h69-2-7" class="i">+  if (pid_ != 0)
</a><a href="#h69-2-8" id="h69-2-8" class="i">+    WaitForSingleObject(pid_, INFINITE);
</a>   running_ = 0;
 }
 
<b>diff --git a/<a id="h70" href="../file/src/vendor/re2/util/util.h">src/vendor/re2/util/util.h</a> b/<a href="../file/src/vendor/re2/util/util.h">src/vendor/re2/util/util.h</a></b>
<a href="#h70-0" id="h70-0" class="h">@@ -9,11 +9,15 @@
</a> #include &lt;stdio.h&gt;
 #include &lt;string.h&gt;
 #include &lt;stdint.h&gt;
<a href="#h70-0-3" id="h70-0-3" class="d">-#include &lt;stddef.h&gt;         // For size_t
</a><a href="#h70-0-4" id="h70-0-4" class="i">+#include &lt;stddef.h&gt;     // For size_t
</a> #include &lt;assert.h&gt;
 #include &lt;stdarg.h&gt;
<a href="#h70-0-7" id="h70-0-7" class="d">-#include &lt;time.h&gt;
</a><a href="#h70-0-8" id="h70-0-8" class="d">-#include &lt;ctype.h&gt;	// For isdigit, isalpha.
</a><a href="#h70-0-9" id="h70-0-9" class="i">+#include &lt;time.h&gt;       // For clock_gettime, CLOCK_REALTIME
</a><a href="#h70-0-10" id="h70-0-10" class="i">+#include &lt;ctype.h&gt;      // For isdigit, isalpha
</a><a href="#h70-0-11" id="h70-0-11" class="i">+
</a><a href="#h70-0-12" id="h70-0-12" class="i">+#if !defined(_WIN32)
</a><a href="#h70-0-13" id="h70-0-13" class="i">+#include &lt;sys/time.h&gt;   // For gettimeofday
</a><a href="#h70-0-14" id="h70-0-14" class="i">+#endif
</a> 
 // C++
 #include &lt;ctime&gt;
<a href="#h70-1" id="h70-1" class="h">@@ -41,7 +45,7 @@ using std::sort;
</a> using std::swap;
 using std::make_pair;
 
<a href="#h70-1-3" id="h70-1-3" class="d">-#if defined(__GNUC__) &amp;&amp; !defined(USE_CXX0X) &amp;&amp; !defined(_LIBCPP_ABI_VERSION) &amp;&amp; !defined(OS_ANDROID)
</a><a href="#h70-1-4" id="h70-1-4" class="i">+#if defined(__GNUC__) &amp;&amp; !defined(USE_CXX0X) &amp;&amp; !defined(_LIBCPP_ABI_VERSION)
</a> 
 #include &lt;tr1/unordered_set&gt;
 using std::tr1::unordered_set;
<a href="#h70-2" id="h70-2" class="h">@@ -49,7 +53,7 @@ using std::tr1::unordered_set;
</a> #else
 
 #include &lt;unordered_set&gt;
<a href="#h70-2-3" id="h70-2-3" class="d">-#if defined(WIN32) || defined(OS_ANDROID)
</a><a href="#h70-2-4" id="h70-2-4" class="i">+#if defined(_WIN32)
</a> using std::tr1::unordered_set;
 #else
 using std::unordered_set;
<a href="#h70-3" id="h70-3" class="h">@@ -57,10 +61,9 @@ using std::unordered_set;
</a> 
 #endif
 
<a href="#h70-3-3" id="h70-3-3" class="d">-#ifdef WIN32
</a><a href="#h70-3-4" id="h70-3-4" class="i">+#ifdef _WIN32
</a> 
 #define snprintf _snprintf_s
<a href="#h70-3-7" id="h70-3-7" class="d">-#define sprintf sprintf_s
</a> #define stricmp _stricmp
 #define strtof strtod /* not really correct but best we can do */
 #define strtoll _strtoi64
<a href="#h70-4" id="h70-4" class="h">@@ -68,7 +71,6 @@ using std::unordered_set;
</a> #define vsnprintf vsnprintf_s
 
 #pragma warning(disable: 4018) // signed/unsigned mismatch
<a href="#h70-4-3" id="h70-4-3" class="d">-#pragma warning(disable: 4244) // possible data loss in int conversion
</a> #pragma warning(disable: 4800) // conversion from int to bool
 
 #endif
<a href="#h70-5" id="h70-5" class="h">@@ -88,13 +90,22 @@ typedef unsigned long ulong;
</a> typedef unsigned int uint;
 typedef unsigned short ushort;
 
<a href="#h70-5-3" id="h70-5-3" class="i">+// Prevent the compiler from complaining about or optimizing away variables
</a><a href="#h70-5-4" id="h70-5-4" class="i">+// that appear unused.
</a><a href="#h70-5-5" id="h70-5-5" class="i">+#undef ATTRIBUTE_UNUSED
</a><a href="#h70-5-6" id="h70-5-6" class="i">+#if defined(__GNUC__)
</a><a href="#h70-5-7" id="h70-5-7" class="i">+#define ATTRIBUTE_UNUSED __attribute__ ((unused))
</a><a href="#h70-5-8" id="h70-5-8" class="i">+#else
</a><a href="#h70-5-9" id="h70-5-9" class="i">+#define ATTRIBUTE_UNUSED
</a><a href="#h70-5-10" id="h70-5-10" class="i">+#endif
</a><a href="#h70-5-11" id="h70-5-11" class="i">+
</a> // COMPILE_ASSERT causes a compile error about msg if expr is not true.
 #if __cplusplus &gt;= 201103L
 #define COMPILE_ASSERT(expr, msg) static_assert(expr, #msg)
 #else
 template&lt;bool&gt; struct CompileAssert {};
 #define COMPILE_ASSERT(expr, msg) \
<a href="#h70-5-18" id="h70-5-18" class="d">-  typedef CompileAssert&lt;(bool(expr))&gt; msg[bool(expr) ? 1 : -1]
</a><a href="#h70-5-19" id="h70-5-19" class="i">+  typedef CompileAssert&lt;(bool(expr))&gt; msg[bool(expr) ? 1 : -1] ATTRIBUTE_UNUSED
</a> #endif
 
 // DISALLOW_COPY_AND_ASSIGN disallows the copy and operator= functions.
<a href="#h70-6" id="h70-6" class="h">@@ -134,7 +145,6 @@ int RunningOnValgrind();
</a> 
 }  // namespace re2
 
<a href="#h70-6-3" id="h70-6-3" class="d">-#include &quot;util/arena.h&quot;
</a> #include &quot;util/logging.h&quot;
 #include &quot;util/mutex.h&quot;
 #include &quot;util/utf.h&quot;
<b>diff --git a/<a id="h71" href="../file/src/vendor/re2/util/valgrind.cc">src/vendor/re2/util/valgrind.cc</a> b/<a href="../file/src/vendor/re2/util/valgrind.cc">src/vendor/re2/util/valgrind.cc</a></b>
<a href="#h71-0" id="h71-0" class="h">@@ -3,7 +3,7 @@
</a> // license that can be found in the LICENSE file.
 
 #include &quot;util/util.h&quot;
<a href="#h71-0-3" id="h71-0-3" class="d">-#ifndef WIN32
</a><a href="#h71-0-4" id="h71-0-4" class="i">+#ifndef _WIN32
</a> #include &quot;util/valgrind.h&quot;
 #endif
 
</pre>
</div>
</body>
</html>
