<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Merge branch &#39;indexer&#39; - livegrep - Fast, regular expression code search service</title>
<meta name="description" content="Fast, regular expression code search service" />
<meta name="author" content="Kevin Lin" />
<link rel="icon" type="image/png" href="https://static.kevinlin.info/favicon.png" />
<link rel="alternate" type="application/atom+xml" title="livegrep Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="livegrep Atom Feed (tags)" href="../tags.xml" />
<style type="text/css">
body{color:#000;background-color:#fff;font-family:monospace}h1,h2,h3,h4,h5,h6{font-size:1em;margin:0}img,h1,h2{vertical-align:middle}img{border:0}a:target{background-color:#ccc}a.d,a.h,a.i{text-decoration:none}a.line{text-decoration:none;user-select:none}#blob a{color:#555}#blob a:hover{color:blue;text-decoration:none}table thead td{font-weight:bold}table td{padding:0 .4em}table td pre{margin:0}#content table td{vertical-align:top;white-space:nowrap}#branches tr:hover td,#tags tr:hover td,#index tr:hover td,#log tr:hover td,#files tr:hover td{background-color:#eee}#index tr td:nth-child(2),#tags tr td:nth-child(3),#branches tr td:nth-child(3),#log tr td:nth-child(2){white-space:normal}td.num{text-align:right}.desc{color:#555}hr{border:0;border-top:1px solid #555;height:1px}pre{font-family:monospace}pre a.h{color:#00a}.A,span.i,pre a.i{color:#070}.D,span.d,pre a.d{color:#e00}pre a.h:hover,pre a.i:hover,pre a.d:hover{text-decoration:none}
</style>
</head>
<body>
<table><tr><td><a href="/"><img src="https://static.kevinlin.info/favicon.png" alt="" width="32" height="32" /></a></td><td><h1>livegrep</h1><span class="desc">Fast, regular expression code search service</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://source.static.kevinlin.info/external/livegrep.git">https://source.static.kevinlin.info/external/livegrep.git</a></td></tr><tr><td></td><td>
<a href="../log">Log</a> | <a href="../files">Files</a> | <a href="../refs">Refs</a> | <a href="../file/README.md">README</a> | <a href="../file/COPYING">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/e8eedab188a1bd3f085a6160cfcfafd3371e21ca">e8eedab188a1bd3f085a6160cfcfafd3371e21ca</a>
<b>parent</b> <a href="../commit/06040321e8e79995fec1d64660a3d218d759887a">06040321e8e79995fec1d64660a3d218d759887a</a>
<b>Author:</b> Nelson Elhage &lt;<a href="mailto:nelhage@nelhage.com">nelhage@nelhage.com</a>&gt;
<b>Date:</b>   Sat 31 Dec 2011 13:39:28 -0500

Merge branch &#39;indexer&#39;

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">atomic.h</a></td><td> | </td><td class="num">5</td><td><span class="i">+++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">codesearch.cc</a></td><td> | </td><td class="num">106</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">---------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h2">common.h</a></td><td> | </td><td class="num">6</td><td><span class="i">++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">indexer.cc</a></td><td> | </td><td class="num">556</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">---------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">indexer.h</a></td><td> | </td><td class="num">84</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">-------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h5">recursion.h</a></td><td> | </td><td class="num">16</td><td><span class="i">++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h6">test/index</a></td><td> | </td><td class="num">11</td><td><span class="i">+++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h7">test/unicode</a></td><td> | </td><td class="num">3</td><td><span class="i">+++</span><span class="d"></span></td></tr>
</table></pre><pre>8 files changed, 650 insertions(+), 137 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/atomic.h">atomic.h</a> b/<a href="../file/atomic.h">atomic.h</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -14,6 +14,11 @@ public:
</a>     int operator++() {
         return __sync_fetch_and_add(&amp;val_, 1);
     }
<a href="#h0-0-3" id="h0-0-3" class="i">+
</a><a href="#h0-0-4" id="h0-0-4" class="i">+    int operator--() {
</a><a href="#h0-0-5" id="h0-0-5" class="i">+        return __sync_fetch_and_add(&amp;val_, -1);
</a><a href="#h0-0-6" id="h0-0-6" class="i">+    }
</a><a href="#h0-0-7" id="h0-0-7" class="i">+
</a> private:
     int val_;
 };
<b>diff --git a/<a id="h1" href="../file/codesearch.cc">codesearch.cc</a> b/<a href="../file/codesearch.cc">codesearch.cc</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -82,11 +82,7 @@ public:
</a>         {
             run_timer run(analyze_time_);
             index_ = indexRE(pat);
<a href="#h1-0-3" id="h1-0-3" class="d">-            log_profile(&quot;Index(%d): \n&quot;, int(index_-&gt;keys.size()));
</a><a href="#h1-0-4" id="h1-0-4" class="d">-            for (vector&lt;string&gt;::const_iterator it = index_-&gt;keys.begin();
</a><a href="#h1-0-5" id="h1-0-5" class="d">-                 it != index_-&gt;keys.end(); it++) {
</a><a href="#h1-0-6" id="h1-0-6" class="d">-                log_profile(&quot;  %s\n&quot;, it-&gt;c_str());
</a><a href="#h1-0-7" id="h1-0-7" class="d">-            }
</a><a href="#h1-0-8" id="h1-0-8" class="i">+            log_profile(&quot;Index: %s\n&quot;, index_-&gt;ToString().c_str());
</a>         }
 
         if (FLAGS_timeout &lt;= 0) {
<a href="#h1-1" id="h1-1" class="h">@@ -232,7 +228,7 @@ protected:
</a>     RE2&amp; pat_;
     thread_queue&lt;match_result*&gt;&amp; queue_;
     atomic_int matches_;
<a href="#h1-1-3" id="h1-1-3" class="d">-    shared_ptr&lt;IndexKey&gt; index_;
</a><a href="#h1-1-4" id="h1-1-4" class="i">+    intrusive_ptr&lt;IndexKey&gt; index_;
</a>     timer re2_time_;
     timer git_time_;
     timer index_time_;
<a href="#h1-2" id="h1-2" class="h">@@ -476,41 +472,95 @@ void searcher::operator()(const chunk *chunk)
</a>     if (exit_reason_)
         return;
 
<a href="#h1-2-3" id="h1-2-3" class="d">-    if (FLAGS_index &amp;&amp; index_-&gt;keys.size())
</a><a href="#h1-2-4" id="h1-2-4" class="i">+    if (FLAGS_index &amp;&amp; index_ &amp;&amp; !index_-&gt;empty())
</a>         filtered_search(chunk);
     else
         full_search(chunk);
 }
 
<a href="#h1-2-10" id="h1-2-10" class="d">-void searcher::filtered_search(const chunk *chunk)
</a><a href="#h1-2-11" id="h1-2-11" class="d">-{
</a><a href="#h1-2-12" id="h1-2-12" class="d">-    log_profile(&quot;Attempting filtered search with %d filters\n&quot;,
</a><a href="#h1-2-13" id="h1-2-13" class="d">-                int(index_-&gt;keys.size()));
</a><a href="#h1-2-14" id="h1-2-14" class="d">-    chunk::lt_suffix lt(chunk);
</a><a href="#h1-2-15" id="h1-2-15" class="i">+struct walk_state {
</a><a href="#h1-2-16" id="h1-2-16" class="i">+    uint32_t *left, *right;
</a><a href="#h1-2-17" id="h1-2-17" class="i">+    intrusive_ptr&lt;IndexKey&gt; key;
</a><a href="#h1-2-18" id="h1-2-18" class="i">+    int depth;
</a><a href="#h1-2-19" id="h1-2-19" class="i">+};
</a><a href="#h1-2-20" id="h1-2-20" class="i">+
</a><a href="#h1-2-21" id="h1-2-21" class="i">+struct lt_index {
</a><a href="#h1-2-22" id="h1-2-22" class="i">+    const chunk *chunk_;
</a><a href="#h1-2-23" id="h1-2-23" class="i">+    int idx_;
</a> 
<a href="#h1-2-25" id="h1-2-25" class="d">-    vector&lt;pair&lt;uint32_t*, uint32_t*&gt; &gt; ranges;
</a><a href="#h1-2-26" id="h1-2-26" class="d">-    ranges.reserve(index_-&gt;keys.size());
</a><a href="#h1-2-27" id="h1-2-27" class="d">-    uint32_t *indexes;
</a><a href="#h1-2-28" id="h1-2-28" class="d">-    int count = 0, off = 0;
</a><a href="#h1-2-29" id="h1-2-29" class="i">+    bool operator()(uint32_t lhs, unsigned char rhs) {
</a><a href="#h1-2-30" id="h1-2-30" class="i">+        return cmp(lhs, rhs) &lt; 0;
</a><a href="#h1-2-31" id="h1-2-31" class="i">+    }
</a><a href="#h1-2-32" id="h1-2-32" class="i">+
</a><a href="#h1-2-33" id="h1-2-33" class="i">+    bool operator()(unsigned char lhs, uint32_t rhs) {
</a><a href="#h1-2-34" id="h1-2-34" class="i">+        return cmp(rhs, lhs) &gt; 0;
</a><a href="#h1-2-35" id="h1-2-35" class="i">+    }
</a><a href="#h1-2-36" id="h1-2-36" class="i">+
</a><a href="#h1-2-37" id="h1-2-37" class="i">+    int cmp(uint32_t lhs, unsigned char rhs) {
</a><a href="#h1-2-38" id="h1-2-38" class="i">+        unsigned char lc = chunk_-&gt;data[lhs + idx_];
</a><a href="#h1-2-39" id="h1-2-39" class="i">+        if (lc == &#39;\n&#39;)
</a><a href="#h1-2-40" id="h1-2-40" class="i">+            return -1;
</a><a href="#h1-2-41" id="h1-2-41" class="i">+        return (int)lc - (int)rhs;
</a><a href="#h1-2-42" id="h1-2-42" class="i">+    }
</a><a href="#h1-2-43" id="h1-2-43" class="i">+};
</a> 
<a href="#h1-2-45" id="h1-2-45" class="i">+
</a><a href="#h1-2-46" id="h1-2-46" class="i">+void searcher::filtered_search(const chunk *chunk)
</a><a href="#h1-2-47" id="h1-2-47" class="i">+{
</a><a href="#h1-2-48" id="h1-2-48" class="i">+    uint32_t *indexes = new uint32_t[kChunkSpace];
</a><a href="#h1-2-49" id="h1-2-49" class="i">+    int count = 0;
</a>     {
         run_timer run(index_time_);
<a href="#h1-2-52" id="h1-2-52" class="d">-        for (vector&lt;string&gt;::iterator it = index_-&gt;keys.begin();
</a><a href="#h1-2-53" id="h1-2-53" class="d">-             it != index_-&gt;keys.end(); ++it) {
</a><a href="#h1-2-54" id="h1-2-54" class="d">-            ranges.push_back(equal_range(chunk-&gt;suffixes,
</a><a href="#h1-2-55" id="h1-2-55" class="d">-                                         chunk-&gt;suffixes + chunk-&gt;size,
</a><a href="#h1-2-56" id="h1-2-56" class="d">-                                         *it, lt));
</a><a href="#h1-2-57" id="h1-2-57" class="d">-            count += ranges.back().second - ranges.back().first;
</a><a href="#h1-2-58" id="h1-2-58" class="d">-        }
</a><a href="#h1-2-59" id="h1-2-59" class="d">-        indexes = new uint32_t[count];
</a><a href="#h1-2-60" id="h1-2-60" class="d">-        for (int i = 0; i &lt; index_-&gt;keys.size(); i++) {
</a><a href="#h1-2-61" id="h1-2-61" class="d">-            int width = ranges[i].second - ranges[i].first;
</a><a href="#h1-2-62" id="h1-2-62" class="d">-            memcpy(&amp;indexes[off], ranges[i].first, width * sizeof(uint32_t));
</a><a href="#h1-2-63" id="h1-2-63" class="d">-            off += width;
</a><a href="#h1-2-64" id="h1-2-64" class="i">+        vector&lt;walk_state&gt; stack;
</a><a href="#h1-2-65" id="h1-2-65" class="i">+        stack.push_back((walk_state){
</a><a href="#h1-2-66" id="h1-2-66" class="i">+                chunk-&gt;suffixes, chunk-&gt;suffixes + chunk-&gt;size, index_, 0});
</a><a href="#h1-2-67" id="h1-2-67" class="i">+
</a><a href="#h1-2-68" id="h1-2-68" class="i">+        while (!stack.empty()) {
</a><a href="#h1-2-69" id="h1-2-69" class="i">+            walk_state st = stack.back();
</a><a href="#h1-2-70" id="h1-2-70" class="i">+            stack.pop_back();
</a><a href="#h1-2-71" id="h1-2-71" class="i">+            if (!st.key || (st.right - st.left) &lt;= 100) {
</a><a href="#h1-2-72" id="h1-2-72" class="i">+                memcpy(indexes + count, st.left,
</a><a href="#h1-2-73" id="h1-2-73" class="i">+                       (st.right - st.left) * sizeof(uint32_t));
</a><a href="#h1-2-74" id="h1-2-74" class="i">+                count += (st.right - st.left);
</a><a href="#h1-2-75" id="h1-2-75" class="i">+                continue;
</a><a href="#h1-2-76" id="h1-2-76" class="i">+            }
</a><a href="#h1-2-77" id="h1-2-77" class="i">+            lt_index lt = {chunk, st.depth};
</a><a href="#h1-2-78" id="h1-2-78" class="i">+            for (IndexKey::iterator it = st.key-&gt;begin();
</a><a href="#h1-2-79" id="h1-2-79" class="i">+                 it != st.key-&gt;end(); ++it) {
</a><a href="#h1-2-80" id="h1-2-80" class="i">+                uint32_t *l, *r;
</a><a href="#h1-2-81" id="h1-2-81" class="i">+                l = lower_bound(st.left, st.right, it-&gt;first.first, lt);
</a><a href="#h1-2-82" id="h1-2-82" class="i">+                uint32_t *right = lower_bound(l, st.right,
</a><a href="#h1-2-83" id="h1-2-83" class="i">+                                              (unsigned char)(it-&gt;first.second + 1),
</a><a href="#h1-2-84" id="h1-2-84" class="i">+                                              lt);
</a><a href="#h1-2-85" id="h1-2-85" class="i">+                if (l == right)
</a><a href="#h1-2-86" id="h1-2-86" class="i">+                    continue;
</a><a href="#h1-2-87" id="h1-2-87" class="i">+
</a><a href="#h1-2-88" id="h1-2-88" class="i">+                if (st.depth)
</a><a href="#h1-2-89" id="h1-2-89" class="i">+                    assert(chunk-&gt;data[*l + st.depth - 1] ==
</a><a href="#h1-2-90" id="h1-2-90" class="i">+                           chunk-&gt;data[*(right - 1) + st.depth - 1]);
</a><a href="#h1-2-91" id="h1-2-91" class="i">+
</a><a href="#h1-2-92" id="h1-2-92" class="i">+                assert(l == st.left ||
</a><a href="#h1-2-93" id="h1-2-93" class="i">+                       chunk-&gt;data[*(l-1) + st.depth] == &#39;\n&#39; ||
</a><a href="#h1-2-94" id="h1-2-94" class="i">+                       chunk-&gt;data[*(l-1) + st.depth] &lt; it-&gt;first.first);
</a><a href="#h1-2-95" id="h1-2-95" class="i">+                assert(chunk-&gt;data[*l + st.depth] &gt;= it-&gt;first.first);
</a><a href="#h1-2-96" id="h1-2-96" class="i">+                assert(right == st.right ||
</a><a href="#h1-2-97" id="h1-2-97" class="i">+                       chunk-&gt;data[*right + st.depth] &gt; it-&gt;first.second);
</a><a href="#h1-2-98" id="h1-2-98" class="i">+
</a><a href="#h1-2-99" id="h1-2-99" class="i">+                for (unsigned char ch = it-&gt;first.first; ch &lt;= it-&gt;first.second;
</a><a href="#h1-2-100" id="h1-2-100" class="i">+                     ch++, l = r) {
</a><a href="#h1-2-101" id="h1-2-101" class="i">+                    r = lower_bound(l, right, (unsigned char)(ch + 1), lt);
</a><a href="#h1-2-102" id="h1-2-102" class="i">+
</a><a href="#h1-2-103" id="h1-2-103" class="i">+                    if (r != l) {
</a><a href="#h1-2-104" id="h1-2-104" class="i">+                        stack.push_back((walk_state){l, r, it-&gt;second, st.depth + 1});
</a><a href="#h1-2-105" id="h1-2-105" class="i">+                    }
</a><a href="#h1-2-106" id="h1-2-106" class="i">+                }
</a><a href="#h1-2-107" id="h1-2-107" class="i">+            }
</a>         }
<a href="#h1-2-109" id="h1-2-109" class="i">+
</a>     }
 
     search_lines(indexes, count, chunk);
<a href="#h1-2-113" id="h1-2-113" class="i">+
</a>     delete[] indexes;
 }
 
<b>diff --git a/<a id="h2" href="../file/common.h">common.h</a> b/<a href="../file/common.h">common.h</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -0,0 +1,6 @@
</a><a href="#h2-0-0" id="h2-0-0" class="i">+#ifndef CODESEARCH_COMMON_H
</a><a href="#h2-0-1" id="h2-0-1" class="i">+#define CODESEARCH_COMMON_H
</a><a href="#h2-0-2" id="h2-0-2" class="i">+
</a><a href="#h2-0-3" id="h2-0-3" class="i">+typedef unsigned char uchar;
</a><a href="#h2-0-4" id="h2-0-4" class="i">+
</a><a href="#h2-0-5" id="h2-0-5" class="i">+#endif
</a><b>diff --git a/<a id="h3" href="../file/indexer.cc">indexer.cc</a> b/<a href="../file/indexer.cc">indexer.cc</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -1,12 +1,22 @@
</a> #include &quot;indexer.h&quot;
<a href="#h3-0-1" id="h3-0-1" class="i">+#include &quot;recursion.h&quot;
</a> 
 #include &lt;gflags/gflags.h&gt;
 
<a href="#h3-0-5" id="h3-0-5" class="i">+#include &lt;list&gt;
</a><a href="#h3-0-6" id="h3-0-6" class="i">+
</a> #include &lt;stdarg.h&gt;
 
<a href="#h3-0-9" id="h3-0-9" class="d">-DEFINE_bool(debug_index, false, &quot;Debug the index query generator.&quot;);
</a><a href="#h3-0-10" id="h3-0-10" class="i">+DEFINE_int32(debug_index, 0, &quot;Debug the index query generator.&quot;);
</a><a href="#h3-0-11" id="h3-0-11" class="i">+static void __index_debug(const char *format, ...)
</a><a href="#h3-0-12" id="h3-0-12" class="i">+    __attribute__((format (printf, 1, 2)));
</a><a href="#h3-0-13" id="h3-0-13" class="i">+
</a><a href="#h3-0-14" id="h3-0-14" class="i">+#define debug(lvl, fmt, ...) do {                \
</a><a href="#h3-0-15" id="h3-0-15" class="i">+        if (FLAGS_debug_index &gt;= lvl)            \
</a><a href="#h3-0-16" id="h3-0-16" class="i">+            __index_debug(fmt, ## __VA_ARGS__);  \
</a><a href="#h3-0-17" id="h3-0-17" class="i">+    } while(0)
</a> 
<a href="#h3-0-19" id="h3-0-19" class="d">-static void debug(const char *format, ...) {
</a><a href="#h3-0-20" id="h3-0-20" class="i">+static void __index_debug(const char *format, ...) {
</a>     if (!FLAGS_debug_index)
         return;
     va_list ap;
<a href="#h3-1" id="h3-1" class="h">@@ -20,31 +30,142 @@ using namespace re2;
</a> using namespace std;
 
 const unsigned kMinWeight = 16;
<a href="#h3-1-3" id="h3-1-3" class="d">-const int kMaxFilters     = 32;
</a><a href="#h3-1-4" id="h3-1-4" class="i">+const int kMaxWidth       = 32;
</a><a href="#h3-1-5" id="h3-1-5" class="i">+const int kMaxRecursion   = 10;
</a><a href="#h3-1-6" id="h3-1-6" class="i">+const int kMaxNodes       = (1 &lt;&lt; 24);
</a> 
<a href="#h3-1-8" id="h3-1-8" class="d">-double IndexKey::selectivity() {
</a><a href="#h3-1-9" id="h3-1-9" class="d">-    if (keys.size() == 0)
</a><a href="#h3-1-10" id="h3-1-10" class="d">-        return 1.0;
</a><a href="#h3-1-11" id="h3-1-11" class="i">+namespace {
</a><a href="#h3-1-12" id="h3-1-12" class="i">+    static IndexKey::Stats null_stats;
</a><a href="#h3-1-13" id="h3-1-13" class="i">+};
</a><a href="#h3-1-14" id="h3-1-14" class="i">+
</a><a href="#h3-1-15" id="h3-1-15" class="i">+IndexKey::Stats::Stats ()
</a><a href="#h3-1-16" id="h3-1-16" class="i">+    : selectivity_(1.0), depth_(0), nodes_(1), tail_paths_(1) {
</a><a href="#h3-1-17" id="h3-1-17" class="i">+}
</a><a href="#h3-1-18" id="h3-1-18" class="i">+
</a><a href="#h3-1-19" id="h3-1-19" class="i">+IndexKey::Stats IndexKey::Stats::insert(const value_type&amp; val) const {
</a><a href="#h3-1-20" id="h3-1-20" class="i">+    Stats out(*this);
</a><a href="#h3-1-21" id="h3-1-21" class="i">+    if (out.selectivity_ == 1.0) {
</a><a href="#h3-1-22" id="h3-1-22" class="i">+        out.selectivity_ = 0.0;
</a><a href="#h3-1-23" id="h3-1-23" class="i">+        out.tail_paths_  = 0;
</a><a href="#h3-1-24" id="h3-1-24" class="i">+    }
</a><a href="#h3-1-25" id="h3-1-25" class="i">+
</a><a href="#h3-1-26" id="h3-1-26" class="i">+    const Stats&amp; rstats = val.second ? val.second-&gt;stats() : null_stats;
</a><a href="#h3-1-27" id="h3-1-27" class="i">+
</a><a href="#h3-1-28" id="h3-1-28" class="i">+    out.selectivity_ += (val.first.second - val.first.first + 1)/128. * rstats.selectivity_;
</a><a href="#h3-1-29" id="h3-1-29" class="i">+    out.depth_ = max(depth_, rstats.depth_ + 1);
</a><a href="#h3-1-30" id="h3-1-30" class="i">+    out.nodes_ += (val.first.second - val.first.first + 1) * rstats.nodes_;
</a><a href="#h3-1-31" id="h3-1-31" class="i">+    if (!val.second)
</a><a href="#h3-1-32" id="h3-1-32" class="i">+        out.tail_paths_ += (val.first.second - val.first.first + 1);
</a><a href="#h3-1-33" id="h3-1-33" class="i">+
</a><a href="#h3-1-34" id="h3-1-34" class="i">+    return out;
</a><a href="#h3-1-35" id="h3-1-35" class="i">+}
</a> 
<a href="#h3-1-37" id="h3-1-37" class="d">-    double s = 0.0;
</a><a href="#h3-1-38" id="h3-1-38" class="d">-    for (vector&lt;string&gt;::const_iterator it = keys.begin();
</a><a href="#h3-1-39" id="h3-1-39" class="d">-         it != keys.end(); ++it)
</a><a href="#h3-1-40" id="h3-1-40" class="d">-        s += pow(1./(it-&gt;size() + 1), 8);
</a><a href="#h3-1-41" id="h3-1-41" class="i">+IndexKey::Stats IndexKey::Stats::concat(const IndexKey::Stats&amp; rhs) const {
</a><a href="#h3-1-42" id="h3-1-42" class="i">+    Stats out(*this);
</a><a href="#h3-1-43" id="h3-1-43" class="i">+    out.selectivity_ *= rhs.selectivity_;
</a><a href="#h3-1-44" id="h3-1-44" class="i">+    out.depth_ += rhs.depth_;
</a><a href="#h3-1-45" id="h3-1-45" class="i">+    out.nodes_ += tail_paths_ * rhs.nodes_;
</a><a href="#h3-1-46" id="h3-1-46" class="i">+    out.tail_paths_ *= rhs.tail_paths_;
</a> 
<a href="#h3-1-48" id="h3-1-48" class="d">-    return s;
</a><a href="#h3-1-49" id="h3-1-49" class="i">+    return out;
</a><a href="#h3-1-50" id="h3-1-50" class="i">+}
</a><a href="#h3-1-51" id="h3-1-51" class="i">+
</a><a href="#h3-1-52" id="h3-1-52" class="i">+void IndexKey::insert(const value_type&amp; val) {
</a><a href="#h3-1-53" id="h3-1-53" class="i">+    stats_ = stats_.insert(val);
</a><a href="#h3-1-54" id="h3-1-54" class="i">+
</a><a href="#h3-1-55" id="h3-1-55" class="i">+    iterator it = edges_.insert(val).first;
</a><a href="#h3-1-56" id="h3-1-56" class="i">+    if (val.second) {
</a><a href="#h3-1-57" id="h3-1-57" class="i">+        tails_.splice(tails_.end(), val.second-&gt;tails_);
</a><a href="#h3-1-58" id="h3-1-58" class="i">+    } else {
</a><a href="#h3-1-59" id="h3-1-59" class="i">+        tails_.push_back(it);
</a><a href="#h3-1-60" id="h3-1-60" class="i">+    }
</a><a href="#h3-1-61" id="h3-1-61" class="i">+}
</a><a href="#h3-1-62" id="h3-1-62" class="i">+
</a><a href="#h3-1-63" id="h3-1-63" class="i">+double IndexKey::selectivity() {
</a><a href="#h3-1-64" id="h3-1-64" class="i">+    if (empty())
</a><a href="#h3-1-65" id="h3-1-65" class="i">+        assert(stats_.selectivity_ == 1.0);
</a><a href="#h3-1-66" id="h3-1-66" class="i">+
</a><a href="#h3-1-67" id="h3-1-67" class="i">+    return stats_.selectivity_;
</a> }
 
 unsigned IndexKey::weight() {
<a href="#h3-1-71" id="h3-1-71" class="i">+    if (1/selectivity() &gt; double(numeric_limits&lt;unsigned&gt;::max()))
</a><a href="#h3-1-72" id="h3-1-72" class="i">+        return numeric_limits&lt;unsigned&gt;::max() / 2;
</a>     return 1/selectivity();
 }
 
<a href="#h3-1-76" id="h3-1-76" class="d">-string IndexKey::ToString() {
</a><a href="#h3-1-77" id="h3-1-77" class="i">+long IndexKey::nodes() {
</a><a href="#h3-1-78" id="h3-1-78" class="i">+    return stats_.nodes_;
</a><a href="#h3-1-79" id="h3-1-79" class="i">+}
</a><a href="#h3-1-80" id="h3-1-80" class="i">+
</a><a href="#h3-1-81" id="h3-1-81" class="i">+int IndexKey::depth() {
</a><a href="#h3-1-82" id="h3-1-82" class="i">+    return stats_.depth_;
</a><a href="#h3-1-83" id="h3-1-83" class="i">+}
</a><a href="#h3-1-84" id="h3-1-84" class="i">+
</a><a href="#h3-1-85" id="h3-1-85" class="i">+void IndexKey::collect_tails(list&lt;IndexKey::iterator&gt;&amp; tails) {
</a><a href="#h3-1-86" id="h3-1-86" class="i">+    tails.splice(tails.end(), tails_);
</a><a href="#h3-1-87" id="h3-1-87" class="i">+}
</a><a href="#h3-1-88" id="h3-1-88" class="i">+
</a><a href="#h3-1-89" id="h3-1-89" class="i">+void IndexKey::concat(intrusive_ptr&lt;IndexKey&gt; rhs) {
</a><a href="#h3-1-90" id="h3-1-90" class="i">+    assert(anchor &amp; kAnchorRight);
</a><a href="#h3-1-91" id="h3-1-91" class="i">+    assert(rhs-&gt;anchor &amp; kAnchorLeft);
</a><a href="#h3-1-92" id="h3-1-92" class="i">+    assert(!empty());
</a><a href="#h3-1-93" id="h3-1-93" class="i">+
</a><a href="#h3-1-94" id="h3-1-94" class="i">+    if (rhs-&gt;empty())
</a><a href="#h3-1-95" id="h3-1-95" class="i">+        return;
</a><a href="#h3-1-96" id="h3-1-96" class="i">+
</a><a href="#h3-1-97" id="h3-1-97" class="i">+    list&lt;IndexKey::iterator&gt; tails;
</a><a href="#h3-1-98" id="h3-1-98" class="i">+    collect_tails(tails);
</a><a href="#h3-1-99" id="h3-1-99" class="i">+    for (auto it = tails.begin(); it != tails.end(); ++it) {
</a><a href="#h3-1-100" id="h3-1-100" class="i">+        assert(!(*it)-&gt;second);
</a><a href="#h3-1-101" id="h3-1-101" class="i">+        (*it)-&gt;second = rhs;
</a><a href="#h3-1-102" id="h3-1-102" class="i">+    }
</a><a href="#h3-1-103" id="h3-1-103" class="i">+    if (anchor &amp; kAnchorRepeat)
</a><a href="#h3-1-104" id="h3-1-104" class="i">+        anchor &amp;= ~kAnchorLeft;
</a><a href="#h3-1-105" id="h3-1-105" class="i">+    if ((rhs-&gt;anchor &amp; (kAnchorRepeat|kAnchorRight)) != kAnchorRight)
</a><a href="#h3-1-106" id="h3-1-106" class="i">+        anchor &amp;= ~kAnchorRight;
</a><a href="#h3-1-107" id="h3-1-107" class="i">+
</a><a href="#h3-1-108" id="h3-1-108" class="i">+    stats_ = stats_.concat(rhs-&gt;stats());
</a><a href="#h3-1-109" id="h3-1-109" class="i">+    rhs-&gt;collect_tails(tails_);
</a><a href="#h3-1-110" id="h3-1-110" class="i">+}
</a><a href="#h3-1-111" id="h3-1-111" class="i">+
</a><a href="#h3-1-112" id="h3-1-112" class="i">+static string strprintf(const char *fmt, ...)
</a><a href="#h3-1-113" id="h3-1-113" class="i">+    __attribute__((format (printf, 1, 2)));
</a><a href="#h3-1-114" id="h3-1-114" class="i">+
</a><a href="#h3-1-115" id="h3-1-115" class="i">+static string strprintf(const char *fmt, ...) {
</a><a href="#h3-1-116" id="h3-1-116" class="i">+    char buf[4096];
</a><a href="#h3-1-117" id="h3-1-117" class="i">+    va_list ap;
</a><a href="#h3-1-118" id="h3-1-118" class="i">+    va_start(ap, fmt);
</a><a href="#h3-1-119" id="h3-1-119" class="i">+    vsnprintf(buf, sizeof buf, fmt, ap);
</a><a href="#h3-1-120" id="h3-1-120" class="i">+    va_end(ap);
</a><a href="#h3-1-121" id="h3-1-121" class="i">+
</a><a href="#h3-1-122" id="h3-1-122" class="i">+    return string(buf);
</a><a href="#h3-1-123" id="h3-1-123" class="i">+}
</a><a href="#h3-1-124" id="h3-1-124" class="i">+
</a><a href="#h3-1-125" id="h3-1-125" class="i">+static string StrChar(uchar c) {
</a><a href="#h3-1-126" id="h3-1-126" class="i">+    if (c &gt; &#39; &#39; &amp;&amp; c &lt;= &#39;~&#39;)
</a><a href="#h3-1-127" id="h3-1-127" class="i">+        return strprintf(&quot;%c&quot;, c);
</a><a href="#h3-1-128" id="h3-1-128" class="i">+    return strprintf(&quot;\\x%02x&quot;, c);
</a><a href="#h3-1-129" id="h3-1-129" class="i">+}
</a><a href="#h3-1-130" id="h3-1-130" class="i">+
</a><a href="#h3-1-131" id="h3-1-131" class="i">+static string ToString(IndexKey *k, int indent = 0) {
</a>     string out;
<a href="#h3-1-133" id="h3-1-133" class="d">-    for (vector&lt;string&gt;::const_iterator it = keys.begin();
</a><a href="#h3-1-134" id="h3-1-134" class="d">-         it != keys.end(); ++it) {
</a><a href="#h3-1-135" id="h3-1-135" class="d">-        out += *it;
</a><a href="#h3-1-136" id="h3-1-136" class="d">-        out += &quot;,&quot;;
</a><a href="#h3-1-137" id="h3-1-137" class="i">+    if (k == 0)
</a><a href="#h3-1-138" id="h3-1-138" class="i">+        return strprintf(&quot;%*.s[]\n&quot;, indent, &quot;&quot;);
</a><a href="#h3-1-139" id="h3-1-139" class="i">+
</a><a href="#h3-1-140" id="h3-1-140" class="i">+    for (IndexKey::iterator it = k-&gt;begin(); it != k-&gt;end(); ++it) {
</a><a href="#h3-1-141" id="h3-1-141" class="i">+        out += strprintf(&quot;%*.s[%s-%s] -&gt; \n&quot;,
</a><a href="#h3-1-142" id="h3-1-142" class="i">+                         indent, &quot;&quot;,
</a><a href="#h3-1-143" id="h3-1-143" class="i">+                         StrChar(it-&gt;first.first).c_str(),
</a><a href="#h3-1-144" id="h3-1-144" class="i">+                         StrChar(it-&gt;first.second).c_str());
</a><a href="#h3-1-145" id="h3-1-145" class="i">+        out += ToString(it-&gt;second.get(), indent + 1);
</a>     }
<a href="#h3-1-147" id="h3-1-147" class="i">+    return out;
</a><a href="#h3-1-148" id="h3-1-148" class="i">+}
</a><a href="#h3-1-149" id="h3-1-149" class="i">+
</a><a href="#h3-1-150" id="h3-1-150" class="i">+string IndexKey::ToString() {
</a><a href="#h3-1-151" id="h3-1-151" class="i">+    string out = ::ToString(this, 0);
</a><a href="#h3-1-152" id="h3-1-152" class="i">+
</a>     out += &quot;|&quot;;
     if (anchor &amp; kAnchorLeft)
         out += &quot;&lt;&quot;;
<a href="#h3-2" id="h3-2" class="h">@@ -55,17 +176,17 @@ string IndexKey::ToString() {
</a>     return out;
 }
 
<a href="#h3-2-3" id="h3-2-3" class="d">-class IndexWalker : public Regexp::Walker&lt;shared_ptr&lt;IndexKey&gt; &gt; {
</a><a href="#h3-2-4" id="h3-2-4" class="i">+class IndexWalker : public Regexp::Walker&lt;intrusive_ptr&lt;IndexKey&gt; &gt; {
</a> public:
     IndexWalker() { }
<a href="#h3-2-7" id="h3-2-7" class="d">-    virtual shared_ptr&lt;IndexKey&gt;
</a><a href="#h3-2-8" id="h3-2-8" class="d">-    PostVisit(Regexp* re, shared_ptr&lt;IndexKey&gt; parent_arg,
</a><a href="#h3-2-9" id="h3-2-9" class="d">-              shared_ptr&lt;IndexKey&gt; pre_arg,
</a><a href="#h3-2-10" id="h3-2-10" class="d">-              shared_ptr&lt;IndexKey&gt; *child_args, int nchild_args);
</a><a href="#h3-2-11" id="h3-2-11" class="i">+    virtual intrusive_ptr&lt;IndexKey&gt;
</a><a href="#h3-2-12" id="h3-2-12" class="i">+    PostVisit(Regexp* re, intrusive_ptr&lt;IndexKey&gt; parent_arg,
</a><a href="#h3-2-13" id="h3-2-13" class="i">+              intrusive_ptr&lt;IndexKey&gt; pre_arg,
</a><a href="#h3-2-14" id="h3-2-14" class="i">+              intrusive_ptr&lt;IndexKey&gt; *child_args, int nchild_args);
</a> 
<a href="#h3-2-16" id="h3-2-16" class="d">-    virtual shared_ptr&lt;IndexKey&gt;
</a><a href="#h3-2-17" id="h3-2-17" class="i">+    virtual intrusive_ptr&lt;IndexKey&gt;
</a>     ShortVisit(Regexp* re,
<a href="#h3-2-19" id="h3-2-19" class="d">-               shared_ptr&lt;IndexKey&gt; parent_arg);
</a><a href="#h3-2-20" id="h3-2-20" class="i">+               intrusive_ptr&lt;IndexKey&gt; parent_arg);
</a> 
 private:
     IndexWalker(const IndexWalker&amp;);
<a href="#h3-3" id="h3-3" class="h">@@ -73,128 +194,331 @@ private:
</a> };
 
 namespace {
<a href="#h3-3-3" id="h3-3-3" class="i">+    typedef map&lt;pair&lt;intrusive_ptr&lt;IndexKey&gt;, intrusive_ptr&lt;IndexKey&gt; &gt;,
</a><a href="#h3-3-4" id="h3-3-4" class="i">+                intrusive_ptr&lt;IndexKey&gt; &gt; alternate_cache;
</a><a href="#h3-3-5" id="h3-3-5" class="i">+
</a><a href="#h3-3-6" id="h3-3-6" class="i">+    intrusive_ptr&lt;IndexKey&gt; Alternate(alternate_cache&amp;,
</a><a href="#h3-3-7" id="h3-3-7" class="i">+                                   intrusive_ptr&lt;IndexKey&gt;,
</a><a href="#h3-3-8" id="h3-3-8" class="i">+                                   intrusive_ptr&lt;IndexKey&gt;);
</a><a href="#h3-3-9" id="h3-3-9" class="i">+
</a>     string RuneToString(Rune r) {
         char buf[UTFmax];
         int n = runetochar(buf, &amp;r);
         return string(buf, n);
     }
 
<a href="#h3-3-16" id="h3-3-16" class="d">-    shared_ptr&lt;IndexKey&gt; Any() {
</a><a href="#h3-3-17" id="h3-3-17" class="d">-        return shared_ptr&lt;IndexKey&gt;(new IndexKey(kAnchorNone));
</a><a href="#h3-3-18" id="h3-3-18" class="i">+    intrusive_ptr&lt;IndexKey&gt; Any() {
</a><a href="#h3-3-19" id="h3-3-19" class="i">+        return intrusive_ptr&lt;IndexKey&gt;(new IndexKey());
</a>     }
 
<a href="#h3-3-22" id="h3-3-22" class="d">-    shared_ptr&lt;IndexKey&gt; Empty() {
</a><a href="#h3-3-23" id="h3-3-23" class="d">-        return shared_ptr&lt;IndexKey&gt;(new IndexKey(kAnchorBoth));
</a><a href="#h3-3-24" id="h3-3-24" class="i">+    intrusive_ptr&lt;IndexKey&gt; Empty() {
</a><a href="#h3-3-25" id="h3-3-25" class="i">+        return intrusive_ptr&lt;IndexKey&gt;(new IndexKey(kAnchorBoth));
</a>     }
 
<a href="#h3-3-28" id="h3-3-28" class="d">-
</a><a href="#h3-3-29" id="h3-3-29" class="d">-    shared_ptr&lt;IndexKey&gt; Literal(Rune r) {
</a><a href="#h3-3-30" id="h3-3-30" class="d">-        shared_ptr&lt;IndexKey&gt; k(new IndexKey);
</a><a href="#h3-3-31" id="h3-3-31" class="d">-        k-&gt;keys.push_back(RuneToString(r));
</a><a href="#h3-3-32" id="h3-3-32" class="i">+    intrusive_ptr&lt;IndexKey&gt; Literal(string s) {
</a><a href="#h3-3-33" id="h3-3-33" class="i">+        intrusive_ptr&lt;IndexKey&gt; k = 0;
</a><a href="#h3-3-34" id="h3-3-34" class="i">+        for (string::reverse_iterator it = s.rbegin();
</a><a href="#h3-3-35" id="h3-3-35" class="i">+             it != s.rend(); ++it) {
</a><a href="#h3-3-36" id="h3-3-36" class="i">+            k = intrusive_ptr&lt;IndexKey&gt;(new IndexKey(pair&lt;uchar, uchar&gt;(*it, *it), k));
</a><a href="#h3-3-37" id="h3-3-37" class="i">+        }
</a>         k-&gt;anchor = kAnchorBoth;
         return k;
     }
 
<a href="#h3-3-42" id="h3-3-42" class="d">-    shared_ptr&lt;IndexKey&gt; Literal(Rune *runes, int nrunes) {
</a><a href="#h3-3-43" id="h3-3-43" class="d">-        shared_ptr&lt;IndexKey&gt; k(new IndexKey);
</a><a href="#h3-3-44" id="h3-3-44" class="i">+    intrusive_ptr&lt;IndexKey&gt; Literal(Rune r) {
</a><a href="#h3-3-45" id="h3-3-45" class="i">+        return Literal(RuneToString(r));
</a><a href="#h3-3-46" id="h3-3-46" class="i">+    }
</a><a href="#h3-3-47" id="h3-3-47" class="i">+
</a><a href="#h3-3-48" id="h3-3-48" class="i">+    intrusive_ptr&lt;IndexKey&gt; Literal(Rune *runes, int nrunes) {
</a>         string lit;
 
         for (int i = 0; i &lt; nrunes; i++) {
             lit.append(RuneToString(runes[i]));
         }
 
<a href="#h3-3-55" id="h3-3-55" class="d">-        k-&gt;keys.push_back(lit);
</a><a href="#h3-3-56" id="h3-3-56" class="d">-        k-&gt;anchor = kAnchorBoth;
</a><a href="#h3-3-57" id="h3-3-57" class="i">+        return Literal(lit);
</a><a href="#h3-3-58" id="h3-3-58" class="i">+    }
</a> 
<a href="#h3-3-60" id="h3-3-60" class="d">-        return k;
</a><a href="#h3-3-61" id="h3-3-61" class="i">+    intrusive_ptr&lt;IndexKey&gt; LexRange(const string &amp;lo, const string&amp; hi) {
</a><a href="#h3-3-62" id="h3-3-62" class="i">+        intrusive_ptr&lt;IndexKey&gt; out(new IndexKey(kAnchorBoth));
</a><a href="#h3-3-63" id="h3-3-63" class="i">+
</a><a href="#h3-3-64" id="h3-3-64" class="i">+        if (lo.size() == 0 &amp;&amp; hi.size() == 0)
</a><a href="#h3-3-65" id="h3-3-65" class="i">+            return out;
</a><a href="#h3-3-66" id="h3-3-66" class="i">+        if (lo.size() == 0)
</a><a href="#h3-3-67" id="h3-3-67" class="i">+            return Literal(hi);
</a><a href="#h3-3-68" id="h3-3-68" class="i">+        assert(hi.size() != 0);
</a><a href="#h3-3-69" id="h3-3-69" class="i">+        if (lo[0] &lt; hi[0])
</a><a href="#h3-3-70" id="h3-3-70" class="i">+            out-&gt;insert(IndexKey::value_type
</a><a href="#h3-3-71" id="h3-3-71" class="i">+                        (pair&lt;uchar, uchar&gt;(lo[0], hi[0] - 1), 0));
</a><a href="#h3-3-72" id="h3-3-72" class="i">+        out-&gt;insert(IndexKey::value_type
</a><a href="#h3-3-73" id="h3-3-73" class="i">+                    (pair&lt;uchar, uchar&gt;(hi[0], hi[0]),
</a><a href="#h3-3-74" id="h3-3-74" class="i">+                     LexRange(lo.substr(1), hi.substr(1))));
</a><a href="#h3-3-75" id="h3-3-75" class="i">+        return out;
</a>     }
 
<a href="#h3-3-78" id="h3-3-78" class="d">-    shared_ptr&lt;IndexKey&gt; CClass(CharClass *cc) {
</a><a href="#h3-3-79" id="h3-3-79" class="d">-        if (cc-&gt;size() &gt; kMaxFilters)
</a><a href="#h3-3-80" id="h3-3-80" class="i">+    intrusive_ptr&lt;IndexKey&gt; CClass(CharClass *cc) {
</a><a href="#h3-3-81" id="h3-3-81" class="i">+        if (cc-&gt;size() &gt; kMaxWidth)
</a>             return Any();
 
<a href="#h3-3-84" id="h3-3-84" class="d">-        shared_ptr&lt;IndexKey&gt; k(new IndexKey());
</a><a href="#h3-3-85" id="h3-3-85" class="i">+        intrusive_ptr&lt;IndexKey&gt; k(new IndexKey(kAnchorBoth));
</a><a href="#h3-3-86" id="h3-3-86" class="i">+
</a><a href="#h3-3-87" id="h3-3-87" class="i">+        for (CharClass::iterator i = cc-&gt;begin(); i != cc-&gt;end(); ++i) {
</a><a href="#h3-3-88" id="h3-3-88" class="i">+            if (i-&gt;lo &lt; Runeself &amp;&amp; i-&gt;lo &lt; Runeself)
</a><a href="#h3-3-89" id="h3-3-89" class="i">+                k-&gt;insert(IndexKey::value_type
</a><a href="#h3-3-90" id="h3-3-90" class="i">+                          (pair&lt;uchar, uchar&gt;(i-&gt;lo, i-&gt;hi),
</a><a href="#h3-3-91" id="h3-3-91" class="i">+                           0));
</a><a href="#h3-3-92" id="h3-3-92" class="i">+            else {
</a><a href="#h3-3-93" id="h3-3-93" class="i">+                alternate_cache cache;
</a><a href="#h3-3-94" id="h3-3-94" class="i">+                k = Alternate(cache, k, LexRange(RuneToString(i-&gt;lo),
</a><a href="#h3-3-95" id="h3-3-95" class="i">+                                                 RuneToString(i-&gt;hi)));
</a><a href="#h3-3-96" id="h3-3-96" class="i">+            }
</a><a href="#h3-3-97" id="h3-3-97" class="i">+        }
</a><a href="#h3-3-98" id="h3-3-98" class="i">+
</a><a href="#h3-3-99" id="h3-3-99" class="i">+        return k;
</a><a href="#h3-3-100" id="h3-3-100" class="i">+    }
</a> 
<a href="#h3-3-102" id="h3-3-102" class="d">-        for (CharClass::iterator i = cc-&gt;begin(); i != cc-&gt;end(); ++i)
</a><a href="#h3-3-103" id="h3-3-103" class="d">-            for (Rune r = i-&gt;lo; r &lt;= i-&gt;hi; r++)
</a><a href="#h3-3-104" id="h3-3-104" class="d">-                k-&gt;keys.push_back(RuneToString(r));
</a><a href="#h3-3-105" id="h3-3-105" class="i">+    bool ShouldConcat(intrusive_ptr&lt;IndexKey&gt; lhs, intrusive_ptr&lt;IndexKey&gt; rhs) {
</a><a href="#h3-3-106" id="h3-3-106" class="i">+        assert(lhs &amp;&amp; rhs);
</a><a href="#h3-3-107" id="h3-3-107" class="i">+        if (!(lhs-&gt;anchor &amp; kAnchorRight) ||
</a><a href="#h3-3-108" id="h3-3-108" class="i">+            !(rhs-&gt;anchor &amp; kAnchorLeft))
</a><a href="#h3-3-109" id="h3-3-109" class="i">+            return false;
</a><a href="#h3-3-110" id="h3-3-110" class="i">+        if (lhs-&gt;empty())
</a><a href="#h3-3-111" id="h3-3-111" class="i">+            return false;
</a><a href="#h3-3-112" id="h3-3-112" class="i">+        IndexKey::Stats concat = lhs-&gt;stats().concat(rhs-&gt;stats());
</a><a href="#h3-3-113" id="h3-3-113" class="i">+        if (concat.nodes_ &gt;= kMaxNodes)
</a><a href="#h3-3-114" id="h3-3-114" class="i">+            return false;
</a><a href="#h3-3-115" id="h3-3-115" class="i">+        return true;
</a><a href="#h3-3-116" id="h3-3-116" class="i">+    }
</a> 
<a href="#h3-3-118" id="h3-3-118" class="d">-        k-&gt;anchor = kAnchorBoth;
</a><a href="#h3-3-119" id="h3-3-119" class="i">+    intrusive_ptr&lt;IndexKey&gt; Concat(intrusive_ptr&lt;IndexKey&gt; lhs, intrusive_ptr&lt;IndexKey&gt; rhs) {
</a><a href="#h3-3-120" id="h3-3-120" class="i">+        assert(lhs);
</a><a href="#h3-3-121" id="h3-3-121" class="i">+        intrusive_ptr&lt;IndexKey&gt; out = lhs;
</a> 
<a href="#h3-3-123" id="h3-3-123" class="d">-        return k;
</a><a href="#h3-3-124" id="h3-3-124" class="i">+        debug(2, &quot;Concat([%s](%ld), [%s](%ld)) = &quot;,
</a><a href="#h3-3-125" id="h3-3-125" class="i">+              lhs ? lhs-&gt;ToString().c_str() : &quot;&quot;,
</a><a href="#h3-3-126" id="h3-3-126" class="i">+              lhs-&gt;nodes(),
</a><a href="#h3-3-127" id="h3-3-127" class="i">+              rhs ? rhs-&gt;ToString().c_str() : &quot;&quot;,
</a><a href="#h3-3-128" id="h3-3-128" class="i">+              rhs-&gt;nodes());
</a><a href="#h3-3-129" id="h3-3-129" class="i">+
</a><a href="#h3-3-130" id="h3-3-130" class="i">+        if (ShouldConcat(lhs, rhs)) {
</a><a href="#h3-3-131" id="h3-3-131" class="i">+            out-&gt;concat(rhs);
</a><a href="#h3-3-132" id="h3-3-132" class="i">+        } else  {
</a><a href="#h3-3-133" id="h3-3-133" class="i">+            out-&gt;anchor &amp;= ~kAnchorRight;
</a><a href="#h3-3-134" id="h3-3-134" class="i">+        }
</a><a href="#h3-3-135" id="h3-3-135" class="i">+
</a><a href="#h3-3-136" id="h3-3-136" class="i">+        debug(2, &quot;[%s]\n&quot;, out-&gt;ToString().c_str());
</a><a href="#h3-3-137" id="h3-3-137" class="i">+
</a><a href="#h3-3-138" id="h3-3-138" class="i">+        return out;
</a>     }
 
<a href="#h3-3-141" id="h3-3-141" class="d">-    shared_ptr&lt;IndexKey&gt; Concat(shared_ptr&lt;IndexKey&gt; lhs, shared_ptr&lt;IndexKey&gt; rhs) {
</a><a href="#h3-3-142" id="h3-3-142" class="d">-        shared_ptr&lt;IndexKey&gt; out = 0;
</a><a href="#h3-3-143" id="h3-3-143" class="d">-
</a><a href="#h3-3-144" id="h3-3-144" class="d">-        debug(&quot;Concat([%s](%d), [%s](%d)) = &quot;,
</a><a href="#h3-3-145" id="h3-3-145" class="d">-               lhs-&gt;ToString().c_str(),
</a><a href="#h3-3-146" id="h3-3-146" class="d">-               lhs-&gt;weight(),
</a><a href="#h3-3-147" id="h3-3-147" class="d">-               rhs-&gt;ToString().c_str(),
</a><a href="#h3-3-148" id="h3-3-148" class="d">-               rhs-&gt;weight());
</a><a href="#h3-3-149" id="h3-3-149" class="d">-
</a><a href="#h3-3-150" id="h3-3-150" class="d">-        if ((lhs-&gt;anchor &amp; kAnchorRight) &amp;&amp;
</a><a href="#h3-3-151" id="h3-3-151" class="d">-            (rhs-&gt;anchor &amp; kAnchorLeft) &amp;&amp;
</a><a href="#h3-3-152" id="h3-3-152" class="d">-            lhs-&gt;keys.size() &amp;&amp; rhs-&gt;keys.size() &amp;&amp;
</a><a href="#h3-3-153" id="h3-3-153" class="d">-            lhs-&gt;keys.size() * rhs-&gt;keys.size() &lt;= kMaxFilters) {
</a><a href="#h3-3-154" id="h3-3-154" class="d">-            out = shared_ptr&lt;IndexKey&gt;(new IndexKey);
</a><a href="#h3-3-155" id="h3-3-155" class="d">-            for (vector&lt;string&gt;::iterator lit = lhs-&gt;keys.begin();
</a><a href="#h3-3-156" id="h3-3-156" class="d">-                 lit != lhs-&gt;keys.end(); ++lit)
</a><a href="#h3-3-157" id="h3-3-157" class="d">-                for (vector&lt;string&gt;::iterator rit = rhs-&gt;keys.begin();
</a><a href="#h3-3-158" id="h3-3-158" class="d">-                     rit != rhs-&gt;keys.end(); ++rit)
</a><a href="#h3-3-159" id="h3-3-159" class="d">-                    out-&gt;keys.push_back(*lit + *rit);
</a><a href="#h3-3-160" id="h3-3-160" class="d">-            if ((lhs-&gt;anchor &amp; (kAnchorRepeat|kAnchorLeft)) == kAnchorLeft)
</a><a href="#h3-3-161" id="h3-3-161" class="d">-                out-&gt;anchor |= kAnchorLeft;
</a><a href="#h3-3-162" id="h3-3-162" class="d">-            if ((rhs-&gt;anchor &amp; (kAnchorRepeat|kAnchorRight)) == kAnchorRight)
</a><a href="#h3-3-163" id="h3-3-163" class="d">-                out-&gt;anchor |= kAnchorRight;
</a><a href="#h3-3-164" id="h3-3-164" class="i">+    IndexKey::Stats TryConcat(intrusive_ptr&lt;IndexKey&gt; *start,
</a><a href="#h3-3-165" id="h3-3-165" class="i">+                              intrusive_ptr&lt;IndexKey&gt; *end) {
</a><a href="#h3-3-166" id="h3-3-166" class="i">+        IndexKey::Stats st = (*start)-&gt;stats();
</a><a href="#h3-3-167" id="h3-3-167" class="i">+        debug(4, &quot;TryConcat: Searching suffix of length %ld\n&quot;,
</a><a href="#h3-3-168" id="h3-3-168" class="i">+              end - start);
</a><a href="#h3-3-169" id="h3-3-169" class="i">+        if (!*start || !((*start)-&gt;anchor &amp; kAnchorRight) || (*start)-&gt;empty()) {
</a><a href="#h3-3-170" id="h3-3-170" class="i">+            debug(4, &quot;!ConcatRight, returning early.\n&quot;);
</a><a href="#h3-3-171" id="h3-3-171" class="i">+            return st;
</a>         }
<a href="#h3-3-173" id="h3-3-173" class="i">+        for (intrusive_ptr&lt;IndexKey&gt; *ptr = start + 1; ptr != end; ptr++) {
</a><a href="#h3-3-174" id="h3-3-174" class="i">+            if (!*(ptr) || !((*ptr)-&gt;anchor &amp; kAnchorLeft))
</a><a href="#h3-3-175" id="h3-3-175" class="i">+                break;
</a> 
<a href="#h3-3-177" id="h3-3-177" class="d">-        if (!out || lhs-&gt;weight() &gt; out-&gt;weight()) {
</a><a href="#h3-3-178" id="h3-3-178" class="d">-            out = lhs;
</a><a href="#h3-3-179" id="h3-3-179" class="d">-            out-&gt;anchor &amp;= ~kAnchorRight;
</a><a href="#h3-3-180" id="h3-3-180" class="i">+            st = st.concat((*ptr)-&gt;stats());
</a><a href="#h3-3-181" id="h3-3-181" class="i">+
</a><a href="#h3-3-182" id="h3-3-182" class="i">+            if (st.nodes_ &gt;= kMaxNodes)
</a><a href="#h3-3-183" id="h3-3-183" class="i">+                break;
</a><a href="#h3-3-184" id="h3-3-184" class="i">+            if (((*ptr)-&gt;anchor &amp; (kAnchorRepeat|kAnchorRight)) != kAnchorRight)
</a><a href="#h3-3-185" id="h3-3-185" class="i">+                break;
</a>         }
<a href="#h3-3-187" id="h3-3-187" class="i">+        debug(4, &quot;TryConcat: nodes=%ld, selectivity=%f\n&quot;,
</a><a href="#h3-3-188" id="h3-3-188" class="i">+              st.nodes_, st.selectivity_);
</a><a href="#h3-3-189" id="h3-3-189" class="i">+        return st;
</a><a href="#h3-3-190" id="h3-3-190" class="i">+    }
</a> 
<a href="#h3-3-192" id="h3-3-192" class="d">-        if (rhs-&gt;weight() &gt; out-&gt;weight()) {
</a><a href="#h3-3-193" id="h3-3-193" class="d">-            out = rhs;
</a><a href="#h3-3-194" id="h3-3-194" class="d">-            out-&gt;anchor &amp;= ~kAnchorLeft;
</a><a href="#h3-3-195" id="h3-3-195" class="i">+    bool Prefer(const IndexKey::Stats&amp; lhs,
</a><a href="#h3-3-196" id="h3-3-196" class="i">+                const IndexKey::Stats&amp; rhs) {
</a><a href="#h3-3-197" id="h3-3-197" class="i">+        return (lhs.selectivity_ &lt; rhs.selectivity_);
</a><a href="#h3-3-198" id="h3-3-198" class="i">+        /*
</a><a href="#h3-3-199" id="h3-3-199" class="i">+        return (kRECost * lhs.selectivity_ + kNodeCost * lhs.nodes_ &lt;
</a><a href="#h3-3-200" id="h3-3-200" class="i">+                kRECost * rhs.selectivity_ + kNodeCost * rhs.nodes_);
</a><a href="#h3-3-201" id="h3-3-201" class="i">+        */
</a><a href="#h3-3-202" id="h3-3-202" class="i">+    }
</a><a href="#h3-3-203" id="h3-3-203" class="i">+
</a><a href="#h3-3-204" id="h3-3-204" class="i">+    intrusive_ptr&lt;IndexKey&gt; Concat(intrusive_ptr&lt;IndexKey&gt; *children,
</a><a href="#h3-3-205" id="h3-3-205" class="i">+                                int nchildren) {
</a><a href="#h3-3-206" id="h3-3-206" class="i">+        intrusive_ptr&lt;IndexKey&gt; *end = children + nchildren, *best_start = 0, *ptr;
</a><a href="#h3-3-207" id="h3-3-207" class="i">+        IndexKey::Stats best_stats;
</a><a href="#h3-3-208" id="h3-3-208" class="i">+
</a><a href="#h3-3-209" id="h3-3-209" class="i">+        debug(3, &quot;Concat: Searching %d positions\n&quot;, nchildren);
</a><a href="#h3-3-210" id="h3-3-210" class="i">+        for (ptr = children; ptr != end; ptr++) {
</a><a href="#h3-3-211" id="h3-3-211" class="i">+            IndexKey::Stats st = TryConcat(ptr, end);
</a><a href="#h3-3-212" id="h3-3-212" class="i">+            if (st.nodes_ &gt; 1 &amp;&amp; Prefer(st, best_stats)) {
</a><a href="#h3-3-213" id="h3-3-213" class="i">+                debug(3, &quot;Concat: Found new best: %ld: %f\n&quot;,
</a><a href="#h3-3-214" id="h3-3-214" class="i">+                      ptr - children, st.selectivity_);
</a><a href="#h3-3-215" id="h3-3-215" class="i">+                best_start = ptr;
</a><a href="#h3-3-216" id="h3-3-216" class="i">+                best_stats = st;
</a><a href="#h3-3-217" id="h3-3-217" class="i">+            }
</a>         }
 
<a href="#h3-3-220" id="h3-3-220" class="d">-        debug(&quot;[%s]\n&quot;, out-&gt;ToString().c_str());
</a><a href="#h3-3-221" id="h3-3-221" class="i">+        if (best_start == 0) {
</a><a href="#h3-3-222" id="h3-3-222" class="i">+            debug(3, &quot;Concat: No good results found.\n&quot;);
</a><a href="#h3-3-223" id="h3-3-223" class="i">+            return Any();
</a><a href="#h3-3-224" id="h3-3-224" class="i">+        }
</a> 
<a href="#h3-3-226" id="h3-3-226" class="i">+        intrusive_ptr&lt;IndexKey&gt; out = *best_start;
</a><a href="#h3-3-227" id="h3-3-227" class="i">+        for (ptr = best_start + 1; ptr != end; ptr++) {
</a><a href="#h3-3-228" id="h3-3-228" class="i">+            out = Concat(out, *ptr);
</a><a href="#h3-3-229" id="h3-3-229" class="i">+        }
</a>         return out;
     }
 
<a href="#h3-3-233" id="h3-3-233" class="d">-    shared_ptr&lt;IndexKey&gt; Alternate(shared_ptr&lt;IndexKey&gt; lhs, shared_ptr&lt;IndexKey&gt; rhs) {
</a><a href="#h3-3-234" id="h3-3-234" class="d">-        if (lhs-&gt;keys.size() &amp;&amp; rhs-&gt;keys.size() &amp;&amp;
</a><a href="#h3-3-235" id="h3-3-235" class="d">-            lhs-&gt;keys.size() + rhs-&gt;keys.size() &lt; kMaxFilters) {
</a><a href="#h3-3-236" id="h3-3-236" class="d">-            lhs-&gt;keys.insert(lhs-&gt;keys.end(), rhs-&gt;keys.begin(), rhs-&gt;keys.end());
</a><a href="#h3-3-237" id="h3-3-237" class="d">-            lhs-&gt;anchor = (lhs-&gt;anchor &amp; rhs-&gt;anchor) |
</a><a href="#h3-3-238" id="h3-3-238" class="d">-                ((lhs-&gt;anchor | lhs-&gt;anchor) &amp; kAnchorRepeat);
</a><a href="#h3-3-239" id="h3-3-239" class="i">+    bool intersects(const pair&lt;uchar, uchar&gt;&amp; left,
</a><a href="#h3-3-240" id="h3-3-240" class="i">+                    const pair&lt;uchar, uchar&gt;&amp; right) {
</a><a href="#h3-3-241" id="h3-3-241" class="i">+        if (left.first &lt;= right.first)
</a><a href="#h3-3-242" id="h3-3-242" class="i">+            return left.second &gt;= right.first;
</a><a href="#h3-3-243" id="h3-3-243" class="i">+        else
</a><a href="#h3-3-244" id="h3-3-244" class="i">+            return right.second &gt;= left.first;
</a><a href="#h3-3-245" id="h3-3-245" class="i">+    }
</a><a href="#h3-3-246" id="h3-3-246" class="i">+
</a><a href="#h3-3-247" id="h3-3-247" class="i">+    enum {
</a><a href="#h3-3-248" id="h3-3-248" class="i">+        kTakeLeft  = 0x01,
</a><a href="#h3-3-249" id="h3-3-249" class="i">+        kTakeRight = 0x02,
</a><a href="#h3-3-250" id="h3-3-250" class="i">+        kTakeBoth  = 0x03
</a><a href="#h3-3-251" id="h3-3-251" class="i">+    };
</a><a href="#h3-3-252" id="h3-3-252" class="i">+
</a><a href="#h3-3-253" id="h3-3-253" class="i">+    int Merge(alternate_cache&amp; cache,
</a><a href="#h3-3-254" id="h3-3-254" class="i">+              intrusive_ptr&lt;IndexKey&gt; out,
</a><a href="#h3-3-255" id="h3-3-255" class="i">+              pair&lt;uchar, uchar&gt;&amp; left,
</a><a href="#h3-3-256" id="h3-3-256" class="i">+              intrusive_ptr&lt;IndexKey&gt; lnext,
</a><a href="#h3-3-257" id="h3-3-257" class="i">+              pair&lt;uchar, uchar&gt;&amp; right,
</a><a href="#h3-3-258" id="h3-3-258" class="i">+              intrusive_ptr&lt;IndexKey&gt; rnext) {
</a><a href="#h3-3-259" id="h3-3-259" class="i">+        if (intersects(left, right)) {
</a><a href="#h3-3-260" id="h3-3-260" class="i">+            debug(3, &quot;Processing intersection: &lt;%hhx,%hhx&gt; vs. &lt;%hhx,%hhx&gt;\n&quot;,
</a><a href="#h3-3-261" id="h3-3-261" class="i">+                  left.first, left.second, right.first, right.second);
</a><a href="#h3-3-262" id="h3-3-262" class="i">+            if (left.first &lt; right.first) {
</a><a href="#h3-3-263" id="h3-3-263" class="i">+                out-&gt;insert
</a><a href="#h3-3-264" id="h3-3-264" class="i">+                    (make_pair(make_pair(left.first,
</a><a href="#h3-3-265" id="h3-3-265" class="i">+                                         right.first - 1),
</a><a href="#h3-3-266" id="h3-3-266" class="i">+                               lnext));
</a><a href="#h3-3-267" id="h3-3-267" class="i">+                left.first = right.first;
</a><a href="#h3-3-268" id="h3-3-268" class="i">+            } else if (right.first &lt; left.first) {
</a><a href="#h3-3-269" id="h3-3-269" class="i">+                out-&gt;insert
</a><a href="#h3-3-270" id="h3-3-270" class="i">+                    (make_pair(make_pair(right.first,
</a><a href="#h3-3-271" id="h3-3-271" class="i">+                                         left.first - 1),
</a><a href="#h3-3-272" id="h3-3-272" class="i">+                               rnext));
</a><a href="#h3-3-273" id="h3-3-273" class="i">+                right.first = left.first;
</a><a href="#h3-3-274" id="h3-3-274" class="i">+            }
</a><a href="#h3-3-275" id="h3-3-275" class="i">+            /* left and right now start at the same location */
</a><a href="#h3-3-276" id="h3-3-276" class="i">+            assert(left.first == right.first);
</a><a href="#h3-3-277" id="h3-3-277" class="i">+
</a><a href="#h3-3-278" id="h3-3-278" class="i">+            uchar end = min(left.second, right.second);
</a><a href="#h3-3-279" id="h3-3-279" class="i">+            out-&gt;insert
</a><a href="#h3-3-280" id="h3-3-280" class="i">+                (make_pair(make_pair(left.first, end),
</a><a href="#h3-3-281" id="h3-3-281" class="i">+                           Alternate(cache, lnext, rnext)));
</a><a href="#h3-3-282" id="h3-3-282" class="i">+            if (left.second &gt; end) {
</a><a href="#h3-3-283" id="h3-3-283" class="i">+                left.first = end+1;
</a><a href="#h3-3-284" id="h3-3-284" class="i">+                return kTakeRight;
</a><a href="#h3-3-285" id="h3-3-285" class="i">+            } else if (right.second &gt; end) {
</a><a href="#h3-3-286" id="h3-3-286" class="i">+                right.first = end+1;
</a><a href="#h3-3-287" id="h3-3-287" class="i">+                return kTakeLeft;
</a><a href="#h3-3-288" id="h3-3-288" class="i">+            }
</a><a href="#h3-3-289" id="h3-3-289" class="i">+            return kTakeBoth;
</a><a href="#h3-3-290" id="h3-3-290" class="i">+        }
</a><a href="#h3-3-291" id="h3-3-291" class="i">+        /* Non-intersecting */
</a><a href="#h3-3-292" id="h3-3-292" class="i">+        if (left.first &lt; right.first) {
</a><a href="#h3-3-293" id="h3-3-293" class="i">+            out-&gt;insert(make_pair(left, lnext));
</a><a href="#h3-3-294" id="h3-3-294" class="i">+            return kTakeLeft;
</a><a href="#h3-3-295" id="h3-3-295" class="i">+        }
</a><a href="#h3-3-296" id="h3-3-296" class="i">+        assert(right.first &lt; left.first);
</a><a href="#h3-3-297" id="h3-3-297" class="i">+        out-&gt;insert(make_pair(right, rnext));
</a><a href="#h3-3-298" id="h3-3-298" class="i">+        return kTakeRight;
</a><a href="#h3-3-299" id="h3-3-299" class="i">+    }
</a> 
<a href="#h3-3-301" id="h3-3-301" class="i">+    intrusive_ptr&lt;IndexKey&gt; AlternateInternal(alternate_cache&amp; cache,
</a><a href="#h3-3-302" id="h3-3-302" class="i">+                                           intrusive_ptr&lt;IndexKey&gt; lhs,
</a><a href="#h3-3-303" id="h3-3-303" class="i">+                                           intrusive_ptr&lt;IndexKey&gt; rhs) {
</a><a href="#h3-3-304" id="h3-3-304" class="i">+        if (lhs == rhs)
</a>             return lhs;
<a href="#h3-3-306" id="h3-3-306" class="i">+        if (lhs-&gt;empty() || rhs-&gt;empty() ||
</a><a href="#h3-3-307" id="h3-3-307" class="i">+            lhs-&gt;size() + rhs-&gt;size() &gt;= kMaxWidth)
</a><a href="#h3-3-308" id="h3-3-308" class="i">+            return Any();
</a><a href="#h3-3-309" id="h3-3-309" class="i">+
</a><a href="#h3-3-310" id="h3-3-310" class="i">+        static int recursion_depth = 0;
</a><a href="#h3-3-311" id="h3-3-311" class="i">+        RecursionCounter guard(recursion_depth);
</a><a href="#h3-3-312" id="h3-3-312" class="i">+        if (recursion_depth &gt; kMaxRecursion)
</a><a href="#h3-3-313" id="h3-3-313" class="i">+            return Any();
</a><a href="#h3-3-314" id="h3-3-314" class="i">+
</a><a href="#h3-3-315" id="h3-3-315" class="i">+        intrusive_ptr&lt;IndexKey&gt; out(new IndexKey
</a><a href="#h3-3-316" id="h3-3-316" class="i">+                                 ((lhs-&gt;anchor &amp; rhs-&gt;anchor) |
</a><a href="#h3-3-317" id="h3-3-317" class="i">+                                  ((lhs-&gt;anchor | lhs-&gt;anchor) &amp; kAnchorRepeat)));
</a><a href="#h3-3-318" id="h3-3-318" class="i">+        IndexKey::const_iterator lit, rit;
</a><a href="#h3-3-319" id="h3-3-319" class="i">+        lit = lhs-&gt;begin();
</a><a href="#h3-3-320" id="h3-3-320" class="i">+        rit = rhs-&gt;begin();
</a><a href="#h3-3-321" id="h3-3-321" class="i">+        pair&lt;uchar, uchar&gt; left;
</a><a href="#h3-3-322" id="h3-3-322" class="i">+        if (lit != lhs-&gt;end())
</a><a href="#h3-3-323" id="h3-3-323" class="i">+            left = lit-&gt;first;
</a><a href="#h3-3-324" id="h3-3-324" class="i">+        pair&lt;uchar, uchar&gt; right = rit-&gt;first;
</a><a href="#h3-3-325" id="h3-3-325" class="i">+        if (rit != rhs-&gt;end())
</a><a href="#h3-3-326" id="h3-3-326" class="i">+            right = rit-&gt;first;
</a><a href="#h3-3-327" id="h3-3-327" class="i">+        while (lit != lhs-&gt;end() &amp;&amp; rit != rhs-&gt;end()) {
</a><a href="#h3-3-328" id="h3-3-328" class="i">+            int action = Merge(cache, out, left, lit-&gt;second, right, rit-&gt;second);
</a><a href="#h3-3-329" id="h3-3-329" class="i">+            if (action &amp; kTakeLeft)
</a><a href="#h3-3-330" id="h3-3-330" class="i">+                if (++lit != lhs-&gt;end())
</a><a href="#h3-3-331" id="h3-3-331" class="i">+                    left = lit-&gt;first;
</a><a href="#h3-3-332" id="h3-3-332" class="i">+            if (action &amp; kTakeRight)
</a><a href="#h3-3-333" id="h3-3-333" class="i">+                if (++rit != rhs-&gt;end())
</a><a href="#h3-3-334" id="h3-3-334" class="i">+                    right = rit-&gt;first;
</a>         }
 
<a href="#h3-3-337" id="h3-3-337" class="d">-        return Any();
</a><a href="#h3-3-338" id="h3-3-338" class="i">+        if (lit != lhs-&gt;end()) {
</a><a href="#h3-3-339" id="h3-3-339" class="i">+            out-&gt;insert(make_pair(left, lit-&gt;second));
</a><a href="#h3-3-340" id="h3-3-340" class="i">+            ++lit;
</a><a href="#h3-3-341" id="h3-3-341" class="i">+        }
</a><a href="#h3-3-342" id="h3-3-342" class="i">+        if (rit != rhs-&gt;end()) {
</a><a href="#h3-3-343" id="h3-3-343" class="i">+            out-&gt;insert(make_pair(right, rit-&gt;second));
</a><a href="#h3-3-344" id="h3-3-344" class="i">+            ++rit;
</a><a href="#h3-3-345" id="h3-3-345" class="i">+        }
</a><a href="#h3-3-346" id="h3-3-346" class="i">+
</a><a href="#h3-3-347" id="h3-3-347" class="i">+        for (; lit != lhs-&gt;end(); ++lit)
</a><a href="#h3-3-348" id="h3-3-348" class="i">+            out-&gt;insert(*lit);
</a><a href="#h3-3-349" id="h3-3-349" class="i">+        for (; rit != rhs-&gt;end(); ++rit)
</a><a href="#h3-3-350" id="h3-3-350" class="i">+            out-&gt;insert(*rit);
</a><a href="#h3-3-351" id="h3-3-351" class="i">+
</a><a href="#h3-3-352" id="h3-3-352" class="i">+        return out;
</a><a href="#h3-3-353" id="h3-3-353" class="i">+    }
</a><a href="#h3-3-354" id="h3-3-354" class="i">+
</a><a href="#h3-3-355" id="h3-3-355" class="i">+    intrusive_ptr&lt;IndexKey&gt; Alternate(alternate_cache&amp; cache,
</a><a href="#h3-3-356" id="h3-3-356" class="i">+                                   intrusive_ptr&lt;IndexKey&gt; lhs,
</a><a href="#h3-3-357" id="h3-3-357" class="i">+                                   intrusive_ptr&lt;IndexKey&gt; rhs) {
</a><a href="#h3-3-358" id="h3-3-358" class="i">+        auto it = cache.find(make_pair(lhs, rhs));
</a><a href="#h3-3-359" id="h3-3-359" class="i">+        if (it != cache.end())
</a><a href="#h3-3-360" id="h3-3-360" class="i">+            return it-&gt;second;
</a><a href="#h3-3-361" id="h3-3-361" class="i">+        intrusive_ptr&lt;IndexKey&gt; out = AlternateInternal(cache, lhs, rhs);
</a><a href="#h3-3-362" id="h3-3-362" class="i">+        cache[make_pair(lhs, rhs)] = out;
</a><a href="#h3-3-363" id="h3-3-363" class="i">+        return out;
</a>     }
 
 };
 
<a href="#h3-3-368" id="h3-3-368" class="d">-shared_ptr&lt;IndexKey&gt; indexRE(const re2::RE2 &amp;re) {
</a><a href="#h3-3-369" id="h3-3-369" class="i">+intrusive_ptr&lt;IndexKey&gt; indexRE(const re2::RE2 &amp;re) {
</a>     IndexWalker walk;
 
<a href="#h3-3-372" id="h3-3-372" class="d">-    shared_ptr&lt;IndexKey&gt; key = walk.Walk(re.Regexp(), 0);
</a><a href="#h3-3-373" id="h3-3-373" class="i">+    Regexp *sre = re.Regexp()-&gt;Simplify();
</a><a href="#h3-3-374" id="h3-3-374" class="i">+    intrusive_ptr&lt;IndexKey&gt; key = walk.WalkExponential(sre, 0, 10000);
</a><a href="#h3-3-375" id="h3-3-375" class="i">+    sre-&gt;Decref();
</a> 
<a href="#h3-3-377" id="h3-3-377" class="d">-    if (key-&gt;weight() &lt; kMinWeight)
</a><a href="#h3-3-378" id="h3-3-378" class="d">-        key-&gt;keys.clear();
</a><a href="#h3-3-379" id="h3-3-379" class="i">+    if (key &amp;&amp; key-&gt;weight() &lt; kMinWeight)
</a><a href="#h3-3-380" id="h3-3-380" class="i">+        key = 0;
</a>     return key;
 }
 
<a href="#h3-3-384" id="h3-3-384" class="d">-shared_ptr&lt;IndexKey&gt;
</a><a href="#h3-3-385" id="h3-3-385" class="d">-IndexWalker::PostVisit(Regexp* re, shared_ptr&lt;IndexKey&gt; parent_arg,
</a><a href="#h3-3-386" id="h3-3-386" class="d">-                       shared_ptr&lt;IndexKey&gt; pre_arg,
</a><a href="#h3-3-387" id="h3-3-387" class="d">-                       shared_ptr&lt;IndexKey&gt; *child_args,
</a><a href="#h3-3-388" id="h3-3-388" class="i">+intrusive_ptr&lt;IndexKey&gt;
</a><a href="#h3-3-389" id="h3-3-389" class="i">+IndexWalker::PostVisit(Regexp* re, intrusive_ptr&lt;IndexKey&gt; parent_arg,
</a><a href="#h3-3-390" id="h3-3-390" class="i">+                       intrusive_ptr&lt;IndexKey&gt; pre_arg,
</a><a href="#h3-3-391" id="h3-3-391" class="i">+                       intrusive_ptr&lt;IndexKey&gt; *child_args,
</a>                        int nchild_args) {
<a href="#h3-3-393" id="h3-3-393" class="d">-    shared_ptr&lt;IndexKey&gt; key;
</a><a href="#h3-3-394" id="h3-3-394" class="i">+    intrusive_ptr&lt;IndexKey&gt; key;
</a> 
     switch (re-&gt;op()) {
     case kRegexpNoMatch:
<a href="#h3-4" id="h3-4" class="h">@@ -226,15 +550,16 @@ IndexWalker::PostVisit(Regexp* re, shared_ptr&lt;IndexKey&gt; parent_arg,
</a>         break;
 
     case kRegexpConcat:
<a href="#h3-4-3" id="h3-4-3" class="d">-        key = Empty();
</a><a href="#h3-4-4" id="h3-4-4" class="d">-        for (int i = 0; i &lt; nchild_args; i++)
</a><a href="#h3-4-5" id="h3-4-5" class="d">-            key = Concat(key, child_args[i]);
</a><a href="#h3-4-6" id="h3-4-6" class="i">+        key = Concat(child_args, nchild_args);
</a>         break;
 
     case kRegexpAlternate:
<a href="#h3-4-10" id="h3-4-10" class="d">-        key = child_args[0];
</a><a href="#h3-4-11" id="h3-4-11" class="d">-        for (int i = 1; i &lt; nchild_args; i++)
</a><a href="#h3-4-12" id="h3-4-12" class="d">-            key = Alternate(key, child_args[i]);
</a><a href="#h3-4-13" id="h3-4-13" class="i">+        {
</a><a href="#h3-4-14" id="h3-4-14" class="i">+            alternate_cache cache;
</a><a href="#h3-4-15" id="h3-4-15" class="i">+            key = child_args[0];
</a><a href="#h3-4-16" id="h3-4-16" class="i">+            for (int i = 1; i &lt; nchild_args; i++)
</a><a href="#h3-4-17" id="h3-4-17" class="i">+                key = Alternate(cache, key, child_args[i]);
</a><a href="#h3-4-18" id="h3-4-18" class="i">+        }
</a>         break;
 
     case kRegexpStar:
<a href="#h3-5" id="h3-5" class="h">@@ -259,15 +584,42 @@ IndexWalker::PostVisit(Regexp* re, shared_ptr&lt;IndexKey&gt; parent_arg,
</a>         assert(false);
     }
 
<a href="#h3-5-3" id="h3-5-3" class="d">-    debug(&quot; %s -&gt; [%s](%d)\n&quot;,
</a><a href="#h3-5-4" id="h3-5-4" class="d">-          re-&gt;ToString().c_str(),
</a><a href="#h3-5-5" id="h3-5-5" class="d">-          key-&gt;ToString().c_str(),
</a><a href="#h3-5-6" id="h3-5-6" class="d">-          key-&gt;weight());
</a><a href="#h3-5-7" id="h3-5-7" class="i">+    assert(key);
</a><a href="#h3-5-8" id="h3-5-8" class="i">+
</a><a href="#h3-5-9" id="h3-5-9" class="i">+    debug(1, &quot;* INDEX %s ==&gt; &quot;, re-&gt;ToString().c_str());
</a><a href="#h3-5-10" id="h3-5-10" class="i">+    if (key)
</a><a href="#h3-5-11" id="h3-5-11" class="i">+        debug(1, &quot;[weight %d, nodes %ld, depth %d]\n&quot;,
</a><a href="#h3-5-12" id="h3-5-12" class="i">+              key-&gt;weight(), key-&gt;nodes(), key-&gt;depth());
</a><a href="#h3-5-13" id="h3-5-13" class="i">+    else
</a><a href="#h3-5-14" id="h3-5-14" class="i">+        debug(1, &quot;nul\n&quot;);
</a><a href="#h3-5-15" id="h3-5-15" class="i">+
</a><a href="#h3-5-16" id="h3-5-16" class="i">+    debug(2, &quot;           ==&gt; [%s]\n&quot;,
</a><a href="#h3-5-17" id="h3-5-17" class="i">+          key ? key-&gt;ToString().c_str() : &quot;nul&quot;);
</a><a href="#h3-5-18" id="h3-5-18" class="i">+
</a><a href="#h3-5-19" id="h3-5-19" class="i">+    if (FLAGS_debug_index &amp;&amp; key)
</a><a href="#h3-5-20" id="h3-5-20" class="i">+        key-&gt;check_rep();
</a> 
     return key;
 }
 
<a href="#h3-5-25" id="h3-5-25" class="d">-shared_ptr&lt;IndexKey&gt;
</a><a href="#h3-5-26" id="h3-5-26" class="d">-IndexWalker::ShortVisit(Regexp* re, shared_ptr&lt;IndexKey&gt; parent_arg) {
</a><a href="#h3-5-27" id="h3-5-27" class="i">+intrusive_ptr&lt;IndexKey&gt;
</a><a href="#h3-5-28" id="h3-5-28" class="i">+IndexWalker::ShortVisit(Regexp* re, intrusive_ptr&lt;IndexKey&gt; parent_arg) {
</a>     return Any();
 }
<a href="#h3-5-31" id="h3-5-31" class="i">+
</a><a href="#h3-5-32" id="h3-5-32" class="i">+void IndexKey::check_rep() {
</a><a href="#h3-5-33" id="h3-5-33" class="i">+    pair&lt;uchar, uchar&gt; last = make_pair(&#39;\0&#39;, &#39;\0&#39;);
</a><a href="#h3-5-34" id="h3-5-34" class="i">+    for (iterator it = begin(); it != end(); ++it) {
</a><a href="#h3-5-35" id="h3-5-35" class="i">+        assert(!intersects(last, it-&gt;first));
</a><a href="#h3-5-36" id="h3-5-36" class="i">+        last = it-&gt;first;
</a><a href="#h3-5-37" id="h3-5-37" class="i">+    }
</a><a href="#h3-5-38" id="h3-5-38" class="i">+}
</a><a href="#h3-5-39" id="h3-5-39" class="i">+
</a><a href="#h3-5-40" id="h3-5-40" class="i">+void intrusive_ptr_add_ref(IndexKey *key) {
</a><a href="#h3-5-41" id="h3-5-41" class="i">+    ++key-&gt;refs_;
</a><a href="#h3-5-42" id="h3-5-42" class="i">+}
</a><a href="#h3-5-43" id="h3-5-43" class="i">+
</a><a href="#h3-5-44" id="h3-5-44" class="i">+void intrusive_ptr_release(IndexKey *key) {
</a><a href="#h3-5-45" id="h3-5-45" class="i">+    if (--key-&gt;refs_ == 0)
</a><a href="#h3-5-46" id="h3-5-46" class="i">+        delete key;
</a><a href="#h3-5-47" id="h3-5-47" class="i">+}
</a><b>diff --git a/<a id="h4" href="../file/indexer.h">indexer.h</a> b/<a href="../file/indexer.h">indexer.h</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -2,15 +2,20 @@
</a> #define CODESEARCH_INDEXER_H
 
 #include &lt;vector&gt;
<a href="#h4-0-3" id="h4-0-3" class="i">+#include &lt;list&gt;
</a> #include &lt;string&gt;
<a href="#h4-0-5" id="h4-0-5" class="d">-#include &lt;memory&gt;
</a><a href="#h4-0-6" id="h4-0-6" class="i">+#include &lt;boost/intrusive_ptr.hpp&gt;
</a> 
 #include &quot;re2/re2.h&quot;
 #include &quot;re2/walker-inl.h&quot;
 
<a href="#h4-0-11" id="h4-0-11" class="i">+#include &quot;atomic.h&quot;
</a><a href="#h4-0-12" id="h4-0-12" class="i">+#include &quot;common.h&quot;
</a><a href="#h4-0-13" id="h4-0-13" class="i">+
</a> using std::string;
 using std::vector;
<a href="#h4-0-16" id="h4-0-16" class="d">-using std::shared_ptr;
</a><a href="#h4-0-17" id="h4-0-17" class="i">+using std::list;
</a><a href="#h4-0-18" id="h4-0-18" class="i">+using boost::intrusive_ptr;
</a> 
 enum {
     kAnchorNone   = 0x00,
<a href="#h4-1" id="h4-1" class="h">@@ -20,11 +25,56 @@ enum {
</a>     kAnchorRepeat = 0x04
 };
 
<a href="#h4-1-3" id="h4-1-3" class="d">-struct IndexKey {
</a><a href="#h4-1-4" id="h4-1-4" class="d">-    vector&lt;string&gt; keys;
</a><a href="#h4-1-5" id="h4-1-5" class="d">-    int anchor;
</a><a href="#h4-1-6" id="h4-1-6" class="i">+class IndexKey {
</a><a href="#h4-1-7" id="h4-1-7" class="i">+public:
</a><a href="#h4-1-8" id="h4-1-8" class="i">+    typedef map&lt;pair&lt;uchar, uchar&gt;, intrusive_ptr&lt;IndexKey&gt; &gt;::iterator iterator;
</a><a href="#h4-1-9" id="h4-1-9" class="i">+    typedef map&lt;pair&lt;uchar, uchar&gt;, intrusive_ptr&lt;IndexKey&gt; &gt;::const_iterator const_iterator;
</a><a href="#h4-1-10" id="h4-1-10" class="i">+    typedef pair&lt;pair&lt;uchar, uchar&gt;, intrusive_ptr&lt;IndexKey&gt; &gt; value_type;
</a><a href="#h4-1-11" id="h4-1-11" class="i">+
</a><a href="#h4-1-12" id="h4-1-12" class="i">+    iterator begin() {
</a><a href="#h4-1-13" id="h4-1-13" class="i">+        return edges_.begin();
</a><a href="#h4-1-14" id="h4-1-14" class="i">+    }
</a><a href="#h4-1-15" id="h4-1-15" class="i">+
</a><a href="#h4-1-16" id="h4-1-16" class="i">+    iterator end() {
</a><a href="#h4-1-17" id="h4-1-17" class="i">+        return edges_.end();
</a><a href="#h4-1-18" id="h4-1-18" class="i">+    }
</a><a href="#h4-1-19" id="h4-1-19" class="i">+
</a><a href="#h4-1-20" id="h4-1-20" class="i">+    IndexKey(int anchor = kAnchorNone)
</a><a href="#h4-1-21" id="h4-1-21" class="i">+        : anchor(anchor), refs_(0) { }
</a><a href="#h4-1-22" id="h4-1-22" class="i">+
</a><a href="#h4-1-23" id="h4-1-23" class="i">+    IndexKey(pair&lt;uchar, uchar&gt; p,
</a><a href="#h4-1-24" id="h4-1-24" class="i">+             intrusive_ptr&lt;IndexKey&gt; next,
</a><a href="#h4-1-25" id="h4-1-25" class="i">+             int anchor = kAnchorNone)
</a><a href="#h4-1-26" id="h4-1-26" class="i">+        : anchor(anchor), refs_(0) {
</a><a href="#h4-1-27" id="h4-1-27" class="i">+        insert(value_type(p, next));
</a><a href="#h4-1-28" id="h4-1-28" class="i">+    }
</a><a href="#h4-1-29" id="h4-1-29" class="i">+
</a><a href="#h4-1-30" id="h4-1-30" class="i">+    void insert(const value_type&amp; v);
</a><a href="#h4-1-31" id="h4-1-31" class="i">+    void concat(intrusive_ptr&lt;IndexKey&gt; rhs);
</a><a href="#h4-1-32" id="h4-1-32" class="i">+
</a><a href="#h4-1-33" id="h4-1-33" class="i">+    bool empty() {
</a><a href="#h4-1-34" id="h4-1-34" class="i">+        return edges_.empty();
</a><a href="#h4-1-35" id="h4-1-35" class="i">+    }
</a><a href="#h4-1-36" id="h4-1-36" class="i">+
</a><a href="#h4-1-37" id="h4-1-37" class="i">+    size_t size() {
</a><a href="#h4-1-38" id="h4-1-38" class="i">+        return edges_.size();
</a><a href="#h4-1-39" id="h4-1-39" class="i">+    }
</a> 
<a href="#h4-1-41" id="h4-1-41" class="d">-    IndexKey(int anchor = kAnchorNone) : anchor(anchor) { }
</a><a href="#h4-1-42" id="h4-1-42" class="i">+    class Stats {
</a><a href="#h4-1-43" id="h4-1-43" class="i">+    public:
</a><a href="#h4-1-44" id="h4-1-44" class="i">+        double selectivity_;
</a><a href="#h4-1-45" id="h4-1-45" class="i">+        int depth_;
</a><a href="#h4-1-46" id="h4-1-46" class="i">+        long nodes_;
</a><a href="#h4-1-47" id="h4-1-47" class="i">+        long tail_paths_;
</a><a href="#h4-1-48" id="h4-1-48" class="i">+
</a><a href="#h4-1-49" id="h4-1-49" class="i">+        Stats();
</a><a href="#h4-1-50" id="h4-1-50" class="i">+        Stats insert(const value_type&amp; v) const;
</a><a href="#h4-1-51" id="h4-1-51" class="i">+        Stats concat(const Stats&amp; rhs) const;
</a><a href="#h4-1-52" id="h4-1-52" class="i">+    };
</a><a href="#h4-1-53" id="h4-1-53" class="i">+
</a><a href="#h4-1-54" id="h4-1-54" class="i">+    const Stats&amp; stats() {
</a><a href="#h4-1-55" id="h4-1-55" class="i">+        return stats_;
</a><a href="#h4-1-56" id="h4-1-56" class="i">+    }
</a> 
     /*
      * Returns an approximation of the fraction of the input corpus
<a href="#h4-2" id="h4-2" class="h">@@ -49,10 +99,30 @@ struct IndexKey {
</a>      * key.
      */
     unsigned weight();
<a href="#h4-2-3" id="h4-2-3" class="i">+    int depth();
</a><a href="#h4-2-4" id="h4-2-4" class="i">+    long nodes();
</a> 
     string ToString();
<a href="#h4-2-7" id="h4-2-7" class="i">+
</a><a href="#h4-2-8" id="h4-2-8" class="i">+    void check_rep();
</a><a href="#h4-2-9" id="h4-2-9" class="i">+
</a><a href="#h4-2-10" id="h4-2-10" class="i">+    int anchor;
</a><a href="#h4-2-11" id="h4-2-11" class="i">+protected:
</a><a href="#h4-2-12" id="h4-2-12" class="i">+    map&lt;pair&lt;uchar, uchar&gt;, intrusive_ptr&lt;IndexKey&gt; &gt; edges_;
</a><a href="#h4-2-13" id="h4-2-13" class="i">+    Stats stats_;
</a><a href="#h4-2-14" id="h4-2-14" class="i">+    list&lt;iterator&gt; tails_;
</a><a href="#h4-2-15" id="h4-2-15" class="i">+    atomic_int refs_;
</a><a href="#h4-2-16" id="h4-2-16" class="i">+
</a><a href="#h4-2-17" id="h4-2-17" class="i">+    void collect_tails(list&lt;IndexKey::iterator&gt;&amp; tails);
</a><a href="#h4-2-18" id="h4-2-18" class="i">+
</a><a href="#h4-2-19" id="h4-2-19" class="i">+private:
</a><a href="#h4-2-20" id="h4-2-20" class="i">+    IndexKey(const IndexKey&amp;);
</a><a href="#h4-2-21" id="h4-2-21" class="i">+    void operator=(const IndexKey&amp;);
</a><a href="#h4-2-22" id="h4-2-22" class="i">+
</a><a href="#h4-2-23" id="h4-2-23" class="i">+    friend void intrusive_ptr_add_ref(IndexKey *key);
</a><a href="#h4-2-24" id="h4-2-24" class="i">+    friend void intrusive_ptr_release(IndexKey *key);
</a> };
 
<a href="#h4-2-27" id="h4-2-27" class="d">-shared_ptr&lt;IndexKey&gt; indexRE(const re2::RE2 &amp;pat);
</a><a href="#h4-2-28" id="h4-2-28" class="i">+intrusive_ptr&lt;IndexKey&gt; indexRE(const re2::RE2 &amp;pat);
</a> 
 #endif /* CODESEARCH_INDEXER_H */
<b>diff --git a/<a id="h5" href="../file/recursion.h">recursion.h</a> b/<a href="../file/recursion.h">recursion.h</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -0,0 +1,16 @@
</a><a href="#h5-0-0" id="h5-0-0" class="i">+#ifndef CODESEARCH_RECURSION_H
</a><a href="#h5-0-1" id="h5-0-1" class="i">+#define CODESEARCH_RECURSION_H
</a><a href="#h5-0-2" id="h5-0-2" class="i">+
</a><a href="#h5-0-3" id="h5-0-3" class="i">+class RecursionCounter {
</a><a href="#h5-0-4" id="h5-0-4" class="i">+public:
</a><a href="#h5-0-5" id="h5-0-5" class="i">+    RecursionCounter(int &amp;depth) : depth_(depth) {
</a><a href="#h5-0-6" id="h5-0-6" class="i">+        depth_++;
</a><a href="#h5-0-7" id="h5-0-7" class="i">+    }
</a><a href="#h5-0-8" id="h5-0-8" class="i">+    ~RecursionCounter() {
</a><a href="#h5-0-9" id="h5-0-9" class="i">+        depth_--;
</a><a href="#h5-0-10" id="h5-0-10" class="i">+    }
</a><a href="#h5-0-11" id="h5-0-11" class="i">+protected:
</a><a href="#h5-0-12" id="h5-0-12" class="i">+    int &amp;depth_;
</a><a href="#h5-0-13" id="h5-0-13" class="i">+};
</a><a href="#h5-0-14" id="h5-0-14" class="i">+
</a><a href="#h5-0-15" id="h5-0-15" class="i">+#endif
</a><b>diff --git a/<a id="h6" href="../file/test/index">test/index</a> b/<a href="../file/test/index">test/index</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -0,0 +1,11 @@
</a><a href="#h6-0-0" id="h6-0-0" class="i">+([a-e]:)|[g-k]
</a><a href="#h6-0-1" id="h6-0-1" class="i">+([a-e0-9]:)|[g-kw-z]
</a><a href="#h6-0-2" id="h6-0-2" class="i">+([a-e]:)|[a-e]
</a><a href="#h6-0-3" id="h6-0-3" class="i">+([a-e]:)|[d-g]
</a><a href="#h6-0-4" id="h6-0-4" class="i">+([a-e]:)|([d-g];)
</a><a href="#h6-0-5" id="h6-0-5" class="i">+([a-ei-lz]:)|([d-gl-oy];)
</a><a href="#h6-0-6" id="h6-0-6" class="i">+\s[0-9a-f]
</a><a href="#h6-0-7" id="h6-0-7" class="i">+[a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k][a-bd-eg-hj-k]
</a><a href="#h6-0-8" id="h6-0-8" class="i">+([a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z])|([a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z][a-fw-z])
</a><a href="#h6-0-9" id="h6-0-9" class="i">+([acegikmoqsuwy{}][acegikmoqsuwy{}][acegikmoqsuwy{}][acegikmoqsuwy{}][acegikmoqsuwy{}][acegikmoqsuwy{}][acegikmoqsuwy{}][acegikmoqsuwy{}][acegikmoqsuwy{}][acegikmoqsuwy{}])|([acegikmoqsuwy{}][acegikmoqsuwy{}][acegikmoqsuwy{}][acegikmoqsuwy{}][acegikmoqsuwy{}][acegikmoqsuwy{}][acegikmoqsuwy{}][acegikmoqsuwy{}][acegikmoqsuwy{}][acegikmoqsuwy{}])
</a><a href="#h6-0-10" id="h6-0-10" class="i">+((p((n((l((j((h((f((d(a|b))|(e(a|b))))|(g((d(a|b))|(e(a|b))))))|(i((f((d(a|b))|(e(a|b))))|(g((d(a|b))|(e(a|b))))))))|(k((h((f((d(a|b))|(e(a|b))))|(g((d(a|b))|(e(a|b))))))|(i((f((d(a|b))|(e(a|b))))|(g((d(a|b))|(e(a|b))))))))))|(m((j((h((f((d(a|b))|(e(a|b))))|(g((d(a|b))|(e(a|b))))))|(i((f((d(a|b))|(e(a|b))))|(g((d(a|b))|(e(a|b))))))))|(k((h((f((d(a|b))|(e(a|b))))|(g((d(a|b))|(e(a|b))))))|(i((f((d(a|b))|(e(a|b))))|(g((d(a|b))|(e(a|b))))))))))))|(o((l((j((h((f((d(a|b))|(e(a|b))))|(g((d(a|b))|(e(a|b))))))|(i((f((d(a|b))|(e(a|b))))|(g((d(a|b))|(e(a|b))))))))|(k((h((f((d(a|b))|(e(a|b))))|(g((d(a|b))|(e(a|b))))))|(i((f((d(a|b))|(e(a|b))))|(g((d(a|b))|(e(a|b))))))))))|(m((j((h((f((d(a|b))|(e(a|b))))|(g((d(a|b))|(e(a|b))))))|(i((f((d(a|b))|(e(a|b))))|(g((d(a|b))|(e(a|b))))))))|(k((h((f((d(a|b))|(e(a|b))))|(g((d(a|b))|(e(a|b))))))|(i((f((d(a|b))|(e(a|b))))|(g((d(a|b))|(e(a|b))))))))))))))|(q((n((l((j((h((f((d(a|b))|(e(a|b))))|(g((d(a|b))|(e(a|b))))))|(i((f((d(a|b))|(e(a|b))))|(g((d(a|b))|(e(a|b))))))))|(k((h((f((d(a|b))|(e(a|b))))|(g((d(a|b))|(e(a|b))))))|(i((f((d(a|b))|(e(a|b))))|(g((d(a|b))|(e(a|b))))))))))|(m((j((h((f((d(a|b))|(e(a|b))))|(g((d(a|b))|(e(a|b))))))|(i((f((d(a|b))|(e(a|b))))|(g((d(a|b))|(e(a|b))))))))|(k((h((f((d(a|b))|(e(a|b))))|(g((d(a|b))|(e(a|b))))))|(i((f((d(a|b))|(e(a|b))))|(g((d(a|b))|(e(a|b))))))))))))|(o((l((j((h((f((d(a|b))|(e(a|b))))|(g((d(a|b))|(e(a|b))))))|(i((f((d(a|b))|(e(a|b))))|(g((d(a|b))|(e(a|b))))))))|(k((h((f((d(a|b))|(e(a|b))))|(g((d(a|b))|(e(a|b))))))|(i((f((d(a|b))|(e(a|b))))|(g((d(a|b))|(e(a|b))))))))))|(m((j((h((f((d(a|b))|(e(a|b))))|(g((d(a|b))|(e(a|b))))))|(i((f((d(a|b))|(e(a|b))))|(g((d(a|b))|(e(a|b))))))))|(k((h((f((d(a|b))|(e(a|b))))|(g((d(a|b))|(e(a|b))))))|(i((f((d(a|b))|(e(a|b))))|(g((d(a|b))|(e(a|b)))))))))))))))
</a><b>diff --git a/<a id="h7" href="../file/test/unicode">test/unicode</a> b/<a href="../file/test/unicode">test/unicode</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -0,0 +1,3 @@
</a><a href="#h7-0-0" id="h7-0-0" class="i">+[-]
</a><a href="#h7-0-1" id="h7-0-1" class="i">+[-]{2}
</a><a href="#h7-0-2" id="h7-0-2" class="i">+[0-9-]{4}
</a></pre>
</div>
</body>
</html>
