<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Merge pull request #180 from livegrep/nelhage-unique - livegrep - Fast, regular expression code search service</title>
<link rel="icon" type="image/png" href="https://static.kevinlin.info/favicon.png" />
<link rel="alternate" type="application/atom+xml" title="livegrep Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="livegrep Atom Feed (tags)" href="../tags.xml" />
<style type="text/css">
body {
	color: #000;
	background-color: #fff;
	font-family: monospace;
}

h1, h2, h3, h4, h5, h6 {
	font-size: 1em;
	margin: 0;
}

img, h1, h2 {
	vertical-align: middle;
}

img {
	border: 0;
}

a:target {
	background-color: #ccc;
}

a.d,
a.h,
a.i {
	text-decoration: none;
}

a.line {
	text-decoration: none;
	user-select: none;
}

#blob a {
	color: #555;
}

#blob a:hover {
	color: blue;
	text-decoration: none;
}

table thead td {
	font-weight: bold;
}

table td {
	padding: 0 0.4em;
}

#content table td {
	vertical-align: top;
	white-space: nowrap;
}

#branches tr:hover td,
#tags tr:hover td,
#index tr:hover td,
#log tr:hover td,
#files tr:hover td {
	background-color: #eee;
}

#index tr td:nth-child(2),
#tags tr td:nth-child(3),
#branches tr td:nth-child(3),
#log tr td:nth-child(2) {
	white-space: normal;
}

td.num {
	text-align: right;
}

.desc {
	color: #555;
}

hr {
	border: 0;
	border-top: 1px solid #555;
	height: 1px;
}

pre {
	font-family: monospace;
}

pre a.h {
	color: #00a;
}

.A,
span.i,
pre a.i {
	color: #070;
}

.D,
span.d,
pre a.d {
	color: #e00;
}

pre a.h:hover,
pre a.i:hover,
pre a.d:hover {
	text-decoration: none;
}
</style>
</head>
<body>
<table><tr><td><a href="../../"><img src="https://static.kevinlin.info/favicon.png" alt="" width="32" height="32" /></a></td><td><h1>livegrep</h1><span class="desc">Fast, regular expression code search service</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://source.static.kevinlin.info/external/livegrep.git">https://source.static.kevinlin.info/external/livegrep.git</a></td></tr><tr><td></td><td>
<a href="../log">Log</a> | <a href="../files">Files</a> | <a href="../refs">Refs</a> | <a href="../file/README.md">README</a> | <a href="../file/COPYING">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/4b7ead86fc9e6d2fb5a0dde3333ad6b60cac8c63">4b7ead86fc9e6d2fb5a0dde3333ad6b60cac8c63</a>
<b>parent</b> <a href="../commit/e09cd57732800a9636b4c21142d00c60c76d7512">e09cd57732800a9636b4c21142d00c60c76d7512</a>
<b>Author:</b> Nelson Elhage &lt;<a href="mailto:nelhage@nelhage.com">nelhage@nelhage.com</a>&gt;
<b>Date:</b>   Tue,  7 Aug 2018 20:10:25 -0700

Merge pull request #180 from livegrep/nelhage-unique

Port a lot of storage to unique_ptr and vector
<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">src/BUILD</a></td><td> | </td><td class="num">5</td><td><span class="i">++++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">src/chunk.cc</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">src/chunk.h</a></td><td> | </td><td class="num">22</td><td><span class="i">+++++</span><span class="d">-----------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">src/chunk_allocator.cc</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">src/codesearch.cc</a></td><td> | </td><td class="num">106</td><td><span class="i">++++++++++++++++++++++++++++++++++++</span><span class="d">-------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">src/codesearch.h</a></td><td> | </td><td class="num">24</td><td><span class="i">++++++++++++</span><span class="d">------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">src/dump_load.cc</a></td><td> | </td><td class="num">30</td><td><span class="i">+++++++++++++++</span><span class="d">---------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">src/tagsearch.cc</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h8">src/tools/codesearch.cc</a></td><td> | </td><td class="num">1</td><td><span class="i">+</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h9">src/tools/dump-file.cc</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h10">test/codesearch_test.cc</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
</table></pre><pre>11 files changed, 94 insertions(+), 112 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/src/BUILD">src/BUILD</a> b/<a href="../file/src/BUILD">src/BUILD</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -4,7 +4,10 @@ cc_library(
</a>         &quot;*.cc&quot;,
     ]),
     hdrs = glob([&quot;*.h&quot;]),
<a href="#h0-0-3" id="h0-0-3" class="d">-    copts = [&quot;-Wno-sign-compare&quot;],
</a><a href="#h0-0-4" id="h0-0-4" class="i">+    copts = [
</a><a href="#h0-0-5" id="h0-0-5" class="i">+        &quot;-Wno-sign-compare&quot;,
</a><a href="#h0-0-6" id="h0-0-6" class="i">+        &quot;-std=c++14&quot;,
</a><a href="#h0-0-7" id="h0-0-7" class="i">+    ],
</a>     visibility = [&quot;//visibility:public&quot;],
     deps = [
         &quot;//src/lib&quot;,
<b>diff --git a/<a id="h1" href="../file/src/chunk.cc">src/chunk.cc</a> b/<a href="../file/src/chunk.cc">src/chunk.cc</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -128,11 +128,11 @@ void chunk::build_tree() {
</a>     cf_root = build_tree(0, files.size());
 }
 
<a href="#h1-0-3" id="h1-0-3" class="d">-chunk_file_node *chunk::build_tree(int left, int right) {
</a><a href="#h1-0-4" id="h1-0-4" class="i">+unique_ptr&lt;chunk_file_node&gt; chunk::build_tree(int left, int right) {
</a>     if (right == left)
         return 0;
     int mid = (left + right) / 2;
<a href="#h1-0-8" id="h1-0-8" class="d">-    chunk_file_node *node = new chunk_file_node;
</a><a href="#h1-0-9" id="h1-0-9" class="i">+    auto node = std::make_unique&lt;chunk_file_node&gt;();
</a> 
     node-&gt;chunk = &amp;files[mid];
     node-&gt;left  = build_tree(left, mid);
<b>diff --git a/<a id="h2" href="../file/src/chunk.h">src/chunk.h</a> b/<a href="../file/src/chunk.h">src/chunk.h</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -17,6 +17,7 @@
</a> #include &lt;algorithm&gt;
 #include &lt;list&gt;
 #include &lt;set&gt;
<a href="#h2-0-3" id="h2-0-3" class="i">+#include &lt;memory&gt;
</a> 
 #include &lt;stdint.h&gt;
 
<a href="#h2-1" id="h2-1" class="h">@@ -53,16 +54,7 @@ struct chunk_file_node {
</a>     chunk_file *chunk;
     int right_limit;
 
<a href="#h2-1-3" id="h2-1-3" class="d">-    chunk_file_node *left, *right;
</a><a href="#h2-1-4" id="h2-1-4" class="d">-
</a><a href="#h2-1-5" id="h2-1-5" class="d">-    ~chunk_file_node() {
</a><a href="#h2-1-6" id="h2-1-6" class="d">-        if (left != NULL) {
</a><a href="#h2-1-7" id="h2-1-7" class="d">-            delete left;
</a><a href="#h2-1-8" id="h2-1-8" class="d">-        }
</a><a href="#h2-1-9" id="h2-1-9" class="d">-        if (right != NULL) {
</a><a href="#h2-1-10" id="h2-1-10" class="d">-            delete right;
</a><a href="#h2-1-11" id="h2-1-11" class="d">-        }
</a><a href="#h2-1-12" id="h2-1-12" class="d">-    }
</a><a href="#h2-1-13" id="h2-1-13" class="i">+    std::unique_ptr&lt;chunk_file_node&gt; left, right;
</a> };
 
 struct chunk {
<a href="#h2-2" id="h2-2" class="h">@@ -90,7 +82,7 @@ struct chunk {
</a>     // BST constructed from `files` at the very end of index creation. Used to
     // efficiently find, given a substring of this chunk&#39;s data, the files
     // might contain that substring.
<a href="#h2-2-3" id="h2-2-3" class="d">-    chunk_file_node *cf_root;
</a><a href="#h2-2-4" id="h2-2-4" class="i">+    unique_ptr&lt;chunk_file_node&gt; cf_root;
</a> 
     // The suffix array; constructed from `data` during finalization (once the
     // chunk&#39;s data block is full, but before all files have been processed).
<a href="#h2-3" id="h2-3" class="h">@@ -100,13 +92,9 @@ struct chunk {
</a>     unsigned char *data;
 
     chunk(unsigned char *data, uint32_t *suffixes)
<a href="#h2-3-3" id="h2-3-3" class="d">-        : size(0), files(), cf_root(0),
</a><a href="#h2-3-4" id="h2-3-4" class="i">+        : size(0), files(), cf_root(),
</a>           suffixes(suffixes), data(data) { }
 
<a href="#h2-3-7" id="h2-3-7" class="d">-    ~chunk() {
</a><a href="#h2-3-8" id="h2-3-8" class="d">-        delete cf_root;
</a><a href="#h2-3-9" id="h2-3-9" class="d">-    }
</a><a href="#h2-3-10" id="h2-3-10" class="d">-
</a>     void add_chunk_file(indexed_file *sf, const StringPiece&amp; line);
     void finish_file();
     void finalize();
<a href="#h2-4" id="h2-4" class="h">@@ -150,7 +138,7 @@ struct chunk {
</a>         }
     };
 
<a href="#h2-4-3" id="h2-4-3" class="d">-    chunk_file_node *build_tree(int left, int right);
</a><a href="#h2-4-4" id="h2-4-4" class="i">+    unique_ptr&lt;chunk_file_node&gt; build_tree(int left, int right);
</a> 
 private:
     chunk(const chunk&amp;);
<b>diff --git a/<a id="h3" href="../file/src/chunk_allocator.cc">src/chunk_allocator.cc</a> b/<a href="../file/src/chunk_allocator.cc">src/chunk_allocator.cc</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -154,6 +154,6 @@ public:
</a>     }
 };
 
<a href="#h3-0-3" id="h3-0-3" class="d">-chunk_allocator *make_mem_allocator() {
</a><a href="#h3-0-4" id="h3-0-4" class="d">-    return new mem_allocator();
</a><a href="#h3-0-5" id="h3-0-5" class="i">+unique_ptr&lt;chunk_allocator&gt; make_mem_allocator() {
</a><a href="#h3-0-6" id="h3-0-6" class="i">+    return make_unique&lt;mem_allocator&gt;();
</a> }
<b>diff --git a/<a id="h4" href="../file/src/codesearch.cc">src/codesearch.cc</a> b/<a href="../file/src/codesearch.cc">src/codesearch.cc</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -211,15 +211,11 @@ public:
</a>         cc_(cc), query_(&amp;q), transform_(func), queue_(),
         limiter_(q.max_matches), index_key_(index_key), re2_time_(false),
         git_time_(false), index_time_(false), sort_time_(false),
<a href="#h4-0-3" id="h4-0-3" class="d">-        analyze_time_(false), files_(new uint8_t[cc-&gt;files_.size()]),
</a><a href="#h4-0-4" id="h4-0-4" class="i">+        analyze_time_(false), files_(cc-&gt;files_.size(), 0xff),
</a>         files_density_(-1)
<a href="#h4-0-6" id="h4-0-6" class="d">-    {
</a><a href="#h4-0-7" id="h4-0-7" class="d">-        memset(files_, 0xff, cc-&gt;files_.size());
</a><a href="#h4-0-8" id="h4-0-8" class="d">-    }
</a><a href="#h4-0-9" id="h4-0-9" class="i">+    {}
</a> 
     ~searcher() {
<a href="#h4-0-12" id="h4-0-12" class="d">-        delete[] files_;
</a><a href="#h4-0-13" id="h4-0-13" class="d">-
</a>         debug(kDebugProfile, &quot;re2 time: %d.%06ds&quot;,
               int(re2_time_.elapsed().tv_sec),
               int(re2_time_.elapsed().tv_usec));
<a href="#h4-1" id="h4-1" class="h">@@ -277,7 +273,7 @@ protected:
</a>         int hits = 0;
         int sample = min(1000, int(cc_-&gt;files_.size()));
         for (int i = 0; i &lt; sample; i++) {
<a href="#h4-1-3" id="h4-1-3" class="d">-            if (accept(query_, cc_-&gt;files_[rand() % cc_-&gt;files_.size()]))
</a><a href="#h4-1-4" id="h4-1-4" class="i">+            if (accept(query_, cc_-&gt;files_[rand() % cc_-&gt;files_.size()].get()))
</a>                 hits++;
         }
         return (files_density_ = double(hits) / sample);
<a href="#h4-2" id="h4-2" class="h">@@ -285,7 +281,7 @@ protected:
</a> 
     /*
      * Do a linear walk over chunk-&gt;files, searching for all files
<a href="#h4-2-3" id="h4-2-3" class="d">-     * which contain `match&#39;, which is contained within `line&#39;.
</a><a href="#h4-2-4" id="h4-2-4" class="i">+p     * which contain `match&#39;, which is contained within `line&#39;.
</a>      */
     void find_match_brute(const chunk *chunk,
                           const StringPiece&amp; match,
<a href="#h4-3" id="h4-3" class="h">@@ -356,7 +352,7 @@ protected:
</a>     timer index_time_;
     timer sort_time_;
     timer analyze_time_;
<a href="#h4-3-3" id="h4-3-3" class="d">-    uint8_t *files_;
</a><a href="#h4-3-4" id="h4-3-4" class="i">+    vector&lt;uint8_t&gt; files_;
</a> 
     /*
      * The approximate ratio of how many files match file_pat and
<a href="#h4-4" id="h4-4" class="h">@@ -396,7 +392,7 @@ protected:
</a> };
 
 int suffix_search(const unsigned char *data,
<a href="#h4-4-3" id="h4-4-3" class="d">-                  uint32_t *suffixes,
</a><a href="#h4-4-4" id="h4-4-4" class="i">+                  const uint32_t *suffixes,
</a>                   int size,
                   intrusive_ptr&lt;IndexKey&gt; index,
                   vector&lt;uint32_t&gt; &amp;indexes_out);
<a href="#h4-5" id="h4-5" class="h">@@ -405,17 +401,19 @@ void filename_searcher::operator()()
</a> {
     static per_thread&lt;vector&lt;uint32_t&gt; &gt; indexes;
     if (!indexes.get()) {
<a href="#h4-5-3" id="h4-5-3" class="d">-        indexes.put(new vector&lt;uint32_t&gt;(cc_-&gt;filename_data_size_ / kMinFilterRatio / 10));
</a><a href="#h4-5-4" id="h4-5-4" class="i">+        indexes.put(new vector&lt;uint32_t&gt;(cc_-&gt;filename_data_.size() / kMinFilterRatio / 10));
</a>     }
 
<a href="#h4-5-7" id="h4-5-7" class="d">-    int count = suffix_search(cc_-&gt;filename_data_, cc_-&gt;filename_suffixes_, cc_-&gt;filename_data_size_, index_key_, *indexes);
</a><a href="#h4-5-8" id="h4-5-8" class="i">+    int count = suffix_search(cc_-&gt;filename_data_.data(),
</a><a href="#h4-5-9" id="h4-5-9" class="i">+                              cc_-&gt;filename_suffixes_.data(),
</a><a href="#h4-5-10" id="h4-5-10" class="i">+                              cc_-&gt;filename_data_.size(), index_key_, *indexes);
</a> 
     if (count &gt; indexes-&gt;size()) {
         for (auto it = cc_-&gt;files_.begin(); it &lt; cc_-&gt;files_.end(); it++) {
             if (limiter_.exit_early()) {
                 return;
             }
<a href="#h4-5-17" id="h4-5-17" class="d">-            match_filename(*it);
</a><a href="#h4-5-18" id="h4-5-18" class="i">+            match_filename(it-&gt;get());
</a>         }
         return;
     }
<a href="#h4-6" id="h4-6" class="h">@@ -472,36 +470,26 @@ void filename_searcher::match_filename(indexed_file *file) {
</a> }
 
 code_searcher::code_searcher()
<a href="#h4-6-3" id="h4-6-3" class="d">-    : alloc_(0), finalized_(false), filename_data_(NULL), filename_suffixes_(NULL)
</a><a href="#h4-6-4" id="h4-6-4" class="i">+    : alloc_(), finalized_(false), filename_data_(), filename_suffixes_()
</a> {
 #ifdef USE_DENSE_HASH_SET
     lines_.set_empty_key(empty_string);
 #endif
 }
 
<a href="#h4-6-11" id="h4-6-11" class="d">-void code_searcher::set_alloc(chunk_allocator *alloc) {
</a><a href="#h4-6-12" id="h4-6-12" class="i">+void code_searcher::set_alloc(std::unique_ptr&lt;chunk_allocator&gt; alloc) {
</a>     assert(!alloc_);
<a href="#h4-6-14" id="h4-6-14" class="d">-    alloc_ = alloc;
</a><a href="#h4-6-15" id="h4-6-15" class="i">+    alloc_ = move(alloc);
</a> }
 
 code_searcher::~code_searcher() {
     if (alloc_)
         alloc_-&gt;cleanup();
<a href="#h4-6-21" id="h4-6-21" class="d">-    delete alloc_;
</a><a href="#h4-6-22" id="h4-6-22" class="d">-    for (auto tree : trees_) {
</a><a href="#h4-6-23" id="h4-6-23" class="i">+
</a><a href="#h4-6-24" id="h4-6-24" class="i">+    for (auto &amp;tree : trees_) {
</a>         if (tree-&gt;metadata != NULL) {
             json_object_put(tree-&gt;metadata);
         }
<a href="#h4-6-28" id="h4-6-28" class="d">-        delete tree;
</a><a href="#h4-6-29" id="h4-6-29" class="d">-    }
</a><a href="#h4-6-30" id="h4-6-30" class="d">-    for (auto file : files_) {
</a><a href="#h4-6-31" id="h4-6-31" class="d">-        delete file;
</a><a href="#h4-6-32" id="h4-6-32" class="d">-    }
</a><a href="#h4-6-33" id="h4-6-33" class="d">-    if (filename_data_ != NULL) {
</a><a href="#h4-6-34" id="h4-6-34" class="d">-        delete[] filename_data_;
</a><a href="#h4-6-35" id="h4-6-35" class="d">-    }
</a><a href="#h4-6-36" id="h4-6-36" class="d">-    if (filename_suffixes_ != NULL) {
</a><a href="#h4-6-37" id="h4-6-37" class="d">-        delete[] filename_suffixes_;
</a>     }
 }
 
<a href="#h4-7" id="h4-7" class="h">@@ -509,22 +497,24 @@ void code_searcher::index_filenames() {
</a>     log(&quot;Building filename index...&quot;);
     filename_positions_.reserve(files_.size());
 
<a href="#h4-7-3" id="h4-7-3" class="d">-    filename_data_size_ = 0;
</a><a href="#h4-7-4" id="h4-7-4" class="i">+    size_t filename_data_size = 0;
</a>     for (auto it = files_.begin(); it != files_.end(); ++it) {
<a href="#h4-7-6" id="h4-7-6" class="d">-        filename_data_size_ += (*it)-&gt;path.size() + 1;
</a><a href="#h4-7-7" id="h4-7-7" class="i">+        filename_data_size += (*it)-&gt;path.size() + 1;
</a>     }
 
<a href="#h4-7-10" id="h4-7-10" class="d">-    filename_data_ = new unsigned char[filename_data_size_];
</a><a href="#h4-7-11" id="h4-7-11" class="i">+    filename_data_.resize(filename_data_size);
</a>     int offset = 0;
     for (auto it = files_.begin(); it != files_.end(); ++it) {
<a href="#h4-7-14" id="h4-7-14" class="d">-        memcpy(filename_data_ + offset, (*it)-&gt;path.data(), (*it)-&gt;path.size());
</a><a href="#h4-7-15" id="h4-7-15" class="i">+        memcpy(filename_data_.data() + offset, (*it)-&gt;path.data(), (*it)-&gt;path.size());
</a>         filename_data_[offset + (*it)-&gt;path.size()] = &#39;\0&#39;;
<a href="#h4-7-17" id="h4-7-17" class="d">-        filename_positions_.emplace_back(offset, *it);
</a><a href="#h4-7-18" id="h4-7-18" class="i">+        filename_positions_.emplace_back(offset, it-&gt;get());
</a>         offset += (*it)-&gt;path.size() + 1;
     }
 
<a href="#h4-7-22" id="h4-7-22" class="d">-    filename_suffixes_ = new uint32_t[filename_data_size_];
</a><a href="#h4-7-23" id="h4-7-23" class="d">-    divsufsort(filename_data_, reinterpret_cast&lt;saidx_t*&gt;(filename_suffixes_), filename_data_size_);
</a><a href="#h4-7-24" id="h4-7-24" class="i">+    filename_suffixes_.resize(filename_data_size);
</a><a href="#h4-7-25" id="h4-7-25" class="i">+    divsufsort(filename_data_.data(),
</a><a href="#h4-7-26" id="h4-7-26" class="i">+               reinterpret_cast&lt;saidx_t*&gt;(filename_suffixes_.data()),
</a><a href="#h4-7-27" id="h4-7-27" class="i">+               filename_data_size);
</a> }
 
 void code_searcher::finalize() {
<a href="#h4-8" id="h4-8" class="h">@@ -553,7 +543,7 @@ vector&lt;indexed_tree&gt; code_searcher::trees() const {
</a> const indexed_tree* code_searcher::open_tree(const string &amp;name,
                                              json_object *metadata,
                                              const string &amp;version) {
<a href="#h4-8-3" id="h4-8-3" class="d">-    indexed_tree *tree = new indexed_tree;
</a><a href="#h4-8-4" id="h4-8-4" class="i">+    auto tree = std::make_unique&lt;indexed_tree&gt;();
</a>     tree-&gt;name = name;
     tree-&gt;version = version;
     if (metadata) {
<a href="#h4-9" id="h4-9" class="h">@@ -561,8 +551,8 @@ const indexed_tree* code_searcher::open_tree(const string &amp;name,
</a>     } else {
         tree-&gt;metadata = NULL;
     }
<a href="#h4-9-3" id="h4-9-3" class="d">-    trees_.push_back(tree);
</a><a href="#h4-9-4" id="h4-9-4" class="d">-    return tree;
</a><a href="#h4-9-5" id="h4-9-5" class="i">+    trees_.push_back(move(tree));
</a><a href="#h4-9-6" id="h4-9-6" class="i">+    return trees_.back().get();
</a> }
 
 void code_searcher::index_file(const indexed_tree *tree,
<a href="#h4-10" id="h4-10" class="h">@@ -585,15 +575,15 @@ void code_searcher::index_file(const indexed_tree *tree,
</a>     idx_bytes.inc(len);
     idx_files.inc();
 
<a href="#h4-10-3" id="h4-10-3" class="d">-    indexed_file *sf = new indexed_file;
</a><a href="#h4-10-4" id="h4-10-4" class="d">-    sf-&gt;tree = tree;
</a><a href="#h4-10-5" id="h4-10-5" class="d">-    sf-&gt;path = path;
</a><a href="#h4-10-6" id="h4-10-6" class="d">-    sf-&gt;no  = files_.size();
</a><a href="#h4-10-7" id="h4-10-7" class="d">-    files_.push_back(sf);
</a><a href="#h4-10-8" id="h4-10-8" class="i">+    auto file = std::make_unique&lt;indexed_file&gt;();
</a><a href="#h4-10-9" id="h4-10-9" class="i">+    file-&gt;tree = tree;
</a><a href="#h4-10-10" id="h4-10-10" class="i">+    file-&gt;path = path;
</a><a href="#h4-10-11" id="h4-10-11" class="i">+    file-&gt;no  = files_.size();
</a><a href="#h4-10-12" id="h4-10-12" class="i">+    auto *sf = file.get();
</a><a href="#h4-10-13" id="h4-10-13" class="i">+    files_.push_back(move(file));
</a> 
     uint32_t lines = count(p, end, &#39;\n&#39;);
 
<a href="#h4-10-17" id="h4-10-17" class="d">-    // sf-&gt;content = new(new uint32_t[3*lines+1]) file_contents(0);
</a>     file_contents_builder content;
 
     while ((f = static_cast&lt;const char*&gt;(memchr(p, &#39;\n&#39;, end - p))) != 0) {
<a href="#h4-11" id="h4-11" class="h">@@ -646,12 +636,12 @@ void code_searcher::index_file(const indexed_tree *tree,
</a>         goto final;
     }
 
<a href="#h4-11-3" id="h4-11-3" class="d">-    sf-&gt;content = content.build(alloc_);
</a><a href="#h4-11-4" id="h4-11-4" class="i">+    sf-&gt;content = content.build(alloc_.get());
</a>     if (sf-&gt;content == 0) {
         fprintf(stderr, &quot;WARN: %s:%s:%s is too large to be indexed.\n&quot;,
                 tree-&gt;name.c_str(), tree-&gt;version.c_str(), path.c_str());
         file_contents_builder dummy;
<a href="#h4-11-9" id="h4-11-9" class="d">-        sf-&gt;content = dummy.build(alloc_);
</a><a href="#h4-11-10" id="h4-11-10" class="i">+        sf-&gt;content = dummy.build(alloc_.get());
</a>     }
     idx_content_ranges.inc(sf-&gt;content-&gt;size());
     assert(sf-&gt;content-&gt;size() &lt;= 3*lines);
<a href="#h4-12" id="h4-12" class="h">@@ -696,7 +686,7 @@ void searcher::operator()(const chunk *chunk)
</a> }
 
 struct walk_state {
<a href="#h4-12-3" id="h4-12-3" class="d">-    uint32_t *left, *right;
</a><a href="#h4-12-4" id="h4-12-4" class="i">+    const uint32_t *left, *right;
</a>     intrusive_ptr&lt;IndexKey&gt; key;
     int depth;
 };
<a href="#h4-13" id="h4-13" class="h">@@ -722,7 +712,7 @@ struct lt_index {
</a> };
 
 int suffix_search(const unsigned char *data,
<a href="#h4-13-3" id="h4-13-3" class="d">-                  uint32_t *suffixes,
</a><a href="#h4-13-4" id="h4-13-4" class="i">+                  const uint32_t *suffixes,
</a>                   int size,
                   intrusive_ptr&lt;IndexKey&gt; index,
                   vector&lt;uint32_t&gt; &amp;indexes_out) {
<a href="#h4-14" id="h4-14" class="h">@@ -747,9 +737,9 @@ int suffix_search(const unsigned char *data,
</a>         lt_index lt = {data, st.depth};
         for (IndexKey::iterator it = st.key-&gt;begin();
              it != st.key-&gt;end(); ++it) {
<a href="#h4-14-3" id="h4-14-3" class="d">-            uint32_t *l, *r;
</a><a href="#h4-14-4" id="h4-14-4" class="i">+            const uint32_t *l, *r;
</a>             l = lower_bound(st.left, st.right, it-&gt;first.first, lt);
<a href="#h4-14-6" id="h4-14-6" class="d">-            uint32_t *right = lower_bound(l, st.right,
</a><a href="#h4-14-7" id="h4-14-7" class="i">+            const uint32_t *right = lower_bound(l, st.right,
</a>                                           (unsigned char)(it-&gt;first.second + 1),
                                           lt);
             if (l == right)
<a href="#h4-15" id="h4-15" class="h">@@ -984,7 +974,7 @@ void searcher::find_match(const chunk *chunk,
</a> 
     vector&lt;chunk_file_node *&gt; stack;
     assert(chunk-&gt;cf_root);
<a href="#h4-15-3" id="h4-15-3" class="d">-    stack.push_back(chunk-&gt;cf_root);
</a><a href="#h4-15-4" id="h4-15-4" class="i">+    stack.push_back(chunk-&gt;cf_root.get());
</a> 
     debug(kDebugSearch, &quot;find_match(%d)&quot;, loff);
 
<a href="#h4-16" id="h4-16" class="h">@@ -1000,7 +990,7 @@ void searcher::find_match(const chunk *chunk,
</a>             continue;
         if (loff &gt;= n-&gt;chunk-&gt;left) {
             if (n-&gt;right)
<a href="#h4-16-3" id="h4-16-3" class="d">-                stack.push_back(n-&gt;right);
</a><a href="#h4-16-4" id="h4-16-4" class="i">+                stack.push_back(n-&gt;right.get());
</a>             if (loff &lt;= n-&gt;chunk-&gt;right) {
                 debug(kDebugSearch, &quot;visit &lt;%d-%d&gt;&quot;, n-&gt;chunk-&gt;left, n-&gt;chunk-&gt;right);
                 assert(loff &gt;= n-&gt;chunk-&gt;left &amp;&amp; loff &lt;= n-&gt;chunk-&gt;right);
<a href="#h4-17" id="h4-17" class="h">@@ -1015,7 +1005,7 @@ void searcher::find_match(const chunk *chunk,
</a>             }
         }
         if (n-&gt;left)
<a href="#h4-17-3" id="h4-17-3" class="d">-            stack.push_back(n-&gt;left);
</a><a href="#h4-17-4" id="h4-17-4" class="i">+            stack.push_back(n-&gt;left.get());
</a>     }
 }
 
<a href="#h4-18" id="h4-18" class="h">@@ -1025,10 +1015,10 @@ void searcher::try_match(const StringPiece&amp; line,
</a>                          indexed_file *sf) {
 
     int lno = 1;
<a href="#h4-18-3" id="h4-18-3" class="d">-    auto it = sf-&gt;content-&gt;begin(cc_-&gt;alloc_);
</a><a href="#h4-18-4" id="h4-18-4" class="i">+    auto it = sf-&gt;content-&gt;begin(cc_-&gt;alloc_.get());
</a> 
     while (true) {
<a href="#h4-18-7" id="h4-18-7" class="d">-        for (;it != sf-&gt;content-&gt;end(cc_-&gt;alloc_); ++it) {
</a><a href="#h4-18-8" id="h4-18-8" class="i">+        for (;it != sf-&gt;content-&gt;end(cc_-&gt;alloc_.get()); ++it) {
</a>             if (line.data() &gt;= it-&gt;data() &amp;&amp;
                 line.data() &lt;= it-&gt;data() + it-&gt;size()) {
                 lno += count(it-&gt;data(), line.data(), &#39;\n&#39;);
<a href="#h4-19" id="h4-19" class="h">@@ -1040,7 +1030,7 @@ void searcher::try_match(const StringPiece&amp; line,
</a> 
         debug(kDebugSearch, &quot;found match on %s:%d&quot;, sf-&gt;path.c_str(), lno);
 
<a href="#h4-19-3" id="h4-19-3" class="d">-        if (it == sf-&gt;content-&gt;end(cc_-&gt;alloc_))
</a><a href="#h4-19-4" id="h4-19-4" class="i">+        if (it == sf-&gt;content-&gt;end(cc_-&gt;alloc_.get()))
</a>             return;
 
         match_result *m = new match_result;
<a href="#h4-20" id="h4-20" class="h">@@ -1058,7 +1048,7 @@ void searcher::try_match(const StringPiece&amp; line,
</a> 
         for (i = 0; i &lt; kContextLines; i++) {
             if (l.data() == bit-&gt;data()) {
<a href="#h4-20-3" id="h4-20-3" class="d">-                if (bit == sf-&gt;content-&gt;begin(cc_-&gt;alloc_))
</a><a href="#h4-20-4" id="h4-20-4" class="i">+                if (bit == sf-&gt;content-&gt;begin(cc_-&gt;alloc_.get()))
</a>                     break;
                 --bit;
                 l = StringPiece(bit-&gt;data() + bit-&gt;size() + 1, 0);
<a href="#h4-21" id="h4-21" class="h">@@ -1071,7 +1061,7 @@ void searcher::try_match(const StringPiece&amp; line,
</a> 
         for (i = 0; i &lt; kContextLines; i++) {
             if (l.data() + l.size() == fit-&gt;data() + fit-&gt;size()) {
<a href="#h4-21-3" id="h4-21-3" class="d">-                if (++fit == sf-&gt;content-&gt;end(cc_-&gt;alloc_))
</a><a href="#h4-21-4" id="h4-21-4" class="i">+                if (++fit == sf-&gt;content-&gt;end(cc_-&gt;alloc_.get()))
</a>                     break;
                 l = StringPiece(fit-&gt;data() - 1, 0);
             }
<b>diff --git a/<a id="h5" href="../file/src/codesearch.h">src/codesearch.h</a> b/<a href="../file/src/codesearch.h">src/codesearch.h</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -16,6 +16,7 @@
</a> #include &lt;mutex&gt;
 #include &lt;thread&gt;
 #include &lt;functional&gt;
<a href="#h5-0-3" id="h5-0-3" class="i">+#include &lt;memory&gt;
</a> #include &lt;boost/intrusive_ptr.hpp&gt;
 
 #ifdef USE_DENSE_HASH_SET
<a href="#h5-1" id="h5-1" class="h">@@ -161,8 +162,8 @@ public:
</a>                     StringPiece contents);
     void finalize();
 
<a href="#h5-1-3" id="h5-1-3" class="d">-    void set_alloc(chunk_allocator *alloc);
</a><a href="#h5-1-4" id="h5-1-4" class="d">-    chunk_allocator *alloc() { return alloc_; }
</a><a href="#h5-1-5" id="h5-1-5" class="i">+    void set_alloc(std::unique_ptr&lt;chunk_allocator&gt; alloc);
</a><a href="#h5-1-6" id="h5-1-6" class="i">+    chunk_allocator *alloc() { return alloc_.get(); }
</a> 
     vector&lt;indexed_tree&gt; trees() const;
     string name() const {
<a href="#h5-2" id="h5-2" class="h">@@ -172,10 +173,10 @@ public:
</a>         name_ = name;
     }
 
<a href="#h5-2-3" id="h5-2-3" class="d">-    vector&lt;indexed_file*&gt;::const_iterator begin_files() {
</a><a href="#h5-2-4" id="h5-2-4" class="i">+    vector&lt;std::unique_ptr&lt;indexed_file&gt;&gt;::const_iterator begin_files() {
</a>         return files_.begin();
     }
<a href="#h5-2-7" id="h5-2-7" class="d">-    vector&lt;indexed_file*&gt;::const_iterator end_files() {
</a><a href="#h5-2-8" id="h5-2-8" class="i">+    vector&lt;std::unique_ptr&lt;indexed_file&gt;&gt;::const_iterator end_files() {
</a>         return files_.end();
     }
 
<a href="#h5-3" id="h5-3" class="h">@@ -238,7 +239,7 @@ protected:
</a>     // present.
     string_hash lines_;
 
<a href="#h5-3-3" id="h5-3-3" class="d">-    chunk_allocator *alloc_;
</a><a href="#h5-3-4" id="h5-3-4" class="i">+    std::unique_ptr&lt;chunk_allocator&gt; alloc_;
</a> 
     // Indicates that everything all is ready for searching--we are done creating
     // index or initializing it from a file.
<a href="#h5-4" id="h5-4" class="h">@@ -249,14 +250,13 @@ protected:
</a> 
     // Structures for fast filename search; somewhat similar to a single chunk.
     // Built from files_ at finalization, not serialized or anything like that.
<a href="#h5-4-3" id="h5-4-3" class="d">-    unsigned char *filename_data_;
</a><a href="#h5-4-4" id="h5-4-4" class="d">-    int filename_data_size_;
</a><a href="#h5-4-5" id="h5-4-5" class="d">-    uint32_t *filename_suffixes_;
</a><a href="#h5-4-6" id="h5-4-6" class="i">+    vector&lt;unsigned char&gt; filename_data_;
</a><a href="#h5-4-7" id="h5-4-7" class="i">+    vector&lt;uint32_t&gt; filename_suffixes_;
</a>     // pairs (i, file), where file-&gt;path starts at filename_data_[i]
     vector&lt;pair&lt;int, indexed_file*&gt;&gt; filename_positions_;
 
<a href="#h5-4-11" id="h5-4-11" class="d">-    vector&lt;indexed_tree*&gt; trees_;
</a><a href="#h5-4-12" id="h5-4-12" class="d">-    vector&lt;indexed_file*&gt; files_;
</a><a href="#h5-4-13" id="h5-4-13" class="i">+    vector&lt;std::unique_ptr&lt;indexed_tree&gt;&gt; trees_;
</a><a href="#h5-4-14" id="h5-4-14" class="i">+    vector&lt;std::unique_ptr&lt;indexed_file&gt;&gt; files_;
</a> 
 private:
     void index_filenames();
<a href="#h5-5" id="h5-5" class="h">@@ -270,9 +270,9 @@ private:
</a> };
 
 // dump_load.cc
<a href="#h5-5-3" id="h5-5-3" class="d">-chunk_allocator *make_dump_allocator(code_searcher *search, const string&amp; path);
</a><a href="#h5-5-4" id="h5-5-4" class="i">+std::unique_ptr&lt;chunk_allocator&gt; make_dump_allocator(code_searcher *search, const string&amp; path);
</a> // chunk_allocator.cc
<a href="#h5-5-6" id="h5-5-6" class="d">-chunk_allocator *make_mem_allocator();
</a><a href="#h5-5-7" id="h5-5-7" class="i">+std::unique_ptr&lt;chunk_allocator&gt; make_mem_allocator();
</a> 
 void default_re2_options(RE2::Options&amp;);
 
<b>diff --git a/<a id="h6" href="../file/src/dump_load.cc">src/dump_load.cc</a> b/<a href="../file/src/dump_load.cc">src/dump_load.cc</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -214,7 +214,7 @@ protected:
</a>         p_ = static_cast&lt;uint8_t*&gt;(map_) + off;
     }
 
<a href="#h6-0-3" id="h6-0-3" class="d">-    indexed_file *load_file(code_searcher *cs);
</a><a href="#h6-0-4" id="h6-0-4" class="i">+    std::unique_ptr&lt;indexed_file&gt; load_file(code_searcher *cs);
</a>     void load_chunk(code_searcher *);
 
     uint32_t load_int32() {
<a href="#h6-1" id="h6-1" class="h">@@ -238,8 +238,8 @@ protected:
</a>     chunk_header *next_chunk_;
 };
 
<a href="#h6-1-3" id="h6-1-3" class="d">-chunk_allocator *make_dump_allocator(code_searcher *search, const string&amp; path) {
</a><a href="#h6-1-4" id="h6-1-4" class="d">-    return new dump_allocator(search, path.c_str());
</a><a href="#h6-1-5" id="h6-1-5" class="i">+std::unique_ptr&lt;chunk_allocator&gt; make_dump_allocator(code_searcher *search, const string&amp; path) {
</a><a href="#h6-1-6" id="h6-1-6" class="i">+    return std::make_unique&lt;dump_allocator&gt;(search, path.c_str());
</a> }
 
 void codesearch_index::dump_file(map&lt;const indexed_tree*, int&gt;&amp; ids, indexed_file *sf) {
<a href="#h6-2" id="h6-2" class="h">@@ -303,12 +303,12 @@ void codesearch_index::dump_metadata() {
</a>             dump_string(json_object_to_json_string((*it)-&gt;metadata));
         else
             dump_string(&quot;&quot;);
<a href="#h6-2-3" id="h6-2-3" class="d">-        tree_ids[*it] = it - cs_-&gt;trees_.begin();
</a><a href="#h6-2-4" id="h6-2-4" class="i">+        tree_ids[it-&gt;get()] = it - cs_-&gt;trees_.begin();
</a>     }
     hdr_.files_off = stream_.tellp();
<a href="#h6-2-7" id="h6-2-7" class="d">-    for (vector&lt;indexed_file*&gt;::iterator it = cs_-&gt;files_.begin();
</a><a href="#h6-2-8" id="h6-2-8" class="i">+    for (auto it = cs_-&gt;files_.begin();
</a>          it != cs_-&gt;files_.end(); ++it)
<a href="#h6-2-10" id="h6-2-10" class="d">-        dump_file(tree_ids, *it);
</a><a href="#h6-2-11" id="h6-2-11" class="i">+        dump_file(tree_ids, it-&gt;get());
</a> 
     auto hdr = chunks_.begin();
     for (auto it = cs_-&gt;alloc_-&gt;begin();
<a href="#h6-3" id="h6-3" class="h">@@ -391,9 +391,9 @@ chunk *load_allocator::alloc_chunk() {
</a>     return new chunk(data, indexes);
 }
 
<a href="#h6-3-3" id="h6-3-3" class="d">-indexed_file *load_allocator::load_file(code_searcher *cs) {
</a><a href="#h6-3-4" id="h6-3-4" class="d">-    indexed_file *sf = new indexed_file;
</a><a href="#h6-3-5" id="h6-3-5" class="d">-    sf-&gt;tree = cs-&gt;trees_[load_int32()];
</a><a href="#h6-3-6" id="h6-3-6" class="i">+unique_ptr&lt;indexed_file&gt; load_allocator::load_file(code_searcher *cs) {
</a><a href="#h6-3-7" id="h6-3-7" class="i">+    auto sf = std::make_unique&lt;indexed_file&gt;();
</a><a href="#h6-3-8" id="h6-3-8" class="i">+    sf-&gt;tree = cs-&gt;trees_[load_int32()].get();
</a>     sf-&gt;path = load_string();
     sf-&gt;no = cs-&gt;files_.size();
     return sf;
<a href="#h6-4" id="h6-4" class="h">@@ -413,7 +413,7 @@ void load_allocator::load_chunk(code_searcher *cs) {
</a>         chunk_file &amp;cf = chunk-&gt;files.back();
         uint32_t nfiles = load_int32();
         for (int j = 0; j &lt; nfiles; j++)
<a href="#h6-4-3" id="h6-4-3" class="d">-            cf.files.push_back(cs-&gt;files_[load_int32()]);
</a><a href="#h6-4-4" id="h6-4-4" class="i">+            cf.files.push_back(cs-&gt;files_[load_int32()].get());
</a>         cf.left  = load_int32();
         cf.right = load_int32();
     }
<a href="#h6-5" id="h6-5" class="h">@@ -434,7 +434,7 @@ void load_allocator::load(code_searcher *cs) {
</a> 
     p_ = ptr&lt;uint8_t&gt;(hdr_-&gt;refs_off);
     for (int i = 0; i &lt; hdr_-&gt;ntrees; i++) {
<a href="#h6-5-3" id="h6-5-3" class="d">-        indexed_tree *tree = new indexed_tree;
</a><a href="#h6-5-4" id="h6-5-4" class="i">+        auto tree = std::make_unique&lt;indexed_tree&gt;();
</a>         tree-&gt;name = load_string();
         tree-&gt;version = load_string();
         string metadata = load_string();
<a href="#h6-6" id="h6-6" class="h">@@ -446,7 +446,7 @@ void load_allocator::load(code_searcher *cs) {
</a>             tree-&gt;metadata = js;
         }
 
<a href="#h6-6-3" id="h6-6-3" class="d">-        cs-&gt;trees_.push_back(tree);
</a><a href="#h6-6-4" id="h6-6-4" class="i">+        cs-&gt;trees_.push_back(move(tree));
</a>     }
 
     p_ = ptr&lt;uint8_t&gt;(hdr_-&gt;files_off);
<a href="#h6-7" id="h6-7" class="h">@@ -491,7 +491,7 @@ void code_searcher::dump_index(const string &amp;path) {
</a> }
 
 void code_searcher::load_index(const string &amp;path) {
<a href="#h6-7-3" id="h6-7-3" class="d">-    load_allocator *alloc = new load_allocator(this, path);
</a><a href="#h6-7-4" id="h6-7-4" class="d">-    set_alloc(alloc);
</a><a href="#h6-7-5" id="h6-7-5" class="d">-    alloc-&gt;load(this);
</a><a href="#h6-7-6" id="h6-7-6" class="i">+    std::unique_ptr&lt;load_allocator&gt; alloc = std::make_unique&lt;load_allocator&gt;(this, path);
</a><a href="#h6-7-7" id="h6-7-7" class="i">+    set_alloc(move(alloc));
</a><a href="#h6-7-8" id="h6-7-8" class="i">+    dynamic_cast&lt;load_allocator*&gt;(alloc_.get())-&gt;load(this);
</a> }
<b>diff --git a/<a id="h7" href="../file/src/tagsearch.cc">src/tagsearch.cc</a> b/<a href="../file/src/tagsearch.cc">src/tagsearch.cc</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -50,9 +50,9 @@ std::string create_tag_line_regex(
</a> };
 
 void tag_searcher::cache_indexed_files(code_searcher* cs) {
<a href="#h7-0-3" id="h7-0-3" class="d">-    file_alloc_ = cs-&gt;alloc_;
</a><a href="#h7-0-4" id="h7-0-4" class="i">+    file_alloc_ = cs-&gt;alloc_.get();
</a>     for (auto it = cs-&gt;begin_files(); it != cs-&gt;end_files(); ++it) {
<a href="#h7-0-6" id="h7-0-6" class="d">-        auto file = *it;
</a><a href="#h7-0-7" id="h7-0-7" class="i">+        auto file = it-&gt;get();
</a>         auto key = path(file-&gt;tree-&gt;name) / path(file-&gt;path);
         path_to_file_map_.insert(std::make_pair(key.string(), file));
     }
<b>diff --git a/<a id="h8" href="../file/src/tools/codesearch.cc">src/tools/codesearch.cc</a> b/<a href="../file/src/tools/codesearch.cc">src/tools/codesearch.cc</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -10,6 +10,7 @@
</a> #include &quot;src/lib/debug.h&quot;
 
 #include &quot;src/codesearch.h&quot;
<a href="#h8-0-3" id="h8-0-3" class="i">+#include &quot;src/chunk_allocator.h&quot;
</a> #include &quot;src/tagsearch.h&quot;
 #include &quot;src/re_width.h&quot;
 #include &quot;src/git_indexer.h&quot;
<b>diff --git a/<a id="h9" href="../file/src/tools/dump-file.cc">src/tools/dump-file.cc</a> b/<a href="../file/src/tools/dump-file.cc">src/tools/dump-file.cc</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -34,7 +34,7 @@ int dump_file(int argc, char **argv) {
</a> 
     for (auto it = cs.begin_files(); it != cs.end_files(); ++it) {
         if ((*it)-&gt;path == path) {
<a href="#h9-0-3" id="h9-0-3" class="d">-            dump_file(&amp;cs, *it);
</a><a href="#h9-0-4" id="h9-0-4" class="i">+            dump_file(&amp;cs, it-&gt;get());
</a>             return 0;
         }
     }
<b>diff --git a/<a id="h10" href="../file/test/codesearch_test.cc">test/codesearch_test.cc</a> b/<a href="../file/test/codesearch_test.cc">test/codesearch_test.cc</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -26,7 +26,7 @@ TEST_F(codesearch_test, IndexTest) {
</a> 
     EXPECT_EQ(1, cs_.end_files() - cs_.begin_files());
 
<a href="#h10-0-3" id="h10-0-3" class="d">-    indexed_file *f = *cs_.begin_files();
</a><a href="#h10-0-4" id="h10-0-4" class="i">+    indexed_file *f = cs_.begin_files()-&gt;get();
</a>     EXPECT_EQ(&quot;/data/file1&quot;, f-&gt;path);
     EXPECT_EQ(tree_, f-&gt;tree);
 
<a href="#h10-1" id="h10-1" class="h">@@ -61,7 +61,7 @@ TEST_F(codesearch_test, NoTrailingNewLine) {
</a> 
     EXPECT_EQ(1, cs_.end_files() - cs_.begin_files());
 
<a href="#h10-1-3" id="h10-1-3" class="d">-    indexed_file *f = *cs_.begin_files();
</a><a href="#h10-1-4" id="h10-1-4" class="i">+    indexed_file *f = cs_.begin_files()-&gt;get();
</a>     EXPECT_EQ(&quot;/data/file1&quot;, f-&gt;path);
     EXPECT_EQ(tree_, f-&gt;tree);
 
</pre>
</div>
</body>
</html>
