<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Merge pull request #8 from livegrep/query-string - livegrep - Fast, regular expression code search service</title>
<meta name="description" content="Fast, regular expression code search service" />
<meta name="author" content="Kevin Lin" />
<link rel="icon" type="image/png" href="https://static.kevinlin.info/favicon.png" />
<link rel="alternate" type="application/atom+xml" title="livegrep Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="livegrep Atom Feed (tags)" href="../tags.xml" />
<style type="text/css">
body{color:#000;background-color:#fff;font-family:monospace}h1,h2,h3,h4,h5,h6{font-size:1em;margin:0}img,h1,h2{vertical-align:middle}img{border:0}a:target{background-color:#ccc}a.d,a.h,a.i{text-decoration:none}a.line{text-decoration:none;user-select:none}#blob a{color:#555}#blob a:hover{color:blue;text-decoration:none}table thead td{font-weight:bold}table td{padding:0 .4em}table td pre{margin:0}#content table td{vertical-align:top;white-space:nowrap}#branches tr:hover td,#tags tr:hover td,#index tr:hover td,#log tr:hover td,#files tr:hover td{background-color:#eee}#index tr td:nth-child(2),#tags tr td:nth-child(3),#branches tr td:nth-child(3),#log tr td:nth-child(2){white-space:normal}td.num{text-align:right}.desc{color:#555}hr{border:0;border-top:1px solid #555;height:1px}pre{font-family:monospace}pre a.h{color:#00a}.A,span.i,pre a.i{color:#070}.D,span.d,pre a.d{color:#e00}pre a.h:hover,pre a.i:hover,pre a.d:hover{text-decoration:none}
</style>
</head>
<body>
<table><tr><td><a href="/"><img src="https://static.kevinlin.info/favicon.png" alt="" width="32" height="32" /></a></td><td><h1>livegrep</h1><span class="desc">Fast, regular expression code search service</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://source.static.kevinlin.info/external/livegrep.git">https://source.static.kevinlin.info/external/livegrep.git</a></td></tr><tr><td></td><td>
<a href="../log">Log</a> | <a href="../files">Files</a> | <a href="../refs">Refs</a> | <a href="../file/README.md">README</a> | <a href="../file/COPYING">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/e62727ea9d0317b95f3b516879198dd2d0bea955">e62727ea9d0317b95f3b516879198dd2d0bea955</a>
<b>parent</b> <a href="../commit/cbb5f7ff130d1aa6c61a2ad90812817007435511">cbb5f7ff130d1aa6c61a2ad90812817007435511</a>
<b>Author:</b> Nelson Elhage &lt;<a href="mailto:nelhage@nelhage.com">nelhage@nelhage.com</a>&gt;
<b>Date:</b>   Sat, 27 Dec 2014 01:31:25 +0200

Merge pull request #8 from livegrep/query-string

Replace the separate search boxes with a query string.
<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">Vagrantfile</a></td><td> | </td><td class="num">5</td><td><span class="i">+++</span><span class="d">--</span></td></tr>
<tr><td class="A">A</td><td><a href="#h1">client/test/mock_test.go</a></td><td> | </td><td class="num">75</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">client/test/testutil.go</a></td><td> | </td><td class="num">51</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">doc/examples/livegrep/index.json</a></td><td> | </td><td class="num">8</td><td><span class="i">++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">livegrep/livegrep.go</a></td><td> | </td><td class="num">2</td><td><span class="i">++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">server/api.go</a></td><td> | </td><td class="num">31</td><td><span class="i">+++++++++++++++++++++</span><span class="d">----------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h6">server/backend.go</a></td><td> | </td><td class="num">131</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h7">server/backend/backend.go</a></td><td> | </td><td class="num">104</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h8">server/backend_test.go</a></td><td> | </td><td class="num">102</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h9">server/config/config.go</a></td><td> | </td><td class="num">23</td><td><span class="i">+++++++</span><span class="d">----------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h10">server/query.go</a></td><td> | </td><td class="num">84</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h11">server/query_test.go</a></td><td> | </td><td class="num">84</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h12">server/server.go</a></td><td> | </td><td class="num">99</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">---------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h13">server/templates.go</a></td><td> | </td><td class="num">41</td><td><span class="i">+++++++</span><span class="d">----------------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h14">server/templates/templates.go</a></td><td> | </td><td class="num">62</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h15">web/htdocs/assets/css/codesearch.css</a></td><td> | </td><td class="num">69</td><td><span class="i">++++++++++++++++++++++++++++++++++</span><span class="d">-----------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h16">web/htdocs/assets/js/codesearch.js</a></td><td> | </td><td class="num">9</td><td><span class="i">+</span><span class="d">--------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h17">web/htdocs/assets/js/codesearch_ui.js</a></td><td> | </td><td class="num">60</td><td><span class="i">+++++++++++++++++++</span><span class="d">-----------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h18">web/templates/about.html</a></td><td> | </td><td class="num">9</td><td><span class="i">++++</span><span class="d">-----</span></td></tr>
<tr><td class="A">A</td><td><a href="#h19">web/templates/help.html</a></td><td> | </td><td class="num">68</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h20">web/templates/index.html</a></td><td> | </td><td class="num">65</td><td><span class="i">+++++++++++++++++++++++++++</span><span class="d">--------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h21">web/templates/layout.html</a></td><td> | </td><td class="num">18</td><td><span class="i">+</span><span class="d">-----------------</span></td></tr>
</table></pre><pre>22 files changed, 864 insertions(+), 336 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/Vagrantfile">Vagrantfile</a> b/<a href="../file/Vagrantfile">Vagrantfile</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -42,8 +42,9 @@ EOF
</a> set -ex
 wget --no-verbose -O /usr/local/src/go#{GOLANG_VERSION}.tgz http://golang.org/dl/go#{GOLANG_VERSION}.linux-amd64.tar.gz
 tar -C /usr/local -xzf /usr/local/src/go#{GOLANG_VERSION}.tgz
<a href="#h0-0-3" id="h0-0-3" class="d">-mkdir /gopath
</a><a href="#h0-0-4" id="h0-0-4" class="d">-chown vagrant:vagrant /gopath
</a><a href="#h0-0-5" id="h0-0-5" class="i">+mkdir -p /gopath/src/github.com/livegrep/
</a><a href="#h0-0-6" id="h0-0-6" class="i">+ln -nsf /vagrant /gopath/src/github.com/livegrep/livegrep
</a><a href="#h0-0-7" id="h0-0-7" class="i">+chown -R vagrant:vagrant /gopath
</a> cat &gt;/etc/profile.d/golang.sh &lt;&lt;EOT
 export PATH=$PATH:/usr/local/go/bin
 export GOPATH=/gopath
<b>diff --git a/<a id="h1" href="../file/client/test/mock_test.go">client/test/mock_test.go</a> b/<a href="../file/client/test/mock_test.go">client/test/mock_test.go</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -0,0 +1,75 @@
</a><a href="#h1-0-0" id="h1-0-0" class="i">+package test
</a><a href="#h1-0-1" id="h1-0-1" class="i">+
</a><a href="#h1-0-2" id="h1-0-2" class="i">+import (
</a><a href="#h1-0-3" id="h1-0-3" class="i">+	&quot;errors&quot;
</a><a href="#h1-0-4" id="h1-0-4" class="i">+	&quot;reflect&quot;
</a><a href="#h1-0-5" id="h1-0-5" class="i">+	&quot;testing&quot;
</a><a href="#h1-0-6" id="h1-0-6" class="i">+
</a><a href="#h1-0-7" id="h1-0-7" class="i">+	&quot;github.com/livegrep/livegrep/client&quot;
</a><a href="#h1-0-8" id="h1-0-8" class="i">+)
</a><a href="#h1-0-9" id="h1-0-9" class="i">+
</a><a href="#h1-0-10" id="h1-0-10" class="i">+func TestQueryError(t *testing.T) {
</a><a href="#h1-0-11" id="h1-0-11" class="i">+	m := &amp;MockClient{QueryError: errors.New(&quot;query error&quot;)}
</a><a href="#h1-0-12" id="h1-0-12" class="i">+	s, e := m.Query(&amp;client.Query{})
</a><a href="#h1-0-13" id="h1-0-13" class="i">+	if e == nil || s != nil {
</a><a href="#h1-0-14" id="h1-0-14" class="i">+		t.Fatalf(&quot;QueryError&quot;)
</a><a href="#h1-0-15" id="h1-0-15" class="i">+	}
</a><a href="#h1-0-16" id="h1-0-16" class="i">+	if e.Error() != &quot;query error&quot; {
</a><a href="#h1-0-17" id="h1-0-17" class="i">+		t.Fatalf(&quot;QueryError %s&quot;, e)
</a><a href="#h1-0-18" id="h1-0-18" class="i">+	}
</a><a href="#h1-0-19" id="h1-0-19" class="i">+}
</a><a href="#h1-0-20" id="h1-0-20" class="i">+
</a><a href="#h1-0-21" id="h1-0-21" class="i">+func TestSearchError(t *testing.T) {
</a><a href="#h1-0-22" id="h1-0-22" class="i">+	m := &amp;MockClient{SearchError: errors.New(&quot;search error&quot;)}
</a><a href="#h1-0-23" id="h1-0-23" class="i">+	s, e := m.Query(&amp;client.Query{})
</a><a href="#h1-0-24" id="h1-0-24" class="i">+	if e != nil || s == nil {
</a><a href="#h1-0-25" id="h1-0-25" class="i">+		t.Fatal(&quot;SearchError&quot;)
</a><a href="#h1-0-26" id="h1-0-26" class="i">+	}
</a><a href="#h1-0-27" id="h1-0-27" class="i">+	r := s.Results()
</a><a href="#h1-0-28" id="h1-0-28" class="i">+	if _, ok := &lt;-r; ok {
</a><a href="#h1-0-29" id="h1-0-29" class="i">+		t.Fatal(&quot;SearchError results&quot;)
</a><a href="#h1-0-30" id="h1-0-30" class="i">+	}
</a><a href="#h1-0-31" id="h1-0-31" class="i">+	_, e = s.Close()
</a><a href="#h1-0-32" id="h1-0-32" class="i">+	if e == nil {
</a><a href="#h1-0-33" id="h1-0-33" class="i">+		t.Fatal(&quot;SearchError error&quot;)
</a><a href="#h1-0-34" id="h1-0-34" class="i">+	}
</a><a href="#h1-0-35" id="h1-0-35" class="i">+	if e.Error() != &quot;search error&quot; {
</a><a href="#h1-0-36" id="h1-0-36" class="i">+		t.Fatal(&quot;SearchErrors&quot;, e)
</a><a href="#h1-0-37" id="h1-0-37" class="i">+	}
</a><a href="#h1-0-38" id="h1-0-38" class="i">+}
</a><a href="#h1-0-39" id="h1-0-39" class="i">+
</a><a href="#h1-0-40" id="h1-0-40" class="i">+func TestErr(t *testing.T) {
</a><a href="#h1-0-41" id="h1-0-41" class="i">+	m := &amp;MockClient{Err_: errors.New(&quot;client error&quot;)}
</a><a href="#h1-0-42" id="h1-0-42" class="i">+	e := m.Err()
</a><a href="#h1-0-43" id="h1-0-43" class="i">+	if e == nil || e.Error() != &quot;client error&quot; {
</a><a href="#h1-0-44" id="h1-0-44" class="i">+		t.Fatal(&quot;Err&quot;, e)
</a><a href="#h1-0-45" id="h1-0-45" class="i">+	}
</a><a href="#h1-0-46" id="h1-0-46" class="i">+}
</a><a href="#h1-0-47" id="h1-0-47" class="i">+
</a><a href="#h1-0-48" id="h1-0-48" class="i">+func TestResults(t *testing.T) {
</a><a href="#h1-0-49" id="h1-0-49" class="i">+	rs := []*client.Result{
</a><a href="#h1-0-50" id="h1-0-50" class="i">+		{Line: &quot;line 1&quot;},
</a><a href="#h1-0-51" id="h1-0-51" class="i">+		{Line: &quot;line 2&quot;},
</a><a href="#h1-0-52" id="h1-0-52" class="i">+	}
</a><a href="#h1-0-53" id="h1-0-53" class="i">+	st := &amp;client.Stats{ExitReason: &quot;time&quot;}
</a><a href="#h1-0-54" id="h1-0-54" class="i">+	m := &amp;MockClient{Results: rs, Stats: st}
</a><a href="#h1-0-55" id="h1-0-55" class="i">+	s, e := m.Query(&amp;client.Query{})
</a><a href="#h1-0-56" id="h1-0-56" class="i">+	if s == nil || e != nil {
</a><a href="#h1-0-57" id="h1-0-57" class="i">+		t.Fatal(&quot;Results&quot;, s, e)
</a><a href="#h1-0-58" id="h1-0-58" class="i">+	}
</a><a href="#h1-0-59" id="h1-0-59" class="i">+	rc := s.Results()
</a><a href="#h1-0-60" id="h1-0-60" class="i">+	i := 0
</a><a href="#h1-0-61" id="h1-0-61" class="i">+	for r := range rc {
</a><a href="#h1-0-62" id="h1-0-62" class="i">+		if !reflect.DeepEqual(r, rs[i]) {
</a><a href="#h1-0-63" id="h1-0-63" class="i">+			t.Fatal(&quot;result&quot;, i, r)
</a><a href="#h1-0-64" id="h1-0-64" class="i">+		}
</a><a href="#h1-0-65" id="h1-0-65" class="i">+		i++
</a><a href="#h1-0-66" id="h1-0-66" class="i">+	}
</a><a href="#h1-0-67" id="h1-0-67" class="i">+	if i != len(rs) {
</a><a href="#h1-0-68" id="h1-0-68" class="i">+		t.Fatalf(&quot;len %d!=%d&quot;, len(rs), i)
</a><a href="#h1-0-69" id="h1-0-69" class="i">+	}
</a><a href="#h1-0-70" id="h1-0-70" class="i">+	st_, e := s.Close()
</a><a href="#h1-0-71" id="h1-0-71" class="i">+	if st_ != st || e != nil {
</a><a href="#h1-0-72" id="h1-0-72" class="i">+		t.Fatal(&quot;Results&quot;)
</a><a href="#h1-0-73" id="h1-0-73" class="i">+	}
</a><a href="#h1-0-74" id="h1-0-74" class="i">+}
</a><b>diff --git a/<a id="h2" href="../file/client/test/testutil.go">client/test/testutil.go</a> b/<a href="../file/client/test/testutil.go">client/test/testutil.go</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -94,3 +94,54 @@ func NewClient(args ...string) (client.Client, error) {
</a> 
 	return cl, nil
 }
<a href="#h2-0-3" id="h2-0-3" class="i">+
</a><a href="#h2-0-4" id="h2-0-4" class="i">+// MockClient implements a fake Client that returns constant values
</a><a href="#h2-0-5" id="h2-0-5" class="i">+// based on the provided fields.
</a><a href="#h2-0-6" id="h2-0-6" class="i">+type MockClient struct {
</a><a href="#h2-0-7" id="h2-0-7" class="i">+	QueryError  error
</a><a href="#h2-0-8" id="h2-0-8" class="i">+	SearchError error
</a><a href="#h2-0-9" id="h2-0-9" class="i">+	Err_        error
</a><a href="#h2-0-10" id="h2-0-10" class="i">+	Info_       *client.ServerInfo
</a><a href="#h2-0-11" id="h2-0-11" class="i">+	Stats       *client.Stats
</a><a href="#h2-0-12" id="h2-0-12" class="i">+	Results     []*client.Result
</a><a href="#h2-0-13" id="h2-0-13" class="i">+
</a><a href="#h2-0-14" id="h2-0-14" class="i">+	Closed  bool
</a><a href="#h2-0-15" id="h2-0-15" class="i">+	Queries []*client.Query
</a><a href="#h2-0-16" id="h2-0-16" class="i">+}
</a><a href="#h2-0-17" id="h2-0-17" class="i">+
</a><a href="#h2-0-18" id="h2-0-18" class="i">+type mockSearch struct {
</a><a href="#h2-0-19" id="h2-0-19" class="i">+	m *MockClient
</a><a href="#h2-0-20" id="h2-0-20" class="i">+}
</a><a href="#h2-0-21" id="h2-0-21" class="i">+
</a><a href="#h2-0-22" id="h2-0-22" class="i">+func (m *MockClient) Query(q *client.Query) (client.Search, error) {
</a><a href="#h2-0-23" id="h2-0-23" class="i">+	m.Queries = append(m.Queries, q)
</a><a href="#h2-0-24" id="h2-0-24" class="i">+	if m.QueryError != nil {
</a><a href="#h2-0-25" id="h2-0-25" class="i">+		return nil, m.QueryError
</a><a href="#h2-0-26" id="h2-0-26" class="i">+	}
</a><a href="#h2-0-27" id="h2-0-27" class="i">+	return &amp;mockSearch{m}, nil
</a><a href="#h2-0-28" id="h2-0-28" class="i">+}
</a><a href="#h2-0-29" id="h2-0-29" class="i">+
</a><a href="#h2-0-30" id="h2-0-30" class="i">+func (m *MockClient) Close() {
</a><a href="#h2-0-31" id="h2-0-31" class="i">+	m.Closed = true
</a><a href="#h2-0-32" id="h2-0-32" class="i">+}
</a><a href="#h2-0-33" id="h2-0-33" class="i">+
</a><a href="#h2-0-34" id="h2-0-34" class="i">+func (m *MockClient) Info() *client.ServerInfo {
</a><a href="#h2-0-35" id="h2-0-35" class="i">+	return m.Info_
</a><a href="#h2-0-36" id="h2-0-36" class="i">+}
</a><a href="#h2-0-37" id="h2-0-37" class="i">+
</a><a href="#h2-0-38" id="h2-0-38" class="i">+func (m *MockClient) Err() error {
</a><a href="#h2-0-39" id="h2-0-39" class="i">+	return m.Err_
</a><a href="#h2-0-40" id="h2-0-40" class="i">+}
</a><a href="#h2-0-41" id="h2-0-41" class="i">+
</a><a href="#h2-0-42" id="h2-0-42" class="i">+func (s *mockSearch) Results() &lt;-chan *client.Result {
</a><a href="#h2-0-43" id="h2-0-43" class="i">+	out := make(chan *client.Result, len(s.m.Results))
</a><a href="#h2-0-44" id="h2-0-44" class="i">+	for _, r := range s.m.Results {
</a><a href="#h2-0-45" id="h2-0-45" class="i">+		out &lt;- r
</a><a href="#h2-0-46" id="h2-0-46" class="i">+	}
</a><a href="#h2-0-47" id="h2-0-47" class="i">+	close(out)
</a><a href="#h2-0-48" id="h2-0-48" class="i">+	return out
</a><a href="#h2-0-49" id="h2-0-49" class="i">+}
</a><a href="#h2-0-50" id="h2-0-50" class="i">+
</a><a href="#h2-0-51" id="h2-0-51" class="i">+func (s *mockSearch) Close() (*client.Stats, error) {
</a><a href="#h2-0-52" id="h2-0-52" class="i">+	return s.m.Stats, s.m.SearchError
</a><a href="#h2-0-53" id="h2-0-53" class="i">+}
</a><b>diff --git a/<a id="h3" href="../file/doc/examples/livegrep/index.json">doc/examples/livegrep/index.json</a> b/<a href="../file/doc/examples/livegrep/index.json">doc/examples/livegrep/index.json</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -8,6 +8,14 @@
</a>             &quot;metadata&quot;: {
                 &quot;github&quot;: &quot;nelhage/livegrep&quot;
             }
<a href="#h3-0-3" id="h3-0-3" class="i">+        },
</a><a href="#h3-0-4" id="h3-0-4" class="i">+        {
</a><a href="#h3-0-5" id="h3-0-5" class="i">+            &quot;name&quot;: &quot;livegrep^&quot;,
</a><a href="#h3-0-6" id="h3-0-6" class="i">+            &quot;path&quot;: &quot;.&quot;,
</a><a href="#h3-0-7" id="h3-0-7" class="i">+            &quot;revisions&quot;: [ &quot;HEAD^&quot; ],
</a><a href="#h3-0-8" id="h3-0-8" class="i">+            &quot;metadata&quot;: {
</a><a href="#h3-0-9" id="h3-0-9" class="i">+                &quot;github&quot;: &quot;nelhage/livegrep&quot;
</a><a href="#h3-0-10" id="h3-0-10" class="i">+            }
</a>         }
     ]
 }
<b>diff --git a/<a id="h4" href="../file/livegrep/livegrep.go">livegrep/livegrep.go</a> b/<a href="../file/livegrep/livegrep.go">livegrep/livegrep.go</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -18,6 +18,7 @@ import (
</a> var (
 	serveAddr = flag.String(&quot;listen&quot;, &quot;127.0.0.1:8910&quot;, &quot;The address to listen on&quot;)
 	docRoot   = flag.String(&quot;docroot&quot;, &quot;./web&quot;, &quot;The livegrep document root (web/ directory)&quot;)
<a href="#h4-0-3" id="h4-0-3" class="i">+	reload    = flag.Bool(&quot;reload&quot;, false, &quot;Reload template files on every request&quot;)
</a> 	_         = flag.Bool(&quot;logtostderr&quot;, false, &quot;[DEPRECATED] compatibility with glog&quot;)
 )
 
<a href="#h4-1" id="h4-1" class="h">@@ -38,6 +39,7 @@ func main() {
</a> 	cfg := &amp;config.Config{
 		DocRoot: *docRoot,
 		Listen:  *serveAddr,
<a href="#h4-1-3" id="h4-1-3" class="i">+		Reload:  *reload,
</a> 	}
 	if err = json.Unmarshal(data, &amp;cfg); err != nil {
 		log.Fatalf(&quot;reading %s: %s&quot;, flag.Arg(0), err.Error())
<b>diff --git a/<a id="h5" href="../file/server/api.go">server/api.go</a> b/<a href="../file/server/api.go">server/api.go</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -10,7 +10,6 @@ import (
</a> 
 	&quot;github.com/livegrep/livegrep/client&quot;
 	&quot;github.com/livegrep/livegrep/server/api&quot;
<a href="#h5-0-3" id="h5-0-3" class="d">-	&quot;github.com/livegrep/livegrep/server/backend&quot;
</a> 	&quot;github.com/livegrep/livegrep/server/log&quot;
 )
 
<a href="#h5-1" id="h5-1" class="h">@@ -40,14 +39,26 @@ func writeQueryError(ctx context.Context, w http.ResponseWriter, err error) {
</a> 	return
 }
 
<a href="#h5-1-3" id="h5-1-3" class="d">-func parseQuery(r *http.Request) client.Query {
</a><a href="#h5-1-4" id="h5-1-4" class="i">+func extractQuery(ctx context.Context, r *http.Request) client.Query {
</a> 	params := r.URL.Query()
<a href="#h5-1-6" id="h5-1-6" class="d">-	return client.Query{
</a><a href="#h5-1-7" id="h5-1-7" class="d">-		Line:     params.Get(&quot;line&quot;),
</a><a href="#h5-1-8" id="h5-1-8" class="d">-		File:     params.Get(&quot;file&quot;),
</a><a href="#h5-1-9" id="h5-1-9" class="d">-		Repo:     params.Get(&quot;repo&quot;),
</a><a href="#h5-1-10" id="h5-1-10" class="d">-		FoldCase: params.Get(&quot;fold_case&quot;) != &quot;&quot;,
</a><a href="#h5-1-11" id="h5-1-11" class="i">+	var query client.Query
</a><a href="#h5-1-12" id="h5-1-12" class="i">+	if q, ok := params[&quot;q&quot;]; ok {
</a><a href="#h5-1-13" id="h5-1-13" class="i">+		query = ParseQuery(q[0])
</a><a href="#h5-1-14" id="h5-1-14" class="i">+		log.Printf(ctx, &quot;parsing query q=%v out=%s&quot;, q[0], asJSON{query})
</a> 	}
<a href="#h5-1-16" id="h5-1-16" class="i">+	if line, ok := params[&quot;line&quot;]; ok {
</a><a href="#h5-1-17" id="h5-1-17" class="i">+		query.Line = line[0]
</a><a href="#h5-1-18" id="h5-1-18" class="i">+	}
</a><a href="#h5-1-19" id="h5-1-19" class="i">+	if file, ok := params[&quot;file&quot;]; ok {
</a><a href="#h5-1-20" id="h5-1-20" class="i">+		query.File = file[0]
</a><a href="#h5-1-21" id="h5-1-21" class="i">+	}
</a><a href="#h5-1-22" id="h5-1-22" class="i">+	if repo, ok := params[&quot;repo&quot;]; ok {
</a><a href="#h5-1-23" id="h5-1-23" class="i">+		query.Repo = repo[0]
</a><a href="#h5-1-24" id="h5-1-24" class="i">+	}
</a><a href="#h5-1-25" id="h5-1-25" class="i">+	if fc, ok := params[&quot;fold_case&quot;]; ok &amp;&amp; fc[0] != &quot;&quot; {
</a><a href="#h5-1-26" id="h5-1-26" class="i">+		query.FoldCase = true
</a><a href="#h5-1-27" id="h5-1-27" class="i">+	}
</a><a href="#h5-1-28" id="h5-1-28" class="i">+	return query
</a> }
 
 const MaxRetries = 8
<a href="#h5-2" id="h5-2" class="h">@@ -56,7 +67,7 @@ var (
</a> 	ErrTimedOut = errors.New(&quot;timed out talking to backend&quot;)
 )
 
<a href="#h5-2-3" id="h5-2-3" class="d">-func (s *server) doSearch(ctx context.Context, backend *backend.Backend, q *client.Query) (*api.ReplySearch, error) {
</a><a href="#h5-2-4" id="h5-2-4" class="i">+func (s *server) doSearch(ctx context.Context, backend *Backend, q *client.Query) (*api.ReplySearch, error) {
</a> 	var cl client.Client
 	var search client.Search
 	var err error
<a href="#h5-3" id="h5-3" class="h">@@ -89,7 +100,7 @@ func (s *server) doSearch(ctx context.Context, backend *backend.Backend, q *clie
</a> 
 func (s *server) ServeAPISearch(ctx context.Context, w http.ResponseWriter, r *http.Request) {
 	backendName := r.URL.Query().Get(&quot;:backend&quot;)
<a href="#h5-3-3" id="h5-3-3" class="d">-	var backend *backend.Backend
</a><a href="#h5-3-4" id="h5-3-4" class="i">+	var backend *Backend
</a> 	if backendName != &quot;&quot; {
 		backend = s.bk[backendName]
 		if backend == nil {
<a href="#h5-4" id="h5-4" class="h">@@ -103,7 +114,7 @@ func (s *server) ServeAPISearch(ctx context.Context, w http.ResponseWriter, r *h
</a> 		}
 	}
 
<a href="#h5-4-3" id="h5-4-3" class="d">-	q := parseQuery(r)
</a><a href="#h5-4-4" id="h5-4-4" class="i">+	q := extractQuery(ctx, r)
</a> 
 	if q.Line == &quot;&quot; {
 		writeError(ctx, w, 400, &quot;bad_query&quot;,
<b>diff --git a/<a id="h6" href="../file/server/backend.go">server/backend.go</a> b/<a href="../file/server/backend.go">server/backend.go</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -0,0 +1,131 @@
</a><a href="#h6-0-0" id="h6-0-0" class="i">+package server
</a><a href="#h6-0-1" id="h6-0-1" class="i">+
</a><a href="#h6-0-2" id="h6-0-2" class="i">+import (
</a><a href="#h6-0-3" id="h6-0-3" class="i">+	&quot;log&quot;
</a><a href="#h6-0-4" id="h6-0-4" class="i">+	&quot;sync&quot;
</a><a href="#h6-0-5" id="h6-0-5" class="i">+	&quot;time&quot;
</a><a href="#h6-0-6" id="h6-0-6" class="i">+
</a><a href="#h6-0-7" id="h6-0-7" class="i">+	&quot;github.com/livegrep/livegrep/client&quot;
</a><a href="#h6-0-8" id="h6-0-8" class="i">+)
</a><a href="#h6-0-9" id="h6-0-9" class="i">+
</a><a href="#h6-0-10" id="h6-0-10" class="i">+const (
</a><a href="#h6-0-11" id="h6-0-11" class="i">+	defaultPoolSize = 8
</a><a href="#h6-0-12" id="h6-0-12" class="i">+)
</a><a href="#h6-0-13" id="h6-0-13" class="i">+
</a><a href="#h6-0-14" id="h6-0-14" class="i">+var (
</a><a href="#h6-0-15" id="h6-0-15" class="i">+	// maximum time to wait after a failed connection
</a><a href="#h6-0-16" id="h6-0-16" class="i">+	// attempt. `var` not `const` so it can be retried by the
</a><a href="#h6-0-17" id="h6-0-17" class="i">+	// tests.
</a><a href="#h6-0-18" id="h6-0-18" class="i">+	maxBackoff = 10 * time.Second
</a><a href="#h6-0-19" id="h6-0-19" class="i">+)
</a><a href="#h6-0-20" id="h6-0-20" class="i">+
</a><a href="#h6-0-21" id="h6-0-21" class="i">+type Tree struct {
</a><a href="#h6-0-22" id="h6-0-22" class="i">+	Name    string
</a><a href="#h6-0-23" id="h6-0-23" class="i">+	Version string
</a><a href="#h6-0-24" id="h6-0-24" class="i">+	Github  string
</a><a href="#h6-0-25" id="h6-0-25" class="i">+}
</a><a href="#h6-0-26" id="h6-0-26" class="i">+
</a><a href="#h6-0-27" id="h6-0-27" class="i">+type I struct {
</a><a href="#h6-0-28" id="h6-0-28" class="i">+	Name  string
</a><a href="#h6-0-29" id="h6-0-29" class="i">+	Trees []Tree
</a><a href="#h6-0-30" id="h6-0-30" class="i">+	sync.Mutex
</a><a href="#h6-0-31" id="h6-0-31" class="i">+}
</a><a href="#h6-0-32" id="h6-0-32" class="i">+
</a><a href="#h6-0-33" id="h6-0-33" class="i">+type Backend struct {
</a><a href="#h6-0-34" id="h6-0-34" class="i">+	Id       string
</a><a href="#h6-0-35" id="h6-0-35" class="i">+	Dial     func() (client.Client, error)
</a><a href="#h6-0-36" id="h6-0-36" class="i">+	PoolSize int
</a><a href="#h6-0-37" id="h6-0-37" class="i">+	I        *I
</a><a href="#h6-0-38" id="h6-0-38" class="i">+	Clients  chan client.Client
</a><a href="#h6-0-39" id="h6-0-39" class="i">+
</a><a href="#h6-0-40" id="h6-0-40" class="i">+	pending chan struct{}
</a><a href="#h6-0-41" id="h6-0-41" class="i">+	backoff time.Duration
</a><a href="#h6-0-42" id="h6-0-42" class="i">+}
</a><a href="#h6-0-43" id="h6-0-43" class="i">+
</a><a href="#h6-0-44" id="h6-0-44" class="i">+func (bk *Backend) Start() {
</a><a href="#h6-0-45" id="h6-0-45" class="i">+	if bk.PoolSize == 0 {
</a><a href="#h6-0-46" id="h6-0-46" class="i">+		bk.PoolSize = defaultPoolSize
</a><a href="#h6-0-47" id="h6-0-47" class="i">+	}
</a><a href="#h6-0-48" id="h6-0-48" class="i">+	bk.Clients = make(chan client.Client, bk.PoolSize)
</a><a href="#h6-0-49" id="h6-0-49" class="i">+	bk.pending = make(chan struct{}, bk.PoolSize)
</a><a href="#h6-0-50" id="h6-0-50" class="i">+	bk.backoff = 10 * time.Millisecond
</a><a href="#h6-0-51" id="h6-0-51" class="i">+	if bk.I == nil {
</a><a href="#h6-0-52" id="h6-0-52" class="i">+		bk.I = &amp;I{Name: bk.Id}
</a><a href="#h6-0-53" id="h6-0-53" class="i">+	}
</a><a href="#h6-0-54" id="h6-0-54" class="i">+	for i := 0; i &lt; bk.PoolSize; i++ {
</a><a href="#h6-0-55" id="h6-0-55" class="i">+		bk.pending &lt;- struct{}{}
</a><a href="#h6-0-56" id="h6-0-56" class="i">+	}
</a><a href="#h6-0-57" id="h6-0-57" class="i">+	go bk.connectLoop()
</a><a href="#h6-0-58" id="h6-0-58" class="i">+}
</a><a href="#h6-0-59" id="h6-0-59" class="i">+
</a><a href="#h6-0-60" id="h6-0-60" class="i">+func (bk *Backend) CheckIn(c client.Client) {
</a><a href="#h6-0-61" id="h6-0-61" class="i">+	if c.Err() != nil {
</a><a href="#h6-0-62" id="h6-0-62" class="i">+		c.Close()
</a><a href="#h6-0-63" id="h6-0-63" class="i">+		bk.pending &lt;- struct{}{}
</a><a href="#h6-0-64" id="h6-0-64" class="i">+		return
</a><a href="#h6-0-65" id="h6-0-65" class="i">+	}
</a><a href="#h6-0-66" id="h6-0-66" class="i">+
</a><a href="#h6-0-67" id="h6-0-67" class="i">+	bk.Clients &lt;- c
</a><a href="#h6-0-68" id="h6-0-68" class="i">+}
</a><a href="#h6-0-69" id="h6-0-69" class="i">+
</a><a href="#h6-0-70" id="h6-0-70" class="i">+func (bk *Backend) Close() {
</a><a href="#h6-0-71" id="h6-0-71" class="i">+drain:
</a><a href="#h6-0-72" id="h6-0-72" class="i">+	for {
</a><a href="#h6-0-73" id="h6-0-73" class="i">+		select {
</a><a href="#h6-0-74" id="h6-0-74" class="i">+		case &lt;-bk.pending:
</a><a href="#h6-0-75" id="h6-0-75" class="i">+		default:
</a><a href="#h6-0-76" id="h6-0-76" class="i">+			break drain
</a><a href="#h6-0-77" id="h6-0-77" class="i">+		}
</a><a href="#h6-0-78" id="h6-0-78" class="i">+	}
</a><a href="#h6-0-79" id="h6-0-79" class="i">+	close(bk.pending)
</a><a href="#h6-0-80" id="h6-0-80" class="i">+	for c := range bk.Clients {
</a><a href="#h6-0-81" id="h6-0-81" class="i">+		c.Close()
</a><a href="#h6-0-82" id="h6-0-82" class="i">+	}
</a><a href="#h6-0-83" id="h6-0-83" class="i">+}
</a><a href="#h6-0-84" id="h6-0-84" class="i">+
</a><a href="#h6-0-85" id="h6-0-85" class="i">+func (bk *Backend) connectLoop() {
</a><a href="#h6-0-86" id="h6-0-86" class="i">+	for _ = range bk.pending {
</a><a href="#h6-0-87" id="h6-0-87" class="i">+	retry:
</a><a href="#h6-0-88" id="h6-0-88" class="i">+		cl, err := bk.Dial()
</a><a href="#h6-0-89" id="h6-0-89" class="i">+		if err != nil {
</a><a href="#h6-0-90" id="h6-0-90" class="i">+			log.Printf(&quot;Connection error: backend=%s error=%s&quot;,
</a><a href="#h6-0-91" id="h6-0-91" class="i">+				bk.Id, err.Error())
</a><a href="#h6-0-92" id="h6-0-92" class="i">+			bk.backoff *= 2
</a><a href="#h6-0-93" id="h6-0-93" class="i">+			if bk.backoff &gt; maxBackoff {
</a><a href="#h6-0-94" id="h6-0-94" class="i">+				bk.backoff = maxBackoff
</a><a href="#h6-0-95" id="h6-0-95" class="i">+			}
</a><a href="#h6-0-96" id="h6-0-96" class="i">+			time.Sleep(bk.backoff)
</a><a href="#h6-0-97" id="h6-0-97" class="i">+			goto retry
</a><a href="#h6-0-98" id="h6-0-98" class="i">+		}
</a><a href="#h6-0-99" id="h6-0-99" class="i">+
</a><a href="#h6-0-100" id="h6-0-100" class="i">+		log.Printf(&quot;Connected: backend=%s&quot;, bk.Id)
</a><a href="#h6-0-101" id="h6-0-101" class="i">+		bk.backoff = 10 * time.Millisecond
</a><a href="#h6-0-102" id="h6-0-102" class="i">+
</a><a href="#h6-0-103" id="h6-0-103" class="i">+		if info := cl.Info(); info != nil {
</a><a href="#h6-0-104" id="h6-0-104" class="i">+			bk.refresh(info)
</a><a href="#h6-0-105" id="h6-0-105" class="i">+		}
</a><a href="#h6-0-106" id="h6-0-106" class="i">+		bk.Clients &lt;- cl
</a><a href="#h6-0-107" id="h6-0-107" class="i">+
</a><a href="#h6-0-108" id="h6-0-108" class="i">+	}
</a><a href="#h6-0-109" id="h6-0-109" class="i">+	close(bk.Clients)
</a><a href="#h6-0-110" id="h6-0-110" class="i">+}
</a><a href="#h6-0-111" id="h6-0-111" class="i">+
</a><a href="#h6-0-112" id="h6-0-112" class="i">+func (bk *Backend) refresh(info *client.ServerInfo) {
</a><a href="#h6-0-113" id="h6-0-113" class="i">+	bk.I.Lock()
</a><a href="#h6-0-114" id="h6-0-114" class="i">+	defer bk.I.Unlock()
</a><a href="#h6-0-115" id="h6-0-115" class="i">+
</a><a href="#h6-0-116" id="h6-0-116" class="i">+	if info.Name != &quot;&quot; {
</a><a href="#h6-0-117" id="h6-0-117" class="i">+		bk.I.Name = info.Name
</a><a href="#h6-0-118" id="h6-0-118" class="i">+	}
</a><a href="#h6-0-119" id="h6-0-119" class="i">+	if len(info.Trees) &gt; 0 {
</a><a href="#h6-0-120" id="h6-0-120" class="i">+		bk.I.Trees = nil
</a><a href="#h6-0-121" id="h6-0-121" class="i">+		for _, r := range info.Trees {
</a><a href="#h6-0-122" id="h6-0-122" class="i">+			gh := &quot;&quot;
</a><a href="#h6-0-123" id="h6-0-123" class="i">+			if v, ok := r.Metadata[&quot;github&quot;]; ok {
</a><a href="#h6-0-124" id="h6-0-124" class="i">+				gh = v.(string)
</a><a href="#h6-0-125" id="h6-0-125" class="i">+			}
</a><a href="#h6-0-126" id="h6-0-126" class="i">+			bk.I.Trees = append(bk.I.Trees,
</a><a href="#h6-0-127" id="h6-0-127" class="i">+				Tree{r.Name, r.Version, gh})
</a><a href="#h6-0-128" id="h6-0-128" class="i">+		}
</a><a href="#h6-0-129" id="h6-0-129" class="i">+	}
</a><a href="#h6-0-130" id="h6-0-130" class="i">+}
</a><b>diff --git a/<a id="h7" href="../file/server/backend/backend.go">server/backend/backend.go</a> b/<a href="../file/server/backend/backend.go">server/backend/backend.go</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -1,104 +0,0 @@
</a><a href="#h7-0-0" id="h7-0-0" class="d">-package backend
</a><a href="#h7-0-1" id="h7-0-1" class="d">-
</a><a href="#h7-0-2" id="h7-0-2" class="d">-import (
</a><a href="#h7-0-3" id="h7-0-3" class="d">-	&quot;log&quot;
</a><a href="#h7-0-4" id="h7-0-4" class="d">-	&quot;sync&quot;
</a><a href="#h7-0-5" id="h7-0-5" class="d">-	&quot;time&quot;
</a><a href="#h7-0-6" id="h7-0-6" class="d">-
</a><a href="#h7-0-7" id="h7-0-7" class="d">-	&quot;github.com/livegrep/livegrep/client&quot;
</a><a href="#h7-0-8" id="h7-0-8" class="d">-	&quot;github.com/livegrep/livegrep/server/config&quot;
</a><a href="#h7-0-9" id="h7-0-9" class="d">-)
</a><a href="#h7-0-10" id="h7-0-10" class="d">-
</a><a href="#h7-0-11" id="h7-0-11" class="d">-const (
</a><a href="#h7-0-12" id="h7-0-12" class="d">-	PoolSize = 8
</a><a href="#h7-0-13" id="h7-0-13" class="d">-)
</a><a href="#h7-0-14" id="h7-0-14" class="d">-
</a><a href="#h7-0-15" id="h7-0-15" class="d">-type Tree struct {
</a><a href="#h7-0-16" id="h7-0-16" class="d">-	Name    string
</a><a href="#h7-0-17" id="h7-0-17" class="d">-	Version string
</a><a href="#h7-0-18" id="h7-0-18" class="d">-	Github  string
</a><a href="#h7-0-19" id="h7-0-19" class="d">-}
</a><a href="#h7-0-20" id="h7-0-20" class="d">-
</a><a href="#h7-0-21" id="h7-0-21" class="d">-type I struct {
</a><a href="#h7-0-22" id="h7-0-22" class="d">-	Name  string
</a><a href="#h7-0-23" id="h7-0-23" class="d">-	Trees []Tree
</a><a href="#h7-0-24" id="h7-0-24" class="d">-	sync.Mutex
</a><a href="#h7-0-25" id="h7-0-25" class="d">-}
</a><a href="#h7-0-26" id="h7-0-26" class="d">-
</a><a href="#h7-0-27" id="h7-0-27" class="d">-type Backend struct {
</a><a href="#h7-0-28" id="h7-0-28" class="d">-	Addr    string
</a><a href="#h7-0-29" id="h7-0-29" class="d">-	Id      string
</a><a href="#h7-0-30" id="h7-0-30" class="d">-	I       *I
</a><a href="#h7-0-31" id="h7-0-31" class="d">-	Clients chan client.Client
</a><a href="#h7-0-32" id="h7-0-32" class="d">-	pending chan struct{}
</a><a href="#h7-0-33" id="h7-0-33" class="d">-}
</a><a href="#h7-0-34" id="h7-0-34" class="d">-
</a><a href="#h7-0-35" id="h7-0-35" class="d">-func New(cfg *config.Backend) *Backend {
</a><a href="#h7-0-36" id="h7-0-36" class="d">-	bk := &amp;Backend{
</a><a href="#h7-0-37" id="h7-0-37" class="d">-		Addr:    cfg.Addr,
</a><a href="#h7-0-38" id="h7-0-38" class="d">-		Id:      cfg.Id,
</a><a href="#h7-0-39" id="h7-0-39" class="d">-		I:       &amp;I{Name: cfg.Name},
</a><a href="#h7-0-40" id="h7-0-40" class="d">-		Clients: make(chan client.Client, PoolSize),
</a><a href="#h7-0-41" id="h7-0-41" class="d">-		pending: make(chan struct{}, PoolSize),
</a><a href="#h7-0-42" id="h7-0-42" class="d">-	}
</a><a href="#h7-0-43" id="h7-0-43" class="d">-	for _, r := range cfg.Repos {
</a><a href="#h7-0-44" id="h7-0-44" class="d">-		bk.I.Trees = append(bk.I.Trees, Tree{Name: r.Name, Version: r.Refs[0], Github: r.Github})
</a><a href="#h7-0-45" id="h7-0-45" class="d">-	}
</a><a href="#h7-0-46" id="h7-0-46" class="d">-	for i := 0; i &lt; PoolSize; i++ {
</a><a href="#h7-0-47" id="h7-0-47" class="d">-		bk.pending &lt;- struct{}{}
</a><a href="#h7-0-48" id="h7-0-48" class="d">-	}
</a><a href="#h7-0-49" id="h7-0-49" class="d">-	go bk.connectLoop()
</a><a href="#h7-0-50" id="h7-0-50" class="d">-	return bk
</a><a href="#h7-0-51" id="h7-0-51" class="d">-}
</a><a href="#h7-0-52" id="h7-0-52" class="d">-
</a><a href="#h7-0-53" id="h7-0-53" class="d">-func (bk *Backend) CheckIn(c client.Client) {
</a><a href="#h7-0-54" id="h7-0-54" class="d">-	if c.Err() != nil {
</a><a href="#h7-0-55" id="h7-0-55" class="d">-		c.Close()
</a><a href="#h7-0-56" id="h7-0-56" class="d">-		bk.pending &lt;- struct{}{}
</a><a href="#h7-0-57" id="h7-0-57" class="d">-		return
</a><a href="#h7-0-58" id="h7-0-58" class="d">-	}
</a><a href="#h7-0-59" id="h7-0-59" class="d">-
</a><a href="#h7-0-60" id="h7-0-60" class="d">-	bk.Clients &lt;- c
</a><a href="#h7-0-61" id="h7-0-61" class="d">-}
</a><a href="#h7-0-62" id="h7-0-62" class="d">-
</a><a href="#h7-0-63" id="h7-0-63" class="d">-func (bk *Backend) connectLoop() {
</a><a href="#h7-0-64" id="h7-0-64" class="d">-	for _ = range bk.pending {
</a><a href="#h7-0-65" id="h7-0-65" class="d">-		for {
</a><a href="#h7-0-66" id="h7-0-66" class="d">-			cl, err := client.Dial(&quot;tcp&quot;, bk.Addr)
</a><a href="#h7-0-67" id="h7-0-67" class="d">-			if err != nil {
</a><a href="#h7-0-68" id="h7-0-68" class="d">-				log.Printf(&quot;Connection error: %s&quot;, err.Error())
</a><a href="#h7-0-69" id="h7-0-69" class="d">-				time.Sleep(5 * time.Second)
</a><a href="#h7-0-70" id="h7-0-70" class="d">-				continue
</a><a href="#h7-0-71" id="h7-0-71" class="d">-			}
</a><a href="#h7-0-72" id="h7-0-72" class="d">-			log.Printf(&quot;Connected, backend=%s addr=%s&quot;,
</a><a href="#h7-0-73" id="h7-0-73" class="d">-				bk.Id, bk.Addr)
</a><a href="#h7-0-74" id="h7-0-74" class="d">-
</a><a href="#h7-0-75" id="h7-0-75" class="d">-			if info := cl.Info(); info != nil {
</a><a href="#h7-0-76" id="h7-0-76" class="d">-				bk.refresh(info)
</a><a href="#h7-0-77" id="h7-0-77" class="d">-			}
</a><a href="#h7-0-78" id="h7-0-78" class="d">-			bk.Clients &lt;- cl
</a><a href="#h7-0-79" id="h7-0-79" class="d">-			break
</a><a href="#h7-0-80" id="h7-0-80" class="d">-		}
</a><a href="#h7-0-81" id="h7-0-81" class="d">-	}
</a><a href="#h7-0-82" id="h7-0-82" class="d">-}
</a><a href="#h7-0-83" id="h7-0-83" class="d">-
</a><a href="#h7-0-84" id="h7-0-84" class="d">-func (bk *Backend) refresh(info *client.ServerInfo) {
</a><a href="#h7-0-85" id="h7-0-85" class="d">-	bk.I.Lock()
</a><a href="#h7-0-86" id="h7-0-86" class="d">-	defer bk.I.Unlock()
</a><a href="#h7-0-87" id="h7-0-87" class="d">-
</a><a href="#h7-0-88" id="h7-0-88" class="d">-	if info.Name != &quot;&quot; {
</a><a href="#h7-0-89" id="h7-0-89" class="d">-		bk.I.Name = info.Name
</a><a href="#h7-0-90" id="h7-0-90" class="d">-	}
</a><a href="#h7-0-91" id="h7-0-91" class="d">-	if len(info.Trees) &gt; 0 {
</a><a href="#h7-0-92" id="h7-0-92" class="d">-		bk.I.Trees = nil
</a><a href="#h7-0-93" id="h7-0-93" class="d">-		for _, r := range info.Trees {
</a><a href="#h7-0-94" id="h7-0-94" class="d">-			gh := &quot;&quot;
</a><a href="#h7-0-95" id="h7-0-95" class="d">-			v, ok := r.Metadata[&quot;github&quot;]
</a><a href="#h7-0-96" id="h7-0-96" class="d">-			if ok {
</a><a href="#h7-0-97" id="h7-0-97" class="d">-				gh = v.(string)
</a><a href="#h7-0-98" id="h7-0-98" class="d">-			}
</a><a href="#h7-0-99" id="h7-0-99" class="d">-			bk.I.Trees = append(bk.I.Trees,
</a><a href="#h7-0-100" id="h7-0-100" class="d">-				Tree{r.Name, r.Version, gh})
</a><a href="#h7-0-101" id="h7-0-101" class="d">-		}
</a><a href="#h7-0-102" id="h7-0-102" class="d">-	}
</a><a href="#h7-0-103" id="h7-0-103" class="d">-}
</a><b>diff --git a/<a id="h8" href="../file/server/backend_test.go">server/backend_test.go</a> b/<a href="../file/server/backend_test.go">server/backend_test.go</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -0,0 +1,102 @@
</a><a href="#h8-0-0" id="h8-0-0" class="i">+package server
</a><a href="#h8-0-1" id="h8-0-1" class="i">+
</a><a href="#h8-0-2" id="h8-0-2" class="i">+import (
</a><a href="#h8-0-3" id="h8-0-3" class="i">+	&quot;errors&quot;
</a><a href="#h8-0-4" id="h8-0-4" class="i">+	&quot;testing&quot;
</a><a href="#h8-0-5" id="h8-0-5" class="i">+	&quot;time&quot;
</a><a href="#h8-0-6" id="h8-0-6" class="i">+
</a><a href="#h8-0-7" id="h8-0-7" class="i">+	&quot;github.com/livegrep/livegrep/client&quot;
</a><a href="#h8-0-8" id="h8-0-8" class="i">+	&quot;github.com/livegrep/livegrep/client/test&quot;
</a><a href="#h8-0-9" id="h8-0-9" class="i">+)
</a><a href="#h8-0-10" id="h8-0-10" class="i">+
</a><a href="#h8-0-11" id="h8-0-11" class="i">+func init() {
</a><a href="#h8-0-12" id="h8-0-12" class="i">+	maxBackoff = 1 * time.Millisecond
</a><a href="#h8-0-13" id="h8-0-13" class="i">+}
</a><a href="#h8-0-14" id="h8-0-14" class="i">+
</a><a href="#h8-0-15" id="h8-0-15" class="i">+func TestFailedDial(t *testing.T) {
</a><a href="#h8-0-16" id="h8-0-16" class="i">+	tries := 0
</a><a href="#h8-0-17" id="h8-0-17" class="i">+	dial := func() (client.Client, error) {
</a><a href="#h8-0-18" id="h8-0-18" class="i">+		tries++
</a><a href="#h8-0-19" id="h8-0-19" class="i">+		if tries &lt; 10 {
</a><a href="#h8-0-20" id="h8-0-20" class="i">+			return nil, errors.New(&quot;connect error&quot;)
</a><a href="#h8-0-21" id="h8-0-21" class="i">+		}
</a><a href="#h8-0-22" id="h8-0-22" class="i">+		return &amp;test.MockClient{
</a><a href="#h8-0-23" id="h8-0-23" class="i">+			QueryError: errors.New(&quot;query failed&quot;),
</a><a href="#h8-0-24" id="h8-0-24" class="i">+		}, nil
</a><a href="#h8-0-25" id="h8-0-25" class="i">+	}
</a><a href="#h8-0-26" id="h8-0-26" class="i">+
</a><a href="#h8-0-27" id="h8-0-27" class="i">+	bk := &amp;Backend{
</a><a href="#h8-0-28" id="h8-0-28" class="i">+		Id:       &quot;search&quot;,
</a><a href="#h8-0-29" id="h8-0-29" class="i">+		Dial:     dial,
</a><a href="#h8-0-30" id="h8-0-30" class="i">+		PoolSize: 2,
</a><a href="#h8-0-31" id="h8-0-31" class="i">+	}
</a><a href="#h8-0-32" id="h8-0-32" class="i">+
</a><a href="#h8-0-33" id="h8-0-33" class="i">+	bk.Start()
</a><a href="#h8-0-34" id="h8-0-34" class="i">+	defer bk.Close()
</a><a href="#h8-0-35" id="h8-0-35" class="i">+
</a><a href="#h8-0-36" id="h8-0-36" class="i">+	select {
</a><a href="#h8-0-37" id="h8-0-37" class="i">+	case &lt;-time.After(1 * time.Second):
</a><a href="#h8-0-38" id="h8-0-38" class="i">+		t.Fatal(&quot;timed out waiting for dial&quot;)
</a><a href="#h8-0-39" id="h8-0-39" class="i">+	case &lt;-bk.Clients:
</a><a href="#h8-0-40" id="h8-0-40" class="i">+	}
</a><a href="#h8-0-41" id="h8-0-41" class="i">+
</a><a href="#h8-0-42" id="h8-0-42" class="i">+}
</a><a href="#h8-0-43" id="h8-0-43" class="i">+
</a><a href="#h8-0-44" id="h8-0-44" class="i">+func assertClosed(t *testing.T, bk *Backend) {
</a><a href="#h8-0-45" id="h8-0-45" class="i">+	select {
</a><a href="#h8-0-46" id="h8-0-46" class="i">+	case _, ok := &lt;-bk.pending:
</a><a href="#h8-0-47" id="h8-0-47" class="i">+		if ok {
</a><a href="#h8-0-48" id="h8-0-48" class="i">+			t.Fatal(&quot;pending data&quot;)
</a><a href="#h8-0-49" id="h8-0-49" class="i">+		}
</a><a href="#h8-0-50" id="h8-0-50" class="i">+	default:
</a><a href="#h8-0-51" id="h8-0-51" class="i">+		t.Fatal(&quot;pending not closed&quot;)
</a><a href="#h8-0-52" id="h8-0-52" class="i">+	}
</a><a href="#h8-0-53" id="h8-0-53" class="i">+	select {
</a><a href="#h8-0-54" id="h8-0-54" class="i">+	case _, ok := &lt;-bk.Clients:
</a><a href="#h8-0-55" id="h8-0-55" class="i">+		if ok {
</a><a href="#h8-0-56" id="h8-0-56" class="i">+			t.Fatal(&quot;clients data&quot;)
</a><a href="#h8-0-57" id="h8-0-57" class="i">+		}
</a><a href="#h8-0-58" id="h8-0-58" class="i">+	default:
</a><a href="#h8-0-59" id="h8-0-59" class="i">+		t.Fatal(&quot;clients not closed&quot;)
</a><a href="#h8-0-60" id="h8-0-60" class="i">+	}
</a><a href="#h8-0-61" id="h8-0-61" class="i">+}
</a><a href="#h8-0-62" id="h8-0-62" class="i">+
</a><a href="#h8-0-63" id="h8-0-63" class="i">+func TestCloseClients(t *testing.T) {
</a><a href="#h8-0-64" id="h8-0-64" class="i">+	var clients []*test.MockClient
</a><a href="#h8-0-65" id="h8-0-65" class="i">+	dial := func() (client.Client, error) {
</a><a href="#h8-0-66" id="h8-0-66" class="i">+		cl := &amp;test.MockClient{
</a><a href="#h8-0-67" id="h8-0-67" class="i">+			QueryError: errors.New(&quot;query failed&quot;),
</a><a href="#h8-0-68" id="h8-0-68" class="i">+		}
</a><a href="#h8-0-69" id="h8-0-69" class="i">+		clients = append(clients, cl)
</a><a href="#h8-0-70" id="h8-0-70" class="i">+		return cl, nil
</a><a href="#h8-0-71" id="h8-0-71" class="i">+	}
</a><a href="#h8-0-72" id="h8-0-72" class="i">+	bk := &amp;Backend{
</a><a href="#h8-0-73" id="h8-0-73" class="i">+		Dial: dial,
</a><a href="#h8-0-74" id="h8-0-74" class="i">+		Id:   &quot;q&quot;,
</a><a href="#h8-0-75" id="h8-0-75" class="i">+	}
</a><a href="#h8-0-76" id="h8-0-76" class="i">+	bk.Start()
</a><a href="#h8-0-77" id="h8-0-77" class="i">+	for i := 0; i &lt; bk.PoolSize; i++ {
</a><a href="#h8-0-78" id="h8-0-78" class="i">+		cl := &lt;-bk.Clients
</a><a href="#h8-0-79" id="h8-0-79" class="i">+		bk.CheckIn(cl)
</a><a href="#h8-0-80" id="h8-0-80" class="i">+	}
</a><a href="#h8-0-81" id="h8-0-81" class="i">+	bk.Close()
</a><a href="#h8-0-82" id="h8-0-82" class="i">+	for i, cl := range clients {
</a><a href="#h8-0-83" id="h8-0-83" class="i">+		if !cl.Closed {
</a><a href="#h8-0-84" id="h8-0-84" class="i">+			t.Fatal(&quot;failed to close&quot;, i)
</a><a href="#h8-0-85" id="h8-0-85" class="i">+		}
</a><a href="#h8-0-86" id="h8-0-86" class="i">+	}
</a><a href="#h8-0-87" id="h8-0-87" class="i">+	assertClosed(t, bk)
</a><a href="#h8-0-88" id="h8-0-88" class="i">+}
</a><a href="#h8-0-89" id="h8-0-89" class="i">+
</a><a href="#h8-0-90" id="h8-0-90" class="i">+func TestCloseNoClients(t *testing.T) {
</a><a href="#h8-0-91" id="h8-0-91" class="i">+	dial := func() (client.Client, error) {
</a><a href="#h8-0-92" id="h8-0-92" class="i">+		return nil, errors.New(&quot;error&quot;)
</a><a href="#h8-0-93" id="h8-0-93" class="i">+	}
</a><a href="#h8-0-94" id="h8-0-94" class="i">+	bk := &amp;Backend{
</a><a href="#h8-0-95" id="h8-0-95" class="i">+		Dial: dial,
</a><a href="#h8-0-96" id="h8-0-96" class="i">+		Id:   &quot;q&quot;,
</a><a href="#h8-0-97" id="h8-0-97" class="i">+	}
</a><a href="#h8-0-98" id="h8-0-98" class="i">+	bk.Start()
</a><a href="#h8-0-99" id="h8-0-99" class="i">+	bk.Close()
</a><a href="#h8-0-100" id="h8-0-100" class="i">+	assertClosed(t, bk)
</a><a href="#h8-0-101" id="h8-0-101" class="i">+}
</a><b>diff --git a/<a id="h9" href="../file/server/config/config.go">server/config/config.go</a> b/<a href="../file/server/config/config.go">server/config/config.go</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -1,18 +1,8 @@
</a> package config
 
<a href="#h9-0-2" id="h9-0-2" class="d">-type Repo struct {
</a><a href="#h9-0-3" id="h9-0-3" class="d">-	Path   string   `json:&quot;path&quot;`
</a><a href="#h9-0-4" id="h9-0-4" class="d">-	Name   string   `json:&quot;name&quot;`
</a><a href="#h9-0-5" id="h9-0-5" class="d">-	Refs   []string `json:&quot;refs&quot;`
</a><a href="#h9-0-6" id="h9-0-6" class="d">-	Github string   `json:&quot;github&quot;`
</a><a href="#h9-0-7" id="h9-0-7" class="d">-}
</a><a href="#h9-0-8" id="h9-0-8" class="d">-
</a> type Backend struct {
<a href="#h9-0-10" id="h9-0-10" class="d">-	Id        string `json:&quot;id&quot;`
</a><a href="#h9-0-11" id="h9-0-11" class="d">-	Name      string `json:&quot;name&quot;`
</a><a href="#h9-0-12" id="h9-0-12" class="d">-	Addr      string `json:&quot;addr&quot;`
</a><a href="#h9-0-13" id="h9-0-13" class="d">-	IndexPath string `json:&quot;index&quot;`
</a><a href="#h9-0-14" id="h9-0-14" class="d">-	Repos     []Repo `json:&quot;repos&quot;`
</a><a href="#h9-0-15" id="h9-0-15" class="i">+	Id   string `json:&quot;id&quot;`
</a><a href="#h9-0-16" id="h9-0-16" class="i">+	Addr string `json:&quot;addr&quot;`
</a> }
 
 type Config struct {
<a href="#h9-1" id="h9-1" class="h">@@ -30,10 +20,8 @@ type Config struct {
</a> 	// Should we respect X-Real-Ip, X-Real-Proto, and X-Forwarded-Host?
 	ReverseProxy bool `json:&quot;reverse_proxy&quot;`
 
<a href="#h9-1-3" id="h9-1-3" class="d">-	// List of backends to connect to. Each backend must minimally
</a><a href="#h9-1-4" id="h9-1-4" class="d">-	// include the &quot;id&quot; and &quot;addr&quot; fields; All other fields are
</a><a href="#h9-1-5" id="h9-1-5" class="d">-	// optional and will be replaced by values reported by the
</a><a href="#h9-1-6" id="h9-1-6" class="d">-	// backend server once we successfully connect.
</a><a href="#h9-1-7" id="h9-1-7" class="i">+	// List of backends to connect to. Each backend must include
</a><a href="#h9-1-8" id="h9-1-8" class="i">+	// the &quot;id&quot; and &quot;addr&quot; fields.
</a> 	Backends []Backend `json:&quot;backends&quot;`
 
 	// The address to listen on, as HOST:PORT.
<a href="#h9-2" id="h9-2" class="h">@@ -42,4 +30,7 @@ type Config struct {
</a> 	Sentry struct {
 		URI string `json:&quot;uri&quot;`
 	} `json:&quot;sentry&quot;`
<a href="#h9-2-3" id="h9-2-3" class="i">+
</a><a href="#h9-2-4" id="h9-2-4" class="i">+	// Whether to re-load templates on every request
</a><a href="#h9-2-5" id="h9-2-5" class="i">+	Reload bool `json:&quot;reload&quot;`
</a> }
<b>diff --git a/<a id="h10" href="../file/server/query.go">server/query.go</a> b/<a href="../file/server/query.go">server/query.go</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -0,0 +1,84 @@
</a><a href="#h10-0-0" id="h10-0-0" class="i">+package server
</a><a href="#h10-0-1" id="h10-0-1" class="i">+
</a><a href="#h10-0-2" id="h10-0-2" class="i">+import (
</a><a href="#h10-0-3" id="h10-0-3" class="i">+	&quot;bytes&quot;
</a><a href="#h10-0-4" id="h10-0-4" class="i">+	&quot;regexp&quot;
</a><a href="#h10-0-5" id="h10-0-5" class="i">+	&quot;strings&quot;
</a><a href="#h10-0-6" id="h10-0-6" class="i">+	&quot;unicode/utf8&quot;
</a><a href="#h10-0-7" id="h10-0-7" class="i">+
</a><a href="#h10-0-8" id="h10-0-8" class="i">+	&quot;github.com/livegrep/livegrep/client&quot;
</a><a href="#h10-0-9" id="h10-0-9" class="i">+)
</a><a href="#h10-0-10" id="h10-0-10" class="i">+
</a><a href="#h10-0-11" id="h10-0-11" class="i">+var pieceRE = regexp.MustCompile(`\(|(?:^(\w+):|\\.)| `)
</a><a href="#h10-0-12" id="h10-0-12" class="i">+
</a><a href="#h10-0-13" id="h10-0-13" class="i">+func ParseQuery(query string) client.Query {
</a><a href="#h10-0-14" id="h10-0-14" class="i">+	ops := make(map[string]string)
</a><a href="#h10-0-15" id="h10-0-15" class="i">+	key := &quot;&quot;
</a><a href="#h10-0-16" id="h10-0-16" class="i">+	q := strings.TrimSpace(query)
</a><a href="#h10-0-17" id="h10-0-17" class="i">+
</a><a href="#h10-0-18" id="h10-0-18" class="i">+	for {
</a><a href="#h10-0-19" id="h10-0-19" class="i">+		m := pieceRE.FindStringSubmatchIndex(q)
</a><a href="#h10-0-20" id="h10-0-20" class="i">+		if m == nil {
</a><a href="#h10-0-21" id="h10-0-21" class="i">+			ops[key] += q
</a><a href="#h10-0-22" id="h10-0-22" class="i">+			break
</a><a href="#h10-0-23" id="h10-0-23" class="i">+		}
</a><a href="#h10-0-24" id="h10-0-24" class="i">+
</a><a href="#h10-0-25" id="h10-0-25" class="i">+		ops[key] += q[:m[0]]
</a><a href="#h10-0-26" id="h10-0-26" class="i">+		match := q[m[0]:m[1]]
</a><a href="#h10-0-27" id="h10-0-27" class="i">+		q = q[m[1]:]
</a><a href="#h10-0-28" id="h10-0-28" class="i">+
</a><a href="#h10-0-29" id="h10-0-29" class="i">+		if match == &quot; &quot; {
</a><a href="#h10-0-30" id="h10-0-30" class="i">+			// A space: Ends the operator, if we&#39;re in one.
</a><a href="#h10-0-31" id="h10-0-31" class="i">+			if key == &quot;&quot; {
</a><a href="#h10-0-32" id="h10-0-32" class="i">+				ops[key] += &quot; &quot;
</a><a href="#h10-0-33" id="h10-0-33" class="i">+			} else {
</a><a href="#h10-0-34" id="h10-0-34" class="i">+				key = &quot;&quot;
</a><a href="#h10-0-35" id="h10-0-35" class="i">+			}
</a><a href="#h10-0-36" id="h10-0-36" class="i">+		} else if match == &quot;(&quot; {
</a><a href="#h10-0-37" id="h10-0-37" class="i">+			// A parenthesis. Nothing is special until the
</a><a href="#h10-0-38" id="h10-0-38" class="i">+			// end of a balanced set of parenthesis
</a><a href="#h10-0-39" id="h10-0-39" class="i">+			p := 1
</a><a href="#h10-0-40" id="h10-0-40" class="i">+			esc := false
</a><a href="#h10-0-41" id="h10-0-41" class="i">+			var (
</a><a href="#h10-0-42" id="h10-0-42" class="i">+				i int
</a><a href="#h10-0-43" id="h10-0-43" class="i">+				r rune
</a><a href="#h10-0-44" id="h10-0-44" class="i">+			)
</a><a href="#h10-0-45" id="h10-0-45" class="i">+			var w bytes.Buffer
</a><a href="#h10-0-46" id="h10-0-46" class="i">+			for i, r = range q {
</a><a href="#h10-0-47" id="h10-0-47" class="i">+				switch {
</a><a href="#h10-0-48" id="h10-0-48" class="i">+				case esc:
</a><a href="#h10-0-49" id="h10-0-49" class="i">+					esc = false
</a><a href="#h10-0-50" id="h10-0-50" class="i">+				case r == &#39;\\&#39;:
</a><a href="#h10-0-51" id="h10-0-51" class="i">+					esc = true
</a><a href="#h10-0-52" id="h10-0-52" class="i">+				case r == &#39;(&#39;:
</a><a href="#h10-0-53" id="h10-0-53" class="i">+					p++
</a><a href="#h10-0-54" id="h10-0-54" class="i">+				case r == &#39;)&#39;:
</a><a href="#h10-0-55" id="h10-0-55" class="i">+					p--
</a><a href="#h10-0-56" id="h10-0-56" class="i">+				}
</a><a href="#h10-0-57" id="h10-0-57" class="i">+				w.WriteRune(r)
</a><a href="#h10-0-58" id="h10-0-58" class="i">+				if p == 0 {
</a><a href="#h10-0-59" id="h10-0-59" class="i">+					break
</a><a href="#h10-0-60" id="h10-0-60" class="i">+				}
</a><a href="#h10-0-61" id="h10-0-61" class="i">+			}
</a><a href="#h10-0-62" id="h10-0-62" class="i">+			ops[key] += match + w.String()
</a><a href="#h10-0-63" id="h10-0-63" class="i">+			q = q[i+utf8.RuneLen(r):]
</a><a href="#h10-0-64" id="h10-0-64" class="i">+		} else if match[0] == &#39;\\&#39; {
</a><a href="#h10-0-65" id="h10-0-65" class="i">+			ops[key] += match
</a><a href="#h10-0-66" id="h10-0-66" class="i">+		} else {
</a><a href="#h10-0-67" id="h10-0-67" class="i">+			// An operator. The key is in match group 1
</a><a href="#h10-0-68" id="h10-0-68" class="i">+			key = match[m[2]-m[0] : m[3]-m[0]]
</a><a href="#h10-0-69" id="h10-0-69" class="i">+		}
</a><a href="#h10-0-70" id="h10-0-70" class="i">+	}
</a><a href="#h10-0-71" id="h10-0-71" class="i">+
</a><a href="#h10-0-72" id="h10-0-72" class="i">+	var out client.Query
</a><a href="#h10-0-73" id="h10-0-73" class="i">+	out.File = ops[&quot;file&quot;]
</a><a href="#h10-0-74" id="h10-0-74" class="i">+	out.Repo = ops[&quot;repo&quot;]
</a><a href="#h10-0-75" id="h10-0-75" class="i">+	out.Line = strings.TrimSpace(ops[&quot;&quot;] + ops[&quot;case&quot;])
</a><a href="#h10-0-76" id="h10-0-76" class="i">+	if _, ok := ops[&quot;case&quot;]; ok {
</a><a href="#h10-0-77" id="h10-0-77" class="i">+		out.FoldCase = false
</a><a href="#h10-0-78" id="h10-0-78" class="i">+	} else {
</a><a href="#h10-0-79" id="h10-0-79" class="i">+		out.FoldCase = strings.IndexAny(out.Line, &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;) == -1
</a><a href="#h10-0-80" id="h10-0-80" class="i">+	}
</a><a href="#h10-0-81" id="h10-0-81" class="i">+
</a><a href="#h10-0-82" id="h10-0-82" class="i">+	return out
</a><a href="#h10-0-83" id="h10-0-83" class="i">+}
</a><b>diff --git a/<a id="h11" href="../file/server/query_test.go">server/query_test.go</a> b/<a href="../file/server/query_test.go">server/query_test.go</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -0,0 +1,84 @@
</a><a href="#h11-0-0" id="h11-0-0" class="i">+package server
</a><a href="#h11-0-1" id="h11-0-1" class="i">+
</a><a href="#h11-0-2" id="h11-0-2" class="i">+import (
</a><a href="#h11-0-3" id="h11-0-3" class="i">+	&quot;reflect&quot;
</a><a href="#h11-0-4" id="h11-0-4" class="i">+	&quot;testing&quot;
</a><a href="#h11-0-5" id="h11-0-5" class="i">+
</a><a href="#h11-0-6" id="h11-0-6" class="i">+	&quot;github.com/livegrep/livegrep/client&quot;
</a><a href="#h11-0-7" id="h11-0-7" class="i">+)
</a><a href="#h11-0-8" id="h11-0-8" class="i">+
</a><a href="#h11-0-9" id="h11-0-9" class="i">+func TestParseQuery(t *testing.T) {
</a><a href="#h11-0-10" id="h11-0-10" class="i">+	cases := []struct {
</a><a href="#h11-0-11" id="h11-0-11" class="i">+		in  string
</a><a href="#h11-0-12" id="h11-0-12" class="i">+		out client.Query
</a><a href="#h11-0-13" id="h11-0-13" class="i">+	}{
</a><a href="#h11-0-14" id="h11-0-14" class="i">+		{
</a><a href="#h11-0-15" id="h11-0-15" class="i">+			&quot;hello&quot;,
</a><a href="#h11-0-16" id="h11-0-16" class="i">+			client.Query{Line: &quot;hello&quot;, FoldCase: true},
</a><a href="#h11-0-17" id="h11-0-17" class="i">+		},
</a><a href="#h11-0-18" id="h11-0-18" class="i">+		{
</a><a href="#h11-0-19" id="h11-0-19" class="i">+			&quot;a b c&quot;,
</a><a href="#h11-0-20" id="h11-0-20" class="i">+			client.Query{Line: &quot;a b c&quot;, FoldCase: true},
</a><a href="#h11-0-21" id="h11-0-21" class="i">+		},
</a><a href="#h11-0-22" id="h11-0-22" class="i">+		{
</a><a href="#h11-0-23" id="h11-0-23" class="i">+			&quot;line file:.rb&quot;,
</a><a href="#h11-0-24" id="h11-0-24" class="i">+			client.Query{
</a><a href="#h11-0-25" id="h11-0-25" class="i">+				Line:     &quot;line&quot;,
</a><a href="#h11-0-26" id="h11-0-26" class="i">+				File:     &quot;.rb&quot;,
</a><a href="#h11-0-27" id="h11-0-27" class="i">+				FoldCase: true,
</a><a href="#h11-0-28" id="h11-0-28" class="i">+			},
</a><a href="#h11-0-29" id="h11-0-29" class="i">+		},
</a><a href="#h11-0-30" id="h11-0-30" class="i">+		{
</a><a href="#h11-0-31" id="h11-0-31" class="i">+			&quot; a  &quot;,
</a><a href="#h11-0-32" id="h11-0-32" class="i">+			client.Query{Line: &quot;a&quot;, FoldCase: true},
</a><a href="#h11-0-33" id="h11-0-33" class="i">+		},
</a><a href="#h11-0-34" id="h11-0-34" class="i">+		{
</a><a href="#h11-0-35" id="h11-0-35" class="i">+			&quot;( a  )&quot;,
</a><a href="#h11-0-36" id="h11-0-36" class="i">+			client.Query{Line: &quot;( a  )&quot;, FoldCase: true},
</a><a href="#h11-0-37" id="h11-0-37" class="i">+		},
</a><a href="#h11-0-38" id="h11-0-38" class="i">+		{
</a><a href="#h11-0-39" id="h11-0-39" class="i">+			&quot;Aa&quot;,
</a><a href="#h11-0-40" id="h11-0-40" class="i">+			client.Query{Line: &quot;Aa&quot;, FoldCase: false},
</a><a href="#h11-0-41" id="h11-0-41" class="i">+		},
</a><a href="#h11-0-42" id="h11-0-42" class="i">+		{
</a><a href="#h11-0-43" id="h11-0-43" class="i">+			&quot;case:abc&quot;,
</a><a href="#h11-0-44" id="h11-0-44" class="i">+			client.Query{Line: &quot;abc&quot;, FoldCase: false},
</a><a href="#h11-0-45" id="h11-0-45" class="i">+		},
</a><a href="#h11-0-46" id="h11-0-46" class="i">+		{
</a><a href="#h11-0-47" id="h11-0-47" class="i">+			&quot;case:abc file:^kernel/&quot;,
</a><a href="#h11-0-48" id="h11-0-48" class="i">+			client.Query{Line: &quot;abc&quot;, FoldCase: false, File: &quot;^kernel/&quot;},
</a><a href="#h11-0-49" id="h11-0-49" class="i">+		},
</a><a href="#h11-0-50" id="h11-0-50" class="i">+		{
</a><a href="#h11-0-51" id="h11-0-51" class="i">+			&quot;case:abc file:( )&quot;,
</a><a href="#h11-0-52" id="h11-0-52" class="i">+			client.Query{Line: &quot;abc&quot;, FoldCase: false, File: &quot;( )&quot;},
</a><a href="#h11-0-53" id="h11-0-53" class="i">+		},
</a><a href="#h11-0-54" id="h11-0-54" class="i">+		{
</a><a href="#h11-0-55" id="h11-0-55" class="i">+			&quot;a file:b c&quot;,
</a><a href="#h11-0-56" id="h11-0-56" class="i">+			client.Query{Line: &quot;a c&quot;, FoldCase: true, File: &quot;b&quot;},
</a><a href="#h11-0-57" id="h11-0-57" class="i">+		},
</a><a href="#h11-0-58" id="h11-0-58" class="i">+		{
</a><a href="#h11-0-59" id="h11-0-59" class="i">+			&quot;a file:((abc()())()) c&quot;,
</a><a href="#h11-0-60" id="h11-0-60" class="i">+			client.Query{Line: &quot;a c&quot;, FoldCase: true, File: &quot;((abc()())())&quot;},
</a><a href="#h11-0-61" id="h11-0-61" class="i">+		},
</a><a href="#h11-0-62" id="h11-0-62" class="i">+		{
</a><a href="#h11-0-63" id="h11-0-63" class="i">+			&quot;(  () (   &quot;,
</a><a href="#h11-0-64" id="h11-0-64" class="i">+			client.Query{Line: &quot;(  () (&quot;, FoldCase: true},
</a><a href="#h11-0-65" id="h11-0-65" class="i">+		},
</a><a href="#h11-0-66" id="h11-0-66" class="i">+		{
</a><a href="#h11-0-67" id="h11-0-67" class="i">+			`a file:\(`,
</a><a href="#h11-0-68" id="h11-0-68" class="i">+			client.Query{Line: &quot;a&quot;, File: `\(`, FoldCase: true},
</a><a href="#h11-0-69" id="h11-0-69" class="i">+		},
</a><a href="#h11-0-70" id="h11-0-70" class="i">+		{
</a><a href="#h11-0-71" id="h11-0-71" class="i">+			`a file:(\()`,
</a><a href="#h11-0-72" id="h11-0-72" class="i">+			client.Query{Line: &quot;a&quot;, File: `(\()`, FoldCase: true},
</a><a href="#h11-0-73" id="h11-0-73" class="i">+		},
</a><a href="#h11-0-74" id="h11-0-74" class="i">+	}
</a><a href="#h11-0-75" id="h11-0-75" class="i">+
</a><a href="#h11-0-76" id="h11-0-76" class="i">+	for _, tc := range cases {
</a><a href="#h11-0-77" id="h11-0-77" class="i">+		parsed := ParseQuery(tc.in)
</a><a href="#h11-0-78" id="h11-0-78" class="i">+		if !reflect.DeepEqual(tc.out, parsed) {
</a><a href="#h11-0-79" id="h11-0-79" class="i">+			t.Errorf(&quot;error parsing %q: expected %#v got %#v&quot;,
</a><a href="#h11-0-80" id="h11-0-80" class="i">+				tc.in, tc.out, parsed)
</a><a href="#h11-0-81" id="h11-0-81" class="i">+		}
</a><a href="#h11-0-82" id="h11-0-82" class="i">+	}
</a><a href="#h11-0-83" id="h11-0-83" class="i">+}
</a><b>diff --git a/<a id="h12" href="../file/server/server.go">server/server.go</a> b/<a href="../file/server/server.go">server/server.go</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -1,6 +1,7 @@
</a> package server
 
 import (
<a href="#h12-0-3" id="h12-0-3" class="i">+	&quot;fmt&quot;
</a> 	&quot;html/template&quot;
 	&quot;io&quot;
 	&quot;net/http&quot;
<a href="#h12-1" id="h12-1" class="h">@@ -10,24 +11,34 @@ import (
</a> 	&quot;code.google.com/p/go.net/context&quot;
 
 	&quot;github.com/bmizerany/pat&quot;
<a href="#h12-1-3" id="h12-1-3" class="d">-	&quot;github.com/livegrep/livegrep/server/backend&quot;
</a><a href="#h12-1-4" id="h12-1-4" class="i">+
</a><a href="#h12-1-5" id="h12-1-5" class="i">+	&quot;github.com/livegrep/livegrep/client&quot;
</a> 	&quot;github.com/livegrep/livegrep/server/config&quot;
 	&quot;github.com/livegrep/livegrep/server/log&quot;
 	&quot;github.com/livegrep/livegrep/server/reqid&quot;
<a href="#h12-1-9" id="h12-1-9" class="i">+	&quot;github.com/livegrep/livegrep/server/templates&quot;
</a> )
 
<a href="#h12-1-12" id="h12-1-12" class="i">+type Templates struct {
</a><a href="#h12-1-13" id="h12-1-13" class="i">+	Layout,
</a><a href="#h12-1-14" id="h12-1-14" class="i">+	Index,
</a><a href="#h12-1-15" id="h12-1-15" class="i">+	About,
</a><a href="#h12-1-16" id="h12-1-16" class="i">+	Help *template.Template
</a><a href="#h12-1-17" id="h12-1-17" class="i">+	OpenSearch *template.Template `template:&quot;opensearch.xml&quot;`
</a><a href="#h12-1-18" id="h12-1-18" class="i">+}
</a><a href="#h12-1-19" id="h12-1-19" class="i">+
</a> type server struct {
 	config *config.Config
<a href="#h12-1-22" id="h12-1-22" class="d">-	bk     map[string]*backend.Backend
</a><a href="#h12-1-23" id="h12-1-23" class="i">+	bk     map[string]*Backend
</a> 	inner  http.Handler
<a href="#h12-1-25" id="h12-1-25" class="d">-	t      templates
</a><a href="#h12-1-26" id="h12-1-26" class="i">+	T      Templates
</a><a href="#h12-1-27" id="h12-1-27" class="i">+	Layout *template.Template
</a> }
 
 func (s *server) loadTemplates() {
<a href="#h12-1-31" id="h12-1-31" class="d">-	s.t.layout = s.readTemplates(&quot;layout.html&quot;)
</a><a href="#h12-1-32" id="h12-1-32" class="d">-	s.t.searchPage = s.readTemplates(&quot;index.html&quot;)
</a><a href="#h12-1-33" id="h12-1-33" class="d">-	s.t.aboutPage = s.readTemplates(&quot;about.html&quot;)
</a><a href="#h12-1-34" id="h12-1-34" class="d">-	s.t.opensearchXML = s.readTemplates(&quot;opensearch.xml&quot;)
</a><a href="#h12-1-35" id="h12-1-35" class="i">+	if e := templates.Load(path.Join(s.config.DocRoot, &quot;templates&quot;), &amp;s.T); e != nil {
</a><a href="#h12-1-36" id="h12-1-36" class="i">+		panic(fmt.Sprintf(&quot;loading templates: %v&quot;, e))
</a><a href="#h12-1-37" id="h12-1-37" class="i">+	}
</a> }
 
 func (s *server) ServeHTTP(w http.ResponseWriter, r *http.Request) {
<a href="#h12-2" id="h12-2" class="h">@@ -40,7 +51,7 @@ func (s *server) ServeRoot(ctx context.Context, w http.ResponseWriter, r *http.R
</a> 
 func (s *server) ServeSearch(ctx context.Context, w http.ResponseWriter, r *http.Request) {
 	gh := make(map[string]map[string]string, len(s.bk))
<a href="#h12-2-3" id="h12-2-3" class="d">-	backends := make([]*backend.Backend, 0, len(s.bk))
</a><a href="#h12-2-4" id="h12-2-4" class="i">+	backends := make([]*Backend, 0, len(s.bk))
</a> 	for _, bk := range s.bk {
 		backends = append(backends, bk)
 		bk.I.Lock()
<a href="#h12-3" id="h12-3" class="h">@@ -53,32 +64,50 @@ func (s *server) ServeSearch(ctx context.Context, w http.ResponseWriter, r *http
</a> 		}
 		bk.I.Unlock()
 	}
<a href="#h12-3-3" id="h12-3-3" class="d">-	data := &amp;searchContext{
</a><a href="#h12-3-4" id="h12-3-4" class="d">-		GithubRepos: gh,
</a><a href="#h12-3-5" id="h12-3-5" class="d">-		Backends:    backends,
</a><a href="#h12-3-6" id="h12-3-6" class="d">-	}
</a><a href="#h12-3-7" id="h12-3-7" class="d">-	body, err := s.executeTemplate(s.t.searchPage, data)
</a><a href="#h12-3-8" id="h12-3-8" class="i">+	data := &amp;struct {
</a><a href="#h12-3-9" id="h12-3-9" class="i">+		GithubRepos map[string]map[string]string
</a><a href="#h12-3-10" id="h12-3-10" class="i">+		Backends    []*Backend
</a><a href="#h12-3-11" id="h12-3-11" class="i">+	}{gh, backends}
</a><a href="#h12-3-12" id="h12-3-12" class="i">+
</a><a href="#h12-3-13" id="h12-3-13" class="i">+	body, err := executeTemplate(s.T.Index, data)
</a> 	if err != nil {
 		http.Error(w, err.Error(), 500)
 		return
 	}
 	s.renderPage(w, &amp;page{
<a href="#h12-3-19" id="h12-3-19" class="d">-		Title:     &quot;search&quot;,
</a><a href="#h12-3-20" id="h12-3-20" class="d">-		IncludeJS: true,
</a><a href="#h12-3-21" id="h12-3-21" class="d">-		Body:      template.HTML(body),
</a><a href="#h12-3-22" id="h12-3-22" class="i">+		Title: &quot;search&quot;,
</a><a href="#h12-3-23" id="h12-3-23" class="i">+		Body:  template.HTML(body),
</a> 	})
 }
 
 func (s *server) ServeAbout(ctx context.Context, w http.ResponseWriter, r *http.Request) {
<a href="#h12-3-28" id="h12-3-28" class="d">-	body, err := s.executeTemplate(s.t.aboutPage, nil)
</a><a href="#h12-3-29" id="h12-3-29" class="i">+	body, err := executeTemplate(s.T.About, nil)
</a> 	if err != nil {
 		http.Error(w, err.Error(), 500)
 		return
 	}
 	s.renderPage(w, &amp;page{
<a href="#h12-3-35" id="h12-3-35" class="d">-		Title:     &quot;about&quot;,
</a><a href="#h12-3-36" id="h12-3-36" class="d">-		IncludeJS: true,
</a><a href="#h12-3-37" id="h12-3-37" class="d">-		Body:      template.HTML(body),
</a><a href="#h12-3-38" id="h12-3-38" class="i">+		Title: &quot;about&quot;,
</a><a href="#h12-3-39" id="h12-3-39" class="i">+		Body:  template.HTML(body),
</a><a href="#h12-3-40" id="h12-3-40" class="i">+	})
</a><a href="#h12-3-41" id="h12-3-41" class="i">+}
</a><a href="#h12-3-42" id="h12-3-42" class="i">+
</a><a href="#h12-3-43" id="h12-3-43" class="i">+func (s *server) ServeHelp(ctx context.Context, w http.ResponseWriter, r *http.Request) {
</a><a href="#h12-3-44" id="h12-3-44" class="i">+	d := struct{ SampleRepo string }{}
</a><a href="#h12-3-45" id="h12-3-45" class="i">+	for _, bk := range s.bk {
</a><a href="#h12-3-46" id="h12-3-46" class="i">+		if len(bk.I.Trees) &gt; 1 {
</a><a href="#h12-3-47" id="h12-3-47" class="i">+			d.SampleRepo = bk.I.Trees[0].Name
</a><a href="#h12-3-48" id="h12-3-48" class="i">+		}
</a><a href="#h12-3-49" id="h12-3-49" class="i">+	}
</a><a href="#h12-3-50" id="h12-3-50" class="i">+
</a><a href="#h12-3-51" id="h12-3-51" class="i">+	body, err := executeTemplate(s.T.Help, d)
</a><a href="#h12-3-52" id="h12-3-52" class="i">+	if err != nil {
</a><a href="#h12-3-53" id="h12-3-53" class="i">+		http.Error(w, err.Error(), 500)
</a><a href="#h12-3-54" id="h12-3-54" class="i">+		return
</a><a href="#h12-3-55" id="h12-3-55" class="i">+	}
</a><a href="#h12-3-56" id="h12-3-56" class="i">+	s.renderPage(w, &amp;page{
</a><a href="#h12-3-57" id="h12-3-57" class="i">+		Title: &quot;query syntax&quot;,
</a><a href="#h12-3-58" id="h12-3-58" class="i">+		Body:  template.HTML(body),
</a> 	})
 }
 
<a href="#h12-4" id="h12-4" class="h">@@ -99,8 +128,11 @@ func (s *server) requestProtocol(r *http.Request) string {
</a> }
 
 func (s *server) ServeOpensearch(ctx context.Context, w http.ResponseWriter, r *http.Request) {
<a href="#h12-4-3" id="h12-4-3" class="d">-	data := &amp;opensearchContext{}
</a><a href="#h12-4-4" id="h12-4-4" class="d">-	data.BaseURL += s.requestProtocol(r) + &quot;://&quot; + r.Host + &quot;/&quot;
</a><a href="#h12-4-5" id="h12-4-5" class="i">+	data := &amp;struct {
</a><a href="#h12-4-6" id="h12-4-6" class="i">+		BackendName, BaseURL string
</a><a href="#h12-4-7" id="h12-4-7" class="i">+	}{
</a><a href="#h12-4-8" id="h12-4-8" class="i">+		BaseURL: s.requestProtocol(r) + &quot;://&quot; + r.Host + &quot;/&quot;,
</a><a href="#h12-4-9" id="h12-4-9" class="i">+	}
</a> 
 	for _, bk := range s.bk {
 		if bk.I.Name != &quot;&quot; {
<a href="#h12-5" id="h12-5" class="h">@@ -109,7 +141,7 @@ func (s *server) ServeOpensearch(ctx context.Context, w http.ResponseWriter, r *
</a> 		}
 	}
 
<a href="#h12-5-3" id="h12-5-3" class="d">-	body, err := s.executeTemplate(s.t.opensearchXML, data)
</a><a href="#h12-5-4" id="h12-5-4" class="i">+	body, err := executeTemplate(s.T.OpenSearch, data)
</a> 	if err != nil {
 		http.Error(w, err.Error(), 500)
 		return
<a href="#h12-6" id="h12-6" class="h">@@ -136,11 +168,17 @@ func (s *server) Handler(f func(c context.Context, w http.ResponseWriter, r *htt
</a> }
 
 func New(cfg *config.Config) (http.Handler, error) {
<a href="#h12-6-3" id="h12-6-3" class="d">-	srv := &amp;server{config: cfg, bk: make(map[string]*backend.Backend)}
</a><a href="#h12-6-4" id="h12-6-4" class="i">+	srv := &amp;server{config: cfg, bk: make(map[string]*Backend)}
</a> 	srv.loadTemplates()
 
 	for _, bk := range srv.config.Backends {
<a href="#h12-6-8" id="h12-6-8" class="d">-		srv.bk[bk.Id] = backend.New(&amp;bk)
</a><a href="#h12-6-9" id="h12-6-9" class="i">+		addr := bk.Addr
</a><a href="#h12-6-10" id="h12-6-10" class="i">+		be := &amp;Backend{
</a><a href="#h12-6-11" id="h12-6-11" class="i">+			Id:   bk.Id,
</a><a href="#h12-6-12" id="h12-6-12" class="i">+			Dial: func() (client.Client, error) { return client.Dial(&quot;tcp&quot;, addr) },
</a><a href="#h12-6-13" id="h12-6-13" class="i">+		}
</a><a href="#h12-6-14" id="h12-6-14" class="i">+		be.Start()
</a><a href="#h12-6-15" id="h12-6-15" class="i">+		srv.bk[be.Id] = be
</a> 	}
 
 	m := pat.New()
<a href="#h12-7" id="h12-7" class="h">@@ -148,15 +186,24 @@ func New(cfg *config.Config) (http.Handler, error) {
</a> 	m.Add(&quot;GET&quot;, &quot;/search/:backend&quot;, srv.Handler(srv.ServeSearch))
 	m.Add(&quot;GET&quot;, &quot;/search/&quot;, srv.Handler(srv.ServeSearch))
 	m.Add(&quot;GET&quot;, &quot;/about&quot;, srv.Handler(srv.ServeAbout))
<a href="#h12-7-3" id="h12-7-3" class="i">+	m.Add(&quot;GET&quot;, &quot;/help&quot;, srv.Handler(srv.ServeHelp))
</a> 	m.Add(&quot;GET&quot;, &quot;/debug/healthcheck&quot;, srv.Handler(srv.ServeHealthcheck))
 	m.Add(&quot;GET&quot;, &quot;/opensearch.xml&quot;, srv.Handler(srv.ServeOpensearch))
 
 	m.Add(&quot;GET&quot;, &quot;/api/v1/search/:backend&quot;, srv.Handler(srv.ServeAPISearch))
 	m.Add(&quot;GET&quot;, &quot;/api/v1/search/&quot;, srv.Handler(srv.ServeAPISearch))
 
<a href="#h12-7-10" id="h12-7-10" class="i">+	var h http.Handler = m
</a><a href="#h12-7-11" id="h12-7-11" class="i">+
</a><a href="#h12-7-12" id="h12-7-12" class="i">+	if cfg.Reload {
</a><a href="#h12-7-13" id="h12-7-13" class="i">+		h = templates.ReloadHandler(
</a><a href="#h12-7-14" id="h12-7-14" class="i">+			path.Join(srv.config.DocRoot, &quot;templates&quot;),
</a><a href="#h12-7-15" id="h12-7-15" class="i">+			&amp;srv.T, h)
</a><a href="#h12-7-16" id="h12-7-16" class="i">+	}
</a><a href="#h12-7-17" id="h12-7-17" class="i">+
</a> 	mux := http.NewServeMux()
 	mux.Handle(&quot;/assets/&quot;, http.FileServer(http.Dir(path.Join(cfg.DocRoot, &quot;htdocs&quot;))))
<a href="#h12-7-20" id="h12-7-20" class="d">-	mux.Handle(&quot;/&quot;, m)
</a><a href="#h12-7-21" id="h12-7-21" class="i">+	mux.Handle(&quot;/&quot;, h)
</a> 
 	srv.inner = mux
 
<b>diff --git a/<a id="h13" href="../file/server/templates.go">server/templates.go</a> b/<a href="../file/server/templates.go">server/templates.go</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -2,48 +2,21 @@ package server
</a> 
 import (
 	&quot;bytes&quot;
<a href="#h13-0-3" id="h13-0-3" class="d">-	&quot;html/template&quot;
</a> 	&quot;io&quot;
 	&quot;log&quot;
<a href="#h13-0-6" id="h13-0-6" class="d">-	&quot;path&quot;
</a> 
<a href="#h13-0-8" id="h13-0-8" class="d">-	&quot;github.com/livegrep/livegrep/server/backend&quot;
</a><a href="#h13-0-9" id="h13-0-9" class="i">+	&quot;html/template&quot;
</a><a href="#h13-0-10" id="h13-0-10" class="i">+
</a> 	&quot;github.com/livegrep/livegrep/server/config&quot;
 )
 
<a href="#h13-0-14" id="h13-0-14" class="d">-type templates struct {
</a><a href="#h13-0-15" id="h13-0-15" class="d">-	layout,
</a><a href="#h13-0-16" id="h13-0-16" class="d">-	searchPage,
</a><a href="#h13-0-17" id="h13-0-17" class="d">-	aboutPage,
</a><a href="#h13-0-18" id="h13-0-18" class="d">-	opensearchXML *template.Template
</a><a href="#h13-0-19" id="h13-0-19" class="d">-}
</a><a href="#h13-0-20" id="h13-0-20" class="d">-
</a> type page struct {
<a href="#h13-0-22" id="h13-0-22" class="d">-	IncludeJS bool
</a><a href="#h13-0-23" id="h13-0-23" class="d">-	Title     string
</a><a href="#h13-0-24" id="h13-0-24" class="d">-	Body      template.HTML
</a><a href="#h13-0-25" id="h13-0-25" class="d">-	Config    *config.Config
</a><a href="#h13-0-26" id="h13-0-26" class="d">-}
</a><a href="#h13-0-27" id="h13-0-27" class="d">-
</a><a href="#h13-0-28" id="h13-0-28" class="d">-type opensearchContext struct {
</a><a href="#h13-0-29" id="h13-0-29" class="d">-	BackendName string
</a><a href="#h13-0-30" id="h13-0-30" class="d">-	BaseURL     string
</a><a href="#h13-0-31" id="h13-0-31" class="d">-}
</a><a href="#h13-0-32" id="h13-0-32" class="d">-
</a><a href="#h13-0-33" id="h13-0-33" class="d">-type searchContext struct {
</a><a href="#h13-0-34" id="h13-0-34" class="d">-	GithubRepos interface{}
</a><a href="#h13-0-35" id="h13-0-35" class="d">-	Backends    []*backend.Backend
</a><a href="#h13-0-36" id="h13-0-36" class="d">-}
</a><a href="#h13-0-37" id="h13-0-37" class="d">-
</a><a href="#h13-0-38" id="h13-0-38" class="d">-func (s *server) readTemplates(files ...string) *template.Template {
</a><a href="#h13-0-39" id="h13-0-39" class="d">-	filenames := make([]string, 0, len(files))
</a><a href="#h13-0-40" id="h13-0-40" class="d">-	for _, f := range files {
</a><a href="#h13-0-41" id="h13-0-41" class="d">-		filenames = append(filenames, path.Join(s.config.DocRoot, &quot;templates&quot;, f))
</a><a href="#h13-0-42" id="h13-0-42" class="d">-	}
</a><a href="#h13-0-43" id="h13-0-43" class="d">-	return template.Must(template.ParseFiles(filenames...))
</a><a href="#h13-0-44" id="h13-0-44" class="i">+	Title  string
</a><a href="#h13-0-45" id="h13-0-45" class="i">+	Body   template.HTML
</a><a href="#h13-0-46" id="h13-0-46" class="i">+	Config *config.Config
</a> }
 
<a href="#h13-0-49" id="h13-0-49" class="d">-func (s *server) executeTemplate(t *template.Template, context interface{}) ([]byte, error) {
</a><a href="#h13-0-50" id="h13-0-50" class="i">+func executeTemplate(t *template.Template, context interface{}) ([]byte, error) {
</a> 	var buf bytes.Buffer
 	if err := t.Execute(&amp;buf, context); err != nil {
 		return nil, err
<a href="#h13-1" id="h13-1" class="h">@@ -53,7 +26,7 @@ func (s *server) executeTemplate(t *template.Template, context interface{}) ([]b
</a> 
 func (s *server) renderPage(w io.Writer, p *page) {
 	p.Config = s.config
<a href="#h13-1-3" id="h13-1-3" class="d">-	if e := s.t.layout.Execute(w, p); e != nil {
</a><a href="#h13-1-4" id="h13-1-4" class="i">+	if e := s.T.Layout.Execute(w, p); e != nil {
</a> 		log.Printf(&quot;Error rendering page=%q error=%q&quot;,
 			p.Title, e.Error())
 	}
<b>diff --git a/<a id="h14" href="../file/server/templates/templates.go">server/templates/templates.go</a> b/<a href="../file/server/templates/templates.go">server/templates/templates.go</a></b>
<a href="#h14-0" id="h14-0" class="h">@@ -0,0 +1,62 @@
</a><a href="#h14-0-0" id="h14-0-0" class="i">+package templates
</a><a href="#h14-0-1" id="h14-0-1" class="i">+
</a><a href="#h14-0-2" id="h14-0-2" class="i">+import (
</a><a href="#h14-0-3" id="h14-0-3" class="i">+	&quot;html/template&quot;
</a><a href="#h14-0-4" id="h14-0-4" class="i">+	&quot;log&quot;
</a><a href="#h14-0-5" id="h14-0-5" class="i">+	&quot;net/http&quot;
</a><a href="#h14-0-6" id="h14-0-6" class="i">+	&quot;path&quot;
</a><a href="#h14-0-7" id="h14-0-7" class="i">+	&quot;reflect&quot;
</a><a href="#h14-0-8" id="h14-0-8" class="i">+	&quot;strings&quot;
</a><a href="#h14-0-9" id="h14-0-9" class="i">+)
</a><a href="#h14-0-10" id="h14-0-10" class="i">+
</a><a href="#h14-0-11" id="h14-0-11" class="i">+func templatePath(f reflect.StructField) string {
</a><a href="#h14-0-12" id="h14-0-12" class="i">+	if path := f.Tag.Get(&quot;template&quot;); path != &quot;&quot; {
</a><a href="#h14-0-13" id="h14-0-13" class="i">+		return path
</a><a href="#h14-0-14" id="h14-0-14" class="i">+	}
</a><a href="#h14-0-15" id="h14-0-15" class="i">+	return strings.ToLower(f.Name) + &quot;.html&quot;
</a><a href="#h14-0-16" id="h14-0-16" class="i">+}
</a><a href="#h14-0-17" id="h14-0-17" class="i">+
</a><a href="#h14-0-18" id="h14-0-18" class="i">+func Load(base string, templates interface{}) error {
</a><a href="#h14-0-19" id="h14-0-19" class="i">+	v := reflect.ValueOf(templates)
</a><a href="#h14-0-20" id="h14-0-20" class="i">+	if v.Kind() != reflect.Ptr {
</a><a href="#h14-0-21" id="h14-0-21" class="i">+		panic(&quot;Load: Must provide pointer-to-struct&quot;)
</a><a href="#h14-0-22" id="h14-0-22" class="i">+	}
</a><a href="#h14-0-23" id="h14-0-23" class="i">+	v = v.Elem()
</a><a href="#h14-0-24" id="h14-0-24" class="i">+	if v.Kind() != reflect.Struct {
</a><a href="#h14-0-25" id="h14-0-25" class="i">+		panic(&quot;Load: Must provide pointer-to-struct&quot;)
</a><a href="#h14-0-26" id="h14-0-26" class="i">+	}
</a><a href="#h14-0-27" id="h14-0-27" class="i">+	t := v.Type()
</a><a href="#h14-0-28" id="h14-0-28" class="i">+	for i := 0; i &lt; t.NumField(); i++ {
</a><a href="#h14-0-29" id="h14-0-29" class="i">+		f := t.Field(i)
</a><a href="#h14-0-30" id="h14-0-30" class="i">+
</a><a href="#h14-0-31" id="h14-0-31" class="i">+		if !f.Type.AssignableTo(reflect.TypeOf((*template.Template)(nil))) {
</a><a href="#h14-0-32" id="h14-0-32" class="i">+			continue
</a><a href="#h14-0-33" id="h14-0-33" class="i">+		}
</a><a href="#h14-0-34" id="h14-0-34" class="i">+
</a><a href="#h14-0-35" id="h14-0-35" class="i">+		p := templatePath(f)
</a><a href="#h14-0-36" id="h14-0-36" class="i">+		tpl, err := template.ParseFiles(path.Join(base, p))
</a><a href="#h14-0-37" id="h14-0-37" class="i">+		if err != nil {
</a><a href="#h14-0-38" id="h14-0-38" class="i">+			return err
</a><a href="#h14-0-39" id="h14-0-39" class="i">+		}
</a><a href="#h14-0-40" id="h14-0-40" class="i">+		v.Field(i).Set(reflect.ValueOf(tpl))
</a><a href="#h14-0-41" id="h14-0-41" class="i">+	}
</a><a href="#h14-0-42" id="h14-0-42" class="i">+	return nil
</a><a href="#h14-0-43" id="h14-0-43" class="i">+}
</a><a href="#h14-0-44" id="h14-0-44" class="i">+
</a><a href="#h14-0-45" id="h14-0-45" class="i">+type reloadHandler struct {
</a><a href="#h14-0-46" id="h14-0-46" class="i">+	baseDir string
</a><a href="#h14-0-47" id="h14-0-47" class="i">+	t       interface{}
</a><a href="#h14-0-48" id="h14-0-48" class="i">+	in      http.Handler
</a><a href="#h14-0-49" id="h14-0-49" class="i">+}
</a><a href="#h14-0-50" id="h14-0-50" class="i">+
</a><a href="#h14-0-51" id="h14-0-51" class="i">+func ReloadHandler(base string, templates interface{}, h http.Handler) http.Handler {
</a><a href="#h14-0-52" id="h14-0-52" class="i">+	return &amp;reloadHandler{base, templates, h}
</a><a href="#h14-0-53" id="h14-0-53" class="i">+}
</a><a href="#h14-0-54" id="h14-0-54" class="i">+
</a><a href="#h14-0-55" id="h14-0-55" class="i">+func (h *reloadHandler) ServeHTTP(w http.ResponseWriter, r *http.Request) {
</a><a href="#h14-0-56" id="h14-0-56" class="i">+	e := Load(h.baseDir, h.t)
</a><a href="#h14-0-57" id="h14-0-57" class="i">+	if e != nil {
</a><a href="#h14-0-58" id="h14-0-58" class="i">+		log.Printf(&quot;loading templates: err=%v&quot;, e)
</a><a href="#h14-0-59" id="h14-0-59" class="i">+	}
</a><a href="#h14-0-60" id="h14-0-60" class="i">+	h.in.ServeHTTP(w, r)
</a><a href="#h14-0-61" id="h14-0-61" class="i">+}
</a><b>diff --git a/<a id="h15" href="../file/web/htdocs/assets/css/codesearch.css">web/htdocs/assets/css/codesearch.css</a> b/<a href="../file/web/htdocs/assets/css/codesearch.css">web/htdocs/assets/css/codesearch.css</a></b>
<a href="#h15-0" id="h15-0" class="h">@@ -1,12 +1,12 @@
</a> body {
     margin: 1em 3em;
<a href="#h15-0-2" id="h15-0-2" class="i">+    font-family: sans-serif;
</a> }
 
 #searcharea {
     width: 30em;
     margin: auto;
     margin-bottom: 1em;
<a href="#h15-0-9" id="h15-0-9" class="d">-    padding: 5px;
</a>     border: 1px solid black;
 }
 
<a href="#h15-1" id="h15-1" class="h">@@ -15,10 +15,27 @@ body {
</a> }
 
 #searchinput {
<a href="#h15-1-3" id="h15-1-3" class="i">+    margin: 10px;
</a><a href="#h15-1-4" id="h15-1-4" class="i">+}
</a><a href="#h15-1-5" id="h15-1-5" class="i">+
</a><a href="#h15-1-6" id="h15-1-6" class="i">+.querybox {
</a>     float: left;
 }
 
<a href="#h15-1-10" id="h15-1-10" class="d">-#errorbox {
</a><a href="#h15-1-11" id="h15-1-11" class="i">+.querybox {
</a><a href="#h15-1-12" id="h15-1-12" class="i">+    font-size: 80%;
</a><a href="#h15-1-13" id="h15-1-13" class="i">+    padding-left: 1ex;
</a><a href="#h15-1-14" id="h15-1-14" class="i">+}
</a><a href="#h15-1-15" id="h15-1-15" class="i">+
</a><a href="#h15-1-16" id="h15-1-16" class="i">+.querybox .help a{
</a><a href="#h15-1-17" id="h15-1-17" class="i">+    text-decoration: none;
</a><a href="#h15-1-18" id="h15-1-18" class="i">+}
</a><a href="#h15-1-19" id="h15-1-19" class="i">+
</a><a href="#h15-1-20" id="h15-1-20" class="i">+#searcharea input {
</a><a href="#h15-1-21" id="h15-1-21" class="i">+  width: 20em;
</a><a href="#h15-1-22" id="h15-1-22" class="i">+}
</a><a href="#h15-1-23" id="h15-1-23" class="i">+
</a><a href="#h15-1-24" id="h15-1-24" class="i">+#whatbox {
</a>     float: right;
 }
 
<a href="#h15-2" id="h15-2" class="h">@@ -33,6 +50,8 @@ body {
</a> 
 #regex-error {
     display: none;
<a href="#h15-2-3" id="h15-2-3" class="i">+    text-align: center;
</a><a href="#h15-2-4" id="h15-2-4" class="i">+    margin: 10px;
</a> }
 
 #errortext {
<a href="#h15-3" id="h15-3" class="h">@@ -138,48 +157,28 @@ body {
</a>     width: 40em;
 }
 
<a href="#h15-3-3" id="h15-3-3" class="d">-#feedback {
</a><a href="#h15-3-4" id="h15-3-4" class="d">-    border: 3px double black;
</a><a href="#h15-3-5" id="h15-3-5" class="d">-    background: white;
</a><a href="#h15-3-6" id="h15-3-6" class="d">-    z-index: 1;
</a><a href="#h15-3-7" id="h15-3-7" class="d">-    position: absolute;
</a><a href="#h15-3-8" id="h15-3-8" class="d">-    display: none;
</a><a href="#h15-3-9" id="h15-3-9" class="i">+#permalink {
</a><a href="#h15-3-10" id="h15-3-10" class="i">+    font-size: 80%;
</a> }
 
<a href="#h15-3-13" id="h15-3-13" class="d">-#feedback .spinner {
</a><a href="#h15-3-14" id="h15-3-14" class="i">+#resultarea {
</a>     display: none;
 }
 
<a href="#h15-3-18" id="h15-3-18" class="d">-#feedback input {
</a><a href="#h15-3-19" id="h15-3-19" class="d">-    margin: 5px;
</a><a href="#h15-3-20" id="h15-3-20" class="d">-}
</a><a href="#h15-3-21" id="h15-3-21" class="d">-
</a><a href="#h15-3-22" id="h15-3-22" class="d">-#feedback button {
</a><a href="#h15-3-23" id="h15-3-23" class="d">-    margin: 5px;
</a><a href="#h15-3-24" id="h15-3-24" class="d">-}
</a><a href="#h15-3-25" id="h15-3-25" class="d">-
</a><a href="#h15-3-26" id="h15-3-26" class="d">-#feedback textarea {
</a><a href="#h15-3-27" id="h15-3-27" class="d">-    margin: 5px;
</a><a href="#h15-3-28" id="h15-3-28" class="d">-}
</a><a href="#h15-3-29" id="h15-3-29" class="i">+/* /help */
</a> 
<a href="#h15-3-31" id="h15-3-31" class="d">-#feedback .submit {
</a><a href="#h15-3-32" id="h15-3-32" class="d">-    float: right;
</a><a href="#h15-3-33" id="h15-3-33" class="d">-}
</a><a href="#h15-3-34" id="h15-3-34" class="d">-
</a><a href="#h15-3-35" id="h15-3-35" class="d">-#feedback {
</a><a href="#h15-3-36" id="h15-3-36" class="d">-    font-size: 80%;
</a><a href="#h15-3-37" id="h15-3-37" class="d">-    color: #999;
</a><a href="#h15-3-38" id="h15-3-38" class="d">-    margin: 5px;
</a><a href="#h15-3-39" id="h15-3-39" class="i">+div.example {
</a><a href="#h15-3-40" id="h15-3-40" class="i">+    margin: 10px;
</a><a href="#h15-3-41" id="h15-3-41" class="i">+    width: 20em;
</a><a href="#h15-3-42" id="h15-3-42" class="i">+    padding-left: 2em;
</a> }
 
<a href="#h15-3-45" id="h15-3-45" class="d">-#feedback .result {
</a><a href="#h15-3-46" id="h15-3-46" class="d">-    font-size: 100%;
</a><a href="#h15-3-47" id="h15-3-47" class="i">+.query {
</a><a href="#h15-3-48" id="h15-3-48" class="i">+    font-family: monospace;
</a><a href="#h15-3-49" id="h15-3-49" class="i">+    font-weight: bold;
</a> }
 
<a href="#h15-3-52" id="h15-3-52" class="d">-#permalink {
</a><a href="#h15-3-53" id="h15-3-53" class="i">+.example .link {
</a>     font-size: 80%;
<a href="#h15-3-55" id="h15-3-55" class="d">-}
</a><a href="#h15-3-56" id="h15-3-56" class="d">-
</a><a href="#h15-3-57" id="h15-3-57" class="d">-#resultarea {
</a><a href="#h15-3-58" id="h15-3-58" class="d">-    display: none;
</a><a href="#h15-3-59" id="h15-3-59" class="i">+    float: right;
</a> }
<b>diff --git a/<a id="h16" href="../file/web/htdocs/assets/js/codesearch.js">web/htdocs/assets/js/codesearch.js</a> b/<a href="../file/web/htdocs/assets/js/codesearch.js">web/htdocs/assets/js/codesearch.js</a></b>
<a href="#h16-0" id="h16-0" class="h">@@ -28,14 +28,7 @@ var Codesearch = function() {
</a>       if (&#39;backend&#39; in opts) {
         url = url + opts.backend;
       }
<a href="#h16-0-3" id="h16-0-3" class="d">-      var q = {};
</a><a href="#h16-0-4" id="h16-0-4" class="d">-
</a><a href="#h16-0-5" id="h16-0-5" class="d">-      [&#39;line&#39;,&#39;file&#39;, &#39;repo&#39;, &#39;fold_case&#39;].forEach(function (key) {
</a><a href="#h16-0-6" id="h16-0-6" class="d">-        if(opts[key])
</a><a href="#h16-0-7" id="h16-0-7" class="d">-          q[key] = opts[key];
</a><a href="#h16-0-8" id="h16-0-8" class="d">-      });
</a><a href="#h16-0-9" id="h16-0-9" class="d">-      if (q.fold_case !== true)
</a><a href="#h16-0-10" id="h16-0-10" class="d">-        delete q.fold_case;
</a><a href="#h16-0-11" id="h16-0-11" class="i">+      var q = {q: opts.q};
</a> 
       url = url + &quot;?&quot; + $.param(q);
 
<b>diff --git a/<a id="h17" href="../file/web/htdocs/assets/js/codesearch_ui.js">web/htdocs/assets/js/codesearch_ui.js</a> b/<a href="../file/web/htdocs/assets/js/codesearch_ui.js">web/htdocs/assets/js/codesearch_ui.js</a></b>
<a href="#h17-0" id="h17-0" class="h">@@ -164,23 +164,15 @@ var SearchState = Backbone.Model.extend({
</a>   dispatch: function (search) {
     var cur = this.search_map[this.get(&#39;displaying&#39;)];
     if (cur &amp;&amp;
<a href="#h17-0-3" id="h17-0-3" class="d">-        cur.q === search.line &amp;&amp;
</a><a href="#h17-0-4" id="h17-0-4" class="d">-        cur.file === search.file &amp;&amp;
</a><a href="#h17-0-5" id="h17-0-5" class="d">-        cur.backend === search.backend &amp;&amp;
</a><a href="#h17-0-6" id="h17-0-6" class="d">-        cur.repo === search.repo &amp;&amp;
</a><a href="#h17-0-7" id="h17-0-7" class="d">-        cur.fold_case === search.fold_case) {
</a><a href="#h17-0-8" id="h17-0-8" class="i">+        cur.q === search.q) {
</a>       return false;
     }
     var id = this.next_id();
     search.id = id;
     this.search_map[id] = {
<a href="#h17-0-14" id="h17-0-14" class="d">-      q: search.line,
</a><a href="#h17-0-15" id="h17-0-15" class="d">-      file: search.file,
</a><a href="#h17-0-16" id="h17-0-16" class="d">-      backend: search.backend,
</a><a href="#h17-0-17" id="h17-0-17" class="d">-      repo: search.repo,
</a><a href="#h17-0-18" id="h17-0-18" class="d">-      fold_case: search.fold_case
</a><a href="#h17-0-19" id="h17-0-19" class="i">+      q: search.q,
</a>     };
<a href="#h17-0-21" id="h17-0-21" class="d">-    if (!search.line.length) {
</a><a href="#h17-0-22" id="h17-0-22" class="i">+    if (!search.q.length) {
</a>       this.set(&#39;displaying&#39;, id);
       return false;
     }
<a href="#h17-1" id="h17-1" class="h">@@ -194,13 +186,10 @@ var SearchState = Backbone.Model.extend({
</a>       return &#39;/search&#39;;
     var base = &#39;/search&#39;;
 
<a href="#h17-1-3" id="h17-1-3" class="d">-    [&#39;q&#39;,&#39;file&#39;, &#39;repo&#39;, &#39;fold_case&#39;].forEach(function (key) {
</a><a href="#h17-1-4" id="h17-1-4" class="d">-      if(current[key])
</a><a href="#h17-1-5" id="h17-1-5" class="d">-        q[key] = current[key];
</a><a href="#h17-1-6" id="h17-1-6" class="d">-    });
</a><a href="#h17-1-7" id="h17-1-7" class="i">+    q.q = current.q;
</a> 
<a href="#h17-1-9" id="h17-1-9" class="d">-    if (q.backend) {
</a><a href="#h17-1-10" id="h17-1-10" class="d">-      base += &quot;/&quot; + q.backend
</a><a href="#h17-1-11" id="h17-1-11" class="i">+    if (current.backend) {
</a><a href="#h17-1-12" id="h17-1-12" class="i">+      base += &quot;/&quot; + current.backend
</a>     } else if (CodesearchUI.input_backend) {
       base += &quot;/&quot; + CodesearchUI.input_backend.val();
     }
<a href="#h17-2" id="h17-2" class="h">@@ -312,21 +301,13 @@ var CodesearchUI = function() {
</a>       CodesearchUI.view = new ResultView({model: CodesearchUI.state});
 
       CodesearchUI.input      = $(&#39;#searchbox&#39;);
<a href="#h17-2-3" id="h17-2-3" class="d">-      CodesearchUI.input_file = $(&#39;#filebox&#39;);
</a><a href="#h17-2-4" id="h17-2-4" class="d">-      CodesearchUI.input_repo = $(&#39;#repobox&#39;);
</a><a href="#h17-2-5" id="h17-2-5" class="d">-      CodesearchUI.input_fold_case = $(&#39;#fold-case&#39;);
</a>       CodesearchUI.input_backend = $(&#39;#backend&#39;);
       if (CodesearchUI.input_backend.length == 0)
         CodesearchUI.input_backend = null;
       CodesearchUI.parse_url();
 
       CodesearchUI.input.keydown(CodesearchUI.keypress);
<a href="#h17-2-12" id="h17-2-12" class="d">-      CodesearchUI.input_file.keydown(CodesearchUI.keypress);
</a><a href="#h17-2-13" id="h17-2-13" class="d">-      CodesearchUI.input_repo.keydown(CodesearchUI.keypress);
</a>       CodesearchUI.input.bind(&#39;paste&#39;, CodesearchUI.keypress);
<a href="#h17-2-15" id="h17-2-15" class="d">-      CodesearchUI.input_file.bind(&#39;paste&#39;, CodesearchUI.keypress);
</a><a href="#h17-2-16" id="h17-2-16" class="d">-      CodesearchUI.input_repo.bind(&#39;paste&#39;, CodesearchUI.keypress);
</a><a href="#h17-2-17" id="h17-2-17" class="d">-      CodesearchUI.input_fold_case.bind(&#39;click&#39;, CodesearchUI.keypress);
</a>       CodesearchUI.input.focus();
       if (CodesearchUI.input_backend)
         CodesearchUI.input_backend.change(CodesearchUI.select_backend);
<a href="#h17-3" id="h17-3" class="h">@@ -335,14 +316,20 @@ var CodesearchUI = function() {
</a>     },
     parse_url: function() {
       var parms = CodesearchUI.parse_query_params();
<a href="#h17-3-3" id="h17-3-3" class="d">-      if (parms.q)
</a><a href="#h17-3-4" id="h17-3-4" class="d">-        CodesearchUI.input.val(parms.q);
</a><a href="#h17-3-5" id="h17-3-5" class="i">+      var q = []
</a><a href="#h17-3-6" id="h17-3-6" class="i">+      if (parms.q) {
</a><a href="#h17-3-7" id="h17-3-7" class="i">+        if (parms.fold_case === &#39;true&#39;)
</a><a href="#h17-3-8" id="h17-3-8" class="i">+          q.push(&#39;case:&#39; + parms.q);
</a><a href="#h17-3-9" id="h17-3-9" class="i">+        else
</a><a href="#h17-3-10" id="h17-3-10" class="i">+          q.push(parms.q);
</a><a href="#h17-3-11" id="h17-3-11" class="i">+      }
</a>       if (parms.file)
<a href="#h17-3-13" id="h17-3-13" class="d">-        CodesearchUI.input_file.val(parms.file);
</a><a href="#h17-3-14" id="h17-3-14" class="i">+        q.push(&quot;file:&quot; + parms.file)
</a>       if (parms.repo)
<a href="#h17-3-16" id="h17-3-16" class="d">-        CodesearchUI.input_repo.val(parms.repo);
</a><a href="#h17-3-17" id="h17-3-17" class="d">-      if (parms.fold_case === &#39;true&#39;)
</a><a href="#h17-3-18" id="h17-3-18" class="d">-        CodesearchUI.input_fold_case.attr(&#39;checked&#39;, true);
</a><a href="#h17-3-19" id="h17-3-19" class="i">+        q.push(&quot;repo:&quot; + parms.repo)
</a><a href="#h17-3-20" id="h17-3-20" class="i">+
</a><a href="#h17-3-21" id="h17-3-21" class="i">+      CodesearchUI.input.val(q.join(&#39; &#39;));
</a><a href="#h17-3-22" id="h17-3-22" class="i">+
</a>       var backend = null;
       if (parms.backend)
         backend = parms.backend;
<a href="#h17-4" id="h17-4" class="h">@@ -373,12 +360,6 @@ var CodesearchUI = function() {
</a>       if (!CodesearchUI.input_backend)
         return;
       var backend = CodesearchUI.input_backend.val();
<a href="#h17-4-3" id="h17-4-3" class="d">-      if (Object.keys(CodesearchUI.github_repos[backend]).length == 1) {
</a><a href="#h17-4-4" id="h17-4-4" class="d">-        CodesearchUI.input_repo.val(&#39;&#39;);
</a><a href="#h17-4-5" id="h17-4-5" class="d">-        $(&#39;#reposel&#39;).hide();
</a><a href="#h17-4-6" id="h17-4-6" class="d">-      } else {
</a><a href="#h17-4-7" id="h17-4-7" class="d">-        $(&#39;#reposel&#39;).show();
</a><a href="#h17-4-8" id="h17-4-8" class="d">-      }
</a>       CodesearchUI.keypress();
     },
     keypress: function() {
<a href="#h17-5" id="h17-5" class="h">@@ -388,10 +369,7 @@ var CodesearchUI = function() {
</a>     newsearch: function() {
       CodesearchUI.clear_timer();
       var search = {
<a href="#h17-5-3" id="h17-5-3" class="d">-        line: CodesearchUI.input.val(),
</a><a href="#h17-5-4" id="h17-5-4" class="d">-        file: CodesearchUI.input_file.val(),
</a><a href="#h17-5-5" id="h17-5-5" class="d">-        repo: CodesearchUI.input_repo.val(),
</a><a href="#h17-5-6" id="h17-5-6" class="d">-        fold_case: !!CodesearchUI.input_fold_case.attr(&#39;checked&#39;)
</a><a href="#h17-5-7" id="h17-5-7" class="i">+        q: CodesearchUI.input.val(),
</a>       };
       if (CodesearchUI.input_backend)
         search.backend = CodesearchUI.input_backend.val();
<b>diff --git a/<a id="h18" href="../file/web/templates/about.html">web/templates/about.html</a> b/<a href="../file/web/templates/about.html">web/templates/about.html</a></b>
<a href="#h18-0" id="h18-0" class="h">@@ -5,16 +5,15 @@
</a>     href=&quot;http://google.com/codesearch&quot;&gt;Google Codesearch.&lt;/a&gt;
   &lt;/p&gt;
   &lt;p&gt;
<a href="#h18-0-3" id="h18-0-3" class="d">-    live-grep uses Russ Cox&#39;s excellent &lt;a
</a><a href="#h18-0-4" id="h18-0-4" class="i">+    livegrep uses Russ Cox&#39;s excellent &lt;a
</a>     href=&quot;http://code.google.com/p/re2/&quot;&gt;RE2&lt;/a&gt; regular expression
     library, underneath a custom indexing and searching backend
     written in C++ with pthreads. The frontend is implemented in &lt;a
     href=&quot;http://golang.org/&quot;&gt;Go&lt;/a&gt;.
   &lt;/p&gt;
   &lt;p&gt;
<a href="#h18-0-11" id="h18-0-11" class="d">-    livegrep has been tested on recent Chrome and Firefox, as well as
</a><a href="#h18-0-12" id="h18-0-12" class="d">-    IE8 and 9. I have reports of it working in recent Safari, as
</a><a href="#h18-0-13" id="h18-0-13" class="d">-    well. Bug reports are appreciated, either via the &quot;feedback&quot;
</a><a href="#h18-0-14" id="h18-0-14" class="d">-    button above, or via &lt;a href=&quot;mailto:feedback@livegrep.com&quot;&gt;email&lt;/a&gt;.
</a><a href="#h18-0-15" id="h18-0-15" class="i">+    livegrep is written and run by &lt;a
</a><a href="#h18-0-16" id="h18-0-16" class="i">+    href=&quot;https://nelhage.com/&quot;&gt;Nelson Elhage&lt;/a&gt; and is &lt;a
</a><a href="#h18-0-17" id="h18-0-17" class="i">+    href=&quot;https://github.com/livegrep/livegrep&quot;&gt;open source&lt;/a&gt;.
</a>   &lt;/p&gt;
 &lt;/div&gt;
<b>diff --git a/<a id="h19" href="../file/web/templates/help.html">web/templates/help.html</a> b/<a href="../file/web/templates/help.html">web/templates/help.html</a></b>
<a href="#h19-0" id="h19-0" class="h">@@ -0,0 +1,68 @@
</a><a href="#h19-0-0" id="h19-0-0" class="i">+&lt;div id=&#39;searcharea&#39;&gt;
</a><a href="#h19-0-1" id="h19-0-1" class="i">+  &lt;p&gt;
</a><a href="#h19-0-2" id="h19-0-2" class="i">+    Search over source code by typing a regular expression into the
</a><a href="#h19-0-3" id="h19-0-3" class="i">+    query box. Searches are case-insensitive by default:
</a><a href="#h19-0-4" id="h19-0-4" class="i">+  &lt;/p&gt;
</a><a href="#h19-0-5" id="h19-0-5" class="i">+  &lt;div class=&#39;example&#39;&gt;
</a><a href="#h19-0-6" id="h19-0-6" class="i">+    &lt;span class=&#39;query&#39;&gt;
</a><a href="#h19-0-7" id="h19-0-7" class="i">+      hello,?\sworld
</a><a href="#h19-0-8" id="h19-0-8" class="i">+    &lt;/span&gt;
</a><a href="#h19-0-9" id="h19-0-9" class="i">+    &lt;span class=&#39;link&#39;&gt;
</a><a href="#h19-0-10" id="h19-0-10" class="i">+      &lt;a href=&quot;/search/?q=hello,?\sworld&quot;&gt;
</a><a href="#h19-0-11" id="h19-0-11" class="i">+        try it
</a><a href="#h19-0-12" id="h19-0-12" class="i">+      &lt;/a&gt;
</a><a href="#h19-0-13" id="h19-0-13" class="i">+    &lt;/span&gt;
</a><a href="#h19-0-14" id="h19-0-14" class="i">+  &lt;/div&gt;
</a><a href="#h19-0-15" id="h19-0-15" class="i">+
</a><a href="#h19-0-16" id="h19-0-16" class="i">+  &lt;p&gt;
</a><a href="#h19-0-17" id="h19-0-17" class="i">+    Queries containing capital letters are matched case-sensitively:
</a><a href="#h19-0-18" id="h19-0-18" class="i">+  &lt;/p&gt;
</a><a href="#h19-0-19" id="h19-0-19" class="i">+
</a><a href="#h19-0-20" id="h19-0-20" class="i">+  &lt;div class=&#39;example&#39;&gt;
</a><a href="#h19-0-21" id="h19-0-21" class="i">+    &lt;span class=&#39;query&#39;&gt;
</a><a href="#h19-0-22" id="h19-0-22" class="i">+      Hello
</a><a href="#h19-0-23" id="h19-0-23" class="i">+    &lt;/span&gt;
</a><a href="#h19-0-24" id="h19-0-24" class="i">+    &lt;span class=&#39;link&#39;&gt;
</a><a href="#h19-0-25" id="h19-0-25" class="i">+      &lt;a href=&quot;/search/?q=Hello&quot;&gt;
</a><a href="#h19-0-26" id="h19-0-26" class="i">+        try it
</a><a href="#h19-0-27" id="h19-0-27" class="i">+      &lt;/a&gt;
</a><a href="#h19-0-28" id="h19-0-28" class="i">+    &lt;/span&gt;
</a><a href="#h19-0-29" id="h19-0-29" class="i">+  &lt;/div&gt;
</a><a href="#h19-0-30" id="h19-0-30" class="i">+
</a><a href="#h19-0-31" id="h19-0-31" class="i">+  &lt;p&gt;
</a><a href="#h19-0-32" id="h19-0-32" class="i">+    Restrict matches to specific files using a &lt;span
</a><a href="#h19-0-33" id="h19-0-33" class="i">+    class=&#39;query&#39;&gt;file:&lt;/span&gt; modifier:
</a><a href="#h19-0-34" id="h19-0-34" class="i">+  &lt;/p&gt;
</a><a href="#h19-0-35" id="h19-0-35" class="i">+
</a><a href="#h19-0-36" id="h19-0-36" class="i">+  &lt;div class=&#39;example&#39;&gt;
</a><a href="#h19-0-37" id="h19-0-37" class="i">+    &lt;span class=&#39;query&#39;&gt;
</a><a href="#h19-0-38" id="h19-0-38" class="i">+      exit file:\.c$
</a><a href="#h19-0-39" id="h19-0-39" class="i">+    &lt;/span&gt;
</a><a href="#h19-0-40" id="h19-0-40" class="i">+    &lt;span class=&#39;link&#39;&gt;
</a><a href="#h19-0-41" id="h19-0-41" class="i">+      &lt;a href=&quot;/search/?q=exit+file:\.c$&quot;&gt;
</a><a href="#h19-0-42" id="h19-0-42" class="i">+        try it
</a><a href="#h19-0-43" id="h19-0-43" class="i">+      &lt;/a&gt;
</a><a href="#h19-0-44" id="h19-0-44" class="i">+    &lt;/span&gt;
</a><a href="#h19-0-45" id="h19-0-45" class="i">+  &lt;/div&gt;
</a><a href="#h19-0-46" id="h19-0-46" class="i">+
</a><a href="#h19-0-47" id="h19-0-47" class="i">+  {{ if .SampleRepo }}
</a><a href="#h19-0-48" id="h19-0-48" class="i">+  &lt;p&gt;
</a><a href="#h19-0-49" id="h19-0-49" class="i">+    Restrict matches to specific repositories via &lt;span
</a><a href="#h19-0-50" id="h19-0-50" class="i">+    class=&#39;query&#39;&gt;repo:&lt;/span&gt;
</a><a href="#h19-0-51" id="h19-0-51" class="i">+  &lt;/p&gt;
</a><a href="#h19-0-52" id="h19-0-52" class="i">+
</a><a href="#h19-0-53" id="h19-0-53" class="i">+  &lt;div class=&#39;example&#39;&gt;
</a><a href="#h19-0-54" id="h19-0-54" class="i">+    &lt;span class=&#39;query&#39;&gt;
</a><a href="#h19-0-55" id="h19-0-55" class="i">+      fail repo:{{.SampleRepo}}
</a><a href="#h19-0-56" id="h19-0-56" class="i">+    &lt;/span&gt;
</a><a href="#h19-0-57" id="h19-0-57" class="i">+    &lt;span class=&#39;link&#39;&gt;
</a><a href="#h19-0-58" id="h19-0-58" class="i">+      &lt;a href=&quot;/search/?q=exit+repo:{{.SampleRepo}}&quot;&gt;
</a><a href="#h19-0-59" id="h19-0-59" class="i">+        try it
</a><a href="#h19-0-60" id="h19-0-60" class="i">+      &lt;/a&gt;
</a><a href="#h19-0-61" id="h19-0-61" class="i">+    &lt;/span&gt;
</a><a href="#h19-0-62" id="h19-0-62" class="i">+  &lt;/div&gt;
</a><a href="#h19-0-63" id="h19-0-63" class="i">+  {{ end }}
</a><a href="#h19-0-64" id="h19-0-64" class="i">+
</a><a href="#h19-0-65" id="h19-0-65" class="i">+  &lt;p&gt;
</a><a href="#h19-0-66" id="h19-0-66" class="i">+  &lt;/p&gt;
</a><a href="#h19-0-67" id="h19-0-67" class="i">+&lt;/div&gt;
</a><b>diff --git a/<a id="h20" href="../file/web/templates/index.html">web/templates/index.html</a> b/<a href="../file/web/templates/index.html">web/templates/index.html</a></b>
<a href="#h20-0" id="h20-0" class="h">@@ -2,47 +2,36 @@
</a>   $(function(){CodesearchUI.github_repos = {{.GithubRepos}};});
 &lt;/script&gt;
 &lt;div id=&#39;searcharea&#39;&gt;
<a href="#h20-0-3" id="h20-0-3" class="d">-  &lt;table id=&#39;searchinput&#39;&gt;
</a><a href="#h20-0-4" id="h20-0-4" class="d">-    &lt;tr&gt;
</a><a href="#h20-0-5" id="h20-0-5" class="d">-      &lt;td&gt;&lt;span class=&#39;label&#39;&gt;regex:&lt;/span&gt;&lt;/td&gt;
</a><a href="#h20-0-6" id="h20-0-6" class="d">-      &lt;td&gt;&lt;input type=&quot;text&quot; id=&#39;searchbox&#39;&gt;&lt;/input&gt;&lt;/td&gt;
</a><a href="#h20-0-7" id="h20-0-7" class="d">-    &lt;/tr&gt;
</a><a href="#h20-0-8" id="h20-0-8" class="d">-    &lt;tr&gt;
</a><a href="#h20-0-9" id="h20-0-9" class="d">-      &lt;td&gt;&lt;span class=&#39;label&#39;&gt;path:&lt;/span&gt;&lt;/td&gt;
</a><a href="#h20-0-10" id="h20-0-10" class="d">-      &lt;td&gt;&lt;input type=&quot;text&quot; id=&#39;filebox&#39;&gt;&lt;/input&gt;&lt;/td&gt;
</a><a href="#h20-0-11" id="h20-0-11" class="d">-    &lt;/tr&gt;
</a><a href="#h20-0-12" id="h20-0-12" class="d">-    &lt;tr id=&#39;reposel&#39;&gt;
</a><a href="#h20-0-13" id="h20-0-13" class="d">-      &lt;td&gt;&lt;span class=&#39;label&#39;&gt;repository:&lt;/span&gt;&lt;/td&gt;
</a><a href="#h20-0-14" id="h20-0-14" class="d">-      &lt;td&gt;&lt;input type=&quot;text&quot; id=&#39;repobox&#39;&gt;&lt;/input&gt;&lt;/td&gt;
</a><a href="#h20-0-15" id="h20-0-15" class="d">-    &lt;/tr&gt;
</a><a href="#h20-0-16" id="h20-0-16" class="d">-  &lt;/table&gt;
</a><a href="#h20-0-17" id="h20-0-17" class="d">-  &lt;div id=&#39;errorbox&#39;&gt;
</a><a href="#h20-0-18" id="h20-0-18" class="d">-    {{if gt (.Backends | len) 1 }}
</a><a href="#h20-0-19" id="h20-0-19" class="d">-    &lt;div class=&#39;what&#39;&gt; Search:
</a><a href="#h20-0-20" id="h20-0-20" class="d">-    &lt;select id=&#39;backend&#39;&gt;
</a><a href="#h20-0-21" id="h20-0-21" class="d">-    {{range .Backends}}
</a><a href="#h20-0-22" id="h20-0-22" class="d">-     &lt;option value=&quot;{{.Id}}&quot;&gt;{{.I.Name}}&lt;/option&gt;
</a><a href="#h20-0-23" id="h20-0-23" class="d">-    {{end}}
</a><a href="#h20-0-24" id="h20-0-24" class="d">-    &lt;/select&gt;
</a><a href="#h20-0-25" id="h20-0-25" class="i">+  &lt;div id=&#39;searchinput&#39;&gt;
</a><a href="#h20-0-26" id="h20-0-26" class="i">+    &lt;div class=&#39;querybox&#39;&gt;
</a><a href="#h20-0-27" id="h20-0-27" class="i">+    &lt;span class=&#39;label&#39;&gt;query:&lt;/span&gt;
</a><a href="#h20-0-28" id="h20-0-28" class="i">+    &lt;input type=&quot;text&quot; id=&#39;searchbox&#39;&gt;&lt;/input&gt;
</a><a href="#h20-0-29" id="h20-0-29" class="i">+    &lt;span class=&#39;help&#39;&gt;&lt;a href=&quot;/help&quot; target=&quot;_blank&quot;&gt;help&lt;/a&gt;&lt;/span&gt;
</a>     &lt;/div&gt;
<a href="#h20-0-31" id="h20-0-31" class="d">-    {{else}}
</a><a href="#h20-0-32" id="h20-0-32" class="d">-    {{with index .Backends 0}}
</a><a href="#h20-0-33" id="h20-0-33" class="d">-    &lt;div class=&#39;what&#39;&gt; Now searching: {{ .I.Name }}&lt;/div&gt;
</a><a href="#h20-0-34" id="h20-0-34" class="d">-    &lt;select id=&#39;backend&#39; style=&#39;display: none;&#39;&gt;
</a><a href="#h20-0-35" id="h20-0-35" class="d">-      &lt;option value=&quot;{{.Id}}&quot;&gt;{{.I.Name}}&lt;/option&gt;
</a><a href="#h20-0-36" id="h20-0-36" class="d">-    &lt;/select&gt;
</a><a href="#h20-0-37" id="h20-0-37" class="d">-    {{end}}
</a><a href="#h20-0-38" id="h20-0-38" class="d">-    {{end}}
</a><a href="#h20-0-39" id="h20-0-39" class="d">-    &lt;div id=&#39;regex-error&#39;&gt;
</a><a href="#h20-0-40" id="h20-0-40" class="d">-      &lt;span class=&#39;label&#39;&gt; Error: &lt;/span&gt;
</a><a href="#h20-0-41" id="h20-0-41" class="d">-      &lt;span id=&#39;errortext&#39;&gt;
</a><a href="#h20-0-42" id="h20-0-42" class="d">-      &lt;/span&gt;
</a><a href="#h20-0-43" id="h20-0-43" class="i">+    &lt;div id=&#39;whatbox&#39;&gt;
</a><a href="#h20-0-44" id="h20-0-44" class="i">+      {{if gt (.Backends | len) 1 }}
</a><a href="#h20-0-45" id="h20-0-45" class="i">+      &lt;div class=&#39;what&#39;&gt; Search:
</a><a href="#h20-0-46" id="h20-0-46" class="i">+      &lt;select id=&#39;backend&#39;&gt;
</a><a href="#h20-0-47" id="h20-0-47" class="i">+        {{range .Backends}}
</a><a href="#h20-0-48" id="h20-0-48" class="i">+        &lt;option value=&quot;{{.Id}}&quot;&gt;{{.I.Name}}&lt;/option&gt;
</a><a href="#h20-0-49" id="h20-0-49" class="i">+        {{end}}
</a><a href="#h20-0-50" id="h20-0-50" class="i">+      &lt;/select&gt;
</a><a href="#h20-0-51" id="h20-0-51" class="i">+      &lt;/div&gt;
</a><a href="#h20-0-52" id="h20-0-52" class="i">+      {{else}}
</a><a href="#h20-0-53" id="h20-0-53" class="i">+      {{with index .Backends 0}}
</a><a href="#h20-0-54" id="h20-0-54" class="i">+      &lt;div class=&#39;what&#39;&gt; Now searching: {{ .I.Name }}&lt;/div&gt;
</a><a href="#h20-0-55" id="h20-0-55" class="i">+      &lt;select id=&#39;backend&#39; style=&#39;display: none;&#39;&gt;
</a><a href="#h20-0-56" id="h20-0-56" class="i">+        &lt;option value=&quot;{{.Id}}&quot;&gt;{{.I.Name}}&lt;/option&gt;
</a><a href="#h20-0-57" id="h20-0-57" class="i">+      &lt;/select&gt;
</a><a href="#h20-0-58" id="h20-0-58" class="i">+      {{end}}
</a><a href="#h20-0-59" id="h20-0-59" class="i">+      {{end}}
</a>     &lt;/div&gt;
<a href="#h20-0-61" id="h20-0-61" class="i">+    &lt;div class=&#39;clear&#39;&gt; &lt;/div&gt;
</a>   &lt;/div&gt;
<a href="#h20-0-63" id="h20-0-63" class="d">-  &lt;div id=&#39;casefold&#39;&gt;
</a><a href="#h20-0-64" id="h20-0-64" class="d">-    &lt;input type=&#39;checkbox&#39; id=&#39;fold-case&#39;&gt;&lt;label for=&#39;fold-case&#39;&gt;ignore case&lt;/label&gt;
</a><a href="#h20-0-65" id="h20-0-65" class="d">-  &lt;/div&gt;
</a><a href="#h20-0-66" id="h20-0-66" class="d">-  &lt;div class=&#39;clear&#39;&gt; &lt;/div&gt;
</a><a href="#h20-0-67" id="h20-0-67" class="i">+  &lt;div id=&#39;regex-error&#39;&gt;
</a><a href="#h20-0-68" id="h20-0-68" class="i">+    &lt;span class=&#39;label&#39;&gt; error: &lt;/span&gt;
</a><a href="#h20-0-69" id="h20-0-69" class="i">+    &lt;span id=&#39;errortext&#39;&gt; &lt;/span&gt;
</a><a href="#h20-0-70" id="h20-0-70" class="i">+    &lt;/div&gt;  
</a> &lt;/div&gt;
 &lt;div id=&#39;resultbox&#39;&gt;
 &lt;div id=&#39;resultarea&#39;&gt;
<b>diff --git a/<a id="h21" href="../file/web/templates/layout.html">web/templates/layout.html</a> b/<a href="../file/web/templates/layout.html">web/templates/layout.html</a></b>
<a href="#h21-0" id="h21-0" class="h">@@ -5,7 +5,6 @@
</a>     &lt;title&gt;code search  {{.Title}}&lt;/title&gt;
     &lt;link rel=&quot;stylesheet&quot; href=&#39;/assets/css/codesearch.css&#39; /&gt;
     &lt;script language=&quot;javascript&quot; type=&quot;text/javascript&quot; src=&quot;/assets/js/3d/jquery.js&quot;&gt;&lt;/script&gt;
<a href="#h21-0-3" id="h21-0-3" class="d">-    {{if .IncludeJS}}
</a>     &lt;script language=&quot;javascript&quot; type=&quot;text/javascript&quot; src=&quot;/assets/js/3d/underscore.js&quot;&gt;&lt;/script&gt;
     &lt;script language=&quot;javascript&quot; type=&quot;text/javascript&quot; src=&quot;/assets/js/3d/backbone.js&quot;&gt;&lt;/script&gt;
     &lt;script language=&quot;javascript&quot; type=&quot;text/javascript&quot; src=&quot;/assets/js/3d/html.js&quot;&gt;&lt;/script&gt;
<a href="#h21-1" id="h21-1" class="h">@@ -17,7 +16,7 @@
</a>       Raven.config({{.Config.Sentry.URI}}, {}).install();
     &lt;/script&gt;
     {{end}}
<a href="#h21-1-3" id="h21-1-3" class="d">-    {{end}}
</a><a href="#h21-1-4" id="h21-1-4" class="i">+
</a>     {{if .Config.GoogleAnalyticsId}}
     &lt;script type=&quot;text/javascript&quot;&gt;
     
<a href="#h21-2" id="h21-2" class="h">@@ -47,21 +46,6 @@
</a>         &lt;li class=&#39;first&#39;&gt;livegrep is a project by &lt;a href=&quot;http://blog.nelhage.com/&quot;&gt;Nelson Elhage&lt;/a&gt;&lt;/li&gt;
       &lt;/ul&gt;
     &lt;/div&gt;
<a href="#h21-2-3" id="h21-2-3" class="d">-    &lt;div id=&#39;feedback&#39;&gt;
</a><a href="#h21-2-4" id="h21-2-4" class="d">-      &lt;form id=&#39;feedbackform&#39; action=&#39;#&#39;&gt;
</a><a href="#h21-2-5" id="h21-2-5" class="d">-        &lt;div class=&#39;label&#39;&gt;Comments? Questions? Suggestions? &lt;/div&gt;
</a><a href="#h21-2-6" id="h21-2-6" class="d">-        &lt;textarea rows=&#39;10&#39; cols=&#39;40&#39;&gt;&lt;/textarea&gt;
</a><a href="#h21-2-7" id="h21-2-7" class="d">-        &lt;div class=&#39;clear&#39;&gt; &lt;/div&gt;
</a><a href="#h21-2-8" id="h21-2-8" class="d">-        &lt;span class=&#39;label&#39;&gt;Email (if you want a reply):&lt;/span&gt;
</a><a href="#h21-2-9" id="h21-2-9" class="d">-        &lt;input type=&#39;text&#39; class=&#39;email&#39;&gt; &lt;/input&gt;
</a><a href="#h21-2-10" id="h21-2-10" class="d">-        &lt;div class=&#39;clear&#39;&gt; &lt;/div&gt;
</a><a href="#h21-2-11" id="h21-2-11" class="d">-        &lt;span class=&#39;submit&#39;&gt;
</a><a href="#h21-2-12" id="h21-2-12" class="d">-          &lt;span class=&#39;result&#39;&gt; &lt;/span&gt;
</a><a href="#h21-2-13" id="h21-2-13" class="d">-          &lt;img class=&#39;spinner&#39; src=&#39;/assets/img/ajax-loader.gif&#39; alt=&#39;&#39;&gt; &lt;/img&gt;
</a><a href="#h21-2-14" id="h21-2-14" class="d">-          &lt;button&gt;Send It&lt;/button&gt;
</a><a href="#h21-2-15" id="h21-2-15" class="d">-        &lt;/span&gt;
</a><a href="#h21-2-16" id="h21-2-16" class="d">-      &lt;/form&gt;
</a><a href="#h21-2-17" id="h21-2-17" class="d">-    &lt;/div&gt;
</a>     {{ .Body}}
   &lt;/body&gt;
 &lt;/html&gt;
</pre>
</div>
</body>
</html>
