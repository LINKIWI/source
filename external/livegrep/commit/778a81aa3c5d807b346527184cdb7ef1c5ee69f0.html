<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Merge remote-tracking branch &#39;upstream/main&#39; - livegrep - Fast, regular expression code search service</title>
<meta name="description" content="Fast, regular expression code search service" />
<meta name="author" content="Kevin Lin" />
<link rel="icon" type="image/png" href="https://static.kevinlin.info/favicon.png" />
<link rel="alternate" type="application/atom+xml" title="livegrep Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="livegrep Atom Feed (tags)" href="../tags.xml" />
<style type="text/css">
body{color:#000;background-color:#fff;font-family:monospace}h1,h2,h3,h4,h5,h6{font-size:1em;margin:0}img,h1,h2{vertical-align:middle}img{border:0}a:target{background-color:#ccc}a.d,a.h,a.i{text-decoration:none}a.line{text-decoration:none;user-select:none}#blob a{color:#555}#blob a:hover{color:blue;text-decoration:none}table thead td{font-weight:bold}table td{padding:0 .4em}table td pre{margin:0}#content table td{vertical-align:top;white-space:nowrap}#branches tr:hover td,#tags tr:hover td,#index tr:hover td,#log tr:hover td,#files tr:hover td{background-color:#eee}#index tr td:nth-child(2),#tags tr td:nth-child(3),#branches tr td:nth-child(3),#log tr td:nth-child(2){white-space:normal}td.num{text-align:right}.desc{color:#555}hr{border:0;border-top:1px solid #555;height:1px}pre{font-family:monospace}pre a.h{color:#00a}.A,span.i,pre a.i{color:#070}.D,span.d,pre a.d{color:#e00}pre a.h:hover,pre a.i:hover,pre a.d:hover{text-decoration:none}
</style>
</head>
<body>
<table><tr><td><a href="/"><img src="https://static.kevinlin.info/favicon.png" alt="" width="32" height="32" /></a></td><td><h1>livegrep</h1><span class="desc">Fast, regular expression code search service</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://source.static.kevinlin.info/external/livegrep.git">https://source.static.kevinlin.info/external/livegrep.git</a></td></tr><tr><td></td><td>
<a href="../log">Log</a> | <a href="../files">Files</a> | <a href="../refs">Refs</a> | <a href="../file/README.md">README</a> | <a href="../file/COPYING">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/778a81aa3c5d807b346527184cdb7ef1c5ee69f0">778a81aa3c5d807b346527184cdb7ef1c5ee69f0</a>
<b>parent</b> <a href="../commit/46084c2c66ba1ead9a9d564965118e0eceae45fb">46084c2c66ba1ead9a9d564965118e0eceae45fb</a>
<b>Author:</b> Kevin Lin &lt;<a href="mailto:developer@kevinlin.info">developer@kevinlin.info</a>&gt;
<b>Date:</b>   Thu  3 Feb 2022 19:52:40 -0800

Merge remote-tracking branch &#39;upstream/main&#39;

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">.bazelrc.ci</a></td><td> | </td><td class="num">31</td><td><span class="i">+++++++++++++++++++++++++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">.bazelversion</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">.github/workflows/ci.yaml</a></td><td> | </td><td class="num">102</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">-----------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">WORKSPACE</a></td><td> | </td><td class="num">23</td><td><span class="i">++++++++</span><span class="d">---------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">cmd/livegrep-fetch-reindex/main.go</a></td><td> | </td><td class="num">9</td><td><span class="i">++++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">cmd/livegrep-github-reindex/main.go</a></td><td> | </td><td class="num">160</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">--------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h6">docker/base/Dockerfile</a></td><td> | </td><td class="num">9</td><td><span class="i">+++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h7">docker/indexer/Dockerfile</a></td><td> | </td><td class="num">3</td><td><span class="i">+++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h8">docker/nginx/Dockerfile</a></td><td> | </td><td class="num">8</td><td><span class="i">++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h9">docker/nginx/nginx.conf</a></td><td> | </td><td class="num">71</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h10">package.sh</a></td><td> | </td><td class="num">3</td><td><span class="i">+++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h11">server/fileview.go</a></td><td> | </td><td class="num">1</td><td><span class="i">+</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h12">src/BUILD</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h13">src/tools/codesearch.cc</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
</table></pre><pre>14 files changed, 329 insertions(+), 97 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/.bazelrc.ci">.bazelrc.ci</a> b/<a href="../file/.bazelrc.ci">.bazelrc.ci</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -1,7 +1,30 @@
</a><a href="#h0-0-0" id="h0-0-0" class="d">-# This is from Bazel&#39;s former travis setup, to avoid blowing up the RAM usage.
</a><a href="#h0-0-1" id="h0-0-1" class="d">-startup --host_jvm_args=-Xms512m
</a><a href="#h0-0-2" id="h0-0-2" class="d">-startup --host_jvm_args=-Xmx1024m
</a><a href="#h0-0-3" id="h0-0-3" class="d">-build -c opt
</a><a href="#h0-0-4" id="h0-0-4" class="i">+startup --host_jvm_args=-Dbazel.DigestFunction=sha256
</a><a href="#h0-0-5" id="h0-0-5" class="i">+
</a><a href="#h0-0-6" id="h0-0-6" class="i">+# Ensure sandboxing is on to increase hermeticity.
</a><a href="#h0-0-7" id="h0-0-7" class="i">+build --spawn_strategy=sandboxed
</a><a href="#h0-0-8" id="h0-0-8" class="i">+
</a><a href="#h0-0-9" id="h0-0-9" class="i">+build --compilation_mode=opt
</a> 
 # This is so we understand failures better
 build --verbose_failures
<a href="#h0-0-13" id="h0-0-13" class="i">+build --worker_verbose
</a><a href="#h0-0-14" id="h0-0-14" class="i">+test --test_output=errors
</a><a href="#h0-0-15" id="h0-0-15" class="i">+test --test_verbose_timeout_warnings
</a><a href="#h0-0-16" id="h0-0-16" class="i">+
</a><a href="#h0-0-17" id="h0-0-17" class="i">+# Use BuildBuddy (anonymously for now) to build
</a><a href="#h0-0-18" id="h0-0-18" class="i">+# I tried a GCS cache, but I think we were hitting up against
</a><a href="#h0-0-19" id="h0-0-19" class="i">+# GH Actions API Request limit (10,000 per hour), since the GCS
</a><a href="#h0-0-20" id="h0-0-20" class="i">+# cache is HTTP based, and seeding the cache (building with an empty 
</a><a href="#h0-0-21" id="h0-0-21" class="i">+# cache) will write ~18k objects - 
</a><a href="#h0-0-22" id="h0-0-22" class="i">+# each which is theoretically an HTTP PUT call. BuildBuddy otoh uses
</a><a href="#h0-0-23" id="h0-0-23" class="i">+# GRPC, so a single connection/API call can be used to stream many writes
</a><a href="#h0-0-24" id="h0-0-24" class="i">+build --bes_results_url=https://app.buildbuddy.io/invocation/
</a><a href="#h0-0-25" id="h0-0-25" class="i">+build --bes_backend=grpcs://cloud.buildbuddy.io
</a><a href="#h0-0-26" id="h0-0-26" class="i">+build --remote_cache=grpcs://cloud.buildbuddy.io
</a><a href="#h0-0-27" id="h0-0-27" class="i">+build --remote_timeout=3600
</a><a href="#h0-0-28" id="h0-0-28" class="i">+
</a><a href="#h0-0-29" id="h0-0-29" class="i">+# don&#39;t fail if the cache is unavailable
</a><a href="#h0-0-30" id="h0-0-30" class="i">+common --remote_local_fallback=true
</a><a href="#h0-0-31" id="h0-0-31" class="i">+# remote upload defaults to true, which we don&#39;t want. We use sed to switch
</a><a href="#h0-0-32" id="h0-0-32" class="i">+# false to true during the CI build if necessary
</a><a href="#h0-0-33" id="h0-0-33" class="i">+common --remote_upload_local_results=false
</a><b>diff --git a/<a id="h1" href="../file/.bazelversion">.bazelversion</a> b/<a href="../file/.bazelversion">.bazelversion</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -1 +1 @@
</a><a href="#h1-0-0" id="h1-0-0" class="d">-4.2.1
</a><a href="#h1-0-1" id="h1-0-1" class="i">+5.0.0
</a><b>diff --git a/<a id="h2" href="../file/.github/workflows/ci.yaml">.github/workflows/ci.yaml</a> b/<a href="../file/.github/workflows/ci.yaml">.github/workflows/ci.yaml</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -1,34 +1,48 @@
</a> on:
<a href="#h2-0-1" id="h2-0-1" class="d">-  pull_request: {}
</a><a href="#h2-0-2" id="h2-0-2" class="i">+  pull_request:
</a><a href="#h2-0-3" id="h2-0-3" class="i">+    branches:
</a><a href="#h2-0-4" id="h2-0-4" class="i">+      - main
</a>   push:
     branches:
       - main
<a href="#h2-0-8" id="h2-0-8" class="d">-  schedule:
</a><a href="#h2-0-9" id="h2-0-9" class="d">-    # Run in cron every night to keep the cache warm.
</a><a href="#h2-0-10" id="h2-0-10" class="d">-    # Github prunes caches every 7 days, and I don&#39;t push often
</a><a href="#h2-0-11" id="h2-0-11" class="d">-    # enough to keep our cache from being evicted without this.
</a><a href="#h2-0-12" id="h2-0-12" class="d">-    - cron: &#39;7 6 * * *&#39;
</a> 
 name: Continuous integration
 
<a href="#h2-0-16" id="h2-0-16" class="i">+env:
</a><a href="#h2-0-17" id="h2-0-17" class="i">+  BASE_IMAGE_NAME: livegrep/base
</a><a href="#h2-0-18" id="h2-0-18" class="i">+  INDEXER_IMAGE_NAME: livegrep/indexer
</a><a href="#h2-0-19" id="h2-0-19" class="i">+  NGINX_IMAGE_NAME: livegrep/nginx
</a><a href="#h2-0-20" id="h2-0-20" class="i">+
</a> jobs:
   ci:
     runs-on: ubuntu-20.04
<a href="#h2-0-24" id="h2-0-24" class="d">-    container: us.gcr.io/livegrep/ci:11
</a>     steps:
       - uses: actions/checkout@v2
<a href="#h2-0-27" id="h2-0-27" class="d">-      - uses: actions/cache@v2
</a><a href="#h2-0-28" id="h2-0-28" class="d">-        with:
</a><a href="#h2-0-29" id="h2-0-29" class="d">-          path: ~/.cache/bazel
</a><a href="#h2-0-30" id="h2-0-30" class="d">-          key: ${{runner.os}}-${{hashFiles(&#39;WORKSPACE&#39;)}}
</a><a href="#h2-0-31" id="h2-0-31" class="d">-          restore-keys: |
</a><a href="#h2-0-32" id="h2-0-32" class="d">-            ${{runner.os}}-
</a><a href="#h2-0-33" id="h2-0-33" class="d">-      - name: setup bazel
</a><a href="#h2-0-34" id="h2-0-34" class="i">+      - name: Switch to CI bazelrc
</a><a href="#h2-0-35" id="h2-0-35" class="i">+        run: cp .bazelrc.ci .bazelrc
</a><a href="#h2-0-36" id="h2-0-36" class="i">+      # Credit to the tensorboard repo for the cache configuration step
</a><a href="#h2-0-37" id="h2-0-37" class="i">+      # https://github.com/tensorflow/tensorboard/blob/master/.github/workflows/ci.yml#L58
</a><a href="#h2-0-38" id="h2-0-38" class="i">+      # Plenty of ways to do something similar but I really liked theirs
</a><a href="#h2-0-39" id="h2-0-39" class="i">+      - name: &#39;Configure remote build cache usage&#39;
</a><a href="#h2-0-40" id="h2-0-40" class="i">+        env:
</a><a href="#h2-0-41" id="h2-0-41" class="i">+          EVENT_TYPE: ${{ github.event_name }}
</a>         run: |
<a href="#h2-0-43" id="h2-0-43" class="d">-          cat .bazelrc.ci &gt;&gt; .bazelrc
</a><a href="#h2-0-44" id="h2-0-44" class="d">-      - name: bazel fetch
</a><a href="#h2-0-45" id="h2-0-45" class="i">+          if [ &quot;${EVENT_TYPE}&quot; = pull_request ]; then
</a><a href="#h2-0-46" id="h2-0-46" class="i">+            printf &#39;Using read-only cache (PR build)\n&#39;
</a><a href="#h2-0-47" id="h2-0-47" class="i">+            exit
</a><a href="#h2-0-48" id="h2-0-48" class="i">+          fi
</a><a href="#h2-0-49" id="h2-0-49" class="i">+          printf &#39;Using writable cache\n&#39;
</a><a href="#h2-0-50" id="h2-0-50" class="i">+          sed -i &#39;s/common --remote_upload_local_results=false/common --remote_upload_local_results=true/&#39; .bazelrc
</a><a href="#h2-0-51" id="h2-0-51" class="i">+      - name: bazel build
</a><a href="#h2-0-52" id="h2-0-52" class="i">+        id: build
</a>         run: |
<a href="#h2-0-54" id="h2-0-54" class="d">-          bazel fetch //cmd/...
</a><a href="#h2-0-55" id="h2-0-55" class="i">+          bazel build //...
</a><a href="#h2-0-56" id="h2-0-56" class="i">+          echo &quot;build_output_file_name=$(./package.sh)&quot; &gt;&gt; $GITHUB_ENV
</a><a href="#h2-0-57" id="h2-0-57" class="i">+      - name: bazel test
</a><a href="#h2-0-58" id="h2-0-58" class="i">+        run: bazel test --test_arg=-test.v //...
</a><a href="#h2-0-59" id="h2-0-59" class="i">+        # Run after building so we can use BuildBuddys fetch cache rather than
</a><a href="#h2-0-60" id="h2-0-60" class="i">+        # first calling bazel fetch ourselves. If a Go file ins&#39;t formatted
</a><a href="#h2-0-61" id="h2-0-61" class="i">+        # corectly it will only take an additional minute or so for CI to fail.
</a>       - name: gofmt
         run: |
           gofmt=$(bazel info output_base)/external/go_sdk/bin/gofmt
<a href="#h2-1" id="h2-1" class="h">@@ -38,18 +52,46 @@ jobs:
</a>               echo &quot;$format_errors&quot;
               exit 1
           fi
<a href="#h2-1-3" id="h2-1-3" class="d">-      - name: bazel test
</a><a href="#h2-1-4" id="h2-1-4" class="i">+      - name: upload build output
</a><a href="#h2-1-5" id="h2-1-5" class="i">+        if: ${{ github.event_name == &#39;push&#39; }}
</a><a href="#h2-1-6" id="h2-1-6" class="i">+        uses: actions/upload-artifact@v2
</a><a href="#h2-1-7" id="h2-1-7" class="i">+        with:
</a><a href="#h2-1-8" id="h2-1-8" class="i">+          name: &quot;${{ env.build_output_file_name }}&quot;
</a><a href="#h2-1-9" id="h2-1-9" class="i">+          path: &quot;builds/${{ env.build_output_file_name }}.tgz&quot;
</a><a href="#h2-1-10" id="h2-1-10" class="i">+          retention-days: 1
</a><a href="#h2-1-11" id="h2-1-11" class="i">+      - name: Build images
</a><a href="#h2-1-12" id="h2-1-12" class="i">+        if: ${{ github.event_name == &#39;push&#39; }}
</a>         run: |
<a href="#h2-1-14" id="h2-1-14" class="d">-          bazel test --test_arg=-test.v //...
</a><a href="#h2-1-15" id="h2-1-15" class="d">-          bazel build //...
</a><a href="#h2-1-16" id="h2-1-16" class="d">-      - name: upload to google cloud
</a><a href="#h2-1-17" id="h2-1-17" class="d">-        env:
</a><a href="#h2-1-18" id="h2-1-18" class="d">-          GCLOUD_SERVICE_KEY: ${{ secrets.GCLOUD_SERVICE_KEY }}
</a><a href="#h2-1-19" id="h2-1-19" class="i">+          docker build -t $BASE_IMAGE_NAME --file docker/base/Dockerfile --build-arg &quot;livegrep_version=$build_output_file_name&quot;  .
</a><a href="#h2-1-20" id="h2-1-20" class="i">+          docker build -t $INDEXER_IMAGE_NAME . --file docker/indexer/Dockerfile
</a><a href="#h2-1-21" id="h2-1-21" class="i">+          docker build -t $NGINX_IMAGE_NAME . --file docker/nginx/Dockerfile
</a><a href="#h2-1-22" id="h2-1-22" class="i">+      - name: Push images
</a><a href="#h2-1-23" id="h2-1-23" class="i">+        if: ${{ github.event_name == &#39;push&#39; }}
</a>         run: |
<a href="#h2-1-25" id="h2-1-25" class="d">-          if [ &quot;$GCLOUD_SERVICE_KEY&quot; ]; then
</a><a href="#h2-1-26" id="h2-1-26" class="d">-            echo &quot;$GCLOUD_SERVICE_KEY&quot; | openssl enc -a -A -d &gt; &quot;$HOME/gcloud-service-key.json&quot;
</a><a href="#h2-1-27" id="h2-1-27" class="d">-            /usr/local/google-cloud-sdk/bin/gcloud auth activate-service-account --key-file &quot;${HOME}/gcloud-service-key.json&quot;
</a><a href="#h2-1-28" id="h2-1-28" class="d">-            /usr/local/google-cloud-sdk/bin/gcloud config set project livegrep
</a><a href="#h2-1-29" id="h2-1-29" class="d">-            ./package.sh
</a><a href="#h2-1-30" id="h2-1-30" class="d">-            /usr/local/google-cloud-sdk/bin/gsutil cp -n -a public-read -r builds/ gs://livegrep.appspot.com/
</a><a href="#h2-1-31" id="h2-1-31" class="d">-          fi
</a><a href="#h2-1-32" id="h2-1-32" class="i">+          echo &quot;${{ secrets.GITHUB_TOKEN }}&quot; | docker login ghcr.io -u ${{ github.actor }} --password-stdin
</a><a href="#h2-1-33" id="h2-1-33" class="i">+
</a><a href="#h2-1-34" id="h2-1-34" class="i">+          BASE_IMAGE_ID=ghcr.io/${{ github.repository_owner }}/$BASE_IMAGE_NAME
</a><a href="#h2-1-35" id="h2-1-35" class="i">+          INDEXER_IMAGE_ID=ghcr.io/${{ github.repository_owner }}/$INDEXER_IMAGE_NAME
</a><a href="#h2-1-36" id="h2-1-36" class="i">+          NGINX_IMAGE_ID=ghcr.io/${{ github.repository_owner }}/$NGINX_IMAGE_NAME
</a><a href="#h2-1-37" id="h2-1-37" class="i">+
</a><a href="#h2-1-38" id="h2-1-38" class="i">+          # tag each image with GHCRID:VERSION
</a><a href="#h2-1-39" id="h2-1-39" class="i">+          VERSION=$(git rev-parse HEAD | head -c10)
</a><a href="#h2-1-40" id="h2-1-40" class="i">+          docker tag $BASE_IMAGE_NAME $BASE_IMAGE_ID:$VERSION
</a><a href="#h2-1-41" id="h2-1-41" class="i">+          docker tag $INDEXER_IMAGE_NAME $INDEXER_IMAGE_ID:$VERSION
</a><a href="#h2-1-42" id="h2-1-42" class="i">+          docker tag $NGINX_IMAGE_NAME $NGINX_IMAGE_ID:$VERSION
</a><a href="#h2-1-43" id="h2-1-43" class="i">+
</a><a href="#h2-1-44" id="h2-1-44" class="i">+          # this workflow is running on &quot;main&quot; atm so always tag latest
</a><a href="#h2-1-45" id="h2-1-45" class="i">+          docker tag $BASE_IMAGE_NAME $BASE_IMAGE_ID:latest
</a><a href="#h2-1-46" id="h2-1-46" class="i">+          docker tag $INDEXER_IMAGE_NAME $INDEXER_IMAGE_ID:latest
</a><a href="#h2-1-47" id="h2-1-47" class="i">+          docker tag $NGINX_IMAGE_NAME $NGINX_IMAGE_ID:latest
</a><a href="#h2-1-48" id="h2-1-48" class="i">+
</a><a href="#h2-1-49" id="h2-1-49" class="i">+          docker push $NGINX_IMAGE_ID:$VERSION
</a><a href="#h2-1-50" id="h2-1-50" class="i">+          docker push $BASE_IMAGE_ID:$VERSION
</a><a href="#h2-1-51" id="h2-1-51" class="i">+          docker push $INDEXER_IMAGE_ID:$VERSION
</a><a href="#h2-1-52" id="h2-1-52" class="i">+
</a><a href="#h2-1-53" id="h2-1-53" class="i">+          # it seems like docker doesn&#39;t push all tags for an image, you need to
</a><a href="#h2-1-54" id="h2-1-54" class="i">+          # push each tag as if it were a seperate image -__-
</a><a href="#h2-1-55" id="h2-1-55" class="i">+          echo &quot;Pushing latest images to test&quot;
</a><a href="#h2-1-56" id="h2-1-56" class="i">+          docker push $NGINX_IMAGE_ID:latest
</a><a href="#h2-1-57" id="h2-1-57" class="i">+          docker push $BASE_IMAGE_ID:latest
</a><a href="#h2-1-58" id="h2-1-58" class="i">+          docker push $INDEXER_IMAGE_ID:latest
</a><b>diff --git a/<a id="h3" href="../file/WORKSPACE">WORKSPACE</a> b/<a href="../file/WORKSPACE">WORKSPACE</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -19,13 +19,6 @@ http_archive(
</a> )
 
 git_repository(
<a href="#h3-0-3" id="h3-0-3" class="d">-    name = &quot;com_github_google_re2&quot;,
</a><a href="#h3-0-4" id="h3-0-4" class="d">-    commit = &quot;767de83bb7e4bfe3a2d8aec0ec79f9f1f66da30a&quot;,
</a><a href="#h3-0-5" id="h3-0-5" class="d">-    remote = &quot;https://github.com/google/re2&quot;,
</a><a href="#h3-0-6" id="h3-0-6" class="d">-    shallow_since = &quot;1535650560 +0000&quot;,
</a><a href="#h3-0-7" id="h3-0-7" class="d">-)
</a><a href="#h3-0-8" id="h3-0-8" class="d">-
</a><a href="#h3-0-9" id="h3-0-9" class="d">-git_repository(
</a>     name = &quot;gflags&quot;,
     commit = &quot;e171aa2d15ed9eb17054558e0b3a6a413bb01067&quot;,  # v2.2.2
     remote = &quot;https://github.com/gflags/gflags&quot;,
<a href="#h3-1" id="h3-1" class="h">@@ -52,25 +45,25 @@ boost_deps()
</a> 
 http_archive(
     name = &quot;io_bazel_rules_go&quot;,
<a href="#h3-1-3" id="h3-1-3" class="d">-    sha256 = &quot;2b1641428dff9018f9e85c0384f03ec6c10660d935b750e3fa1492a281a53b0f&quot;,
</a><a href="#h3-1-4" id="h3-1-4" class="i">+    sha256 = &quot;d6b2513456fe2229811da7eb67a444be7785f5323c6708b38d851d2b51e54d83&quot;,
</a>     urls = [
<a href="#h3-1-6" id="h3-1-6" class="d">-        &quot;https://mirror.bazel.build/github.com/bazelbuild/rules_go/releases/download/v0.29.0/rules_go-v0.29.0.zip&quot;,
</a><a href="#h3-1-7" id="h3-1-7" class="d">-        &quot;https://github.com/bazelbuild/rules_go/releases/download/v0.29.0/rules_go-v0.29.0.zip&quot;,
</a><a href="#h3-1-8" id="h3-1-8" class="i">+        &quot;https://mirror.bazel.build/github.com/bazelbuild/rules_go/releases/download/v0.30.0/rules_go-v0.30.0.zip&quot;,
</a><a href="#h3-1-9" id="h3-1-9" class="i">+        &quot;https://github.com/bazelbuild/rules_go/releases/download/v0.30.0/rules_go-v0.30.0.zip&quot;,
</a>     ],
 )
 
 git_repository(
     name = &quot;bazel_gazelle&quot;,
<a href="#h3-1-15" id="h3-1-15" class="d">-    commit = &quot;e9091445339de2ba7c01c3561f751b64a7fab4a5&quot;,  # 0.23.0
</a><a href="#h3-1-16" id="h3-1-16" class="i">+    commit = &quot;3ea1d64d6fe943dac06c341f9a265472bb99acd7&quot;,  # 0.24.0
</a>     remote = &quot;https://github.com/bazelbuild/bazel-gazelle.git&quot;,
<a href="#h3-1-18" id="h3-1-18" class="d">-    shallow_since = &quot;1615234775 -0500&quot;,
</a><a href="#h3-1-19" id="h3-1-19" class="i">+    shallow_since = &quot;1633971621 -0400&quot;,
</a> )
 
 load(&quot;@io_bazel_rules_go//go:deps.bzl&quot;, &quot;go_register_toolchains&quot;, &quot;go_rules_dependencies&quot;)
 
 go_rules_dependencies()
 
<a href="#h3-1-26" id="h3-1-26" class="d">-go_register_toolchains(version = &quot;1.17.3&quot;)
</a><a href="#h3-1-27" id="h3-1-27" class="i">+go_register_toolchains(version = &quot;1.17.6&quot;)
</a> 
 load(&quot;@bazel_gazelle//:deps.bzl&quot;, &quot;gazelle_dependencies&quot;)
 
<a href="#h3-2" id="h3-2" class="h">@@ -93,9 +86,9 @@ http_archive(
</a> 
 git_repository(
     name = &quot;com_github_grpc_grpc&quot;,
<a href="#h3-2-3" id="h3-2-3" class="d">-    commit = &quot;c3438a0c5d7bc499eb31fd4853ca72c771f758a5&quot;,
</a><a href="#h3-2-4" id="h3-2-4" class="i">+    commit = &quot;dc78581af30da834b7b95572f109bf6c708686e0&quot;,
</a>     remote = &quot;https://github.com/grpc/grpc.git&quot;,
<a href="#h3-2-6" id="h3-2-6" class="d">-    shallow_since = &quot;1614894778 -0800&quot;,
</a><a href="#h3-2-7" id="h3-2-7" class="i">+    shallow_since = &quot;1643221474 -0800&quot;
</a> )
 
 load(&quot;@com_github_grpc_grpc//bazel:grpc_deps.bzl&quot;, &quot;grpc_deps&quot;)
<b>diff --git a/<a id="h4" href="../file/cmd/livegrep-fetch-reindex/main.go">cmd/livegrep-fetch-reindex/main.go</a> b/<a href="../file/cmd/livegrep-fetch-reindex/main.go">cmd/livegrep-fetch-reindex/main.go</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -24,10 +24,9 @@ var (
</a> 	flagRevparse      = flag.Bool(&quot;revparse&quot;, true, &quot;whether to `git rev-parse` the provided revision in generated links&quot;)
 	flagSkipMissing   = flag.Bool(&quot;skip-missing&quot;, false, &quot;skip repositories where the specified revision is missing&quot;)
 	flagReloadBackend = flag.String(&quot;reload-backend&quot;, &quot;&quot;, &quot;Backend to send a Reload RPC to&quot;)
<a href="#h4-0-3" id="h4-0-3" class="i">+	flagNumWorkers    = flag.Int(&quot;num-workers&quot;, 8, &quot;Number of workers used to update repositories&quot;)
</a> )
 
<a href="#h4-0-6" id="h4-0-6" class="d">-const Workers = 8
</a><a href="#h4-0-7" id="h4-0-7" class="d">-
</a> func main() {
 	flag.Parse()
 	log.SetFlags(0)
<a href="#h4-1" id="h4-1" class="h">@@ -99,11 +98,11 @@ func findCodesearch(given string) string {
</a> 
 func checkoutRepos(repos *[]*config.RepoSpec) error {
 	repoc := make(chan *config.RepoSpec)
<a href="#h4-1-3" id="h4-1-3" class="d">-	errc := make(chan error, Workers)
</a><a href="#h4-1-4" id="h4-1-4" class="i">+	errc := make(chan error, *flagNumWorkers)
</a> 	stop := make(chan struct{})
 	wg := sync.WaitGroup{}
<a href="#h4-1-7" id="h4-1-7" class="d">-	wg.Add(Workers)
</a><a href="#h4-1-8" id="h4-1-8" class="d">-	for i := 0; i &lt; Workers; i++ {
</a><a href="#h4-1-9" id="h4-1-9" class="i">+	wg.Add(*flagNumWorkers)
</a><a href="#h4-1-10" id="h4-1-10" class="i">+	for i := 0; i &lt; *flagNumWorkers; i++ {
</a> 		go func() {
 			defer wg.Done()
 			checkoutWorker(repoc, stop, errc)
<b>diff --git a/<a id="h5" href="../file/cmd/livegrep-github-reindex/main.go">cmd/livegrep-github-reindex/main.go</a> b/<a href="../file/cmd/livegrep-github-reindex/main.go">cmd/livegrep-github-reindex/main.go</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -36,20 +36,24 @@ var (
</a> 		display: &quot;${dir}/livegrep.idx&quot;,
 		fn:      func() string { return path.Join(*flagRepoDir, &quot;livegrep.idx&quot;) },
 	}
<a href="#h5-0-3" id="h5-0-3" class="d">-	flagRevision     = flag.String(&quot;revision&quot;, &quot;HEAD&quot;, &quot;git revision to index&quot;)
</a><a href="#h5-0-4" id="h5-0-4" class="d">-	flagUrlPattern   = flag.String(&quot;url-pattern&quot;, &quot;https://github.com/{name}/blob/{version}/{path}#L{lno}&quot;, &quot;when using the local frontend fileviewer, this string will be used to construt a link to the file source on github&quot;)
</a><a href="#h5-0-5" id="h5-0-5" class="d">-	flagName         = flag.String(&quot;name&quot;, &quot;livegrep index&quot;, &quot;The name to be stored in the index file&quot;)
</a><a href="#h5-0-6" id="h5-0-6" class="d">-	flagRevparse     = flag.Bool(&quot;revparse&quot;, true, &quot;whether to `git rev-parse` the provided revision in generated links&quot;)
</a><a href="#h5-0-7" id="h5-0-7" class="d">-	flagForks        = flag.Bool(&quot;forks&quot;, true, &quot;whether to index repositories that are github forks, and not original repos&quot;)
</a><a href="#h5-0-8" id="h5-0-8" class="d">-	flagArchived     = flag.Bool(&quot;archived&quot;, false, &quot;whether to index repositories that are archived on github&quot;)
</a><a href="#h5-0-9" id="h5-0-9" class="d">-	flagHTTP         = flag.Bool(&quot;http&quot;, false, &quot;clone repositories over HTTPS instead of SSH&quot;)
</a><a href="#h5-0-10" id="h5-0-10" class="d">-	flagHTTPUsername = flag.String(&quot;http-user&quot;, &quot;git&quot;, &quot;Override the username to use when cloning over https&quot;)
</a><a href="#h5-0-11" id="h5-0-11" class="d">-	flagInstallation = flag.Bool(&quot;installation-token&quot;, false, &quot;Treat the API key as a Github Application Installation Key when cloning&quot;)
</a><a href="#h5-0-12" id="h5-0-12" class="d">-	flagDepth        = flag.Int(&quot;depth&quot;, 0, &quot;clone repository with specify --depth=N depth.&quot;)
</a><a href="#h5-0-13" id="h5-0-13" class="d">-	flagSkipMissing  = flag.Bool(&quot;skip-missing&quot;, false, &quot;skip repositories where the specified revision is missing&quot;)
</a><a href="#h5-0-14" id="h5-0-14" class="d">-	flagRepos        = stringList{}
</a><a href="#h5-0-15" id="h5-0-15" class="d">-	flagOrgs         = stringList{}
</a><a href="#h5-0-16" id="h5-0-16" class="d">-	flagUsers        = stringList{}
</a><a href="#h5-0-17" id="h5-0-17" class="i">+	flagRevision                = flag.String(&quot;revision&quot;, &quot;HEAD&quot;, &quot;git revision to index&quot;)
</a><a href="#h5-0-18" id="h5-0-18" class="i">+	flagUrlPattern              = flag.String(&quot;url-pattern&quot;, &quot;https://github.com/{name}/blob/{version}/{path}#L{lno}&quot;, &quot;when using the local frontend fileviewer, this string will be used to construt a link to the file source on github&quot;)
</a><a href="#h5-0-19" id="h5-0-19" class="i">+	flagName                    = flag.String(&quot;name&quot;, &quot;livegrep index&quot;, &quot;The name to be stored in the index file&quot;)
</a><a href="#h5-0-20" id="h5-0-20" class="i">+	flagNumRepoUpdateWorkers    = flag.String(&quot;num-repo-update-workers&quot;, &quot;8&quot;, &quot;Number of workers fetch-reindex will use to update repositories&quot;)
</a><a href="#h5-0-21" id="h5-0-21" class="i">+	flagRevparse                = flag.Bool(&quot;revparse&quot;, true, &quot;whether to `git rev-parse` the provided revision in generated links&quot;)
</a><a href="#h5-0-22" id="h5-0-22" class="i">+	flagForks                   = flag.Bool(&quot;forks&quot;, true, &quot;whether to index repositories that are github forks, and not original repos&quot;)
</a><a href="#h5-0-23" id="h5-0-23" class="i">+	flagArchived                = flag.Bool(&quot;archived&quot;, false, &quot;whether to index repositories that are archived on github&quot;)
</a><a href="#h5-0-24" id="h5-0-24" class="i">+	flagHTTP                    = flag.Bool(&quot;http&quot;, false, &quot;clone repositories over HTTPS instead of SSH&quot;)
</a><a href="#h5-0-25" id="h5-0-25" class="i">+	flagHTTPUsername            = flag.String(&quot;http-user&quot;, &quot;git&quot;, &quot;Override the username to use when cloning over https&quot;)
</a><a href="#h5-0-26" id="h5-0-26" class="i">+	flagInstallation            = flag.Bool(&quot;installation-token&quot;, false, &quot;Treat the API key as a Github Application Installation Key when cloning&quot;)
</a><a href="#h5-0-27" id="h5-0-27" class="i">+	flagDepth                   = flag.Int(&quot;depth&quot;, 0, &quot;clone repository with specify --depth=N depth.&quot;)
</a><a href="#h5-0-28" id="h5-0-28" class="i">+	flagSkipMissing             = flag.Bool(&quot;skip-missing&quot;, false, &quot;skip repositories where the specified revision is missing&quot;)
</a><a href="#h5-0-29" id="h5-0-29" class="i">+	flagMaxConcurrentGHRequests = flag.Int(&quot;max-concurrent-gh-requests&quot;, 1, &quot;Applied per org/user. If fetching 2 orgs, you will have 2x{yourInput} network calls possible at a time&quot;)
</a><a href="#h5-0-30" id="h5-0-30" class="i">+	flagNoIndex                 = flag.Bool(&quot;no-index&quot;, false, &quot;Skip indexing after writing config&quot;)
</a><a href="#h5-0-31" id="h5-0-31" class="i">+
</a><a href="#h5-0-32" id="h5-0-32" class="i">+	flagRepos = stringList{}
</a><a href="#h5-0-33" id="h5-0-33" class="i">+	flagOrgs  = stringList{}
</a><a href="#h5-0-34" id="h5-0-34" class="i">+	flagUsers = stringList{}
</a> )
 
 func init() {
<a href="#h5-1" id="h5-1" class="h">@@ -136,12 +140,17 @@ func main() {
</a> 	if err := writeConfig(config, configPath); err != nil {
 		log.Fatalln(err.Error())
 	}
<a href="#h5-1-3" id="h5-1-3" class="i">+	if *flagNoIndex {
</a><a href="#h5-1-4" id="h5-1-4" class="i">+		log.Printf(&quot;Skipping indexing after writing config&quot;)
</a><a href="#h5-1-5" id="h5-1-5" class="i">+		return
</a><a href="#h5-1-6" id="h5-1-6" class="i">+	}
</a> 
 	index := flagIndexPath.Get().(string)
 
 	args := []string{
 		&quot;--out&quot;, index,
 		&quot;--codesearch&quot;, *flagCodesearch,
<a href="#h5-1-13" id="h5-1-13" class="i">+		&quot;--num-workers&quot;, *flagNumRepoUpdateWorkers,
</a> 	}
 	if *flagRevparse {
 		args = append(args, &quot;--revparse&quot;)
<a href="#h5-2" id="h5-2" class="h">@@ -325,42 +334,113 @@ func getOneRepo(client *github.Client, repo string) ([]*github.Repository, error
</a> 	return []*github.Repository{ghRepo}, nil
 }
 
<a href="#h5-2-3" id="h5-2-3" class="d">-func getOrgRepos(client *github.Client, org string) ([]*github.Repository, error) {
</a><a href="#h5-2-4" id="h5-2-4" class="d">-	var buf []*github.Repository
</a><a href="#h5-2-5" id="h5-2-5" class="d">-	opt := &amp;github.RepositoryListByOrgOptions{
</a><a href="#h5-2-6" id="h5-2-6" class="d">-		ListOptions: github.ListOptions{PerPage: 50},
</a><a href="#h5-2-7" id="h5-2-7" class="i">+type IndexedResponse struct {
</a><a href="#h5-2-8" id="h5-2-8" class="i">+	Page  int
</a><a href="#h5-2-9" id="h5-2-9" class="i">+	Org   string
</a><a href="#h5-2-10" id="h5-2-10" class="i">+	Repos []*github.Repository
</a><a href="#h5-2-11" id="h5-2-11" class="i">+	err   error
</a><a href="#h5-2-12" id="h5-2-12" class="i">+}
</a><a href="#h5-2-13" id="h5-2-13" class="i">+
</a><a href="#h5-2-14" id="h5-2-14" class="i">+func callGitHubConcurrently(initialResp *github.Response, concurrencyLimit int, firstResult []*github.Repository, gClient *github.Client, method string, org string, user string) ([]*github.Repository, error) {
</a><a href="#h5-2-15" id="h5-2-15" class="i">+	pagesToCall := initialResp.LastPage - 1
</a><a href="#h5-2-16" id="h5-2-16" class="i">+
</a><a href="#h5-2-17" id="h5-2-17" class="i">+	// create the matrix of results and add the first one - this is so we can maintain order
</a><a href="#h5-2-18" id="h5-2-18" class="i">+	// which unfortunately takes an extra O(n) pass
</a><a href="#h5-2-19" id="h5-2-19" class="i">+	resultsMatrix := make([][]*github.Repository, pagesToCall+1)
</a><a href="#h5-2-20" id="h5-2-20" class="i">+	resultsMatrix[0] = firstResult
</a><a href="#h5-2-21" id="h5-2-21" class="i">+
</a><a href="#h5-2-22" id="h5-2-22" class="i">+	semaphores := make(chan bool, concurrencyLimit)
</a><a href="#h5-2-23" id="h5-2-23" class="i">+	resStream := make(chan *IndexedResponse, pagesToCall)
</a><a href="#h5-2-24" id="h5-2-24" class="i">+	var wg sync.WaitGroup
</a><a href="#h5-2-25" id="h5-2-25" class="i">+
</a><a href="#h5-2-26" id="h5-2-26" class="i">+	ctx, cancel := context.WithCancel(context.Background())
</a><a href="#h5-2-27" id="h5-2-27" class="i">+	defer cancel()
</a><a href="#h5-2-28" id="h5-2-28" class="i">+
</a><a href="#h5-2-29" id="h5-2-29" class="i">+	for i := 1; i &lt;= pagesToCall; i++ {
</a><a href="#h5-2-30" id="h5-2-30" class="i">+		wg.Add(1)
</a><a href="#h5-2-31" id="h5-2-31" class="i">+
</a><a href="#h5-2-32" id="h5-2-32" class="i">+		go func(ctx context.Context, page int, c chan *IndexedResponse, s chan bool, w *sync.WaitGroup) {
</a><a href="#h5-2-33" id="h5-2-33" class="i">+			s &lt;- true // aquire semaphore
</a><a href="#h5-2-34" id="h5-2-34" class="i">+			defer w.Done()
</a><a href="#h5-2-35" id="h5-2-35" class="i">+
</a><a href="#h5-2-36" id="h5-2-36" class="i">+			var repos []*github.Repository
</a><a href="#h5-2-37" id="h5-2-37" class="i">+			var err error
</a><a href="#h5-2-38" id="h5-2-38" class="i">+			if method == &quot;org&quot; {
</a><a href="#h5-2-39" id="h5-2-39" class="i">+				repos, _, err = gClient.Repositories.ListByOrg(ctx, org, &amp;github.RepositoryListByOrgOptions{
</a><a href="#h5-2-40" id="h5-2-40" class="i">+					ListOptions: github.ListOptions{PerPage: 100, Page: page},
</a><a href="#h5-2-41" id="h5-2-41" class="i">+				})
</a><a href="#h5-2-42" id="h5-2-42" class="i">+			} else if method == &quot;user&quot; {
</a><a href="#h5-2-43" id="h5-2-43" class="i">+				repos, _, err = gClient.Repositories.List(ctx, user, &amp;github.RepositoryListOptions{
</a><a href="#h5-2-44" id="h5-2-44" class="i">+					ListOptions: github.ListOptions{PerPage: 100, Page: page},
</a><a href="#h5-2-45" id="h5-2-45" class="i">+				})
</a><a href="#h5-2-46" id="h5-2-46" class="i">+			}
</a><a href="#h5-2-47" id="h5-2-47" class="i">+
</a><a href="#h5-2-48" id="h5-2-48" class="i">+			c &lt;- &amp;IndexedResponse{
</a><a href="#h5-2-49" id="h5-2-49" class="i">+				Page:  page,
</a><a href="#h5-2-50" id="h5-2-50" class="i">+				Repos: repos,
</a><a href="#h5-2-51" id="h5-2-51" class="i">+				Org:   org,
</a><a href="#h5-2-52" id="h5-2-52" class="i">+				err:   err,
</a><a href="#h5-2-53" id="h5-2-53" class="i">+			}
</a><a href="#h5-2-54" id="h5-2-54" class="i">+			&lt;-s // release semaphore
</a><a href="#h5-2-55" id="h5-2-55" class="i">+		}(ctx, i+1, resStream, semaphores, &amp;wg) // + 1 because pages are 1 based, and we already called 1st to start with
</a> 	}
<a href="#h5-2-57" id="h5-2-57" class="d">-	for {
</a><a href="#h5-2-58" id="h5-2-58" class="d">-		repos, resp, err := client.Repositories.ListByOrg(context.TODO(), org, opt)
</a><a href="#h5-2-59" id="h5-2-59" class="d">-		if err != nil {
</a><a href="#h5-2-60" id="h5-2-60" class="d">-			return nil, err
</a><a href="#h5-2-61" id="h5-2-61" class="d">-		}
</a><a href="#h5-2-62" id="h5-2-62" class="d">-		buf = append(buf, repos...)
</a><a href="#h5-2-63" id="h5-2-63" class="d">-		if resp.NextPage == 0 {
</a><a href="#h5-2-64" id="h5-2-64" class="d">-			break
</a><a href="#h5-2-65" id="h5-2-65" class="i">+
</a><a href="#h5-2-66" id="h5-2-66" class="i">+	// close the channel in the background
</a><a href="#h5-2-67" id="h5-2-67" class="i">+	go func() {
</a><a href="#h5-2-68" id="h5-2-68" class="i">+		wg.Wait()
</a><a href="#h5-2-69" id="h5-2-69" class="i">+		close(resStream)
</a><a href="#h5-2-70" id="h5-2-70" class="i">+		close(semaphores)
</a><a href="#h5-2-71" id="h5-2-71" class="i">+	}()
</a><a href="#h5-2-72" id="h5-2-72" class="i">+
</a><a href="#h5-2-73" id="h5-2-73" class="i">+	for res := range resStream {
</a><a href="#h5-2-74" id="h5-2-74" class="i">+		if res.err != nil {
</a><a href="#h5-2-75" id="h5-2-75" class="i">+			return nil, res.err // cancel will be called after this early return
</a> 		}
<a href="#h5-2-77" id="h5-2-77" class="d">-		opt.ListOptions.Page = resp.NextPage
</a><a href="#h5-2-78" id="h5-2-78" class="i">+		resultsMatrix[res.Page-1] = res.Repos // Page index is 1 based
</a> 	}
<a href="#h5-2-80" id="h5-2-80" class="i">+
</a><a href="#h5-2-81" id="h5-2-81" class="i">+	// Now flatten the matrix and return it
</a><a href="#h5-2-82" id="h5-2-82" class="i">+	var buf []*github.Repository
</a><a href="#h5-2-83" id="h5-2-83" class="i">+	for _, res := range resultsMatrix {
</a><a href="#h5-2-84" id="h5-2-84" class="i">+		buf = append(buf, res...)
</a><a href="#h5-2-85" id="h5-2-85" class="i">+	}
</a><a href="#h5-2-86" id="h5-2-86" class="i">+
</a> 	return buf, nil
 }
 
<a href="#h5-2-90" id="h5-2-90" class="i">+func getOrgRepos(client *github.Client, org string) ([]*github.Repository, error) {
</a><a href="#h5-2-91" id="h5-2-91" class="i">+	log.Printf(&quot;Fetching repositories for organization: %s&quot;, org)
</a><a href="#h5-2-92" id="h5-2-92" class="i">+
</a><a href="#h5-2-93" id="h5-2-93" class="i">+	opt := &amp;github.RepositoryListByOrgOptions{
</a><a href="#h5-2-94" id="h5-2-94" class="i">+		ListOptions: github.ListOptions{PerPage: 100},
</a><a href="#h5-2-95" id="h5-2-95" class="i">+	}
</a><a href="#h5-2-96" id="h5-2-96" class="i">+	repos, resp, err := client.Repositories.ListByOrg(context.TODO(), org, opt)
</a><a href="#h5-2-97" id="h5-2-97" class="i">+
</a><a href="#h5-2-98" id="h5-2-98" class="i">+	if err != nil {
</a><a href="#h5-2-99" id="h5-2-99" class="i">+		return nil, err
</a><a href="#h5-2-100" id="h5-2-100" class="i">+	} else if resp.FirstPage == resp.LastPage { // if no more pages, return early
</a><a href="#h5-2-101" id="h5-2-101" class="i">+		return repos, nil
</a><a href="#h5-2-102" id="h5-2-102" class="i">+	}
</a><a href="#h5-2-103" id="h5-2-103" class="i">+
</a><a href="#h5-2-104" id="h5-2-104" class="i">+	// when flagMaxConcurrentGHRequests is 1 (default), behaves synchronously
</a><a href="#h5-2-105" id="h5-2-105" class="i">+	return callGitHubConcurrently(resp, *flagMaxConcurrentGHRequests, repos, client, &quot;org&quot;, org, &quot;&quot;)
</a><a href="#h5-2-106" id="h5-2-106" class="i">+}
</a><a href="#h5-2-107" id="h5-2-107" class="i">+
</a> func getUserRepos(client *github.Client, user string) ([]*github.Repository, error) {
<a href="#h5-2-109" id="h5-2-109" class="d">-	var buf []*github.Repository
</a><a href="#h5-2-110" id="h5-2-110" class="i">+	log.Printf(&quot;Fetching repositories for user: %s&quot;, user)
</a><a href="#h5-2-111" id="h5-2-111" class="i">+
</a> 	opt := &amp;github.RepositoryListOptions{
<a href="#h5-2-113" id="h5-2-113" class="d">-		ListOptions: github.ListOptions{PerPage: 50},
</a><a href="#h5-2-114" id="h5-2-114" class="i">+		ListOptions: github.ListOptions{PerPage: 100},
</a> 	}
<a href="#h5-2-116" id="h5-2-116" class="d">-	for {
</a><a href="#h5-2-117" id="h5-2-117" class="d">-		repos, resp, err := client.Repositories.List(context.TODO(), user, opt)
</a><a href="#h5-2-118" id="h5-2-118" class="d">-		if err != nil {
</a><a href="#h5-2-119" id="h5-2-119" class="d">-			return nil, err
</a><a href="#h5-2-120" id="h5-2-120" class="d">-		}
</a><a href="#h5-2-121" id="h5-2-121" class="d">-		buf = append(buf, repos...)
</a><a href="#h5-2-122" id="h5-2-122" class="d">-		if resp.NextPage == 0 {
</a><a href="#h5-2-123" id="h5-2-123" class="d">-			break
</a><a href="#h5-2-124" id="h5-2-124" class="d">-		}
</a><a href="#h5-2-125" id="h5-2-125" class="d">-		opt.ListOptions.Page = resp.NextPage
</a><a href="#h5-2-126" id="h5-2-126" class="i">+	repos, resp, err := client.Repositories.List(context.TODO(), user, opt)
</a><a href="#h5-2-127" id="h5-2-127" class="i">+	if err != nil {
</a><a href="#h5-2-128" id="h5-2-128" class="i">+		return nil, err
</a><a href="#h5-2-129" id="h5-2-129" class="i">+	} else if resp.FirstPage == resp.LastPage { // if no more pages, return early
</a><a href="#h5-2-130" id="h5-2-130" class="i">+		return repos, nil
</a> 	}
<a href="#h5-2-132" id="h5-2-132" class="d">-	return buf, nil
</a><a href="#h5-2-133" id="h5-2-133" class="i">+
</a><a href="#h5-2-134" id="h5-2-134" class="i">+	// when flagMaxConcurrentGHRequests is 1 (default), behaves synchronously
</a><a href="#h5-2-135" id="h5-2-135" class="i">+	return callGitHubConcurrently(resp, *flagMaxConcurrentGHRequests, repos, client, &quot;user&quot;, &quot;&quot;, user)
</a> }
 
 func writeConfig(config []byte, file string) error {
<b>diff --git a/<a id="h6" href="../file/docker/base/Dockerfile">docker/base/Dockerfile</a> b/<a href="../file/docker/base/Dockerfile">docker/base/Dockerfile</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -0,0 +1,9 @@
</a><a href="#h6-0-0" id="h6-0-0" class="i">+FROM ubuntu:20.04
</a><a href="#h6-0-1" id="h6-0-1" class="i">+RUN apt-get update &amp;&amp; apt-get -y dist-upgrade
</a><a href="#h6-0-2" id="h6-0-2" class="i">+
</a><a href="#h6-0-3" id="h6-0-3" class="i">+ARG livegrep_version
</a><a href="#h6-0-4" id="h6-0-4" class="i">+COPY ./builds/${livegrep_version}.tgz /livegrep.tgz
</a><a href="#h6-0-5" id="h6-0-5" class="i">+
</a><a href="#h6-0-6" id="h6-0-6" class="i">+RUN tar -C / -xzvf /livegrep.tgz
</a><a href="#h6-0-7" id="h6-0-7" class="i">+COPY ./docker/nginx/nginx.conf /${livegrep_version}}/nginx.conf 
</a><a href="#h6-0-8" id="h6-0-8" class="i">+RUN ln -nsf /${livegrep_version} /livegrep
</a><b>diff --git a/<a id="h7" href="../file/docker/indexer/Dockerfile">docker/indexer/Dockerfile</a> b/<a href="../file/docker/indexer/Dockerfile">docker/indexer/Dockerfile</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -0,0 +1,3 @@
</a><a href="#h7-0-0" id="h7-0-0" class="i">+FROM livegrep/base
</a><a href="#h7-0-1" id="h7-0-1" class="i">+RUN apt-get update &amp;&amp; apt-get -y dist-upgrade
</a><a href="#h7-0-2" id="h7-0-2" class="i">+RUN apt-get --no-install-recommends -y install openssh-client ca-certificates git cron
</a><b>diff --git a/<a id="h8" href="../file/docker/nginx/Dockerfile">docker/nginx/Dockerfile</a> b/<a href="../file/docker/nginx/Dockerfile">docker/nginx/Dockerfile</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -0,0 +1,8 @@
</a><a href="#h8-0-0" id="h8-0-0" class="i">+FROM livegrep/base
</a><a href="#h8-0-1" id="h8-0-1" class="i">+RUN apt-get update &amp;&amp; apt-get -y dist-upgrade
</a><a href="#h8-0-2" id="h8-0-2" class="i">+RUN apt-get -y install nginx
</a><a href="#h8-0-3" id="h8-0-3" class="i">+
</a><a href="#h8-0-4" id="h8-0-4" class="i">+# the base image adds ./livegrep/nginx.conf for us, messy, but
</a><a href="#h8-0-5" id="h8-0-5" class="i">+# works for now
</a><a href="#h8-0-6" id="h8-0-6" class="i">+
</a><a href="#h8-0-7" id="h8-0-7" class="i">+CMD nginx -c /livegrep/nginx.conf
</a><b>diff --git a/<a id="h9" href="../file/docker/nginx/nginx.conf">docker/nginx/nginx.conf</a> b/<a href="../file/docker/nginx/nginx.conf">docker/nginx/nginx.conf</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -0,0 +1,70 @@
</a><a href="#h9-0-0" id="h9-0-0" class="i">+user www-data;
</a><a href="#h9-0-1" id="h9-0-1" class="i">+worker_processes  2;
</a><a href="#h9-0-2" id="h9-0-2" class="i">+
</a><a href="#h9-0-3" id="h9-0-3" class="i">+error_log /dev/stdout;
</a><a href="#h9-0-4" id="h9-0-4" class="i">+daemon off;
</a><a href="#h9-0-5" id="h9-0-5" class="i">+
</a><a href="#h9-0-6" id="h9-0-6" class="i">+events {
</a><a href="#h9-0-7" id="h9-0-7" class="i">+  worker_connections  1024;
</a><a href="#h9-0-8" id="h9-0-8" class="i">+}
</a><a href="#h9-0-9" id="h9-0-9" class="i">+
</a><a href="#h9-0-10" id="h9-0-10" class="i">+http {
</a><a href="#h9-0-11" id="h9-0-11" class="i">+  include       /etc/nginx/mime.types;
</a><a href="#h9-0-12" id="h9-0-12" class="i">+  default_type  application/octet-stream;
</a><a href="#h9-0-13" id="h9-0-13" class="i">+
</a><a href="#h9-0-14" id="h9-0-14" class="i">+  log_format nelhage &#39;$remote_addr - $remote_user [$time_local] &#39;
</a><a href="#h9-0-15" id="h9-0-15" class="i">+                     &#39;&quot;$request&quot; $status $body_bytes_sent &#39;
</a><a href="#h9-0-16" id="h9-0-16" class="i">+                     &#39;&quot;$http_referer&quot; &quot;$http_user_agent&quot; &#39;
</a><a href="#h9-0-17" id="h9-0-17" class="i">+                     &#39;&quot;$host&quot; &quot;$scheme&quot;&#39;;
</a><a href="#h9-0-18" id="h9-0-18" class="i">+
</a><a href="#h9-0-19" id="h9-0-19" class="i">+  map $request_uri $loggable {
</a><a href="#h9-0-20" id="h9-0-20" class="i">+    ~^/debug/ 0;
</a><a href="#h9-0-21" id="h9-0-21" class="i">+    default   1;
</a><a href="#h9-0-22" id="h9-0-22" class="i">+  }
</a><a href="#h9-0-23" id="h9-0-23" class="i">+  access_log /dev/stdout nelhage if=$loggable;
</a><a href="#h9-0-24" id="h9-0-24" class="i">+
</a><a href="#h9-0-25" id="h9-0-25" class="i">+  sendfile on;
</a><a href="#h9-0-26" id="h9-0-26" class="i">+  tcp_nopush on;
</a><a href="#h9-0-27" id="h9-0-27" class="i">+  tcp_nodelay on;
</a><a href="#h9-0-28" id="h9-0-28" class="i">+
</a><a href="#h9-0-29" id="h9-0-29" class="i">+  keepalive_timeout  65;
</a><a href="#h9-0-30" id="h9-0-30" class="i">+
</a><a href="#h9-0-31" id="h9-0-31" class="i">+  gzip  on;
</a><a href="#h9-0-32" id="h9-0-32" class="i">+  gzip_http_version 1.0;
</a><a href="#h9-0-33" id="h9-0-33" class="i">+  gzip_comp_level 2;
</a><a href="#h9-0-34" id="h9-0-34" class="i">+  gzip_proxied any;
</a><a href="#h9-0-35" id="h9-0-35" class="i">+  gzip_vary off;
</a><a href="#h9-0-36" id="h9-0-36" class="i">+  gzip_types text/plain text/css application/x-javascript text/xml application/xml application/rss+xml application/atom+xml text/javascript application/javascript application/json text/mathml;
</a><a href="#h9-0-37" id="h9-0-37" class="i">+  gzip_min_length  1000;
</a><a href="#h9-0-38" id="h9-0-38" class="i">+  gzip_disable     &quot;MSIE [1-6]\.&quot;;
</a><a href="#h9-0-39" id="h9-0-39" class="i">+
</a><a href="#h9-0-40" id="h9-0-40" class="i">+  server_names_hash_bucket_size 64;
</a><a href="#h9-0-41" id="h9-0-41" class="i">+  types_hash_max_size 2048;
</a><a href="#h9-0-42" id="h9-0-42" class="i">+  types_hash_bucket_size 64;
</a><a href="#h9-0-43" id="h9-0-43" class="i">+
</a><a href="#h9-0-44" id="h9-0-44" class="i">+  server {
</a><a href="#h9-0-45" id="h9-0-45" class="i">+    listen 80 default_server;
</a><a href="#h9-0-46" id="h9-0-46" class="i">+
</a><a href="#h9-0-47" id="h9-0-47" class="i">+    if ($http_x_forwarded_proto = &quot;http&quot;) {
</a><a href="#h9-0-48" id="h9-0-48" class="i">+      return 301 https://$host$request_uri;
</a><a href="#h9-0-49" id="h9-0-49" class="i">+    }
</a><a href="#h9-0-50" id="h9-0-50" class="i">+
</a><a href="#h9-0-51" id="h9-0-51" class="i">+    location / {
</a><a href="#h9-0-52" id="h9-0-52" class="i">+      root /livegrep/web/htdocs;
</a><a href="#h9-0-53" id="h9-0-53" class="i">+      try_files $uri @proxy;
</a><a href="#h9-0-54" id="h9-0-54" class="i">+    }
</a><a href="#h9-0-55" id="h9-0-55" class="i">+
</a><a href="#h9-0-56" id="h9-0-56" class="i">+    location @proxy {
</a><a href="#h9-0-57" id="h9-0-57" class="i">+      proxy_set_header Host $http_host;
</a><a href="#h9-0-58" id="h9-0-58" class="i">+      proxy_set_header X-NginX-Proxy true;
</a><a href="#h9-0-59" id="h9-0-59" class="i">+      proxy_pass http://livegrep-frontend:8910;
</a><a href="#h9-0-60" id="h9-0-60" class="i">+      proxy_redirect off;
</a><a href="#h9-0-61" id="h9-0-61" class="i">+
</a><a href="#h9-0-62" id="h9-0-62" class="i">+      proxy_http_version 1.1;
</a><a href="#h9-0-63" id="h9-0-63" class="i">+      proxy_set_header Upgrade $http_upgrade;
</a><a href="#h9-0-64" id="h9-0-64" class="i">+      proxy_set_header Connection &quot;upgrade&quot;;
</a><a href="#h9-0-65" id="h9-0-65" class="i">+    }
</a><a href="#h9-0-66" id="h9-0-66" class="i">+  }
</a><a href="#h9-0-67" id="h9-0-67" class="i">+
</a><a href="#h9-0-68" id="h9-0-68" class="i">+  include /var/run/config/nginx/*.conf;
</a><a href="#h9-0-69" id="h9-0-69" class="i">+}
</a><a href="#h9-0-70" id="h9-0-70" class="i">+\ No newline at end of file
</a><b>diff --git a/<a id="h10" href="../file/package.sh">package.sh</a> b/<a href="../file/package.sh">package.sh</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -8,3 +8,6 @@ bazel build :livegrep
</a> tar -C &quot;$builddir&quot; -xf &quot;$(bazel info bazel-bin)&quot;/livegrep.tar
 tar -czf &quot;builds/$builddir.tgz&quot; &quot;$builddir&quot;
 rm -rf &quot;$builddir&quot;
<a href="#h10-0-3" id="h10-0-3" class="i">+
</a><a href="#h10-0-4" id="h10-0-4" class="i">+# send the name of the built file, so that github actions can upload it
</a><a href="#h10-0-5" id="h10-0-5" class="i">+echo $builddir
</a><b>diff --git a/<a id="h11" href="../file/server/fileview.go">server/fileview.go</a> b/<a href="../file/server/fileview.go">server/fileview.go</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -50,6 +50,7 @@ var extToLangMap map[string]string = map[string]string{
</a> 	&quot;.sky&quot;:         &quot;python&quot;,
 	&quot;.sql&quot;:         &quot;sql&quot;,
 	&quot;.swift&quot;:       &quot;swift&quot;,
<a href="#h11-0-3" id="h11-0-3" class="i">+	&quot;.ts&quot;:          &quot;typescript&quot;,
</a> 	&quot;.tsx&quot;:         &quot;tsx&quot;,
 	&quot;.xml&quot;:         &quot;markup&quot;,
 	&quot;.yaml&quot;:        &quot;yaml&quot;,
<b>diff --git a/<a id="h12" href="../file/src/BUILD">src/BUILD</a> b/<a href="../file/src/BUILD">src/BUILD</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -15,11 +15,11 @@ cc_library(
</a>         &quot;//third_party:utf8cpp&quot;,
         &quot;@boost//:filesystem&quot;,
         &quot;@boost//:intrusive_ptr&quot;,
<a href="#h12-0-3" id="h12-0-3" class="d">-        &quot;@com_github_google_re2//:re2&quot;,
</a>         &quot;@com_github_libgit2//:libgit2&quot;,
         &quot;@com_google_absl//absl/container:flat_hash_set&quot;,
         &quot;@com_google_absl//absl/hash&quot;,
         &quot;@com_google_absl//absl/strings&quot;,
<a href="#h12-0-8" id="h12-0-8" class="i">+        &quot;@com_googlesource_code_re2//:re2&quot;,
</a>         &quot;@divsufsort&quot;,
     ],
 )
<b>diff --git a/<a id="h13" href="../file/src/tools/codesearch.cc">src/tools/codesearch.cc</a> b/<a href="../file/src/tools/codesearch.cc">src/tools/codesearch.cc</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -80,7 +80,7 @@ void build_index(code_searcher *cs, const vector&lt;std::string&gt; &amp;argv) {
</a>     IndexSpec spec;
     auto status = google::protobuf::util::JsonStringToMessage(json_text, &amp;spec, google::protobuf::util::JsonParseOptions());
     if (!status.ok()) {
<a href="#h13-0-3" id="h13-0-3" class="d">-        fprintf(stderr, &quot;Parsing %s: %s\n&quot;, argv[1].c_str(), status.error_message().data());
</a><a href="#h13-0-4" id="h13-0-4" class="i">+        fprintf(stderr, &quot;Parsing %s: %s\n&quot;, argv[1].c_str(), status.message().data());
</a>         exit(1);
     }
     if (!spec.paths_size() &amp;&amp; !spec.repositories_size()) {
</pre>
</div>
</body>
</html>
