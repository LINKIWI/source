<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Reorganize directory structure. - livegrep - Fast, regular expression code search service</title>
<meta name="description" content="Fast, regular expression code search service" />
<meta name="author" content="Kevin Lin" />
<link rel="icon" type="image/png" href="https://static.kevinlin.info/favicon.png" />
<link rel="alternate" type="application/atom+xml" title="livegrep Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="livegrep Atom Feed (tags)" href="../tags.xml" />
<style type="text/css">
body{color:#000;background-color:#fff;font-family:monospace}h1,h2,h3,h4,h5,h6{font-size:1em;margin:0}img,h1,h2{vertical-align:middle}img{border:0}a:target{background-color:#ccc}a.d,a.h,a.i{text-decoration:none}a.line{text-decoration:none;user-select:none}#blob a{color:#555}#blob a:hover{color:blue;text-decoration:none}table thead td{font-weight:bold}table td{padding:0 .4em}#content table td{vertical-align:top;white-space:nowrap}#branches tr:hover td,#tags tr:hover td,#index tr:hover td,#log tr:hover td,#files tr:hover td{background-color:#eee}#index tr td:nth-child(2),#tags tr td:nth-child(3),#branches tr td:nth-child(3),#log tr td:nth-child(2){white-space:normal}td.num{text-align:right}.desc{color:#555}hr{border:0;border-top:1px solid #555;height:1px}pre{font-family:monospace}pre a.h{color:#00a}.A,span.i,pre a.i{color:#070}.D,span.d,pre a.d{color:#e00}pre a.h:hover,pre a.i:hover,pre a.d:hover{text-decoration:none}/*# sourceMappingURL=style.css.min.map */
</style>
</head>
<body>
<table><tr><td><a href="/"><img src="https://static.kevinlin.info/favicon.png" alt="" width="32" height="32" /></a></td><td><h1>livegrep</h1><span class="desc">Fast, regular expression code search service</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://source.static.kevinlin.info/external/livegrep.git">https://source.static.kevinlin.info/external/livegrep.git</a></td></tr><tr><td></td><td>
<a href="../log">Log</a> | <a href="../files">Files</a> | <a href="../refs">Refs</a> | <a href="../file/README.md">README</a> | <a href="../file/COPYING">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/422cbe503074d3ad95eff0e996d7659aa400c645">422cbe503074d3ad95eff0e996d7659aa400c645</a>
<b>parent</b> <a href="../commit/d06569e3ad934e754114f3a3e15b92f142de510c">d06569e3ad934e754114f3a3e15b92f142de510c</a>
<b>Author:</b> Nelson Elhage &lt;<a href="mailto:nelhage@nelhage.com">nelhage@nelhage.com</a>&gt;
<b>Date:</b>   Sun, 29 Sep 2013 21:41:55 -0700

Reorganize directory structure.

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">README.md</a></td><td> | </td><td class="num">12</td><td><span class="i">++++++</span><span class="d">------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h1">bin/cs_server.js</a></td><td> | </td><td class="num">101</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h2">bin/index.js</a></td><td> | </td><td class="num">44</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h3">bin/web_server.js</a></td><td> | </td><td class="num">196</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="R">R</td><td><a href="#h4">web/appserver.js -&gt; js/appserver.js</a></td><td> | </td><td class="num">0</td><td><span class="i"></span><span class="d"></span></td></tr>
<tr><td class="R">R</td><td><a href="#h5">web/backend.js -&gt; js/backend.js</a></td><td> | </td><td class="num">0</td><td><span class="i"></span><span class="d"></span></td></tr>
<tr><td class="R">R</td><td><a href="#h6">web/batch.js -&gt; js/batch.js</a></td><td> | </td><td class="num">0</td><td><span class="i"></span><span class="d"></span></td></tr>
<tr><td class="R">R</td><td><a href="#h7">web/codesearch.js -&gt; js/codesearch.js</a></td><td> | </td><td class="num">0</td><td><span class="i"></span><span class="d"></span></td></tr>
<tr><td class="R">R</td><td><a href="#h8">web/config.js -&gt; js/config.js</a></td><td> | </td><td class="num">0</td><td><span class="i"></span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h9">js/config.local.js</a></td><td> | </td><td class="num">63</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="R">R</td><td><a href="#h10">web/git_util.js -&gt; js/git_util.js</a></td><td> | </td><td class="num">0</td><td><span class="i"></span><span class="d"></span></td></tr>
<tr><td class="R">R</td><td><a href="#h11">web/lib/parseopt.js -&gt; js/lib/parseopt.js</a></td><td> | </td><td class="num">0</td><td><span class="i"></span><span class="d"></span></td></tr>
<tr><td class="R">R</td><td><a href="#h12">web/lib/query-stats.js -&gt; js/lib/query-stats.js</a></td><td> | </td><td class="num">0</td><td><span class="i"></span><span class="d"></span></td></tr>
<tr><td class="R">R</td><td><a href="#h13">web/lib/stats.js -&gt; js/lib/stats.js</a></td><td> | </td><td class="num">0</td><td><span class="i"></span><span class="d"></span></td></tr>
<tr><td class="R">R</td><td><a href="#h14">web/log4js.json -&gt; js/log4js.json</a></td><td> | </td><td class="num">0</td><td><span class="i"></span><span class="d"></span></td></tr>
<tr><td class="R">R</td><td><a href="#h15">web/parse-log.js -&gt; js/parse-log.js</a></td><td> | </td><td class="num">0</td><td><span class="i"></span><span class="d"></span></td></tr>
<tr><td class="R">R</td><td><a href="#h16">web/util.js -&gt; js/util.js</a></td><td> | </td><td class="num">0</td><td><span class="i"></span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h17">test/bench.js</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h18">test/common.js</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h19">test/test.js</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="D">D</td><td><a href="#h20">web/cs_server.js</a></td><td> | </td><td class="num">101</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h21">web/index.js</a></td><td> | </td><td class="num">44</td><td><span class="i"></span><span class="d">--------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h22">web/web_server.js</a></td><td> | </td><td class="num">196</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
</table></pre><pre>23 files changed, 415 insertions(+), 352 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/README.md">README.md</a> b/<a href="../file/README.md">README.md</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -41,16 +41,16 @@ Components
</a> 
 Run `make` to build the `codesearch` binary. This binary can be used
 by hand, but is intended to be driven by the node.js helpers in the
<a href="#h0-0-3" id="h0-0-3" class="d">-`web/` directory.
</a><a href="#h0-0-4" id="h0-0-4" class="i">+`bin/` directory.
</a> 
<a href="#h0-0-6" id="h0-0-6" class="d">-The frontend programs can be configured in `web/config.local.js`. See
</a><a href="#h0-0-7" id="h0-0-7" class="d">-`web/config.js` for the configuration options. Once configuration is
</a><a href="#h0-0-8" id="h0-0-8" class="d">-established, `web/index.js` can be used to build a codesearch index.
</a><a href="#h0-0-9" id="h0-0-9" class="i">+The frontend programs can be configured in `js/config.local.js`. See
</a><a href="#h0-0-10" id="h0-0-10" class="i">+`js/config.js` for the configuration options. Once configuration is
</a><a href="#h0-0-11" id="h0-0-11" class="i">+established, `bin/index.js` can be used to build a codesearch index.
</a> 
 The livegrep frontend then consists of two separate
<a href="#h0-0-14" id="h0-0-14" class="d">-programs. `web/cs_servers.js` runs a `codesearch` process, which it
</a><a href="#h0-0-15" id="h0-0-15" class="i">+programs. `bin/cs_servers.js` runs a `codesearch` process, which it
</a> communicates with via a pipe, and listens on a local
<a href="#h0-0-17" id="h0-0-17" class="d">-port. `web/web_server.js` runs the web server frontend, and
</a><a href="#h0-0-18" id="h0-0-18" class="i">+port. `bin/web_server.js` runs the web server frontend, and
</a> communicates with `cs_server` over a local socket.
 
 Resource Usage
<b>diff --git a/<a id="h1" href="../file/bin/cs_server.js">bin/cs_server.js</a> b/<a href="../file/bin/cs_server.js">bin/cs_server.js</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -0,0 +1,101 @@
</a><a href="#h1-0-0" id="h1-0-0" class="i">+#!/usr/bin/env node
</a><a href="#h1-0-1" id="h1-0-1" class="i">+var dnode   = require(&#39;dnode&#39;),
</a><a href="#h1-0-2" id="h1-0-2" class="i">+    path    = require(&#39;path&#39;),
</a><a href="#h1-0-3" id="h1-0-3" class="i">+    net     = require(&#39;net&#39;),
</a><a href="#h1-0-4" id="h1-0-4" class="i">+    config  = require(&#39;../js/config.js&#39;),
</a><a href="#h1-0-5" id="h1-0-5" class="i">+    git_util   = require(&#39;../js/git_util.js&#39;),
</a><a href="#h1-0-6" id="h1-0-6" class="i">+    util       = require(&#39;../js/util.js&#39;),
</a><a href="#h1-0-7" id="h1-0-7" class="i">+    Codesearch = require(&#39;../js/codesearch.js&#39;),
</a><a href="#h1-0-8" id="h1-0-8" class="i">+    Batch      = require(&#39;../js/batch.js&#39;),
</a><a href="#h1-0-9" id="h1-0-9" class="i">+    parseopt   = require(&#39;../js/lib/parseopt.js&#39;),
</a><a href="#h1-0-10" id="h1-0-10" class="i">+    backend    = require(&#39;../js/backend.js&#39;),
</a><a href="#h1-0-11" id="h1-0-11" class="i">+    Einhorn    = require(&#39;einhorn&#39;);
</a><a href="#h1-0-12" id="h1-0-12" class="i">+
</a><a href="#h1-0-13" id="h1-0-13" class="i">+function Client(parent, remote) {
</a><a href="#h1-0-14" id="h1-0-14" class="i">+  var self = this;
</a><a href="#h1-0-15" id="h1-0-15" class="i">+  this.parent = parent;
</a><a href="#h1-0-16" id="h1-0-16" class="i">+  this.remote = remote;
</a><a href="#h1-0-17" id="h1-0-17" class="i">+  this.queue  = [];
</a><a href="#h1-0-18" id="h1-0-18" class="i">+  this.conn   = parent.codesearch.connect();
</a><a href="#h1-0-19" id="h1-0-19" class="i">+  this.conn.on(&#39;ready&#39;, function() {
</a><a href="#h1-0-20" id="h1-0-20" class="i">+                 var q;
</a><a href="#h1-0-21" id="h1-0-21" class="i">+                 if (self.queue.length) {
</a><a href="#h1-0-22" id="h1-0-22" class="i">+                   q = self.queue.shift();
</a><a href="#h1-0-23" id="h1-0-23" class="i">+                   self.search(q.search, q.cb);
</a><a href="#h1-0-24" id="h1-0-24" class="i">+                 } else {
</a><a href="#h1-0-25" id="h1-0-25" class="i">+                   self.ready();
</a><a href="#h1-0-26" id="h1-0-26" class="i">+                 }
</a><a href="#h1-0-27" id="h1-0-27" class="i">+               });
</a><a href="#h1-0-28" id="h1-0-28" class="i">+}
</a><a href="#h1-0-29" id="h1-0-29" class="i">+
</a><a href="#h1-0-30" id="h1-0-30" class="i">+Client.prototype.ready = function() {
</a><a href="#h1-0-31" id="h1-0-31" class="i">+  if (this.remote.ready)
</a><a href="#h1-0-32" id="h1-0-32" class="i">+    util.remote_call(this.remote, &#39;ready&#39;);
</a><a href="#h1-0-33" id="h1-0-33" class="i">+}
</a><a href="#h1-0-34" id="h1-0-34" class="i">+
</a><a href="#h1-0-35" id="h1-0-35" class="i">+Client.prototype.search = function (search, cb) {
</a><a href="#h1-0-36" id="h1-0-36" class="i">+  if (this.conn.readyState !== &#39;ready&#39;) {
</a><a href="#h1-0-37" id="h1-0-37" class="i">+    this.queue.push({
</a><a href="#h1-0-38" id="h1-0-38" class="i">+                      search: search,
</a><a href="#h1-0-39" id="h1-0-39" class="i">+                      cb: cb
</a><a href="#h1-0-40" id="h1-0-40" class="i">+                    });
</a><a href="#h1-0-41" id="h1-0-41" class="i">+    return;
</a><a href="#h1-0-42" id="h1-0-42" class="i">+  }
</a><a href="#h1-0-43" id="h1-0-43" class="i">+  var search = this.conn.search(search.line, search.file, search.repo);
</a><a href="#h1-0-44" id="h1-0-44" class="i">+  var batch  = new Batch(function (m) {
</a><a href="#h1-0-45" id="h1-0-45" class="i">+                           util.remote_call(cb, &#39;match&#39;, m);
</a><a href="#h1-0-46" id="h1-0-46" class="i">+                         }, 50);
</a><a href="#h1-0-47" id="h1-0-47" class="i">+  search.on(&#39;error&#39;, util.remote_call.bind(null, cb, &#39;error&#39;));
</a><a href="#h1-0-48" id="h1-0-48" class="i">+  search.on(&#39;done&#39;,  function () {
</a><a href="#h1-0-49" id="h1-0-49" class="i">+              batch.flush();
</a><a href="#h1-0-50" id="h1-0-50" class="i">+              util.remote_call.apply(null, [cb, &#39;done&#39;].concat(Array.prototype.slice.call(arguments)));
</a><a href="#h1-0-51" id="h1-0-51" class="i">+            });
</a><a href="#h1-0-52" id="h1-0-52" class="i">+  search.on(&#39;match&#39;, batch.send.bind(batch));
</a><a href="#h1-0-53" id="h1-0-53" class="i">+}
</a><a href="#h1-0-54" id="h1-0-54" class="i">+
</a><a href="#h1-0-55" id="h1-0-55" class="i">+function Server(backend) {
</a><a href="#h1-0-56" id="h1-0-56" class="i">+  var parent = this;
</a><a href="#h1-0-57" id="h1-0-57" class="i">+  this.clients = [];
</a><a href="#h1-0-58" id="h1-0-58" class="i">+
</a><a href="#h1-0-59" id="h1-0-59" class="i">+  this.codesearch = new Codesearch(backend.repo, [], {
</a><a href="#h1-0-60" id="h1-0-60" class="i">+                                     args: [&#39;--load_index&#39;, backend.index].concat(backend.search_args || [])
</a><a href="#h1-0-61" id="h1-0-61" class="i">+                                   });
</a><a href="#h1-0-62" id="h1-0-62" class="i">+  this.Server = function (remote, conn) {
</a><a href="#h1-0-63" id="h1-0-63" class="i">+    parent.clients[conn.id] = new Client(parent, remote);
</a><a href="#h1-0-64" id="h1-0-64" class="i">+    conn.on(&#39;end&#39;, function() {
</a><a href="#h1-0-65" id="h1-0-65" class="i">+              var client = parent.clients[conn.id];
</a><a href="#h1-0-66" id="h1-0-66" class="i">+              delete parent.clients[conn.id];
</a><a href="#h1-0-67" id="h1-0-67" class="i">+            });
</a><a href="#h1-0-68" id="h1-0-68" class="i">+    this.try_search = function(search, cb) {
</a><a href="#h1-0-69" id="h1-0-69" class="i">+      if (parent.clients[conn.id].conn.readyState !== &#39;ready&#39;) {
</a><a href="#h1-0-70" id="h1-0-70" class="i">+        util.remote_call(cb, &#39;not_ready&#39;);
</a><a href="#h1-0-71" id="h1-0-71" class="i">+        return;
</a><a href="#h1-0-72" id="h1-0-72" class="i">+      }
</a><a href="#h1-0-73" id="h1-0-73" class="i">+      parent.clients[conn.id].search(search, cb);
</a><a href="#h1-0-74" id="h1-0-74" class="i">+    }
</a><a href="#h1-0-75" id="h1-0-75" class="i">+    this.search = function(search, cb) {
</a><a href="#h1-0-76" id="h1-0-76" class="i">+      parent.clients[conn.id].search(search, cb);
</a><a href="#h1-0-77" id="h1-0-77" class="i">+    }
</a><a href="#h1-0-78" id="h1-0-78" class="i">+  }
</a><a href="#h1-0-79" id="h1-0-79" class="i">+}
</a><a href="#h1-0-80" id="h1-0-80" class="i">+
</a><a href="#h1-0-81" id="h1-0-81" class="i">+var parser = new parseopt.OptionParser();
</a><a href="#h1-0-82" id="h1-0-82" class="i">+backend.addBackendOpt(config, parser);
</a><a href="#h1-0-83" id="h1-0-83" class="i">+
</a><a href="#h1-0-84" id="h1-0-84" class="i">+var opts = parser.parse(process.argv);
</a><a href="#h1-0-85" id="h1-0-85" class="i">+
</a><a href="#h1-0-86" id="h1-0-86" class="i">+var backend = backend.selectBackend(config, opts);
</a><a href="#h1-0-87" id="h1-0-87" class="i">+
</a><a href="#h1-0-88" id="h1-0-88" class="i">+if (Einhorn.is_worker()) {
</a><a href="#h1-0-89" id="h1-0-89" class="i">+  Einhorn.ack();
</a><a href="#h1-0-90" id="h1-0-90" class="i">+  var app = new Server(backend).Server;
</a><a href="#h1-0-91" id="h1-0-91" class="i">+  var srv = net.createServer(function (c) {
</a><a href="#h1-0-92" id="h1-0-92" class="i">+    var d = dnode(app);
</a><a href="#h1-0-93" id="h1-0-93" class="i">+    c.pipe(d).pipe(c);
</a><a href="#h1-0-94" id="h1-0-94" class="i">+  });
</a><a href="#h1-0-95" id="h1-0-95" class="i">+  var fd = Einhorn.socket();
</a><a href="#h1-0-96" id="h1-0-96" class="i">+  srv.listen({fd: fd});
</a><a href="#h1-0-97" id="h1-0-97" class="i">+} else {
</a><a href="#h1-0-98" id="h1-0-98" class="i">+  var server = dnode(new Server(backend).Server);
</a><a href="#h1-0-99" id="h1-0-99" class="i">+  server.listen(backend.port);
</a><a href="#h1-0-100" id="h1-0-100" class="i">+}
</a><b>diff --git a/<a id="h2" href="../file/bin/index.js">bin/index.js</a> b/<a href="../file/bin/index.js">bin/index.js</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -0,0 +1,44 @@
</a><a href="#h2-0-0" id="h2-0-0" class="i">+#!/usr/bin/env node
</a><a href="#h2-0-1" id="h2-0-1" class="i">+var path    = require(&#39;path&#39;),
</a><a href="#h2-0-2" id="h2-0-2" class="i">+    fs      = require(&#39;fs&#39;),
</a><a href="#h2-0-3" id="h2-0-3" class="i">+    config  = require(&#39;../js/config.js&#39;),
</a><a href="#h2-0-4" id="h2-0-4" class="i">+    backend = require(&#39;../js/backend.js&#39;),
</a><a href="#h2-0-5" id="h2-0-5" class="i">+    parseopt= require(&#39;../js/lib/parseopt.js&#39;),
</a><a href="#h2-0-6" id="h2-0-6" class="i">+    spawn   = require(&#39;child_process&#39;).spawn;
</a><a href="#h2-0-7" id="h2-0-7" class="i">+
</a><a href="#h2-0-8" id="h2-0-8" class="i">+function generateIndex(backend, cb) {
</a><a href="#h2-0-9" id="h2-0-9" class="i">+  console.log(&quot;Generating index file: %s&quot;, backend.index);
</a><a href="#h2-0-10" id="h2-0-10" class="i">+
</a><a href="#h2-0-11" id="h2-0-11" class="i">+  var tmp = backend.index + &quot;.tmp&quot;;
</a><a href="#h2-0-12" id="h2-0-12" class="i">+
</a><a href="#h2-0-13" id="h2-0-13" class="i">+  var repos = backend.repos.map(function (repo) {
</a><a href="#h2-0-14" id="h2-0-14" class="i">+    return (repo.name ? repo.name + &quot;@&quot; : &quot;&quot;) +
</a><a href="#h2-0-15" id="h2-0-15" class="i">+      repo.path + &quot;:&quot; + repo.refs.join(&quot;,&quot;);
</a><a href="#h2-0-16" id="h2-0-16" class="i">+    });
</a><a href="#h2-0-17" id="h2-0-17" class="i">+
</a><a href="#h2-0-18" id="h2-0-18" class="i">+  var cs = spawn(path.join(__dirname, &#39;..&#39;, &#39;codesearch&#39;),
</a><a href="#h2-0-19" id="h2-0-19" class="i">+                 [&#39;--dump_index&#39;, tmp,
</a><a href="#h2-0-20" id="h2-0-20" class="i">+                  &#39;--order_root&#39;, backend.sort.join(&#39; &#39;),
</a><a href="#h2-0-21" id="h2-0-21" class="i">+                 ].concat(repos),
</a><a href="#h2-0-22" id="h2-0-22" class="i">+                 {
</a><a href="#h2-0-23" id="h2-0-23" class="i">+                   customFds: [-1, 1, 2]
</a><a href="#h2-0-24" id="h2-0-24" class="i">+                 });
</a><a href="#h2-0-25" id="h2-0-25" class="i">+  cs.on(&#39;exit&#39;, function(code, signal) {
</a><a href="#h2-0-26" id="h2-0-26" class="i">+          if (code !== 0) {
</a><a href="#h2-0-27" id="h2-0-27" class="i">+            console.error(&quot;Index process exited with %s&quot;, code ? (&quot;error &quot; + code) : &quot;signal &quot; + signal);
</a><a href="#h2-0-28" id="h2-0-28" class="i">+          } else {
</a><a href="#h2-0-29" id="h2-0-29" class="i">+            fs.renameSync(tmp, backend.index);
</a><a href="#h2-0-30" id="h2-0-30" class="i">+          }
</a><a href="#h2-0-31" id="h2-0-31" class="i">+          cb();
</a><a href="#h2-0-32" id="h2-0-32" class="i">+        });
</a><a href="#h2-0-33" id="h2-0-33" class="i">+  cs.stdin.end();
</a><a href="#h2-0-34" id="h2-0-34" class="i">+}
</a><a href="#h2-0-35" id="h2-0-35" class="i">+
</a><a href="#h2-0-36" id="h2-0-36" class="i">+var parser = new parseopt.OptionParser();
</a><a href="#h2-0-37" id="h2-0-37" class="i">+backend.addBackendOpt(config, parser);
</a><a href="#h2-0-38" id="h2-0-38" class="i">+
</a><a href="#h2-0-39" id="h2-0-39" class="i">+var opts = parser.parse(process.argv);
</a><a href="#h2-0-40" id="h2-0-40" class="i">+generateIndex(backend.selectBackend(config, opts),
</a><a href="#h2-0-41" id="h2-0-41" class="i">+             function () {
</a><a href="#h2-0-42" id="h2-0-42" class="i">+               process.exit(0);
</a><a href="#h2-0-43" id="h2-0-43" class="i">+             });
</a><b>diff --git a/<a id="h3" href="../file/bin/web_server.js">bin/web_server.js</a> b/<a href="../file/bin/web_server.js">bin/web_server.js</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -0,0 +1,196 @@
</a><a href="#h3-0-0" id="h3-0-0" class="i">+#!/usr/bin/env node
</a><a href="#h3-0-1" id="h3-0-1" class="i">+var express = require(&#39;express&#39;),
</a><a href="#h3-0-2" id="h3-0-2" class="i">+    http    = require(&#39;http&#39;),
</a><a href="#h3-0-3" id="h3-0-3" class="i">+    hbs     = require(&#39;hbs&#39;),
</a><a href="#h3-0-4" id="h3-0-4" class="i">+    extras  = require(&#39;express-extras&#39;),
</a><a href="#h3-0-5" id="h3-0-5" class="i">+    path    = require(&#39;path&#39;),
</a><a href="#h3-0-6" id="h3-0-6" class="i">+    parseopt= require(&#39;parseopt&#39;),
</a><a href="#h3-0-7" id="h3-0-7" class="i">+    log4js  = require(&#39;log4js&#39;),
</a><a href="#h3-0-8" id="h3-0-8" class="i">+    email   = require(&#39;emailjs&#39;),
</a><a href="#h3-0-9" id="h3-0-9" class="i">+    util    = require(&#39;util&#39;),
</a><a href="#h3-0-10" id="h3-0-10" class="i">+    Server  = require(&#39;../js/appserver.js&#39;),
</a><a href="#h3-0-11" id="h3-0-11" class="i">+    config  = require(&#39;../js/config.js&#39;),
</a><a href="#h3-0-12" id="h3-0-12" class="i">+    Einhorn = require(&#39;einhorn&#39;);
</a><a href="#h3-0-13" id="h3-0-13" class="i">+
</a><a href="#h3-0-14" id="h3-0-14" class="i">+function shorten(ref) {
</a><a href="#h3-0-15" id="h3-0-15" class="i">+  var match = /^refs\/(tags|branches)\/(.*)/.exec(ref);
</a><a href="#h3-0-16" id="h3-0-16" class="i">+  if (match)
</a><a href="#h3-0-17" id="h3-0-17" class="i">+    return match[2];
</a><a href="#h3-0-18" id="h3-0-18" class="i">+  return ref;
</a><a href="#h3-0-19" id="h3-0-19" class="i">+}
</a><a href="#h3-0-20" id="h3-0-20" class="i">+
</a><a href="#h3-0-21" id="h3-0-21" class="i">+var parser = new parseopt.OptionParser(
</a><a href="#h3-0-22" id="h3-0-22" class="i">+  {
</a><a href="#h3-0-23" id="h3-0-23" class="i">+    options: [
</a><a href="#h3-0-24" id="h3-0-24" class="i">+      {
</a><a href="#h3-0-25" id="h3-0-25" class="i">+        name: &quot;--autolaunch&quot;,
</a><a href="#h3-0-26" id="h3-0-26" class="i">+        default: false,
</a><a href="#h3-0-27" id="h3-0-27" class="i">+        type: &#39;flag&#39;,
</a><a href="#h3-0-28" id="h3-0-28" class="i">+        help: &#39;Automatically launch a code-search backend server.&#39;
</a><a href="#h3-0-29" id="h3-0-29" class="i">+      },
</a><a href="#h3-0-30" id="h3-0-30" class="i">+      {
</a><a href="#h3-0-31" id="h3-0-31" class="i">+        name: &quot;--production&quot;,
</a><a href="#h3-0-32" id="h3-0-32" class="i">+        default: false,
</a><a href="#h3-0-33" id="h3-0-33" class="i">+        type: &#39;flag&#39;,
</a><a href="#h3-0-34" id="h3-0-34" class="i">+        help: &#39;Enable options for a production deployment.&#39;
</a><a href="#h3-0-35" id="h3-0-35" class="i">+      }
</a><a href="#h3-0-36" id="h3-0-36" class="i">+    ]
</a><a href="#h3-0-37" id="h3-0-37" class="i">+  });
</a><a href="#h3-0-38" id="h3-0-38" class="i">+
</a><a href="#h3-0-39" id="h3-0-39" class="i">+var opts = parser.parse();
</a><a href="#h3-0-40" id="h3-0-40" class="i">+if (!opts) {
</a><a href="#h3-0-41" id="h3-0-41" class="i">+  process.exit(1);
</a><a href="#h3-0-42" id="h3-0-42" class="i">+}
</a><a href="#h3-0-43" id="h3-0-43" class="i">+
</a><a href="#h3-0-44" id="h3-0-44" class="i">+if (opts.options.autolaunch) {
</a><a href="#h3-0-45" id="h3-0-45" class="i">+  console.log(&quot;Autolaunching a back-end server...&quot;);
</a><a href="#h3-0-46" id="h3-0-46" class="i">+  require(&#39;./cs_server.js&#39;)
</a><a href="#h3-0-47" id="h3-0-47" class="i">+}
</a><a href="#h3-0-48" id="h3-0-48" class="i">+
</a><a href="#h3-0-49" id="h3-0-49" class="i">+var smtp = null;
</a><a href="#h3-0-50" id="h3-0-50" class="i">+if (config.SMTP_CONFIG) {
</a><a href="#h3-0-51" id="h3-0-51" class="i">+  smtp = email.server.connect(config.SMTP_CONFIG);
</a><a href="#h3-0-52" id="h3-0-52" class="i">+}
</a><a href="#h3-0-53" id="h3-0-53" class="i">+
</a><a href="#h3-0-54" id="h3-0-54" class="i">+var app = express();
</a><a href="#h3-0-55" id="h3-0-55" class="i">+var logger = log4js.getLogger(&#39;web&#39;);
</a><a href="#h3-0-56" id="h3-0-56" class="i">+
</a><a href="#h3-0-57" id="h3-0-57" class="i">+app.configure(
</a><a href="#h3-0-58" id="h3-0-58" class="i">+  function() {
</a><a href="#h3-0-59" id="h3-0-59" class="i">+    app.use(extras.fixIP());
</a><a href="#h3-0-60" id="h3-0-60" class="i">+    app.use(log4js.connectLogger(logger, {
</a><a href="#h3-0-61" id="h3-0-61" class="i">+                                   level: log4js.levels.INFO,
</a><a href="#h3-0-62" id="h3-0-62" class="i">+                                   format: function (req, res, fmt) {
</a><a href="#h3-0-63" id="h3-0-63" class="i">+                                     return &#39;&#39; + req.ip + fmt(&#39; [:date] :method :url&#39;);
</a><a href="#h3-0-64" id="h3-0-64" class="i">+                                   }
</a><a href="#h3-0-65" id="h3-0-65" class="i">+                                 }));
</a><a href="#h3-0-66" id="h3-0-66" class="i">+    app.engine(&#39;.html&#39;, hbs.__express);
</a><a href="#h3-0-67" id="h3-0-67" class="i">+    app.set(&#39;view engine&#39;, &#39;html&#39;);
</a><a href="#h3-0-68" id="h3-0-68" class="i">+    app.set(&#39;view options&#39;, {
</a><a href="#h3-0-69" id="h3-0-69" class="i">+              production: opts.options.production
</a><a href="#h3-0-70" id="h3-0-70" class="i">+            });
</a><a href="#h3-0-71" id="h3-0-71" class="i">+    app.set(&#39;views&#39;, path.join(__dirname, &#39;../web/templates&#39;));
</a><a href="#h3-0-72" id="h3-0-72" class="i">+    app.use(express.bodyParser());
</a><a href="#h3-0-73" id="h3-0-73" class="i">+    app.use(express.static(path.join(__dirname, &#39;../web/htdocs&#39;)));
</a><a href="#h3-0-74" id="h3-0-74" class="i">+    hbs.handlebars.registerHelper(&#39;json&#39;, function (data) {
</a><a href="#h3-0-75" id="h3-0-75" class="i">+      return new hbs.handlebars.SafeString(JSON.stringify(data).replace(/&lt;\/script&gt;/g, &#39;&lt;\\/script&gt;&#39;));
</a><a href="#h3-0-76" id="h3-0-76" class="i">+    });
</a><a href="#h3-0-77" id="h3-0-77" class="i">+  });
</a><a href="#h3-0-78" id="h3-0-78" class="i">+
</a><a href="#h3-0-79" id="h3-0-79" class="i">+app.get(&#39;/&#39;, function (req, res) {res.redirect(&#39;/search&#39;);});
</a><a href="#h3-0-80" id="h3-0-80" class="i">+function searchHandler (req, res) {
</a><a href="#h3-0-81" id="h3-0-81" class="i">+  var repo_map = {};
</a><a href="#h3-0-82" id="h3-0-82" class="i">+  Object.keys(config.BACKENDS).forEach(function (name) {
</a><a href="#h3-0-83" id="h3-0-83" class="i">+    var backend = config.BACKENDS[name];
</a><a href="#h3-0-84" id="h3-0-84" class="i">+    repo_map[name] = {};
</a><a href="#h3-0-85" id="h3-0-85" class="i">+    backend.repos.forEach(function (repo) {
</a><a href="#h3-0-86" id="h3-0-86" class="i">+      repo_map[name][repo.name] = repo.github;
</a><a href="#h3-0-87" id="h3-0-87" class="i">+    });
</a><a href="#h3-0-88" id="h3-0-88" class="i">+  });
</a><a href="#h3-0-89" id="h3-0-89" class="i">+  res.render(&#39;index&#39;,
</a><a href="#h3-0-90" id="h3-0-90" class="i">+             {
</a><a href="#h3-0-91" id="h3-0-91" class="i">+               js: true,
</a><a href="#h3-0-92" id="h3-0-92" class="i">+               title: &#39;search&#39;,
</a><a href="#h3-0-93" id="h3-0-93" class="i">+               repos: Object.keys(config.BACKENDS).map(function (name) {
</a><a href="#h3-0-94" id="h3-0-94" class="i">+                 var backend = config.BACKENDS[name];
</a><a href="#h3-0-95" id="h3-0-95" class="i">+                 return {
</a><a href="#h3-0-96" id="h3-0-96" class="i">+                   name: name,
</a><a href="#h3-0-97" id="h3-0-97" class="i">+                   pretty: backend.pretty_name
</a><a href="#h3-0-98" id="h3-0-98" class="i">+                 };
</a><a href="#h3-0-99" id="h3-0-99" class="i">+               }),
</a><a href="#h3-0-100" id="h3-0-100" class="i">+               multi_repo: Object.keys(config.BACKENDS).length &gt; 1,
</a><a href="#h3-0-101" id="h3-0-101" class="i">+               repo_name: (config.BACKENDS[&#39;&#39;]||{}).pretty_name,
</a><a href="#h3-0-102" id="h3-0-102" class="i">+               github_repos: repo_map,
</a><a href="#h3-0-103" id="h3-0-103" class="i">+               production: opts.options.production
</a><a href="#h3-0-104" id="h3-0-104" class="i">+             });
</a><a href="#h3-0-105" id="h3-0-105" class="i">+}
</a><a href="#h3-0-106" id="h3-0-106" class="i">+app.get(&#39;/search&#39;, searchHandler);
</a><a href="#h3-0-107" id="h3-0-107" class="i">+app.get(&#39;/search/:backend&#39;, searchHandler);
</a><a href="#h3-0-108" id="h3-0-108" class="i">+app.get(&#39;/about&#39;, function (req, res) {
</a><a href="#h3-0-109" id="h3-0-109" class="i">+          res.render(&#39;about&#39;,
</a><a href="#h3-0-110" id="h3-0-110" class="i">+                     {
</a><a href="#h3-0-111" id="h3-0-111" class="i">+                       title: &#39;about&#39;,
</a><a href="#h3-0-112" id="h3-0-112" class="i">+                       production: opts.options.production
</a><a href="#h3-0-113" id="h3-0-113" class="i">+                     });
</a><a href="#h3-0-114" id="h3-0-114" class="i">+        });
</a><a href="#h3-0-115" id="h3-0-115" class="i">+function send_feedback(data, cb) {
</a><a href="#h3-0-116" id="h3-0-116" class="i">+  if (smtp) {
</a><a href="#h3-0-117" id="h3-0-117" class="i">+    smtp.send({
</a><a href="#h3-0-118" id="h3-0-118" class="i">+                to: &quot;Nelson Elhage &lt;feedback@livegrep.com&gt;&quot;,
</a><a href="#h3-0-119" id="h3-0-119" class="i">+                from: &quot;Codesearch &lt;mailer@livegrep.com&quot;,
</a><a href="#h3-0-120" id="h3-0-120" class="i">+                subject: &quot;Feedback from codesearch!&quot;,
</a><a href="#h3-0-121" id="h3-0-121" class="i">+                text: util.format(
</a><a href="#h3-0-122" id="h3-0-122" class="i">+                  &quot;Codesearch feedback from: %s \n&quot; +
</a><a href="#h3-0-123" id="h3-0-123" class="i">+                    &quot;IP: %s\n&quot; +
</a><a href="#h3-0-124" id="h3-0-124" class="i">+                    &quot;Session: %s\n\n&quot; +
</a><a href="#h3-0-125" id="h3-0-125" class="i">+                    &quot;%s&quot;,
</a><a href="#h3-0-126" id="h3-0-126" class="i">+                  data.email,
</a><a href="#h3-0-127" id="h3-0-127" class="i">+                  data.remoteAddress,
</a><a href="#h3-0-128" id="h3-0-128" class="i">+                  data.session,
</a><a href="#h3-0-129" id="h3-0-129" class="i">+                  data.text
</a><a href="#h3-0-130" id="h3-0-130" class="i">+                )
</a><a href="#h3-0-131" id="h3-0-131" class="i">+              }, function (err, message) {
</a><a href="#h3-0-132" id="h3-0-132" class="i">+                if (err) {
</a><a href="#h3-0-133" id="h3-0-133" class="i">+                  console.log(&quot;Error sending email!&quot;, err);
</a><a href="#h3-0-134" id="h3-0-134" class="i">+                  cb(err);
</a><a href="#h3-0-135" id="h3-0-135" class="i">+                } else {
</a><a href="#h3-0-136" id="h3-0-136" class="i">+                  console.log(&quot;Email sent!&quot;);
</a><a href="#h3-0-137" id="h3-0-137" class="i">+                  cb();
</a><a href="#h3-0-138" id="h3-0-138" class="i">+                }
</a><a href="#h3-0-139" id="h3-0-139" class="i">+              });
</a><a href="#h3-0-140" id="h3-0-140" class="i">+  } else {
</a><a href="#h3-0-141" id="h3-0-141" class="i">+    process.nextTick(cb);
</a><a href="#h3-0-142" id="h3-0-142" class="i">+  }
</a><a href="#h3-0-143" id="h3-0-143" class="i">+}
</a><a href="#h3-0-144" id="h3-0-144" class="i">+
</a><a href="#h3-0-145" id="h3-0-145" class="i">+app.post(&#39;/feedback&#39;, function (req, res) {
</a><a href="#h3-0-146" id="h3-0-146" class="i">+           console.log(&quot;FEEDBACK&quot;, req.body);
</a><a href="#h3-0-147" id="h3-0-147" class="i">+           if (!(&#39;data&#39; in req.body)) {
</a><a href="#h3-0-148" id="h3-0-148" class="i">+             res.send(400);
</a><a href="#h3-0-149" id="h3-0-149" class="i">+             return;
</a><a href="#h3-0-150" id="h3-0-150" class="i">+           }
</a><a href="#h3-0-151" id="h3-0-151" class="i">+           var data;
</a><a href="#h3-0-152" id="h3-0-152" class="i">+           try {
</a><a href="#h3-0-153" id="h3-0-153" class="i">+             data = JSON.parse(req.body.data);
</a><a href="#h3-0-154" id="h3-0-154" class="i">+           } catch(e) {
</a><a href="#h3-0-155" id="h3-0-155" class="i">+             console.log(&quot;Feedback error: %s&quot;, e);
</a><a href="#h3-0-156" id="h3-0-156" class="i">+             res.send(400);
</a><a href="#h3-0-157" id="h3-0-157" class="i">+             return;
</a><a href="#h3-0-158" id="h3-0-158" class="i">+           }
</a><a href="#h3-0-159" id="h3-0-159" class="i">+
</a><a href="#h3-0-160" id="h3-0-160" class="i">+           if (!data.email &amp;&amp; !data.text) {
</a><a href="#h3-0-161" id="h3-0-161" class="i">+             console.log(&quot;Empty feedback: %j&quot;, data);
</a><a href="#h3-0-162" id="h3-0-162" class="i">+             res.send(200);
</a><a href="#h3-0-163" id="h3-0-163" class="i">+             return;
</a><a href="#h3-0-164" id="h3-0-164" class="i">+           }
</a><a href="#h3-0-165" id="h3-0-165" class="i">+
</a><a href="#h3-0-166" id="h3-0-166" class="i">+           data.remoteAddress = req.connection.remoteAddress;
</a><a href="#h3-0-167" id="h3-0-167" class="i">+           send_feedback(data,
</a><a href="#h3-0-168" id="h3-0-168" class="i">+                         function (err) {
</a><a href="#h3-0-169" id="h3-0-169" class="i">+                           if (err) {
</a><a href="#h3-0-170" id="h3-0-170" class="i">+                             res.send(500);
</a><a href="#h3-0-171" id="h3-0-171" class="i">+                           } else {
</a><a href="#h3-0-172" id="h3-0-172" class="i">+                             res.send(200);
</a><a href="#h3-0-173" id="h3-0-173" class="i">+                           }
</a><a href="#h3-0-174" id="h3-0-174" class="i">+                         });
</a><a href="#h3-0-175" id="h3-0-175" class="i">+         });
</a><a href="#h3-0-176" id="h3-0-176" class="i">+
</a><a href="#h3-0-177" id="h3-0-177" class="i">+var server = http.createServer(app);
</a><a href="#h3-0-178" id="h3-0-178" class="i">+
</a><a href="#h3-0-179" id="h3-0-179" class="i">+if (Einhorn.is_worker()) {
</a><a href="#h3-0-180" id="h3-0-180" class="i">+  Einhorn.ack();
</a><a href="#h3-0-181" id="h3-0-181" class="i">+  var fd = Einhorn.socket();
</a><a href="#h3-0-182" id="h3-0-182" class="i">+  server.listen({fd: fd});
</a><a href="#h3-0-183" id="h3-0-183" class="i">+} else {
</a><a href="#h3-0-184" id="h3-0-184" class="i">+  server.listen(config.WEB_PORT);
</a><a href="#h3-0-185" id="h3-0-185" class="i">+  console.log(&quot;Listening on :%d.&quot;, config.WEB_PORT);
</a><a href="#h3-0-186" id="h3-0-186" class="i">+}
</a><a href="#h3-0-187" id="h3-0-187" class="i">+
</a><a href="#h3-0-188" id="h3-0-188" class="i">+var io = require(&#39;socket.io&#39;).listen(server, {
</a><a href="#h3-0-189" id="h3-0-189" class="i">+                                       logger: log4js.getLogger(&#39;socket.io&#39;),
</a><a href="#h3-0-190" id="h3-0-190" class="i">+                                       &#39;log level&#39;: log4js.levels.INFO
</a><a href="#h3-0-191" id="h3-0-191" class="i">+                                     });
</a><a href="#h3-0-192" id="h3-0-192" class="i">+if (config.SOCKET_IO_TRANSPORTS)
</a><a href="#h3-0-193" id="h3-0-193" class="i">+  io.set(&#39;transports&#39;, config.SOCKET_IO_TRANSPORTS);
</a><a href="#h3-0-194" id="h3-0-194" class="i">+
</a><a href="#h3-0-195" id="h3-0-195" class="i">+var server = new Server(config, io);
</a><b>diff --git a/<a id="h4" href="../file/web/appserver.js">web/appserver.js</a> b/<a href="../file/js/appserver.js">js/appserver.js</a></b>
<b>diff --git a/<a id="h5" href="../file/web/backend.js">web/backend.js</a> b/<a href="../file/js/backend.js">js/backend.js</a></b>
<b>diff --git a/<a id="h6" href="../file/web/batch.js">web/batch.js</a> b/<a href="../file/js/batch.js">js/batch.js</a></b>
<b>diff --git a/<a id="h7" href="../file/web/codesearch.js">web/codesearch.js</a> b/<a href="../file/js/codesearch.js">js/codesearch.js</a></b>
<b>diff --git a/<a id="h8" href="../file/web/config.js">web/config.js</a> b/<a href="../file/js/config.js">js/config.js</a></b>
<b>diff --git a/<a id="h9" href="../file/js/config.local.js">js/config.local.js</a> b/<a href="../file/js/config.local.js">js/config.local.js</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -0,0 +1,63 @@
</a><a href="#h9-0-0" id="h9-0-0" class="i">+var path = require(&#39;path&#39;);
</a><a href="#h9-0-1" id="h9-0-1" class="i">+
</a><a href="#h9-0-2" id="h9-0-2" class="i">+/* module.exports = {
</a><a href="#h9-0-3" id="h9-0-3" class="i">+  SLOW_THRESHOLD: 300,
</a><a href="#h9-0-4" id="h9-0-4" class="i">+  BACKENDS: {livegrep: {
</a><a href="#h9-0-5" id="h9-0-5" class="i">+    host: &quot;localhost&quot;,
</a><a href="#h9-0-6" id="h9-0-6" class="i">+    port: 0xC5EA,
</a><a href="#h9-0-7" id="h9-0-7" class="i">+    connections: 4,
</a><a href="#h9-0-8" id="h9-0-8" class="i">+    index: path.join(__dirname, &quot;livegrep.idx&quot;),
</a><a href="#h9-0-9" id="h9-0-9" class="i">+    pretty_name: &quot;livegrep&quot;,
</a><a href="#h9-0-10" id="h9-0-10" class="i">+    repos: [
</a><a href="#h9-0-11" id="h9-0-11" class="i">+      {
</a><a href="#h9-0-12" id="h9-0-12" class="i">+        path: path.join(__dirname, &quot;..&quot;),
</a><a href="#h9-0-13" id="h9-0-13" class="i">+        name: &quot;Livegrep&quot;,
</a><a href="#h9-0-14" id="h9-0-14" class="i">+        refs: [&quot;HEAD&quot;],
</a><a href="#h9-0-15" id="h9-0-15" class="i">+        github: &quot;nelhage/codesearch&quot;,
</a><a href="#h9-0-16" id="h9-0-16" class="i">+      },
</a><a href="#h9-0-17" id="h9-0-17" class="i">+    ],
</a><a href="#h9-0-18" id="h9-0-18" class="i">+    sort: [],
</a><a href="#h9-0-19" id="h9-0-19" class="i">+  },
</a><a href="#h9-0-20" id="h9-0-20" class="i">+  random: {
</a><a href="#h9-0-21" id="h9-0-21" class="i">+    host: &quot;localhost&quot;,
</a><a href="#h9-0-22" id="h9-0-22" class="i">+    port: 0xC5EB,
</a><a href="#h9-0-23" id="h9-0-23" class="i">+    connections: 4,
</a><a href="#h9-0-24" id="h9-0-24" class="i">+    index: path.join(__dirname, &quot;random.idx&quot;),
</a><a href="#h9-0-25" id="h9-0-25" class="i">+    pretty_name: &quot;Random Crap&quot;,
</a><a href="#h9-0-26" id="h9-0-26" class="i">+    repos: [
</a><a href="#h9-0-27" id="h9-0-27" class="i">+      {
</a><a href="#h9-0-28" id="h9-0-28" class="i">+        path: &#39;/home/nelhage/code/mosh&#39;,
</a><a href="#h9-0-29" id="h9-0-29" class="i">+        name: &quot;mosh&quot;,
</a><a href="#h9-0-30" id="h9-0-30" class="i">+        refs: [&quot;HEAD&quot;],
</a><a href="#h9-0-31" id="h9-0-31" class="i">+        github: &quot;keithw/mosh&quot;,
</a><a href="#h9-0-32" id="h9-0-32" class="i">+      },
</a><a href="#h9-0-33" id="h9-0-33" class="i">+      {
</a><a href="#h9-0-34" id="h9-0-34" class="i">+        path: &#39;/home/nelhage/code/meteor&#39;,
</a><a href="#h9-0-35" id="h9-0-35" class="i">+        name: &quot;meteor&quot;,
</a><a href="#h9-0-36" id="h9-0-36" class="i">+        refs: [&quot;HEAD&quot;],
</a><a href="#h9-0-37" id="h9-0-37" class="i">+        github: &quot;meteor/meteor&quot;,
</a><a href="#h9-0-38" id="h9-0-38" class="i">+      },
</a><a href="#h9-0-39" id="h9-0-39" class="i">+    ],
</a><a href="#h9-0-40" id="h9-0-40" class="i">+    sort: [],
</a><a href="#h9-0-41" id="h9-0-41" class="i">+  }}
</a><a href="#h9-0-42" id="h9-0-42" class="i">+};
</a><a href="#h9-0-43" id="h9-0-43" class="i">+*/
</a><a href="#h9-0-44" id="h9-0-44" class="i">+
</a><a href="#h9-0-45" id="h9-0-45" class="i">+module.exports = {
</a><a href="#h9-0-46" id="h9-0-46" class="i">+  BACKENDS: {&#39;avr-libc&#39;: {
</a><a href="#h9-0-47" id="h9-0-47" class="i">+    host: &quot;localhost&quot;,
</a><a href="#h9-0-48" id="h9-0-48" class="i">+    port: 0xC5EA,
</a><a href="#h9-0-49" id="h9-0-49" class="i">+    connections: 4,
</a><a href="#h9-0-50" id="h9-0-50" class="i">+    index: path.join(__dirname, &quot;avr-libc.idx&quot;),
</a><a href="#h9-0-51" id="h9-0-51" class="i">+    pretty_name: &quot;AVR libc&quot;,
</a><a href="#h9-0-52" id="h9-0-52" class="i">+    repos: [
</a><a href="#h9-0-53" id="h9-0-53" class="i">+      {
</a><a href="#h9-0-54" id="h9-0-54" class="i">+        path: &#39;/home/nelhage/src/avr-libc/&#39;,
</a><a href="#h9-0-55" id="h9-0-55" class="i">+        name: &quot;AVR libc&quot;,
</a><a href="#h9-0-56" id="h9-0-56" class="i">+        refs: [&quot;HEAD&quot;],
</a><a href="#h9-0-57" id="h9-0-57" class="i">+        github: &quot;&quot;,
</a><a href="#h9-0-58" id="h9-0-58" class="i">+      },
</a><a href="#h9-0-59" id="h9-0-59" class="i">+    ],
</a><a href="#h9-0-60" id="h9-0-60" class="i">+    sort: [],
</a><a href="#h9-0-61" id="h9-0-61" class="i">+  }}
</a><a href="#h9-0-62" id="h9-0-62" class="i">+};
</a><b>diff --git a/<a id="h10" href="../file/web/git_util.js">web/git_util.js</a> b/<a href="../file/js/git_util.js">js/git_util.js</a></b>
<b>diff --git a/<a id="h11" href="../file/web/lib/parseopt.js">web/lib/parseopt.js</a> b/<a href="../file/js/lib/parseopt.js">js/lib/parseopt.js</a></b>
<b>diff --git a/<a id="h12" href="../file/web/lib/query-stats.js">web/lib/query-stats.js</a> b/<a href="../file/js/lib/query-stats.js">js/lib/query-stats.js</a></b>
<b>diff --git a/<a id="h13" href="../file/web/lib/stats.js">web/lib/stats.js</a> b/<a href="../file/js/lib/stats.js">js/lib/stats.js</a></b>
<b>diff --git a/<a id="h14" href="../file/web/log4js.json">web/log4js.json</a> b/<a href="../file/js/log4js.json">js/log4js.json</a></b>
<b>diff --git a/<a id="h15" href="../file/web/parse-log.js">web/parse-log.js</a> b/<a href="../file/js/parse-log.js">js/parse-log.js</a></b>
<b>diff --git a/<a id="h16" href="../file/web/util.js">web/util.js</a> b/<a href="../file/js/util.js">js/util.js</a></b>
<b>diff --git a/<a id="h17" href="../file/test/bench.js">test/bench.js</a> b/<a href="../file/test/bench.js">test/bench.js</a></b>
<a href="#h17-0" id="h17-0" class="h">@@ -1,9 +1,9 @@
</a><a href="#h17-0-0" id="h17-0-0" class="d">-var Codesearch = require(&#39;../web/codesearch.js&#39;),
</a><a href="#h17-0-1" id="h17-0-1" class="i">+var Codesearch = require(&#39;../js/codesearch.js&#39;),
</a>     fs         = require(&#39;fs&#39;),
     path       = require(&#39;path&#39;),
     printf     = require(&#39;printf&#39;),
     common     = require(&#39;./common.js&#39;),
<a href="#h17-0-6" id="h17-0-6" class="d">-    stats      = require(&#39;../lib/stats.js&#39;);
</a><a href="#h17-0-7" id="h17-0-7" class="i">+    stats      = require(&#39;../js/lib/stats.js&#39;);
</a> 
 common.parser.add(&#39;--dump-stats&#39;, {type: &#39;string&#39;, target: &#39;dump_stats&#39;});
 common.parser.add(&#39;--load-stats&#39;, {type: &#39;string&#39;, target: &#39;load_stats&#39;});
<b>diff --git a/<a id="h18" href="../file/test/common.js">test/common.js</a> b/<a href="../file/test/common.js">test/common.js</a></b>
<a href="#h18-0" id="h18-0" class="h">@@ -1,7 +1,7 @@
</a><a href="#h18-0-0" id="h18-0-0" class="d">-var Codesearch = require(&#39;../web/codesearch.js&#39;),
</a><a href="#h18-0-1" id="h18-0-1" class="i">+var Codesearch = require(&#39;../js/codesearch.js&#39;),
</a>     fs         = require(&#39;fs&#39;),
     path       = require(&#39;path&#39;),
<a href="#h18-0-4" id="h18-0-4" class="d">-    parseopt   = require(&#39;../web/lib/parseopt.js&#39;),
</a><a href="#h18-0-5" id="h18-0-5" class="i">+    parseopt   = require(&#39;../js/lib/parseopt.js&#39;),
</a>     log4js     = require(&#39;log4js&#39;);
 
 var config = JSON.parse(fs.readFileSync(path.join(__dirname, &quot;config.json&quot;)));
<b>diff --git a/<a id="h19" href="../file/test/test.js">test/test.js</a> b/<a href="../file/test/test.js">test/test.js</a></b>
<a href="#h19-0" id="h19-0" class="h">@@ -1,4 +1,4 @@
</a><a href="#h19-0-0" id="h19-0-0" class="d">-var Codesearch = require(&#39;../web/codesearch.js&#39;),
</a><a href="#h19-0-1" id="h19-0-1" class="i">+var Codesearch = require(&#39;../js/codesearch.js&#39;),
</a>     fs         = require(&#39;fs&#39;),
     assert     = require(&#39;assert&#39;),
     path       = require(&#39;path&#39;),
<b>diff --git a/<a id="h20" href="../file/web/cs_server.js">web/cs_server.js</a> b/<a href="../file/web/cs_server.js">web/cs_server.js</a></b>
<a href="#h20-0" id="h20-0" class="h">@@ -1,101 +0,0 @@
</a><a href="#h20-0-0" id="h20-0-0" class="d">-#!/usr/bin/env node
</a><a href="#h20-0-1" id="h20-0-1" class="d">-var dnode   = require(&#39;dnode&#39;),
</a><a href="#h20-0-2" id="h20-0-2" class="d">-    path    = require(&#39;path&#39;),
</a><a href="#h20-0-3" id="h20-0-3" class="d">-    net     = require(&#39;net&#39;),
</a><a href="#h20-0-4" id="h20-0-4" class="d">-    config  = require(&#39;./config.js&#39;),
</a><a href="#h20-0-5" id="h20-0-5" class="d">-    git_util   = require(&#39;./git_util.js&#39;),
</a><a href="#h20-0-6" id="h20-0-6" class="d">-    util       = require(&#39;./util.js&#39;),
</a><a href="#h20-0-7" id="h20-0-7" class="d">-    Codesearch = require(&#39;./codesearch.js&#39;),
</a><a href="#h20-0-8" id="h20-0-8" class="d">-    Batch      = require(&#39;./batch.js&#39;),
</a><a href="#h20-0-9" id="h20-0-9" class="d">-    parseopt   = require(&#39;./lib/parseopt.js&#39;),
</a><a href="#h20-0-10" id="h20-0-10" class="d">-    backend    = require(&#39;./backend.js&#39;),
</a><a href="#h20-0-11" id="h20-0-11" class="d">-    Einhorn    = require(&#39;einhorn&#39;);
</a><a href="#h20-0-12" id="h20-0-12" class="d">-
</a><a href="#h20-0-13" id="h20-0-13" class="d">-function Client(parent, remote) {
</a><a href="#h20-0-14" id="h20-0-14" class="d">-  var self = this;
</a><a href="#h20-0-15" id="h20-0-15" class="d">-  this.parent = parent;
</a><a href="#h20-0-16" id="h20-0-16" class="d">-  this.remote = remote;
</a><a href="#h20-0-17" id="h20-0-17" class="d">-  this.queue  = [];
</a><a href="#h20-0-18" id="h20-0-18" class="d">-  this.conn   = parent.codesearch.connect();
</a><a href="#h20-0-19" id="h20-0-19" class="d">-  this.conn.on(&#39;ready&#39;, function() {
</a><a href="#h20-0-20" id="h20-0-20" class="d">-                 var q;
</a><a href="#h20-0-21" id="h20-0-21" class="d">-                 if (self.queue.length) {
</a><a href="#h20-0-22" id="h20-0-22" class="d">-                   q = self.queue.shift();
</a><a href="#h20-0-23" id="h20-0-23" class="d">-                   self.search(q.search, q.cb);
</a><a href="#h20-0-24" id="h20-0-24" class="d">-                 } else {
</a><a href="#h20-0-25" id="h20-0-25" class="d">-                   self.ready();
</a><a href="#h20-0-26" id="h20-0-26" class="d">-                 }
</a><a href="#h20-0-27" id="h20-0-27" class="d">-               });
</a><a href="#h20-0-28" id="h20-0-28" class="d">-}
</a><a href="#h20-0-29" id="h20-0-29" class="d">-
</a><a href="#h20-0-30" id="h20-0-30" class="d">-Client.prototype.ready = function() {
</a><a href="#h20-0-31" id="h20-0-31" class="d">-  if (this.remote.ready)
</a><a href="#h20-0-32" id="h20-0-32" class="d">-    util.remote_call(this.remote, &#39;ready&#39;);
</a><a href="#h20-0-33" id="h20-0-33" class="d">-}
</a><a href="#h20-0-34" id="h20-0-34" class="d">-
</a><a href="#h20-0-35" id="h20-0-35" class="d">-Client.prototype.search = function (search, cb) {
</a><a href="#h20-0-36" id="h20-0-36" class="d">-  if (this.conn.readyState !== &#39;ready&#39;) {
</a><a href="#h20-0-37" id="h20-0-37" class="d">-    this.queue.push({
</a><a href="#h20-0-38" id="h20-0-38" class="d">-                      search: search,
</a><a href="#h20-0-39" id="h20-0-39" class="d">-                      cb: cb
</a><a href="#h20-0-40" id="h20-0-40" class="d">-                    });
</a><a href="#h20-0-41" id="h20-0-41" class="d">-    return;
</a><a href="#h20-0-42" id="h20-0-42" class="d">-  }
</a><a href="#h20-0-43" id="h20-0-43" class="d">-  var search = this.conn.search(search.line, search.file, search.repo);
</a><a href="#h20-0-44" id="h20-0-44" class="d">-  var batch  = new Batch(function (m) {
</a><a href="#h20-0-45" id="h20-0-45" class="d">-                           util.remote_call(cb, &#39;match&#39;, m);
</a><a href="#h20-0-46" id="h20-0-46" class="d">-                         }, 50);
</a><a href="#h20-0-47" id="h20-0-47" class="d">-  search.on(&#39;error&#39;, util.remote_call.bind(null, cb, &#39;error&#39;));
</a><a href="#h20-0-48" id="h20-0-48" class="d">-  search.on(&#39;done&#39;,  function () {
</a><a href="#h20-0-49" id="h20-0-49" class="d">-              batch.flush();
</a><a href="#h20-0-50" id="h20-0-50" class="d">-              util.remote_call.apply(null, [cb, &#39;done&#39;].concat(Array.prototype.slice.call(arguments)));
</a><a href="#h20-0-51" id="h20-0-51" class="d">-            });
</a><a href="#h20-0-52" id="h20-0-52" class="d">-  search.on(&#39;match&#39;, batch.send.bind(batch));
</a><a href="#h20-0-53" id="h20-0-53" class="d">-}
</a><a href="#h20-0-54" id="h20-0-54" class="d">-
</a><a href="#h20-0-55" id="h20-0-55" class="d">-function Server(backend) {
</a><a href="#h20-0-56" id="h20-0-56" class="d">-  var parent = this;
</a><a href="#h20-0-57" id="h20-0-57" class="d">-  this.clients = [];
</a><a href="#h20-0-58" id="h20-0-58" class="d">-
</a><a href="#h20-0-59" id="h20-0-59" class="d">-  this.codesearch = new Codesearch(backend.repo, [], {
</a><a href="#h20-0-60" id="h20-0-60" class="d">-                                     args: [&#39;--load_index&#39;, backend.index].concat(backend.search_args || [])
</a><a href="#h20-0-61" id="h20-0-61" class="d">-                                   });
</a><a href="#h20-0-62" id="h20-0-62" class="d">-  this.Server = function (remote, conn) {
</a><a href="#h20-0-63" id="h20-0-63" class="d">-    parent.clients[conn.id] = new Client(parent, remote);
</a><a href="#h20-0-64" id="h20-0-64" class="d">-    conn.on(&#39;end&#39;, function() {
</a><a href="#h20-0-65" id="h20-0-65" class="d">-              var client = parent.clients[conn.id];
</a><a href="#h20-0-66" id="h20-0-66" class="d">-              delete parent.clients[conn.id];
</a><a href="#h20-0-67" id="h20-0-67" class="d">-            });
</a><a href="#h20-0-68" id="h20-0-68" class="d">-    this.try_search = function(search, cb) {
</a><a href="#h20-0-69" id="h20-0-69" class="d">-      if (parent.clients[conn.id].conn.readyState !== &#39;ready&#39;) {
</a><a href="#h20-0-70" id="h20-0-70" class="d">-        util.remote_call(cb, &#39;not_ready&#39;);
</a><a href="#h20-0-71" id="h20-0-71" class="d">-        return;
</a><a href="#h20-0-72" id="h20-0-72" class="d">-      }
</a><a href="#h20-0-73" id="h20-0-73" class="d">-      parent.clients[conn.id].search(search, cb);
</a><a href="#h20-0-74" id="h20-0-74" class="d">-    }
</a><a href="#h20-0-75" id="h20-0-75" class="d">-    this.search = function(search, cb) {
</a><a href="#h20-0-76" id="h20-0-76" class="d">-      parent.clients[conn.id].search(search, cb);
</a><a href="#h20-0-77" id="h20-0-77" class="d">-    }
</a><a href="#h20-0-78" id="h20-0-78" class="d">-  }
</a><a href="#h20-0-79" id="h20-0-79" class="d">-}
</a><a href="#h20-0-80" id="h20-0-80" class="d">-
</a><a href="#h20-0-81" id="h20-0-81" class="d">-var parser = new parseopt.OptionParser();
</a><a href="#h20-0-82" id="h20-0-82" class="d">-backend.addBackendOpt(config, parser);
</a><a href="#h20-0-83" id="h20-0-83" class="d">-
</a><a href="#h20-0-84" id="h20-0-84" class="d">-var opts = parser.parse(process.argv);
</a><a href="#h20-0-85" id="h20-0-85" class="d">-
</a><a href="#h20-0-86" id="h20-0-86" class="d">-var backend = backend.selectBackend(config, opts);
</a><a href="#h20-0-87" id="h20-0-87" class="d">-
</a><a href="#h20-0-88" id="h20-0-88" class="d">-if (Einhorn.is_worker()) {
</a><a href="#h20-0-89" id="h20-0-89" class="d">-  Einhorn.ack();
</a><a href="#h20-0-90" id="h20-0-90" class="d">-  var app = new Server(backend).Server;
</a><a href="#h20-0-91" id="h20-0-91" class="d">-  var srv = net.createServer(function (c) {
</a><a href="#h20-0-92" id="h20-0-92" class="d">-    var d = dnode(app);
</a><a href="#h20-0-93" id="h20-0-93" class="d">-    c.pipe(d).pipe(c);
</a><a href="#h20-0-94" id="h20-0-94" class="d">-  });
</a><a href="#h20-0-95" id="h20-0-95" class="d">-  var fd = Einhorn.socket();
</a><a href="#h20-0-96" id="h20-0-96" class="d">-  srv.listen({fd: fd});
</a><a href="#h20-0-97" id="h20-0-97" class="d">-} else {
</a><a href="#h20-0-98" id="h20-0-98" class="d">-  var server = dnode(new Server(backend).Server);
</a><a href="#h20-0-99" id="h20-0-99" class="d">-  server.listen(backend.port);
</a><a href="#h20-0-100" id="h20-0-100" class="d">-}
</a><b>diff --git a/<a id="h21" href="../file/web/index.js">web/index.js</a> b/<a href="../file/web/index.js">web/index.js</a></b>
<a href="#h21-0" id="h21-0" class="h">@@ -1,44 +0,0 @@
</a><a href="#h21-0-0" id="h21-0-0" class="d">-#!/usr/bin/env node
</a><a href="#h21-0-1" id="h21-0-1" class="d">-var path    = require(&#39;path&#39;),
</a><a href="#h21-0-2" id="h21-0-2" class="d">-    fs      = require(&#39;fs&#39;),
</a><a href="#h21-0-3" id="h21-0-3" class="d">-    config  = require(&#39;./config.js&#39;),
</a><a href="#h21-0-4" id="h21-0-4" class="d">-    backend = require(&#39;./backend.js&#39;),
</a><a href="#h21-0-5" id="h21-0-5" class="d">-    parseopt= require(&#39;./lib/parseopt.js&#39;),
</a><a href="#h21-0-6" id="h21-0-6" class="d">-    spawn   = require(&#39;child_process&#39;).spawn;
</a><a href="#h21-0-7" id="h21-0-7" class="d">-
</a><a href="#h21-0-8" id="h21-0-8" class="d">-function generateIndex(backend, cb) {
</a><a href="#h21-0-9" id="h21-0-9" class="d">-  console.log(&quot;Generating index file: %s&quot;, backend.index);
</a><a href="#h21-0-10" id="h21-0-10" class="d">-
</a><a href="#h21-0-11" id="h21-0-11" class="d">-  var tmp = backend.index + &quot;.tmp&quot;;
</a><a href="#h21-0-12" id="h21-0-12" class="d">-
</a><a href="#h21-0-13" id="h21-0-13" class="d">-  var repos = backend.repos.map(function (repo) {
</a><a href="#h21-0-14" id="h21-0-14" class="d">-    return (repo.name ? repo.name + &quot;@&quot; : &quot;&quot;) +
</a><a href="#h21-0-15" id="h21-0-15" class="d">-      repo.path + &quot;:&quot; + repo.refs.join(&quot;,&quot;);
</a><a href="#h21-0-16" id="h21-0-16" class="d">-    });
</a><a href="#h21-0-17" id="h21-0-17" class="d">-
</a><a href="#h21-0-18" id="h21-0-18" class="d">-  var cs = spawn(path.join(__dirname, &#39;..&#39;, &#39;codesearch&#39;),
</a><a href="#h21-0-19" id="h21-0-19" class="d">-                 [&#39;--dump_index&#39;, tmp,
</a><a href="#h21-0-20" id="h21-0-20" class="d">-                  &#39;--order_root&#39;, backend.sort.join(&#39; &#39;),
</a><a href="#h21-0-21" id="h21-0-21" class="d">-                 ].concat(repos),
</a><a href="#h21-0-22" id="h21-0-22" class="d">-                 {
</a><a href="#h21-0-23" id="h21-0-23" class="d">-                   customFds: [-1, 1, 2]
</a><a href="#h21-0-24" id="h21-0-24" class="d">-                 });
</a><a href="#h21-0-25" id="h21-0-25" class="d">-  cs.on(&#39;exit&#39;, function(code, signal) {
</a><a href="#h21-0-26" id="h21-0-26" class="d">-          if (code !== 0) {
</a><a href="#h21-0-27" id="h21-0-27" class="d">-            console.error(&quot;Index process exited with %s&quot;, code ? (&quot;error &quot; + code) : &quot;signal &quot; + signal);
</a><a href="#h21-0-28" id="h21-0-28" class="d">-          } else {
</a><a href="#h21-0-29" id="h21-0-29" class="d">-            fs.renameSync(tmp, backend.index);
</a><a href="#h21-0-30" id="h21-0-30" class="d">-          }
</a><a href="#h21-0-31" id="h21-0-31" class="d">-          cb();
</a><a href="#h21-0-32" id="h21-0-32" class="d">-        });
</a><a href="#h21-0-33" id="h21-0-33" class="d">-  cs.stdin.end();
</a><a href="#h21-0-34" id="h21-0-34" class="d">-}
</a><a href="#h21-0-35" id="h21-0-35" class="d">-
</a><a href="#h21-0-36" id="h21-0-36" class="d">-var parser = new parseopt.OptionParser();
</a><a href="#h21-0-37" id="h21-0-37" class="d">-backend.addBackendOpt(config, parser);
</a><a href="#h21-0-38" id="h21-0-38" class="d">-
</a><a href="#h21-0-39" id="h21-0-39" class="d">-var opts = parser.parse(process.argv);
</a><a href="#h21-0-40" id="h21-0-40" class="d">-generateIndex(backend.selectBackend(config, opts),
</a><a href="#h21-0-41" id="h21-0-41" class="d">-             function () {
</a><a href="#h21-0-42" id="h21-0-42" class="d">-               process.exit(0);
</a><a href="#h21-0-43" id="h21-0-43" class="d">-             });
</a><b>diff --git a/<a id="h22" href="../file/web/web_server.js">web/web_server.js</a> b/<a href="../file/web/web_server.js">web/web_server.js</a></b>
<a href="#h22-0" id="h22-0" class="h">@@ -1,196 +0,0 @@
</a><a href="#h22-0-0" id="h22-0-0" class="d">-#!/usr/bin/env node
</a><a href="#h22-0-1" id="h22-0-1" class="d">-var express = require(&#39;express&#39;),
</a><a href="#h22-0-2" id="h22-0-2" class="d">-    http    = require(&#39;http&#39;),
</a><a href="#h22-0-3" id="h22-0-3" class="d">-    hbs     = require(&#39;hbs&#39;),
</a><a href="#h22-0-4" id="h22-0-4" class="d">-    extras  = require(&#39;express-extras&#39;),
</a><a href="#h22-0-5" id="h22-0-5" class="d">-    path    = require(&#39;path&#39;),
</a><a href="#h22-0-6" id="h22-0-6" class="d">-    parseopt= require(&#39;parseopt&#39;),
</a><a href="#h22-0-7" id="h22-0-7" class="d">-    log4js  = require(&#39;log4js&#39;),
</a><a href="#h22-0-8" id="h22-0-8" class="d">-    email   = require(&#39;emailjs&#39;),
</a><a href="#h22-0-9" id="h22-0-9" class="d">-    util    = require(&#39;util&#39;),
</a><a href="#h22-0-10" id="h22-0-10" class="d">-    Server  = require(&#39;./appserver.js&#39;),
</a><a href="#h22-0-11" id="h22-0-11" class="d">-    config  = require(&#39;./config.js&#39;),
</a><a href="#h22-0-12" id="h22-0-12" class="d">-    Einhorn = require(&#39;einhorn&#39;);
</a><a href="#h22-0-13" id="h22-0-13" class="d">-
</a><a href="#h22-0-14" id="h22-0-14" class="d">-function shorten(ref) {
</a><a href="#h22-0-15" id="h22-0-15" class="d">-  var match = /^refs\/(tags|branches)\/(.*)/.exec(ref);
</a><a href="#h22-0-16" id="h22-0-16" class="d">-  if (match)
</a><a href="#h22-0-17" id="h22-0-17" class="d">-    return match[2];
</a><a href="#h22-0-18" id="h22-0-18" class="d">-  return ref;
</a><a href="#h22-0-19" id="h22-0-19" class="d">-}
</a><a href="#h22-0-20" id="h22-0-20" class="d">-
</a><a href="#h22-0-21" id="h22-0-21" class="d">-var parser = new parseopt.OptionParser(
</a><a href="#h22-0-22" id="h22-0-22" class="d">-  {
</a><a href="#h22-0-23" id="h22-0-23" class="d">-    options: [
</a><a href="#h22-0-24" id="h22-0-24" class="d">-      {
</a><a href="#h22-0-25" id="h22-0-25" class="d">-        name: &quot;--autolaunch&quot;,
</a><a href="#h22-0-26" id="h22-0-26" class="d">-        default: false,
</a><a href="#h22-0-27" id="h22-0-27" class="d">-        type: &#39;flag&#39;,
</a><a href="#h22-0-28" id="h22-0-28" class="d">-        help: &#39;Automatically launch a code-search backend server.&#39;
</a><a href="#h22-0-29" id="h22-0-29" class="d">-      },
</a><a href="#h22-0-30" id="h22-0-30" class="d">-      {
</a><a href="#h22-0-31" id="h22-0-31" class="d">-        name: &quot;--production&quot;,
</a><a href="#h22-0-32" id="h22-0-32" class="d">-        default: false,
</a><a href="#h22-0-33" id="h22-0-33" class="d">-        type: &#39;flag&#39;,
</a><a href="#h22-0-34" id="h22-0-34" class="d">-        help: &#39;Enable options for a production deployment.&#39;
</a><a href="#h22-0-35" id="h22-0-35" class="d">-      }
</a><a href="#h22-0-36" id="h22-0-36" class="d">-    ]
</a><a href="#h22-0-37" id="h22-0-37" class="d">-  });
</a><a href="#h22-0-38" id="h22-0-38" class="d">-
</a><a href="#h22-0-39" id="h22-0-39" class="d">-var opts = parser.parse();
</a><a href="#h22-0-40" id="h22-0-40" class="d">-if (!opts) {
</a><a href="#h22-0-41" id="h22-0-41" class="d">-  process.exit(1);
</a><a href="#h22-0-42" id="h22-0-42" class="d">-}
</a><a href="#h22-0-43" id="h22-0-43" class="d">-
</a><a href="#h22-0-44" id="h22-0-44" class="d">-if (opts.options.autolaunch) {
</a><a href="#h22-0-45" id="h22-0-45" class="d">-  console.log(&quot;Autolaunching a back-end server...&quot;);
</a><a href="#h22-0-46" id="h22-0-46" class="d">-  require(&#39;./cs_server.js&#39;)
</a><a href="#h22-0-47" id="h22-0-47" class="d">-}
</a><a href="#h22-0-48" id="h22-0-48" class="d">-
</a><a href="#h22-0-49" id="h22-0-49" class="d">-var smtp = null;
</a><a href="#h22-0-50" id="h22-0-50" class="d">-if (config.SMTP_CONFIG) {
</a><a href="#h22-0-51" id="h22-0-51" class="d">-  smtp = email.server.connect(config.SMTP_CONFIG);
</a><a href="#h22-0-52" id="h22-0-52" class="d">-}
</a><a href="#h22-0-53" id="h22-0-53" class="d">-
</a><a href="#h22-0-54" id="h22-0-54" class="d">-var app = express();
</a><a href="#h22-0-55" id="h22-0-55" class="d">-var logger = log4js.getLogger(&#39;web&#39;);
</a><a href="#h22-0-56" id="h22-0-56" class="d">-
</a><a href="#h22-0-57" id="h22-0-57" class="d">-app.configure(
</a><a href="#h22-0-58" id="h22-0-58" class="d">-  function() {
</a><a href="#h22-0-59" id="h22-0-59" class="d">-    app.use(extras.fixIP());
</a><a href="#h22-0-60" id="h22-0-60" class="d">-    app.use(log4js.connectLogger(logger, {
</a><a href="#h22-0-61" id="h22-0-61" class="d">-                                   level: log4js.levels.INFO,
</a><a href="#h22-0-62" id="h22-0-62" class="d">-                                   format: function (req, res, fmt) {
</a><a href="#h22-0-63" id="h22-0-63" class="d">-                                     return &#39;&#39; + req.ip + fmt(&#39; [:date] :method :url&#39;);
</a><a href="#h22-0-64" id="h22-0-64" class="d">-                                   }
</a><a href="#h22-0-65" id="h22-0-65" class="d">-                                 }));
</a><a href="#h22-0-66" id="h22-0-66" class="d">-    app.engine(&#39;.html&#39;, hbs.__express);
</a><a href="#h22-0-67" id="h22-0-67" class="d">-    app.set(&#39;view engine&#39;, &#39;html&#39;);
</a><a href="#h22-0-68" id="h22-0-68" class="d">-    app.set(&#39;view options&#39;, {
</a><a href="#h22-0-69" id="h22-0-69" class="d">-              production: opts.options.production
</a><a href="#h22-0-70" id="h22-0-70" class="d">-            });
</a><a href="#h22-0-71" id="h22-0-71" class="d">-    app.set(&#39;views&#39;, path.join(__dirname, &#39;templates&#39;));
</a><a href="#h22-0-72" id="h22-0-72" class="d">-    app.use(express.bodyParser());
</a><a href="#h22-0-73" id="h22-0-73" class="d">-    app.use(express.static(path.join(__dirname, &#39;htdocs&#39;)));
</a><a href="#h22-0-74" id="h22-0-74" class="d">-    hbs.handlebars.registerHelper(&#39;json&#39;, function (data) {
</a><a href="#h22-0-75" id="h22-0-75" class="d">-      return new hbs.handlebars.SafeString(JSON.stringify(data).replace(/&lt;\/script&gt;/g, &#39;&lt;\\/script&gt;&#39;));
</a><a href="#h22-0-76" id="h22-0-76" class="d">-    });
</a><a href="#h22-0-77" id="h22-0-77" class="d">-  });
</a><a href="#h22-0-78" id="h22-0-78" class="d">-
</a><a href="#h22-0-79" id="h22-0-79" class="d">-app.get(&#39;/&#39;, function (req, res) {res.redirect(&#39;/search&#39;);});
</a><a href="#h22-0-80" id="h22-0-80" class="d">-function searchHandler (req, res) {
</a><a href="#h22-0-81" id="h22-0-81" class="d">-  var repo_map = {};
</a><a href="#h22-0-82" id="h22-0-82" class="d">-  Object.keys(config.BACKENDS).forEach(function (name) {
</a><a href="#h22-0-83" id="h22-0-83" class="d">-    var backend = config.BACKENDS[name];
</a><a href="#h22-0-84" id="h22-0-84" class="d">-    repo_map[name] = {};
</a><a href="#h22-0-85" id="h22-0-85" class="d">-    backend.repos.forEach(function (repo) {
</a><a href="#h22-0-86" id="h22-0-86" class="d">-      repo_map[name][repo.name] = repo.github;
</a><a href="#h22-0-87" id="h22-0-87" class="d">-    });
</a><a href="#h22-0-88" id="h22-0-88" class="d">-  });
</a><a href="#h22-0-89" id="h22-0-89" class="d">-  res.render(&#39;index&#39;,
</a><a href="#h22-0-90" id="h22-0-90" class="d">-             {
</a><a href="#h22-0-91" id="h22-0-91" class="d">-               js: true,
</a><a href="#h22-0-92" id="h22-0-92" class="d">-               title: &#39;search&#39;,
</a><a href="#h22-0-93" id="h22-0-93" class="d">-               repos: Object.keys(config.BACKENDS).map(function (name) {
</a><a href="#h22-0-94" id="h22-0-94" class="d">-                 var backend = config.BACKENDS[name];
</a><a href="#h22-0-95" id="h22-0-95" class="d">-                 return {
</a><a href="#h22-0-96" id="h22-0-96" class="d">-                   name: name,
</a><a href="#h22-0-97" id="h22-0-97" class="d">-                   pretty: backend.pretty_name
</a><a href="#h22-0-98" id="h22-0-98" class="d">-                 };
</a><a href="#h22-0-99" id="h22-0-99" class="d">-               }),
</a><a href="#h22-0-100" id="h22-0-100" class="d">-               multi_repo: Object.keys(config.BACKENDS).length &gt; 1,
</a><a href="#h22-0-101" id="h22-0-101" class="d">-               repo_name: (config.BACKENDS[&#39;&#39;]||{}).pretty_name,
</a><a href="#h22-0-102" id="h22-0-102" class="d">-               github_repos: repo_map,
</a><a href="#h22-0-103" id="h22-0-103" class="d">-               production: opts.options.production
</a><a href="#h22-0-104" id="h22-0-104" class="d">-             });
</a><a href="#h22-0-105" id="h22-0-105" class="d">-}
</a><a href="#h22-0-106" id="h22-0-106" class="d">-app.get(&#39;/search&#39;, searchHandler);
</a><a href="#h22-0-107" id="h22-0-107" class="d">-app.get(&#39;/search/:backend&#39;, searchHandler);
</a><a href="#h22-0-108" id="h22-0-108" class="d">-app.get(&#39;/about&#39;, function (req, res) {
</a><a href="#h22-0-109" id="h22-0-109" class="d">-          res.render(&#39;about&#39;,
</a><a href="#h22-0-110" id="h22-0-110" class="d">-                     {
</a><a href="#h22-0-111" id="h22-0-111" class="d">-                       title: &#39;about&#39;,
</a><a href="#h22-0-112" id="h22-0-112" class="d">-                       production: opts.options.production
</a><a href="#h22-0-113" id="h22-0-113" class="d">-                     });
</a><a href="#h22-0-114" id="h22-0-114" class="d">-        });
</a><a href="#h22-0-115" id="h22-0-115" class="d">-function send_feedback(data, cb) {
</a><a href="#h22-0-116" id="h22-0-116" class="d">-  if (smtp) {
</a><a href="#h22-0-117" id="h22-0-117" class="d">-    smtp.send({
</a><a href="#h22-0-118" id="h22-0-118" class="d">-                to: &quot;Nelson Elhage &lt;feedback@livegrep.com&gt;&quot;,
</a><a href="#h22-0-119" id="h22-0-119" class="d">-                from: &quot;Codesearch &lt;mailer@livegrep.com&quot;,
</a><a href="#h22-0-120" id="h22-0-120" class="d">-                subject: &quot;Feedback from codesearch!&quot;,
</a><a href="#h22-0-121" id="h22-0-121" class="d">-                text: util.format(
</a><a href="#h22-0-122" id="h22-0-122" class="d">-                  &quot;Codesearch feedback from: %s \n&quot; +
</a><a href="#h22-0-123" id="h22-0-123" class="d">-                    &quot;IP: %s\n&quot; +
</a><a href="#h22-0-124" id="h22-0-124" class="d">-                    &quot;Session: %s\n\n&quot; +
</a><a href="#h22-0-125" id="h22-0-125" class="d">-                    &quot;%s&quot;,
</a><a href="#h22-0-126" id="h22-0-126" class="d">-                  data.email,
</a><a href="#h22-0-127" id="h22-0-127" class="d">-                  data.remoteAddress,
</a><a href="#h22-0-128" id="h22-0-128" class="d">-                  data.session,
</a><a href="#h22-0-129" id="h22-0-129" class="d">-                  data.text
</a><a href="#h22-0-130" id="h22-0-130" class="d">-                )
</a><a href="#h22-0-131" id="h22-0-131" class="d">-              }, function (err, message) {
</a><a href="#h22-0-132" id="h22-0-132" class="d">-                if (err) {
</a><a href="#h22-0-133" id="h22-0-133" class="d">-                  console.log(&quot;Error sending email!&quot;, err);
</a><a href="#h22-0-134" id="h22-0-134" class="d">-                  cb(err);
</a><a href="#h22-0-135" id="h22-0-135" class="d">-                } else {
</a><a href="#h22-0-136" id="h22-0-136" class="d">-                  console.log(&quot;Email sent!&quot;);
</a><a href="#h22-0-137" id="h22-0-137" class="d">-                  cb();
</a><a href="#h22-0-138" id="h22-0-138" class="d">-                }
</a><a href="#h22-0-139" id="h22-0-139" class="d">-              });
</a><a href="#h22-0-140" id="h22-0-140" class="d">-  } else {
</a><a href="#h22-0-141" id="h22-0-141" class="d">-    process.nextTick(cb);
</a><a href="#h22-0-142" id="h22-0-142" class="d">-  }
</a><a href="#h22-0-143" id="h22-0-143" class="d">-}
</a><a href="#h22-0-144" id="h22-0-144" class="d">-
</a><a href="#h22-0-145" id="h22-0-145" class="d">-app.post(&#39;/feedback&#39;, function (req, res) {
</a><a href="#h22-0-146" id="h22-0-146" class="d">-           console.log(&quot;FEEDBACK&quot;, req.body);
</a><a href="#h22-0-147" id="h22-0-147" class="d">-           if (!(&#39;data&#39; in req.body)) {
</a><a href="#h22-0-148" id="h22-0-148" class="d">-             res.send(400);
</a><a href="#h22-0-149" id="h22-0-149" class="d">-             return;
</a><a href="#h22-0-150" id="h22-0-150" class="d">-           }
</a><a href="#h22-0-151" id="h22-0-151" class="d">-           var data;
</a><a href="#h22-0-152" id="h22-0-152" class="d">-           try {
</a><a href="#h22-0-153" id="h22-0-153" class="d">-             data = JSON.parse(req.body.data);
</a><a href="#h22-0-154" id="h22-0-154" class="d">-           } catch(e) {
</a><a href="#h22-0-155" id="h22-0-155" class="d">-             console.log(&quot;Feedback error: %s&quot;, e);
</a><a href="#h22-0-156" id="h22-0-156" class="d">-             res.send(400);
</a><a href="#h22-0-157" id="h22-0-157" class="d">-             return;
</a><a href="#h22-0-158" id="h22-0-158" class="d">-           }
</a><a href="#h22-0-159" id="h22-0-159" class="d">-
</a><a href="#h22-0-160" id="h22-0-160" class="d">-           if (!data.email &amp;&amp; !data.text) {
</a><a href="#h22-0-161" id="h22-0-161" class="d">-             console.log(&quot;Empty feedback: %j&quot;, data);
</a><a href="#h22-0-162" id="h22-0-162" class="d">-             res.send(200);
</a><a href="#h22-0-163" id="h22-0-163" class="d">-             return;
</a><a href="#h22-0-164" id="h22-0-164" class="d">-           }
</a><a href="#h22-0-165" id="h22-0-165" class="d">-
</a><a href="#h22-0-166" id="h22-0-166" class="d">-           data.remoteAddress = req.connection.remoteAddress;
</a><a href="#h22-0-167" id="h22-0-167" class="d">-           send_feedback(data,
</a><a href="#h22-0-168" id="h22-0-168" class="d">-                         function (err) {
</a><a href="#h22-0-169" id="h22-0-169" class="d">-                           if (err) {
</a><a href="#h22-0-170" id="h22-0-170" class="d">-                             res.send(500);
</a><a href="#h22-0-171" id="h22-0-171" class="d">-                           } else {
</a><a href="#h22-0-172" id="h22-0-172" class="d">-                             res.send(200);
</a><a href="#h22-0-173" id="h22-0-173" class="d">-                           }
</a><a href="#h22-0-174" id="h22-0-174" class="d">-                         });
</a><a href="#h22-0-175" id="h22-0-175" class="d">-         });
</a><a href="#h22-0-176" id="h22-0-176" class="d">-
</a><a href="#h22-0-177" id="h22-0-177" class="d">-var server = http.createServer(app);
</a><a href="#h22-0-178" id="h22-0-178" class="d">-
</a><a href="#h22-0-179" id="h22-0-179" class="d">-if (Einhorn.is_worker()) {
</a><a href="#h22-0-180" id="h22-0-180" class="d">-  Einhorn.ack();
</a><a href="#h22-0-181" id="h22-0-181" class="d">-  var fd = Einhorn.socket();
</a><a href="#h22-0-182" id="h22-0-182" class="d">-  server.listen({fd: fd});
</a><a href="#h22-0-183" id="h22-0-183" class="d">-} else {
</a><a href="#h22-0-184" id="h22-0-184" class="d">-  server.listen(config.WEB_PORT);
</a><a href="#h22-0-185" id="h22-0-185" class="d">-  console.log(&quot;Listening on :%d.&quot;, config.WEB_PORT);
</a><a href="#h22-0-186" id="h22-0-186" class="d">-}
</a><a href="#h22-0-187" id="h22-0-187" class="d">-
</a><a href="#h22-0-188" id="h22-0-188" class="d">-var io = require(&#39;socket.io&#39;).listen(server, {
</a><a href="#h22-0-189" id="h22-0-189" class="d">-                                       logger: log4js.getLogger(&#39;socket.io&#39;),
</a><a href="#h22-0-190" id="h22-0-190" class="d">-                                       &#39;log level&#39;: log4js.levels.INFO
</a><a href="#h22-0-191" id="h22-0-191" class="d">-                                     });
</a><a href="#h22-0-192" id="h22-0-192" class="d">-if (config.SOCKET_IO_TRANSPORTS)
</a><a href="#h22-0-193" id="h22-0-193" class="d">-  io.set(&#39;transports&#39;, config.SOCKET_IO_TRANSPORTS);
</a><a href="#h22-0-194" id="h22-0-194" class="d">-
</a><a href="#h22-0-195" id="h22-0-195" class="d">-var server = new Server(config, io);
</a></pre>
</div>
</body>
</html>
