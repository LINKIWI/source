<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>flatten the data model a whole bunch - livegrep - Fast, regular expression code search service</title>
<meta name="description" content="Fast, regular expression code search service" />
<meta name="author" content="Kevin Lin" />
<link rel="icon" type="image/png" href="https://static.kevinlin.info/favicon.png" />
<link rel="alternate" type="application/atom+xml" title="livegrep Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="livegrep Atom Feed (tags)" href="../tags.xml" />
<style type="text/css">
body{color:#000;background-color:#fff;font-family:monospace}h1,h2,h3,h4,h5,h6{font-size:1em;margin:0}img,h1,h2{vertical-align:middle}img{border:0}a:target{background-color:#ccc}a.d,a.h,a.i{text-decoration:none}a.line{text-decoration:none;user-select:none}#blob a{color:#555}#blob a:hover{color:blue;text-decoration:none}table thead td{font-weight:bold}table td{padding:0 .4em}table td pre{margin:0}#content table td{vertical-align:top;white-space:nowrap}#branches tr:hover td,#tags tr:hover td,#index tr:hover td,#log tr:hover td,#files tr:hover td{background-color:#eee}#index tr td:nth-child(2),#tags tr td:nth-child(3),#branches tr td:nth-child(3),#log tr td:nth-child(2){white-space:normal}td.num{text-align:right}.desc{color:#555}hr{border:0;border-top:1px solid #555;height:1px}pre{font-family:monospace}pre a.h{color:#00a}.A,span.i,pre a.i{color:#070}.D,span.d,pre a.d{color:#e00}pre a.h:hover,pre a.i:hover,pre a.d:hover{text-decoration:none}
</style>
</head>
<body>
<table><tr><td><a href="/"><img src="https://static.kevinlin.info/favicon.png" alt="" width="32" height="32" /></a></td><td><h1>livegrep</h1><span class="desc">Fast, regular expression code search service</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://source.static.kevinlin.info/external/livegrep.git">https://source.static.kevinlin.info/external/livegrep.git</a></td></tr><tr><td></td><td>
<a href="../log">Log</a> | <a href="../files">Files</a> | <a href="../refs">Refs</a> | <a href="../file/README.md">README</a> | <a href="../file/COPYING">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/59a8b4f57a6a159c24f68ca1a85af03bb0a313d8">59a8b4f57a6a159c24f68ca1a85af03bb0a313d8</a>
<b>parent</b> <a href="../commit/bc142014c6539a06b920be8e7ecc4735ff62e678">bc142014c6539a06b920be8e7ecc4735ff62e678</a>
<b>Author:</b> Nelson Elhage &lt;<a href="mailto:nelhage@nelhage.com">nelhage@nelhage.com</a>&gt;
<b>Date:</b>   Sat 27 Sep 2014 15:42:30 -0700

flatten the data model a whole bunch

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">src/codesearch.cc</a></td><td> | </td><td class="num">168</td><td><span class="i">++++++++++++++++++</span><span class="d">-------------------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">src/codesearch.h</a></td><td> | </td><td class="num">29</td><td><span class="i">++++++</span><span class="d">-----------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">src/dump_load.cc</a></td><td> | </td><td class="num">52</td><td><span class="i">+++++++++++++++</span><span class="d">-------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">src/dump_load.h</a></td><td> | </td><td class="num">3</td><td><span class="i"></span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">src/fs_indexer.cc</a></td><td> | </td><td class="num">8</td><td><span class="i">++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">src/fs_indexer.h</a></td><td> | </td><td class="num">2</td><td><span class="i">++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">src/git_indexer.cc</a></td><td> | </td><td class="num">19</td><td><span class="i">+++++++</span><span class="d">------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">src/git_indexer.h</a></td><td> | </td><td class="num">7</td><td><span class="i">++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h8">src/tools/dump-file.cc</a></td><td> | </td><td class="num">8</td><td><span class="i">+++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h9">src/tools/inspect-index.cc</a></td><td> | </td><td class="num">15</td><td><span class="i">+++++++++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h10">src/tools/interface.cc</a></td><td> | </td><td class="num">21</td><td><span class="i">++++++++</span><span class="d">-------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h11">src/tools/json_interface.cc</a></td><td> | </td><td class="num">42</td><td><span class="i">+++++++++++++++</span><span class="d">---------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h12">test/codesearch_test.cc</a></td><td> | </td><td class="num">15</td><td><span class="i">++++++</span><span class="d">---------</span></td></tr>
</table></pre><pre>13 files changed, 113 insertions(+), 276 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/src/codesearch.cc">src/codesearch.cc</a> b/<a href="../file/src/codesearch.cc">src/codesearch.cc</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -58,7 +58,6 @@ namespace {
</a>     metric idx_bytes(&quot;index.bytes&quot;);
     metric idx_bytes_dedup(&quot;index.bytes.dedup&quot;);
     metric idx_files(&quot;index.files&quot;);
<a href="#h0-0-3" id="h0-0-3" class="d">-    metric idx_files_dedup(&quot;index.files.dedup&quot;);
</a>     metric idx_lines(&quot;index.lines&quot;);
     metric idx_lines_dedup(&quot;index.lines.dedup&quot;);
     metric idx_data_chunks(&quot;index.data.chunks&quot;);
<a href="#h0-1" id="h0-1" class="h">@@ -108,7 +107,6 @@ const StringPiece empty_string(NULL, 0);
</a> 
 class code_searcher;
 struct match_finger;
<a href="#h0-1-3" id="h0-1-3" class="d">-struct match_group;
</a> 
 class searcher {
 public:
<a href="#h0-2" id="h0-2" class="h">@@ -179,44 +177,24 @@ protected:
</a>     void filtered_search(const chunk *chunk);
     void search_lines(uint32_t *left, int count, const chunk *chunk);
 
<a href="#h0-2-3" id="h0-2-3" class="d">-    bool accept(const indexed_path &amp;path) {
</a><a href="#h0-2-4" id="h0-2-4" class="i">+    bool accept(const indexed_file *file) {
</a>         if (!query_-&gt;file_pat &amp;&amp; !query_-&gt;tree_pat)
             return true;
 
         if (query_-&gt;file_pat &amp;&amp;
<a href="#h0-2-9" id="h0-2-9" class="d">-            !query_-&gt;file_pat-&gt;Match(path.path, 0, path.path.size(),
</a><a href="#h0-2-10" id="h0-2-10" class="i">+            !query_-&gt;file_pat-&gt;Match(file-&gt;path, 0, file-&gt;path.size(),
</a>                                      RE2::UNANCHORED, 0, 0))
             return false;
 
         if (query_-&gt;tree_pat &amp;&amp;
<a href="#h0-2-15" id="h0-2-15" class="d">-            !query_-&gt;tree_pat-&gt;Match(path.tree-&gt;repo-&gt;name, 0,
</a><a href="#h0-2-16" id="h0-2-16" class="d">-                                    path.tree-&gt;repo-&gt;name.size(),
</a><a href="#h0-2-17" id="h0-2-17" class="d">-                                    RE2::UNANCHORED, 0, 0))
</a><a href="#h0-2-18" id="h0-2-18" class="i">+            !query_-&gt;tree_pat-&gt;Match(file-&gt;tree-&gt;name, 0,
</a><a href="#h0-2-19" id="h0-2-19" class="i">+                                     file-&gt;tree-&gt;name.size(),
</a><a href="#h0-2-20" id="h0-2-20" class="i">+                                     RE2::UNANCHORED, 0, 0))
</a>             return false;
 
         return true;
     }
 
<a href="#h0-2-26" id="h0-2-26" class="d">-    bool accept(indexed_file *sf) {
</a><a href="#h0-2-27" id="h0-2-27" class="d">-        if (!query_-&gt;file_pat &amp;&amp; !query_-&gt;tree_pat)
</a><a href="#h0-2-28" id="h0-2-28" class="d">-            return true;
</a><a href="#h0-2-29" id="h0-2-29" class="d">-
</a><a href="#h0-2-30" id="h0-2-30" class="d">-        assert(cc_-&gt;files_[sf-&gt;no] == sf);
</a><a href="#h0-2-31" id="h0-2-31" class="d">-
</a><a href="#h0-2-32" id="h0-2-32" class="d">-        if (files_[sf-&gt;no] == 0xff) {
</a><a href="#h0-2-33" id="h0-2-33" class="d">-            bool match = 0;
</a><a href="#h0-2-34" id="h0-2-34" class="d">-            for (auto it = sf-&gt;paths.begin(); it != sf-&gt;paths.end(); ++it) {
</a><a href="#h0-2-35" id="h0-2-35" class="d">-                if (accept(*it)) {
</a><a href="#h0-2-36" id="h0-2-36" class="d">-                    match = true;
</a><a href="#h0-2-37" id="h0-2-37" class="d">-                    break;
</a><a href="#h0-2-38" id="h0-2-38" class="d">-                }
</a><a href="#h0-2-39" id="h0-2-39" class="d">-            }
</a><a href="#h0-2-40" id="h0-2-40" class="d">-            files_[sf-&gt;no] = match;
</a><a href="#h0-2-41" id="h0-2-41" class="d">-        }
</a><a href="#h0-2-42" id="h0-2-42" class="d">-
</a><a href="#h0-2-43" id="h0-2-43" class="d">-        return files_[sf-&gt;no];
</a><a href="#h0-2-44" id="h0-2-44" class="d">-    }
</a><a href="#h0-2-45" id="h0-2-45" class="d">-
</a>     bool accept(const list&lt;indexed_file *&gt; &amp;sfs) {
         for (list&lt;indexed_file *&gt;::const_iterator it = sfs.begin();
              it != sfs.end(); ++it) {
<a href="#h0-3" id="h0-3" class="h">@@ -261,15 +239,12 @@ protected:
</a>     /*
      * Given a matching substring, its containing line, and a search
      * file, determine whether that file actually contains that line,
<a href="#h0-3-3" id="h0-3-3" class="d">-     * and if so, update the match_group with the match information.
</a><a href="#h0-3-4" id="h0-3-4" class="i">+     * and if so, post results to queue_
</a>      */
<a href="#h0-3-6" id="h0-3-6" class="d">-    void try_match(match_group *,
</a><a href="#h0-3-7" id="h0-3-7" class="d">-                   const StringPiece&amp;,
</a><a href="#h0-3-8" id="h0-3-8" class="i">+    void try_match(const StringPiece&amp;,
</a>                    const StringPiece&amp;,
                    indexed_file *);
 
<a href="#h0-3-12" id="h0-3-12" class="d">-    void finish_group(match_group *);
</a><a href="#h0-3-13" id="h0-3-13" class="d">-
</a>     static int line_start(const chunk *chunk, int pos) {
         const unsigned char *start = static_cast&lt;const unsigned char*&gt;
             (memrchr(chunk-&gt;data, &#39;\n&#39;, pos));
<a href="#h0-4" id="h0-4" class="h">@@ -381,27 +356,25 @@ void code_searcher::finalize() {
</a>     idx_content_chunks.inc(alloc_-&gt;end_content() - alloc_-&gt;begin_content());
 }
 
<a href="#h0-4-3" id="h0-4-3" class="d">-vector&lt;indexed_repo&gt; code_searcher::repos() const {
</a><a href="#h0-4-4" id="h0-4-4" class="d">-    vector&lt;indexed_repo&gt; out;
</a><a href="#h0-4-5" id="h0-4-5" class="d">-    out.reserve(repos_.size());
</a><a href="#h0-4-6" id="h0-4-6" class="d">-    for (auto it = repos_.begin(); it != repos_.end(); ++it)
</a><a href="#h0-4-7" id="h0-4-7" class="i">+vector&lt;indexed_tree&gt; code_searcher::trees() const {
</a><a href="#h0-4-8" id="h0-4-8" class="i">+    vector&lt;indexed_tree&gt; out;
</a><a href="#h0-4-9" id="h0-4-9" class="i">+    out.reserve(trees_.size());
</a><a href="#h0-4-10" id="h0-4-10" class="i">+    for (auto it = trees_.begin(); it != trees_.end(); ++it)
</a>         out.push_back(**it);
     return out;
 }
 
<a href="#h0-4-15" id="h0-4-15" class="d">-const indexed_repo* code_searcher::open_repo(const string &amp;name, json_object *metadata) {
</a><a href="#h0-4-16" id="h0-4-16" class="d">-    indexed_repo *repo = new indexed_repo;
</a><a href="#h0-4-17" id="h0-4-17" class="d">-    repo-&gt;name = name;
</a><a href="#h0-4-18" id="h0-4-18" class="d">-    repo-&gt;metadata = metadata;
</a><a href="#h0-4-19" id="h0-4-19" class="d">-    repos_.push_back(repo);
</a><a href="#h0-4-20" id="h0-4-20" class="d">-    return repo;
</a><a href="#h0-4-21" id="h0-4-21" class="d">-}
</a><a href="#h0-4-22" id="h0-4-22" class="d">-
</a><a href="#h0-4-23" id="h0-4-23" class="d">-const indexed_tree* code_searcher::open_revision(const indexed_repo *repo,
</a><a href="#h0-4-24" id="h0-4-24" class="d">-                                                 const string &amp;rev) {
</a><a href="#h0-4-25" id="h0-4-25" class="i">+const indexed_tree* code_searcher::open_tree(const string &amp;name,
</a><a href="#h0-4-26" id="h0-4-26" class="i">+                                             json_object *metadata,
</a><a href="#h0-4-27" id="h0-4-27" class="i">+                                             const string &amp;version) {
</a>     indexed_tree *tree = new indexed_tree;
<a href="#h0-4-29" id="h0-4-29" class="d">-    tree-&gt;repo = repo;
</a><a href="#h0-4-30" id="h0-4-30" class="d">-    tree-&gt;revision = rev;
</a><a href="#h0-4-31" id="h0-4-31" class="i">+    tree-&gt;name = name;
</a><a href="#h0-4-32" id="h0-4-32" class="i">+    tree-&gt;version = version;
</a><a href="#h0-4-33" id="h0-4-33" class="i">+    if (metadata) {
</a><a href="#h0-4-34" id="h0-4-34" class="i">+        tree-&gt;metadata = metadata;
</a><a href="#h0-4-35" id="h0-4-35" class="i">+    } else {
</a><a href="#h0-4-36" id="h0-4-36" class="i">+        tree-&gt;metadata = NULL;
</a><a href="#h0-4-37" id="h0-4-37" class="i">+    }
</a>     trees_.push_back(tree);
     return tree;
 }
<a href="#h0-5" id="h0-5" class="h">@@ -424,24 +397,11 @@ void code_searcher::index_file(const indexed_tree *tree,
</a>     idx_bytes.inc(len);
     idx_files.inc();
 
<a href="#h0-5-3" id="h0-5-3" class="d">-    sha1_buf sha1;
</a><a href="#h0-5-4" id="h0-5-4" class="d">-    sha1_string(&amp;sha1, contents);
</a><a href="#h0-5-5" id="h0-5-5" class="d">-
</a><a href="#h0-5-6" id="h0-5-6" class="d">-    auto sit = file_map_.find(sha1);
</a><a href="#h0-5-7" id="h0-5-7" class="d">-    if (sit != file_map_.end()) {
</a><a href="#h0-5-8" id="h0-5-8" class="d">-        indexed_file *sf = sit-&gt;second;
</a><a href="#h0-5-9" id="h0-5-9" class="d">-        sf-&gt;paths.push_back((indexed_path){tree, path});
</a><a href="#h0-5-10" id="h0-5-10" class="d">-        return;
</a><a href="#h0-5-11" id="h0-5-11" class="d">-    }
</a><a href="#h0-5-12" id="h0-5-12" class="d">-
</a><a href="#h0-5-13" id="h0-5-13" class="d">-    idx_files_dedup.inc();
</a><a href="#h0-5-14" id="h0-5-14" class="d">-
</a>     indexed_file *sf = new indexed_file;
<a href="#h0-5-16" id="h0-5-16" class="d">-    sf-&gt;paths.push_back((indexed_path){tree, path});
</a><a href="#h0-5-17" id="h0-5-17" class="d">-    sf-&gt;hash = sha1;
</a><a href="#h0-5-18" id="h0-5-18" class="i">+    sf-&gt;tree = tree;
</a><a href="#h0-5-19" id="h0-5-19" class="i">+    sf-&gt;path = path;
</a>     sf-&gt;no  = files_.size();
     files_.push_back(sf);
<a href="#h0-5-22" id="h0-5-22" class="d">-    file_map_[sha1] = sf;
</a> 
     uint32_t lines = count(p, end, &#39;\n&#39;);
 
<a href="#h0-6" id="h0-6" class="h">@@ -482,7 +442,7 @@ void code_searcher::index_file(const indexed_tree *tree,
</a>     sf-&gt;content = content.build(alloc_);
     if (sf-&gt;content == 0) {
         fprintf(stderr, &quot;WARN: %s:%s:%s is too large to be indexed.\n&quot;,
<a href="#h0-6-3" id="h0-6-3" class="d">-                tree-&gt;repo-&gt;name.c_str(), tree-&gt;revision.c_str(), path.c_str());
</a><a href="#h0-6-4" id="h0-6-4" class="i">+                tree-&gt;name.c_str(), tree-&gt;version.c_str(), path.c_str());
</a>         file_contents_builder dummy;
         sf-&gt;content = dummy.build(alloc_);
     }
<a href="#h0-7" id="h0-7" class="h">@@ -742,19 +702,6 @@ void searcher::full_search(match_finger *finger,
</a>     }
 }
 
<a href="#h0-7-3" id="h0-7-3" class="d">-struct match_group {
</a><a href="#h0-7-4" id="h0-7-4" class="d">-    StringPiece match, line;
</a><a href="#h0-7-5" id="h0-7-5" class="d">-    int left, right;
</a><a href="#h0-7-6" id="h0-7-6" class="d">-    map&lt;string, vector&lt;match_context&gt; &gt; matches;
</a><a href="#h0-7-7" id="h0-7-7" class="d">-
</a><a href="#h0-7-8" id="h0-7-8" class="d">-    match_group(const StringPiece&amp; match, const StringPiece &amp;line)
</a><a href="#h0-7-9" id="h0-7-9" class="d">-        : match(match), line(line) {
</a><a href="#h0-7-10" id="h0-7-10" class="d">-        left = utf8::distance(line.data(), match.data());
</a><a href="#h0-7-11" id="h0-7-11" class="d">-        right = left +
</a><a href="#h0-7-12" id="h0-7-12" class="d">-            utf8::distance(match.data(), match.data() + match.size());
</a><a href="#h0-7-13" id="h0-7-13" class="d">-    }
</a><a href="#h0-7-14" id="h0-7-14" class="d">-};
</a><a href="#h0-7-15" id="h0-7-15" class="d">-
</a> void searcher::find_match_brute(const chunk *chunk,
                                 const StringPiece&amp; match,
                                 const StringPiece&amp; line) {
<a href="#h0-8" id="h0-8" class="h">@@ -762,7 +709,6 @@ void searcher::find_match_brute(const chunk *chunk,
</a>     timer tm;
     int off = (unsigned char*)line.data() - chunk-&gt;data;
     int searched = 0;
<a href="#h0-8-3" id="h0-8-3" class="d">-    match_group group(match, line);
</a> 
     for(vector&lt;chunk_file&gt;::const_iterator it = chunk-&gt;files.begin();
         it != chunk-&gt;files.end(); it++) {
<a href="#h0-9" id="h0-9" class="h">@@ -774,13 +720,11 @@ void searcher::find_match_brute(const chunk *chunk,
</a>                 searched++;
                 if (exit_early())
                     break;
<a href="#h0-9-3" id="h0-9-3" class="d">-                try_match(&amp;group, line, match, *fit);
</a><a href="#h0-9-4" id="h0-9-4" class="i">+                try_match(line, match, *fit);
</a>             }
         }
     }
 
<a href="#h0-9-9" id="h0-9-9" class="d">-    finish_group(&amp;group);
</a><a href="#h0-9-10" id="h0-9-10" class="d">-
</a>     tm.pause();
     debug(kDebugProfile, &quot;Searched %d files in %d.%06ds&quot;,
           searched,
<a href="#h0-10" id="h0-10" class="h">@@ -822,7 +766,6 @@ void searcher::find_match(const chunk *chunk,
</a> 
     run_timer run(git_time_);
     int loff = (unsigned char*)line.data() - chunk-&gt;data;
<a href="#h0-10-3" id="h0-10-3" class="d">-    match_group group(match, line);
</a> 
     vector&lt;match_frame&gt; stack;
     assert(chunk-&gt;cf_root);
<a href="#h0-11" id="h0-11" class="h">@@ -845,7 +788,7 @@ void searcher::find_match(const chunk *chunk,
</a>                     continue;
                 if (exit_early())
                     break;
<a href="#h0-11-3" id="h0-11-3" class="d">-                try_match(&amp;group, line, match, *it);
</a><a href="#h0-11-4" id="h0-11-4" class="i">+                try_match(line, match, *it);
</a>             }
             continue;
         }
<a href="#h0-12" id="h0-12" class="h">@@ -865,12 +808,10 @@ void searcher::find_match(const chunk *chunk,
</a>         if (n-&gt;left)
             stack.push_back((match_frame){n-&gt;left, false});
     }
<a href="#h0-12-3" id="h0-12-3" class="d">-    finish_group(&amp;group);
</a> }
 
 
<a href="#h0-12-7" id="h0-12-7" class="d">-void searcher::try_match(match_group *group,
</a><a href="#h0-12-8" id="h0-12-8" class="d">-                         const StringPiece&amp; line,
</a><a href="#h0-12-9" id="h0-12-9" class="i">+void searcher::try_match(const StringPiece&amp; line,
</a>                          const StringPiece&amp; match,
                          indexed_file *sf) {
 
<a href="#h0-13" id="h0-13" class="h">@@ -888,15 +829,18 @@ void searcher::try_match(match_group *group,
</a>             }
         }
 
<a href="#h0-13-3" id="h0-13-3" class="d">-        debug(kDebugSearch, &quot;found match on %s:%d&quot;, sf-&gt;paths[0].path.c_str(), lno);
</a><a href="#h0-13-4" id="h0-13-4" class="i">+        debug(kDebugSearch, &quot;found match on %s:%d&quot;, sf-&gt;path.c_str(), lno);
</a> 
         if (it == sf-&gt;content-&gt;end(cc_-&gt;alloc_))
             return;
 
<a href="#h0-13-9" id="h0-13-9" class="d">-        match_context ctx;
</a><a href="#h0-13-10" id="h0-13-10" class="d">-
</a><a href="#h0-13-11" id="h0-13-11" class="d">-        ctx.file = sf;
</a><a href="#h0-13-12" id="h0-13-12" class="d">-        ctx.lno  = lno;
</a><a href="#h0-13-13" id="h0-13-13" class="i">+        match_result *m = new match_result;
</a><a href="#h0-13-14" id="h0-13-14" class="i">+        m-&gt;file = sf;
</a><a href="#h0-13-15" id="h0-13-15" class="i">+        m-&gt;lno  = lno;
</a><a href="#h0-13-16" id="h0-13-16" class="i">+        m-&gt;line = line;
</a><a href="#h0-13-17" id="h0-13-17" class="i">+        m-&gt;matchleft = utf8::distance(line.data(), match.data());
</a><a href="#h0-13-18" id="h0-13-18" class="i">+        m-&gt;matchright = m-&gt;matchleft +
</a><a href="#h0-13-19" id="h0-13-19" class="i">+            utf8::distance(match.data(), match.data() + match.size());
</a> 
         // iterators for forward and backward context
         auto fit = it, bit = it;
<a href="#h0-14" id="h0-14" class="h">@@ -911,7 +855,7 @@ void searcher::try_match(match_group *group,
</a>                 l = StringPiece(bit-&gt;data() + bit-&gt;size() + 1, 0);
             }
             l = find_line(*bit, StringPiece(l.data() - 1, 0));
<a href="#h0-14-3" id="h0-14-3" class="d">-            ctx.context_before.push_back(l);
</a><a href="#h0-14-4" id="h0-14-4" class="i">+            m-&gt;context_before.push_back(l);
</a>         }
 
         l = line;
<a href="#h0-15" id="h0-15" class="h">@@ -923,52 +867,16 @@ void searcher::try_match(match_group *group,
</a>                 l = StringPiece(fit-&gt;data() - 1, 0);
             }
             l = find_line(*fit, StringPiece(l.data() + l.size() + 1, 0));
<a href="#h0-15-3" id="h0-15-3" class="d">-            ctx.context_after.push_back(l);
</a><a href="#h0-15-4" id="h0-15-4" class="i">+            m-&gt;context_after.push_back(l);
</a>         }
 
<a href="#h0-15-7" id="h0-15-7" class="d">-        for (auto it = sf-&gt;paths.begin(); it != sf-&gt;paths.end(); ++it) {
</a><a href="#h0-15-8" id="h0-15-8" class="d">-            if (!accept(*it))
</a><a href="#h0-15-9" id="h0-15-9" class="d">-                continue;
</a><a href="#h0-15-10" id="h0-15-10" class="d">-            auto git = group-&gt;matches.find(it-&gt;path);
</a><a href="#h0-15-11" id="h0-15-11" class="d">-            if (git == group-&gt;matches.end()) {
</a><a href="#h0-15-12" id="h0-15-12" class="d">-                ++matches_;
</a><a href="#h0-15-13" id="h0-15-13" class="d">-                group-&gt;matches[it-&gt;path] = vector&lt;match_context&gt;();
</a><a href="#h0-15-14" id="h0-15-14" class="d">-                group-&gt;matches[it-&gt;path].push_back(ctx);
</a><a href="#h0-15-15" id="h0-15-15" class="d">-                group-&gt;matches[it-&gt;path].back().paths.push_back(*it);
</a><a href="#h0-15-16" id="h0-15-16" class="d">-            } else {
</a><a href="#h0-15-17" id="h0-15-17" class="d">-                bool found = false;
</a><a href="#h0-15-18" id="h0-15-18" class="d">-                for (auto m = git-&gt;second.begin(); m != git-&gt;second.end(); ++m) {
</a><a href="#h0-15-19" id="h0-15-19" class="d">-                    if ((m-&gt;file == sf &amp;&amp; m-&gt;lno == ctx.lno) ||
</a><a href="#h0-15-20" id="h0-15-20" class="d">-                        (m-&gt;context_before == ctx.context_before &amp;&amp;
</a><a href="#h0-15-21" id="h0-15-21" class="d">-                         m-&gt;context_after  == ctx.context_after)) {
</a><a href="#h0-15-22" id="h0-15-22" class="d">-                        m-&gt;paths.push_back(*it);
</a><a href="#h0-15-23" id="h0-15-23" class="d">-                        found = true;
</a><a href="#h0-15-24" id="h0-15-24" class="d">-                        break;
</a><a href="#h0-15-25" id="h0-15-25" class="d">-                    }
</a><a href="#h0-15-26" id="h0-15-26" class="d">-                }
</a><a href="#h0-15-27" id="h0-15-27" class="d">-                if (!found) {
</a><a href="#h0-15-28" id="h0-15-28" class="d">-                    git-&gt;second.push_back(ctx);
</a><a href="#h0-15-29" id="h0-15-29" class="d">-                    git-&gt;second.back().paths.push_back(*it);
</a><a href="#h0-15-30" id="h0-15-30" class="d">-                }
</a><a href="#h0-15-31" id="h0-15-31" class="d">-            }
</a><a href="#h0-15-32" id="h0-15-32" class="d">-        }
</a><a href="#h0-15-33" id="h0-15-33" class="i">+        queue_.push(m);
</a> 
         ++it;
         ++lno;
     }
 }
 
<a href="#h0-15-40" id="h0-15-40" class="d">-void searcher::finish_group(match_group *group) {
</a><a href="#h0-15-41" id="h0-15-41" class="d">-    for (auto it = group-&gt;matches.begin(); it != group-&gt;matches.end(); ++it) {
</a><a href="#h0-15-42" id="h0-15-42" class="d">-        match_result *m = new match_result;
</a><a href="#h0-15-43" id="h0-15-43" class="d">-        m-&gt;line       = group-&gt;line;
</a><a href="#h0-15-44" id="h0-15-44" class="d">-        m-&gt;matchleft  = group-&gt;left;
</a><a href="#h0-15-45" id="h0-15-45" class="d">-        m-&gt;matchright = group-&gt;right;
</a><a href="#h0-15-46" id="h0-15-46" class="d">-        m-&gt;context.swap(it-&gt;second);
</a><a href="#h0-15-47" id="h0-15-47" class="d">-        queue_.push(m);
</a><a href="#h0-15-48" id="h0-15-48" class="d">-    }
</a><a href="#h0-15-49" id="h0-15-49" class="d">-}
</a><a href="#h0-15-50" id="h0-15-50" class="d">-
</a> code_searcher::search_thread::search_thread(code_searcher *cs)
     : cs_(cs) {
     if (FLAGS_search) {
<b>diff --git a/<a id="h1" href="../file/src/codesearch.h">src/codesearch.h</a> b/<a href="../file/src/codesearch.h">src/codesearch.h</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -98,38 +98,24 @@ struct chunk;
</a> struct chunk_file;
 struct json_object;
 
<a href="#h1-0-3" id="h1-0-3" class="d">-struct indexed_repo {
</a><a href="#h1-0-4" id="h1-0-4" class="i">+struct indexed_tree {
</a>     string name;
     json_object *metadata;
<a href="#h1-0-7" id="h1-0-7" class="i">+    string version;
</a> };
 
<a href="#h1-0-10" id="h1-0-10" class="d">-struct indexed_tree {
</a><a href="#h1-0-11" id="h1-0-11" class="d">-    const indexed_repo *repo;
</a><a href="#h1-0-12" id="h1-0-12" class="d">-    string revision;
</a><a href="#h1-0-13" id="h1-0-13" class="d">-};
</a><a href="#h1-0-14" id="h1-0-14" class="d">-
</a><a href="#h1-0-15" id="h1-0-15" class="d">-struct indexed_path {
</a><a href="#h1-0-16" id="h1-0-16" class="i">+struct indexed_file {
</a>     const indexed_tree *tree;
     string path;
<a href="#h1-0-19" id="h1-0-19" class="d">-};
</a><a href="#h1-0-20" id="h1-0-20" class="d">-
</a><a href="#h1-0-21" id="h1-0-21" class="d">-struct indexed_file {
</a><a href="#h1-0-22" id="h1-0-22" class="d">-    vector&lt;indexed_path&gt; paths;
</a><a href="#h1-0-23" id="h1-0-23" class="d">-    sha1_buf hash;
</a>     file_contents *content;
     int no;
 };
 
<a href="#h1-0-28" id="h1-0-28" class="d">-struct match_context {
</a><a href="#h1-0-29" id="h1-0-29" class="i">+struct match_result {
</a>     indexed_file *file;
<a href="#h1-0-31" id="h1-0-31" class="d">-    vector&lt;indexed_path&gt; paths;
</a>     int lno;
     vector&lt;StringPiece&gt; context_before;
     vector&lt;StringPiece&gt; context_after;
<a href="#h1-0-35" id="h1-0-35" class="d">-};
</a><a href="#h1-0-36" id="h1-0-36" class="d">-
</a><a href="#h1-0-37" id="h1-0-37" class="d">-struct match_result {
</a><a href="#h1-0-38" id="h1-0-38" class="d">-    vector&lt;match_context&gt; context;
</a>     StringPiece line;
     int matchleft, matchright;
 };
<a href="#h1-1" id="h1-1" class="h">@@ -150,8 +136,7 @@ public:
</a>     void dump_index(const string&amp; path);
     void load_index(const string&amp; path);
 
<a href="#h1-1-3" id="h1-1-3" class="d">-    const indexed_repo *open_repo(const string &amp;name, json_object *meta);
</a><a href="#h1-1-4" id="h1-1-4" class="d">-    const indexed_tree *open_revision(const indexed_repo *repo, const string&amp; rev);
</a><a href="#h1-1-5" id="h1-1-5" class="i">+    const indexed_tree *open_tree(const string &amp;name, json_object *meta, const string&amp; version);
</a>     void index_file(const indexed_tree *tree,
                     const string&amp; path,
                     StringPiece contents);
<a href="#h1-2" id="h1-2" class="h">@@ -160,7 +145,7 @@ public:
</a>     void set_alloc(chunk_allocator *alloc);
     chunk_allocator *alloc() { return alloc_; }
 
<a href="#h1-2-3" id="h1-2-3" class="d">-    vector&lt;indexed_repo&gt; repos() const;
</a><a href="#h1-2-4" id="h1-2-4" class="i">+    vector&lt;indexed_tree&gt; trees() const;
</a>     string name() const {
         return name_;
     };
<a href="#h1-3" id="h1-3" class="h">@@ -224,10 +209,8 @@ protected:
</a>     string_hash lines_;
     chunk_allocator *alloc_;
     bool finalized_;
<a href="#h1-3-3" id="h1-3-3" class="d">-    vector&lt;indexed_repo*&gt; repos_;
</a>     vector&lt;indexed_tree*&gt; trees_;
     vector&lt;indexed_file*&gt; files_;
<a href="#h1-3-6" id="h1-3-6" class="d">-    google::sparse_hash_map&lt;sha1_buf, indexed_file*, hash_sha1&gt; file_map_;
</a> 
     friend class search_thread;
     friend class searcher;
<b>diff --git a/<a id="h2" href="../file/src/dump_load.cc">src/dump_load.cc</a> b/<a href="../file/src/dump_load.cc">src/dump_load.cc</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -237,12 +237,8 @@ chunk_allocator *make_dump_allocator(code_searcher *search, const string&amp; path) 
</a> }
 
 void codesearch_index::dump_file(map&lt;const indexed_tree*, int&gt;&amp; ids, indexed_file *sf) {
<a href="#h2-0-3" id="h2-0-3" class="d">-    dump(&amp;sf-&gt;hash);
</a><a href="#h2-0-4" id="h2-0-4" class="d">-    dump_int32(sf-&gt;paths.size());
</a><a href="#h2-0-5" id="h2-0-5" class="d">-    for (auto it = sf-&gt;paths.begin(); it != sf-&gt;paths.end(); ++it) {
</a><a href="#h2-0-6" id="h2-0-6" class="d">-        dump_int32(ids[it-&gt;tree]);
</a><a href="#h2-0-7" id="h2-0-7" class="d">-        dump_string(it-&gt;path.c_str());
</a><a href="#h2-0-8" id="h2-0-8" class="d">-    }
</a><a href="#h2-0-9" id="h2-0-9" class="i">+    dump_int32(ids[sf-&gt;tree]);
</a><a href="#h2-0-10" id="h2-0-10" class="i">+    dump_string(sf-&gt;path);
</a> }
 
 void codesearch_index::dump_chunk_file(chunk_file *cf) {
<a href="#h2-1" id="h2-1" class="h">@@ -282,7 +278,6 @@ void codesearch_index::dump_chunk_data(chunk *chunk) {
</a> }
 
 void codesearch_index::dump_metadata() {
<a href="#h2-1-3" id="h2-1-3" class="d">-    hdr_.nrepos   = cs_-&gt;repos_.size();
</a>     hdr_.ntrees   = cs_-&gt;trees_.size();
     hdr_.nfiles   = cs_-&gt;files_.size();
     hdr_.nchunks  = cs_-&gt;alloc_-&gt;size();
<a href="#h2-2" id="h2-2" class="h">@@ -291,24 +286,17 @@ void codesearch_index::dump_metadata() {
</a>     hdr_.name_off = stream_.tellp();
     dump_string(cs_-&gt;name());
 
<a href="#h2-2-3" id="h2-2-3" class="d">-    map&lt;const indexed_repo*, int&gt; repo_ids;
</a>     map&lt;const indexed_tree*, int&gt; tree_ids;
 
<a href="#h2-2-6" id="h2-2-6" class="d">-    hdr_.repos_off = stream_.tellp();
</a><a href="#h2-2-7" id="h2-2-7" class="d">-    for (auto it = cs_-&gt;repos_.begin();
</a><a href="#h2-2-8" id="h2-2-8" class="d">-         it != cs_-&gt;repos_.end(); ++it) {
</a><a href="#h2-2-9" id="h2-2-9" class="i">+    hdr_.refs_off = stream_.tellp();
</a><a href="#h2-2-10" id="h2-2-10" class="i">+    for (auto it = cs_-&gt;trees_.begin();
</a><a href="#h2-2-11" id="h2-2-11" class="i">+         it != cs_-&gt;trees_.end(); ++it) {
</a>         dump_string((*it)-&gt;name);
<a href="#h2-2-13" id="h2-2-13" class="i">+        dump_string((*it)-&gt;version);
</a>         if ((*it)-&gt;metadata)
             dump_string(json_object_to_json_string((*it)-&gt;metadata));
         else
             dump_string(&quot;&quot;);
<a href="#h2-2-18" id="h2-2-18" class="d">-        repo_ids[*it] = it - cs_-&gt;repos_.begin();
</a><a href="#h2-2-19" id="h2-2-19" class="d">-    }
</a><a href="#h2-2-20" id="h2-2-20" class="d">-    hdr_.refs_off = stream_.tellp();
</a><a href="#h2-2-21" id="h2-2-21" class="d">-    for (auto it = cs_-&gt;trees_.begin();
</a><a href="#h2-2-22" id="h2-2-22" class="d">-         it != cs_-&gt;trees_.end(); ++it) {
</a><a href="#h2-2-23" id="h2-2-23" class="d">-        dump_int32(repo_ids[(*it)-&gt;repo]);
</a><a href="#h2-2-24" id="h2-2-24" class="d">-        dump_string((*it)-&gt;revision);
</a>         tree_ids[*it] = it - cs_-&gt;trees_.begin();
     }
     hdr_.files_off = stream_.tellp();
<a href="#h2-3" id="h2-3" class="h">@@ -395,12 +383,8 @@ chunk *load_allocator::alloc_chunk() {
</a> 
 indexed_file *load_allocator::load_file(code_searcher *cs) {
     indexed_file *sf = new indexed_file;
<a href="#h2-3-3" id="h2-3-3" class="d">-    memcpy(&amp;sf-&gt;hash.hash, consume&lt;sha1_buf&gt;(), sizeof(sf-&gt;hash.hash));
</a><a href="#h2-3-4" id="h2-3-4" class="d">-    sf-&gt;paths.resize(load_int32());
</a><a href="#h2-3-5" id="h2-3-5" class="d">-    for (auto it = sf-&gt;paths.begin(); it != sf-&gt;paths.end(); ++it) {
</a><a href="#h2-3-6" id="h2-3-6" class="d">-        it-&gt;tree = cs-&gt;trees_[load_int32()];
</a><a href="#h2-3-7" id="h2-3-7" class="d">-        it-&gt;path = load_string();
</a><a href="#h2-3-8" id="h2-3-8" class="d">-    }
</a><a href="#h2-3-9" id="h2-3-9" class="i">+    sf-&gt;tree = cs-&gt;trees_[load_int32()];
</a><a href="#h2-3-10" id="h2-3-10" class="i">+    sf-&gt;path = load_string();
</a>     sf-&gt;no = cs-&gt;files_.size();
     return sf;
 }
<a href="#h2-4" id="h2-4" class="h">@@ -437,26 +421,20 @@ void load_allocator::load(code_searcher *cs) {
</a> 
     set_chunk_size(hdr_-&gt;chunk_size);
 
<a href="#h2-4-3" id="h2-4-3" class="d">-    p_ = ptr&lt;uint8_t&gt;(hdr_-&gt;repos_off);
</a><a href="#h2-4-4" id="h2-4-4" class="d">-    for (int i = 0; i &lt; hdr_-&gt;nrepos; i++) {
</a><a href="#h2-4-5" id="h2-4-5" class="d">-        indexed_repo *repo = new indexed_repo;
</a><a href="#h2-4-6" id="h2-4-6" class="d">-        repo-&gt;name = load_string();
</a><a href="#h2-4-7" id="h2-4-7" class="i">+    p_ = ptr&lt;uint8_t&gt;(hdr_-&gt;refs_off);
</a><a href="#h2-4-8" id="h2-4-8" class="i">+    for (int i = 0; i &lt; hdr_-&gt;ntrees; i++) {
</a><a href="#h2-4-9" id="h2-4-9" class="i">+        indexed_tree *tree = new indexed_tree;
</a><a href="#h2-4-10" id="h2-4-10" class="i">+        tree-&gt;name = load_string();
</a><a href="#h2-4-11" id="h2-4-11" class="i">+        tree-&gt;version = load_string();
</a>         string metadata = load_string();
         if (metadata.size() == 0) {
<a href="#h2-4-14" id="h2-4-14" class="d">-            repo-&gt;metadata = NULL;
</a><a href="#h2-4-15" id="h2-4-15" class="i">+            tree-&gt;metadata = NULL;
</a>         } else {
             json_object *js = json_tokener_parse(metadata.c_str());
             assert(!is_error(js));
<a href="#h2-4-19" id="h2-4-19" class="d">-            repo-&gt;metadata = js;
</a><a href="#h2-4-20" id="h2-4-20" class="i">+            tree-&gt;metadata = js;
</a>         }
<a href="#h2-4-22" id="h2-4-22" class="d">-        cs-&gt;repos_.push_back(repo);
</a><a href="#h2-4-23" id="h2-4-23" class="d">-    }
</a> 
<a href="#h2-4-25" id="h2-4-25" class="d">-    p_ = ptr&lt;uint8_t&gt;(hdr_-&gt;refs_off);
</a><a href="#h2-4-26" id="h2-4-26" class="d">-    for (int i = 0; i &lt; hdr_-&gt;ntrees; i++) {
</a><a href="#h2-4-27" id="h2-4-27" class="d">-        indexed_tree *tree = new indexed_tree;
</a><a href="#h2-4-28" id="h2-4-28" class="d">-        tree-&gt;repo = cs-&gt;repos_[load_int32()];
</a><a href="#h2-4-29" id="h2-4-29" class="d">-        tree-&gt;revision = load_string();
</a>         cs-&gt;trees_.push_back(tree);
     }
 
<b>diff --git a/<a id="h3" href="../file/src/dump_load.h">src/dump_load.h</a> b/<a href="../file/src/dump_load.h">src/dump_load.h</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -19,9 +19,6 @@ struct index_header {
</a> 
     uint64_t name_off;
 
<a href="#h3-0-3" id="h3-0-3" class="d">-    uint32_t nrepos;
</a><a href="#h3-0-4" id="h3-0-4" class="d">-    uint64_t repos_off;
</a><a href="#h3-0-5" id="h3-0-5" class="d">-
</a>     uint32_t ntrees;
     uint64_t refs_off;
 
<b>diff --git a/<a id="h4" href="../file/src/fs_indexer.cc">src/fs_indexer.cc</a> b/<a href="../file/src/fs_indexer.cc">src/fs_indexer.cc</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -15,19 +15,15 @@ namespace fs = boost::filesystem;
</a> fs_indexer::fs_indexer(code_searcher *cs,
                          const string&amp; name)
     : cs_(cs), name_(name) {
<a href="#h4-0-3" id="h4-0-3" class="i">+    tree_ = cs-&gt;open_tree(name, NULL, &quot;&quot;);
</a> }
 
 fs_indexer::~fs_indexer() {
 }
 
 void fs_indexer::read_file(const string&amp; path) {
<a href="#h4-0-10" id="h4-0-10" class="d">-    // XXX This is a hack.
</a><a href="#h4-0-11" id="h4-0-11" class="d">-    const string nullref = &quot;None&quot;;
</a><a href="#h4-0-12" id="h4-0-12" class="d">-    const indexed_repo *dummy_repo = cs_-&gt;open_repo(name_, NULL);
</a><a href="#h4-0-13" id="h4-0-13" class="d">-    const indexed_tree *dummy_tree = cs_-&gt;open_revision(dummy_repo, nullref);
</a><a href="#h4-0-14" id="h4-0-14" class="d">-
</a>     ifstream in(path.c_str(), ios::in);
<a href="#h4-0-16" id="h4-0-16" class="d">-    cs_-&gt;index_file(dummy_tree, path, StringPiece(static_cast&lt;stringstream const&amp;&gt;(stringstream() &lt;&lt; in.rdbuf()).str().c_str(), fs::file_size(path)));
</a><a href="#h4-0-17" id="h4-0-17" class="i">+    cs_-&gt;index_file(tree_, path, StringPiece(static_cast&lt;stringstream const&amp;&gt;(stringstream() &lt;&lt; in.rdbuf()).str().c_str(), fs::file_size(path)));
</a> }
 
 void fs_indexer::walk(const string&amp; path) {
<b>diff --git a/<a id="h5" href="../file/src/fs_indexer.h">src/fs_indexer.h</a> b/<a href="../file/src/fs_indexer.h">src/fs_indexer.h</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -11,6 +11,7 @@
</a> #include &lt;string&gt;
 
 class code_searcher;
<a href="#h5-0-3" id="h5-0-3" class="i">+struct indexed_tree;
</a> 
 class fs_indexer {
 public:
<a href="#h5-1" id="h5-1" class="h">@@ -22,6 +23,7 @@ public:
</a> protected:
     code_searcher *cs_;
     std::string name_;
<a href="#h5-1-3" id="h5-1-3" class="i">+    const indexed_tree *tree_;
</a> };
 
 #endif
<b>diff --git a/<a id="h6" href="../file/src/git_indexer.cc">src/git_indexer.cc</a> b/<a href="../file/src/git_indexer.cc">src/git_indexer.cc</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -31,8 +31,6 @@ git_indexer::git_indexer(code_searcher *cs,
</a>         fprintf(stderr, &quot;Unable to open repo: %s\n&quot;, repopath.c_str());
         exit(1);
     }
<a href="#h6-0-3" id="h6-0-3" class="d">-    idx_repo_ = cs_-&gt;open_repo(name, metadata);
</a><a href="#h6-0-4" id="h6-0-4" class="d">-
</a>     git_libgit2_opts(GIT_OPT_SET_CACHE_OBJECT_LIMIT, GIT_OBJ_BLOB, 10*1024);
     git_libgit2_opts(GIT_OPT_SET_CACHE_OBJECT_LIMIT, GIT_OBJ_OFS_DELTA, 10*1024);
     git_libgit2_opts(GIT_OPT_SET_CACHE_OBJECT_LIMIT, GIT_OBJ_REF_DELTA, 10*1024);
<a href="#h6-1" id="h6-1" class="h">@@ -49,16 +47,14 @@ void git_indexer::walk(const string&amp; ref) {
</a>     git_commit_tree(tree, commit);
 
     char oidstr[GIT_OID_HEXSZ+1];
<a href="#h6-1-3" id="h6-1-3" class="d">-    string name = FLAGS_revparse ?
</a><a href="#h6-1-4" id="h6-1-4" class="i">+    string version = FLAGS_revparse ?
</a>         strdup(git_oid_tostr(oidstr, sizeof(oidstr), git_commit_id(commit))) : ref;
<a href="#h6-1-6" id="h6-1-6" class="d">-    if (name_.size())
</a><a href="#h6-1-7" id="h6-1-7" class="d">-        name = name_ + &quot;:&quot; + name;
</a> 
<a href="#h6-1-9" id="h6-1-9" class="d">-    idx_tree_ = cs_-&gt;open_revision(idx_repo_, ref);
</a><a href="#h6-1-10" id="h6-1-10" class="d">-    walk_root(name, tree);
</a><a href="#h6-1-11" id="h6-1-11" class="i">+    idx_tree_ = cs_-&gt;open_tree(name_, metadata_, version);
</a><a href="#h6-1-12" id="h6-1-12" class="i">+    walk_root(tree);
</a> }
 
<a href="#h6-1-15" id="h6-1-15" class="d">-void git_indexer::walk_root(const string&amp; ref, git_tree *tree) {
</a><a href="#h6-1-16" id="h6-1-16" class="i">+void git_indexer::walk_root(git_tree *tree) {
</a>     metric::timer tm_walk(git_walk);
     map&lt;string, const git_tree_entry *&gt; root;
     vector&lt;const git_tree_entry *&gt; ordered;
<a href="#h6-2" id="h6-2" class="h">@@ -88,7 +84,7 @@ void git_indexer::walk_root(const string&amp; ref, git_tree *tree) {
</a>         tm_walk.pause();
 
         if (git_tree_entry_type(*it) == GIT_OBJ_TREE) {
<a href="#h6-2-3" id="h6-2-3" class="d">-            walk_tree(ref, path + &quot;/&quot;, obj);
</a><a href="#h6-2-4" id="h6-2-4" class="i">+            walk_tree(path + &quot;/&quot;, obj);
</a>         } else if (git_tree_entry_type(*it) == GIT_OBJ_BLOB) {
             metric::timer tm_content(git_contents);
             const char *data = static_cast&lt;const char*&gt;(git_blob_rawcontent(obj));
<a href="#h6-3" id="h6-3" class="h">@@ -98,8 +94,7 @@ void git_indexer::walk_root(const string&amp; ref, git_tree *tree) {
</a>     }
 }
 
<a href="#h6-3-3" id="h6-3-3" class="d">-void git_indexer::walk_tree(const string&amp; ref,
</a><a href="#h6-3-4" id="h6-3-4" class="d">-                            const string&amp; pfx,
</a><a href="#h6-3-5" id="h6-3-5" class="i">+void git_indexer::walk_tree(const string&amp; pfx,
</a>                             git_tree *tree) {
     metric::timer tm_walk(git_walk);
     string path;
<a href="#h6-4" id="h6-4" class="h">@@ -112,7 +107,7 @@ void git_indexer::walk_tree(const string&amp; ref,
</a>         git_tree_entry_to_object(obj, repo_, ent);
         tm_walk.pause();
         if (git_tree_entry_type(ent) == GIT_OBJ_TREE) {
<a href="#h6-4-3" id="h6-4-3" class="d">-            walk_tree(ref, path + &quot;/&quot;, obj);
</a><a href="#h6-4-4" id="h6-4-4" class="i">+            walk_tree(path + &quot;/&quot;, obj);
</a>         } else if (git_tree_entry_type(ent) == GIT_OBJ_BLOB) {
             metric::timer tm_contents(git_contents);
             const char *data = static_cast&lt;const char*&gt;(git_blob_rawcontent(obj));
<b>diff --git a/<a id="h7" href="../file/src/git_indexer.h">src/git_indexer.h</a> b/<a href="../file/src/git_indexer.h">src/git_indexer.h</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -13,7 +13,6 @@
</a> class code_searcher;
 class git_repository;
 class git_tree;
<a href="#h7-0-3" id="h7-0-3" class="d">-struct indexed_repo;
</a> struct indexed_tree;
 struct json_object;
 
<a href="#h7-1" id="h7-1" class="h">@@ -26,13 +25,11 @@ public:
</a>     ~git_indexer();
     void walk(const std::string&amp; ref);
 protected:
<a href="#h7-1-3" id="h7-1-3" class="d">-    void walk_root(const std::string&amp; ref, git_tree *tree);
</a><a href="#h7-1-4" id="h7-1-4" class="d">-    void walk_tree(const std::string&amp; ref,
</a><a href="#h7-1-5" id="h7-1-5" class="d">-                   const std::string&amp; pfx, git_tree *tree);
</a><a href="#h7-1-6" id="h7-1-6" class="i">+    void walk_root(git_tree *tree);
</a><a href="#h7-1-7" id="h7-1-7" class="i">+    void walk_tree(const std::string&amp; pfx, git_tree *tree);
</a> 
     code_searcher *cs_;
     git_repository *repo_;
<a href="#h7-1-11" id="h7-1-11" class="d">-    const indexed_repo *idx_repo_;
</a>     const indexed_tree *idx_tree_;
     std::string name_;
     json_object *metadata_;
<b>diff --git a/<a id="h8" href="../file/src/tools/dump-file.cc">src/tools/dump-file.cc</a> b/<a href="../file/src/tools/dump-file.cc">src/tools/dump-file.cc</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -32,11 +32,9 @@ int dump_file(int argc, char **argv) {
</a>     cs.load_index(index);
 
     for (auto it = cs.begin_files(); it != cs.end_files(); ++it) {
<a href="#h8-0-3" id="h8-0-3" class="d">-        for (auto pit = (*it)-&gt;paths.begin(); pit != (*it)-&gt;paths.end(); ++pit) {
</a><a href="#h8-0-4" id="h8-0-4" class="d">-            if (pit-&gt;path == path) {
</a><a href="#h8-0-5" id="h8-0-5" class="d">-                dump_file(&amp;cs, *it);
</a><a href="#h8-0-6" id="h8-0-6" class="d">-                return 0;
</a><a href="#h8-0-7" id="h8-0-7" class="d">-            }
</a><a href="#h8-0-8" id="h8-0-8" class="i">+        if ((*it)-&gt;path == path) {
</a><a href="#h8-0-9" id="h8-0-9" class="i">+            dump_file(&amp;cs, *it);
</a><a href="#h8-0-10" id="h8-0-10" class="i">+            return 0;
</a>         }
     }
 
<b>diff --git a/<a id="h9" href="../file/src/tools/inspect-index.cc">src/tools/inspect-index.cc</a> b/<a href="../file/src/tools/inspect-index.cc">src/tools/inspect-index.cc</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -31,7 +31,7 @@ bool operator&lt;(const index_span&amp; left, const index_span&amp; right) {
</a> }
 
 DEFINE_bool(dump_spans, false, &quot;Dump detailed index span information.&quot;);
<a href="#h9-0-3" id="h9-0-3" class="d">-DEFINE_bool(dump_repos, false, &quot;Dump repo names.&quot;);
</a><a href="#h9-0-4" id="h9-0-4" class="i">+DEFINE_bool(dump_trees, false, &quot;Dump tree names.&quot;);
</a> 
 int inspect_index(int argc, char **argv) {
     if (argc != 1) {
<a href="#h9-1" id="h9-1" class="h">@@ -137,13 +137,16 @@ int inspect_index(int argc, char **argv) {
</a>            chunk_file_size,
            chunk_file_size / double(1 &lt;&lt; 20));
 
<a href="#h9-1-3" id="h9-1-3" class="d">-    if (FLAGS_dump_repos) {
</a><a href="#h9-1-4" id="h9-1-4" class="i">+    if (FLAGS_dump_trees) {
</a>         code_searcher cs;
         cs.load_index(argv[0]);
<a href="#h9-1-7" id="h9-1-7" class="d">-        auto repos = cs.repos();
</a><a href="#h9-1-8" id="h9-1-8" class="d">-        printf(&quot;Repos:\n&quot;);
</a><a href="#h9-1-9" id="h9-1-9" class="d">-        for (auto it = repos.begin(); it != repos.end(); ++it) {
</a><a href="#h9-1-10" id="h9-1-10" class="d">-            printf(&quot; %s\n&quot;, it-&gt;name.c_str());
</a><a href="#h9-1-11" id="h9-1-11" class="i">+        auto trees = cs.trees();
</a><a href="#h9-1-12" id="h9-1-12" class="i">+        printf(&quot;Trees:\n&quot;);
</a><a href="#h9-1-13" id="h9-1-13" class="i">+        for (auto it = trees.begin(); it != trees.end(); ++it) {
</a><a href="#h9-1-14" id="h9-1-14" class="i">+            printf(&quot; %s%s%s\n&quot;,
</a><a href="#h9-1-15" id="h9-1-15" class="i">+                   it-&gt;name.c_str(),
</a><a href="#h9-1-16" id="h9-1-16" class="i">+                   it-&gt;version.empty() ? &quot;&quot; : &quot;:&quot;,
</a><a href="#h9-1-17" id="h9-1-17" class="i">+                   it-&gt;version.c_str());
</a>         }
     }
 
<b>diff --git a/<a id="h10" href="../file/src/tools/interface.cc">src/tools/interface.cc</a> b/<a href="../file/src/tools/interface.cc">src/tools/interface.cc</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -95,19 +95,14 @@ public:
</a>     }
 
     virtual void print_match(const match_result *m) {
<a href="#h10-0-3" id="h10-0-3" class="d">-        for (auto ctx = m-&gt;context.begin();
</a><a href="#h10-0-4" id="h10-0-4" class="d">-             ctx != m-&gt;context.end(); ++ctx) {
</a><a href="#h10-0-5" id="h10-0-5" class="d">-            for (auto it = ctx-&gt;paths.begin(); it != ctx-&gt;paths.end(); ++it) {
</a><a href="#h10-0-6" id="h10-0-6" class="d">-                fprintf(out_,
</a><a href="#h10-0-7" id="h10-0-7" class="d">-                        &quot;%s:%s:%s:%d:%d-%d: %.*s\n&quot;,
</a><a href="#h10-0-8" id="h10-0-8" class="d">-                        it-&gt;tree-&gt;repo-&gt;name.c_str(),
</a><a href="#h10-0-9" id="h10-0-9" class="d">-                        it-&gt;tree-&gt;revision.c_str(),
</a><a href="#h10-0-10" id="h10-0-10" class="d">-                        it-&gt;path.c_str(),
</a><a href="#h10-0-11" id="h10-0-11" class="d">-                        ctx-&gt;lno,
</a><a href="#h10-0-12" id="h10-0-12" class="d">-                        m-&gt;matchleft, m-&gt;matchright,
</a><a href="#h10-0-13" id="h10-0-13" class="d">-                        m-&gt;line.size(), m-&gt;line.data());
</a><a href="#h10-0-14" id="h10-0-14" class="d">-            }
</a><a href="#h10-0-15" id="h10-0-15" class="d">-        }
</a><a href="#h10-0-16" id="h10-0-16" class="i">+        fprintf(out_,
</a><a href="#h10-0-17" id="h10-0-17" class="i">+                &quot;%s:%s:%s:%d:%d-%d: %.*s\n&quot;,
</a><a href="#h10-0-18" id="h10-0-18" class="i">+                m-&gt;file-&gt;tree-&gt;name.c_str(),
</a><a href="#h10-0-19" id="h10-0-19" class="i">+                m-&gt;file-&gt;tree-&gt;version.c_str(),
</a><a href="#h10-0-20" id="h10-0-20" class="i">+                m-&gt;file-&gt;path.c_str(),
</a><a href="#h10-0-21" id="h10-0-21" class="i">+                m-&gt;lno,
</a><a href="#h10-0-22" id="h10-0-22" class="i">+                m-&gt;matchleft, m-&gt;matchright,
</a><a href="#h10-0-23" id="h10-0-23" class="i">+                m-&gt;line.size(), m-&gt;line.data());
</a>     }
 
     virtual void print_error(const std::string &amp;err) {
<b>diff --git a/<a id="h11" href="../file/src/tools/json_interface.cc">src/tools/json_interface.cc</a> b/<a href="../file/src/tools/json_interface.cc">src/tools/json_interface.cc</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -28,19 +28,12 @@ json_object *to_json(int i) {
</a>     return json_object_new_int(i);
 }
 
<a href="#h11-0-3" id="h11-0-3" class="d">-static json_object *to_json(const indexed_path &amp;path) {
</a><a href="#h11-0-4" id="h11-0-4" class="i">+json_object *to_json(const indexed_tree &amp;tree) {
</a>     json_object *out = json_object_new_object();
<a href="#h11-0-6" id="h11-0-6" class="d">-    json_object_object_add(out, &quot;repo&quot;, to_json(path.tree-&gt;repo-&gt;name));
</a><a href="#h11-0-7" id="h11-0-7" class="d">-    json_object_object_add(out, &quot;ref&quot;,  to_json(path.tree-&gt;revision));
</a><a href="#h11-0-8" id="h11-0-8" class="d">-    json_object_object_add(out, &quot;path&quot;, to_json(path.path));
</a><a href="#h11-0-9" id="h11-0-9" class="d">-    return out;
</a><a href="#h11-0-10" id="h11-0-10" class="d">-}
</a><a href="#h11-0-11" id="h11-0-11" class="d">-
</a><a href="#h11-0-12" id="h11-0-12" class="d">-json_object *to_json(const indexed_repo &amp;repo) {
</a><a href="#h11-0-13" id="h11-0-13" class="d">-    json_object *out = json_object_new_object();
</a><a href="#h11-0-14" id="h11-0-14" class="d">-    json_object_object_add(out, &quot;name&quot;, to_json(repo.name));
</a><a href="#h11-0-15" id="h11-0-15" class="d">-    if (repo.metadata)
</a><a href="#h11-0-16" id="h11-0-16" class="d">-        json_object_object_add(out, &quot;metadata&quot;, json_object_get(repo.metadata));
</a><a href="#h11-0-17" id="h11-0-17" class="i">+    json_object_object_add(out, &quot;name&quot;, to_json(tree.name));
</a><a href="#h11-0-18" id="h11-0-18" class="i">+    json_object_object_add(out, &quot;version&quot;, to_json(tree.version));
</a><a href="#h11-0-19" id="h11-0-19" class="i">+    if (tree.metadata)
</a><a href="#h11-0-20" id="h11-0-20" class="i">+        json_object_object_add(out, &quot;metadata&quot;, json_object_get(tree.metadata));
</a>     return out;
 }
 
<a href="#h11-1" id="h11-1" class="h">@@ -52,7 +45,6 @@ json_object *to_json(vector&lt;T&gt; vec) {
</a>     return out;
 }
 
<a href="#h11-1-3" id="h11-1-3" class="d">-
</a> json_object *json_frame(const std::string op, json_object *body) {
     json_object *frame = json_object_new_object();
     json_object_object_add(frame, &quot;opcode&quot;, to_json(op));
<a href="#h11-2" id="h11-2" class="h">@@ -62,7 +54,7 @@ json_object *json_frame(const std::string op, json_object *body) {
</a> 
 json_object *json_info(const code_searcher *cs) {
     json_object *obj = json_object_new_object();
<a href="#h11-2-3" id="h11-2-3" class="d">-    json_object_object_add(obj, &quot;repos&quot;, to_json(cs-&gt;repos()));
</a><a href="#h11-2-4" id="h11-2-4" class="i">+    json_object_object_add(obj, &quot;trees&quot;, to_json(cs-&gt;trees()));
</a>     json_object_object_add(obj, &quot;name&quot;, to_json(cs-&gt;name()));
     return obj;
 }
<a href="#h11-3" id="h11-3" class="h">@@ -173,19 +165,15 @@ public:
</a> 
     virtual void print_match(const match_result *m) {
         json_object *obj = json_object_new_object();
<a href="#h11-3-3" id="h11-3-3" class="d">-        json_object *contexts = json_object_new_array();
</a><a href="#h11-3-4" id="h11-3-4" class="d">-        for (auto ctx = m-&gt;context.begin();
</a><a href="#h11-3-5" id="h11-3-5" class="d">-             ctx != m-&gt;context.end(); ++ctx) {
</a><a href="#h11-3-6" id="h11-3-6" class="d">-            json_object *jctx = json_object_new_object();
</a><a href="#h11-3-7" id="h11-3-7" class="d">-            json_object_object_add(jctx, &quot;paths&quot;,  to_json(ctx-&gt;paths));
</a><a href="#h11-3-8" id="h11-3-8" class="d">-            json_object_object_add(jctx, &quot;lno&quot;, to_json(ctx-&gt;lno));
</a><a href="#h11-3-9" id="h11-3-9" class="d">-            json_object_object_add(jctx, &quot;context_before&quot;,
</a><a href="#h11-3-10" id="h11-3-10" class="d">-                                   to_json(ctx-&gt;context_before));
</a><a href="#h11-3-11" id="h11-3-11" class="d">-            json_object_object_add(jctx, &quot;context_after&quot;,
</a><a href="#h11-3-12" id="h11-3-12" class="d">-                                   to_json(ctx-&gt;context_after));
</a><a href="#h11-3-13" id="h11-3-13" class="d">-            json_object_array_add(contexts, jctx);
</a><a href="#h11-3-14" id="h11-3-14" class="d">-        }
</a><a href="#h11-3-15" id="h11-3-15" class="d">-        json_object_object_add(obj, &quot;contexts&quot;, contexts);
</a><a href="#h11-3-16" id="h11-3-16" class="i">+
</a><a href="#h11-3-17" id="h11-3-17" class="i">+        json_object_object_add(obj, &quot;tree&quot;,  to_json(m-&gt;file-&gt;tree-&gt;name));
</a><a href="#h11-3-18" id="h11-3-18" class="i">+        json_object_object_add(obj, &quot;version&quot;,  to_json(m-&gt;file-&gt;tree-&gt;version));
</a><a href="#h11-3-19" id="h11-3-19" class="i">+        json_object_object_add(obj, &quot;path&quot;,  to_json(m-&gt;file-&gt;path));
</a><a href="#h11-3-20" id="h11-3-20" class="i">+        json_object_object_add(obj, &quot;lno&quot;, to_json(m-&gt;lno));
</a><a href="#h11-3-21" id="h11-3-21" class="i">+        json_object_object_add(obj, &quot;context_before&quot;,
</a><a href="#h11-3-22" id="h11-3-22" class="i">+                               to_json(m-&gt;context_before));
</a><a href="#h11-3-23" id="h11-3-23" class="i">+        json_object_object_add(obj, &quot;context_after&quot;,
</a><a href="#h11-3-24" id="h11-3-24" class="i">+                               to_json(m-&gt;context_after));
</a>         json_object *bounds = json_object_new_array();
         json_object_array_add(bounds, to_json(m-&gt;matchleft));
         json_object_array_add(bounds, to_json(m-&gt;matchright));
<b>diff --git a/<a id="h12" href="../file/test/codesearch_test.cc">test/codesearch_test.cc</a> b/<a href="../file/test/codesearch_test.cc">test/codesearch_test.cc</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -8,12 +8,10 @@ class codesearch_test : public ::testing::Test {
</a> protected:
     codesearch_test() {
         cs_.set_alloc(make_mem_allocator());
<a href="#h12-0-3" id="h12-0-3" class="d">-        repo_ = cs_.open_repo(&quot;REPO&quot;, 0);
</a><a href="#h12-0-4" id="h12-0-4" class="d">-        tree_ = cs_.open_revision(repo_, &quot;REV0&quot;);
</a><a href="#h12-0-5" id="h12-0-5" class="i">+        tree_ = cs_.open_tree(&quot;REPO&quot;, 0, &quot;REV0&quot;);
</a>     }
 
     code_searcher cs_;
<a href="#h12-0-9" id="h12-0-9" class="d">-    const indexed_repo *repo_;
</a>     const indexed_tree *tree_;
 };
 
<a href="#h12-1" id="h12-1" class="h">@@ -28,8 +26,8 @@ TEST_F(codesearch_test, IndexTest) {
</a>     EXPECT_EQ(1, cs_.end_files() - cs_.begin_files());
 
     indexed_file *f = *cs_.begin_files();
<a href="#h12-1-3" id="h12-1-3" class="d">-    EXPECT_EQ(&quot;/data/file1&quot;, f-&gt;paths[0].path);
</a><a href="#h12-1-4" id="h12-1-4" class="d">-    EXPECT_EQ(tree_, f-&gt;paths[0].tree);
</a><a href="#h12-1-5" id="h12-1-5" class="i">+    EXPECT_EQ(&quot;/data/file1&quot;, f-&gt;path);
</a><a href="#h12-1-6" id="h12-1-6" class="i">+    EXPECT_EQ(tree_, f-&gt;tree);
</a> 
     string content;
 
<a href="#h12-2" id="h12-2" class="h">@@ -66,8 +64,7 @@ TEST_F(codesearch_test, DuplicateLinesInFile) {
</a>     vector&lt;match_result&gt; results;
     search.match(q, accumulate_matches(&amp;results), &amp;stats);
 
<a href="#h12-2-3" id="h12-2-3" class="d">-    ASSERT_EQ(1, results.size());
</a><a href="#h12-2-4" id="h12-2-4" class="d">-    ASSERT_EQ(2, results[0].context.size());
</a><a href="#h12-2-5" id="h12-2-5" class="d">-    EXPECT_EQ(1, results[0].context[0].lno);
</a><a href="#h12-2-6" id="h12-2-6" class="d">-    EXPECT_EQ(2, results[0].context[1].lno);
</a><a href="#h12-2-7" id="h12-2-7" class="i">+    ASSERT_EQ(2, results.size());
</a><a href="#h12-2-8" id="h12-2-8" class="i">+    EXPECT_EQ(1, results[0].lno);
</a><a href="#h12-2-9" id="h12-2-9" class="i">+    EXPECT_EQ(2, results[1].lno);
</a> }
</pre>
</div>
</body>
</html>
