<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Support talking to multiple codesearch backends in the web interface. - livegrep - Fast, regular expression code search service</title>
<meta name="description" content="Fast, regular expression code search service" />
<meta name="author" content="Kevin Lin" />
<link rel="icon" type="image/png" href="https://static.kevinlin.info/favicon.png" />
<link rel="alternate" type="application/atom+xml" title="livegrep Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="livegrep Atom Feed (tags)" href="../tags.xml" />
<style type="text/css">
body{color:#000;background-color:#fff;font-family:monospace}h1,h2,h3,h4,h5,h6{font-size:1em;margin:0}img,h1,h2{vertical-align:middle}img{border:0}a:target{background-color:#ccc}a.d,a.h,a.i{text-decoration:none}a.line{text-decoration:none;user-select:none}#blob a{color:#555}#blob a:hover{color:blue;text-decoration:none}table thead td{font-weight:bold}table td{padding:0 .4em}table td pre{margin:0}#content table td{vertical-align:top;white-space:nowrap}#branches tr:hover td,#tags tr:hover td,#index tr:hover td,#log tr:hover td,#files tr:hover td{background-color:#eee}#index tr td:nth-child(2),#tags tr td:nth-child(3),#branches tr td:nth-child(3),#log tr td:nth-child(2){white-space:normal}td.num{text-align:right}.desc{color:#555}hr{border:0;border-top:1px solid #555;height:1px}pre{font-family:monospace}pre a.h{color:#00a}.A,span.i,pre a.i{color:#070}.D,span.d,pre a.d{color:#e00}pre a.h:hover,pre a.i:hover,pre a.d:hover{text-decoration:none}
</style>
</head>
<body>
<table><tr><td><a href="/"><img src="https://static.kevinlin.info/favicon.png" alt="" width="32" height="32" /></a></td><td><h1>livegrep</h1><span class="desc">Fast, regular expression code search service</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://source.static.kevinlin.info/external/livegrep.git">https://source.static.kevinlin.info/external/livegrep.git</a></td></tr><tr><td></td><td>
<a href="../log">Log</a> | <a href="../files">Files</a> | <a href="../refs">Refs</a> | <a href="../file/README.md">README</a> | <a href="../file/COPYING">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/43730a6a4323326019293ee92280a03b2921b012">43730a6a4323326019293ee92280a03b2921b012</a>
<b>parent</b> <a href="../commit/f49803b254187500178a3384cc894d6e1e064f17">f49803b254187500178a3384cc894d6e1e064f17</a>
<b>Author:</b> Nelson Elhage &lt;<a href="mailto:nelhage@nelhage.com">nelhage@nelhage.com</a>&gt;
<b>Date:</b>   Sat,  2 Feb 2013 16:59:28 -0800

Support talking to multiple codesearch backends in the web interface.

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">web/appserver.js</a></td><td> | </td><td class="num">217</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">-----------------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h1">web/backend.js</a></td><td> | </td><td class="num">22</td><td><span class="i">++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">web/config.js</a></td><td> | </td><td class="num">23</td><td><span class="i">+++++++++++++</span><span class="d">----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">web/cs_server.js</a></td><td> | </td><td class="num">21</td><td><span class="i">+++++++++++++++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">web/htdocs/codesearch.js</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">web/htdocs/codesearch_ui.js</a></td><td> | </td><td class="num">41</td><td><span class="i">+++++++++++++++++++++++++++</span><span class="d">--------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">web/index.js</a></td><td> | </td><td class="num">52</td><td><span class="i">+++++++++++++++++++++++++++++++++</span><span class="d">-------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">web/templates/index.html</a></td><td> | </td><td class="num">8</td><td><span class="i">+++++++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h8">web/web_server.js</a></td><td> | </td><td class="num">16</td><td><span class="i">+++++++++++++</span><span class="d">---</span></td></tr>
</table></pre><pre>9 files changed, 252 insertions(+), 152 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/web/appserver.js">web/appserver.js</a> b/<a href="../file/web/appserver.js">web/appserver.js</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -15,9 +15,9 @@ function remote_address(sock) {
</a>   return {};
 }
 
<a href="#h0-0-3" id="h0-0-3" class="d">-function Client(parent, pool, sock) {
</a><a href="#h0-0-4" id="h0-0-4" class="i">+function Client(parent, sock) {
</a>   this.parent = parent;
<a href="#h0-0-6" id="h0-0-6" class="d">-  this.pool   = pool;
</a><a href="#h0-0-7" id="h0-0-7" class="i">+  this.is_fast = true;
</a>   this.socket = sock;
   this.pending_search = null;
   this.last_search = null;
<a href="#h0-1" id="h0-1" class="h">@@ -27,6 +27,12 @@ function Client(parent, pool, sock) {
</a>   this.last_slow   = null;
 }
 
<a href="#h0-1-3" id="h0-1-3" class="i">+var DEFAULT_BACKEND = &#39;livegrep&#39;;
</a><a href="#h0-1-4" id="h0-1-4" class="i">+
</a><a href="#h0-1-5" id="h0-1-5" class="i">+Client.prototype.pool = function(search) {
</a><a href="#h0-1-6" id="h0-1-6" class="i">+  return this.parent.pools[search.backend][this.is_fast ? &quot;fast&quot; : &quot;slow&quot;];
</a><a href="#h0-1-7" id="h0-1-7" class="i">+}
</a><a href="#h0-1-8" id="h0-1-8" class="i">+
</a> Client.prototype.debug = function() {
   logger.debug(&quot;[%s:%d] %s&quot;,
                this.remote_address.address,
<a href="#h0-2" id="h0-2" class="h">@@ -34,21 +40,19 @@ Client.prototype.debug = function() {
</a>                util.format.apply(null, arguments));
 }
 
<a href="#h0-2-3" id="h0-2-3" class="d">-Client.prototype.new_search = function (line, file, id) {
</a><a href="#h0-2-4" id="h0-2-4" class="d">-  this.debug(&#39;new search: (%s) (%j)&#39;, id, {line:line, file:file});
</a><a href="#h0-2-5" id="h0-2-5" class="i">+Client.prototype.new_search = function (opts) {
</a><a href="#h0-2-6" id="h0-2-6" class="i">+  opts.backend = opts.backend || DEFAULT_BACKEND;
</a><a href="#h0-2-7" id="h0-2-7" class="i">+  this.debug(&#39;new search: %j&#39;, opts);
</a>   if (this.last_search &amp;&amp;
<a href="#h0-2-9" id="h0-2-9" class="d">-      line === this.last_search.line &amp;&amp;
</a><a href="#h0-2-10" id="h0-2-10" class="d">-      file === this.last_search.file)
</a><a href="#h0-2-11" id="h0-2-11" class="i">+      opts.line === this.last_search.line &amp;&amp;
</a><a href="#h0-2-12" id="h0-2-12" class="i">+      opts.file === this.last_search.file &amp;&amp;
</a><a href="#h0-2-13" id="h0-2-13" class="i">+      opts.backend === this.last_search.backend)
</a>     return;
<a href="#h0-2-15" id="h0-2-15" class="d">-  if (line === &#39;&#39;) {
</a><a href="#h0-2-16" id="h0-2-16" class="i">+  if (opts.line === &#39;&#39;) {
</a>     this.last_search = null;
     return;
   }
<a href="#h0-2-20" id="h0-2-20" class="d">-  this.pending_search = {
</a><a href="#h0-2-21" id="h0-2-21" class="d">-    line: line,
</a><a href="#h0-2-22" id="h0-2-22" class="d">-    file: file,
</a><a href="#h0-2-23" id="h0-2-23" class="d">-    id: id
</a><a href="#h0-2-24" id="h0-2-24" class="d">-  };
</a><a href="#h0-2-25" id="h0-2-25" class="i">+  this.pending_search = opts;
</a>   this.dispatch_search();
 }
 
<a href="#h0-3" id="h0-3" class="h">@@ -57,17 +61,17 @@ Client.prototype.search_done = function() {
</a>   process.nextTick(this.dispatch_search.bind(this));
 }
 
<a href="#h0-3-3" id="h0-3-3" class="d">-Client.prototype.switch_pool = function(pool) {
</a><a href="#h0-3-4" id="h0-3-4" class="d">-  if (this.pool === pool)
</a><a href="#h0-3-5" id="h0-3-5" class="i">+Client.prototype.mark_fast = function(fast) {
</a><a href="#h0-3-6" id="h0-3-6" class="i">+  if (this.is_fast === fast)
</a>     return;
<a href="#h0-3-8" id="h0-3-8" class="d">-  this.debug(&quot;Switching to %s pool&quot;, pool.stats.name);
</a><a href="#h0-3-9" id="h0-3-9" class="d">-  this.pool = pool;
</a><a href="#h0-3-10" id="h0-3-10" class="i">+  this.debug(&quot;Switching to %s pools&quot;, fast ? &quot;fast&quot; : &quot;slow&quot;);
</a><a href="#h0-3-11" id="h0-3-11" class="i">+  this.is_fast = fast;
</a> }
 
 Client.prototype.slow_query = function() {
   this.last_slow = new Date();
   this.fast_streak = 0;
<a href="#h0-3-17" id="h0-3-17" class="d">-  this.switch_pool(this.parent.slow_pool);
</a><a href="#h0-3-18" id="h0-3-18" class="i">+  this.mark_fast(false);
</a> }
 
 Client.prototype.fast_query = function() {
<a href="#h0-4" id="h0-4" class="h">@@ -75,13 +79,13 @@ Client.prototype.fast_query = function() {
</a>   if ((new Date() - this.last_slow) &lt; this.parent.config.MIN_SLOW_TIME)
     return;
   if (this.fast_streak &gt;= this.parent.config.QUERY_STREAK)
<a href="#h0-4-3" id="h0-4-3" class="d">-    this.switch_pool(this.parent.fast_pool);
</a><a href="#h0-4-4" id="h0-4-4" class="i">+    this.mark_fast(true);
</a> }
 
<a href="#h0-4-7" id="h0-4-7" class="d">-Client.prototype.sort_matches = function(matches) {
</a><a href="#h0-4-8" id="h0-4-8" class="i">+Client.prototype.sort_matches = function(pool, matches) {
</a>   var order =  {};
<a href="#h0-4-10" id="h0-4-10" class="d">-  for (var i = 0; i &lt; this.parent.config.BACKEND.sort.length; i++)
</a><a href="#h0-4-11" id="h0-4-11" class="d">-    order[this.parent.config.BACKEND.sort[i]] = i;
</a><a href="#h0-4-12" id="h0-4-12" class="i">+  for (var i = 0; i &lt; pool.backend.sort.length; i++)
</a><a href="#h0-4-13" id="h0-4-13" class="i">+    order[pool.backend.sort[i]] = i;
</a>   function sort_order(path) {
     var dir = /^[^\/]+/.exec(path)[0];
     if (dir in order)
<a href="#h0-5" id="h0-5" class="h">@@ -105,71 +109,74 @@ Client.prototype.sort_matches = function(matches) {
</a> }
 
 Client.prototype.dispatch_search = function() {
<a href="#h0-5-3" id="h0-5-3" class="d">-  if (this.pending_search !== null &amp;&amp;
</a><a href="#h0-5-4" id="h0-5-4" class="d">-      !this.active_search &amp;&amp;
</a><a href="#h0-5-5" id="h0-5-5" class="d">-      this.pool.remotes.length) {
</a><a href="#h0-5-6" id="h0-5-6" class="d">-    if (this.last_slow &amp;&amp;
</a><a href="#h0-5-7" id="h0-5-7" class="d">-        (new Date() - this.last_slow) &gt;= this.parent.config.MAX_SLOW_TIME)
</a><a href="#h0-5-8" id="h0-5-8" class="d">-      this.switch_pool(this.parent.fast_pool);
</a><a href="#h0-5-9" id="h0-5-9" class="i">+  if (this.pending_search === null || this.active_search)
</a><a href="#h0-5-10" id="h0-5-10" class="i">+    return;
</a><a href="#h0-5-11" id="h0-5-11" class="i">+  var pool = this.pool(this.pending_search);
</a><a href="#h0-5-12" id="h0-5-12" class="i">+  if (!pool.remotes)
</a><a href="#h0-5-13" id="h0-5-13" class="i">+    return;
</a> 
<a href="#h0-5-15" id="h0-5-15" class="d">-    var codesearch = this.pool.remotes.pop();
</a><a href="#h0-5-16" id="h0-5-16" class="d">-    console.assert(codesearch.cs_ready);
</a><a href="#h0-5-17" id="h0-5-17" class="d">-    var start = new Date();
</a><a href="#h0-5-18" id="h0-5-18" class="d">-    this.last_search = this.pending_search;
</a><a href="#h0-5-19" id="h0-5-19" class="d">-    this.debug(&#39;dispatching: (%j) to %s-%d...&#39;,
</a><a href="#h0-5-20" id="h0-5-20" class="d">-      this.pending_search,
</a><a href="#h0-5-21" id="h0-5-21" class="d">-      this.pool.stats.name,
</a><a href="#h0-5-22" id="h0-5-22" class="d">-      codesearch.__id);
</a><a href="#h0-5-23" id="h0-5-23" class="i">+  if (this.last_slow &amp;&amp;
</a><a href="#h0-5-24" id="h0-5-24" class="i">+      (new Date() - this.last_slow) &gt;= this.parent.config.MAX_SLOW_TIME)
</a><a href="#h0-5-25" id="h0-5-25" class="i">+    this.mark_fast(true);
</a> 
<a href="#h0-5-27" id="h0-5-27" class="d">-    var search = this.pending_search;
</a><a href="#h0-5-28" id="h0-5-28" class="d">-    this.pending_search = null;
</a><a href="#h0-5-29" id="h0-5-29" class="d">-    this.active_search  = search;
</a><a href="#h0-5-30" id="h0-5-30" class="d">-    var self   = this;
</a><a href="#h0-5-31" id="h0-5-31" class="d">-    var sock   = this.socket;
</a><a href="#h0-5-32" id="h0-5-32" class="d">-    var batch  = new Batch(function (m) {
</a><a href="#h0-5-33" id="h0-5-33" class="d">-                             sock.emit(&#39;match&#39;, search.id, m);
</a><a href="#h0-5-34" id="h0-5-34" class="d">-                           }, 50,
</a><a href="#h0-5-35" id="h0-5-35" class="d">-                           function (matches) {
</a><a href="#h0-5-36" id="h0-5-36" class="d">-                             return self.sort_matches(matches)
</a><a href="#h0-5-37" id="h0-5-37" class="d">-                           });
</a><a href="#h0-5-38" id="h0-5-38" class="d">-    var cbs = {
</a><a href="#h0-5-39" id="h0-5-39" class="d">-      not_ready: function() {
</a><a href="#h0-5-40" id="h0-5-40" class="d">-        logger.info(&#39;Remote reports not ready for %j&#39;, search);
</a><a href="#h0-5-41" id="h0-5-41" class="d">-        if (self.pending_search === null)
</a><a href="#h0-5-42" id="h0-5-42" class="d">-          self.pending_search = search;
</a><a href="#h0-5-43" id="h0-5-43" class="d">-        self.search_done();
</a><a href="#h0-5-44" id="h0-5-44" class="d">-        codesearch.cs_client = null;
</a><a href="#h0-5-45" id="h0-5-45" class="d">-      },
</a><a href="#h0-5-46" id="h0-5-46" class="d">-      error: function (err) {
</a><a href="#h0-5-47" id="h0-5-47" class="d">-        sock.emit(&#39;regex_error&#39;, search.id, err);
</a><a href="#h0-5-48" id="h0-5-48" class="d">-        self.search_done();
</a><a href="#h0-5-49" id="h0-5-49" class="d">-        codesearch.cs_client = null;
</a><a href="#h0-5-50" id="h0-5-50" class="d">-      },
</a><a href="#h0-5-51" id="h0-5-51" class="d">-      match: function (match) {
</a><a href="#h0-5-52" id="h0-5-52" class="d">-        match = JSON.parse(match);
</a><a href="#h0-5-53" id="h0-5-53" class="d">-        logger.trace(&quot;Reporting match %j for %j.&quot;, match, search);
</a><a href="#h0-5-54" id="h0-5-54" class="d">-        batch.send(match);
</a><a href="#h0-5-55" id="h0-5-55" class="d">-      },
</a><a href="#h0-5-56" id="h0-5-56" class="d">-      done: function (stats) {
</a><a href="#h0-5-57" id="h0-5-57" class="d">-        stats = JSON.parse(stats);
</a><a href="#h0-5-58" id="h0-5-58" class="d">-        var time = (new Date()) - start;
</a><a href="#h0-5-59" id="h0-5-59" class="d">-        self.pool.stats.done(search.id, start, time);
</a><a href="#h0-5-60" id="h0-5-60" class="d">-        batch.flush();
</a><a href="#h0-5-61" id="h0-5-61" class="d">-        sock.emit(&#39;search_done&#39;, search.id, time, stats.why);
</a><a href="#h0-5-62" id="h0-5-62" class="d">-        self.debug(&quot;Search done: (%j): %s&quot;, search, time);
</a><a href="#h0-5-63" id="h0-5-63" class="d">-        if (time &gt; self.parent.config.SLOW_THRESHOLD) {
</a><a href="#h0-5-64" id="h0-5-64" class="d">-          self.slow_query();
</a><a href="#h0-5-65" id="h0-5-65" class="d">-        } else {
</a><a href="#h0-5-66" id="h0-5-66" class="d">-          self.fast_query();
</a><a href="#h0-5-67" id="h0-5-67" class="d">-        }
</a><a href="#h0-5-68" id="h0-5-68" class="d">-        self.search_done();
</a><a href="#h0-5-69" id="h0-5-69" class="d">-        codesearch.cs_client = null;
</a><a href="#h0-5-70" id="h0-5-70" class="i">+  var codesearch = pool.remotes.pop();
</a><a href="#h0-5-71" id="h0-5-71" class="i">+  console.assert(codesearch.cs_ready);
</a><a href="#h0-5-72" id="h0-5-72" class="i">+  var start = new Date();
</a><a href="#h0-5-73" id="h0-5-73" class="i">+  this.last_search = this.pending_search;
</a><a href="#h0-5-74" id="h0-5-74" class="i">+  this.debug(&#39;dispatching: (%j) to %s-%d...&#39;,
</a><a href="#h0-5-75" id="h0-5-75" class="i">+    this.pending_search,
</a><a href="#h0-5-76" id="h0-5-76" class="i">+    pool.stats.name,
</a><a href="#h0-5-77" id="h0-5-77" class="i">+    codesearch.__id);
</a><a href="#h0-5-78" id="h0-5-78" class="i">+
</a><a href="#h0-5-79" id="h0-5-79" class="i">+  var search = this.pending_search;
</a><a href="#h0-5-80" id="h0-5-80" class="i">+  this.pending_search = null;
</a><a href="#h0-5-81" id="h0-5-81" class="i">+  this.active_search  = search;
</a><a href="#h0-5-82" id="h0-5-82" class="i">+  var self   = this;
</a><a href="#h0-5-83" id="h0-5-83" class="i">+  var sock   = this.socket;
</a><a href="#h0-5-84" id="h0-5-84" class="i">+  var batch  = new Batch(function (m) {
</a><a href="#h0-5-85" id="h0-5-85" class="i">+                           sock.emit(&#39;match&#39;, search.id, m);
</a><a href="#h0-5-86" id="h0-5-86" class="i">+                         }, 50,
</a><a href="#h0-5-87" id="h0-5-87" class="i">+                         function (matches) {
</a><a href="#h0-5-88" id="h0-5-88" class="i">+                           return self.sort_matches(pool, matches)
</a><a href="#h0-5-89" id="h0-5-89" class="i">+                         });
</a><a href="#h0-5-90" id="h0-5-90" class="i">+  var cbs = {
</a><a href="#h0-5-91" id="h0-5-91" class="i">+    not_ready: function() {
</a><a href="#h0-5-92" id="h0-5-92" class="i">+      logger.info(&#39;Remote reports not ready for %j&#39;, search);
</a><a href="#h0-5-93" id="h0-5-93" class="i">+      if (self.pending_search === null)
</a><a href="#h0-5-94" id="h0-5-94" class="i">+        self.pending_search = search;
</a><a href="#h0-5-95" id="h0-5-95" class="i">+      self.search_done();
</a><a href="#h0-5-96" id="h0-5-96" class="i">+      codesearch.cs_client = null;
</a><a href="#h0-5-97" id="h0-5-97" class="i">+    },
</a><a href="#h0-5-98" id="h0-5-98" class="i">+    error: function (err) {
</a><a href="#h0-5-99" id="h0-5-99" class="i">+      sock.emit(&#39;regex_error&#39;, search.id, err);
</a><a href="#h0-5-100" id="h0-5-100" class="i">+      self.search_done();
</a><a href="#h0-5-101" id="h0-5-101" class="i">+      codesearch.cs_client = null;
</a><a href="#h0-5-102" id="h0-5-102" class="i">+    },
</a><a href="#h0-5-103" id="h0-5-103" class="i">+    match: function (match) {
</a><a href="#h0-5-104" id="h0-5-104" class="i">+      match = JSON.parse(match);
</a><a href="#h0-5-105" id="h0-5-105" class="i">+      match.backend = search.backend;
</a><a href="#h0-5-106" id="h0-5-106" class="i">+      logger.trace(&quot;Reporting match %j for %j.&quot;, match, search);
</a><a href="#h0-5-107" id="h0-5-107" class="i">+      batch.send(match);
</a><a href="#h0-5-108" id="h0-5-108" class="i">+    },
</a><a href="#h0-5-109" id="h0-5-109" class="i">+    done: function (stats) {
</a><a href="#h0-5-110" id="h0-5-110" class="i">+      stats = JSON.parse(stats);
</a><a href="#h0-5-111" id="h0-5-111" class="i">+      var time = (new Date()) - start;
</a><a href="#h0-5-112" id="h0-5-112" class="i">+      pool.stats.done(search.id, start, time);
</a><a href="#h0-5-113" id="h0-5-113" class="i">+      batch.flush();
</a><a href="#h0-5-114" id="h0-5-114" class="i">+      sock.emit(&#39;search_done&#39;, search.id, time, stats.why);
</a><a href="#h0-5-115" id="h0-5-115" class="i">+      self.debug(&quot;Search done: (%j): %s&quot;, search, time);
</a><a href="#h0-5-116" id="h0-5-116" class="i">+      if (time &gt; self.parent.config.SLOW_THRESHOLD) {
</a><a href="#h0-5-117" id="h0-5-117" class="i">+        self.slow_query();
</a><a href="#h0-5-118" id="h0-5-118" class="i">+      } else {
</a><a href="#h0-5-119" id="h0-5-119" class="i">+        self.fast_query();
</a>       }
<a href="#h0-5-121" id="h0-5-121" class="i">+      self.search_done();
</a><a href="#h0-5-122" id="h0-5-122" class="i">+      codesearch.cs_client = null;
</a>     }
<a href="#h0-5-124" id="h0-5-124" class="d">-    codesearch.try_search(search.line, search.file, cbs);
</a><a href="#h0-5-125" id="h0-5-125" class="d">-    codesearch.cs_ready = false;
</a><a href="#h0-5-126" id="h0-5-126" class="d">-    codesearch.cs_client = this;
</a>   }
<a href="#h0-5-128" id="h0-5-128" class="i">+  codesearch.try_search(search.line, search.file, cbs);
</a><a href="#h0-5-129" id="h0-5-129" class="i">+  codesearch.cs_ready = false;
</a><a href="#h0-5-130" id="h0-5-130" class="i">+  codesearch.cs_client = this;
</a> }
 
 function ConnectionPool(server, name, backend) {
<a href="#h0-6" id="h0-6" class="h">@@ -179,6 +186,7 @@ function ConnectionPool(server, name, backend) {
</a>   this.connections = [];
   this.stats       = new QueryStats(name, {timeout: 5*60*1000});
   this.stats.start();
<a href="#h0-6-3" id="h0-6-3" class="i">+  this.backend = backend;
</a> 
   var id = 0;
   for (var i = 0; i &lt; backend.connections; i++) {
<a href="#h0-7" id="h0-7" class="h">@@ -255,23 +263,37 @@ ConnectionPool.prototype.dispatch = function () {
</a> }
 
 function SearchServer(config, io) {
<a href="#h0-7-3" id="h0-7-3" class="d">-  var parent = this;
</a><a href="#h0-7-4" id="h0-7-4" class="i">+  var self = this;
</a>   this.config  = config;
   this.clients = {};
<a href="#h0-7-7" id="h0-7-7" class="d">-  this.fast_pool = new ConnectionPool(this, &#39;fast&#39;, config.BACKEND);
</a><a href="#h0-7-8" id="h0-7-8" class="d">-  this.slow_pool = new ConnectionPool(this, &#39;slow&#39;, config.BACKEND);
</a><a href="#h0-7-9" id="h0-7-9" class="i">+  this.pools   = {};
</a><a href="#h0-7-10" id="h0-7-10" class="i">+  Object.keys(config.BACKENDS).forEach(function (name) {
</a><a href="#h0-7-11" id="h0-7-11" class="i">+    var backend = config.BACKENDS[name];
</a><a href="#h0-7-12" id="h0-7-12" class="i">+    self.pools[name] = {
</a><a href="#h0-7-13" id="h0-7-13" class="i">+      fast: new ConnectionPool(self, &#39;fast-&#39; + name, backend),
</a><a href="#h0-7-14" id="h0-7-14" class="i">+      slow: new ConnectionPool(self, &#39;slow-&#39; + name, backend),
</a><a href="#h0-7-15" id="h0-7-15" class="i">+    }
</a><a href="#h0-7-16" id="h0-7-16" class="i">+  });
</a> 
   var Server = function (sock) {
     logger.info(&quot;New client (%s)[%j]&quot;, sock.id, remote_address(sock));
<a href="#h0-7-20" id="h0-7-20" class="d">-    parent.clients[sock.id] = new Client(parent, parent.fast_pool, sock);
</a><a href="#h0-7-21" id="h0-7-21" class="d">-    sock.on(&#39;new_search&#39;, function(line, file, id) {
</a><a href="#h0-7-22" id="h0-7-22" class="d">-              if (id == null)
</a><a href="#h0-7-23" id="h0-7-23" class="d">-                id = line;
</a><a href="#h0-7-24" id="h0-7-24" class="d">-              parent.clients[sock.id].new_search(line, file, id);
</a><a href="#h0-7-25" id="h0-7-25" class="i">+    self.clients[sock.id] = new Client(self, sock);
</a><a href="#h0-7-26" id="h0-7-26" class="i">+    sock.on(&#39;new_search&#39;, function(opts, file, id) {
</a><a href="#h0-7-27" id="h0-7-27" class="i">+              if (typeof(opts) == &#39;string&#39;) {
</a><a href="#h0-7-28" id="h0-7-28" class="i">+                // Compatibility with the old API
</a><a href="#h0-7-29" id="h0-7-29" class="i">+                opts = {
</a><a href="#h0-7-30" id="h0-7-30" class="i">+                  line: opts,
</a><a href="#h0-7-31" id="h0-7-31" class="i">+                  file: file,
</a><a href="#h0-7-32" id="h0-7-32" class="i">+                  id: id
</a><a href="#h0-7-33" id="h0-7-33" class="i">+                }
</a><a href="#h0-7-34" id="h0-7-34" class="i">+              }
</a><a href="#h0-7-35" id="h0-7-35" class="i">+              if (opts.id == null)
</a><a href="#h0-7-36" id="h0-7-36" class="i">+                opts.id = opts.line;
</a><a href="#h0-7-37" id="h0-7-37" class="i">+              self.clients[sock.id].new_search(opts);
</a>     });
     sock.on(&#39;disconnect&#39;, function() {
               logger.info(&quot;Disconnected (%s)[%j]&quot;, sock.id, remote_address(sock));
<a href="#h0-7-41" id="h0-7-41" class="d">-              delete parent.clients[sock.id];
</a><a href="#h0-7-42" id="h0-7-42" class="i">+              delete self.clients[sock.id];
</a>             });
   };
 
<a href="#h0-8" id="h0-8" class="h">@@ -279,7 +301,7 @@ function SearchServer(config, io) {
</a>     new Server(sock);
   });
   setInterval(function() {
<a href="#h0-8-3" id="h0-8-3" class="d">-                parent.dump_stats();
</a><a href="#h0-8-4" id="h0-8-4" class="i">+                self.dump_stats();
</a>               }, 30*1000);
 }
 
<a href="#h0-9" id="h0-9" class="h">@@ -289,17 +311,18 @@ SearchServer.prototype.dump_stats = function() {
</a>   _.values(this.clients).forEach(
     function (c){
       clients++;
<a href="#h0-9-3" id="h0-9-3" class="d">-      if (c.pool === self.slow_pool)
</a><a href="#h0-9-4" id="h0-9-4" class="d">-        slow++;
</a><a href="#h0-9-5" id="h0-9-5" class="d">-      else if (c.pool === self.fast_pool)
</a><a href="#h0-9-6" id="h0-9-6" class="i">+      if (c.is_fast)
</a>         fast++;
       else
<a href="#h0-9-9" id="h0-9-9" class="d">-        console.log(&quot;WTF pool %j&quot;, c);
</a><a href="#h0-9-10" id="h0-9-10" class="i">+        slow++;
</a>     });
   logger.info(&quot;Clients/slow/fast: %d %d %d&quot;, clients, slow, fast);
   var stats = {};
<a href="#h0-9-14" id="h0-9-14" class="d">-  stats.slow = this.slow_pool.stats.stats();
</a><a href="#h0-9-15" id="h0-9-15" class="d">-  stats.fast = this.fast_pool.stats.stats();
</a><a href="#h0-9-16" id="h0-9-16" class="i">+  Object.keys(self.pools).forEach(function (name) {
</a><a href="#h0-9-17" id="h0-9-17" class="i">+    var pools = self.pools[name];
</a><a href="#h0-9-18" id="h0-9-18" class="i">+    stats[pools.slow.name] = pools.slow.stats.stats();
</a><a href="#h0-9-19" id="h0-9-19" class="i">+    stats[pools.fast.name] = pools.slow.stats.stats();
</a><a href="#h0-9-20" id="h0-9-20" class="i">+  });
</a>   stats.server = {
     clients: clients,
     slow: slow,
<b>diff --git a/<a id="h1" href="../file/web/backend.js">web/backend.js</a> b/<a href="../file/web/backend.js">web/backend.js</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -0,0 +1,22 @@
</a><a href="#h1-0-0" id="h1-0-0" class="i">+function addBackendOpt(config, parser) {
</a><a href="#h1-0-1" id="h1-0-1" class="i">+  if (Object.keys(config.BACKENDS).length &gt; 1) {
</a><a href="#h1-0-2" id="h1-0-2" class="i">+    parser.add([&#39;--backend&#39;, &#39;-b&#39;],
</a><a href="#h1-0-3" id="h1-0-3" class="i">+               {
</a><a href="#h1-0-4" id="h1-0-4" class="i">+                 type: &#39;string&#39;,
</a><a href="#h1-0-5" id="h1-0-5" class="i">+                 default: &#39;&#39;,
</a><a href="#h1-0-6" id="h1-0-6" class="i">+                 help: &#39;Which backend to index. Options: &#39; +
</a><a href="#h1-0-7" id="h1-0-7" class="i">+                     Object.keys(config.BACKENDS).join(&#39;,&#39;)
</a><a href="#h1-0-8" id="h1-0-8" class="i">+               });
</a><a href="#h1-0-9" id="h1-0-9" class="i">+  }
</a><a href="#h1-0-10" id="h1-0-10" class="i">+}
</a><a href="#h1-0-11" id="h1-0-11" class="i">+module.exports.addBackendOpt = addBackendOpt;
</a><a href="#h1-0-12" id="h1-0-12" class="i">+
</a><a href="#h1-0-13" id="h1-0-13" class="i">+function selectBackend(config, opts) {
</a><a href="#h1-0-14" id="h1-0-14" class="i">+  var backend = config.BACKENDS[opts.options.backend || &#39;&#39;];
</a><a href="#h1-0-15" id="h1-0-15" class="i">+  if (!backend) {
</a><a href="#h1-0-16" id="h1-0-16" class="i">+    throw new Error(&quot;No such backend: &quot; + opts.options.backend);
</a><a href="#h1-0-17" id="h1-0-17" class="i">+  }
</a><a href="#h1-0-18" id="h1-0-18" class="i">+  return backend;
</a><a href="#h1-0-19" id="h1-0-19" class="i">+}
</a><a href="#h1-0-20" id="h1-0-20" class="i">+
</a><a href="#h1-0-21" id="h1-0-21" class="i">+module.exports.selectBackend = selectBackend;
</a><b>diff --git a/<a id="h2" href="../file/web/config.js">web/config.js</a> b/<a href="../file/web/config.js">web/config.js</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -4,7 +4,7 @@ var path   = require(&#39;path&#39;),
</a> 
 var config = {
   WEB_PORT: 8910,
<a href="#h2-0-3" id="h2-0-3" class="d">-  BACKEND: {
</a><a href="#h2-0-4" id="h2-0-4" class="i">+  BACKENDS: {&quot;&quot;: {
</a>     host: &quot;localhost&quot;,
     port: 0xC5EA,
     connections: 4,
<a href="#h2-1" id="h2-1" class="h">@@ -20,7 +20,7 @@ var config = {
</a>       }
     ],
     sort: &#39;include kernel mm fs arch&#39;.split(/\s+/),
<a href="#h2-1-3" id="h2-1-3" class="d">-  },
</a><a href="#h2-1-4" id="h2-1-4" class="i">+  }},
</a>   LOG4JS_CONFIG:   path.join(__dirname, &quot;log4js.json&quot;),
   SLOW_THRESHOLD:  300,
   MIN_SLOW_TIME:   2000,
<a href="#h2-2" id="h2-2" class="h">@@ -39,14 +39,17 @@ try {
</a> } catch (e) {
 }
 
<a href="#h2-2-3" id="h2-2-3" class="d">-if (config.BACKEND.repos.length &gt; 1) {
</a><a href="#h2-2-4" id="h2-2-4" class="d">-  var seen = {};
</a><a href="#h2-2-5" id="h2-2-5" class="d">-  config.BACKEND.repos.forEach(function (repo) {
</a><a href="#h2-2-6" id="h2-2-6" class="d">-    console.assert(repo.name);
</a><a href="#h2-2-7" id="h2-2-7" class="d">-    console.assert(!seen.hasOwnProperty(repo.name));
</a><a href="#h2-2-8" id="h2-2-8" class="d">-    seen[repo.name] = true;
</a><a href="#h2-2-9" id="h2-2-9" class="d">-  });
</a><a href="#h2-2-10" id="h2-2-10" class="d">-}
</a><a href="#h2-2-11" id="h2-2-11" class="i">+Object.keys(config.BACKENDS).forEach(function (k) {
</a><a href="#h2-2-12" id="h2-2-12" class="i">+  var backend = config.BACKENDS[k];
</a><a href="#h2-2-13" id="h2-2-13" class="i">+  if (backend.repos.length &gt; 1) {
</a><a href="#h2-2-14" id="h2-2-14" class="i">+    var seen = {};
</a><a href="#h2-2-15" id="h2-2-15" class="i">+    backend.repos.forEach(function (repo) {
</a><a href="#h2-2-16" id="h2-2-16" class="i">+      console.assert(repo.name);
</a><a href="#h2-2-17" id="h2-2-17" class="i">+      console.assert(!seen.hasOwnProperty(repo.name));
</a><a href="#h2-2-18" id="h2-2-18" class="i">+      seen[repo.name] = true;
</a><a href="#h2-2-19" id="h2-2-19" class="i">+    });
</a><a href="#h2-2-20" id="h2-2-20" class="i">+  }
</a><a href="#h2-2-21" id="h2-2-21" class="i">+});
</a> 
 log4js.configure(config.LOG4JS_CONFIG);
 
<b>diff --git a/<a id="h3" href="../file/web/cs_server.js">web/cs_server.js</a> b/<a href="../file/web/cs_server.js">web/cs_server.js</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -7,6 +7,8 @@ var dnode   = require(&#39;dnode&#39;),
</a>     util       = require(&#39;./util.js&#39;),
     Codesearch = require(&#39;./codesearch.js&#39;),
     Batch      = require(&#39;./batch.js&#39;),
<a href="#h3-0-3" id="h3-0-3" class="i">+    parseopt   = require(&#39;./lib/parseopt.js&#39;),
</a><a href="#h3-0-4" id="h3-0-4" class="i">+    backend    = require(&#39;./backend.js&#39;),
</a>     Einhorn    = require(&#39;einhorn&#39;);
 
 function Client(parent, remote) {
<a href="#h3-1" id="h3-1" class="h">@@ -52,12 +54,12 @@ Client.prototype.search = function (re, file, cb) {
</a>   search.on(&#39;match&#39;, batch.send.bind(batch));
 }
 
<a href="#h3-1-3" id="h3-1-3" class="d">-function Server(config) {
</a><a href="#h3-1-4" id="h3-1-4" class="i">+function Server(backend) {
</a>   var parent = this;
   this.clients = [];
 
<a href="#h3-1-8" id="h3-1-8" class="d">-  this.codesearch = new Codesearch(config.BACKEND.repo, [], {
</a><a href="#h3-1-9" id="h3-1-9" class="d">-                                     args: [&#39;--load_index&#39;, config.BACKEND.index]
</a><a href="#h3-1-10" id="h3-1-10" class="i">+  this.codesearch = new Codesearch(backend.repo, [], {
</a><a href="#h3-1-11" id="h3-1-11" class="i">+                                     args: [&#39;--load_index&#39;, backend.index]
</a>                                    });
   this.Server = function (remote, conn) {
     parent.clients[conn.id] = new Client(parent, remote);
<a href="#h3-2" id="h3-2" class="h">@@ -78,9 +80,16 @@ function Server(config) {
</a>   }
 }
 
<a href="#h3-2-3" id="h3-2-3" class="i">+var parser = new parseopt.OptionParser();
</a><a href="#h3-2-4" id="h3-2-4" class="i">+backend.addBackendOpt(config, parser);
</a><a href="#h3-2-5" id="h3-2-5" class="i">+
</a><a href="#h3-2-6" id="h3-2-6" class="i">+var opts = parser.parse(process.argv);
</a><a href="#h3-2-7" id="h3-2-7" class="i">+
</a><a href="#h3-2-8" id="h3-2-8" class="i">+var backend = backend.selectBackend(config, opts);
</a><a href="#h3-2-9" id="h3-2-9" class="i">+
</a> if (Einhorn.is_worker()) {
   Einhorn.ack();
<a href="#h3-2-12" id="h3-2-12" class="d">-  var app = new Server(config).Server;
</a><a href="#h3-2-13" id="h3-2-13" class="i">+  var app = new Server(backend).Server;
</a>   var srv = net.createServer(function (c) {
     var d = dnode(app);
     c.pipe(d).pipe(c);
<a href="#h3-3" id="h3-3" class="h">@@ -88,6 +97,6 @@ if (Einhorn.is_worker()) {
</a>   var fd = Einhorn.socket();
   srv.listen({fd: fd});
 } else {
<a href="#h3-3-3" id="h3-3-3" class="d">-  var server = dnode(new Server(config).Server);
</a><a href="#h3-3-4" id="h3-3-4" class="d">-  server.listen(config.BACKEND.port);
</a><a href="#h3-3-5" id="h3-3-5" class="i">+  var server = dnode(new Server(backend).Server);
</a><a href="#h3-3-6" id="h3-3-6" class="i">+  server.listen(backend.port);
</a> }
<b>diff --git a/<a id="h4" href="../file/web/htdocs/codesearch.js">web/htdocs/codesearch.js</a> b/<a href="../file/web/htdocs/codesearch.js">web/htdocs/codesearch.js</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -18,9 +18,9 @@ var Codesearch = function() {
</a>       socket.on(&#39;match&#39;, Codesearch.delegate.match);
       socket.on(&#39;search_done&#39;, Codesearch.delegate.search_done);
     },
<a href="#h4-0-3" id="h4-0-3" class="d">-    new_search: function(re, file, id) {
</a><a href="#h4-0-4" id="h4-0-4" class="i">+    new_search: function(opts) {
</a>       if (Codesearch.socket !== null)
<a href="#h4-0-6" id="h4-0-6" class="d">-        Codesearch.socket.emit(&#39;new_search&#39;, re, file, id);
</a><a href="#h4-0-7" id="h4-0-7" class="i">+        Codesearch.socket.emit(&#39;new_search&#39;, opts);
</a>     }
   };
 }();
<b>diff --git a/<a id="h5" href="../file/web/htdocs/codesearch_ui.js">web/htdocs/codesearch_ui.js</a> b/<a href="../file/web/htdocs/codesearch_ui.js">web/htdocs/codesearch_ui.js</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -62,8 +62,9 @@ var Match = Backbone.Model.extend({
</a>       name = pieces[0];
       ref = pieces[1];
     }
<a href="#h5-0-3" id="h5-0-3" class="d">-    return &quot;https://github.com/&quot; + CodesearchUI.github_repos[name] + &quot;/blob/&quot; + shorten(ref) +
</a><a href="#h5-0-4" id="h5-0-4" class="d">-      &quot;/&quot; + this.get(&#39;path&#39;).path + &quot;#L&quot; + this.get(&#39;context&#39;).lno;
</a><a href="#h5-0-5" id="h5-0-5" class="i">+    return &quot;https://github.com/&quot; + CodesearchUI.github_repos[this.get(&#39;backend&#39;)][name] +
</a><a href="#h5-0-6" id="h5-0-6" class="i">+      &quot;/blob/&quot; + shorten(ref) + &quot;/&quot; + this.get(&#39;path&#39;).path +
</a><a href="#h5-0-7" id="h5-0-7" class="i">+      &quot;#L&quot; + this.get(&#39;context&#39;).lno;
</a>   }
 });
 
<a href="#h5-1" id="h5-1" class="h">@@ -183,12 +184,16 @@ var SearchState = Backbone.Model.extend({
</a>     return ++this.search_id;
   },
 
<a href="#h5-1-3" id="h5-1-3" class="d">-  dispatch: function (q, file) {
</a><a href="#h5-1-4" id="h5-1-4" class="i">+  dispatch: function (search) {
</a>     var id = this.next_id();
<a href="#h5-1-6" id="h5-1-6" class="d">-    this.search_map[id] = {q: q, file: file};
</a><a href="#h5-1-7" id="h5-1-7" class="d">-    if (!q.length)
</a><a href="#h5-1-8" id="h5-1-8" class="i">+    search.id = id;
</a><a href="#h5-1-9" id="h5-1-9" class="i">+    this.search_map[id] = {
</a><a href="#h5-1-10" id="h5-1-10" class="i">+      q: search.line,
</a><a href="#h5-1-11" id="h5-1-11" class="i">+      file: search.file,
</a><a href="#h5-1-12" id="h5-1-12" class="i">+      backend: search.backend
</a><a href="#h5-1-13" id="h5-1-13" class="i">+    };
</a><a href="#h5-1-14" id="h5-1-14" class="i">+    if (!search.line.length)
</a>       this.set(&#39;displaying&#39;, id);
<a href="#h5-1-16" id="h5-1-16" class="d">-    return id;
</a>   },
 
   url: function() {
<a href="#h5-2" id="h5-2" class="h">@@ -197,8 +202,10 @@ var SearchState = Backbone.Model.extend({
</a>     if (!current)
       return &#39;/search&#39;;
 
<a href="#h5-2-3" id="h5-2-3" class="d">-    if (current.q)    q.q = current.q;
</a><a href="#h5-2-4" id="h5-2-4" class="d">-    if (current.file) q.file = current.file;
</a><a href="#h5-2-5" id="h5-2-5" class="i">+    [&#39;q&#39;,&#39;file&#39;,&#39;backend&#39;].forEach(function (key) {
</a><a href="#h5-2-6" id="h5-2-6" class="i">+      if(current[key])
</a><a href="#h5-2-7" id="h5-2-7" class="i">+        q[key] = current[key];
</a><a href="#h5-2-8" id="h5-2-8" class="i">+    });
</a>     return &#39;/search?&#39; + $.param(q);
   },
 
<a href="#h5-3" id="h5-3" class="h">@@ -214,6 +221,7 @@ var SearchState = Backbone.Model.extend({
</a>       return false;
     this.set(&#39;displaying&#39;, search);
     this.matches.add({
<a href="#h5-3-3" id="h5-3-3" class="i">+                       backend: match.backend,
</a>                        line: match.line,
                        bounds: match.bounds,
                        contexts: match.contexts
<a href="#h5-4" id="h5-4" class="h">@@ -309,17 +317,21 @@ var CodesearchUI = function() {
</a> 
       CodesearchUI.input      = $(&#39;#searchbox&#39;);
       CodesearchUI.input_file = $(&#39;#filebox&#39;);
<a href="#h5-4-3" id="h5-4-3" class="i">+      CodesearchUI.input_backend = $(&#39;#backend&#39;);
</a>       var parms = CodesearchUI.parse_query_params();
       if (parms.q)
         CodesearchUI.input.val(parms.q);
       if (parms.file)
         CodesearchUI.input_file.val(parms.file);
<a href="#h5-4-9" id="h5-4-9" class="i">+      if (parms.backend)
</a><a href="#h5-4-10" id="h5-4-10" class="i">+        CodesearchUI.input_backend.val(parms.backend);
</a> 
       CodesearchUI.input.keydown(CodesearchUI.keypress);
       CodesearchUI.input_file.keydown(CodesearchUI.keypress);
       CodesearchUI.input.bind(&#39;paste&#39;, CodesearchUI.keypress);
       CodesearchUI.input_file.bind(&#39;paste&#39;, CodesearchUI.keypress);
       CodesearchUI.input.focus();
<a href="#h5-4-17" id="h5-4-17" class="i">+      CodesearchUI.input_backend.change(CodesearchUI.keypress);
</a> 
       Codesearch.connect(CodesearchUI);
     },
<a href="#h5-5" id="h5-5" class="h">@@ -342,12 +354,13 @@ var CodesearchUI = function() {
</a>       setTimeout(CodesearchUI.newsearch, 0);
     },
     newsearch: function() {
<a href="#h5-5-3" id="h5-5-3" class="d">-      var id = CodesearchUI.state.dispatch(CodesearchUI.input.val(),
</a><a href="#h5-5-4" id="h5-5-4" class="d">-                                           CodesearchUI.input_file.val());
</a><a href="#h5-5-5" id="h5-5-5" class="d">-      Codesearch.new_search(
</a><a href="#h5-5-6" id="h5-5-6" class="d">-        CodesearchUI.input.val(),
</a><a href="#h5-5-7" id="h5-5-7" class="d">-        CodesearchUI.input_file.val(),
</a><a href="#h5-5-8" id="h5-5-8" class="d">-        id);
</a><a href="#h5-5-9" id="h5-5-9" class="i">+      var search = {
</a><a href="#h5-5-10" id="h5-5-10" class="i">+        line: CodesearchUI.input.val(),
</a><a href="#h5-5-11" id="h5-5-11" class="i">+        file: CodesearchUI.input_file.val(),
</a><a href="#h5-5-12" id="h5-5-12" class="i">+        backend: CodesearchUI.input_backend.val(),
</a><a href="#h5-5-13" id="h5-5-13" class="i">+      };
</a><a href="#h5-5-14" id="h5-5-14" class="i">+      CodesearchUI.state.dispatch(search);
</a><a href="#h5-5-15" id="h5-5-15" class="i">+      Codesearch.new_search(search);
</a>     },
     error: function(search, error) {
       CodesearchUI.state.handle_error(search, error);
<b>diff --git a/<a id="h6" href="../file/web/index.js">web/index.js</a> b/<a href="../file/web/index.js">web/index.js</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -2,28 +2,42 @@
</a> var path    = require(&#39;path&#39;),
     fs      = require(&#39;fs&#39;),
     config  = require(&#39;./config.js&#39;),
<a href="#h6-0-3" id="h6-0-3" class="i">+    backend = require(&#39;./backend.js&#39;),
</a><a href="#h6-0-4" id="h6-0-4" class="i">+    parseopt= require(&#39;./lib/parseopt.js&#39;),
</a>     spawn   = require(&#39;child_process&#39;).spawn;
 
<a href="#h6-0-7" id="h6-0-7" class="d">-console.log(&quot;Generating index file: %s&quot;, config.BACKEND.index);
</a><a href="#h6-0-8" id="h6-0-8" class="i">+function generateIndex(backend, cb) {
</a><a href="#h6-0-9" id="h6-0-9" class="i">+  console.log(&quot;Generating index file: %s&quot;, backend.index);
</a> 
<a href="#h6-0-11" id="h6-0-11" class="d">-var tmp = config.BACKEND.index + &quot;.tmp&quot;;
</a><a href="#h6-0-12" id="h6-0-12" class="i">+  var tmp = backend.index + &quot;.tmp&quot;;
</a> 
<a href="#h6-0-14" id="h6-0-14" class="d">-var repos = config.BACKEND.repos.map(function (repo) {
</a><a href="#h6-0-15" id="h6-0-15" class="d">-  return (repo.name ? repo.name + &quot;@&quot; : &quot;&quot;) +
</a><a href="#h6-0-16" id="h6-0-16" class="i">+  var repos = backend.repos.map(function (repo) {
</a><a href="#h6-0-17" id="h6-0-17" class="i">+    return (repo.name ? repo.name + &quot;@&quot; : &quot;&quot;) +
</a>       repo.path + &quot;:&quot; + repo.refs.join(&quot;,&quot;);
<a href="#h6-0-19" id="h6-0-19" class="d">-});
</a><a href="#h6-0-20" id="h6-0-20" class="i">+    });
</a> 
<a href="#h6-0-22" id="h6-0-22" class="d">-var cs = spawn(path.join(__dirname, &#39;..&#39;, &#39;codesearch&#39;),
</a><a href="#h6-0-23" id="h6-0-23" class="d">-               [&#39;--dump_index&#39;, tmp,
</a><a href="#h6-0-24" id="h6-0-24" class="d">-                &#39;--order_root&#39;, config.BACKEND.sort.join(&#39; &#39;),
</a><a href="#h6-0-25" id="h6-0-25" class="d">-               ].concat(repos),
</a><a href="#h6-0-26" id="h6-0-26" class="d">-               {
</a><a href="#h6-0-27" id="h6-0-27" class="d">-                 customFds: [-1, 1, 2]
</a><a href="#h6-0-28" id="h6-0-28" class="d">-               });
</a><a href="#h6-0-29" id="h6-0-29" class="d">-cs.on(&#39;exit&#39;, function(code) {
</a><a href="#h6-0-30" id="h6-0-30" class="d">-        if (code !== 0)
</a><a href="#h6-0-31" id="h6-0-31" class="d">-          console.error(&quot;Index process exited with error %d&quot;, code);
</a><a href="#h6-0-32" id="h6-0-32" class="d">-        fs.renameSync(tmp, config.BACKEND.index);
</a><a href="#h6-0-33" id="h6-0-33" class="d">-        process.exit(0);
</a><a href="#h6-0-34" id="h6-0-34" class="d">-      });
</a><a href="#h6-0-35" id="h6-0-35" class="d">-cs.stdin.end();
</a><a href="#h6-0-36" id="h6-0-36" class="i">+  var cs = spawn(path.join(__dirname, &#39;..&#39;, &#39;codesearch&#39;),
</a><a href="#h6-0-37" id="h6-0-37" class="i">+                 [&#39;--dump_index&#39;, tmp,
</a><a href="#h6-0-38" id="h6-0-38" class="i">+                  &#39;--order_root&#39;, backend.sort.join(&#39; &#39;),
</a><a href="#h6-0-39" id="h6-0-39" class="i">+                 ].concat(repos),
</a><a href="#h6-0-40" id="h6-0-40" class="i">+                 {
</a><a href="#h6-0-41" id="h6-0-41" class="i">+                   customFds: [-1, 1, 2]
</a><a href="#h6-0-42" id="h6-0-42" class="i">+                 });
</a><a href="#h6-0-43" id="h6-0-43" class="i">+  cs.on(&#39;exit&#39;, function(code) {
</a><a href="#h6-0-44" id="h6-0-44" class="i">+          if (code !== 0)
</a><a href="#h6-0-45" id="h6-0-45" class="i">+            console.error(&quot;Index process exited with error %d&quot;, code);
</a><a href="#h6-0-46" id="h6-0-46" class="i">+          else
</a><a href="#h6-0-47" id="h6-0-47" class="i">+            fs.renameSync(tmp, backend.index);
</a><a href="#h6-0-48" id="h6-0-48" class="i">+          cb();
</a><a href="#h6-0-49" id="h6-0-49" class="i">+        });
</a><a href="#h6-0-50" id="h6-0-50" class="i">+  cs.stdin.end();
</a><a href="#h6-0-51" id="h6-0-51" class="i">+}
</a><a href="#h6-0-52" id="h6-0-52" class="i">+
</a><a href="#h6-0-53" id="h6-0-53" class="i">+var parser = new parseopt.OptionParser();
</a><a href="#h6-0-54" id="h6-0-54" class="i">+backend.addBackendOpt(config, parser);
</a><a href="#h6-0-55" id="h6-0-55" class="i">+
</a><a href="#h6-0-56" id="h6-0-56" class="i">+var opts = parser.parse(process.argv);
</a><a href="#h6-0-57" id="h6-0-57" class="i">+generateIndex(backend.selectBackend(config, opts),
</a><a href="#h6-0-58" id="h6-0-58" class="i">+             function () {
</a><a href="#h6-0-59" id="h6-0-59" class="i">+               process.exit(0);
</a><a href="#h6-0-60" id="h6-0-60" class="i">+             });
</a><b>diff --git a/<a id="h7" href="../file/web/templates/index.html">web/templates/index.html</a> b/<a href="../file/web/templates/index.html">web/templates/index.html</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -13,7 +13,13 @@
</a>     &lt;/tr&gt;
   &lt;/table&gt;
   &lt;div id=&#39;errorbox&#39;&gt;
<a href="#h7-0-3" id="h7-0-3" class="d">-    &lt;div class=&#39;what&#39;&gt; Now searching: {{repo_name}} &lt;/div&gt;
</a><a href="#h7-0-4" id="h7-0-4" class="i">+    &lt;div class=&#39;what&#39;&gt; Search:
</a><a href="#h7-0-5" id="h7-0-5" class="i">+    &lt;select id=&#39;backend&#39;&gt;
</a><a href="#h7-0-6" id="h7-0-6" class="i">+    {{#each repos}}
</a><a href="#h7-0-7" id="h7-0-7" class="i">+     &lt;option value=&quot;{{name}}&quot;&gt;{{pretty}}&lt;/option&gt;
</a><a href="#h7-0-8" id="h7-0-8" class="i">+    {{/each}}
</a><a href="#h7-0-9" id="h7-0-9" class="i">+    &lt;/select&gt;
</a><a href="#h7-0-10" id="h7-0-10" class="i">+    &lt;/div&gt;
</a>     &lt;div id=&#39;regex-error&#39;&gt;
       &lt;span class=&#39;label&#39;&gt; Error: &lt;/span&gt;
       &lt;span id=&#39;errortext&#39;&gt;
<b>diff --git a/<a id="h8" href="../file/web/web_server.js">web/web_server.js</a> b/<a href="../file/web/web_server.js">web/web_server.js</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -81,14 +81,24 @@ app.configure(
</a> app.get(&#39;/&#39;, function (req, res) {res.redirect(&#39;/search&#39;);});
 app.get(&#39;/search&#39;, function (req, res) {
           var repo_map = {};
<a href="#h8-0-3" id="h8-0-3" class="d">-          config.BACKEND.repos.forEach(function (repo) {
</a><a href="#h8-0-4" id="h8-0-4" class="d">-            repo_map[repo.name] = repo.github;
</a><a href="#h8-0-5" id="h8-0-5" class="i">+          Object.keys(config.BACKENDS).forEach(function (name) {
</a><a href="#h8-0-6" id="h8-0-6" class="i">+            var backend = config.BACKENDS[name];
</a><a href="#h8-0-7" id="h8-0-7" class="i">+            repo_map[name] = {};
</a><a href="#h8-0-8" id="h8-0-8" class="i">+            backend.repos.forEach(function (repo) {
</a><a href="#h8-0-9" id="h8-0-9" class="i">+              repo_map[name][repo.name] = repo.github;
</a><a href="#h8-0-10" id="h8-0-10" class="i">+            });
</a>           });
           res.render(&#39;index&#39;,
                      {
                        js: true,
                        title: &#39;search&#39;,
<a href="#h8-0-16" id="h8-0-16" class="d">-                       repo_name: config.BACKEND.pretty_name,
</a><a href="#h8-0-17" id="h8-0-17" class="i">+                       repos: Object.keys(config.BACKENDS).map(function (name) {
</a><a href="#h8-0-18" id="h8-0-18" class="i">+                         var backend = config.BACKENDS[name];
</a><a href="#h8-0-19" id="h8-0-19" class="i">+                         return {
</a><a href="#h8-0-20" id="h8-0-20" class="i">+                           name: name,
</a><a href="#h8-0-21" id="h8-0-21" class="i">+                           pretty: backend.pretty_name
</a><a href="#h8-0-22" id="h8-0-22" class="i">+                         };
</a><a href="#h8-0-23" id="h8-0-23" class="i">+                       }),
</a>                        github_repos: repo_map,
                      });
         });
</pre>
</div>
</body>
</html>
