<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Merge branch &#39;master&#39; into web-live - livegrep - Fast, regular expression code search service</title>
<meta name="description" content="Fast, regular expression code search service" />
<meta name="author" content="Kevin Lin" />
<link rel="icon" type="image/png" href="https://static.kevinlin.info/favicon.png" />
<link rel="alternate" type="application/atom+xml" title="livegrep Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="livegrep Atom Feed (tags)" href="../tags.xml" />
<style type="text/css">
body{color:#000;background-color:#fff;font-family:monospace}h1,h2,h3,h4,h5,h6{font-size:1em;margin:0}img,h1,h2{vertical-align:middle}img{border:0}a:target{background-color:#ccc}a.d,a.h,a.i{text-decoration:none}a.line{text-decoration:none;user-select:none}#blob a{color:#555}#blob a:hover{color:blue;text-decoration:none}table thead td{font-weight:bold}table td{padding:0 .4em}table td pre{margin:0}#content table td{vertical-align:top;white-space:nowrap}#branches tr:hover td,#tags tr:hover td,#index tr:hover td,#log tr:hover td,#files tr:hover td{background-color:#eee}#index tr td:nth-child(2),#tags tr td:nth-child(3),#branches tr td:nth-child(3),#log tr td:nth-child(2){white-space:normal}td.num{text-align:right}.desc{color:#555}hr{border:0;border-top:1px solid #555;height:1px}pre{font-family:monospace}pre a.h{color:#00a}.A,span.i,pre a.i{color:#070}.D,span.d,pre a.d{color:#e00}pre a.h:hover,pre a.i:hover,pre a.d:hover{text-decoration:none}
</style>
</head>
<body>
<table><tr><td><a href="/"><img src="https://static.kevinlin.info/favicon.png" alt="" width="32" height="32" /></a></td><td><h1>livegrep</h1><span class="desc">Fast, regular expression code search service</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://source.static.kevinlin.info/external/livegrep.git">https://source.static.kevinlin.info/external/livegrep.git</a></td></tr><tr><td></td><td>
<a href="../log">Log</a> | <a href="../files">Files</a> | <a href="../refs">Refs</a> | <a href="../file/README.md">README</a> | <a href="../file/COPYING">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/88009f343f420524d7fdbed2ab6e6022024c5ec0">88009f343f420524d7fdbed2ab6e6022024c5ec0</a>
<b>parent</b> <a href="../commit/da002491f65da598f97b8f7e9eb4484715412efa">da002491f65da598f97b8f7e9eb4484715412efa</a>
<b>Author:</b> Nelson Elhage &lt;<a href="mailto:nelhage@nelhage.com">nelhage@nelhage.com</a>&gt;
<b>Date:</b>   Sat 19 Nov 2011 10:36:35 -0500

Merge branch &#39;master&#39; into web-live

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">.gitignore</a></td><td> | </td><td class="num">1</td><td><span class="i">+</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h1">.gitmodules</a></td><td> | </td><td class="num">3</td><td><span class="i">+++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">Makefile</a></td><td> | </td><td class="num">36</td><td><span class="i">+++++++++++++++++++++++</span><span class="d">-------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h3">atomic.h</a></td><td> | </td><td class="num">21</td><td><span class="i">+++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h4">chunk.cc</a></td><td> | </td><td class="num">145</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h5">chunk.h</a></td><td> | </td><td class="num">101</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h6">chunk_allocator.cc</a></td><td> | </td><td class="num">55</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h7">chunk_allocator.h</a></td><td> | </td><td class="num">43</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h8">codesearch.cc</a></td><td> | </td><td class="num">535</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">---------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h9">codesearch.h</a></td><td> | </td><td class="num">25</td><td><span class="i">++++++++++++++++++++++++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h10">main.cc</a></td><td> | </td><td class="num">71</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">----------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h11">radix_sort.cc</a></td><td> | </td><td class="num">42</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h12">radix_sort.h</a></td><td> | </td><td class="num">48</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h13">re2</a></td><td> | </td><td class="num">1</td><td><span class="i">+</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h14">test/test.js</a></td><td> | </td><td class="num">74</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h15">test/testcases</a></td><td> | </td><td class="num">19</td><td><span class="i">+++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h16">thread_pool.h</a></td><td> | </td><td class="num">62</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h17">thread_queue.h</a></td><td> | </td><td class="num">6</td><td><span class="i">++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h18">timer.h</a></td><td> | </td><td class="num">15</td><td><span class="i">++++++++++++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h19">web/codesearch.js</a></td><td> | </td><td class="num">18</td><td><span class="i">+++++++++++</span><span class="d">-------</span></td></tr>
</table></pre><pre>20 files changed, 1085 insertions(+), 236 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/.gitignore">.gitignore</a> b/<a href="../file/.gitignore">.gitignore</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -1,3 +1,4 @@
</a> /codesearch
 /Makefile.config
 *.o
<a href="#h0-0-3" id="h0-0-3" class="i">+.*.d
</a><b>diff --git a/<a id="h1" href="../file/.gitmodules">.gitmodules</a> b/<a href="../file/.gitmodules">.gitmodules</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -0,0 +1,3 @@
</a><a href="#h1-0-0" id="h1-0-0" class="i">+[submodule &quot;re2&quot;]
</a><a href="#h1-0-1" id="h1-0-1" class="i">+	path = re2
</a><a href="#h1-0-2" id="h1-0-2" class="i">+	url = ../re2/
</a><b>diff --git a/<a id="h2" href="../file/Makefile">Makefile</a> b/<a href="../file/Makefile">Makefile</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -2,23 +2,21 @@
</a> 
 comma:=,
 
<a href="#h2-0-3" id="h2-0-3" class="d">-extradirs=$(sort $(libgit2) $(re2))
</a><a href="#h2-0-4" id="h2-0-4" class="i">+libre2=$(CURDIR)/re2/obj/libre2.a
</a> 
<a href="#h2-0-6" id="h2-0-6" class="d">-CXXFLAGS = $(patsubst %,-I%/include, $(extradirs))
</a><a href="#h2-0-7" id="h2-0-7" class="i">+extradirs=$(sort $(libgit2) $(gflags))
</a><a href="#h2-0-8" id="h2-0-8" class="i">+
</a><a href="#h2-0-9" id="h2-0-9" class="i">+CPPFLAGS = -I$(CURDIR)/re2/ $(patsubst %,-I%/include, $(extradirs))
</a> LDFLAGS  = $(patsubst %, -L%/lib, $(extradirs))
 LDFLAGS += $(patsubst %, -Wl$(comma)-R%/lib, $(extradirs))
 
<a href="#h2-0-13" id="h2-0-13" class="d">-CXXFLAGS+=-ggdb3 -std=c++0x -Wall -Werror -Wno-sign-compare -pthread
</a><a href="#h2-0-14" id="h2-0-14" class="i">+CXXFLAGS+=-g -std=c++0x -Wall -Werror -Wno-sign-compare -pthread
</a> LDFLAGS+=-pthread
<a href="#h2-0-16" id="h2-0-16" class="d">-LDLIBS=-lgit2 -lre2 -ljson
</a><a href="#h2-0-17" id="h2-0-17" class="i">+LDLIBS=-lgit2 -ljson -lgflags
</a> 
 ifeq ($(noopt),)
 CXXFLAGS+=-O2
 endif
<a href="#h2-0-22" id="h2-0-22" class="d">-ifneq ($(profile),)
</a><a href="#h2-0-23" id="h2-0-23" class="d">-CXXFLAGS+=-pg
</a><a href="#h2-0-24" id="h2-0-24" class="d">-LDFLAGS+=-pg
</a><a href="#h2-0-25" id="h2-0-25" class="d">-endif
</a> ifneq ($(densehash),)
 CXXFLAGS+=-DUSE_DENSE_HASH_SET
 endif
<a href="#h2-1" id="h2-1" class="h">@@ -26,13 +24,25 @@ ifneq ($(profile),)
</a> CXXFLAGS+=-DPROFILE_CODESEARCH
 endif
 
<a href="#h2-1-3" id="h2-1-3" class="d">-HEADERS = smart_git.h timer.h thread_queue.h mutex.h thread_pool.h codesearch.h
</a><a href="#h2-1-4" id="h2-1-4" class="i">+HEADERS = smart_git.h timer.h thread_queue.h mutex.h thread_pool.h codesearch.h chunk.h chunk_allocator.h
</a><a href="#h2-1-5" id="h2-1-5" class="i">+OBJECTS = codesearch.o main.o chunk.o chunk_allocator.o radix_sort.o
</a><a href="#h2-1-6" id="h2-1-6" class="i">+DEPFILES = $(OBJECTS:%.o=.%.d)
</a> 
<a href="#h2-1-8" id="h2-1-8" class="d">-all: codesearch
</a><a href="#h2-1-9" id="h2-1-9" class="i">+all: codesearch $(DEPFILES)
</a> 
<a href="#h2-1-11" id="h2-1-11" class="d">-codesearch: codesearch.o main.o
</a><a href="#h2-1-12" id="h2-1-12" class="i">+codesearch: $(OBJECTS) $(libre2)
</a><a href="#h2-1-13" id="h2-1-13" class="i">+	$(CXX) -o $@ $(LDFLAGS) $^ $(LDLIBS)
</a> 
<a href="#h2-1-15" id="h2-1-15" class="d">-codesearch.o: codesearch.cc $(HEADERS)
</a><a href="#h2-1-16" id="h2-1-16" class="i">+$(libre2):
</a><a href="#h2-1-17" id="h2-1-17" class="i">+	( cd re2 &amp;&amp; $(MAKE) )
</a> 
 clean:
<a href="#h2-1-20" id="h2-1-20" class="d">-	rm -f codesearch codesearch.o
</a><a href="#h2-1-21" id="h2-1-21" class="i">+	rm -f codesearch $(OBJECTS) $(DEPFILES)
</a><a href="#h2-1-22" id="h2-1-22" class="i">+
</a><a href="#h2-1-23" id="h2-1-23" class="i">+.%.d: %.cc
</a><a href="#h2-1-24" id="h2-1-24" class="i">+	@set -e; rm -f $@; \
</a><a href="#h2-1-25" id="h2-1-25" class="i">+	 $(CXX) -M $(CPPFLAGS) $(CXXFLAGS) $&lt; &gt; $@.$$$$; \
</a><a href="#h2-1-26" id="h2-1-26" class="i">+	 sed &#39;s,\($*\)\.o[ :]*,\1.o $@ : ,g&#39; &lt; $@.$$$$ &gt; $@; \
</a><a href="#h2-1-27" id="h2-1-27" class="i">+	 rm -f $@.$$$$
</a><a href="#h2-1-28" id="h2-1-28" class="i">+
</a><a href="#h2-1-29" id="h2-1-29" class="i">+-include $(DEPFILES)
</a><b>diff --git a/<a id="h3" href="../file/atomic.h">atomic.h</a> b/<a href="../file/atomic.h">atomic.h</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -0,0 +1,21 @@
</a><a href="#h3-0-0" id="h3-0-0" class="i">+#ifndef CODESEARCH_ATOMIC_H
</a><a href="#h3-0-1" id="h3-0-1" class="i">+#define CODESEARCH_ATOMIC_H
</a><a href="#h3-0-2" id="h3-0-2" class="i">+
</a><a href="#h3-0-3" id="h3-0-3" class="i">+/* A minimal implementation of atomic_int for portability */
</a><a href="#h3-0-4" id="h3-0-4" class="i">+
</a><a href="#h3-0-5" id="h3-0-5" class="i">+class atomic_int {
</a><a href="#h3-0-6" id="h3-0-6" class="i">+public:
</a><a href="#h3-0-7" id="h3-0-7" class="i">+    atomic_int(int x) : val_(x) { }
</a><a href="#h3-0-8" id="h3-0-8" class="i">+
</a><a href="#h3-0-9" id="h3-0-9" class="i">+    int load() {
</a><a href="#h3-0-10" id="h3-0-10" class="i">+        return val_;
</a><a href="#h3-0-11" id="h3-0-11" class="i">+    }
</a><a href="#h3-0-12" id="h3-0-12" class="i">+
</a><a href="#h3-0-13" id="h3-0-13" class="i">+    int operator++() {
</a><a href="#h3-0-14" id="h3-0-14" class="i">+        return __sync_fetch_and_add(&amp;val_, 1);
</a><a href="#h3-0-15" id="h3-0-15" class="i">+    }
</a><a href="#h3-0-16" id="h3-0-16" class="i">+private:
</a><a href="#h3-0-17" id="h3-0-17" class="i">+    int val_;
</a><a href="#h3-0-18" id="h3-0-18" class="i">+};
</a><a href="#h3-0-19" id="h3-0-19" class="i">+
</a><a href="#h3-0-20" id="h3-0-20" class="i">+#endif
</a><b>diff --git a/<a id="h4" href="../file/chunk.cc">chunk.cc</a> b/<a href="../file/chunk.cc">chunk.cc</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -0,0 +1,145 @@
</a><a href="#h4-0-0" id="h4-0-0" class="i">+#include &quot;chunk.h&quot;
</a><a href="#h4-0-1" id="h4-0-1" class="i">+#include &quot;radix_sort.h&quot;
</a><a href="#h4-0-2" id="h4-0-2" class="i">+
</a><a href="#h4-0-3" id="h4-0-3" class="i">+#include &lt;re2/re2.h&gt;
</a><a href="#h4-0-4" id="h4-0-4" class="i">+#include &lt;gflags/gflags.h&gt;
</a><a href="#h4-0-5" id="h4-0-5" class="i">+
</a><a href="#h4-0-6" id="h4-0-6" class="i">+using re2::StringPiece;
</a><a href="#h4-0-7" id="h4-0-7" class="i">+
</a><a href="#h4-0-8" id="h4-0-8" class="i">+DECLARE_bool(index);
</a><a href="#h4-0-9" id="h4-0-9" class="i">+
</a><a href="#h4-0-10" id="h4-0-10" class="i">+DEFINE_int32(chunk_power, 20, &quot;Size of search chunks, as a power of two&quot;);
</a><a href="#h4-0-11" id="h4-0-11" class="i">+
</a><a href="#h4-0-12" id="h4-0-12" class="i">+static bool validate_chunk_power(const char* flagname, int32_t value) {
</a><a href="#h4-0-13" id="h4-0-13" class="i">+    if (value &gt; 10 &amp;&amp; value &lt; 30) {
</a><a href="#h4-0-14" id="h4-0-14" class="i">+        kChunkSize = (1 &lt;&lt; value);
</a><a href="#h4-0-15" id="h4-0-15" class="i">+        kChunkSpace = kChunkSize - sizeof(chunk);
</a><a href="#h4-0-16" id="h4-0-16" class="i">+        return true;
</a><a href="#h4-0-17" id="h4-0-17" class="i">+    }
</a><a href="#h4-0-18" id="h4-0-18" class="i">+    return false;
</a><a href="#h4-0-19" id="h4-0-19" class="i">+}
</a><a href="#h4-0-20" id="h4-0-20" class="i">+
</a><a href="#h4-0-21" id="h4-0-21" class="i">+static const bool dummy = google::RegisterFlagValidator(&amp;FLAGS_chunk_power,
</a><a href="#h4-0-22" id="h4-0-22" class="i">+                                                        validate_chunk_power);
</a><a href="#h4-0-23" id="h4-0-23" class="i">+
</a><a href="#h4-0-24" id="h4-0-24" class="i">+size_t kChunkSize = (1 &lt;&lt; 20);
</a><a href="#h4-0-25" id="h4-0-25" class="i">+size_t kChunkSpace(kChunkSize - sizeof(chunk));
</a><a href="#h4-0-26" id="h4-0-26" class="i">+
</a><a href="#h4-0-27" id="h4-0-27" class="i">+class radix_sorter {
</a><a href="#h4-0-28" id="h4-0-28" class="i">+public:
</a><a href="#h4-0-29" id="h4-0-29" class="i">+    radix_sorter(chunk *chunk) : chunk_(chunk) {
</a><a href="#h4-0-30" id="h4-0-30" class="i">+        lengths = new uint32_t[chunk_-&gt;size];
</a><a href="#h4-0-31" id="h4-0-31" class="i">+        for (int i = 0; i &lt; chunk_-&gt;size; i ++)
</a><a href="#h4-0-32" id="h4-0-32" class="i">+            lengths[i] = static_cast&lt;char*&gt;
</a><a href="#h4-0-33" id="h4-0-33" class="i">+                (memchr(&amp;chunk_-&gt;data[i], &#39;\n&#39;, chunk_-&gt;size - i)) -
</a><a href="#h4-0-34" id="h4-0-34" class="i">+                (chunk_-&gt;data + i);
</a><a href="#h4-0-35" id="h4-0-35" class="i">+    }
</a><a href="#h4-0-36" id="h4-0-36" class="i">+
</a><a href="#h4-0-37" id="h4-0-37" class="i">+    ~radix_sorter() {
</a><a href="#h4-0-38" id="h4-0-38" class="i">+        delete[] lengths;
</a><a href="#h4-0-39" id="h4-0-39" class="i">+    }
</a><a href="#h4-0-40" id="h4-0-40" class="i">+
</a><a href="#h4-0-41" id="h4-0-41" class="i">+    void sort();
</a><a href="#h4-0-42" id="h4-0-42" class="i">+
</a><a href="#h4-0-43" id="h4-0-43" class="i">+    struct cmp_suffix {
</a><a href="#h4-0-44" id="h4-0-44" class="i">+        radix_sorter &amp;sort;
</a><a href="#h4-0-45" id="h4-0-45" class="i">+        cmp_suffix(radix_sorter &amp;s) : sort(s) {}
</a><a href="#h4-0-46" id="h4-0-46" class="i">+        bool operator()(uint32_t lhs, uint32_t rhs) {
</a><a href="#h4-0-47" id="h4-0-47" class="i">+            char *l = &amp;sort.chunk_-&gt;data[lhs];
</a><a href="#h4-0-48" id="h4-0-48" class="i">+            char *r = &amp;sort.chunk_-&gt;data[rhs];
</a><a href="#h4-0-49" id="h4-0-49" class="i">+            unsigned ll = sort.lengths[lhs];
</a><a href="#h4-0-50" id="h4-0-50" class="i">+            unsigned rl = sort.lengths[rhs];
</a><a href="#h4-0-51" id="h4-0-51" class="i">+            int cmp = memcmp(l, r, min(ll, rl));
</a><a href="#h4-0-52" id="h4-0-52" class="i">+            if (cmp &lt; 0)
</a><a href="#h4-0-53" id="h4-0-53" class="i">+                return true;
</a><a href="#h4-0-54" id="h4-0-54" class="i">+            if (cmp &gt; 0)
</a><a href="#h4-0-55" id="h4-0-55" class="i">+                return false;
</a><a href="#h4-0-56" id="h4-0-56" class="i">+            return ll &lt; rl;
</a><a href="#h4-0-57" id="h4-0-57" class="i">+        }
</a><a href="#h4-0-58" id="h4-0-58" class="i">+    };
</a><a href="#h4-0-59" id="h4-0-59" class="i">+
</a><a href="#h4-0-60" id="h4-0-60" class="i">+    struct indexer {
</a><a href="#h4-0-61" id="h4-0-61" class="i">+        radix_sorter &amp;sort;
</a><a href="#h4-0-62" id="h4-0-62" class="i">+        indexer(radix_sorter &amp;s) : sort(s) {}
</a><a href="#h4-0-63" id="h4-0-63" class="i">+        unsigned operator()(uint32_t off, int i) {
</a><a href="#h4-0-64" id="h4-0-64" class="i">+            return sort.index(off, i);
</a><a href="#h4-0-65" id="h4-0-65" class="i">+        }
</a><a href="#h4-0-66" id="h4-0-66" class="i">+    };
</a><a href="#h4-0-67" id="h4-0-67" class="i">+
</a><a href="#h4-0-68" id="h4-0-68" class="i">+private:
</a><a href="#h4-0-69" id="h4-0-69" class="i">+    unsigned index(uint32_t off, int i) {
</a><a href="#h4-0-70" id="h4-0-70" class="i">+        if (i &gt;= lengths[off]) return 0;
</a><a href="#h4-0-71" id="h4-0-71" class="i">+        return (unsigned)(unsigned char)chunk_-&gt;data[off + i];
</a><a href="#h4-0-72" id="h4-0-72" class="i">+    }
</a><a href="#h4-0-73" id="h4-0-73" class="i">+
</a><a href="#h4-0-74" id="h4-0-74" class="i">+    chunk *chunk_;
</a><a href="#h4-0-75" id="h4-0-75" class="i">+    unsigned *lengths;
</a><a href="#h4-0-76" id="h4-0-76" class="i">+
</a><a href="#h4-0-77" id="h4-0-77" class="i">+    radix_sorter(const radix_sorter&amp;);
</a><a href="#h4-0-78" id="h4-0-78" class="i">+    radix_sorter operator=(const radix_sorter&amp;);
</a><a href="#h4-0-79" id="h4-0-79" class="i">+};
</a><a href="#h4-0-80" id="h4-0-80" class="i">+
</a><a href="#h4-0-81" id="h4-0-81" class="i">+void chunk::add_chunk_file(search_file *sf, const StringPiece&amp; line)
</a><a href="#h4-0-82" id="h4-0-82" class="i">+{
</a><a href="#h4-0-83" id="h4-0-83" class="i">+    int l = line.data() - data;
</a><a href="#h4-0-84" id="h4-0-84" class="i">+    int r = l + line.size();
</a><a href="#h4-0-85" id="h4-0-85" class="i">+    chunk_file *f = NULL;
</a><a href="#h4-0-86" id="h4-0-86" class="i">+    int min_dist = numeric_limits&lt;int&gt;::max(), dist;
</a><a href="#h4-0-87" id="h4-0-87" class="i">+    for (vector&lt;chunk_file&gt;::iterator it = cur_file.begin();
</a><a href="#h4-0-88" id="h4-0-88" class="i">+         it != cur_file.end(); it ++) {
</a><a href="#h4-0-89" id="h4-0-89" class="i">+        if (l &lt;= it-&gt;left)
</a><a href="#h4-0-90" id="h4-0-90" class="i">+            dist = max(0, it-&gt;left - r);
</a><a href="#h4-0-91" id="h4-0-91" class="i">+        else if (r &gt;= it-&gt;right)
</a><a href="#h4-0-92" id="h4-0-92" class="i">+            dist = max(0, l - it-&gt;right);
</a><a href="#h4-0-93" id="h4-0-93" class="i">+        else
</a><a href="#h4-0-94" id="h4-0-94" class="i">+            dist = 0;
</a><a href="#h4-0-95" id="h4-0-95" class="i">+        assert(dist == 0 || r &lt; it-&gt;left || l &gt; it-&gt;right);
</a><a href="#h4-0-96" id="h4-0-96" class="i">+        if (dist &lt; min_dist) {
</a><a href="#h4-0-97" id="h4-0-97" class="i">+            min_dist = dist;
</a><a href="#h4-0-98" id="h4-0-98" class="i">+            f = &amp;(*it);
</a><a href="#h4-0-99" id="h4-0-99" class="i">+        }
</a><a href="#h4-0-100" id="h4-0-100" class="i">+    }
</a><a href="#h4-0-101" id="h4-0-101" class="i">+    if (f &amp;&amp; min_dist &lt; kMaxGap) {
</a><a href="#h4-0-102" id="h4-0-102" class="i">+        f-&gt;expand(l, r);
</a><a href="#h4-0-103" id="h4-0-103" class="i">+        return;
</a><a href="#h4-0-104" id="h4-0-104" class="i">+    }
</a><a href="#h4-0-105" id="h4-0-105" class="i">+    chunk_files++;
</a><a href="#h4-0-106" id="h4-0-106" class="i">+    cur_file.push_back(chunk_file());
</a><a href="#h4-0-107" id="h4-0-107" class="i">+    chunk_file&amp; cf = cur_file.back();
</a><a href="#h4-0-108" id="h4-0-108" class="i">+    cf.file = sf;
</a><a href="#h4-0-109" id="h4-0-109" class="i">+    cf.left = l;
</a><a href="#h4-0-110" id="h4-0-110" class="i">+    cf.right = r;
</a><a href="#h4-0-111" id="h4-0-111" class="i">+}
</a><a href="#h4-0-112" id="h4-0-112" class="i">+
</a><a href="#h4-0-113" id="h4-0-113" class="i">+void chunk::finish_file() {
</a><a href="#h4-0-114" id="h4-0-114" class="i">+    int right = -1;
</a><a href="#h4-0-115" id="h4-0-115" class="i">+    sort(cur_file.begin(), cur_file.end());
</a><a href="#h4-0-116" id="h4-0-116" class="i">+    for (vector&lt;chunk_file&gt;::iterator it = cur_file.begin();
</a><a href="#h4-0-117" id="h4-0-117" class="i">+         it != cur_file.end(); it ++) {
</a><a href="#h4-0-118" id="h4-0-118" class="i">+        assert(right &lt; it-&gt;left);
</a><a href="#h4-0-119" id="h4-0-119" class="i">+        right = max(right, it-&gt;right);
</a><a href="#h4-0-120" id="h4-0-120" class="i">+    }
</a><a href="#h4-0-121" id="h4-0-121" class="i">+    files.insert(files.end(), cur_file.begin(), cur_file.end());
</a><a href="#h4-0-122" id="h4-0-122" class="i">+    cur_file.clear();
</a><a href="#h4-0-123" id="h4-0-123" class="i">+}
</a><a href="#h4-0-124" id="h4-0-124" class="i">+
</a><a href="#h4-0-125" id="h4-0-125" class="i">+int chunk::chunk_files = 0;
</a><a href="#h4-0-126" id="h4-0-126" class="i">+
</a><a href="#h4-0-127" id="h4-0-127" class="i">+void radix_sorter::sort() {
</a><a href="#h4-0-128" id="h4-0-128" class="i">+    cmp_suffix cmp(*this);
</a><a href="#h4-0-129" id="h4-0-129" class="i">+    indexer idx(*this);
</a><a href="#h4-0-130" id="h4-0-130" class="i">+    msd_radix_sort(chunk_-&gt;suffixes, chunk_-&gt;suffixes + chunk_-&gt;size, 0,
</a><a href="#h4-0-131" id="h4-0-131" class="i">+                   idx, cmp);
</a><a href="#h4-0-132" id="h4-0-132" class="i">+    assert(is_sorted(chunk_-&gt;suffixes, chunk_-&gt;suffixes + chunk_-&gt;size, cmp));
</a><a href="#h4-0-133" id="h4-0-133" class="i">+}
</a><a href="#h4-0-134" id="h4-0-134" class="i">+
</a><a href="#h4-0-135" id="h4-0-135" class="i">+
</a><a href="#h4-0-136" id="h4-0-136" class="i">+void chunk::finalize() {
</a><a href="#h4-0-137" id="h4-0-137" class="i">+    if (FLAGS_index) {
</a><a href="#h4-0-138" id="h4-0-138" class="i">+        suffixes = new uint32_t[size];
</a><a href="#h4-0-139" id="h4-0-139" class="i">+        for (int i = 0; i &lt; size; i++)
</a><a href="#h4-0-140" id="h4-0-140" class="i">+            suffixes[i] = i;
</a><a href="#h4-0-141" id="h4-0-141" class="i">+        radix_sorter sort(this);
</a><a href="#h4-0-142" id="h4-0-142" class="i">+        sort.sort();
</a><a href="#h4-0-143" id="h4-0-143" class="i">+    }
</a><a href="#h4-0-144" id="h4-0-144" class="i">+}
</a><b>diff --git a/<a id="h5" href="../file/chunk.h">chunk.h</a> b/<a href="../file/chunk.h">chunk.h</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -0,0 +1,101 @@
</a><a href="#h5-0-0" id="h5-0-0" class="i">+#include &lt;assert.h&gt;
</a><a href="#h5-0-1" id="h5-0-1" class="i">+#include &lt;string.h&gt;
</a><a href="#h5-0-2" id="h5-0-2" class="i">+
</a><a href="#h5-0-3" id="h5-0-3" class="i">+#include &lt;vector&gt;
</a><a href="#h5-0-4" id="h5-0-4" class="i">+#include &lt;string&gt;
</a><a href="#h5-0-5" id="h5-0-5" class="i">+#include &lt;algorithm&gt;
</a><a href="#h5-0-6" id="h5-0-6" class="i">+
</a><a href="#h5-0-7" id="h5-0-7" class="i">+#include &lt;stdint.h&gt;
</a><a href="#h5-0-8" id="h5-0-8" class="i">+
</a><a href="#h5-0-9" id="h5-0-9" class="i">+struct search_file;
</a><a href="#h5-0-10" id="h5-0-10" class="i">+namespace re2 {
</a><a href="#h5-0-11" id="h5-0-11" class="i">+    class StringPiece;
</a><a href="#h5-0-12" id="h5-0-12" class="i">+}
</a><a href="#h5-0-13" id="h5-0-13" class="i">+
</a><a href="#h5-0-14" id="h5-0-14" class="i">+using namespace std;
</a><a href="#h5-0-15" id="h5-0-15" class="i">+using re2::StringPiece;
</a><a href="#h5-0-16" id="h5-0-16" class="i">+
</a><a href="#h5-0-17" id="h5-0-17" class="i">+struct chunk_file {
</a><a href="#h5-0-18" id="h5-0-18" class="i">+    search_file *file;
</a><a href="#h5-0-19" id="h5-0-19" class="i">+    int left;
</a><a href="#h5-0-20" id="h5-0-20" class="i">+    int right;
</a><a href="#h5-0-21" id="h5-0-21" class="i">+    void expand(int l, int r) {
</a><a href="#h5-0-22" id="h5-0-22" class="i">+        left  = min(left, l);
</a><a href="#h5-0-23" id="h5-0-23" class="i">+        right = max(right, r);
</a><a href="#h5-0-24" id="h5-0-24" class="i">+    }
</a><a href="#h5-0-25" id="h5-0-25" class="i">+
</a><a href="#h5-0-26" id="h5-0-26" class="i">+    bool operator&lt;(const chunk_file&amp; rhs) const {
</a><a href="#h5-0-27" id="h5-0-27" class="i">+        return left &lt; rhs.left;
</a><a href="#h5-0-28" id="h5-0-28" class="i">+    }
</a><a href="#h5-0-29" id="h5-0-29" class="i">+};
</a><a href="#h5-0-30" id="h5-0-30" class="i">+
</a><a href="#h5-0-31" id="h5-0-31" class="i">+extern size_t kChunkSize;
</a><a href="#h5-0-32" id="h5-0-32" class="i">+const size_t kMaxGap       = 1 &lt;&lt; 10;
</a><a href="#h5-0-33" id="h5-0-33" class="i">+#define CHUNK_MAGIC 0xC407FADE
</a><a href="#h5-0-34" id="h5-0-34" class="i">+
</a><a href="#h5-0-35" id="h5-0-35" class="i">+struct chunk {
</a><a href="#h5-0-36" id="h5-0-36" class="i">+    static int chunk_files;
</a><a href="#h5-0-37" id="h5-0-37" class="i">+    int size;
</a><a href="#h5-0-38" id="h5-0-38" class="i">+    unsigned magic;
</a><a href="#h5-0-39" id="h5-0-39" class="i">+    vector&lt;chunk_file&gt; files;
</a><a href="#h5-0-40" id="h5-0-40" class="i">+    vector&lt;chunk_file&gt; cur_file;
</a><a href="#h5-0-41" id="h5-0-41" class="i">+    uint32_t *suffixes;
</a><a href="#h5-0-42" id="h5-0-42" class="i">+    char data[0];
</a><a href="#h5-0-43" id="h5-0-43" class="i">+
</a><a href="#h5-0-44" id="h5-0-44" class="i">+    chunk()
</a><a href="#h5-0-45" id="h5-0-45" class="i">+        : size(0), magic(CHUNK_MAGIC), files(), suffixes(0) {
</a><a href="#h5-0-46" id="h5-0-46" class="i">+    }
</a><a href="#h5-0-47" id="h5-0-47" class="i">+
</a><a href="#h5-0-48" id="h5-0-48" class="i">+    void add_chunk_file(search_file *sf, const StringPiece&amp; line);
</a><a href="#h5-0-49" id="h5-0-49" class="i">+    void finish_file();
</a><a href="#h5-0-50" id="h5-0-50" class="i">+    void finalize();
</a><a href="#h5-0-51" id="h5-0-51" class="i">+
</a><a href="#h5-0-52" id="h5-0-52" class="i">+    static chunk *from_str(const char *p) {
</a><a href="#h5-0-53" id="h5-0-53" class="i">+        chunk *out = reinterpret_cast&lt;chunk*&gt;
</a><a href="#h5-0-54" id="h5-0-54" class="i">+            ((uintptr_t(p) - 1) &amp; ~(kChunkSize - 1));
</a><a href="#h5-0-55" id="h5-0-55" class="i">+        assert(out-&gt;magic == CHUNK_MAGIC);
</a><a href="#h5-0-56" id="h5-0-56" class="i">+        return out;
</a><a href="#h5-0-57" id="h5-0-57" class="i">+    }
</a><a href="#h5-0-58" id="h5-0-58" class="i">+
</a><a href="#h5-0-59" id="h5-0-59" class="i">+    struct lt_suffix {
</a><a href="#h5-0-60" id="h5-0-60" class="i">+        const chunk *chunk_;
</a><a href="#h5-0-61" id="h5-0-61" class="i">+        lt_suffix(const chunk *chunk) : chunk_(chunk) { }
</a><a href="#h5-0-62" id="h5-0-62" class="i">+        bool operator()(uint32_t lhs, uint32_t rhs) {
</a><a href="#h5-0-63" id="h5-0-63" class="i">+            const char *l = &amp;chunk_-&gt;data[lhs];
</a><a href="#h5-0-64" id="h5-0-64" class="i">+            const char *r = &amp;chunk_-&gt;data[rhs];
</a><a href="#h5-0-65" id="h5-0-65" class="i">+            const char *le = static_cast&lt;const char*&gt;
</a><a href="#h5-0-66" id="h5-0-66" class="i">+                (memchr(l, &#39;\n&#39;, chunk_-&gt;size - lhs));
</a><a href="#h5-0-67" id="h5-0-67" class="i">+            const char *re = static_cast&lt;const char*&gt;
</a><a href="#h5-0-68" id="h5-0-68" class="i">+                (memchr(r, &#39;\n&#39;, chunk_-&gt;size - rhs));
</a><a href="#h5-0-69" id="h5-0-69" class="i">+            assert(le);
</a><a href="#h5-0-70" id="h5-0-70" class="i">+            assert(re);
</a><a href="#h5-0-71" id="h5-0-71" class="i">+            return strncmp(l, r, min(le - l, re - r)) &lt; 0;
</a><a href="#h5-0-72" id="h5-0-72" class="i">+        }
</a><a href="#h5-0-73" id="h5-0-73" class="i">+
</a><a href="#h5-0-74" id="h5-0-74" class="i">+        bool operator()(uint32_t lhs, const string&amp; rhs) {
</a><a href="#h5-0-75" id="h5-0-75" class="i">+            return cmp(lhs, rhs) &lt; 0;
</a><a href="#h5-0-76" id="h5-0-76" class="i">+        }
</a><a href="#h5-0-77" id="h5-0-77" class="i">+
</a><a href="#h5-0-78" id="h5-0-78" class="i">+        bool operator()(const string&amp; lhs, uint32_t rhs) {
</a><a href="#h5-0-79" id="h5-0-79" class="i">+            return cmp(rhs, lhs) &gt; 0;
</a><a href="#h5-0-80" id="h5-0-80" class="i">+        }
</a><a href="#h5-0-81" id="h5-0-81" class="i">+
</a><a href="#h5-0-82" id="h5-0-82" class="i">+    private:
</a><a href="#h5-0-83" id="h5-0-83" class="i">+        int cmp(uint32_t lhs, const string&amp; rhs) {
</a><a href="#h5-0-84" id="h5-0-84" class="i">+            const char *l = &amp;chunk_-&gt;data[lhs];
</a><a href="#h5-0-85" id="h5-0-85" class="i">+            const char *le = static_cast&lt;const char*&gt;
</a><a href="#h5-0-86" id="h5-0-86" class="i">+                (memchr(l, &#39;\n&#39;, chunk_-&gt;size - lhs));
</a><a href="#h5-0-87" id="h5-0-87" class="i">+            size_t lhs_len = le - l;
</a><a href="#h5-0-88" id="h5-0-88" class="i">+            int cmp = memcmp(l, rhs.c_str(), min(lhs_len, rhs.size()));
</a><a href="#h5-0-89" id="h5-0-89" class="i">+            if (cmp == 0)
</a><a href="#h5-0-90" id="h5-0-90" class="i">+                return lhs_len &lt; rhs.size() ? -1 : 0;
</a><a href="#h5-0-91" id="h5-0-91" class="i">+            return cmp;
</a><a href="#h5-0-92" id="h5-0-92" class="i">+        }
</a><a href="#h5-0-93" id="h5-0-93" class="i">+    };
</a><a href="#h5-0-94" id="h5-0-94" class="i">+
</a><a href="#h5-0-95" id="h5-0-95" class="i">+private:
</a><a href="#h5-0-96" id="h5-0-96" class="i">+    chunk(const chunk&amp;);
</a><a href="#h5-0-97" id="h5-0-97" class="i">+    chunk operator=(const chunk&amp;);
</a><a href="#h5-0-98" id="h5-0-98" class="i">+};
</a><a href="#h5-0-99" id="h5-0-99" class="i">+
</a><a href="#h5-0-100" id="h5-0-100" class="i">+extern size_t kChunkSpace;
</a><b>diff --git a/<a id="h6" href="../file/chunk_allocator.cc">chunk_allocator.cc</a> b/<a href="../file/chunk_allocator.cc">chunk_allocator.cc</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -0,0 +1,55 @@
</a><a href="#h6-0-0" id="h6-0-0" class="i">+#include &quot;chunk_allocator.h&quot;
</a><a href="#h6-0-1" id="h6-0-1" class="i">+#include &quot;chunk.h&quot;
</a><a href="#h6-0-2" id="h6-0-2" class="i">+
</a><a href="#h6-0-3" id="h6-0-3" class="i">+#include &lt;gflags/gflags.h&gt;
</a><a href="#h6-0-4" id="h6-0-4" class="i">+
</a><a href="#h6-0-5" id="h6-0-5" class="i">+DECLARE_int32(threads);
</a><a href="#h6-0-6" id="h6-0-6" class="i">+
</a><a href="#h6-0-7" id="h6-0-7" class="i">+bool chunk_allocator::finalizer::operator()(chunk *chunk) {
</a><a href="#h6-0-8" id="h6-0-8" class="i">+    if (!chunk)
</a><a href="#h6-0-9" id="h6-0-9" class="i">+        return true;
</a><a href="#h6-0-10" id="h6-0-10" class="i">+    chunk-&gt;finalize();
</a><a href="#h6-0-11" id="h6-0-11" class="i">+    return false;
</a><a href="#h6-0-12" id="h6-0-12" class="i">+}
</a><a href="#h6-0-13" id="h6-0-13" class="i">+
</a><a href="#h6-0-14" id="h6-0-14" class="i">+chunk_allocator::chunk_allocator()  :
</a><a href="#h6-0-15" id="h6-0-15" class="i">+    current_(0), finalizer_() {
</a><a href="#h6-0-16" id="h6-0-16" class="i">+    new_chunk();
</a><a href="#h6-0-17" id="h6-0-17" class="i">+    finalize_pool_ = new thread_pool&lt;chunk*, finalizer&gt;(FLAGS_threads, finalizer_);
</a><a href="#h6-0-18" id="h6-0-18" class="i">+}
</a><a href="#h6-0-19" id="h6-0-19" class="i">+
</a><a href="#h6-0-20" id="h6-0-20" class="i">+char *chunk_allocator::alloc(size_t len) {
</a><a href="#h6-0-21" id="h6-0-21" class="i">+    assert(len &lt; kChunkSpace);
</a><a href="#h6-0-22" id="h6-0-22" class="i">+    if ((current_-&gt;size + len) &gt; kChunkSpace)
</a><a href="#h6-0-23" id="h6-0-23" class="i">+        new_chunk();
</a><a href="#h6-0-24" id="h6-0-24" class="i">+    char *out = current_-&gt;data + current_-&gt;size;
</a><a href="#h6-0-25" id="h6-0-25" class="i">+    current_-&gt;size += len;
</a><a href="#h6-0-26" id="h6-0-26" class="i">+    return out;
</a><a href="#h6-0-27" id="h6-0-27" class="i">+}
</a><a href="#h6-0-28" id="h6-0-28" class="i">+
</a><a href="#h6-0-29" id="h6-0-29" class="i">+static chunk *alloc_chunk() {
</a><a href="#h6-0-30" id="h6-0-30" class="i">+    void *p;
</a><a href="#h6-0-31" id="h6-0-31" class="i">+    if (posix_memalign(&amp;p, kChunkSize, kChunkSize) != 0)
</a><a href="#h6-0-32" id="h6-0-32" class="i">+        return NULL;
</a><a href="#h6-0-33" id="h6-0-33" class="i">+    return new(p) chunk;
</a><a href="#h6-0-34" id="h6-0-34" class="i">+};
</a><a href="#h6-0-35" id="h6-0-35" class="i">+
</a><a href="#h6-0-36" id="h6-0-36" class="i">+void chunk_allocator::new_chunk()  {
</a><a href="#h6-0-37" id="h6-0-37" class="i">+    if (current_)
</a><a href="#h6-0-38" id="h6-0-38" class="i">+        finalize_pool_-&gt;queue(current_);
</a><a href="#h6-0-39" id="h6-0-39" class="i">+    current_ = alloc_chunk();
</a><a href="#h6-0-40" id="h6-0-40" class="i">+    chunks_.push_back(current_);
</a><a href="#h6-0-41" id="h6-0-41" class="i">+}
</a><a href="#h6-0-42" id="h6-0-42" class="i">+
</a><a href="#h6-0-43" id="h6-0-43" class="i">+void chunk_allocator::finalize()  {
</a><a href="#h6-0-44" id="h6-0-44" class="i">+    finalize_pool_-&gt;queue(current_);
</a><a href="#h6-0-45" id="h6-0-45" class="i">+    for (int i = 0; i &lt; FLAGS_threads; i++)
</a><a href="#h6-0-46" id="h6-0-46" class="i">+        finalize_pool_-&gt;queue(NULL);
</a><a href="#h6-0-47" id="h6-0-47" class="i">+    delete finalize_pool_;
</a><a href="#h6-0-48" id="h6-0-48" class="i">+    finalize_pool_ = NULL;
</a><a href="#h6-0-49" id="h6-0-49" class="i">+}
</a><a href="#h6-0-50" id="h6-0-50" class="i">+
</a><a href="#h6-0-51" id="h6-0-51" class="i">+void chunk_allocator::skip_chunk() {
</a><a href="#h6-0-52" id="h6-0-52" class="i">+    current_ = 0;
</a><a href="#h6-0-53" id="h6-0-53" class="i">+    new_chunk();
</a><a href="#h6-0-54" id="h6-0-54" class="i">+}
</a><b>diff --git a/<a id="h7" href="../file/chunk_allocator.h">chunk_allocator.h</a> b/<a href="../file/chunk_allocator.h">chunk_allocator.h</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -0,0 +1,43 @@
</a><a href="#h7-0-0" id="h7-0-0" class="i">+#include &lt;list&gt;
</a><a href="#h7-0-1" id="h7-0-1" class="i">+#include &quot;thread_pool.h&quot;
</a><a href="#h7-0-2" id="h7-0-2" class="i">+
</a><a href="#h7-0-3" id="h7-0-3" class="i">+using namespace std;
</a><a href="#h7-0-4" id="h7-0-4" class="i">+struct chunk;
</a><a href="#h7-0-5" id="h7-0-5" class="i">+
</a><a href="#h7-0-6" id="h7-0-6" class="i">+class chunk_allocator {
</a><a href="#h7-0-7" id="h7-0-7" class="i">+public:
</a><a href="#h7-0-8" id="h7-0-8" class="i">+    chunk_allocator();
</a><a href="#h7-0-9" id="h7-0-9" class="i">+    char *alloc(size_t len);
</a><a href="#h7-0-10" id="h7-0-10" class="i">+
</a><a href="#h7-0-11" id="h7-0-11" class="i">+    list&lt;chunk*&gt;::iterator begin () {
</a><a href="#h7-0-12" id="h7-0-12" class="i">+        return chunks_.begin();
</a><a href="#h7-0-13" id="h7-0-13" class="i">+    }
</a><a href="#h7-0-14" id="h7-0-14" class="i">+
</a><a href="#h7-0-15" id="h7-0-15" class="i">+    typename list&lt;chunk*&gt;::iterator end () {
</a><a href="#h7-0-16" id="h7-0-16" class="i">+        return chunks_.end();
</a><a href="#h7-0-17" id="h7-0-17" class="i">+    }
</a><a href="#h7-0-18" id="h7-0-18" class="i">+
</a><a href="#h7-0-19" id="h7-0-19" class="i">+    size_t size () {
</a><a href="#h7-0-20" id="h7-0-20" class="i">+        return chunks_.size();
</a><a href="#h7-0-21" id="h7-0-21" class="i">+    }
</a><a href="#h7-0-22" id="h7-0-22" class="i">+
</a><a href="#h7-0-23" id="h7-0-23" class="i">+    chunk *current_chunk() {
</a><a href="#h7-0-24" id="h7-0-24" class="i">+        return current_;
</a><a href="#h7-0-25" id="h7-0-25" class="i">+    }
</a><a href="#h7-0-26" id="h7-0-26" class="i">+
</a><a href="#h7-0-27" id="h7-0-27" class="i">+    void skip_chunk();
</a><a href="#h7-0-28" id="h7-0-28" class="i">+    void finalize();
</a><a href="#h7-0-29" id="h7-0-29" class="i">+
</a><a href="#h7-0-30" id="h7-0-30" class="i">+protected:
</a><a href="#h7-0-31" id="h7-0-31" class="i">+
</a><a href="#h7-0-32" id="h7-0-32" class="i">+    struct finalizer {
</a><a href="#h7-0-33" id="h7-0-33" class="i">+        bool operator()(chunk *chunk);
</a><a href="#h7-0-34" id="h7-0-34" class="i">+    };
</a><a href="#h7-0-35" id="h7-0-35" class="i">+
</a><a href="#h7-0-36" id="h7-0-36" class="i">+    void new_chunk();
</a><a href="#h7-0-37" id="h7-0-37" class="i">+
</a><a href="#h7-0-38" id="h7-0-38" class="i">+    list&lt;chunk*&gt; chunks_;
</a><a href="#h7-0-39" id="h7-0-39" class="i">+    chunk *current_;
</a><a href="#h7-0-40" id="h7-0-40" class="i">+    finalizer finalizer_;
</a><a href="#h7-0-41" id="h7-0-41" class="i">+    thread_pool&lt;chunk*, finalizer&gt; *finalize_pool_;
</a><a href="#h7-0-42" id="h7-0-42" class="i">+};
</a><b>diff --git a/<a id="h8" href="../file/codesearch.cc">codesearch.cc</a> b/<a href="../file/codesearch.cc">codesearch.cc</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -6,16 +6,23 @@
</a> #include &lt;list&gt;
 #include &lt;iostream&gt;
 #include &lt;string&gt;
<a href="#h8-0-3" id="h8-0-3" class="d">-#include &lt;atomic&gt;
</a><a href="#h8-0-4" id="h8-0-4" class="i">+#include &lt;fstream&gt;
</a> 
 #include &lt;re2/re2.h&gt;
<a href="#h8-0-7" id="h8-0-7" class="i">+#include &lt;re2/filtered_re2.h&gt;
</a> 
 #include &lt;json/json.h&gt;
 
<a href="#h8-0-11" id="h8-0-11" class="i">+#include &lt;gflags/gflags.h&gt;
</a><a href="#h8-0-12" id="h8-0-12" class="i">+
</a> #include &quot;timer.h&quot;
 #include &quot;thread_queue.h&quot;
 #include &quot;thread_pool.h&quot;
 #include &quot;codesearch.h&quot;
<a href="#h8-0-17" id="h8-0-17" class="i">+#include &quot;chunk.h&quot;
</a><a href="#h8-0-18" id="h8-0-18" class="i">+#include &quot;chunk_allocator.h&quot;
</a><a href="#h8-0-19" id="h8-0-19" class="i">+#include &quot;radix_sort.h&quot;
</a><a href="#h8-0-20" id="h8-0-20" class="i">+#include &quot;atomic.h&quot;
</a> 
 #include &quot;utf8.h&quot;
 
<a href="#h8-1" id="h8-1" class="h">@@ -23,8 +30,6 @@ using re2::RE2;
</a> using re2::StringPiece;
 using namespace std;
 
<a href="#h8-1-3" id="h8-1-3" class="d">-const size_t kChunkSize    = 1 &lt;&lt; 20;
</a><a href="#h8-1-4" id="h8-1-4" class="d">-const size_t kMaxGap       = 1 &lt;&lt; 10;
</a> const int    kMaxMatches   = 50;
 const int    kContextLines = 3;
 
<a href="#h8-2" id="h8-2" class="h">@@ -34,24 +39,20 @@ const int    kContextLines = 3;
</a> #define log_profile(...)
 #endif
 
<a href="#h8-2-3" id="h8-2-3" class="i">+DEFINE_bool(index, true, &quot;Create a suffix-array index to speed searches.&quot;);
</a><a href="#h8-2-4" id="h8-2-4" class="i">+DECLARE_int32(threads);
</a><a href="#h8-2-5" id="h8-2-5" class="i">+
</a><a href="#h8-2-6" id="h8-2-6" class="i">+namespace re2 {
</a><a href="#h8-2-7" id="h8-2-7" class="i">+    extern int32_t FLAGS_filtered_re2_min_atom_len;
</a><a href="#h8-2-8" id="h8-2-8" class="i">+};
</a><a href="#h8-2-9" id="h8-2-9" class="i">+
</a><a href="#h8-2-10" id="h8-2-10" class="i">+const int kMaxFilters = 4;
</a><a href="#h8-2-11" id="h8-2-11" class="i">+
</a> struct search_file {
     string path;
     const char *ref;
     git_oid oid;
<a href="#h8-2-16" id="h8-2-16" class="d">-};
</a><a href="#h8-2-17" id="h8-2-17" class="d">-
</a><a href="#h8-2-18" id="h8-2-18" class="d">-struct chunk_file {
</a><a href="#h8-2-19" id="h8-2-19" class="d">-    search_file *file;
</a><a href="#h8-2-20" id="h8-2-20" class="d">-    int left;
</a><a href="#h8-2-21" id="h8-2-21" class="d">-    int right;
</a><a href="#h8-2-22" id="h8-2-22" class="d">-    void expand(int l, int r) {
</a><a href="#h8-2-23" id="h8-2-23" class="d">-        left  = min(left, l);
</a><a href="#h8-2-24" id="h8-2-24" class="d">-        right = max(right, r);
</a><a href="#h8-2-25" id="h8-2-25" class="d">-    }
</a><a href="#h8-2-26" id="h8-2-26" class="d">-
</a><a href="#h8-2-27" id="h8-2-27" class="d">-    bool operator&lt;(const chunk_file&amp; rhs) const {
</a><a href="#h8-2-28" id="h8-2-28" class="d">-        return left &lt; rhs.left;
</a><a href="#h8-2-29" id="h8-2-29" class="d">-    }
</a><a href="#h8-2-30" id="h8-2-30" class="i">+    int no;
</a> };
 
 struct match_result {
<a href="#h8-3" id="h8-3" class="h">@@ -63,119 +64,6 @@ struct match_result {
</a>     int matchleft, matchright;
 };
 
<a href="#h8-3-3" id="h8-3-3" class="d">-#define CHUNK_MAGIC 0xC407FADE
</a><a href="#h8-3-4" id="h8-3-4" class="d">-
</a><a href="#h8-3-5" id="h8-3-5" class="d">-struct chunk {
</a><a href="#h8-3-6" id="h8-3-6" class="d">-    static int chunk_files;
</a><a href="#h8-3-7" id="h8-3-7" class="d">-    int size;
</a><a href="#h8-3-8" id="h8-3-8" class="d">-    unsigned magic;
</a><a href="#h8-3-9" id="h8-3-9" class="d">-    vector&lt;chunk_file&gt; files;
</a><a href="#h8-3-10" id="h8-3-10" class="d">-    vector&lt;chunk_file&gt; cur_file;
</a><a href="#h8-3-11" id="h8-3-11" class="d">-    char data[0];
</a><a href="#h8-3-12" id="h8-3-12" class="d">-
</a><a href="#h8-3-13" id="h8-3-13" class="d">-    chunk()
</a><a href="#h8-3-14" id="h8-3-14" class="d">-        : size(0), magic(CHUNK_MAGIC), files() {
</a><a href="#h8-3-15" id="h8-3-15" class="d">-    }
</a><a href="#h8-3-16" id="h8-3-16" class="d">-
</a><a href="#h8-3-17" id="h8-3-17" class="d">-    void add_chunk_file(search_file *sf, const StringPiece&amp; line) {
</a><a href="#h8-3-18" id="h8-3-18" class="d">-        int l = line.data() - data;
</a><a href="#h8-3-19" id="h8-3-19" class="d">-        int r = l + line.size();
</a><a href="#h8-3-20" id="h8-3-20" class="d">-        chunk_file *f = NULL;
</a><a href="#h8-3-21" id="h8-3-21" class="d">-        int min_dist = numeric_limits&lt;int&gt;::max(), dist;
</a><a href="#h8-3-22" id="h8-3-22" class="d">-        for (vector&lt;chunk_file&gt;::iterator it = cur_file.begin();
</a><a href="#h8-3-23" id="h8-3-23" class="d">-             it != cur_file.end(); it ++) {
</a><a href="#h8-3-24" id="h8-3-24" class="d">-            if (l &lt;= it-&gt;left)
</a><a href="#h8-3-25" id="h8-3-25" class="d">-                dist = max(0, it-&gt;left - r);
</a><a href="#h8-3-26" id="h8-3-26" class="d">-            else if (r &gt;= it-&gt;right)
</a><a href="#h8-3-27" id="h8-3-27" class="d">-                dist = max(0, l - it-&gt;right);
</a><a href="#h8-3-28" id="h8-3-28" class="d">-            else
</a><a href="#h8-3-29" id="h8-3-29" class="d">-                dist = 0;
</a><a href="#h8-3-30" id="h8-3-30" class="d">-            assert(dist == 0 || r &lt; it-&gt;left || l &gt; it-&gt;right);
</a><a href="#h8-3-31" id="h8-3-31" class="d">-            if (dist &lt; min_dist) {
</a><a href="#h8-3-32" id="h8-3-32" class="d">-                min_dist = dist;
</a><a href="#h8-3-33" id="h8-3-33" class="d">-                f = &amp;(*it);
</a><a href="#h8-3-34" id="h8-3-34" class="d">-            }
</a><a href="#h8-3-35" id="h8-3-35" class="d">-        }
</a><a href="#h8-3-36" id="h8-3-36" class="d">-        if (f &amp;&amp; min_dist &lt; kMaxGap) {
</a><a href="#h8-3-37" id="h8-3-37" class="d">-            f-&gt;expand(l, r);
</a><a href="#h8-3-38" id="h8-3-38" class="d">-            return;
</a><a href="#h8-3-39" id="h8-3-39" class="d">-        }
</a><a href="#h8-3-40" id="h8-3-40" class="d">-        chunk_files++;
</a><a href="#h8-3-41" id="h8-3-41" class="d">-        cur_file.push_back(chunk_file());
</a><a href="#h8-3-42" id="h8-3-42" class="d">-        chunk_file&amp; cf = cur_file.back();
</a><a href="#h8-3-43" id="h8-3-43" class="d">-        cf.file = sf;
</a><a href="#h8-3-44" id="h8-3-44" class="d">-        cf.left = l;
</a><a href="#h8-3-45" id="h8-3-45" class="d">-        cf.right = r;
</a><a href="#h8-3-46" id="h8-3-46" class="d">-    }
</a><a href="#h8-3-47" id="h8-3-47" class="d">-
</a><a href="#h8-3-48" id="h8-3-48" class="d">-    void finish_file() {
</a><a href="#h8-3-49" id="h8-3-49" class="d">-        int right = -1;
</a><a href="#h8-3-50" id="h8-3-50" class="d">-        sort(cur_file.begin(), cur_file.end());
</a><a href="#h8-3-51" id="h8-3-51" class="d">-        for (vector&lt;chunk_file&gt;::iterator it = cur_file.begin();
</a><a href="#h8-3-52" id="h8-3-52" class="d">-             it != cur_file.end(); it ++) {
</a><a href="#h8-3-53" id="h8-3-53" class="d">-            assert(right &lt; it-&gt;left);
</a><a href="#h8-3-54" id="h8-3-54" class="d">-            right = max(right, it-&gt;right);
</a><a href="#h8-3-55" id="h8-3-55" class="d">-        }
</a><a href="#h8-3-56" id="h8-3-56" class="d">-        files.insert(files.end(), cur_file.begin(), cur_file.end());
</a><a href="#h8-3-57" id="h8-3-57" class="d">-        cur_file.clear();
</a><a href="#h8-3-58" id="h8-3-58" class="d">-    }
</a><a href="#h8-3-59" id="h8-3-59" class="d">-
</a><a href="#h8-3-60" id="h8-3-60" class="d">-    static chunk *from_str(const char *p) {
</a><a href="#h8-3-61" id="h8-3-61" class="d">-        chunk *out = reinterpret_cast&lt;chunk*&gt;
</a><a href="#h8-3-62" id="h8-3-62" class="d">-            ((uintptr_t(p) - 1) &amp; ~(kChunkSize - 1));
</a><a href="#h8-3-63" id="h8-3-63" class="d">-        assert(out-&gt;magic == CHUNK_MAGIC);
</a><a href="#h8-3-64" id="h8-3-64" class="d">-        return out;
</a><a href="#h8-3-65" id="h8-3-65" class="d">-    }
</a><a href="#h8-3-66" id="h8-3-66" class="d">-};
</a><a href="#h8-3-67" id="h8-3-67" class="d">-
</a><a href="#h8-3-68" id="h8-3-68" class="d">-int chunk::chunk_files = 0;
</a><a href="#h8-3-69" id="h8-3-69" class="d">-
</a><a href="#h8-3-70" id="h8-3-70" class="d">-const size_t kChunkSpace = kChunkSize - sizeof(chunk);
</a><a href="#h8-3-71" id="h8-3-71" class="d">-
</a><a href="#h8-3-72" id="h8-3-72" class="d">-chunk *alloc_chunk() {
</a><a href="#h8-3-73" id="h8-3-73" class="d">-    void *p;
</a><a href="#h8-3-74" id="h8-3-74" class="d">-    if (posix_memalign(&amp;p, kChunkSize, kChunkSize) != 0)
</a><a href="#h8-3-75" id="h8-3-75" class="d">-        return NULL;
</a><a href="#h8-3-76" id="h8-3-76" class="d">-    return new(p) chunk;
</a><a href="#h8-3-77" id="h8-3-77" class="d">-};
</a><a href="#h8-3-78" id="h8-3-78" class="d">-
</a><a href="#h8-3-79" id="h8-3-79" class="d">-class chunk_allocator {
</a><a href="#h8-3-80" id="h8-3-80" class="d">-public:
</a><a href="#h8-3-81" id="h8-3-81" class="d">-    chunk_allocator() : current_(0) {
</a><a href="#h8-3-82" id="h8-3-82" class="d">-        new_chunk();
</a><a href="#h8-3-83" id="h8-3-83" class="d">-    }
</a><a href="#h8-3-84" id="h8-3-84" class="d">-
</a><a href="#h8-3-85" id="h8-3-85" class="d">-    char *alloc(size_t len) {
</a><a href="#h8-3-86" id="h8-3-86" class="d">-        assert(len &lt; kChunkSpace);
</a><a href="#h8-3-87" id="h8-3-87" class="d">-        if ((current_-&gt;size + len) &gt; kChunkSpace)
</a><a href="#h8-3-88" id="h8-3-88" class="d">-            new_chunk();
</a><a href="#h8-3-89" id="h8-3-89" class="d">-        char *out = current_-&gt;data + current_-&gt;size;
</a><a href="#h8-3-90" id="h8-3-90" class="d">-        current_-&gt;size += len;
</a><a href="#h8-3-91" id="h8-3-91" class="d">-        return out;
</a><a href="#h8-3-92" id="h8-3-92" class="d">-    }
</a><a href="#h8-3-93" id="h8-3-93" class="d">-
</a><a href="#h8-3-94" id="h8-3-94" class="d">-    list&lt;chunk*&gt;::iterator begin () {
</a><a href="#h8-3-95" id="h8-3-95" class="d">-        return chunks_.begin();
</a><a href="#h8-3-96" id="h8-3-96" class="d">-    }
</a><a href="#h8-3-97" id="h8-3-97" class="d">-
</a><a href="#h8-3-98" id="h8-3-98" class="d">-    typename list&lt;chunk*&gt;::iterator end () {
</a><a href="#h8-3-99" id="h8-3-99" class="d">-        return chunks_.end();
</a><a href="#h8-3-100" id="h8-3-100" class="d">-    }
</a><a href="#h8-3-101" id="h8-3-101" class="d">-
</a><a href="#h8-3-102" id="h8-3-102" class="d">-    chunk *current_chunk() {
</a><a href="#h8-3-103" id="h8-3-103" class="d">-        return current_;
</a><a href="#h8-3-104" id="h8-3-104" class="d">-    }
</a><a href="#h8-3-105" id="h8-3-105" class="d">-
</a><a href="#h8-3-106" id="h8-3-106" class="d">-protected:
</a><a href="#h8-3-107" id="h8-3-107" class="d">-    void new_chunk() {
</a><a href="#h8-3-108" id="h8-3-108" class="d">-        current_ = alloc_chunk();
</a><a href="#h8-3-109" id="h8-3-109" class="d">-        chunks_.push_back(current_);
</a><a href="#h8-3-110" id="h8-3-110" class="d">-    }
</a><a href="#h8-3-111" id="h8-3-111" class="d">-
</a><a href="#h8-3-112" id="h8-3-112" class="d">-    list&lt;chunk*&gt; chunks_;
</a><a href="#h8-3-113" id="h8-3-113" class="d">-    chunk *current_;
</a><a href="#h8-3-114" id="h8-3-114" class="d">-};
</a><a href="#h8-3-115" id="h8-3-115" class="d">-
</a> bool eqstr::operator()(const StringPiece&amp; lhs, const StringPiece&amp; rhs) const {
     if (lhs.data() == NULL &amp;&amp; rhs.data() == NULL)
         return true;
<a href="#h8-4" id="h8-4" class="h">@@ -197,20 +85,27 @@ class searcher {
</a> public:
     searcher(code_searcher *cc, thread_queue&lt;match_result*&gt;&amp; queue, RE2&amp; pat) :
         cc_(cc), pat_(pat), queue_(queue),
<a href="#h8-4-3" id="h8-4-3" class="d">-        matches_(0)
</a><a href="#h8-4-4" id="h8-4-4" class="d">-#ifdef PROFILE_CODESEARCH
</a><a href="#h8-4-5" id="h8-4-5" class="d">-        , re2_time_(false), our_time_(false)
</a><a href="#h8-4-6" id="h8-4-6" class="d">-#endif
</a><a href="#h8-4-7" id="h8-4-7" class="i">+        matches_(0), re2_time_(false), git_time_(false)
</a>     {
<a href="#h8-4-9" id="h8-4-9" class="i">+        int id;
</a><a href="#h8-4-10" id="h8-4-10" class="i">+        re2::FLAGS_filtered_re2_min_atom_len = 5;
</a><a href="#h8-4-11" id="h8-4-11" class="i">+        while(re2::FLAGS_filtered_re2_min_atom_len &gt; 0) {
</a><a href="#h8-4-12" id="h8-4-12" class="i">+            re2::FilteredRE2 fre2;
</a><a href="#h8-4-13" id="h8-4-13" class="i">+            assert(!fre2.Add(pat.pattern(), pat.options(), &amp;id));
</a><a href="#h8-4-14" id="h8-4-14" class="i">+            fre2.Compile(&amp;filter_, false);
</a><a href="#h8-4-15" id="h8-4-15" class="i">+            if (filter_.size() &gt; 0 &amp;&amp; filter_.size() &lt; kMaxFilters)
</a><a href="#h8-4-16" id="h8-4-16" class="i">+                break;
</a><a href="#h8-4-17" id="h8-4-17" class="i">+            re2::FLAGS_filtered_re2_min_atom_len--;
</a><a href="#h8-4-18" id="h8-4-18" class="i">+        }
</a>     }
 
     ~searcher() {
         log_profile(&quot;re2 time: %d.%06ds\n&quot;,
                     int(re2_time_.elapsed().tv_sec),
                     int(re2_time_.elapsed().tv_usec));
<a href="#h8-4-25" id="h8-4-25" class="d">-        log_profile(&quot;our time: %d.%06ds\n&quot;,
</a><a href="#h8-4-26" id="h8-4-26" class="d">-                    int(our_time_.elapsed().tv_sec),
</a><a href="#h8-4-27" id="h8-4-27" class="d">-                    int(our_time_.elapsed().tv_usec));
</a><a href="#h8-4-28" id="h8-4-28" class="i">+        log_profile(&quot;git time: %d.%06ds\n&quot;,
</a><a href="#h8-4-29" id="h8-4-29" class="i">+                    int(git_time_.elapsed().tv_sec),
</a><a href="#h8-4-30" id="h8-4-30" class="i">+                    int(git_time_.elapsed().tv_usec));
</a>     }
 
     class thread_state {
<a href="#h8-5" id="h8-5" class="h">@@ -231,51 +126,27 @@ public:
</a>         friend class searcher;
     };
 
<a href="#h8-5-3" id="h8-5-3" class="d">-    bool operator()(const thread_state&amp; ts, const chunk *chunk) {
</a><a href="#h8-5-4" id="h8-5-4" class="d">-        if (chunk == NULL) {
</a><a href="#h8-5-5" id="h8-5-5" class="d">-            queue_.push(NULL);
</a><a href="#h8-5-6" id="h8-5-6" class="d">-            return true;
</a><a href="#h8-5-7" id="h8-5-7" class="d">-        }
</a><a href="#h8-5-8" id="h8-5-8" class="d">-        StringPiece str(chunk-&gt;data, chunk-&gt;size);
</a><a href="#h8-5-9" id="h8-5-9" class="d">-        StringPiece match;
</a><a href="#h8-5-10" id="h8-5-10" class="d">-        int pos = 0, new_pos;
</a><a href="#h8-5-11" id="h8-5-11" class="d">-        timer re2_time(false), our_time(false);
</a><a href="#h8-5-12" id="h8-5-12" class="d">-        while (pos &lt; str.size() &amp;&amp; matches_.load() &lt; kMaxMatches) {
</a><a href="#h8-5-13" id="h8-5-13" class="d">-            {
</a><a href="#h8-5-14" id="h8-5-14" class="d">-                run_timer run(re2_time);
</a><a href="#h8-5-15" id="h8-5-15" class="d">-                if (!pat_.Match(str, pos, str.size() - 1, RE2::UNANCHORED, &amp;match, 1))
</a><a href="#h8-5-16" id="h8-5-16" class="d">-                    break;
</a><a href="#h8-5-17" id="h8-5-17" class="d">-            }
</a><a href="#h8-5-18" id="h8-5-18" class="d">-            {
</a><a href="#h8-5-19" id="h8-5-19" class="d">-                run_timer run(our_time);
</a><a href="#h8-5-20" id="h8-5-20" class="d">-                assert(memchr(match.data(), &#39;\n&#39;, match.size()) == NULL);
</a><a href="#h8-5-21" id="h8-5-21" class="d">-                StringPiece line = find_line(str, match);
</a><a href="#h8-5-22" id="h8-5-22" class="d">-                if (utf8::is_valid(line.data(), line.data() + line.size()))
</a><a href="#h8-5-23" id="h8-5-23" class="d">-                    find_match(chunk, match, line, ts);
</a><a href="#h8-5-24" id="h8-5-24" class="d">-                new_pos = line.size() + line.data() - str.data() + 1;
</a><a href="#h8-5-25" id="h8-5-25" class="d">-                assert(new_pos &gt; pos);
</a><a href="#h8-5-26" id="h8-5-26" class="d">-                pos = new_pos;
</a><a href="#h8-5-27" id="h8-5-27" class="d">-            }
</a><a href="#h8-5-28" id="h8-5-28" class="d">-        }
</a><a href="#h8-5-29" id="h8-5-29" class="d">-#ifdef PROFILE_CODESEARCH
</a><a href="#h8-5-30" id="h8-5-30" class="d">-        {
</a><a href="#h8-5-31" id="h8-5-31" class="d">-            mutex_locker locked(timer_mtx_);
</a><a href="#h8-5-32" id="h8-5-32" class="d">-            re2_time_.add(re2_time);
</a><a href="#h8-5-33" id="h8-5-33" class="d">-            our_time_.add(our_time);
</a><a href="#h8-5-34" id="h8-5-34" class="d">-        }
</a><a href="#h8-5-35" id="h8-5-35" class="d">-#endif
</a><a href="#h8-5-36" id="h8-5-36" class="d">-        if (matches_.load() &gt;= kMaxMatches) {
</a><a href="#h8-5-37" id="h8-5-37" class="d">-            queue_.push(NULL);
</a><a href="#h8-5-38" id="h8-5-38" class="d">-            return true;
</a><a href="#h8-5-39" id="h8-5-39" class="d">-        }
</a><a href="#h8-5-40" id="h8-5-40" class="d">-        return false;
</a><a href="#h8-5-41" id="h8-5-41" class="i">+    bool operator()(const thread_state&amp; ts, const chunk *chunk);
</a><a href="#h8-5-42" id="h8-5-42" class="i">+
</a><a href="#h8-5-43" id="h8-5-43" class="i">+    void get_stats(match_stats *stats) {
</a><a href="#h8-5-44" id="h8-5-44" class="i">+        stats-&gt;re2_time = re2_time_.elapsed();
</a><a href="#h8-5-45" id="h8-5-45" class="i">+        stats-&gt;git_time = git_time_.elapsed();
</a>     }
 
 protected:
<a href="#h8-5-49" id="h8-5-49" class="i">+    void full_search(const thread_state&amp; ts, const chunk *chunk);
</a><a href="#h8-5-50" id="h8-5-50" class="i">+    void full_search(const thread_state&amp; ts, const chunk *chunk,
</a><a href="#h8-5-51" id="h8-5-51" class="i">+                     size_t minpos, size_t maxpos);
</a><a href="#h8-5-52" id="h8-5-52" class="i">+
</a><a href="#h8-5-53" id="h8-5-53" class="i">+    void filtered_search(const thread_state&amp; ts, const chunk *chunk);
</a><a href="#h8-5-54" id="h8-5-54" class="i">+    void search_lines(uint32_t *left, int count,
</a><a href="#h8-5-55" id="h8-5-55" class="i">+                      const thread_state&amp; ts, const chunk *chunk);
</a><a href="#h8-5-56" id="h8-5-56" class="i">+
</a>     void find_match (const chunk *chunk,
                      const StringPiece&amp; match,
                      const StringPiece&amp; line,
                      const thread_state&amp; ts) {
<a href="#h8-5-61" id="h8-5-61" class="i">+        run_timer run(git_time_);
</a>         timer tm;
         int off = line.data() - chunk-&gt;data;
         int searched = 0;
<a href="#h8-6" id="h8-6" class="h">@@ -305,6 +176,22 @@ protected:
</a>     match_result *try_match(const StringPiece&amp;, const StringPiece&amp;,
                             search_file *, git_repository *);
 
<a href="#h8-6-3" id="h8-6-3" class="i">+    static int line_start(const chunk *chunk, int pos) {
</a><a href="#h8-6-4" id="h8-6-4" class="i">+        const char *start = static_cast&lt;const char*&gt;
</a><a href="#h8-6-5" id="h8-6-5" class="i">+            (memrchr(chunk-&gt;data, &#39;\n&#39;, pos));
</a><a href="#h8-6-6" id="h8-6-6" class="i">+        if (start == NULL)
</a><a href="#h8-6-7" id="h8-6-7" class="i">+            return 0;
</a><a href="#h8-6-8" id="h8-6-8" class="i">+        return start - chunk-&gt;data;
</a><a href="#h8-6-9" id="h8-6-9" class="i">+    }
</a><a href="#h8-6-10" id="h8-6-10" class="i">+
</a><a href="#h8-6-11" id="h8-6-11" class="i">+    static int line_end(const chunk *chunk, int pos) {
</a><a href="#h8-6-12" id="h8-6-12" class="i">+        const char *end = static_cast&lt;const char*&gt;
</a><a href="#h8-6-13" id="h8-6-13" class="i">+            (memchr(chunk-&gt;data + pos, &#39;\n&#39;, chunk-&gt;size - pos));
</a><a href="#h8-6-14" id="h8-6-14" class="i">+        if (end == NULL)
</a><a href="#h8-6-15" id="h8-6-15" class="i">+            return chunk-&gt;size;
</a><a href="#h8-6-16" id="h8-6-16" class="i">+        return end - chunk-&gt;data;
</a><a href="#h8-6-17" id="h8-6-17" class="i">+    }
</a><a href="#h8-6-18" id="h8-6-18" class="i">+
</a>     static StringPiece find_line(const StringPiece&amp; chunk, const StringPiece&amp; match) {
         const char *start, *end;
         assert(match.data() &gt;= chunk.data());
<a href="#h8-7" id="h8-7" class="h">@@ -328,15 +215,13 @@ protected:
</a>     RE2&amp; pat_;
     thread_queue&lt;match_result*&gt;&amp; queue_;
     atomic_int matches_;
<a href="#h8-7-3" id="h8-7-3" class="d">-#ifdef PROFILE_CODESEARCH
</a><a href="#h8-7-4" id="h8-7-4" class="i">+    vector&lt;string&gt; filter_;
</a>     timer re2_time_;
<a href="#h8-7-6" id="h8-7-6" class="d">-    timer our_time_;
</a><a href="#h8-7-7" id="h8-7-7" class="d">-    mutex timer_mtx_;
</a><a href="#h8-7-8" id="h8-7-8" class="d">-#endif
</a><a href="#h8-7-9" id="h8-7-9" class="i">+    timer git_time_;
</a> };
 
 code_searcher::code_searcher(git_repository *repo)
<a href="#h8-7-13" id="h8-7-13" class="d">-    : repo_(repo), stats_(), output_json_(false)
</a><a href="#h8-7-14" id="h8-7-14" class="i">+    : repo_(repo), stats_(), output_json_(false), finalized_(false)
</a> {
 #ifdef USE_DENSE_HASH_SET
     lines_.set_empty_key(empty_string);
<a href="#h8-8" id="h8-8" class="h">@@ -349,11 +234,14 @@ code_searcher::~code_searcher() {
</a> }
 
 void code_searcher::walk_ref(const char *ref) {
<a href="#h8-8-3" id="h8-8-3" class="i">+    assert(!finalized_);
</a>     smart_object&lt;git_commit&gt; commit;
     smart_object&lt;git_tree&gt; tree;
     resolve_ref(commit, ref);
     git_commit_tree(tree, commit);
 
<a href="#h8-8-9" id="h8-8-9" class="i">+    refs_.push_back(ref);
</a><a href="#h8-8-10" id="h8-8-10" class="i">+
</a>     walk_tree(ref, &quot;&quot;, tree);
 }
 
<a href="#h8-9" id="h8-9" class="h">@@ -363,11 +251,169 @@ void code_searcher::dump_stats() {
</a>     printf(&quot;Lines: %ld (dedup: %ld)\n&quot;, stats_.lines, stats_.dedup_lines);
 }
 
<a href="#h8-9-3" id="h8-9-3" class="d">-int code_searcher::match(RE2&amp; pat) {
</a><a href="#h8-9-4" id="h8-9-4" class="i">+const uint32_t kIndexMagic   = 0xc0d35eac;
</a><a href="#h8-9-5" id="h8-9-5" class="i">+const uint32_t kIndexVersion = 2;
</a><a href="#h8-9-6" id="h8-9-6" class="i">+
</a><a href="#h8-9-7" id="h8-9-7" class="i">+struct index_header {
</a><a href="#h8-9-8" id="h8-9-8" class="i">+    uint32_t magic;
</a><a href="#h8-9-9" id="h8-9-9" class="i">+    uint32_t version;
</a><a href="#h8-9-10" id="h8-9-10" class="i">+    uint32_t chunk_size;
</a><a href="#h8-9-11" id="h8-9-11" class="i">+    uint32_t nrefs;
</a><a href="#h8-9-12" id="h8-9-12" class="i">+    uint32_t nfiles;
</a><a href="#h8-9-13" id="h8-9-13" class="i">+    uint32_t nchunks;
</a><a href="#h8-9-14" id="h8-9-14" class="i">+} __attribute__((packed));
</a><a href="#h8-9-15" id="h8-9-15" class="i">+
</a><a href="#h8-9-16" id="h8-9-16" class="i">+
</a><a href="#h8-9-17" id="h8-9-17" class="i">+struct chunk_header {
</a><a href="#h8-9-18" id="h8-9-18" class="i">+    uint32_t size;
</a><a href="#h8-9-19" id="h8-9-19" class="i">+    uint32_t nfiles;
</a><a href="#h8-9-20" id="h8-9-20" class="i">+} __attribute__((packed));
</a><a href="#h8-9-21" id="h8-9-21" class="i">+
</a><a href="#h8-9-22" id="h8-9-22" class="i">+static void dump_int32(ostream&amp; stream, uint32_t i) {
</a><a href="#h8-9-23" id="h8-9-23" class="i">+    stream.write(reinterpret_cast&lt;char*&gt;(&amp;i), sizeof i);
</a><a href="#h8-9-24" id="h8-9-24" class="i">+}
</a><a href="#h8-9-25" id="h8-9-25" class="i">+
</a><a href="#h8-9-26" id="h8-9-26" class="i">+static void dump_string(ostream&amp; stream, const char *str) {
</a><a href="#h8-9-27" id="h8-9-27" class="i">+    uint32_t len = strlen(str);
</a><a href="#h8-9-28" id="h8-9-28" class="i">+    dump_int32(stream, len);
</a><a href="#h8-9-29" id="h8-9-29" class="i">+    stream.write(str, len);
</a><a href="#h8-9-30" id="h8-9-30" class="i">+}
</a><a href="#h8-9-31" id="h8-9-31" class="i">+
</a><a href="#h8-9-32" id="h8-9-32" class="i">+void code_searcher::dump_file(ostream&amp; stream, search_file *sf) {
</a><a href="#h8-9-33" id="h8-9-33" class="i">+    /* (str path, int ref, oid id) */
</a><a href="#h8-9-34" id="h8-9-34" class="i">+    dump_string(stream, sf-&gt;path.c_str());
</a><a href="#h8-9-35" id="h8-9-35" class="i">+    dump_int32(stream, find(refs_.begin(), refs_.end(), sf-&gt;ref) - refs_.begin());
</a><a href="#h8-9-36" id="h8-9-36" class="i">+    stream.write(reinterpret_cast&lt;char*&gt;(&amp;sf-&gt;oid), sizeof sf-&gt;oid);
</a><a href="#h8-9-37" id="h8-9-37" class="i">+}
</a><a href="#h8-9-38" id="h8-9-38" class="i">+
</a><a href="#h8-9-39" id="h8-9-39" class="i">+void dump_chunk_file(ostream&amp; stream, chunk_file *cf) {
</a><a href="#h8-9-40" id="h8-9-40" class="i">+    dump_int32(stream, cf-&gt;file-&gt;no);
</a><a href="#h8-9-41" id="h8-9-41" class="i">+    dump_int32(stream, cf-&gt;left);
</a><a href="#h8-9-42" id="h8-9-42" class="i">+    dump_int32(stream, cf-&gt;right);
</a><a href="#h8-9-43" id="h8-9-43" class="i">+}
</a><a href="#h8-9-44" id="h8-9-44" class="i">+
</a><a href="#h8-9-45" id="h8-9-45" class="i">+void code_searcher::dump_chunk(ostream&amp; stream, chunk *chunk) {
</a><a href="#h8-9-46" id="h8-9-46" class="i">+    chunk_header hdr = { uint32_t(chunk-&gt;size), uint32_t(chunk-&gt;files.size()) };
</a><a href="#h8-9-47" id="h8-9-47" class="i">+    stream.write(reinterpret_cast&lt;char*&gt;(&amp;hdr), sizeof hdr);
</a><a href="#h8-9-48" id="h8-9-48" class="i">+    for (vector&lt;chunk_file&gt;::iterator it = chunk-&gt;files.begin();
</a><a href="#h8-9-49" id="h8-9-49" class="i">+         it != chunk-&gt;files.end(); it ++)
</a><a href="#h8-9-50" id="h8-9-50" class="i">+        dump_chunk_file(stream, &amp;(*it));
</a><a href="#h8-9-51" id="h8-9-51" class="i">+    stream.write(chunk-&gt;data, chunk-&gt;size);
</a><a href="#h8-9-52" id="h8-9-52" class="i">+    stream.write(reinterpret_cast&lt;char*&gt;(chunk-&gt;suffixes),
</a><a href="#h8-9-53" id="h8-9-53" class="i">+                 sizeof(uint32_t) * chunk-&gt;size);
</a><a href="#h8-9-54" id="h8-9-54" class="i">+}
</a><a href="#h8-9-55" id="h8-9-55" class="i">+
</a><a href="#h8-9-56" id="h8-9-56" class="i">+void code_searcher::dump_index(const string&amp; path) {
</a><a href="#h8-9-57" id="h8-9-57" class="i">+    assert(finalized_);
</a><a href="#h8-9-58" id="h8-9-58" class="i">+    ofstream stream(path.c_str());
</a><a href="#h8-9-59" id="h8-9-59" class="i">+    index_header hdr;
</a><a href="#h8-9-60" id="h8-9-60" class="i">+    hdr.magic   = kIndexMagic;
</a><a href="#h8-9-61" id="h8-9-61" class="i">+    hdr.version = kIndexVersion;
</a><a href="#h8-9-62" id="h8-9-62" class="i">+    hdr.chunk_size = kChunkSize;
</a><a href="#h8-9-63" id="h8-9-63" class="i">+    hdr.nrefs   = refs_.size();
</a><a href="#h8-9-64" id="h8-9-64" class="i">+    hdr.nfiles  = files_.size();
</a><a href="#h8-9-65" id="h8-9-65" class="i">+    hdr.nchunks = alloc_-&gt;size();
</a><a href="#h8-9-66" id="h8-9-66" class="i">+
</a><a href="#h8-9-67" id="h8-9-67" class="i">+    stream.write(reinterpret_cast&lt;const char*&gt;(&amp;hdr), sizeof(hdr));
</a><a href="#h8-9-68" id="h8-9-68" class="i">+
</a><a href="#h8-9-69" id="h8-9-69" class="i">+    for (vector&lt;const char*&gt;::iterator it = refs_.begin();
</a><a href="#h8-9-70" id="h8-9-70" class="i">+         it != refs_.end(); ++it) {
</a><a href="#h8-9-71" id="h8-9-71" class="i">+        dump_string(stream, *it);
</a><a href="#h8-9-72" id="h8-9-72" class="i">+    }
</a><a href="#h8-9-73" id="h8-9-73" class="i">+
</a><a href="#h8-9-74" id="h8-9-74" class="i">+    for (vector&lt;search_file*&gt;::iterator it = files_.begin();
</a><a href="#h8-9-75" id="h8-9-75" class="i">+         it != files_.end(); ++it) {
</a><a href="#h8-9-76" id="h8-9-76" class="i">+        dump_file(stream, *it);
</a><a href="#h8-9-77" id="h8-9-77" class="i">+    }
</a><a href="#h8-9-78" id="h8-9-78" class="i">+
</a><a href="#h8-9-79" id="h8-9-79" class="i">+    for (list&lt;chunk*&gt;::iterator it = alloc_-&gt;begin();
</a><a href="#h8-9-80" id="h8-9-80" class="i">+         it != alloc_-&gt;end(); ++it) {
</a><a href="#h8-9-81" id="h8-9-81" class="i">+        dump_chunk(stream, *it);
</a><a href="#h8-9-82" id="h8-9-82" class="i">+    }
</a><a href="#h8-9-83" id="h8-9-83" class="i">+}
</a><a href="#h8-9-84" id="h8-9-84" class="i">+
</a><a href="#h8-9-85" id="h8-9-85" class="i">+uint32_t load_int32(istream&amp; stream) {
</a><a href="#h8-9-86" id="h8-9-86" class="i">+    uint32_t out;
</a><a href="#h8-9-87" id="h8-9-87" class="i">+    stream.read(reinterpret_cast&lt;char*&gt;(&amp;out), sizeof out);
</a><a href="#h8-9-88" id="h8-9-88" class="i">+    return out;
</a><a href="#h8-9-89" id="h8-9-89" class="i">+}
</a><a href="#h8-9-90" id="h8-9-90" class="i">+
</a><a href="#h8-9-91" id="h8-9-91" class="i">+char *load_string(istream&amp; stream) {
</a><a href="#h8-9-92" id="h8-9-92" class="i">+    uint32_t len = load_int32(stream);
</a><a href="#h8-9-93" id="h8-9-93" class="i">+    char *buf = new char[len + 1];
</a><a href="#h8-9-94" id="h8-9-94" class="i">+    stream.read(buf, len);
</a><a href="#h8-9-95" id="h8-9-95" class="i">+    buf[len] = 0;
</a><a href="#h8-9-96" id="h8-9-96" class="i">+    return buf;
</a><a href="#h8-9-97" id="h8-9-97" class="i">+}
</a><a href="#h8-9-98" id="h8-9-98" class="i">+
</a><a href="#h8-9-99" id="h8-9-99" class="i">+search_file *code_searcher::load_file(istream&amp; stream) {
</a><a href="#h8-9-100" id="h8-9-100" class="i">+    search_file *sf = new search_file;
</a><a href="#h8-9-101" id="h8-9-101" class="i">+    char *str = load_string(stream);
</a><a href="#h8-9-102" id="h8-9-102" class="i">+    sf-&gt;path = str;
</a><a href="#h8-9-103" id="h8-9-103" class="i">+    delete[] str;
</a><a href="#h8-9-104" id="h8-9-104" class="i">+    sf-&gt;ref = refs_[load_int32(stream)];
</a><a href="#h8-9-105" id="h8-9-105" class="i">+    stream.read(reinterpret_cast&lt;char*&gt;(&amp;sf-&gt;oid), sizeof(sf-&gt;oid));
</a><a href="#h8-9-106" id="h8-9-106" class="i">+    sf-&gt;no = files_.size();
</a><a href="#h8-9-107" id="h8-9-107" class="i">+    return sf;
</a><a href="#h8-9-108" id="h8-9-108" class="i">+}
</a><a href="#h8-9-109" id="h8-9-109" class="i">+
</a><a href="#h8-9-110" id="h8-9-110" class="i">+void code_searcher::load_chunk_file(istream&amp; stream, chunk_file *cf) {
</a><a href="#h8-9-111" id="h8-9-111" class="i">+    cf-&gt;file = files_[load_int32(stream)];
</a><a href="#h8-9-112" id="h8-9-112" class="i">+    cf-&gt;left = load_int32(stream);
</a><a href="#h8-9-113" id="h8-9-113" class="i">+    cf-&gt;right = load_int32(stream);
</a><a href="#h8-9-114" id="h8-9-114" class="i">+}
</a><a href="#h8-9-115" id="h8-9-115" class="i">+
</a><a href="#h8-9-116" id="h8-9-116" class="i">+void code_searcher::load_chunk(istream&amp; stream, chunk *chunk) {
</a><a href="#h8-9-117" id="h8-9-117" class="i">+    chunk_header hdr;
</a><a href="#h8-9-118" id="h8-9-118" class="i">+    stream.read(reinterpret_cast&lt;char*&gt;(&amp;hdr), sizeof hdr);
</a><a href="#h8-9-119" id="h8-9-119" class="i">+    assert(hdr.size &lt;= kChunkSpace);
</a><a href="#h8-9-120" id="h8-9-120" class="i">+    chunk-&gt;size = hdr.size;
</a><a href="#h8-9-121" id="h8-9-121" class="i">+    for (int i = 0; i &lt; hdr.nfiles; i++) {
</a><a href="#h8-9-122" id="h8-9-122" class="i">+        chunk-&gt;files.push_back(chunk_file());
</a><a href="#h8-9-123" id="h8-9-123" class="i">+        load_chunk_file(stream, &amp;chunk-&gt;files.back());
</a><a href="#h8-9-124" id="h8-9-124" class="i">+    }
</a><a href="#h8-9-125" id="h8-9-125" class="i">+    stream.read(chunk-&gt;data, chunk-&gt;size);
</a><a href="#h8-9-126" id="h8-9-126" class="i">+    chunk-&gt;suffixes = new uint32_t[chunk-&gt;size];
</a><a href="#h8-9-127" id="h8-9-127" class="i">+    stream.read(reinterpret_cast&lt;char*&gt;(chunk-&gt;suffixes),
</a><a href="#h8-9-128" id="h8-9-128" class="i">+                sizeof(uint32_t) * chunk-&gt;size);
</a><a href="#h8-9-129" id="h8-9-129" class="i">+}
</a><a href="#h8-9-130" id="h8-9-130" class="i">+
</a><a href="#h8-9-131" id="h8-9-131" class="i">+void code_searcher::load_index(const string&amp; path) {
</a><a href="#h8-9-132" id="h8-9-132" class="i">+    assert(!finalized_);
</a><a href="#h8-9-133" id="h8-9-133" class="i">+    assert(!refs_.size());
</a><a href="#h8-9-134" id="h8-9-134" class="i">+
</a><a href="#h8-9-135" id="h8-9-135" class="i">+    ifstream stream(path.c_str());
</a><a href="#h8-9-136" id="h8-9-136" class="i">+    index_header hdr;
</a><a href="#h8-9-137" id="h8-9-137" class="i">+    stream.read(reinterpret_cast&lt;char*&gt;(&amp;hdr), sizeof hdr);
</a><a href="#h8-9-138" id="h8-9-138" class="i">+    assert(!stream.fail());
</a><a href="#h8-9-139" id="h8-9-139" class="i">+    assert(hdr.magic == kIndexMagic);
</a><a href="#h8-9-140" id="h8-9-140" class="i">+    assert(hdr.version == kIndexVersion);
</a><a href="#h8-9-141" id="h8-9-141" class="i">+    assert(hdr.chunk_size == kChunkSize);
</a><a href="#h8-9-142" id="h8-9-142" class="i">+
</a><a href="#h8-9-143" id="h8-9-143" class="i">+    for (int i = 0; i &lt; hdr.nrefs; i++) {
</a><a href="#h8-9-144" id="h8-9-144" class="i">+        refs_.push_back(load_string(stream));
</a><a href="#h8-9-145" id="h8-9-145" class="i">+    }
</a><a href="#h8-9-146" id="h8-9-146" class="i">+
</a><a href="#h8-9-147" id="h8-9-147" class="i">+    for (int i = 0; i &lt; hdr.nfiles; i++) {
</a><a href="#h8-9-148" id="h8-9-148" class="i">+        files_.push_back(load_file(stream));
</a><a href="#h8-9-149" id="h8-9-149" class="i">+    }
</a><a href="#h8-9-150" id="h8-9-150" class="i">+
</a><a href="#h8-9-151" id="h8-9-151" class="i">+    for (int i = 0; i &lt; hdr.nchunks; i++) {
</a><a href="#h8-9-152" id="h8-9-152" class="i">+        load_chunk(stream, alloc_-&gt;current_chunk());
</a><a href="#h8-9-153" id="h8-9-153" class="i">+        if (i != hdr.nchunks - 1)
</a><a href="#h8-9-154" id="h8-9-154" class="i">+            alloc_-&gt;skip_chunk();
</a><a href="#h8-9-155" id="h8-9-155" class="i">+    }
</a><a href="#h8-9-156" id="h8-9-156" class="i">+
</a><a href="#h8-9-157" id="h8-9-157" class="i">+    finalized_ = true;
</a><a href="#h8-9-158" id="h8-9-158" class="i">+}
</a><a href="#h8-9-159" id="h8-9-159" class="i">+
</a><a href="#h8-9-160" id="h8-9-160" class="i">+int code_searcher::match(RE2&amp; pat, match_stats *stats) {
</a>     list&lt;chunk*&gt;::iterator it;
     match_result *m;
     int matches = 0;
<a href="#h8-9-164" id="h8-9-164" class="d">-    int threads = 4;
</a><a href="#h8-9-165" id="h8-9-165" class="i">+    int threads = FLAGS_threads;
</a><a href="#h8-9-166" id="h8-9-166" class="i">+
</a><a href="#h8-9-167" id="h8-9-167" class="i">+    assert(finalized_);
</a> 
     thread_queue&lt;match_result*&gt; results;
     searcher search(this, results, pat);
<a href="#h8-10" id="h8-10" class="h">@@ -389,9 +435,17 @@ int code_searcher::match(RE2&amp; pat) {
</a>         print_match(m);
         delete m;
     }
<a href="#h8-10-3" id="h8-10-3" class="i">+
</a><a href="#h8-10-4" id="h8-10-4" class="i">+    search.get_stats(stats);
</a>     return matches;
 }
 
<a href="#h8-10-8" id="h8-10-8" class="i">+void code_searcher::finalize() {
</a><a href="#h8-10-9" id="h8-10-9" class="i">+    assert(!finalized_);
</a><a href="#h8-10-10" id="h8-10-10" class="i">+    finalized_ = true;
</a><a href="#h8-10-11" id="h8-10-11" class="i">+    alloc_-&gt;finalize();
</a><a href="#h8-10-12" id="h8-10-12" class="i">+}
</a><a href="#h8-10-13" id="h8-10-13" class="i">+
</a> void code_searcher::print_match(const match_result *m) {
     if (output_json_)
         print_match_json(m);
<a href="#h8-11" id="h8-11" class="h">@@ -453,12 +507,18 @@ void code_searcher::update_stats(const char *ref, const string&amp; path, git_blob *
</a>     const char *p = static_cast&lt;const char*&gt;(git_blob_rawcontent(blob));
     const char *end = p + len;
     const char *f;
<a href="#h8-11-3" id="h8-11-3" class="i">+    chunk *c;
</a><a href="#h8-11-4" id="h8-11-4" class="i">+    StringPiece line;
</a><a href="#h8-11-5" id="h8-11-5" class="i">+
</a><a href="#h8-11-6" id="h8-11-6" class="i">+    if (memchr(p, 0, len) != NULL)
</a><a href="#h8-11-7" id="h8-11-7" class="i">+        return;
</a><a href="#h8-11-8" id="h8-11-8" class="i">+
</a>     search_file *sf = new search_file;
     sf-&gt;path = path;
     sf-&gt;ref = ref;
     git_oid_cpy(&amp;sf-&gt;oid, git_object_id(reinterpret_cast&lt;git_object*&gt;(blob)));
<a href="#h8-11-13" id="h8-11-13" class="d">-    chunk *c;
</a><a href="#h8-11-14" id="h8-11-14" class="d">-    StringPiece line;
</a><a href="#h8-11-15" id="h8-11-15" class="i">+    sf-&gt;no  = files_.size();
</a><a href="#h8-11-16" id="h8-11-16" class="i">+    files_.push_back(sf);
</a> 
     while ((f = static_cast&lt;const char*&gt;(memchr(p, &#39;\n&#39;, end - p))) != 0) {
         string_hash::iterator it = lines_.find(StringPiece(p, f - p));
<a href="#h8-12" id="h8-12" class="h">@@ -508,6 +568,112 @@ void code_searcher::resolve_ref(smart_object&lt;git_commit&gt;&amp; out, const char *refna
</a>     }
 }
 
<a href="#h8-12-3" id="h8-12-3" class="i">+bool searcher::operator()(const thread_state&amp; ts, const chunk *chunk)
</a><a href="#h8-12-4" id="h8-12-4" class="i">+{
</a><a href="#h8-12-5" id="h8-12-5" class="i">+    if (chunk == NULL) {
</a><a href="#h8-12-6" id="h8-12-6" class="i">+        queue_.push(NULL);
</a><a href="#h8-12-7" id="h8-12-7" class="i">+        return true;
</a><a href="#h8-12-8" id="h8-12-8" class="i">+    }
</a><a href="#h8-12-9" id="h8-12-9" class="i">+
</a><a href="#h8-12-10" id="h8-12-10" class="i">+    if (FLAGS_index &amp;&amp; filter_.size() &gt; 0 &amp;&amp; filter_.size() &lt; kMaxFilters)
</a><a href="#h8-12-11" id="h8-12-11" class="i">+        filtered_search(ts, chunk);
</a><a href="#h8-12-12" id="h8-12-12" class="i">+    else
</a><a href="#h8-12-13" id="h8-12-13" class="i">+        full_search(ts, chunk);
</a><a href="#h8-12-14" id="h8-12-14" class="i">+
</a><a href="#h8-12-15" id="h8-12-15" class="i">+    if (matches_.load() &gt;= kMaxMatches) {
</a><a href="#h8-12-16" id="h8-12-16" class="i">+        queue_.push(NULL);
</a><a href="#h8-12-17" id="h8-12-17" class="i">+        return true;
</a><a href="#h8-12-18" id="h8-12-18" class="i">+    }
</a><a href="#h8-12-19" id="h8-12-19" class="i">+    return false;
</a><a href="#h8-12-20" id="h8-12-20" class="i">+}
</a><a href="#h8-12-21" id="h8-12-21" class="i">+
</a><a href="#h8-12-22" id="h8-12-22" class="i">+void searcher::filtered_search(const thread_state&amp; ts, const chunk *chunk)
</a><a href="#h8-12-23" id="h8-12-23" class="i">+{
</a><a href="#h8-12-24" id="h8-12-24" class="i">+    log_profile(&quot;Attempting filtered search with %d filters\n&quot;, int(filter_.size()));
</a><a href="#h8-12-25" id="h8-12-25" class="i">+    chunk::lt_suffix lt(chunk);
</a><a href="#h8-12-26" id="h8-12-26" class="i">+
</a><a href="#h8-12-27" id="h8-12-27" class="i">+    pair&lt;uint32_t*, uint32_t*&gt; ranges[kMaxFilters];
</a><a href="#h8-12-28" id="h8-12-28" class="i">+    uint32_t *indexes;
</a><a href="#h8-12-29" id="h8-12-29" class="i">+    int count = 0, off = 0;
</a><a href="#h8-12-30" id="h8-12-30" class="i">+
</a><a href="#h8-12-31" id="h8-12-31" class="i">+    for (int i = 0; i &lt; filter_.size(); i++) {
</a><a href="#h8-12-32" id="h8-12-32" class="i">+        ranges[i] = equal_range(chunk-&gt;suffixes,
</a><a href="#h8-12-33" id="h8-12-33" class="i">+                                chunk-&gt;suffixes + chunk-&gt;size,
</a><a href="#h8-12-34" id="h8-12-34" class="i">+                                filter_[i], lt);
</a><a href="#h8-12-35" id="h8-12-35" class="i">+        count += ranges[i].second - ranges[i].first;
</a><a href="#h8-12-36" id="h8-12-36" class="i">+    }
</a><a href="#h8-12-37" id="h8-12-37" class="i">+    indexes = new uint32_t[count];
</a><a href="#h8-12-38" id="h8-12-38" class="i">+    for (int i = 0; i &lt; filter_.size(); i++) {
</a><a href="#h8-12-39" id="h8-12-39" class="i">+        int width = ranges[i].second - ranges[i].first;
</a><a href="#h8-12-40" id="h8-12-40" class="i">+        memcpy(&amp;indexes[off], ranges[i].first, width * sizeof(uint32_t));
</a><a href="#h8-12-41" id="h8-12-41" class="i">+        off += width;
</a><a href="#h8-12-42" id="h8-12-42" class="i">+    }
</a><a href="#h8-12-43" id="h8-12-43" class="i">+
</a><a href="#h8-12-44" id="h8-12-44" class="i">+    search_lines(indexes, count, ts, chunk);
</a><a href="#h8-12-45" id="h8-12-45" class="i">+    delete[] indexes;
</a><a href="#h8-12-46" id="h8-12-46" class="i">+}
</a><a href="#h8-12-47" id="h8-12-47" class="i">+
</a><a href="#h8-12-48" id="h8-12-48" class="i">+const size_t kMinSkip = 250;
</a><a href="#h8-12-49" id="h8-12-49" class="i">+
</a><a href="#h8-12-50" id="h8-12-50" class="i">+void searcher::search_lines(uint32_t *indexes, int count,
</a><a href="#h8-12-51" id="h8-12-51" class="i">+                            const thread_state&amp; ts,
</a><a href="#h8-12-52" id="h8-12-52" class="i">+                            const chunk *chunk)
</a><a href="#h8-12-53" id="h8-12-53" class="i">+{
</a><a href="#h8-12-54" id="h8-12-54" class="i">+    lsd_radix_sort(indexes, indexes + count);
</a><a href="#h8-12-55" id="h8-12-55" class="i">+
</a><a href="#h8-12-56" id="h8-12-56" class="i">+    if (count == 0)
</a><a href="#h8-12-57" id="h8-12-57" class="i">+        return;
</a><a href="#h8-12-58" id="h8-12-58" class="i">+
</a><a href="#h8-12-59" id="h8-12-59" class="i">+    StringPiece search(chunk-&gt;data, chunk-&gt;size);
</a><a href="#h8-12-60" id="h8-12-60" class="i">+    uint32_t max = indexes[0];
</a><a href="#h8-12-61" id="h8-12-61" class="i">+    uint32_t min = line_start(chunk, indexes[0]);
</a><a href="#h8-12-62" id="h8-12-62" class="i">+    for (int i = 0; i &lt;= count; i++) {
</a><a href="#h8-12-63" id="h8-12-63" class="i">+        if (i != count) {
</a><a href="#h8-12-64" id="h8-12-64" class="i">+            if (indexes[i] &lt; max) continue;
</a><a href="#h8-12-65" id="h8-12-65" class="i">+            if (indexes[i] &lt; max + kMinSkip) {
</a><a href="#h8-12-66" id="h8-12-66" class="i">+                max = indexes[i];
</a><a href="#h8-12-67" id="h8-12-67" class="i">+                continue;
</a><a href="#h8-12-68" id="h8-12-68" class="i">+            }
</a><a href="#h8-12-69" id="h8-12-69" class="i">+        }
</a><a href="#h8-12-70" id="h8-12-70" class="i">+
</a><a href="#h8-12-71" id="h8-12-71" class="i">+        int end = line_end(chunk, max);
</a><a href="#h8-12-72" id="h8-12-72" class="i">+        full_search(ts, chunk, min, end);
</a><a href="#h8-12-73" id="h8-12-73" class="i">+
</a><a href="#h8-12-74" id="h8-12-74" class="i">+        if (i != count) {
</a><a href="#h8-12-75" id="h8-12-75" class="i">+            max = indexes[i];
</a><a href="#h8-12-76" id="h8-12-76" class="i">+            min = line_start(chunk, max);
</a><a href="#h8-12-77" id="h8-12-77" class="i">+        }
</a><a href="#h8-12-78" id="h8-12-78" class="i">+    }
</a><a href="#h8-12-79" id="h8-12-79" class="i">+}
</a><a href="#h8-12-80" id="h8-12-80" class="i">+
</a><a href="#h8-12-81" id="h8-12-81" class="i">+void searcher::full_search(const thread_state&amp; ts, const chunk *chunk)
</a><a href="#h8-12-82" id="h8-12-82" class="i">+{
</a><a href="#h8-12-83" id="h8-12-83" class="i">+    full_search(ts, chunk, 0, chunk-&gt;size - 1);
</a><a href="#h8-12-84" id="h8-12-84" class="i">+}
</a><a href="#h8-12-85" id="h8-12-85" class="i">+
</a><a href="#h8-12-86" id="h8-12-86" class="i">+void searcher::full_search(const thread_state&amp; ts, const chunk *chunk,
</a><a href="#h8-12-87" id="h8-12-87" class="i">+                           size_t minpos, size_t maxpos)
</a><a href="#h8-12-88" id="h8-12-88" class="i">+{
</a><a href="#h8-12-89" id="h8-12-89" class="i">+    StringPiece str(chunk-&gt;data, chunk-&gt;size);
</a><a href="#h8-12-90" id="h8-12-90" class="i">+    StringPiece match;
</a><a href="#h8-12-91" id="h8-12-91" class="i">+    int pos = minpos, new_pos;
</a><a href="#h8-12-92" id="h8-12-92" class="i">+    while (pos &lt; maxpos &amp;&amp; matches_.load() &lt; kMaxMatches) {
</a><a href="#h8-12-93" id="h8-12-93" class="i">+        {
</a><a href="#h8-12-94" id="h8-12-94" class="i">+            run_timer run(re2_time_);
</a><a href="#h8-12-95" id="h8-12-95" class="i">+            if (!pat_.Match(str, pos, maxpos, RE2::UNANCHORED, &amp;match, 1))
</a><a href="#h8-12-96" id="h8-12-96" class="i">+                break;
</a><a href="#h8-12-97" id="h8-12-97" class="i">+        }
</a><a href="#h8-12-98" id="h8-12-98" class="i">+        assert(memchr(match.data(), &#39;\n&#39;, match.size()) == NULL);
</a><a href="#h8-12-99" id="h8-12-99" class="i">+        StringPiece line = find_line(str, match);
</a><a href="#h8-12-100" id="h8-12-100" class="i">+        if (utf8::is_valid(line.data(), line.data() + line.size()))
</a><a href="#h8-12-101" id="h8-12-101" class="i">+            find_match(chunk, match, line, ts);
</a><a href="#h8-12-102" id="h8-12-102" class="i">+        new_pos = line.size() + line.data() - str.data() + 1;
</a><a href="#h8-12-103" id="h8-12-103" class="i">+        assert(new_pos &gt; pos);
</a><a href="#h8-12-104" id="h8-12-104" class="i">+        pos = new_pos;
</a><a href="#h8-12-105" id="h8-12-105" class="i">+    }
</a><a href="#h8-12-106" id="h8-12-106" class="i">+}
</a><a href="#h8-12-107" id="h8-12-107" class="i">+
</a><a href="#h8-12-108" id="h8-12-108" class="i">+
</a> match_result *searcher::try_match(const StringPiece&amp; line,
                                   const StringPiece&amp; match,
                                   search_file *sf,
<a href="#h8-13" id="h8-13" class="h">@@ -518,6 +684,7 @@ match_result *searcher::try_match(const StringPiece&amp; line,
</a>                        git_blob_rawsize(blob));
     StringPiece matchline;
     RE2 pat(&quot;^&quot; + RE2::QuoteMeta(line) + &quot;$&quot;, pat_.options());
<a href="#h8-13-3" id="h8-13-3" class="i">+    assert(pat.ok());
</a>     if (!pat.Match(search, 0, search.size(), RE2::UNANCHORED, &amp;matchline, 1))
         return 0;
     match_result *m = new match_result;
<b>diff --git a/<a id="h9" href="../file/codesearch.h">codesearch.h</a> b/<a href="../file/codesearch.h">codesearch.h</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -3,6 +3,7 @@
</a> 
 #include &lt;vector&gt;
 #include &lt;string&gt;
<a href="#h9-0-3" id="h9-0-3" class="i">+#include &lt;fstream&gt;
</a> 
 #ifdef USE_DENSE_HASH_SET
 #include &lt;google/dense_hash_set&gt;
<a href="#h9-1" id="h9-1" class="h">@@ -49,15 +50,27 @@ typedef google::dense_hash_set&lt;StringPiece, hashstr, eqstr&gt; string_hash;
</a> typedef google::sparse_hash_set&lt;StringPiece, hashstr, eqstr&gt; string_hash;
 #endif
 
<a href="#h9-1-3" id="h9-1-3" class="i">+struct match_stats {
</a><a href="#h9-1-4" id="h9-1-4" class="i">+    timeval re2_time;
</a><a href="#h9-1-5" id="h9-1-5" class="i">+    timeval git_time;
</a><a href="#h9-1-6" id="h9-1-6" class="i">+};
</a><a href="#h9-1-7" id="h9-1-7" class="i">+
</a><a href="#h9-1-8" id="h9-1-8" class="i">+struct search_file;
</a><a href="#h9-1-9" id="h9-1-9" class="i">+struct chunk;
</a><a href="#h9-1-10" id="h9-1-10" class="i">+struct chunk_file;
</a><a href="#h9-1-11" id="h9-1-11" class="i">+
</a> class code_searcher {
 public:
     code_searcher(git_repository *repo);
     ~code_searcher();
     void walk_ref(const char *ref);
     void dump_stats();
<a href="#h9-1-18" id="h9-1-18" class="d">-    int match(RE2&amp; pat);
</a><a href="#h9-1-19" id="h9-1-19" class="i">+    void dump_index(const string&amp; path);
</a><a href="#h9-1-20" id="h9-1-20" class="i">+    void load_index(const string&amp; path);
</a><a href="#h9-1-21" id="h9-1-21" class="i">+    int match(RE2&amp; pat, match_stats *stats);
</a> 
     void set_output_json(bool j) { output_json_ = j; }
<a href="#h9-1-24" id="h9-1-24" class="i">+    void finalize();
</a> protected:
     void print_match(const match_result *m);
     void print_match_json(const match_result *m);
<a href="#h9-2" id="h9-2" class="h">@@ -65,6 +78,13 @@ protected:
</a>     void update_stats(const char *ref, const string&amp; path, git_blob *blob);
     void resolve_ref(smart_object&lt;git_commit&gt; &amp;out, const char *refname);
 
<a href="#h9-2-3" id="h9-2-3" class="i">+    void dump_file(std::ostream&amp; stream, search_file *sf);
</a><a href="#h9-2-4" id="h9-2-4" class="i">+    void dump_chunk(std::ostream&amp; stream, chunk *);
</a><a href="#h9-2-5" id="h9-2-5" class="i">+
</a><a href="#h9-2-6" id="h9-2-6" class="i">+    search_file *load_file(std::istream&amp; stream);
</a><a href="#h9-2-7" id="h9-2-7" class="i">+    void load_chunk_file(std::istream&amp; stream, chunk_file *);
</a><a href="#h9-2-8" id="h9-2-8" class="i">+    void load_chunk(std::istream&amp; stream, chunk *);
</a><a href="#h9-2-9" id="h9-2-9" class="i">+
</a>     git_repository *repo_;
     string_hash lines_;
     struct {
<a href="#h9-3" id="h9-3" class="h">@@ -73,6 +93,9 @@ protected:
</a>     } stats_;
     chunk_allocator *alloc_;
     bool output_json_;
<a href="#h9-3-3" id="h9-3-3" class="i">+    bool finalized_;
</a><a href="#h9-3-4" id="h9-3-4" class="i">+    std::vector&lt;const char*&gt;  refs_;
</a><a href="#h9-3-5" id="h9-3-5" class="i">+    std::vector&lt;search_file*&gt; files_;
</a> 
     friend class searcher;
 };
<b>diff --git a/<a id="h10" href="../file/main.cc">main.cc</a> b/<a href="../file/main.cc">main.cc</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -5,31 +5,69 @@
</a> #include &lt;stdio.h&gt;
 #include &lt;iostream&gt;
 
<a href="#h10-0-3" id="h10-0-3" class="d">-bool FLAG_machine_interface = true;
</a><a href="#h10-0-4" id="h10-0-4" class="i">+#include &lt;gflags/gflags.h&gt;
</a><a href="#h10-0-5" id="h10-0-5" class="i">+
</a><a href="#h10-0-6" id="h10-0-6" class="i">+#include &lt;json/json.h&gt;
</a><a href="#h10-0-7" id="h10-0-7" class="i">+
</a><a href="#h10-0-8" id="h10-0-8" class="i">+#include &lt;re2/regexp.h&gt;
</a><a href="#h10-0-9" id="h10-0-9" class="i">+
</a><a href="#h10-0-10" id="h10-0-10" class="i">+DEFINE_bool(json, false, &quot;Use JSON output.&quot;);
</a><a href="#h10-0-11" id="h10-0-11" class="i">+DEFINE_int32(threads, 4, &quot;Number of threads to use.&quot;);
</a><a href="#h10-0-12" id="h10-0-12" class="i">+DEFINE_string(dump_index, &quot;&quot;, &quot;Dump the produced index to a specified file&quot;);
</a><a href="#h10-0-13" id="h10-0-13" class="i">+DEFINE_string(load_index, &quot;&quot;, &quot;Load the index from a file instead of walking the repository&quot;);
</a><a href="#h10-0-14" id="h10-0-14" class="i">+DEFINE_string(git_dir, &quot;.git&quot;, &quot;The git directory to read from&quot;);
</a> 
 using namespace std;
 
<a href="#h10-0-18" id="h10-0-18" class="i">+long timeval_ms (struct timeval tv) {
</a><a href="#h10-0-19" id="h10-0-19" class="i">+    return tv.tv_sec * 1000 + tv.tv_usec / 1000;
</a><a href="#h10-0-20" id="h10-0-20" class="i">+}
</a><a href="#h10-0-21" id="h10-0-21" class="i">+
</a><a href="#h10-0-22" id="h10-0-22" class="i">+void print_stats(const match_stats &amp;stats) {
</a><a href="#h10-0-23" id="h10-0-23" class="i">+    json_object *obj = json_object_new_object();
</a><a href="#h10-0-24" id="h10-0-24" class="i">+    json_object_object_add(obj, &quot;re2_time&quot;, json_object_new_int
</a><a href="#h10-0-25" id="h10-0-25" class="i">+                           (timeval_ms(stats.re2_time)));
</a><a href="#h10-0-26" id="h10-0-26" class="i">+    json_object_object_add(obj, &quot;git_time&quot;, json_object_new_int
</a><a href="#h10-0-27" id="h10-0-27" class="i">+                           (timeval_ms(stats.git_time)));
</a><a href="#h10-0-28" id="h10-0-28" class="i">+    printf(&quot;DONE %s\n&quot;, json_object_to_json_string(obj));
</a><a href="#h10-0-29" id="h10-0-29" class="i">+    json_object_put(obj);
</a><a href="#h10-0-30" id="h10-0-30" class="i">+}
</a><a href="#h10-0-31" id="h10-0-31" class="i">+
</a> int main(int argc, char **argv) {
<a href="#h10-0-33" id="h10-0-33" class="i">+    google::SetUsageMessage(&quot;Usage: &quot; + string(argv[0]) + &quot; &lt;options&gt; REFS&quot;);
</a><a href="#h10-0-34" id="h10-0-34" class="i">+    google::ParseCommandLineFlags(&amp;argc, &amp;argv, true);
</a><a href="#h10-0-35" id="h10-0-35" class="i">+
</a>     git_repository *repo;
<a href="#h10-0-37" id="h10-0-37" class="d">-    git_repository_open(&amp;repo, &quot;.git&quot;);
</a><a href="#h10-0-38" id="h10-0-38" class="i">+    git_repository_open(&amp;repo, FLAGS_git_dir.c_str());
</a> 
     code_searcher counter(repo);
<a href="#h10-0-41" id="h10-0-41" class="d">-    counter.set_output_json(FLAG_machine_interface);
</a><a href="#h10-0-42" id="h10-0-42" class="i">+    counter.set_output_json(FLAGS_json);
</a> 
<a href="#h10-0-44" id="h10-0-44" class="d">-    for (int i = 1; i &lt; argc; i++) {
</a><a href="#h10-0-45" id="h10-0-45" class="i">+    if (FLAGS_load_index.size() == 0) {
</a>         timer tm;
         struct timeval elapsed;
<a href="#h10-0-48" id="h10-0-48" class="d">-        if (!FLAG_machine_interface)
</a><a href="#h10-0-49" id="h10-0-49" class="d">-            printf(&quot;Walking %s...&quot;, argv[i]);
</a><a href="#h10-0-50" id="h10-0-50" class="d">-        fflush(stdout);
</a><a href="#h10-0-51" id="h10-0-51" class="d">-        counter.walk_ref(argv[i]);
</a><a href="#h10-0-52" id="h10-0-52" class="i">+
</a><a href="#h10-0-53" id="h10-0-53" class="i">+        for (int i = 1; i &lt; argc; i++) {
</a><a href="#h10-0-54" id="h10-0-54" class="i">+            if (!FLAGS_json)
</a><a href="#h10-0-55" id="h10-0-55" class="i">+                printf(&quot;Walking %s...&quot;, argv[i]);
</a><a href="#h10-0-56" id="h10-0-56" class="i">+            fflush(stdout);
</a><a href="#h10-0-57" id="h10-0-57" class="i">+            counter.walk_ref(argv[i]);
</a><a href="#h10-0-58" id="h10-0-58" class="i">+            elapsed = tm.elapsed();
</a><a href="#h10-0-59" id="h10-0-59" class="i">+            if (!FLAGS_json)
</a><a href="#h10-0-60" id="h10-0-60" class="i">+                printf(&quot; done.\n&quot;);
</a><a href="#h10-0-61" id="h10-0-61" class="i">+        }
</a><a href="#h10-0-62" id="h10-0-62" class="i">+        counter.finalize();
</a>         elapsed = tm.elapsed();
<a href="#h10-0-64" id="h10-0-64" class="d">-        if (!FLAG_machine_interface)
</a><a href="#h10-0-65" id="h10-0-65" class="d">-            printf(&quot; done in %d.%06ds\n&quot;,
</a><a href="#h10-0-66" id="h10-0-66" class="i">+        if (!FLAGS_json)
</a><a href="#h10-0-67" id="h10-0-67" class="i">+            printf(&quot;repository indexed in %d.%06ds\n&quot;,
</a>                    (int)elapsed.tv_sec, (int)elapsed.tv_usec);
<a href="#h10-0-69" id="h10-0-69" class="i">+    } else {
</a><a href="#h10-0-70" id="h10-0-70" class="i">+        counter.load_index(FLAGS_load_index);
</a>     }
<a href="#h10-0-72" id="h10-0-72" class="d">-    if (!FLAG_machine_interface)
</a><a href="#h10-0-73" id="h10-0-73" class="i">+    if (!FLAGS_json &amp;&amp; !FLAGS_load_index.size())
</a>         counter.dump_stats();
<a href="#h10-0-75" id="h10-0-75" class="i">+    if (FLAGS_dump_index.size())
</a><a href="#h10-0-76" id="h10-0-76" class="i">+        counter.dump_index(FLAGS_dump_index);
</a>     RE2::Options opts;
     opts.set_never_nl(true);
     opts.set_one_line(false);
<a href="#h10-1" id="h10-1" class="h">@@ -38,7 +76,7 @@ int main(int argc, char **argv) {
</a>     opts.set_word_boundary(true);
     opts.set_log_errors(false);
     while (true) {
<a href="#h10-1-3" id="h10-1-3" class="d">-        if (FLAG_machine_interface)
</a><a href="#h10-1-4" id="h10-1-4" class="i">+        if (FLAGS_json)
</a>             printf(&quot;READY\n&quot;);
         else
             printf(&quot;regex&gt; &quot;);
<a href="#h10-2" id="h10-2" class="h">@@ -48,7 +86,7 @@ int main(int argc, char **argv) {
</a>             break;
         RE2 re(line, opts);
         if (!re.ok()) {
<a href="#h10-2-3" id="h10-2-3" class="d">-            if (!FLAG_machine_interface)
</a><a href="#h10-2-4" id="h10-2-4" class="i">+            if (!FLAGS_json)
</a>                 printf(&quot;Error: %s\n&quot;, re.error().c_str());
             else
                 printf(&quot;FATAL %s\n&quot;, re.error().c_str());
<a href="#h10-3" id="h10-3" class="h">@@ -56,10 +94,11 @@ int main(int argc, char **argv) {
</a>         if (re.ok()) {
             timer tm;
             struct timeval elapsed;
<a href="#h10-3-3" id="h10-3-3" class="d">-            counter.match(re);
</a><a href="#h10-3-4" id="h10-3-4" class="i">+            match_stats stats;
</a><a href="#h10-3-5" id="h10-3-5" class="i">+            counter.match(re, &amp;stats);
</a>             elapsed = tm.elapsed();
<a href="#h10-3-7" id="h10-3-7" class="d">-            if (FLAG_machine_interface)
</a><a href="#h10-3-8" id="h10-3-8" class="d">-                printf(&quot;DONE\n&quot;);
</a><a href="#h10-3-9" id="h10-3-9" class="i">+            if (FLAGS_json)
</a><a href="#h10-3-10" id="h10-3-10" class="i">+                print_stats(stats);
</a>             else
                 printf(&quot;Match completed in %d.%06ds.\n&quot;,
                        (int)elapsed.tv_sec, (int)elapsed.tv_usec);
<b>diff --git a/<a id="h11" href="../file/radix_sort.cc">radix_sort.cc</a> b/<a href="../file/radix_sort.cc">radix_sort.cc</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -0,0 +1,42 @@
</a><a href="#h11-0-0" id="h11-0-0" class="i">+#include &lt;stdint.h&gt;
</a><a href="#h11-0-1" id="h11-0-1" class="i">+#include &lt;string.h&gt;
</a><a href="#h11-0-2" id="h11-0-2" class="i">+
</a><a href="#h11-0-3" id="h11-0-3" class="i">+void lsd_radix_sort(uint32_t *left, uint32_t *right)
</a><a href="#h11-0-4" id="h11-0-4" class="i">+{
</a><a href="#h11-0-5" id="h11-0-5" class="i">+    int width = right - left;
</a><a href="#h11-0-6" id="h11-0-6" class="i">+    uint32_t *scratch = new uint32_t[width];
</a><a href="#h11-0-7" id="h11-0-7" class="i">+    uint32_t *cur = left, *other = scratch;
</a><a href="#h11-0-8" id="h11-0-8" class="i">+    uint32_t counts[256];
</a><a href="#h11-0-9" id="h11-0-9" class="i">+    /*
</a><a href="#h11-0-10" id="h11-0-10" class="i">+     * We do four passes
</a><a href="#h11-0-11" id="h11-0-11" class="i">+     * (0) input -&gt; scratch
</a><a href="#h11-0-12" id="h11-0-12" class="i">+     * (1) scratch -&gt; input
</a><a href="#h11-0-13" id="h11-0-13" class="i">+     * (2) input -&gt; scratch
</a><a href="#h11-0-14" id="h11-0-14" class="i">+     * (3) scratch -&gt; input
</a><a href="#h11-0-15" id="h11-0-15" class="i">+     *
</a><a href="#h11-0-16" id="h11-0-16" class="i">+     * So after the fourth pass, the input array is sorted and back in
</a><a href="#h11-0-17" id="h11-0-17" class="i">+     * the original storage.
</a><a href="#h11-0-18" id="h11-0-18" class="i">+     */
</a><a href="#h11-0-19" id="h11-0-19" class="i">+
</a><a href="#h11-0-20" id="h11-0-20" class="i">+    for (int digit = 0; digit &lt; 4; digit++) {
</a><a href="#h11-0-21" id="h11-0-21" class="i">+        memset(counts, 0, sizeof counts);
</a><a href="#h11-0-22" id="h11-0-22" class="i">+        for (int i = 0; i &lt; width; i++) {
</a><a href="#h11-0-23" id="h11-0-23" class="i">+            counts[(cur[i] &gt;&gt; (8 * digit)) &amp; 0xFF]++;
</a><a href="#h11-0-24" id="h11-0-24" class="i">+        }
</a><a href="#h11-0-25" id="h11-0-25" class="i">+        int total = 0;
</a><a href="#h11-0-26" id="h11-0-26" class="i">+        for (int i = 0; i &lt; 256; i++) {
</a><a href="#h11-0-27" id="h11-0-27" class="i">+            int tmp = counts[i];
</a><a href="#h11-0-28" id="h11-0-28" class="i">+            counts[i] = total;
</a><a href="#h11-0-29" id="h11-0-29" class="i">+            total += tmp;
</a><a href="#h11-0-30" id="h11-0-30" class="i">+        }
</a><a href="#h11-0-31" id="h11-0-31" class="i">+        for (int i = 0; i &lt; width; i++) {
</a><a href="#h11-0-32" id="h11-0-32" class="i">+            int d = (cur[i] &gt;&gt; (8 * digit)) &amp; 0xFF;
</a><a href="#h11-0-33" id="h11-0-33" class="i">+            other[counts[d]++] = cur[i];
</a><a href="#h11-0-34" id="h11-0-34" class="i">+        }
</a><a href="#h11-0-35" id="h11-0-35" class="i">+        uint32_t *tmp = cur;
</a><a href="#h11-0-36" id="h11-0-36" class="i">+        cur = other;
</a><a href="#h11-0-37" id="h11-0-37" class="i">+        other = tmp;
</a><a href="#h11-0-38" id="h11-0-38" class="i">+    }
</a><a href="#h11-0-39" id="h11-0-39" class="i">+
</a><a href="#h11-0-40" id="h11-0-40" class="i">+    delete[] scratch;
</a><a href="#h11-0-41" id="h11-0-41" class="i">+}
</a><b>diff --git a/<a id="h12" href="../file/radix_sort.h">radix_sort.h</a> b/<a href="../file/radix_sort.h">radix_sort.h</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -0,0 +1,48 @@
</a><a href="#h12-0-0" id="h12-0-0" class="i">+#ifndef CODESEARCH_RADIX_SORT_H
</a><a href="#h12-0-1" id="h12-0-1" class="i">+#define CODESEARCH_RADIX_SORT_H
</a><a href="#h12-0-2" id="h12-0-2" class="i">+
</a><a href="#h12-0-3" id="h12-0-3" class="i">+#include &lt;algorithm&gt;
</a><a href="#h12-0-4" id="h12-0-4" class="i">+
</a><a href="#h12-0-5" id="h12-0-5" class="i">+const size_t kRadixCutoff = 128;
</a><a href="#h12-0-6" id="h12-0-6" class="i">+
</a><a href="#h12-0-7" id="h12-0-7" class="i">+template &lt;typename Index, typename Compare&gt;
</a><a href="#h12-0-8" id="h12-0-8" class="i">+void msd_radix_sort(uint32_t *left, uint32_t *right, int level,
</a><a href="#h12-0-9" id="h12-0-9" class="i">+                    Index index, Compare cmp) {
</a><a href="#h12-0-10" id="h12-0-10" class="i">+    if (right - left &lt; kRadixCutoff) {
</a><a href="#h12-0-11" id="h12-0-11" class="i">+        std::sort(left, right, cmp);
</a><a href="#h12-0-12" id="h12-0-12" class="i">+        return;
</a><a href="#h12-0-13" id="h12-0-13" class="i">+    }
</a><a href="#h12-0-14" id="h12-0-14" class="i">+    unsigned counts[256] = {};
</a><a href="#h12-0-15" id="h12-0-15" class="i">+    unsigned dest[256];
</a><a href="#h12-0-16" id="h12-0-16" class="i">+    uint32_t *p;
</a><a href="#h12-0-17" id="h12-0-17" class="i">+    for (p = left; p != right; p++)
</a><a href="#h12-0-18" id="h12-0-18" class="i">+        counts[index(*p, level)]++;
</a><a href="#h12-0-19" id="h12-0-19" class="i">+    for (int i = 0, total = 0; i &lt; 256; i++) {
</a><a href="#h12-0-20" id="h12-0-20" class="i">+        int tmp = counts[i];
</a><a href="#h12-0-21" id="h12-0-21" class="i">+        counts[i] = total;
</a><a href="#h12-0-22" id="h12-0-22" class="i">+        total += tmp;
</a><a href="#h12-0-23" id="h12-0-23" class="i">+    }
</a><a href="#h12-0-24" id="h12-0-24" class="i">+    memcpy(dest, counts, sizeof counts);
</a><a href="#h12-0-25" id="h12-0-25" class="i">+    int this_chunk;
</a><a href="#h12-0-26" id="h12-0-26" class="i">+    for (p = left, this_chunk = 0; this_chunk &lt; 255;) {
</a><a href="#h12-0-27" id="h12-0-27" class="i">+        if (p - left == counts[this_chunk + 1]) {
</a><a href="#h12-0-28" id="h12-0-28" class="i">+            this_chunk++;
</a><a href="#h12-0-29" id="h12-0-29" class="i">+            continue;
</a><a href="#h12-0-30" id="h12-0-30" class="i">+        }
</a><a href="#h12-0-31" id="h12-0-31" class="i">+        int target = index(*p, level);
</a><a href="#h12-0-32" id="h12-0-32" class="i">+        if (target == this_chunk) {
</a><a href="#h12-0-33" id="h12-0-33" class="i">+            p++;
</a><a href="#h12-0-34" id="h12-0-34" class="i">+            continue;
</a><a href="#h12-0-35" id="h12-0-35" class="i">+        }
</a><a href="#h12-0-36" id="h12-0-36" class="i">+        assert(dest[target] &lt; (right - left));
</a><a href="#h12-0-37" id="h12-0-37" class="i">+        swap(left[dest[target]++], *p);
</a><a href="#h12-0-38" id="h12-0-38" class="i">+    }
</a><a href="#h12-0-39" id="h12-0-39" class="i">+    for (int i = 1; i &lt; 256; i++) {
</a><a href="#h12-0-40" id="h12-0-40" class="i">+        uint32_t *r = (i == 255) ? right : left + counts[i+1];
</a><a href="#h12-0-41" id="h12-0-41" class="i">+        msd_radix_sort(left + counts[i], r, level + 1, index, cmp);
</a><a href="#h12-0-42" id="h12-0-42" class="i">+    }
</a><a href="#h12-0-43" id="h12-0-43" class="i">+}
</a><a href="#h12-0-44" id="h12-0-44" class="i">+
</a><a href="#h12-0-45" id="h12-0-45" class="i">+void lsd_radix_sort(uint32_t *left, uint32_t *right);
</a><a href="#h12-0-46" id="h12-0-46" class="i">+
</a><a href="#h12-0-47" id="h12-0-47" class="i">+#endif
</a><b>diff --git a/<a id="h13" href="../file/re2">re2</a> b/<a href="../file/re2">re2</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -0,0 +1 @@
</a><a href="#h13-0-0" id="h13-0-0" class="i">+Subproject commit 69b190449c4b7dcee6a22aa2e2c590e5c3f06f7a
</a><b>diff --git a/<a id="h14" href="../file/test/test.js">test/test.js</a> b/<a href="../file/test/test.js">test/test.js</a></b>
<a href="#h14-0" id="h14-0" class="h">@@ -0,0 +1,74 @@
</a><a href="#h14-0-0" id="h14-0-0" class="i">+var Codesearch = require(&#39;../web/codesearch.js&#39;),
</a><a href="#h14-0-1" id="h14-0-1" class="i">+    fs         = require(&#39;fs&#39;),
</a><a href="#h14-0-2" id="h14-0-2" class="i">+    path       = require(&#39;path&#39;);
</a><a href="#h14-0-3" id="h14-0-3" class="i">+
</a><a href="#h14-0-4" id="h14-0-4" class="i">+var ITERATIONS = 10;
</a><a href="#h14-0-5" id="h14-0-5" class="i">+
</a><a href="#h14-0-6" id="h14-0-6" class="i">+var REPO = process.argv[2] || &#39;/home/nelhage/code/linux-2.6&#39;;
</a><a href="#h14-0-7" id="h14-0-7" class="i">+
</a><a href="#h14-0-8" id="h14-0-8" class="i">+var queries = fs.readFileSync(path.join(__dirname, &#39;testcases&#39;), &#39;utf8&#39;).split(/\n/);
</a><a href="#h14-0-9" id="h14-0-9" class="i">+
</a><a href="#h14-0-10" id="h14-0-10" class="i">+var cs = new Codesearch(REPO, [], {
</a><a href="#h14-0-11" id="h14-0-11" class="i">+                          args: process.argv.slice(3)
</a><a href="#h14-0-12" id="h14-0-12" class="i">+                        });
</a><a href="#h14-0-13" id="h14-0-13" class="i">+var times = { };
</a><a href="#h14-0-14" id="h14-0-14" class="i">+
</a><a href="#h14-0-15" id="h14-0-15" class="i">+function loop(i) {
</a><a href="#h14-0-16" id="h14-0-16" class="i">+    if (i == queries.length) {
</a><a href="#h14-0-17" id="h14-0-17" class="i">+        if (ITERATIONS == 0) {
</a><a href="#h14-0-18" id="h14-0-18" class="i">+            done();
</a><a href="#h14-0-19" id="h14-0-19" class="i">+        } else {
</a><a href="#h14-0-20" id="h14-0-20" class="i">+            ITERATIONS--;
</a><a href="#h14-0-21" id="h14-0-21" class="i">+            loop(0);
</a><a href="#h14-0-22" id="h14-0-22" class="i">+        }
</a><a href="#h14-0-23" id="h14-0-23" class="i">+        return;
</a><a href="#h14-0-24" id="h14-0-24" class="i">+    }
</a><a href="#h14-0-25" id="h14-0-25" class="i">+    var q = queries[i];
</a><a href="#h14-0-26" id="h14-0-26" class="i">+    var start = new Date();
</a><a href="#h14-0-27" id="h14-0-27" class="i">+    var search = cs.search(q);
</a><a href="#h14-0-28" id="h14-0-28" class="i">+    var results = 0;
</a><a href="#h14-0-29" id="h14-0-29" class="i">+    search.on(&#39;match&#39;, function () {
</a><a href="#h14-0-30" id="h14-0-30" class="i">+                  results++;
</a><a href="#h14-0-31" id="h14-0-31" class="i">+              })
</a><a href="#h14-0-32" id="h14-0-32" class="i">+    search.on(&#39;done&#39;,
</a><a href="#h14-0-33" id="h14-0-33" class="i">+              function (stats) {
</a><a href="#h14-0-34" id="h14-0-34" class="i">+                  var end = new Date();
</a><a href="#h14-0-35" id="h14-0-35" class="i">+                  var time = +(end - start);
</a><a href="#h14-0-36" id="h14-0-36" class="i">+                  if (!(q in times))
</a><a href="#h14-0-37" id="h14-0-37" class="i">+                      times[q] = [];
</a><a href="#h14-0-38" id="h14-0-38" class="i">+                  stats.time = time;
</a><a href="#h14-0-39" id="h14-0-39" class="i">+                  times[q].push(stats);
</a><a href="#h14-0-40" id="h14-0-40" class="i">+                  cs.once(&#39;ready&#39;, function() {
</a><a href="#h14-0-41" id="h14-0-41" class="i">+                              loop(i+1);
</a><a href="#h14-0-42" id="h14-0-42" class="i">+                          });
</a><a href="#h14-0-43" id="h14-0-43" class="i">+              });
</a><a href="#h14-0-44" id="h14-0-44" class="i">+}
</a><a href="#h14-0-45" id="h14-0-45" class="i">+
</a><a href="#h14-0-46" id="h14-0-46" class="i">+function average(l, field) {
</a><a href="#h14-0-47" id="h14-0-47" class="i">+    var sum = 0;
</a><a href="#h14-0-48" id="h14-0-48" class="i">+    l.forEach(function (e) {sum += e[field];});
</a><a href="#h14-0-49" id="h14-0-49" class="i">+    return sum / l.length;
</a><a href="#h14-0-50" id="h14-0-50" class="i">+}
</a><a href="#h14-0-51" id="h14-0-51" class="i">+
</a><a href="#h14-0-52" id="h14-0-52" class="i">+function done() {
</a><a href="#h14-0-53" id="h14-0-53" class="i">+    var results = [];
</a><a href="#h14-0-54" id="h14-0-54" class="i">+    for (q in times) {
</a><a href="#h14-0-55" id="h14-0-55" class="i">+        results.push([q, times[q], average(times[q], &#39;time&#39;)]);
</a><a href="#h14-0-56" id="h14-0-56" class="i">+    }
</a><a href="#h14-0-57" id="h14-0-57" class="i">+    results.sort(function (a,b) {
</a><a href="#h14-0-58" id="h14-0-58" class="i">+                     return b[2] - a[2]
</a><a href="#h14-0-59" id="h14-0-59" class="i">+                 });
</a><a href="#h14-0-60" id="h14-0-60" class="i">+    console.log(&quot;*** RESULTS ***&quot;)
</a><a href="#h14-0-61" id="h14-0-61" class="i">+    results.forEach(function (r) {
</a><a href="#h14-0-62" id="h14-0-62" class="i">+        console.log(&quot;[%s]: %ss (re2: %s, git: %s)&quot;,
</a><a href="#h14-0-63" id="h14-0-63" class="i">+                    r[0], Math.round(r[2])/1000,
</a><a href="#h14-0-64" id="h14-0-64" class="i">+                    Math.round(average(r[1], &#39;re2_time&#39;))/1000,
</a><a href="#h14-0-65" id="h14-0-65" class="i">+                    Math.round(average(r[1], &#39;git_time&#39;))/1000)
</a><a href="#h14-0-66" id="h14-0-66" class="i">+    });
</a><a href="#h14-0-67" id="h14-0-67" class="i">+    process.exit(0);
</a><a href="#h14-0-68" id="h14-0-68" class="i">+}
</a><a href="#h14-0-69" id="h14-0-69" class="i">+
</a><a href="#h14-0-70" id="h14-0-70" class="i">+cs.once(&#39;ready&#39;, function() {
</a><a href="#h14-0-71" id="h14-0-71" class="i">+            console.log(&quot;Begin searching...&quot;);
</a><a href="#h14-0-72" id="h14-0-72" class="i">+            loop(0);
</a><a href="#h14-0-73" id="h14-0-73" class="i">+        });
</a><b>diff --git a/<a id="h15" href="../file/test/testcases">test/testcases</a> b/<a href="../file/test/testcases">test/testcases</a></b>
<a href="#h15-0" id="h15-0" class="h">@@ -0,0 +1,19 @@
</a><a href="#h15-0-0" id="h15-0-0" class="i">+
</a><a href="#h15-0-1" id="h15-0-1" class="i">+____do
</a><a href="#h15-0-2" id="h15-0-2" class="i">+errno\W
</a><a href="#h15-0-3" id="h15-0-3" class="i">+kmalloc\(
</a><a href="#h15-0-4" id="h15-0-4" class="i">+printk\(
</a><a href="#h15-0-5" id="h15-0-5" class="i">+^(\s.*\S)?kmalloc\s*\(
</a><a href="#h15-0-6" id="h15-0-6" class="i">+^(\s.*\S)?printk\s*\(
</a><a href="#h15-0-7" id="h15-0-7" class="i">+^(\s.*\S)?acct_
</a><a href="#h15-0-8" id="h15-0-8" class="i">+.
</a><a href="#h15-0-9" id="h15-0-9" class="i">+^$
</a><a href="#h15-0-10" id="h15-0-10" class="i">+[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}
</a><a href="#h15-0-11" id="h15-0-11" class="i">+[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}
</a><a href="#h15-0-12" id="h15-0-12" class="i">+[0-9a-fA-F]{20}
</a><a href="#h15-0-13" id="h15-0-13" class="i">+[0-9a-fA-F]{50}
</a><a href="#h15-0-14" id="h15-0-14" class="i">+[0-9a-fA-F]{100}
</a><a href="#h15-0-15" id="h15-0-15" class="i">+dazed
</a><a href="#h15-0-16" id="h15-0-16" class="i">+.zqz
</a><a href="#h15-0-17" id="h15-0-17" class="i">+\s$
</a><a href="#h15-0-18" id="h15-0-18" class="i">+\s{10}
</a><b>diff --git a/<a id="h16" href="../file/thread_pool.h">thread_pool.h</a> b/<a href="../file/thread_pool.h">thread_pool.h</a></b>
<a href="#h16-0" id="h16-0" class="h">@@ -1,10 +1,27 @@
</a><a href="#h16-0-0" id="h16-0-0" class="i">+#ifndef CODESEARCH_THREAD_POOL_H
</a><a href="#h16-0-1" id="h16-0-1" class="i">+#define CODESEARCH_THREAD_POOL_H
</a><a href="#h16-0-2" id="h16-0-2" class="i">+
</a><a href="#h16-0-3" id="h16-0-3" class="i">+#include &lt;pthread.h&gt;
</a><a href="#h16-0-4" id="h16-0-4" class="i">+
</a><a href="#h16-0-5" id="h16-0-5" class="i">+#include &quot;thread_queue.h&quot;
</a><a href="#h16-0-6" id="h16-0-6" class="i">+
</a><a href="#h16-0-7" id="h16-0-7" class="i">+struct no_thread_state;
</a><a href="#h16-0-8" id="h16-0-8" class="i">+
</a><a href="#h16-0-9" id="h16-0-9" class="i">+template &lt;class J, class DoIt, class ThreadState = no_thread_state&gt;
</a><a href="#h16-0-10" id="h16-0-10" class="i">+class thread_pool;
</a><a href="#h16-0-11" id="h16-0-11" class="i">+
</a><a href="#h16-0-12" id="h16-0-12" class="i">+template&lt;class J, class DoIt, class ThreadState&gt;
</a><a href="#h16-0-13" id="h16-0-13" class="i">+void _thread_worker(thread_pool&lt;J, DoIt, ThreadState&gt;&amp;);
</a><a href="#h16-0-14" id="h16-0-14" class="i">+template&lt;class J, class DoIt&gt;
</a><a href="#h16-0-15" id="h16-0-15" class="i">+void _thread_worker(thread_pool&lt;J, DoIt, no_thread_state&gt;&amp;);
</a><a href="#h16-0-16" id="h16-0-16" class="i">+
</a> template &lt;class J, class DoIt, class ThreadState&gt;
 class thread_pool {
 public:
     thread_pool (int nthreads, DoIt&amp; fn)
         : nthreads_(nthreads), fn_(fn) {
         threads_ = new pthread_t[nthreads_];
<a href="#h16-0-23" id="h16-0-23" class="d">-        for (int i = 0; i &lt; nthreads; i++) {
</a><a href="#h16-0-24" id="h16-0-24" class="i">+        for (int i = 0; i &lt; nthreads_; i++) {
</a>             pthread_create(&amp;threads_[i], NULL, worker, this);
         }
     }
<a href="#h16-1" id="h16-1" class="h">@@ -18,7 +35,7 @@ public:
</a>         for (i = 0; i &lt; nthreads_; i++) {
             pthread_join(threads_[i], NULL);
         }
<a href="#h16-1-3" id="h16-1-3" class="d">-        delete threads_;
</a><a href="#h16-1-4" id="h16-1-4" class="i">+        delete[] threads_;
</a>     }
 
 protected:
<a href="#h16-2" id="h16-2" class="h">@@ -27,18 +44,39 @@ protected:
</a>     thread_queue&lt;J&gt; queue_;
     DoIt&amp; fn_;
 
<a href="#h16-2-3" id="h16-2-3" class="d">-    void worker() {
</a><a href="#h16-2-4" id="h16-2-4" class="d">-        ThreadState ts(fn_);
</a><a href="#h16-2-5" id="h16-2-5" class="d">-        while (true) {
</a><a href="#h16-2-6" id="h16-2-6" class="d">-            J job = queue_.pop();
</a><a href="#h16-2-7" id="h16-2-7" class="d">-            if (fn_(ts, job))
</a><a href="#h16-2-8" id="h16-2-8" class="d">-                break;
</a><a href="#h16-2-9" id="h16-2-9" class="d">-        }
</a><a href="#h16-2-10" id="h16-2-10" class="d">-    }
</a><a href="#h16-2-11" id="h16-2-11" class="d">-
</a>     static void *worker(void *arg) {
         thread_pool *pool = static_cast&lt;thread_pool*&gt;(arg);
<a href="#h16-2-14" id="h16-2-14" class="d">-        pool-&gt;worker();
</a><a href="#h16-2-15" id="h16-2-15" class="i">+        _thread_worker(*pool);
</a>         return NULL;
     }
<a href="#h16-2-18" id="h16-2-18" class="i">+
</a><a href="#h16-2-19" id="h16-2-19" class="i">+    friend void _thread_worker&lt;&gt;(thread_pool&amp;);
</a><a href="#h16-2-20" id="h16-2-20" class="i">+    friend void _thread_worker&lt;&gt;(thread_pool&lt;J, DoIt, no_thread_state&gt;&amp;);
</a> };
<a href="#h16-2-22" id="h16-2-22" class="i">+
</a><a href="#h16-2-23" id="h16-2-23" class="i">+
</a><a href="#h16-2-24" id="h16-2-24" class="i">+struct no_thread_state {};
</a><a href="#h16-2-25" id="h16-2-25" class="i">+
</a><a href="#h16-2-26" id="h16-2-26" class="i">+template&lt;class J, class DoIt, class ThreadState&gt;
</a><a href="#h16-2-27" id="h16-2-27" class="i">+void _thread_worker(thread_pool&lt;J, DoIt, ThreadState&gt;&amp; pool)
</a><a href="#h16-2-28" id="h16-2-28" class="i">+{
</a><a href="#h16-2-29" id="h16-2-29" class="i">+    ThreadState ts(pool.fn_);
</a><a href="#h16-2-30" id="h16-2-30" class="i">+    while (true) {
</a><a href="#h16-2-31" id="h16-2-31" class="i">+        J job = pool.queue_.pop();
</a><a href="#h16-2-32" id="h16-2-32" class="i">+        if (pool.fn_(ts, job))
</a><a href="#h16-2-33" id="h16-2-33" class="i">+            break;
</a><a href="#h16-2-34" id="h16-2-34" class="i">+    }
</a><a href="#h16-2-35" id="h16-2-35" class="i">+}
</a><a href="#h16-2-36" id="h16-2-36" class="i">+
</a><a href="#h16-2-37" id="h16-2-37" class="i">+template &lt;class J, class DoIt&gt;
</a><a href="#h16-2-38" id="h16-2-38" class="i">+void _thread_worker(thread_pool&lt;J, DoIt, no_thread_state&gt;&amp; pool)
</a><a href="#h16-2-39" id="h16-2-39" class="i">+{
</a><a href="#h16-2-40" id="h16-2-40" class="i">+    while (true) {
</a><a href="#h16-2-41" id="h16-2-41" class="i">+        J job = pool.queue_.pop();
</a><a href="#h16-2-42" id="h16-2-42" class="i">+        if (pool.fn_(job))
</a><a href="#h16-2-43" id="h16-2-43" class="i">+            break;
</a><a href="#h16-2-44" id="h16-2-44" class="i">+    }
</a><a href="#h16-2-45" id="h16-2-45" class="i">+}
</a><a href="#h16-2-46" id="h16-2-46" class="i">+
</a><a href="#h16-2-47" id="h16-2-47" class="i">+#endif /* CODESEARCH_THREAD_POOL_H */
</a><a href="#h16-2-48" id="h16-2-48" class="i">+
</a><b>diff --git a/<a id="h17" href="../file/thread_queue.h">thread_queue.h</a> b/<a href="../file/thread_queue.h">thread_queue.h</a></b>
<a href="#h17-0" id="h17-0" class="h">@@ -1,3 +1,6 @@
</a><a href="#h17-0-0" id="h17-0-0" class="i">+#ifndef CODESEARCH_THREAD_QUEUE_H
</a><a href="#h17-0-1" id="h17-0-1" class="i">+#define CODESEARCH_THREAD_QUEUE_H
</a><a href="#h17-0-2" id="h17-0-2" class="i">+
</a> #include &lt;list&gt;
 
 #include &quot;mutex.h&quot;
<a href="#h17-1" id="h17-1" class="h">@@ -38,3 +41,6 @@ public:
</a>     cond_var cond_;
     std::list&lt;T&gt; queue_;
 };
<a href="#h17-1-3" id="h17-1-3" class="i">+
</a><a href="#h17-1-4" id="h17-1-4" class="i">+
</a><a href="#h17-1-5" id="h17-1-5" class="i">+#endif /* CODESEARCH_THREAD_QUEUE_H */
</a><b>diff --git a/<a id="h18" href="../file/timer.h">timer.h</a> b/<a href="../file/timer.h">timer.h</a></b>
<a href="#h18-0" id="h18-0" class="h">@@ -1,6 +1,8 @@
</a> #include &lt;sys/time.h&gt;
 #include &lt;assert.h&gt;
 
<a href="#h18-0-3" id="h18-0-3" class="i">+#include &quot;mutex.h&quot;
</a><a href="#h18-0-4" id="h18-0-4" class="i">+
</a> class timer {
 public:
     timer(bool startnow = true)
<a href="#h18-1" id="h18-1" class="h">@@ -10,12 +12,14 @@ public:
</a>     }
 
     void start() {
<a href="#h18-1-3" id="h18-1-3" class="i">+        mutex_locker locked(lock_);
</a>         assert(!running_);
         running_ = true;
         gettimeofday(&amp;start_, NULL);
     }
 
     void pause() {
<a href="#h18-1-10" id="h18-1-10" class="i">+        mutex_locker locked(lock_);
</a>         struct timeval now, delta;
         assert(running_);
         running_ = false;
<a href="#h18-2" id="h18-2" class="h">@@ -25,17 +29,20 @@ public:
</a>     }
 
     void reset() {
<a href="#h18-2-3" id="h18-2-3" class="i">+        mutex_locker locked(lock_);
</a>         running_ = false;
         elapsed_ = (struct timeval){0,0};
     }
 
     void add(timer &amp;other) {
<a href="#h18-2-9" id="h18-2-9" class="i">+        mutex_locker locked(lock_);
</a>         assert(!running_);
         struct timeval elapsed = other.elapsed();
         timeval_add(&amp;elapsed_, &amp;elapsed_, &amp;elapsed);
     }
 
     struct timeval elapsed() {
<a href="#h18-2-16" id="h18-2-16" class="i">+        mutex_locker locked(lock_);
</a>         if (running_) {
             struct timeval now, delta;
             gettimeofday(&amp;now, NULL);
<a href="#h18-3" id="h18-3" class="h">@@ -50,6 +57,7 @@ protected:
</a>     bool running_;
     struct timeval start_;
     struct timeval elapsed_;
<a href="#h18-3-3" id="h18-3-3" class="i">+    mutex lock_;
</a> 
     timer(const timer&amp; rhs);
     timer operator=(const timer&amp; rhs);
<a href="#h18-4" id="h18-4" class="h">@@ -98,12 +106,13 @@ protected:
</a> class run_timer {
 public:
     run_timer(timer&amp; timer)
<a href="#h18-4-3" id="h18-4-3" class="d">-        : timer_(timer) {
</a><a href="#h18-4-4" id="h18-4-4" class="d">-        timer_.start();
</a><a href="#h18-4-5" id="h18-4-5" class="i">+        : timer_(timer), local_() {
</a>     }
     ~run_timer() {
<a href="#h18-4-8" id="h18-4-8" class="d">-        timer_.pause();
</a><a href="#h18-4-9" id="h18-4-9" class="i">+        local_.pause();
</a><a href="#h18-4-10" id="h18-4-10" class="i">+        timer_.add(local_);
</a>     }
 protected:
     timer &amp;timer_;
<a href="#h18-4-14" id="h18-4-14" class="i">+    timer local_;
</a> };
<b>diff --git a/<a id="h19" href="../file/web/codesearch.js">web/codesearch.js</a> b/<a href="../file/web/codesearch.js">web/codesearch.js</a></b>
<a href="#h19-0" id="h19-0" class="h">@@ -4,11 +4,14 @@ var spawn   = require(&#39;child_process&#39;).spawn,
</a>     util    = require(&#39;util&#39;),
     events = require(&quot;events&quot;);
 
<a href="#h19-0-3" id="h19-0-3" class="d">-function Codesearch(dir, refs) {
</a><a href="#h19-0-4" id="h19-0-4" class="i">+function Codesearch(repo, refs, opts) {
</a><a href="#h19-0-5" id="h19-0-5" class="i">+  if (opts === null)
</a><a href="#h19-0-6" id="h19-0-6" class="i">+    opts = {};
</a>   events.EventEmitter.call(this);
   this.child = spawn(path.join(__dirname, &#39;..&#39;, &#39;codesearch&#39;),
<a href="#h19-0-9" id="h19-0-9" class="d">-                     (refs || [&#39;HEAD&#39;]), {
</a><a href="#h19-0-10" id="h19-0-10" class="d">-                       cwd: dir,
</a><a href="#h19-0-11" id="h19-0-11" class="i">+                     [&#39;--git_dir&#39;, path.join(repo, &quot;.git&quot;), &#39;--json&#39;].concat(
</a><a href="#h19-0-12" id="h19-0-12" class="i">+                       opts.args||[]).concat(refs || [&#39;HEAD&#39;]),
</a><a href="#h19-0-13" id="h19-0-13" class="i">+                     {
</a>                        customFds: [-1, -1, 2]
                      });
   this.child.stdout.setEncoding(&#39;utf8&#39;);
<a href="#h19-1" id="h19-1" class="h">@@ -46,11 +49,12 @@ function expect_ready(line) {
</a> Codesearch.prototype.handle_line = {
   &#39;init&#39;: expect_ready,
   &#39;searching&#39;: function (line) {
<a href="#h19-1-3" id="h19-1-3" class="d">-    var match = /^FATAL (.*)/.exec(line);
</a><a href="#h19-1-4" id="h19-1-4" class="d">-    if (match) {
</a><a href="#h19-1-5" id="h19-1-5" class="i">+    var match;
</a><a href="#h19-1-6" id="h19-1-6" class="i">+    if (match = /^FATAL (.*)/.exec(line)) {
</a>       this.error(match[1]);
<a href="#h19-1-8" id="h19-1-8" class="d">-    } else if (line == &#39;DONE&#39;) {
</a><a href="#h19-1-9" id="h19-1-9" class="d">-      this.current_search.emit(&#39;done&#39;);
</a><a href="#h19-1-10" id="h19-1-10" class="i">+    } else if (match = /^DONE\s*(.*)/.exec(line)) {
</a><a href="#h19-1-11" id="h19-1-11" class="i">+      var stats = JSON.parse(match[1]);
</a><a href="#h19-1-12" id="h19-1-12" class="i">+      this.current_search.emit(&#39;done&#39;, stats);
</a>       this.endSearch();
     } else {
       this.match(line);
</pre>
</div>
</body>
</html>
