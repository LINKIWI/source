<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Purge node.js with fire. - livegrep - Fast, regular expression code search service</title>
<meta name="description" content="Fast, regular expression code search service" />
<meta name="author" content="Kevin Lin" />
<link rel="icon" type="image/png" href="https://static.kevinlin.info/favicon.png" />
<link rel="alternate" type="application/atom+xml" title="livegrep Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="livegrep Atom Feed (tags)" href="../tags.xml" />
<style type="text/css">
body{color:#000;background-color:#fff;font-family:monospace}h1,h2,h3,h4,h5,h6{font-size:1em;margin:0}img,h1,h2{vertical-align:middle}img{border:0}a:target{background-color:#ccc}a.d,a.h,a.i{text-decoration:none}a.line{text-decoration:none;user-select:none}#blob a{color:#555}#blob a:hover{color:blue;text-decoration:none}table thead td{font-weight:bold}table td{padding:0 .4em}table td pre{margin:0}#content table td{vertical-align:top;white-space:nowrap}#branches tr:hover td,#tags tr:hover td,#index tr:hover td,#log tr:hover td,#files tr:hover td{background-color:#eee}#index tr td:nth-child(2),#tags tr td:nth-child(3),#branches tr td:nth-child(3),#log tr td:nth-child(2){white-space:normal}td.num{text-align:right}.desc{color:#555}hr{border:0;border-top:1px solid #555;height:1px}pre{font-family:monospace}pre a.h{color:#00a}.A,span.i,pre a.i{color:#070}.D,span.d,pre a.d{color:#e00}pre a.h:hover,pre a.i:hover,pre a.d:hover{text-decoration:none}
</style>
</head>
<body>
<table><tr><td><a href="/"><img src="https://static.kevinlin.info/favicon.png" alt="" width="32" height="32" /></a></td><td><h1>livegrep</h1><span class="desc">Fast, regular expression code search service</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://source.static.kevinlin.info/external/livegrep.git">https://source.static.kevinlin.info/external/livegrep.git</a></td></tr><tr><td></td><td>
<a href="../log">Log</a> | <a href="../files">Files</a> | <a href="../refs">Refs</a> | <a href="../file/README.md">README</a> | <a href="../file/COPYING">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/63b09dc5a3a2b122c51ab339eb9b3a0ca4d440cd">63b09dc5a3a2b122c51ab339eb9b3a0ca4d440cd</a>
<b>parent</b> <a href="../commit/d4098d4a7e84c47abb394b240186a27f8bbe8b1c">d4098d4a7e84c47abb394b240186a27f8bbe8b1c</a>
<b>Author:</b> Nelson Elhage &lt;<a href="mailto:nelhage@nelhage.com">nelhage@nelhage.com</a>&gt;
<b>Date:</b>   Sat 29 Mar 2014 12:48:28 -0700

Purge node.js with fire.

<b>Diffstat:</b>
<table><tr><td class="D">D</td><td><a href="#h0">bin/cs_server.js</a></td><td> | </td><td class="num">89</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h1">bin/index.js</a></td><td> | </td><td class="num">44</td><td><span class="i"></span><span class="d">--------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h2">bin/web_server.js</a></td><td> | </td><td class="num">201</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h3">js/.gitignore</a></td><td> | </td><td class="num">1</td><td><span class="i"></span><span class="d">-</span></td></tr>
<tr><td class="D">D</td><td><a href="#h4">js/appserver.js</a></td><td> | </td><td class="num">337</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h5">js/backend.js</a></td><td> | </td><td class="num">24</td><td><span class="i"></span><span class="d">------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h6">js/batch.js</a></td><td> | </td><td class="num">29</td><td><span class="i"></span><span class="d">-----------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h7">js/codesearch.js</a></td><td> | </td><td class="num">145</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h8">js/config.js</a></td><td> | </td><td class="num">57</td><td><span class="i"></span><span class="d">---------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h9">js/git_util.js</a></td><td> | </td><td class="num">11</td><td><span class="i"></span><span class="d">-----------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h10">js/lib/parseopt.js</a></td><td> | </td><td class="num">22</td><td><span class="i"></span><span class="d">----------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h11">js/lib/query-stats.js</a></td><td> | </td><td class="num">81</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h12">js/lib/stats.js</a></td><td> | </td><td class="num">20</td><td><span class="i"></span><span class="d">--------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h13">js/log4js.json</a></td><td> | </td><td class="num">45</td><td><span class="i"></span><span class="d">---------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h14">js/parse-log.js</a></td><td> | </td><td class="num">56</td><td><span class="i"></span><span class="d">--------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h15">js/util.js</a></td><td> | </td><td class="num">23</td><td><span class="i"></span><span class="d">-----------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h16">package.json</a></td><td> | </td><td class="num">24</td><td><span class="i"></span><span class="d">------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h17">runtests.sh</a></td><td> | </td><td class="num">21</td><td><span class="i"></span><span class="d">---------------------</span></td></tr>
</table></pre><pre>18 files changed, 0 insertions(+), 1230 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/bin/cs_server.js">bin/cs_server.js</a> b/<a href="../file/bin/cs_server.js">bin/cs_server.js</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -1,89 +0,0 @@
</a><a href="#h0-0-0" id="h0-0-0" class="d">-#!/usr/bin/env node
</a><a href="#h0-0-1" id="h0-0-1" class="d">-var dnode   = require(&#39;dnode&#39;),
</a><a href="#h0-0-2" id="h0-0-2" class="d">-    path    = require(&#39;path&#39;),
</a><a href="#h0-0-3" id="h0-0-3" class="d">-    net     = require(&#39;net&#39;),
</a><a href="#h0-0-4" id="h0-0-4" class="d">-    config  = require(&#39;../js/config.js&#39;),
</a><a href="#h0-0-5" id="h0-0-5" class="d">-    git_util   = require(&#39;../js/git_util.js&#39;),
</a><a href="#h0-0-6" id="h0-0-6" class="d">-    util       = require(&#39;../js/util.js&#39;),
</a><a href="#h0-0-7" id="h0-0-7" class="d">-    Codesearch = require(&#39;../js/codesearch.js&#39;),
</a><a href="#h0-0-8" id="h0-0-8" class="d">-    Batch      = require(&#39;../js/batch.js&#39;),
</a><a href="#h0-0-9" id="h0-0-9" class="d">-    parseopt   = require(&#39;../js/lib/parseopt.js&#39;),
</a><a href="#h0-0-10" id="h0-0-10" class="d">-    backend    = require(&#39;../js/backend.js&#39;)
</a><a href="#h0-0-11" id="h0-0-11" class="d">-
</a><a href="#h0-0-12" id="h0-0-12" class="d">-function Client(parent, remote) {
</a><a href="#h0-0-13" id="h0-0-13" class="d">-  var self = this;
</a><a href="#h0-0-14" id="h0-0-14" class="d">-  this.parent = parent;
</a><a href="#h0-0-15" id="h0-0-15" class="d">-  this.remote = remote;
</a><a href="#h0-0-16" id="h0-0-16" class="d">-  this.queue  = [];
</a><a href="#h0-0-17" id="h0-0-17" class="d">-  this.conn   = parent.codesearch.connect();
</a><a href="#h0-0-18" id="h0-0-18" class="d">-  this.conn.on(&#39;ready&#39;, function() {
</a><a href="#h0-0-19" id="h0-0-19" class="d">-                 var q;
</a><a href="#h0-0-20" id="h0-0-20" class="d">-                 if (self.queue.length) {
</a><a href="#h0-0-21" id="h0-0-21" class="d">-                   q = self.queue.shift();
</a><a href="#h0-0-22" id="h0-0-22" class="d">-                   self.search(q.search, q.cb);
</a><a href="#h0-0-23" id="h0-0-23" class="d">-                 } else {
</a><a href="#h0-0-24" id="h0-0-24" class="d">-                   self.ready();
</a><a href="#h0-0-25" id="h0-0-25" class="d">-                 }
</a><a href="#h0-0-26" id="h0-0-26" class="d">-               });
</a><a href="#h0-0-27" id="h0-0-27" class="d">-}
</a><a href="#h0-0-28" id="h0-0-28" class="d">-
</a><a href="#h0-0-29" id="h0-0-29" class="d">-Client.prototype.ready = function() {
</a><a href="#h0-0-30" id="h0-0-30" class="d">-  if (this.remote.ready)
</a><a href="#h0-0-31" id="h0-0-31" class="d">-    util.remote_call(this.remote, &#39;ready&#39;);
</a><a href="#h0-0-32" id="h0-0-32" class="d">-}
</a><a href="#h0-0-33" id="h0-0-33" class="d">-
</a><a href="#h0-0-34" id="h0-0-34" class="d">-Client.prototype.search = function (search, cb) {
</a><a href="#h0-0-35" id="h0-0-35" class="d">-  if (this.conn.readyState !== &#39;ready&#39;) {
</a><a href="#h0-0-36" id="h0-0-36" class="d">-    this.queue.push({
</a><a href="#h0-0-37" id="h0-0-37" class="d">-                      search: search,
</a><a href="#h0-0-38" id="h0-0-38" class="d">-                      cb: cb
</a><a href="#h0-0-39" id="h0-0-39" class="d">-                    });
</a><a href="#h0-0-40" id="h0-0-40" class="d">-    return;
</a><a href="#h0-0-41" id="h0-0-41" class="d">-  }
</a><a href="#h0-0-42" id="h0-0-42" class="d">-  var search = this.conn.search(search.line, search.file, search.repo);
</a><a href="#h0-0-43" id="h0-0-43" class="d">-  var batch  = new Batch(function (m) {
</a><a href="#h0-0-44" id="h0-0-44" class="d">-                           util.remote_call(cb, &#39;match&#39;, m);
</a><a href="#h0-0-45" id="h0-0-45" class="d">-                         }, 50);
</a><a href="#h0-0-46" id="h0-0-46" class="d">-  search.on(&#39;error&#39;, util.remote_call.bind(null, cb, &#39;error&#39;));
</a><a href="#h0-0-47" id="h0-0-47" class="d">-  search.on(&#39;done&#39;,  function () {
</a><a href="#h0-0-48" id="h0-0-48" class="d">-              batch.flush();
</a><a href="#h0-0-49" id="h0-0-49" class="d">-              util.remote_call.apply(null, [cb, &#39;done&#39;].concat(Array.prototype.slice.call(arguments)));
</a><a href="#h0-0-50" id="h0-0-50" class="d">-            });
</a><a href="#h0-0-51" id="h0-0-51" class="d">-  search.on(&#39;match&#39;, batch.send.bind(batch));
</a><a href="#h0-0-52" id="h0-0-52" class="d">-}
</a><a href="#h0-0-53" id="h0-0-53" class="d">-
</a><a href="#h0-0-54" id="h0-0-54" class="d">-function Server(backend) {
</a><a href="#h0-0-55" id="h0-0-55" class="d">-  var parent = this;
</a><a href="#h0-0-56" id="h0-0-56" class="d">-  this.clients = [];
</a><a href="#h0-0-57" id="h0-0-57" class="d">-
</a><a href="#h0-0-58" id="h0-0-58" class="d">-  this.codesearch = new Codesearch(backend.repo, [], {
</a><a href="#h0-0-59" id="h0-0-59" class="d">-                                     args: [&#39;--load_index&#39;, backend.index].concat(backend.search_args || [])
</a><a href="#h0-0-60" id="h0-0-60" class="d">-                                   });
</a><a href="#h0-0-61" id="h0-0-61" class="d">-  this.Server = function (remote, conn) {
</a><a href="#h0-0-62" id="h0-0-62" class="d">-    parent.clients[conn.id] = new Client(parent, remote);
</a><a href="#h0-0-63" id="h0-0-63" class="d">-    conn.on(&#39;end&#39;, function() {
</a><a href="#h0-0-64" id="h0-0-64" class="d">-              var client = parent.clients[conn.id];
</a><a href="#h0-0-65" id="h0-0-65" class="d">-              delete parent.clients[conn.id];
</a><a href="#h0-0-66" id="h0-0-66" class="d">-            });
</a><a href="#h0-0-67" id="h0-0-67" class="d">-    this.try_search = function(search, cb) {
</a><a href="#h0-0-68" id="h0-0-68" class="d">-      if (parent.clients[conn.id].conn.readyState !== &#39;ready&#39;) {
</a><a href="#h0-0-69" id="h0-0-69" class="d">-        util.remote_call(cb, &#39;not_ready&#39;);
</a><a href="#h0-0-70" id="h0-0-70" class="d">-        return;
</a><a href="#h0-0-71" id="h0-0-71" class="d">-      }
</a><a href="#h0-0-72" id="h0-0-72" class="d">-      parent.clients[conn.id].search(search, cb);
</a><a href="#h0-0-73" id="h0-0-73" class="d">-    }
</a><a href="#h0-0-74" id="h0-0-74" class="d">-    this.search = function(search, cb) {
</a><a href="#h0-0-75" id="h0-0-75" class="d">-      parent.clients[conn.id].search(search, cb);
</a><a href="#h0-0-76" id="h0-0-76" class="d">-    }
</a><a href="#h0-0-77" id="h0-0-77" class="d">-  }
</a><a href="#h0-0-78" id="h0-0-78" class="d">-}
</a><a href="#h0-0-79" id="h0-0-79" class="d">-
</a><a href="#h0-0-80" id="h0-0-80" class="d">-var parser = new parseopt.OptionParser();
</a><a href="#h0-0-81" id="h0-0-81" class="d">-backend.addBackendOpt(config, parser);
</a><a href="#h0-0-82" id="h0-0-82" class="d">-
</a><a href="#h0-0-83" id="h0-0-83" class="d">-var opts = parser.parse(process.argv);
</a><a href="#h0-0-84" id="h0-0-84" class="d">-
</a><a href="#h0-0-85" id="h0-0-85" class="d">-var backend = backend.selectBackend(config, opts);
</a><a href="#h0-0-86" id="h0-0-86" class="d">-
</a><a href="#h0-0-87" id="h0-0-87" class="d">-var server = dnode(new Server(backend).Server);
</a><a href="#h0-0-88" id="h0-0-88" class="d">-server.listen(backend.port);
</a><b>diff --git a/<a id="h1" href="../file/bin/index.js">bin/index.js</a> b/<a href="../file/bin/index.js">bin/index.js</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -1,44 +0,0 @@
</a><a href="#h1-0-0" id="h1-0-0" class="d">-#!/usr/bin/env node
</a><a href="#h1-0-1" id="h1-0-1" class="d">-var path    = require(&#39;path&#39;),
</a><a href="#h1-0-2" id="h1-0-2" class="d">-    fs      = require(&#39;fs&#39;),
</a><a href="#h1-0-3" id="h1-0-3" class="d">-    config  = require(&#39;../js/config.js&#39;),
</a><a href="#h1-0-4" id="h1-0-4" class="d">-    backend = require(&#39;../js/backend.js&#39;),
</a><a href="#h1-0-5" id="h1-0-5" class="d">-    parseopt= require(&#39;../js/lib/parseopt.js&#39;),
</a><a href="#h1-0-6" id="h1-0-6" class="d">-    spawn   = require(&#39;child_process&#39;).spawn;
</a><a href="#h1-0-7" id="h1-0-7" class="d">-
</a><a href="#h1-0-8" id="h1-0-8" class="d">-function generateIndex(backend, cb) {
</a><a href="#h1-0-9" id="h1-0-9" class="d">-  console.log(&quot;Generating index file: %s&quot;, backend.index);
</a><a href="#h1-0-10" id="h1-0-10" class="d">-
</a><a href="#h1-0-11" id="h1-0-11" class="d">-  var tmp = backend.index + &quot;.tmp&quot;;
</a><a href="#h1-0-12" id="h1-0-12" class="d">-
</a><a href="#h1-0-13" id="h1-0-13" class="d">-  var repos = backend.repos.map(function (repo) {
</a><a href="#h1-0-14" id="h1-0-14" class="d">-    return (repo.name ? repo.name + &quot;@&quot; : &quot;&quot;) +
</a><a href="#h1-0-15" id="h1-0-15" class="d">-      repo.path + &quot;:&quot; + repo.refs.join(&quot;,&quot;);
</a><a href="#h1-0-16" id="h1-0-16" class="d">-    });
</a><a href="#h1-0-17" id="h1-0-17" class="d">-
</a><a href="#h1-0-18" id="h1-0-18" class="d">-  var cs = spawn(path.join(__dirname, &#39;..&#39;, &#39;codesearch&#39;),
</a><a href="#h1-0-19" id="h1-0-19" class="d">-                 [&#39;--dump_index&#39;, tmp,
</a><a href="#h1-0-20" id="h1-0-20" class="d">-                  &#39;--order_root&#39;, backend.sort.join(&#39; &#39;),
</a><a href="#h1-0-21" id="h1-0-21" class="d">-                 ].concat(repos),
</a><a href="#h1-0-22" id="h1-0-22" class="d">-                 {
</a><a href="#h1-0-23" id="h1-0-23" class="d">-                   customFds: [-1, 1, 2]
</a><a href="#h1-0-24" id="h1-0-24" class="d">-                 });
</a><a href="#h1-0-25" id="h1-0-25" class="d">-  cs.on(&#39;exit&#39;, function(code, signal) {
</a><a href="#h1-0-26" id="h1-0-26" class="d">-          if (code !== 0) {
</a><a href="#h1-0-27" id="h1-0-27" class="d">-            console.error(&quot;Index process exited with %s&quot;, code ? (&quot;error &quot; + code) : &quot;signal &quot; + signal);
</a><a href="#h1-0-28" id="h1-0-28" class="d">-          } else {
</a><a href="#h1-0-29" id="h1-0-29" class="d">-            fs.renameSync(tmp, backend.index);
</a><a href="#h1-0-30" id="h1-0-30" class="d">-          }
</a><a href="#h1-0-31" id="h1-0-31" class="d">-          cb();
</a><a href="#h1-0-32" id="h1-0-32" class="d">-        });
</a><a href="#h1-0-33" id="h1-0-33" class="d">-  cs.stdin.end();
</a><a href="#h1-0-34" id="h1-0-34" class="d">-}
</a><a href="#h1-0-35" id="h1-0-35" class="d">-
</a><a href="#h1-0-36" id="h1-0-36" class="d">-var parser = new parseopt.OptionParser();
</a><a href="#h1-0-37" id="h1-0-37" class="d">-backend.addBackendOpt(config, parser);
</a><a href="#h1-0-38" id="h1-0-38" class="d">-
</a><a href="#h1-0-39" id="h1-0-39" class="d">-var opts = parser.parse(process.argv);
</a><a href="#h1-0-40" id="h1-0-40" class="d">-generateIndex(backend.selectBackend(config, opts),
</a><a href="#h1-0-41" id="h1-0-41" class="d">-             function () {
</a><a href="#h1-0-42" id="h1-0-42" class="d">-               process.exit(0);
</a><a href="#h1-0-43" id="h1-0-43" class="d">-             });
</a><b>diff --git a/<a id="h2" href="../file/bin/web_server.js">bin/web_server.js</a> b/<a href="../file/bin/web_server.js">bin/web_server.js</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -1,201 +0,0 @@
</a><a href="#h2-0-0" id="h2-0-0" class="d">-#!/usr/bin/env node
</a><a href="#h2-0-1" id="h2-0-1" class="d">-var express = require(&#39;express&#39;),
</a><a href="#h2-0-2" id="h2-0-2" class="d">-    http    = require(&#39;http&#39;),
</a><a href="#h2-0-3" id="h2-0-3" class="d">-    hbs     = require(&#39;hbs&#39;),
</a><a href="#h2-0-4" id="h2-0-4" class="d">-    extras  = require(&#39;express-extras&#39;),
</a><a href="#h2-0-5" id="h2-0-5" class="d">-    path    = require(&#39;path&#39;),
</a><a href="#h2-0-6" id="h2-0-6" class="d">-    parseopt= require(&#39;parseopt&#39;),
</a><a href="#h2-0-7" id="h2-0-7" class="d">-    log4js  = require(&#39;log4js&#39;),
</a><a href="#h2-0-8" id="h2-0-8" class="d">-    email   = require(&#39;emailjs&#39;),
</a><a href="#h2-0-9" id="h2-0-9" class="d">-    util    = require(&#39;util&#39;),
</a><a href="#h2-0-10" id="h2-0-10" class="d">-    Server  = require(&#39;../js/appserver.js&#39;),
</a><a href="#h2-0-11" id="h2-0-11" class="d">-    config  = require(&#39;../js/config.js&#39;);
</a><a href="#h2-0-12" id="h2-0-12" class="d">-
</a><a href="#h2-0-13" id="h2-0-13" class="d">-function shorten(ref) {
</a><a href="#h2-0-14" id="h2-0-14" class="d">-  var match = /^refs\/(tags|branches)\/(.*)/.exec(ref);
</a><a href="#h2-0-15" id="h2-0-15" class="d">-  if (match)
</a><a href="#h2-0-16" id="h2-0-16" class="d">-    return match[2];
</a><a href="#h2-0-17" id="h2-0-17" class="d">-  return ref;
</a><a href="#h2-0-18" id="h2-0-18" class="d">-}
</a><a href="#h2-0-19" id="h2-0-19" class="d">-
</a><a href="#h2-0-20" id="h2-0-20" class="d">-var parser = new parseopt.OptionParser(
</a><a href="#h2-0-21" id="h2-0-21" class="d">-  {
</a><a href="#h2-0-22" id="h2-0-22" class="d">-    options: [
</a><a href="#h2-0-23" id="h2-0-23" class="d">-      {
</a><a href="#h2-0-24" id="h2-0-24" class="d">-        name: &quot;--autolaunch&quot;,
</a><a href="#h2-0-25" id="h2-0-25" class="d">-        default: false,
</a><a href="#h2-0-26" id="h2-0-26" class="d">-        type: &#39;flag&#39;,
</a><a href="#h2-0-27" id="h2-0-27" class="d">-        help: &#39;Automatically launch a code-search backend server.&#39;
</a><a href="#h2-0-28" id="h2-0-28" class="d">-      },
</a><a href="#h2-0-29" id="h2-0-29" class="d">-      {
</a><a href="#h2-0-30" id="h2-0-30" class="d">-        name: &quot;--production&quot;,
</a><a href="#h2-0-31" id="h2-0-31" class="d">-        default: false,
</a><a href="#h2-0-32" id="h2-0-32" class="d">-        type: &#39;flag&#39;,
</a><a href="#h2-0-33" id="h2-0-33" class="d">-        help: &#39;Enable options for a production deployment.&#39;
</a><a href="#h2-0-34" id="h2-0-34" class="d">-      }
</a><a href="#h2-0-35" id="h2-0-35" class="d">-    ]
</a><a href="#h2-0-36" id="h2-0-36" class="d">-  });
</a><a href="#h2-0-37" id="h2-0-37" class="d">-
</a><a href="#h2-0-38" id="h2-0-38" class="d">-var opts = parser.parse();
</a><a href="#h2-0-39" id="h2-0-39" class="d">-if (!opts) {
</a><a href="#h2-0-40" id="h2-0-40" class="d">-  process.exit(1);
</a><a href="#h2-0-41" id="h2-0-41" class="d">-}
</a><a href="#h2-0-42" id="h2-0-42" class="d">-
</a><a href="#h2-0-43" id="h2-0-43" class="d">-if (opts.options.autolaunch) {
</a><a href="#h2-0-44" id="h2-0-44" class="d">-  console.log(&quot;Autolaunching a back-end server...&quot;);
</a><a href="#h2-0-45" id="h2-0-45" class="d">-  require(&#39;./cs_server.js&#39;)
</a><a href="#h2-0-46" id="h2-0-46" class="d">-}
</a><a href="#h2-0-47" id="h2-0-47" class="d">-
</a><a href="#h2-0-48" id="h2-0-48" class="d">-var smtp = null;
</a><a href="#h2-0-49" id="h2-0-49" class="d">-if (config.SMTP_CONFIG) {
</a><a href="#h2-0-50" id="h2-0-50" class="d">-  smtp = email.server.connect(config.SMTP_CONFIG);
</a><a href="#h2-0-51" id="h2-0-51" class="d">-}
</a><a href="#h2-0-52" id="h2-0-52" class="d">-
</a><a href="#h2-0-53" id="h2-0-53" class="d">-var app = express();
</a><a href="#h2-0-54" id="h2-0-54" class="d">-var logger = log4js.getLogger(&#39;web&#39;);
</a><a href="#h2-0-55" id="h2-0-55" class="d">-
</a><a href="#h2-0-56" id="h2-0-56" class="d">-app.configure(
</a><a href="#h2-0-57" id="h2-0-57" class="d">-  function() {
</a><a href="#h2-0-58" id="h2-0-58" class="d">-    app.use(extras.fixIP());
</a><a href="#h2-0-59" id="h2-0-59" class="d">-    app.use(log4js.connectLogger(logger, {
</a><a href="#h2-0-60" id="h2-0-60" class="d">-                                   level: log4js.levels.INFO,
</a><a href="#h2-0-61" id="h2-0-61" class="d">-                                   format: function (req, res, fmt) {
</a><a href="#h2-0-62" id="h2-0-62" class="d">-                                     return &#39;&#39; + req.ip + fmt(&#39; [:date] :method :url&#39;);
</a><a href="#h2-0-63" id="h2-0-63" class="d">-                                   }
</a><a href="#h2-0-64" id="h2-0-64" class="d">-                                 }));
</a><a href="#h2-0-65" id="h2-0-65" class="d">-    app.engine(&#39;.html&#39;, hbs.__express);
</a><a href="#h2-0-66" id="h2-0-66" class="d">-    app.engine(&#39;.xml&#39;, hbs.__express);
</a><a href="#h2-0-67" id="h2-0-67" class="d">-    app.set(&#39;view engine&#39;, &#39;html&#39;);
</a><a href="#h2-0-68" id="h2-0-68" class="d">-    app.set(&#39;view options&#39;, {
</a><a href="#h2-0-69" id="h2-0-69" class="d">-              production: opts.options.production
</a><a href="#h2-0-70" id="h2-0-70" class="d">-            });
</a><a href="#h2-0-71" id="h2-0-71" class="d">-    app.set(&#39;views&#39;, path.join(__dirname, &#39;../web/templates&#39;));
</a><a href="#h2-0-72" id="h2-0-72" class="d">-    app.use(express.bodyParser());
</a><a href="#h2-0-73" id="h2-0-73" class="d">-    app.use(express.static(path.join(__dirname, &#39;../web/htdocs&#39;)));
</a><a href="#h2-0-74" id="h2-0-74" class="d">-    if (opts.options.production) {
</a><a href="#h2-0-75" id="h2-0-75" class="d">-      app.enable(&#39;trust proxy&#39;);
</a><a href="#h2-0-76" id="h2-0-76" class="d">-    }
</a><a href="#h2-0-77" id="h2-0-77" class="d">-    hbs.handlebars.registerHelper(&#39;json&#39;, function (data) {
</a><a href="#h2-0-78" id="h2-0-78" class="d">-      return new hbs.handlebars.SafeString(JSON.stringify(data).replace(/&lt;\/script&gt;/g, &#39;&lt;\\/script&gt;&#39;));
</a><a href="#h2-0-79" id="h2-0-79" class="d">-    });
</a><a href="#h2-0-80" id="h2-0-80" class="d">-  });
</a><a href="#h2-0-81" id="h2-0-81" class="d">-
</a><a href="#h2-0-82" id="h2-0-82" class="d">-app.get(&#39;/&#39;, function (req, res) {res.redirect(&#39;/search&#39;);});
</a><a href="#h2-0-83" id="h2-0-83" class="d">-function searchHandler (req, res) {
</a><a href="#h2-0-84" id="h2-0-84" class="d">-  var repo_map = {};
</a><a href="#h2-0-85" id="h2-0-85" class="d">-  Object.keys(config.BACKENDS).forEach(function (name) {
</a><a href="#h2-0-86" id="h2-0-86" class="d">-    var backend = config.BACKENDS[name];
</a><a href="#h2-0-87" id="h2-0-87" class="d">-    repo_map[name] = {};
</a><a href="#h2-0-88" id="h2-0-88" class="d">-    backend.repos.forEach(function (repo) {
</a><a href="#h2-0-89" id="h2-0-89" class="d">-      repo_map[name][repo.name] = repo.github;
</a><a href="#h2-0-90" id="h2-0-90" class="d">-    });
</a><a href="#h2-0-91" id="h2-0-91" class="d">-  });
</a><a href="#h2-0-92" id="h2-0-92" class="d">-  res.render(&#39;index&#39;,
</a><a href="#h2-0-93" id="h2-0-93" class="d">-             {
</a><a href="#h2-0-94" id="h2-0-94" class="d">-               js: true,
</a><a href="#h2-0-95" id="h2-0-95" class="d">-               title: &#39;search&#39;,
</a><a href="#h2-0-96" id="h2-0-96" class="d">-               repos: Object.keys(config.BACKENDS).map(function (name) {
</a><a href="#h2-0-97" id="h2-0-97" class="d">-                 var backend = config.BACKENDS[name];
</a><a href="#h2-0-98" id="h2-0-98" class="d">-                 return {
</a><a href="#h2-0-99" id="h2-0-99" class="d">-                   name: name,
</a><a href="#h2-0-100" id="h2-0-100" class="d">-                   pretty: backend.pretty_name
</a><a href="#h2-0-101" id="h2-0-101" class="d">-                 };
</a><a href="#h2-0-102" id="h2-0-102" class="d">-               }),
</a><a href="#h2-0-103" id="h2-0-103" class="d">-               multi_repo: Object.keys(config.BACKENDS).length &gt; 1,
</a><a href="#h2-0-104" id="h2-0-104" class="d">-               repo_name: (config.BACKENDS[&#39;&#39;]||{}).pretty_name,
</a><a href="#h2-0-105" id="h2-0-105" class="d">-               github_repos: repo_map,
</a><a href="#h2-0-106" id="h2-0-106" class="d">-               production: opts.options.production
</a><a href="#h2-0-107" id="h2-0-107" class="d">-             });
</a><a href="#h2-0-108" id="h2-0-108" class="d">-}
</a><a href="#h2-0-109" id="h2-0-109" class="d">-app.get(&#39;/search&#39;, searchHandler);
</a><a href="#h2-0-110" id="h2-0-110" class="d">-app.get(&#39;/search/:backend&#39;, searchHandler);
</a><a href="#h2-0-111" id="h2-0-111" class="d">-app.get(&#39;/about&#39;, function (req, res) {
</a><a href="#h2-0-112" id="h2-0-112" class="d">-          res.render(&#39;about&#39;,
</a><a href="#h2-0-113" id="h2-0-113" class="d">-                     {
</a><a href="#h2-0-114" id="h2-0-114" class="d">-                       title: &#39;about&#39;,
</a><a href="#h2-0-115" id="h2-0-115" class="d">-                       production: opts.options.production
</a><a href="#h2-0-116" id="h2-0-116" class="d">-                     });
</a><a href="#h2-0-117" id="h2-0-117" class="d">-        });
</a><a href="#h2-0-118" id="h2-0-118" class="d">-app.get(&#39;/opensearch.xml&#39;, function (req, res) {
</a><a href="#h2-0-119" id="h2-0-119" class="d">-          var backend = config.BACKENDS[Object.keys(config.BACKENDS)[0]];
</a><a href="#h2-0-120" id="h2-0-120" class="d">-          res.render(&#39;opensearch.xml&#39;, {
</a><a href="#h2-0-121" id="h2-0-121" class="d">-              &#39;layout&#39;: false,
</a><a href="#h2-0-122" id="h2-0-122" class="d">-              &#39;baseURL&#39;: req.protocol + &quot;://&quot; + req.get(&#39;Host&#39;) + &quot;/&quot;,
</a><a href="#h2-0-123" id="h2-0-123" class="d">-              &#39;backend&#39;: backend
</a><a href="#h2-0-124" id="h2-0-124" class="d">-          });
</a><a href="#h2-0-125" id="h2-0-125" class="d">-});
</a><a href="#h2-0-126" id="h2-0-126" class="d">-function send_feedback(data, cb) {
</a><a href="#h2-0-127" id="h2-0-127" class="d">-  if (smtp) {
</a><a href="#h2-0-128" id="h2-0-128" class="d">-    smtp.send({
</a><a href="#h2-0-129" id="h2-0-129" class="d">-                to: &quot;Nelson Elhage &lt;feedback@livegrep.com&gt;&quot;,
</a><a href="#h2-0-130" id="h2-0-130" class="d">-                from: &quot;Codesearch &lt;mailer@livegrep.com&quot;,
</a><a href="#h2-0-131" id="h2-0-131" class="d">-                subject: &quot;Feedback from codesearch!&quot;,
</a><a href="#h2-0-132" id="h2-0-132" class="d">-                text: util.format(
</a><a href="#h2-0-133" id="h2-0-133" class="d">-                  &quot;Codesearch feedback from: %s \n&quot; +
</a><a href="#h2-0-134" id="h2-0-134" class="d">-                    &quot;IP: %s\n&quot; +
</a><a href="#h2-0-135" id="h2-0-135" class="d">-                    &quot;Session: %s\n\n&quot; +
</a><a href="#h2-0-136" id="h2-0-136" class="d">-                    &quot;%s&quot;,
</a><a href="#h2-0-137" id="h2-0-137" class="d">-                  data.email,
</a><a href="#h2-0-138" id="h2-0-138" class="d">-                  data.remoteAddress,
</a><a href="#h2-0-139" id="h2-0-139" class="d">-                  data.session,
</a><a href="#h2-0-140" id="h2-0-140" class="d">-                  data.text
</a><a href="#h2-0-141" id="h2-0-141" class="d">-                )
</a><a href="#h2-0-142" id="h2-0-142" class="d">-              }, function (err, message) {
</a><a href="#h2-0-143" id="h2-0-143" class="d">-                if (err) {
</a><a href="#h2-0-144" id="h2-0-144" class="d">-                  console.log(&quot;Error sending email!&quot;, err);
</a><a href="#h2-0-145" id="h2-0-145" class="d">-                  cb(err);
</a><a href="#h2-0-146" id="h2-0-146" class="d">-                } else {
</a><a href="#h2-0-147" id="h2-0-147" class="d">-                  console.log(&quot;Email sent!&quot;);
</a><a href="#h2-0-148" id="h2-0-148" class="d">-                  cb();
</a><a href="#h2-0-149" id="h2-0-149" class="d">-                }
</a><a href="#h2-0-150" id="h2-0-150" class="d">-              });
</a><a href="#h2-0-151" id="h2-0-151" class="d">-  } else {
</a><a href="#h2-0-152" id="h2-0-152" class="d">-    process.nextTick(cb);
</a><a href="#h2-0-153" id="h2-0-153" class="d">-  }
</a><a href="#h2-0-154" id="h2-0-154" class="d">-}
</a><a href="#h2-0-155" id="h2-0-155" class="d">-
</a><a href="#h2-0-156" id="h2-0-156" class="d">-app.post(&#39;/feedback&#39;, function (req, res) {
</a><a href="#h2-0-157" id="h2-0-157" class="d">-           console.log(&quot;FEEDBACK&quot;, req.body);
</a><a href="#h2-0-158" id="h2-0-158" class="d">-           if (!(&#39;data&#39; in req.body)) {
</a><a href="#h2-0-159" id="h2-0-159" class="d">-             res.send(400);
</a><a href="#h2-0-160" id="h2-0-160" class="d">-             return;
</a><a href="#h2-0-161" id="h2-0-161" class="d">-           }
</a><a href="#h2-0-162" id="h2-0-162" class="d">-           var data;
</a><a href="#h2-0-163" id="h2-0-163" class="d">-           try {
</a><a href="#h2-0-164" id="h2-0-164" class="d">-             data = JSON.parse(req.body.data);
</a><a href="#h2-0-165" id="h2-0-165" class="d">-           } catch(e) {
</a><a href="#h2-0-166" id="h2-0-166" class="d">-             console.log(&quot;Feedback error: %s&quot;, e);
</a><a href="#h2-0-167" id="h2-0-167" class="d">-             res.send(400);
</a><a href="#h2-0-168" id="h2-0-168" class="d">-             return;
</a><a href="#h2-0-169" id="h2-0-169" class="d">-           }
</a><a href="#h2-0-170" id="h2-0-170" class="d">-
</a><a href="#h2-0-171" id="h2-0-171" class="d">-           if (!data.email &amp;&amp; !data.text) {
</a><a href="#h2-0-172" id="h2-0-172" class="d">-             console.log(&quot;Empty feedback: %j&quot;, data);
</a><a href="#h2-0-173" id="h2-0-173" class="d">-             res.send(200);
</a><a href="#h2-0-174" id="h2-0-174" class="d">-             return;
</a><a href="#h2-0-175" id="h2-0-175" class="d">-           }
</a><a href="#h2-0-176" id="h2-0-176" class="d">-
</a><a href="#h2-0-177" id="h2-0-177" class="d">-           data.remoteAddress = req.connection.remoteAddress;
</a><a href="#h2-0-178" id="h2-0-178" class="d">-           send_feedback(data,
</a><a href="#h2-0-179" id="h2-0-179" class="d">-                         function (err) {
</a><a href="#h2-0-180" id="h2-0-180" class="d">-                           if (err) {
</a><a href="#h2-0-181" id="h2-0-181" class="d">-                             res.send(500);
</a><a href="#h2-0-182" id="h2-0-182" class="d">-                           } else {
</a><a href="#h2-0-183" id="h2-0-183" class="d">-                             res.send(200);
</a><a href="#h2-0-184" id="h2-0-184" class="d">-                           }
</a><a href="#h2-0-185" id="h2-0-185" class="d">-                         });
</a><a href="#h2-0-186" id="h2-0-186" class="d">-         });
</a><a href="#h2-0-187" id="h2-0-187" class="d">-
</a><a href="#h2-0-188" id="h2-0-188" class="d">-var server = http.createServer(app);
</a><a href="#h2-0-189" id="h2-0-189" class="d">-
</a><a href="#h2-0-190" id="h2-0-190" class="d">-server.listen(config.WEB_PORT);
</a><a href="#h2-0-191" id="h2-0-191" class="d">-console.log(&quot;Listening on :%d.&quot;, config.WEB_PORT);
</a><a href="#h2-0-192" id="h2-0-192" class="d">-
</a><a href="#h2-0-193" id="h2-0-193" class="d">-var io = require(&#39;socket.io&#39;).listen(server, {
</a><a href="#h2-0-194" id="h2-0-194" class="d">-                                       logger: log4js.getLogger(&#39;socket.io&#39;),
</a><a href="#h2-0-195" id="h2-0-195" class="d">-                                       &#39;log level&#39;: log4js.levels.INFO
</a><a href="#h2-0-196" id="h2-0-196" class="d">-                                     });
</a><a href="#h2-0-197" id="h2-0-197" class="d">-if (config.SOCKET_IO_TRANSPORTS)
</a><a href="#h2-0-198" id="h2-0-198" class="d">-  io.set(&#39;transports&#39;, config.SOCKET_IO_TRANSPORTS);
</a><a href="#h2-0-199" id="h2-0-199" class="d">-
</a><a href="#h2-0-200" id="h2-0-200" class="d">-var server = new Server(config, io);
</a><b>diff --git a/<a id="h3" href="../file/js/.gitignore">js/.gitignore</a> b/<a href="../file/js/.gitignore">js/.gitignore</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -1 +0,0 @@
</a><a href="#h3-0-0" id="h3-0-0" class="d">-config.local.js
</a><b>diff --git a/<a id="h4" href="../file/js/appserver.js">js/appserver.js</a> b/<a href="../file/js/appserver.js">js/appserver.js</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -1,337 +0,0 @@
</a><a href="#h4-0-0" id="h4-0-0" class="d">-var dnode  = require(&#39;dnode&#39;),
</a><a href="#h4-0-1" id="h4-0-1" class="d">-    fs     = require(&#39;fs&#39;),
</a><a href="#h4-0-2" id="h4-0-2" class="d">-    net    = require(&#39;net&#39;),
</a><a href="#h4-0-3" id="h4-0-3" class="d">-    log4js = require(&#39;log4js&#39;),
</a><a href="#h4-0-4" id="h4-0-4" class="d">-    util   = require(&#39;util&#39;),
</a><a href="#h4-0-5" id="h4-0-5" class="d">-    path   = require(&#39;path&#39;),
</a><a href="#h4-0-6" id="h4-0-6" class="d">-    _      = require(&#39;underscore&#39;),
</a><a href="#h4-0-7" id="h4-0-7" class="d">-    Batch  = require(&#39;./batch.js&#39;),
</a><a href="#h4-0-8" id="h4-0-8" class="d">-    QueryStats  = require(&#39;./lib/query-stats.js&#39;);
</a><a href="#h4-0-9" id="h4-0-9" class="d">-var logger  = log4js.getLogger(&#39;appserver&#39;);
</a><a href="#h4-0-10" id="h4-0-10" class="d">-
</a><a href="#h4-0-11" id="h4-0-11" class="d">-function remote_address(sock) {
</a><a href="#h4-0-12" id="h4-0-12" class="d">- if (sock.handshake.address)
</a><a href="#h4-0-13" id="h4-0-13" class="d">-   return sock.handshake.address;
</a><a href="#h4-0-14" id="h4-0-14" class="d">-  return {};
</a><a href="#h4-0-15" id="h4-0-15" class="d">-}
</a><a href="#h4-0-16" id="h4-0-16" class="d">-
</a><a href="#h4-0-17" id="h4-0-17" class="d">-function Client(parent, sock) {
</a><a href="#h4-0-18" id="h4-0-18" class="d">-  this.parent = parent;
</a><a href="#h4-0-19" id="h4-0-19" class="d">-  this.is_fast = true;
</a><a href="#h4-0-20" id="h4-0-20" class="d">-  this.socket = sock;
</a><a href="#h4-0-21" id="h4-0-21" class="d">-  this.pending_search = null;
</a><a href="#h4-0-22" id="h4-0-22" class="d">-  this.last_search = null;
</a><a href="#h4-0-23" id="h4-0-23" class="d">-  this.active_search = null;
</a><a href="#h4-0-24" id="h4-0-24" class="d">-  this.remote_address = remote_address(sock);
</a><a href="#h4-0-25" id="h4-0-25" class="d">-  this.fast_streak = 0;
</a><a href="#h4-0-26" id="h4-0-26" class="d">-  this.last_slow   = null;
</a><a href="#h4-0-27" id="h4-0-27" class="d">-}
</a><a href="#h4-0-28" id="h4-0-28" class="d">-
</a><a href="#h4-0-29" id="h4-0-29" class="d">-Client.prototype.pool = function(search) {
</a><a href="#h4-0-30" id="h4-0-30" class="d">-  return this.parent.pools[search.backend][this.is_fast ? &quot;fast&quot; : &quot;slow&quot;];
</a><a href="#h4-0-31" id="h4-0-31" class="d">-}
</a><a href="#h4-0-32" id="h4-0-32" class="d">-
</a><a href="#h4-0-33" id="h4-0-33" class="d">-Client.prototype.debug = function() {
</a><a href="#h4-0-34" id="h4-0-34" class="d">-  logger.debug(&quot;[%s:%d] %s&quot;,
</a><a href="#h4-0-35" id="h4-0-35" class="d">-               this.remote_address.address,
</a><a href="#h4-0-36" id="h4-0-36" class="d">-               this.remote_address.port,
</a><a href="#h4-0-37" id="h4-0-37" class="d">-               util.format.apply(null, arguments));
</a><a href="#h4-0-38" id="h4-0-38" class="d">-}
</a><a href="#h4-0-39" id="h4-0-39" class="d">-
</a><a href="#h4-0-40" id="h4-0-40" class="d">-Client.prototype.new_search = function (opts) {
</a><a href="#h4-0-41" id="h4-0-41" class="d">-  if (!this.parent.pools[opts.backend]) {
</a><a href="#h4-0-42" id="h4-0-42" class="d">-    opts.backend = Object.keys(this.parent.pools)[0];
</a><a href="#h4-0-43" id="h4-0-43" class="d">-  }
</a><a href="#h4-0-44" id="h4-0-44" class="d">-  this.debug(&#39;new search: %j&#39;, opts);
</a><a href="#h4-0-45" id="h4-0-45" class="d">-  if (this.last_search &amp;&amp;
</a><a href="#h4-0-46" id="h4-0-46" class="d">-      opts.line === this.last_search.line &amp;&amp;
</a><a href="#h4-0-47" id="h4-0-47" class="d">-      opts.file === this.last_search.file &amp;&amp;
</a><a href="#h4-0-48" id="h4-0-48" class="d">-      opts.repo === this.last_search.repo &amp;&amp;
</a><a href="#h4-0-49" id="h4-0-49" class="d">-      opts.backend === this.last_search.backend)
</a><a href="#h4-0-50" id="h4-0-50" class="d">-    return;
</a><a href="#h4-0-51" id="h4-0-51" class="d">-  if (opts.line === &#39;&#39;) {
</a><a href="#h4-0-52" id="h4-0-52" class="d">-    this.last_search = null;
</a><a href="#h4-0-53" id="h4-0-53" class="d">-    return;
</a><a href="#h4-0-54" id="h4-0-54" class="d">-  }
</a><a href="#h4-0-55" id="h4-0-55" class="d">-  this.pending_search = opts;
</a><a href="#h4-0-56" id="h4-0-56" class="d">-  this.dispatch_search();
</a><a href="#h4-0-57" id="h4-0-57" class="d">-}
</a><a href="#h4-0-58" id="h4-0-58" class="d">-
</a><a href="#h4-0-59" id="h4-0-59" class="d">-Client.prototype.search_done = function() {
</a><a href="#h4-0-60" id="h4-0-60" class="d">-  this.active_search = null;
</a><a href="#h4-0-61" id="h4-0-61" class="d">-  process.nextTick(this.dispatch_search.bind(this));
</a><a href="#h4-0-62" id="h4-0-62" class="d">-}
</a><a href="#h4-0-63" id="h4-0-63" class="d">-
</a><a href="#h4-0-64" id="h4-0-64" class="d">-Client.prototype.mark_fast = function(fast) {
</a><a href="#h4-0-65" id="h4-0-65" class="d">-  if (this.is_fast === fast)
</a><a href="#h4-0-66" id="h4-0-66" class="d">-    return;
</a><a href="#h4-0-67" id="h4-0-67" class="d">-  this.debug(&quot;Switching to %s pools&quot;, fast ? &quot;fast&quot; : &quot;slow&quot;);
</a><a href="#h4-0-68" id="h4-0-68" class="d">-  this.is_fast = fast;
</a><a href="#h4-0-69" id="h4-0-69" class="d">-}
</a><a href="#h4-0-70" id="h4-0-70" class="d">-
</a><a href="#h4-0-71" id="h4-0-71" class="d">-Client.prototype.slow_query = function() {
</a><a href="#h4-0-72" id="h4-0-72" class="d">-  this.last_slow = new Date();
</a><a href="#h4-0-73" id="h4-0-73" class="d">-  this.fast_streak = 0;
</a><a href="#h4-0-74" id="h4-0-74" class="d">-  this.mark_fast(false);
</a><a href="#h4-0-75" id="h4-0-75" class="d">-}
</a><a href="#h4-0-76" id="h4-0-76" class="d">-
</a><a href="#h4-0-77" id="h4-0-77" class="d">-Client.prototype.fast_query = function() {
</a><a href="#h4-0-78" id="h4-0-78" class="d">-  this.fast_streak++;
</a><a href="#h4-0-79" id="h4-0-79" class="d">-  if ((new Date() - this.last_slow) &lt; this.parent.config.MIN_SLOW_TIME)
</a><a href="#h4-0-80" id="h4-0-80" class="d">-    return;
</a><a href="#h4-0-81" id="h4-0-81" class="d">-  if (this.fast_streak &gt;= this.parent.config.QUERY_STREAK)
</a><a href="#h4-0-82" id="h4-0-82" class="d">-    this.mark_fast(true);
</a><a href="#h4-0-83" id="h4-0-83" class="d">-}
</a><a href="#h4-0-84" id="h4-0-84" class="d">-
</a><a href="#h4-0-85" id="h4-0-85" class="d">-Client.prototype.sort_matches = function(pool, matches) {
</a><a href="#h4-0-86" id="h4-0-86" class="d">-  var order =  {};
</a><a href="#h4-0-87" id="h4-0-87" class="d">-  for (var i = 0; i &lt; pool.backend.sort.length; i++)
</a><a href="#h4-0-88" id="h4-0-88" class="d">-    order[pool.backend.sort[i]] = i;
</a><a href="#h4-0-89" id="h4-0-89" class="d">-  function sort_order(path) {
</a><a href="#h4-0-90" id="h4-0-90" class="d">-    var dir = /^[^\/]+/.exec(path)[0];
</a><a href="#h4-0-91" id="h4-0-91" class="d">-    if (dir in order)
</a><a href="#h4-0-92" id="h4-0-92" class="d">-      return order[dir];
</a><a href="#h4-0-93" id="h4-0-93" class="d">-    return 1000;
</a><a href="#h4-0-94" id="h4-0-94" class="d">-  }
</a><a href="#h4-0-95" id="h4-0-95" class="d">-  i = 0;
</a><a href="#h4-0-96" id="h4-0-96" class="d">-  var annotated = matches.map(function (m) {
</a><a href="#h4-0-97" id="h4-0-97" class="d">-                                return {
</a><a href="#h4-0-98" id="h4-0-98" class="d">-                                  match: m,
</a><a href="#h4-0-99" id="h4-0-99" class="d">-                                  order: sort_order(m.file),
</a><a href="#h4-0-100" id="h4-0-100" class="d">-                                  index: i
</a><a href="#h4-0-101" id="h4-0-101" class="d">-                                }
</a><a href="#h4-0-102" id="h4-0-102" class="d">-                              });
</a><a href="#h4-0-103" id="h4-0-103" class="d">-  var sorted = annotated.sort(function (a,b) {
</a><a href="#h4-0-104" id="h4-0-104" class="d">-                                if (a.order != b.order)
</a><a href="#h4-0-105" id="h4-0-105" class="d">-                                  return a.order - b.order;
</a><a href="#h4-0-106" id="h4-0-106" class="d">-                                return a.index - b.index;
</a><a href="#h4-0-107" id="h4-0-107" class="d">-                              });
</a><a href="#h4-0-108" id="h4-0-108" class="d">-  return sorted.map(function (r) {return r.match});
</a><a href="#h4-0-109" id="h4-0-109" class="d">-}
</a><a href="#h4-0-110" id="h4-0-110" class="d">-
</a><a href="#h4-0-111" id="h4-0-111" class="d">-Client.prototype.dispatch_search = function() {
</a><a href="#h4-0-112" id="h4-0-112" class="d">-  if (this.pending_search === null || this.active_search)
</a><a href="#h4-0-113" id="h4-0-113" class="d">-    return;
</a><a href="#h4-0-114" id="h4-0-114" class="d">-  var pool = this.pool(this.pending_search);
</a><a href="#h4-0-115" id="h4-0-115" class="d">-  if (!pool.remotes)
</a><a href="#h4-0-116" id="h4-0-116" class="d">-    return;
</a><a href="#h4-0-117" id="h4-0-117" class="d">-
</a><a href="#h4-0-118" id="h4-0-118" class="d">-  if (this.last_slow &amp;&amp;
</a><a href="#h4-0-119" id="h4-0-119" class="d">-      (new Date() - this.last_slow) &gt;= this.parent.config.MAX_SLOW_TIME)
</a><a href="#h4-0-120" id="h4-0-120" class="d">-    this.mark_fast(true);
</a><a href="#h4-0-121" id="h4-0-121" class="d">-
</a><a href="#h4-0-122" id="h4-0-122" class="d">-  var codesearch = pool.remotes.pop();
</a><a href="#h4-0-123" id="h4-0-123" class="d">-  console.assert(codesearch.cs_ready);
</a><a href="#h4-0-124" id="h4-0-124" class="d">-  var start = new Date();
</a><a href="#h4-0-125" id="h4-0-125" class="d">-  this.last_search = this.pending_search;
</a><a href="#h4-0-126" id="h4-0-126" class="d">-  this.debug(&#39;dispatching: (%j) to %s-%d...&#39;,
</a><a href="#h4-0-127" id="h4-0-127" class="d">-    this.pending_search,
</a><a href="#h4-0-128" id="h4-0-128" class="d">-    pool.stats.name,
</a><a href="#h4-0-129" id="h4-0-129" class="d">-    codesearch.__id);
</a><a href="#h4-0-130" id="h4-0-130" class="d">-
</a><a href="#h4-0-131" id="h4-0-131" class="d">-  var search = this.pending_search;
</a><a href="#h4-0-132" id="h4-0-132" class="d">-  this.pending_search = null;
</a><a href="#h4-0-133" id="h4-0-133" class="d">-  this.active_search  = search;
</a><a href="#h4-0-134" id="h4-0-134" class="d">-  var self   = this;
</a><a href="#h4-0-135" id="h4-0-135" class="d">-  var sock   = this.socket;
</a><a href="#h4-0-136" id="h4-0-136" class="d">-  var batch  = new Batch(function (m) {
</a><a href="#h4-0-137" id="h4-0-137" class="d">-                           sock.emit(&#39;match&#39;, search.id, m);
</a><a href="#h4-0-138" id="h4-0-138" class="d">-                         }, 50,
</a><a href="#h4-0-139" id="h4-0-139" class="d">-                         function (matches) {
</a><a href="#h4-0-140" id="h4-0-140" class="d">-                           return self.sort_matches(pool, matches)
</a><a href="#h4-0-141" id="h4-0-141" class="d">-                         });
</a><a href="#h4-0-142" id="h4-0-142" class="d">-  var cbs = {
</a><a href="#h4-0-143" id="h4-0-143" class="d">-    not_ready: function() {
</a><a href="#h4-0-144" id="h4-0-144" class="d">-      logger.info(&#39;Remote reports not ready for %j&#39;, search);
</a><a href="#h4-0-145" id="h4-0-145" class="d">-      if (self.pending_search === null)
</a><a href="#h4-0-146" id="h4-0-146" class="d">-        self.pending_search = search;
</a><a href="#h4-0-147" id="h4-0-147" class="d">-      self.search_done();
</a><a href="#h4-0-148" id="h4-0-148" class="d">-      codesearch.cs_client = null;
</a><a href="#h4-0-149" id="h4-0-149" class="d">-    },
</a><a href="#h4-0-150" id="h4-0-150" class="d">-    error: function (err) {
</a><a href="#h4-0-151" id="h4-0-151" class="d">-      sock.emit(&#39;regex_error&#39;, search.id, err);
</a><a href="#h4-0-152" id="h4-0-152" class="d">-      self.search_done();
</a><a href="#h4-0-153" id="h4-0-153" class="d">-      codesearch.cs_client = null;
</a><a href="#h4-0-154" id="h4-0-154" class="d">-    },
</a><a href="#h4-0-155" id="h4-0-155" class="d">-    match: function (match) {
</a><a href="#h4-0-156" id="h4-0-156" class="d">-      match = JSON.parse(match);
</a><a href="#h4-0-157" id="h4-0-157" class="d">-      match.backend = search.backend;
</a><a href="#h4-0-158" id="h4-0-158" class="d">-      logger.trace(&quot;Reporting match %j for %j.&quot;, match, search);
</a><a href="#h4-0-159" id="h4-0-159" class="d">-      batch.send(match);
</a><a href="#h4-0-160" id="h4-0-160" class="d">-    },
</a><a href="#h4-0-161" id="h4-0-161" class="d">-    done: function (stats) {
</a><a href="#h4-0-162" id="h4-0-162" class="d">-      stats = JSON.parse(stats);
</a><a href="#h4-0-163" id="h4-0-163" class="d">-      var time = (new Date()) - start;
</a><a href="#h4-0-164" id="h4-0-164" class="d">-      pool.stats.done(search.id, start, time);
</a><a href="#h4-0-165" id="h4-0-165" class="d">-      batch.flush();
</a><a href="#h4-0-166" id="h4-0-166" class="d">-      sock.emit(&#39;search_done&#39;, search.id, time, stats.why);
</a><a href="#h4-0-167" id="h4-0-167" class="d">-      self.debug(&quot;Search done: (%j): %s&quot;, search, time);
</a><a href="#h4-0-168" id="h4-0-168" class="d">-      if (time &gt; self.parent.config.SLOW_THRESHOLD) {
</a><a href="#h4-0-169" id="h4-0-169" class="d">-        self.slow_query();
</a><a href="#h4-0-170" id="h4-0-170" class="d">-      } else {
</a><a href="#h4-0-171" id="h4-0-171" class="d">-        self.fast_query();
</a><a href="#h4-0-172" id="h4-0-172" class="d">-      }
</a><a href="#h4-0-173" id="h4-0-173" class="d">-      self.search_done();
</a><a href="#h4-0-174" id="h4-0-174" class="d">-      codesearch.cs_client = null;
</a><a href="#h4-0-175" id="h4-0-175" class="d">-    }
</a><a href="#h4-0-176" id="h4-0-176" class="d">-  }
</a><a href="#h4-0-177" id="h4-0-177" class="d">-  codesearch.try_search(search, cbs);
</a><a href="#h4-0-178" id="h4-0-178" class="d">-  codesearch.cs_ready = false;
</a><a href="#h4-0-179" id="h4-0-179" class="d">-  codesearch.cs_client = this;
</a><a href="#h4-0-180" id="h4-0-180" class="d">-}
</a><a href="#h4-0-181" id="h4-0-181" class="d">-
</a><a href="#h4-0-182" id="h4-0-182" class="d">-function ConnectionPool(server, name, backend) {
</a><a href="#h4-0-183" id="h4-0-183" class="d">-  var self = this;
</a><a href="#h4-0-184" id="h4-0-184" class="d">-  this.server  = server
</a><a href="#h4-0-185" id="h4-0-185" class="d">-  this.remotes = [];
</a><a href="#h4-0-186" id="h4-0-186" class="d">-  this.connections = [];
</a><a href="#h4-0-187" id="h4-0-187" class="d">-  this.stats       = new QueryStats(name, {timeout: 5*60*1000});
</a><a href="#h4-0-188" id="h4-0-188" class="d">-  this.stats.start();
</a><a href="#h4-0-189" id="h4-0-189" class="d">-  this.backend = backend;
</a><a href="#h4-0-190" id="h4-0-190" class="d">-
</a><a href="#h4-0-191" id="h4-0-191" class="d">-  var id = 0;
</a><a href="#h4-0-192" id="h4-0-192" class="d">-  for (var i = 0; i &lt; backend.connections; i++) {
</a><a href="#h4-0-193" id="h4-0-193" class="d">-    self.connect_to(backend, id++);
</a><a href="#h4-0-194" id="h4-0-194" class="d">-  }
</a><a href="#h4-0-195" id="h4-0-195" class="d">-}
</a><a href="#h4-0-196" id="h4-0-196" class="d">-
</a><a href="#h4-0-197" id="h4-0-197" class="d">-ConnectionPool.prototype.connect_to = function(bk, id) {
</a><a href="#h4-0-198" id="h4-0-198" class="d">-  var self = this;
</a><a href="#h4-0-199" id="h4-0-199" class="d">-  var remote = null;
</a><a href="#h4-0-200" id="h4-0-200" class="d">-  var delay = 100;
</a><a href="#h4-0-201" id="h4-0-201" class="d">-  var d = null;
</a><a href="#h4-0-202" id="h4-0-202" class="d">-  var stream = null;
</a><a href="#h4-0-203" id="h4-0-203" class="d">-  var me = id;
</a><a href="#h4-0-204" id="h4-0-204" class="d">-
</a><a href="#h4-0-205" id="h4-0-205" class="d">-  var ready = function() {
</a><a href="#h4-0-206" id="h4-0-206" class="d">-    if (!remote) return;
</a><a href="#h4-0-207" id="h4-0-207" class="d">-    logger.debug(&#39;Remote %s-%d ready (%d)!&#39;,
</a><a href="#h4-0-208" id="h4-0-208" class="d">-      self.stats.name, remote.__id, me);
</a><a href="#h4-0-209" id="h4-0-209" class="d">-    if (remote.cs_ready) {
</a><a href="#h4-0-210" id="h4-0-210" class="d">-      logger.debug(&#39;(already queued)!&#39;);
</a><a href="#h4-0-211" id="h4-0-211" class="d">-      return;
</a><a href="#h4-0-212" id="h4-0-212" class="d">-    }
</a><a href="#h4-0-213" id="h4-0-213" class="d">-    remote.cs_ready = true;
</a><a href="#h4-0-214" id="h4-0-214" class="d">-    self.remotes.push(remote);
</a><a href="#h4-0-215" id="h4-0-215" class="d">-    self.dispatch();
</a><a href="#h4-0-216" id="h4-0-216" class="d">-    delay = 100;
</a><a href="#h4-0-217" id="h4-0-217" class="d">-  }
</a><a href="#h4-0-218" id="h4-0-218" class="d">-
</a><a href="#h4-0-219" id="h4-0-219" class="d">-  var disconnected = function() {
</a><a href="#h4-0-220" id="h4-0-220" class="d">-    logger.info(&quot;Lost connection to backend (%s-%s). Reconnect in %d...&quot;,
</a><a href="#h4-0-221" id="h4-0-221" class="d">-      self.stats.name, remote ? remote.__id : &quot;??&quot;, delay);
</a><a href="#h4-0-222" id="h4-0-222" class="d">-    stream.end();
</a><a href="#h4-0-223" id="h4-0-223" class="d">-    self.remotes = self.remotes.filter(function (r) {return r !== remote});
</a><a href="#h4-0-224" id="h4-0-224" class="d">-    self.connections = self.connections.filter(
</a><a href="#h4-0-225" id="h4-0-225" class="d">-      function (c) { return c !== d});
</a><a href="#h4-0-226" id="h4-0-226" class="d">-    if (remote &amp;&amp; remote.cs_client)
</a><a href="#h4-0-227" id="h4-0-227" class="d">-      remote.cs_client.search_done();
</a><a href="#h4-0-228" id="h4-0-228" class="d">-    setTimeout(connect, delay)
</a><a href="#h4-0-229" id="h4-0-229" class="d">-    delay = Math.min(delay * 2, 60*1000);
</a><a href="#h4-0-230" id="h4-0-230" class="d">-  }
</a><a href="#h4-0-231" id="h4-0-231" class="d">-
</a><a href="#h4-0-232" id="h4-0-232" class="d">-  var connect = function() {
</a><a href="#h4-0-233" id="h4-0-233" class="d">-    d = dnode({ ready: ready });
</a><a href="#h4-0-234" id="h4-0-234" class="d">-    d.on(&#39;remote&#39;, function(r) {
</a><a href="#h4-0-235" id="h4-0-235" class="d">-           self.connections.push(d);
</a><a href="#h4-0-236" id="h4-0-236" class="d">-           remote = r;
</a><a href="#h4-0-237" id="h4-0-237" class="d">-           remote.__id = id;
</a><a href="#h4-0-238" id="h4-0-238" class="d">-           remote.cs_ready  = false;
</a><a href="#h4-0-239" id="h4-0-239" class="d">-           remote.cs_client = null;
</a><a href="#h4-0-240" id="h4-0-240" class="d">-           logger.info(&quot;Connected to codesearch daemon.&quot;);
</a><a href="#h4-0-241" id="h4-0-241" class="d">-         });
</a><a href="#h4-0-242" id="h4-0-242" class="d">-    d.on(&#39;ready&#39;,     ready);
</a><a href="#h4-0-243" id="h4-0-243" class="d">-    d.on(&#39;close&#39;,     disconnected);
</a><a href="#h4-0-244" id="h4-0-244" class="d">-    d.on(&#39;end&#39;,       disconnected);
</a><a href="#h4-0-245" id="h4-0-245" class="d">-    d.on(&#39;error&#39;,     disconnected);
</a><a href="#h4-0-246" id="h4-0-246" class="d">-    stream = net.connect({
</a><a href="#h4-0-247" id="h4-0-247" class="d">-                           host: bk.host,
</a><a href="#h4-0-248" id="h4-0-248" class="d">-                           port: bk.port
</a><a href="#h4-0-249" id="h4-0-249" class="d">-                         });
</a><a href="#h4-0-250" id="h4-0-250" class="d">-    stream.on(&#39;error&#39;,   disconnected);
</a><a href="#h4-0-251" id="h4-0-251" class="d">-    stream.pipe(d).pipe(stream);
</a><a href="#h4-0-252" id="h4-0-252" class="d">-  }
</a><a href="#h4-0-253" id="h4-0-253" class="d">-
</a><a href="#h4-0-254" id="h4-0-254" class="d">-  connect();
</a><a href="#h4-0-255" id="h4-0-255" class="d">-}
</a><a href="#h4-0-256" id="h4-0-256" class="d">-
</a><a href="#h4-0-257" id="h4-0-257" class="d">-ConnectionPool.prototype.dispatch = function () {
</a><a href="#h4-0-258" id="h4-0-258" class="d">-  var clients = this.clients;
</a><a href="#h4-0-259" id="h4-0-259" class="d">-  _.shuffle(_.values(this.clients)).forEach(
</a><a href="#h4-0-260" id="h4-0-260" class="d">-    function (client) {
</a><a href="#h4-0-261" id="h4-0-261" class="d">-      client.dispatch_search();
</a><a href="#h4-0-262" id="h4-0-262" class="d">-    });
</a><a href="#h4-0-263" id="h4-0-263" class="d">-}
</a><a href="#h4-0-264" id="h4-0-264" class="d">-
</a><a href="#h4-0-265" id="h4-0-265" class="d">-function SearchServer(config, io) {
</a><a href="#h4-0-266" id="h4-0-266" class="d">-  var self = this;
</a><a href="#h4-0-267" id="h4-0-267" class="d">-  this.config  = config;
</a><a href="#h4-0-268" id="h4-0-268" class="d">-  this.clients = {};
</a><a href="#h4-0-269" id="h4-0-269" class="d">-  this.pools   = {};
</a><a href="#h4-0-270" id="h4-0-270" class="d">-  Object.keys(config.BACKENDS).forEach(function (name) {
</a><a href="#h4-0-271" id="h4-0-271" class="d">-    var backend = config.BACKENDS[name];
</a><a href="#h4-0-272" id="h4-0-272" class="d">-    self.pools[name] = {
</a><a href="#h4-0-273" id="h4-0-273" class="d">-      fast: new ConnectionPool(self, &#39;fast-&#39; + name, backend),
</a><a href="#h4-0-274" id="h4-0-274" class="d">-      slow: new ConnectionPool(self, &#39;slow-&#39; + name, backend),
</a><a href="#h4-0-275" id="h4-0-275" class="d">-    }
</a><a href="#h4-0-276" id="h4-0-276" class="d">-  });
</a><a href="#h4-0-277" id="h4-0-277" class="d">-
</a><a href="#h4-0-278" id="h4-0-278" class="d">-  var Server = function (sock) {
</a><a href="#h4-0-279" id="h4-0-279" class="d">-    logger.info(&quot;New client (%s)[%j]&quot;, sock.id, remote_address(sock));
</a><a href="#h4-0-280" id="h4-0-280" class="d">-    self.clients[sock.id] = new Client(self, sock);
</a><a href="#h4-0-281" id="h4-0-281" class="d">-    sock.on(&#39;new_search&#39;, function(opts, file, id) {
</a><a href="#h4-0-282" id="h4-0-282" class="d">-              if (typeof(opts) == &#39;string&#39;) {
</a><a href="#h4-0-283" id="h4-0-283" class="d">-                // Compatibility with the old API
</a><a href="#h4-0-284" id="h4-0-284" class="d">-                opts = {
</a><a href="#h4-0-285" id="h4-0-285" class="d">-                  line: opts,
</a><a href="#h4-0-286" id="h4-0-286" class="d">-                  file: file,
</a><a href="#h4-0-287" id="h4-0-287" class="d">-                  id: id
</a><a href="#h4-0-288" id="h4-0-288" class="d">-                }
</a><a href="#h4-0-289" id="h4-0-289" class="d">-              }
</a><a href="#h4-0-290" id="h4-0-290" class="d">-              if (opts.id == null)
</a><a href="#h4-0-291" id="h4-0-291" class="d">-                opts.id = opts.line;
</a><a href="#h4-0-292" id="h4-0-292" class="d">-              self.clients[sock.id].new_search(opts);
</a><a href="#h4-0-293" id="h4-0-293" class="d">-    });
</a><a href="#h4-0-294" id="h4-0-294" class="d">-    sock.on(&#39;disconnect&#39;, function() {
</a><a href="#h4-0-295" id="h4-0-295" class="d">-              logger.info(&quot;Disconnected (%s)[%j]&quot;, sock.id, remote_address(sock));
</a><a href="#h4-0-296" id="h4-0-296" class="d">-              delete self.clients[sock.id];
</a><a href="#h4-0-297" id="h4-0-297" class="d">-            });
</a><a href="#h4-0-298" id="h4-0-298" class="d">-  };
</a><a href="#h4-0-299" id="h4-0-299" class="d">-
</a><a href="#h4-0-300" id="h4-0-300" class="d">-  io.sockets.on(&#39;connection&#39;, function(sock) {
</a><a href="#h4-0-301" id="h4-0-301" class="d">-    new Server(sock);
</a><a href="#h4-0-302" id="h4-0-302" class="d">-  });
</a><a href="#h4-0-303" id="h4-0-303" class="d">-  setInterval(function() {
</a><a href="#h4-0-304" id="h4-0-304" class="d">-                self.dump_stats();
</a><a href="#h4-0-305" id="h4-0-305" class="d">-              }, 30*1000);
</a><a href="#h4-0-306" id="h4-0-306" class="d">-}
</a><a href="#h4-0-307" id="h4-0-307" class="d">-
</a><a href="#h4-0-308" id="h4-0-308" class="d">-SearchServer.prototype.dump_stats = function() {
</a><a href="#h4-0-309" id="h4-0-309" class="d">-  var clients = 0, slow = 0, fast = 0;
</a><a href="#h4-0-310" id="h4-0-310" class="d">-  var self = this;
</a><a href="#h4-0-311" id="h4-0-311" class="d">-  _.values(this.clients).forEach(
</a><a href="#h4-0-312" id="h4-0-312" class="d">-    function (c){
</a><a href="#h4-0-313" id="h4-0-313" class="d">-      clients++;
</a><a href="#h4-0-314" id="h4-0-314" class="d">-      if (c.is_fast)
</a><a href="#h4-0-315" id="h4-0-315" class="d">-        fast++;
</a><a href="#h4-0-316" id="h4-0-316" class="d">-      else
</a><a href="#h4-0-317" id="h4-0-317" class="d">-        slow++;
</a><a href="#h4-0-318" id="h4-0-318" class="d">-    });
</a><a href="#h4-0-319" id="h4-0-319" class="d">-  logger.info(&quot;Clients/slow/fast: %d %d %d&quot;, clients, slow, fast);
</a><a href="#h4-0-320" id="h4-0-320" class="d">-  var stats = {};
</a><a href="#h4-0-321" id="h4-0-321" class="d">-  Object.keys(self.pools).forEach(function (name) {
</a><a href="#h4-0-322" id="h4-0-322" class="d">-    var pools = self.pools[name];
</a><a href="#h4-0-323" id="h4-0-323" class="d">-    stats[pools.slow.stats.name] = pools.slow.stats.stats();
</a><a href="#h4-0-324" id="h4-0-324" class="d">-    stats[pools.fast.stats.name] = pools.slow.stats.stats();
</a><a href="#h4-0-325" id="h4-0-325" class="d">-  });
</a><a href="#h4-0-326" id="h4-0-326" class="d">-  stats.server = {
</a><a href="#h4-0-327" id="h4-0-327" class="d">-    clients: clients,
</a><a href="#h4-0-328" id="h4-0-328" class="d">-    slow: slow,
</a><a href="#h4-0-329" id="h4-0-329" class="d">-    fast: fast
</a><a href="#h4-0-330" id="h4-0-330" class="d">-  };
</a><a href="#h4-0-331" id="h4-0-331" class="d">-  fs.writeFile(path.join(__dirname, &quot;../web/log/stats.json&quot;),
</a><a href="#h4-0-332" id="h4-0-332" class="d">-               JSON.stringify(stats) + &quot;\n&quot;,
</a><a href="#h4-0-333" id="h4-0-333" class="d">-               &quot;utf8&quot;);
</a><a href="#h4-0-334" id="h4-0-334" class="d">-}
</a><a href="#h4-0-335" id="h4-0-335" class="d">-
</a><a href="#h4-0-336" id="h4-0-336" class="d">-module.exports = SearchServer;
</a><b>diff --git a/<a id="h5" href="../file/js/backend.js">js/backend.js</a> b/<a href="../file/js/backend.js">js/backend.js</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -1,24 +0,0 @@
</a><a href="#h5-0-0" id="h5-0-0" class="d">-function addBackendOpt(config, parser) {
</a><a href="#h5-0-1" id="h5-0-1" class="d">-  if (Object.keys(config.BACKENDS).length &gt; 1) {
</a><a href="#h5-0-2" id="h5-0-2" class="d">-    parser.add([&#39;--backend&#39;, &#39;-b&#39;],
</a><a href="#h5-0-3" id="h5-0-3" class="d">-               {
</a><a href="#h5-0-4" id="h5-0-4" class="d">-                 type: &#39;string&#39;,
</a><a href="#h5-0-5" id="h5-0-5" class="d">-                 default: &#39;&#39;,
</a><a href="#h5-0-6" id="h5-0-6" class="d">-                 help: &#39;Which backend to index. Options: &#39; +
</a><a href="#h5-0-7" id="h5-0-7" class="d">-                     Object.keys(config.BACKENDS).join(&#39;,&#39;)
</a><a href="#h5-0-8" id="h5-0-8" class="d">-               });
</a><a href="#h5-0-9" id="h5-0-9" class="d">-  }
</a><a href="#h5-0-10" id="h5-0-10" class="d">-}
</a><a href="#h5-0-11" id="h5-0-11" class="d">-module.exports.addBackendOpt = addBackendOpt;
</a><a href="#h5-0-12" id="h5-0-12" class="d">-
</a><a href="#h5-0-13" id="h5-0-13" class="d">-function selectBackend(config, opts) {
</a><a href="#h5-0-14" id="h5-0-14" class="d">-  if(Object.keys(config.BACKENDS).length == 1)
</a><a href="#h5-0-15" id="h5-0-15" class="d">-    return config.BACKENDS[Object.keys(config.BACKENDS)[0]];
</a><a href="#h5-0-16" id="h5-0-16" class="d">-  var backend = config.BACKENDS[opts.options.backend || &#39;&#39;];
</a><a href="#h5-0-17" id="h5-0-17" class="d">-  if (!backend) {
</a><a href="#h5-0-18" id="h5-0-18" class="d">-    throw new Error(&quot;No such backend: &quot; + opts.options.backend);
</a><a href="#h5-0-19" id="h5-0-19" class="d">-  }
</a><a href="#h5-0-20" id="h5-0-20" class="d">-  return backend;
</a><a href="#h5-0-21" id="h5-0-21" class="d">-}
</a><a href="#h5-0-22" id="h5-0-22" class="d">-
</a><a href="#h5-0-23" id="h5-0-23" class="d">-module.exports.selectBackend = selectBackend;
</a><b>diff --git a/<a id="h6" href="../file/js/batch.js">js/batch.js</a> b/<a href="../file/js/batch.js">js/batch.js</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -1,29 +0,0 @@
</a><a href="#h6-0-0" id="h6-0-0" class="d">-function Batch(cb, interval, preprocess) {
</a><a href="#h6-0-1" id="h6-0-1" class="d">-  if (interval === undefined)
</a><a href="#h6-0-2" id="h6-0-2" class="d">-    interval = 10;
</a><a href="#h6-0-3" id="h6-0-3" class="d">-  this.cb         = cb;
</a><a href="#h6-0-4" id="h6-0-4" class="d">-  this.preprocess = preprocess;
</a><a href="#h6-0-5" id="h6-0-5" class="d">-  this.interval   = interval;
</a><a href="#h6-0-6" id="h6-0-6" class="d">-  this.results    = [];
</a><a href="#h6-0-7" id="h6-0-7" class="d">-  this.last_flush = new Date();
</a><a href="#h6-0-8" id="h6-0-8" class="d">-}
</a><a href="#h6-0-9" id="h6-0-9" class="d">-
</a><a href="#h6-0-10" id="h6-0-10" class="d">-Batch.prototype.send = function(r) {
</a><a href="#h6-0-11" id="h6-0-11" class="d">-  this.results.push(r);
</a><a href="#h6-0-12" id="h6-0-12" class="d">-  this.maybe_flush();
</a><a href="#h6-0-13" id="h6-0-13" class="d">-}
</a><a href="#h6-0-14" id="h6-0-14" class="d">-
</a><a href="#h6-0-15" id="h6-0-15" class="d">-Batch.prototype.maybe_flush = function(r) {
</a><a href="#h6-0-16" id="h6-0-16" class="d">-  if ((new Date() - this.last_flush) &gt; this.interval)
</a><a href="#h6-0-17" id="h6-0-17" class="d">-    this.flush();
</a><a href="#h6-0-18" id="h6-0-18" class="d">-}
</a><a href="#h6-0-19" id="h6-0-19" class="d">-
</a><a href="#h6-0-20" id="h6-0-20" class="d">-Batch.prototype.flush = function() {
</a><a href="#h6-0-21" id="h6-0-21" class="d">-  if (this.preprocess)
</a><a href="#h6-0-22" id="h6-0-22" class="d">-    this.results = this.preprocess(this.results);
</a><a href="#h6-0-23" id="h6-0-23" class="d">-  this.results.forEach(this.cb);
</a><a href="#h6-0-24" id="h6-0-24" class="d">-  this.results = [];
</a><a href="#h6-0-25" id="h6-0-25" class="d">-  this.last_flush = new Date();
</a><a href="#h6-0-26" id="h6-0-26" class="d">-}
</a><a href="#h6-0-27" id="h6-0-27" class="d">-
</a><a href="#h6-0-28" id="h6-0-28" class="d">-module.exports = Batch;
</a><b>diff --git a/<a id="h7" href="../file/js/codesearch.js">js/codesearch.js</a> b/<a href="../file/js/codesearch.js">js/codesearch.js</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -1,145 +0,0 @@
</a><a href="#h7-0-0" id="h7-0-0" class="d">-var spawn   = require(&#39;child_process&#39;).spawn,
</a><a href="#h7-0-1" id="h7-0-1" class="d">-    path    = require(&#39;path&#39;),
</a><a href="#h7-0-2" id="h7-0-2" class="d">-    carrier = require(&#39;carrier&#39;),
</a><a href="#h7-0-3" id="h7-0-3" class="d">-    util    = require(&#39;util&#39;),
</a><a href="#h7-0-4" id="h7-0-4" class="d">-    events  = require(&quot;events&quot;),
</a><a href="#h7-0-5" id="h7-0-5" class="d">-    fs      = require(&#39;fs&#39;),
</a><a href="#h7-0-6" id="h7-0-6" class="d">-    net     = require(&#39;net&#39;),
</a><a href="#h7-0-7" id="h7-0-7" class="d">-    temp    = require(&#39;temp&#39;),
</a><a href="#h7-0-8" id="h7-0-8" class="d">-    log4js  = require(&#39;log4js&#39;);
</a><a href="#h7-0-9" id="h7-0-9" class="d">-
</a><a href="#h7-0-10" id="h7-0-10" class="d">-var logger = log4js.getLogger(&#39;codesearch&#39;);
</a><a href="#h7-0-11" id="h7-0-11" class="d">-
</a><a href="#h7-0-12" id="h7-0-12" class="d">-var uniq = 0;
</a><a href="#h7-0-13" id="h7-0-13" class="d">-
</a><a href="#h7-0-14" id="h7-0-14" class="d">-function Codesearch(repo, refs, opts) {
</a><a href="#h7-0-15" id="h7-0-15" class="d">-  if (opts === null)
</a><a href="#h7-0-16" id="h7-0-16" class="d">-    opts = {};
</a><a href="#h7-0-17" id="h7-0-17" class="d">-  events.EventEmitter.call(this);
</a><a href="#h7-0-18" id="h7-0-18" class="d">-  var socket = path.join(temp.mkdirSync(&#39;codesearch&#39;), &#39;socket&#39;);
</a><a href="#h7-0-19" id="h7-0-19" class="d">-
</a><a href="#h7-0-20" id="h7-0-20" class="d">-  this.socket = socket;
</a><a href="#h7-0-21" id="h7-0-21" class="d">-  refs = refs || [&#39;HEAD&#39;];
</a><a href="#h7-0-22" id="h7-0-22" class="d">-  var spec = repo + &quot;:&quot; + refs.join(&quot;,&quot;);
</a><a href="#h7-0-23" id="h7-0-23" class="d">-  this.child = spawn(path.join(__dirname, &#39;..&#39;, &#39;codesearch&#39;),
</a><a href="#h7-0-24" id="h7-0-24" class="d">-                     [&#39;--json&#39;, &#39;--listen&#39;, socket].concat(
</a><a href="#h7-0-25" id="h7-0-25" class="d">-                       opts.args||[]).concat(spec),
</a><a href="#h7-0-26" id="h7-0-26" class="d">-                     {
</a><a href="#h7-0-27" id="h7-0-27" class="d">-                       customFds: [-1, 1, 2]
</a><a href="#h7-0-28" id="h7-0-28" class="d">-                     });
</a><a href="#h7-0-29" id="h7-0-29" class="d">-  this.child.on(&#39;exit&#39;, function(code) {
</a><a href="#h7-0-30" id="h7-0-30" class="d">-                  this.emit(&#39;error&#39;, &#39;Child exited with code &#39; + code);
</a><a href="#h7-0-31" id="h7-0-31" class="d">-                });
</a><a href="#h7-0-32" id="h7-0-32" class="d">-  var child = this.child;
</a><a href="#h7-0-33" id="h7-0-33" class="d">-  process.on(&#39;exit&#39;, function() {
</a><a href="#h7-0-34" id="h7-0-34" class="d">-               child.kill();
</a><a href="#h7-0-35" id="h7-0-35" class="d">-               fs.unlinkSync(socket);
</a><a href="#h7-0-36" id="h7-0-36" class="d">-               fs.rmdirSync(path.dirname(socket));
</a><a href="#h7-0-37" id="h7-0-37" class="d">-             });
</a><a href="#h7-0-38" id="h7-0-38" class="d">-}
</a><a href="#h7-0-39" id="h7-0-39" class="d">-util.inherits(Codesearch, events.EventEmitter);
</a><a href="#h7-0-40" id="h7-0-40" class="d">-
</a><a href="#h7-0-41" id="h7-0-41" class="d">-Codesearch.prototype.connect = function(cb) {
</a><a href="#h7-0-42" id="h7-0-42" class="d">-  var conn = new Connection(this);
</a><a href="#h7-0-43" id="h7-0-43" class="d">-  if (cb !== undefined)
</a><a href="#h7-0-44" id="h7-0-44" class="d">-    conn.on(&#39;connected&#39;, cb.bind(null, conn));
</a><a href="#h7-0-45" id="h7-0-45" class="d">-  return conn;
</a><a href="#h7-0-46" id="h7-0-46" class="d">-}
</a><a href="#h7-0-47" id="h7-0-47" class="d">-
</a><a href="#h7-0-48" id="h7-0-48" class="d">-function Connection(parent) {
</a><a href="#h7-0-49" id="h7-0-49" class="d">-  var self = this;
</a><a href="#h7-0-50" id="h7-0-50" class="d">-  self.parent = parent;
</a><a href="#h7-0-51" id="h7-0-51" class="d">-  self.id     = ++uniq;
</a><a href="#h7-0-52" id="h7-0-52" class="d">-  function connect() {
</a><a href="#h7-0-53" id="h7-0-53" class="d">-    if (!fs.existsSync(parent.socket)) {
</a><a href="#h7-0-54" id="h7-0-54" class="d">-      logger.debug(&quot;Waiting for daemon startup...&quot;);
</a><a href="#h7-0-55" id="h7-0-55" class="d">-      setTimeout(connect, 100);
</a><a href="#h7-0-56" id="h7-0-56" class="d">-      return;
</a><a href="#h7-0-57" id="h7-0-57" class="d">-    }
</a><a href="#h7-0-58" id="h7-0-58" class="d">-    self.socket = net.connect(
</a><a href="#h7-0-59" id="h7-0-59" class="d">-      parent.socket,
</a><a href="#h7-0-60" id="h7-0-60" class="d">-      function() {
</a><a href="#h7-0-61" id="h7-0-61" class="d">-        self.emit(&#39;connected&#39;);
</a><a href="#h7-0-62" id="h7-0-62" class="d">-        self.socket.setEncoding(&#39;utf8&#39;);
</a><a href="#h7-0-63" id="h7-0-63" class="d">-        carrier.carry(self.socket,
</a><a href="#h7-0-64" id="h7-0-64" class="d">-                      self.got_line.bind(self));
</a><a href="#h7-0-65" id="h7-0-65" class="d">-        self.readyState = &#39;init&#39;;
</a><a href="#h7-0-66" id="h7-0-66" class="d">-      });
</a><a href="#h7-0-67" id="h7-0-67" class="d">-  }
</a><a href="#h7-0-68" id="h7-0-68" class="d">-  connect();
</a><a href="#h7-0-69" id="h7-0-69" class="d">-
</a><a href="#h7-0-70" id="h7-0-70" class="d">-  self.readyState = &#39;connecting&#39;;
</a><a href="#h7-0-71" id="h7-0-71" class="d">-  self.current_search = null;
</a><a href="#h7-0-72" id="h7-0-72" class="d">-}
</a><a href="#h7-0-73" id="h7-0-73" class="d">-util.inherits(Connection, events.EventEmitter);
</a><a href="#h7-0-74" id="h7-0-74" class="d">-
</a><a href="#h7-0-75" id="h7-0-75" class="d">-Connection.prototype.search = function(str, file, repo) {
</a><a href="#h7-0-76" id="h7-0-76" class="d">-  var evt;
</a><a href="#h7-0-77" id="h7-0-77" class="d">-  logger.debug(&quot;[cs %s] search(%j)&quot;, this.id, {line: str, file: file, repo: repo});
</a><a href="#h7-0-78" id="h7-0-78" class="d">-  console.assert(this.readyState == &#39;ready&#39;);
</a><a href="#h7-0-79" id="h7-0-79" class="d">-  this.socket.write(JSON.stringify({line: str, file: file, repo: repo}) + &quot;\n&quot;);
</a><a href="#h7-0-80" id="h7-0-80" class="d">-  this.setState(&#39;searching&#39;);
</a><a href="#h7-0-81" id="h7-0-81" class="d">-
</a><a href="#h7-0-82" id="h7-0-82" class="d">-  evt = new events.EventEmitter();
</a><a href="#h7-0-83" id="h7-0-83" class="d">-  evt.search = {line: str, file: file};
</a><a href="#h7-0-84" id="h7-0-84" class="d">-  this.current_search = evt;
</a><a href="#h7-0-85" id="h7-0-85" class="d">-  return evt;
</a><a href="#h7-0-86" id="h7-0-86" class="d">-}
</a><a href="#h7-0-87" id="h7-0-87" class="d">-
</a><a href="#h7-0-88" id="h7-0-88" class="d">-Connection.prototype.got_line = function(line) {
</a><a href="#h7-0-89" id="h7-0-89" class="d">-  logger.trace(&quot;&lt; %s&quot;, line);
</a><a href="#h7-0-90" id="h7-0-90" class="d">-  this.handle_line[this.readyState].call(this, line);
</a><a href="#h7-0-91" id="h7-0-91" class="d">-}
</a><a href="#h7-0-92" id="h7-0-92" class="d">-
</a><a href="#h7-0-93" id="h7-0-93" class="d">-function expect_ready(line) {
</a><a href="#h7-0-94" id="h7-0-94" class="d">-  console.assert(line == &#39;READY&#39;);
</a><a href="#h7-0-95" id="h7-0-95" class="d">-  this.ready();
</a><a href="#h7-0-96" id="h7-0-96" class="d">-}
</a><a href="#h7-0-97" id="h7-0-97" class="d">-
</a><a href="#h7-0-98" id="h7-0-98" class="d">-Connection.prototype.handle_line = {
</a><a href="#h7-0-99" id="h7-0-99" class="d">-  &#39;init&#39;: expect_ready,
</a><a href="#h7-0-100" id="h7-0-100" class="d">-  &#39;searching&#39;: function (line) {
</a><a href="#h7-0-101" id="h7-0-101" class="d">-    var match;
</a><a href="#h7-0-102" id="h7-0-102" class="d">-    if (match = /^FATAL (.*)/.exec(line)) {
</a><a href="#h7-0-103" id="h7-0-103" class="d">-      this.error(match[1]);
</a><a href="#h7-0-104" id="h7-0-104" class="d">-    } else if (match = /^DONE\s*(.*)/.exec(line)) {
</a><a href="#h7-0-105" id="h7-0-105" class="d">-      var stats = JSON.parse(match[1]);
</a><a href="#h7-0-106" id="h7-0-106" class="d">-      this.current_search.emit(&#39;done&#39;, stats);
</a><a href="#h7-0-107" id="h7-0-107" class="d">-      this.endSearch();
</a><a href="#h7-0-108" id="h7-0-108" class="d">-    } else {
</a><a href="#h7-0-109" id="h7-0-109" class="d">-      this.match(line);
</a><a href="#h7-0-110" id="h7-0-110" class="d">-    }
</a><a href="#h7-0-111" id="h7-0-111" class="d">-  },
</a><a href="#h7-0-112" id="h7-0-112" class="d">-  &#39;search_done&#39;: expect_ready,
</a><a href="#h7-0-113" id="h7-0-113" class="d">-  &#39;ready&#39;: function () {
</a><a href="#h7-0-114" id="h7-0-114" class="d">-    console.assert(false);
</a><a href="#h7-0-115" id="h7-0-115" class="d">-  }
</a><a href="#h7-0-116" id="h7-0-116" class="d">-}
</a><a href="#h7-0-117" id="h7-0-117" class="d">-
</a><a href="#h7-0-118" id="h7-0-118" class="d">-Connection.prototype.ready = function() {
</a><a href="#h7-0-119" id="h7-0-119" class="d">-  logger.debug(&quot;[cs %s] ready&quot;, this.id);
</a><a href="#h7-0-120" id="h7-0-120" class="d">-  this.setState(&#39;ready&#39;);
</a><a href="#h7-0-121" id="h7-0-121" class="d">-  this.emit(&#39;ready&#39;);
</a><a href="#h7-0-122" id="h7-0-122" class="d">-}
</a><a href="#h7-0-123" id="h7-0-123" class="d">-
</a><a href="#h7-0-124" id="h7-0-124" class="d">-Connection.prototype.error = function(err) {
</a><a href="#h7-0-125" id="h7-0-125" class="d">-  this.current_search.emit(&#39;error&#39;, err);
</a><a href="#h7-0-126" id="h7-0-126" class="d">-  this.endSearch();
</a><a href="#h7-0-127" id="h7-0-127" class="d">-}
</a><a href="#h7-0-128" id="h7-0-128" class="d">-
</a><a href="#h7-0-129" id="h7-0-129" class="d">-Connection.prototype.endSearch = function() {
</a><a href="#h7-0-130" id="h7-0-130" class="d">-  logger.debug(&quot;[cs %s] search_done(%j)&quot;, this.id, this.current_search);
</a><a href="#h7-0-131" id="h7-0-131" class="d">-  this.setState(&#39;search_done&#39;);
</a><a href="#h7-0-132" id="h7-0-132" class="d">-  this.current_search = null;
</a><a href="#h7-0-133" id="h7-0-133" class="d">-}
</a><a href="#h7-0-134" id="h7-0-134" class="d">-
</a><a href="#h7-0-135" id="h7-0-135" class="d">-Connection.prototype.match = function(match) {
</a><a href="#h7-0-136" id="h7-0-136" class="d">-  var evt = JSON.parse(match);
</a><a href="#h7-0-137" id="h7-0-137" class="d">-  this.current_search.emit(&#39;match&#39;, evt);
</a><a href="#h7-0-138" id="h7-0-138" class="d">-}
</a><a href="#h7-0-139" id="h7-0-139" class="d">-
</a><a href="#h7-0-140" id="h7-0-140" class="d">-Connection.prototype.setState = function(state) {
</a><a href="#h7-0-141" id="h7-0-141" class="d">-  this.readyState = state;
</a><a href="#h7-0-142" id="h7-0-142" class="d">-}
</a><a href="#h7-0-143" id="h7-0-143" class="d">-
</a><a href="#h7-0-144" id="h7-0-144" class="d">-module.exports = Codesearch;
</a><b>diff --git a/<a id="h8" href="../file/js/config.js">js/config.js</a> b/<a href="../file/js/config.js">js/config.js</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -1,57 +0,0 @@
</a><a href="#h8-0-0" id="h8-0-0" class="d">-var path   = require(&#39;path&#39;),
</a><a href="#h8-0-1" id="h8-0-1" class="d">-    fs     = require(&#39;fs&#39;),
</a><a href="#h8-0-2" id="h8-0-2" class="d">-    log4js = require(&#39;log4js&#39;);
</a><a href="#h8-0-3" id="h8-0-3" class="d">-
</a><a href="#h8-0-4" id="h8-0-4" class="d">-var config = {
</a><a href="#h8-0-5" id="h8-0-5" class="d">-  WEB_PORT: 8910,
</a><a href="#h8-0-6" id="h8-0-6" class="d">-  BACKENDS: {&quot;&quot;: {
</a><a href="#h8-0-7" id="h8-0-7" class="d">-    host: &quot;localhost&quot;,
</a><a href="#h8-0-8" id="h8-0-8" class="d">-    port: 0xC5EA,
</a><a href="#h8-0-9" id="h8-0-9" class="d">-    connections: 4,
</a><a href="#h8-0-10" id="h8-0-10" class="d">-    index: path.join(__dirname, &quot;../../linux/codesearch.idx&quot;),
</a><a href="#h8-0-11" id="h8-0-11" class="d">-    name: &quot;linux&quot;,
</a><a href="#h8-0-12" id="h8-0-12" class="d">-    pretty_name: &quot;Linux v3.7&quot;,
</a><a href="#h8-0-13" id="h8-0-13" class="d">-    search_args: [],
</a><a href="#h8-0-14" id="h8-0-14" class="d">-    repos: [
</a><a href="#h8-0-15" id="h8-0-15" class="d">-      {
</a><a href="#h8-0-16" id="h8-0-16" class="d">-        path: path.join(__dirname, &quot;../../linux&quot;),
</a><a href="#h8-0-17" id="h8-0-17" class="d">-        name: &quot;&quot;,
</a><a href="#h8-0-18" id="h8-0-18" class="d">-        refs: [&quot;v3.7&quot;],
</a><a href="#h8-0-19" id="h8-0-19" class="d">-        github: &quot;torvalds/linux&quot;,
</a><a href="#h8-0-20" id="h8-0-20" class="d">-      }
</a><a href="#h8-0-21" id="h8-0-21" class="d">-    ],
</a><a href="#h8-0-22" id="h8-0-22" class="d">-    sort: &#39;include kernel mm fs arch&#39;.split(/\s+/),
</a><a href="#h8-0-23" id="h8-0-23" class="d">-  }},
</a><a href="#h8-0-24" id="h8-0-24" class="d">-  LOG4JS_CONFIG:   path.join(__dirname, &quot;log4js.json&quot;),
</a><a href="#h8-0-25" id="h8-0-25" class="d">-  SLOW_THRESHOLD:  300,
</a><a href="#h8-0-26" id="h8-0-26" class="d">-  MIN_SLOW_TIME:   2000,
</a><a href="#h8-0-27" id="h8-0-27" class="d">-  MAX_SLOW_TIME:   10000,
</a><a href="#h8-0-28" id="h8-0-28" class="d">-  QUERY_STREAK:    5,
</a><a href="#h8-0-29" id="h8-0-29" class="d">-  SMTP_CONFIG:     null,
</a><a href="#h8-0-30" id="h8-0-30" class="d">-};
</a><a href="#h8-0-31" id="h8-0-31" class="d">-
</a><a href="#h8-0-32" id="h8-0-32" class="d">-try {
</a><a href="#h8-0-33" id="h8-0-33" class="d">-  fs.statSync(path.join(__dirname, &#39;config.local.js&#39;));
</a><a href="#h8-0-34" id="h8-0-34" class="d">-  var local = require(&#39;./config.local.js&#39;);
</a><a href="#h8-0-35" id="h8-0-35" class="d">-  Object.keys(local).forEach(
</a><a href="#h8-0-36" id="h8-0-36" class="d">-    function (k){
</a><a href="#h8-0-37" id="h8-0-37" class="d">-      config[k] = local[k]
</a><a href="#h8-0-38" id="h8-0-38" class="d">-    })
</a><a href="#h8-0-39" id="h8-0-39" class="d">-} catch (e) {
</a><a href="#h8-0-40" id="h8-0-40" class="d">-}
</a><a href="#h8-0-41" id="h8-0-41" class="d">-
</a><a href="#h8-0-42" id="h8-0-42" class="d">-Object.keys(config.BACKENDS).forEach(function (k) {
</a><a href="#h8-0-43" id="h8-0-43" class="d">-  var backend = config.BACKENDS[k];
</a><a href="#h8-0-44" id="h8-0-44" class="d">-  if (backend.repos.length &gt; 1) {
</a><a href="#h8-0-45" id="h8-0-45" class="d">-    var seen = {};
</a><a href="#h8-0-46" id="h8-0-46" class="d">-    backend.repos.forEach(function (repo) {
</a><a href="#h8-0-47" id="h8-0-47" class="d">-      console.assert(repo.name);
</a><a href="#h8-0-48" id="h8-0-48" class="d">-      console.assert(!seen.hasOwnProperty(repo.name));
</a><a href="#h8-0-49" id="h8-0-49" class="d">-      seen[repo.name] = true;
</a><a href="#h8-0-50" id="h8-0-50" class="d">-    });
</a><a href="#h8-0-51" id="h8-0-51" class="d">-  }
</a><a href="#h8-0-52" id="h8-0-52" class="d">-});
</a><a href="#h8-0-53" id="h8-0-53" class="d">-
</a><a href="#h8-0-54" id="h8-0-54" class="d">-log4js.configure(config.LOG4JS_CONFIG);
</a><a href="#h8-0-55" id="h8-0-55" class="d">-
</a><a href="#h8-0-56" id="h8-0-56" class="d">-module.exports = config;
</a><b>diff --git a/<a id="h9" href="../file/js/git_util.js">js/git_util.js</a> b/<a href="../file/js/git_util.js">js/git_util.js</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -1,11 +0,0 @@
</a><a href="#h9-0-0" id="h9-0-0" class="d">-var execFile   = require(&#39;child_process&#39;).execFile;
</a><a href="#h9-0-1" id="h9-0-1" class="d">-
</a><a href="#h9-0-2" id="h9-0-2" class="d">-module.exports.rev_parse = function (repo, ref, cb) {
</a><a href="#h9-0-3" id="h9-0-3" class="d">-  execFile(&#39;git&#39;, [&#39;rev-parse&#39;, ref], {
</a><a href="#h9-0-4" id="h9-0-4" class="d">-             cwd: repo
</a><a href="#h9-0-5" id="h9-0-5" class="d">-           }, function (err, stdout, stderr) {
</a><a href="#h9-0-6" id="h9-0-6" class="d">-             if (err) return cb(err, null);
</a><a href="#h9-0-7" id="h9-0-7" class="d">-             var sha1 = stdout.trim();
</a><a href="#h9-0-8" id="h9-0-8" class="d">-             cb(null, sha1);
</a><a href="#h9-0-9" id="h9-0-9" class="d">-           })
</a><a href="#h9-0-10" id="h9-0-10" class="d">-}
</a><b>diff --git a/<a id="h10" href="../file/js/lib/parseopt.js">js/lib/parseopt.js</a> b/<a href="../file/js/lib/parseopt.js">js/lib/parseopt.js</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -1,22 +0,0 @@
</a><a href="#h10-0-0" id="h10-0-0" class="d">-var parseopt = require(&#39;parseopt&#39;);
</a><a href="#h10-0-1" id="h10-0-1" class="d">-
</a><a href="#h10-0-2" id="h10-0-2" class="d">-var OptionParser = function(opts) {
</a><a href="#h10-0-3" id="h10-0-3" class="d">-  var self = this;
</a><a href="#h10-0-4" id="h10-0-4" class="d">-  if (opts === undefined)
</a><a href="#h10-0-5" id="h10-0-5" class="d">-    opts = {};
</a><a href="#h10-0-6" id="h10-0-6" class="d">-  opts.options = opts.options || [];
</a><a href="#h10-0-7" id="h10-0-7" class="d">-  opts.options.push({
</a><a href="#h10-0-8" id="h10-0-8" class="d">-      names: [&#39;--help&#39;, &#39;-h&#39;],
</a><a href="#h10-0-9" id="h10-0-9" class="d">-      type: &#39;flag&#39;,
</a><a href="#h10-0-10" id="h10-0-10" class="d">-      help: &#39;Show this help message.&#39;,
</a><a href="#h10-0-11" id="h10-0-11" class="d">-      onOption: function (value) {
</a><a href="#h10-0-12" id="h10-0-12" class="d">-        self.usage();
</a><a href="#h10-0-13" id="h10-0-13" class="d">-        process.exit(0);
</a><a href="#h10-0-14" id="h10-0-14" class="d">-      }
</a><a href="#h10-0-15" id="h10-0-15" class="d">-  });
</a><a href="#h10-0-16" id="h10-0-16" class="d">-  parseopt.OptionParser.call(this, opts);
</a><a href="#h10-0-17" id="h10-0-17" class="d">-}
</a><a href="#h10-0-18" id="h10-0-18" class="d">-
</a><a href="#h10-0-19" id="h10-0-19" class="d">-OptionParser.prototype = new parseopt.OptionParser();
</a><a href="#h10-0-20" id="h10-0-20" class="d">-
</a><a href="#h10-0-21" id="h10-0-21" class="d">-module.exports.OptionParser = OptionParser;
</a><b>diff --git a/<a id="h11" href="../file/js/lib/query-stats.js">js/lib/query-stats.js</a> b/<a href="../file/js/lib/query-stats.js">js/lib/query-stats.js</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -1,81 +0,0 @@
</a><a href="#h11-0-0" id="h11-0-0" class="d">-var _ = require(&#39;underscore&#39;);
</a><a href="#h11-0-1" id="h11-0-1" class="d">-
</a><a href="#h11-0-2" id="h11-0-2" class="d">-var DEFAULT_DISPLAY_INTERVAL = 100;
</a><a href="#h11-0-3" id="h11-0-3" class="d">-
</a><a href="#h11-0-4" id="h11-0-4" class="d">-
</a><a href="#h11-0-5" id="h11-0-5" class="d">-function QueryStats(name, opts) {
</a><a href="#h11-0-6" id="h11-0-6" class="d">-  this.name    = name;
</a><a href="#h11-0-7" id="h11-0-7" class="d">-  this.records = [];
</a><a href="#h11-0-8" id="h11-0-8" class="d">-  this.queries = 0;
</a><a href="#h11-0-9" id="h11-0-9" class="d">-  this.options = opts;
</a><a href="#h11-0-10" id="h11-0-10" class="d">-  this.start_time   = null;
</a><a href="#h11-0-11" id="h11-0-11" class="d">-  if (!(&#39;interval&#39; in this.options))
</a><a href="#h11-0-12" id="h11-0-12" class="d">-    this.options.interval = DEFAULT_DISPLAY_INTERVAL;
</a><a href="#h11-0-13" id="h11-0-13" class="d">-}
</a><a href="#h11-0-14" id="h11-0-14" class="d">-
</a><a href="#h11-0-15" id="h11-0-15" class="d">-QueryStats.prototype.start = function(id) {
</a><a href="#h11-0-16" id="h11-0-16" class="d">-  if (this.start_time === null)
</a><a href="#h11-0-17" id="h11-0-17" class="d">-    this.start_time = new Date();
</a><a href="#h11-0-18" id="h11-0-18" class="d">-}
</a><a href="#h11-0-19" id="h11-0-19" class="d">-
</a><a href="#h11-0-20" id="h11-0-20" class="d">-
</a><a href="#h11-0-21" id="h11-0-21" class="d">-QueryStats.prototype.prune_old = function(recs) {
</a><a href="#h11-0-22" id="h11-0-22" class="d">-  if (!this.options.timeout)
</a><a href="#h11-0-23" id="h11-0-23" class="d">-    return;
</a><a href="#h11-0-24" id="h11-0-24" class="d">-  var now = new Date();
</a><a href="#h11-0-25" id="h11-0-25" class="d">-  while (recs.length &amp;&amp; (now - recs[0].end) &gt; this.options.timeout)
</a><a href="#h11-0-26" id="h11-0-26" class="d">-    recs.shift(1);
</a><a href="#h11-0-27" id="h11-0-27" class="d">-}
</a><a href="#h11-0-28" id="h11-0-28" class="d">-
</a><a href="#h11-0-29" id="h11-0-29" class="d">-QueryStats.prototype.done = function(id, start, server_time) {
</a><a href="#h11-0-30" id="h11-0-30" class="d">-  var now = new Date();
</a><a href="#h11-0-31" id="h11-0-31" class="d">-  var rec = {
</a><a href="#h11-0-32" id="h11-0-32" class="d">-    id: id,
</a><a href="#h11-0-33" id="h11-0-33" class="d">-    time: now - start,
</a><a href="#h11-0-34" id="h11-0-34" class="d">-    server_time: server_time,
</a><a href="#h11-0-35" id="h11-0-35" class="d">-    start: start,
</a><a href="#h11-0-36" id="h11-0-36" class="d">-    end: now,
</a><a href="#h11-0-37" id="h11-0-37" class="d">-  };
</a><a href="#h11-0-38" id="h11-0-38" class="d">-  this.records.push(rec);
</a><a href="#h11-0-39" id="h11-0-39" class="d">-  this.queries++;
</a><a href="#h11-0-40" id="h11-0-40" class="d">-
</a><a href="#h11-0-41" id="h11-0-41" class="d">-  return (this.queries % this.options.interval) === 0;
</a><a href="#h11-0-42" id="h11-0-42" class="d">-}
</a><a href="#h11-0-43" id="h11-0-43" class="d">-
</a><a href="#h11-0-44" id="h11-0-44" class="d">-QueryStats.prototype.get_percentile = function (field, out) {
</a><a href="#h11-0-45" id="h11-0-45" class="d">-  var qs = _(this.records).sortBy(
</a><a href="#h11-0-46" id="h11-0-46" class="d">-    function (r) {
</a><a href="#h11-0-47" id="h11-0-47" class="d">-      return r[field];
</a><a href="#h11-0-48" id="h11-0-48" class="d">-    });
</a><a href="#h11-0-49" id="h11-0-49" class="d">-
</a><a href="#h11-0-50" id="h11-0-50" class="d">-  [50, 90, 95, 99].forEach(
</a><a href="#h11-0-51" id="h11-0-51" class="d">-    function (n) {
</a><a href="#h11-0-52" id="h11-0-52" class="d">-      if (qs.length)
</a><a href="#h11-0-53" id="h11-0-53" class="d">-        out[n] = qs[Math.floor(n/100 * qs.length)][field];
</a><a href="#h11-0-54" id="h11-0-54" class="d">-      else
</a><a href="#h11-0-55" id="h11-0-55" class="d">-        out[n] = 0;
</a><a href="#h11-0-56" id="h11-0-56" class="d">-    });
</a><a href="#h11-0-57" id="h11-0-57" class="d">-}
</a><a href="#h11-0-58" id="h11-0-58" class="d">-
</a><a href="#h11-0-59" id="h11-0-59" class="d">-QueryStats.prototype.stats = function() {
</a><a href="#h11-0-60" id="h11-0-60" class="d">-  var stats = {percentile: {},
</a><a href="#h11-0-61" id="h11-0-61" class="d">-               srv_percentile: {}};
</a><a href="#h11-0-62" id="h11-0-62" class="d">-
</a><a href="#h11-0-63" id="h11-0-63" class="d">-  this.prune_old(this.records);
</a><a href="#h11-0-64" id="h11-0-64" class="d">-
</a><a href="#h11-0-65" id="h11-0-65" class="d">-  this.get_percentile(&#39;time&#39;, stats.percentile);
</a><a href="#h11-0-66" id="h11-0-66" class="d">-  this.get_percentile(&#39;server_time&#39;, stats.srv_percentile);
</a><a href="#h11-0-67" id="h11-0-67" class="d">-
</a><a href="#h11-0-68" id="h11-0-68" class="d">-  stats.queries = this.queries;
</a><a href="#h11-0-69" id="h11-0-69" class="d">-
</a><a href="#h11-0-70" id="h11-0-70" class="d">-  var start = this.start_time;
</a><a href="#h11-0-71" id="h11-0-71" class="d">-  if (this.options.timeout) {
</a><a href="#h11-0-72" id="h11-0-72" class="d">-    start = Math.max(this.start_time, new Date() - this.options.timeout);
</a><a href="#h11-0-73" id="h11-0-73" class="d">-  }
</a><a href="#h11-0-74" id="h11-0-74" class="d">-
</a><a href="#h11-0-75" id="h11-0-75" class="d">-  stats.qps = 1000 * this.records.length / (new Date() - start);
</a><a href="#h11-0-76" id="h11-0-76" class="d">-
</a><a href="#h11-0-77" id="h11-0-77" class="d">-  return stats;
</a><a href="#h11-0-78" id="h11-0-78" class="d">-}
</a><a href="#h11-0-79" id="h11-0-79" class="d">-
</a><a href="#h11-0-80" id="h11-0-80" class="d">-module.exports = QueryStats;
</a><b>diff --git a/<a id="h12" href="../file/js/lib/stats.js">js/lib/stats.js</a> b/<a href="../file/js/lib/stats.js">js/lib/stats.js</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -1,20 +0,0 @@
</a><a href="#h12-0-0" id="h12-0-0" class="d">-function sum(lst) {
</a><a href="#h12-0-1" id="h12-0-1" class="d">-  var sum = 0;
</a><a href="#h12-0-2" id="h12-0-2" class="d">-  lst.forEach(function (e) {sum += e;});
</a><a href="#h12-0-3" id="h12-0-3" class="d">-  return sum;
</a><a href="#h12-0-4" id="h12-0-4" class="d">-}
</a><a href="#h12-0-5" id="h12-0-5" class="d">-
</a><a href="#h12-0-6" id="h12-0-6" class="d">-function mean(lst) {
</a><a href="#h12-0-7" id="h12-0-7" class="d">-  return sum(lst) / lst.length;
</a><a href="#h12-0-8" id="h12-0-8" class="d">-}
</a><a href="#h12-0-9" id="h12-0-9" class="d">-
</a><a href="#h12-0-10" id="h12-0-10" class="d">-function stdev(lst) {
</a><a href="#h12-0-11" id="h12-0-11" class="d">-  var m = mean(lst);
</a><a href="#h12-0-12" id="h12-0-12" class="d">-  return Math.sqrt(
</a><a href="#h12-0-13" id="h12-0-13" class="d">-    sum(lst.map(function (e) {return (e - m) * (e - m);}))
</a><a href="#h12-0-14" id="h12-0-14" class="d">-      / (lst.length - 1));
</a><a href="#h12-0-15" id="h12-0-15" class="d">-}
</a><a href="#h12-0-16" id="h12-0-16" class="d">-
</a><a href="#h12-0-17" id="h12-0-17" class="d">-module.exports.sum = sum;
</a><a href="#h12-0-18" id="h12-0-18" class="d">-module.exports.mean = mean;
</a><a href="#h12-0-19" id="h12-0-19" class="d">-module.exports.stdev = stdev;
</a><b>diff --git a/<a id="h13" href="../file/js/log4js.json">js/log4js.json</a> b/<a href="../file/js/log4js.json">js/log4js.json</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -1,45 +0,0 @@
</a><a href="#h13-0-0" id="h13-0-0" class="d">-{
</a><a href="#h13-0-1" id="h13-0-1" class="d">-  &quot;appenders&quot;: [
</a><a href="#h13-0-2" id="h13-0-2" class="d">-    {
</a><a href="#h13-0-3" id="h13-0-3" class="d">-      &quot;type&quot;: &quot;logLevelFilter&quot;,
</a><a href="#h13-0-4" id="h13-0-4" class="d">-      &quot;level&quot;: &quot;INFO&quot;,
</a><a href="#h13-0-5" id="h13-0-5" class="d">-      &quot;appender&quot;: {
</a><a href="#h13-0-6" id="h13-0-6" class="d">-        &quot;type&quot;: &quot;console&quot;,
</a><a href="#h13-0-7" id="h13-0-7" class="d">-        &quot;layout&quot;: {
</a><a href="#h13-0-8" id="h13-0-8" class="d">-          &quot;type&quot;: &quot;colored&quot;
</a><a href="#h13-0-9" id="h13-0-9" class="d">-        }
</a><a href="#h13-0-10" id="h13-0-10" class="d">-      }
</a><a href="#h13-0-11" id="h13-0-11" class="d">-    },
</a><a href="#h13-0-12" id="h13-0-12" class="d">-    {
</a><a href="#h13-0-13" id="h13-0-13" class="d">-      &quot;type&quot;: &quot;file&quot;,
</a><a href="#h13-0-14" id="h13-0-14" class="d">-      &quot;filename&quot;: &quot;web/log/codesearch.log&quot;,
</a><a href="#h13-0-15" id="h13-0-15" class="d">-      &quot;category&quot;: &quot;codesearch&quot;,
</a><a href="#h13-0-16" id="h13-0-16" class="d">-      &quot;level&quot;: &quot;DEBUG&quot;,
</a><a href="#h13-0-17" id="h13-0-17" class="d">-      &quot;layout&quot;: {
</a><a href="#h13-0-18" id="h13-0-18" class="d">-        &quot;type&quot;: &quot;basic&quot;
</a><a href="#h13-0-19" id="h13-0-19" class="d">-      }
</a><a href="#h13-0-20" id="h13-0-20" class="d">-    },
</a><a href="#h13-0-21" id="h13-0-21" class="d">-    {
</a><a href="#h13-0-22" id="h13-0-22" class="d">-      &quot;type&quot;: &quot;file&quot;,
</a><a href="#h13-0-23" id="h13-0-23" class="d">-      &quot;filename&quot;: &quot;web/log/appserver.log&quot;,
</a><a href="#h13-0-24" id="h13-0-24" class="d">-      &quot;category&quot;: &quot;appserver&quot;,
</a><a href="#h13-0-25" id="h13-0-25" class="d">-      &quot;level&quot;: &quot;DEBUG&quot;,
</a><a href="#h13-0-26" id="h13-0-26" class="d">-      &quot;layout&quot;: {
</a><a href="#h13-0-27" id="h13-0-27" class="d">-        &quot;type&quot;: &quot;basic&quot;
</a><a href="#h13-0-28" id="h13-0-28" class="d">-      }
</a><a href="#h13-0-29" id="h13-0-29" class="d">-    },
</a><a href="#h13-0-30" id="h13-0-30" class="d">-    {
</a><a href="#h13-0-31" id="h13-0-31" class="d">-      &quot;type&quot;: &quot;file&quot;,
</a><a href="#h13-0-32" id="h13-0-32" class="d">-      &quot;filename&quot;: &quot;web/log/socket.io.log&quot;,
</a><a href="#h13-0-33" id="h13-0-33" class="d">-      &quot;category&quot;: &quot;socket.io&quot;,
</a><a href="#h13-0-34" id="h13-0-34" class="d">-      &quot;level&quot;: &quot;DEBUG&quot;,
</a><a href="#h13-0-35" id="h13-0-35" class="d">-      &quot;layout&quot;: {
</a><a href="#h13-0-36" id="h13-0-36" class="d">-        &quot;type&quot;: &quot;basic&quot;
</a><a href="#h13-0-37" id="h13-0-37" class="d">-      }
</a><a href="#h13-0-38" id="h13-0-38" class="d">-    }
</a><a href="#h13-0-39" id="h13-0-39" class="d">-  ],
</a><a href="#h13-0-40" id="h13-0-40" class="d">-  &quot;levels&quot;: {
</a><a href="#h13-0-41" id="h13-0-41" class="d">-    &quot;appserver&quot;:  &quot;DEBUG&quot;,
</a><a href="#h13-0-42" id="h13-0-42" class="d">-    &quot;codesearch&quot;: &quot;DEBUG&quot;
</a><a href="#h13-0-43" id="h13-0-43" class="d">-  }
</a><a href="#h13-0-44" id="h13-0-44" class="d">-}
</a><b>diff --git a/<a id="h14" href="../file/js/parse-log.js">js/parse-log.js</a> b/<a href="../file/js/parse-log.js">js/parse-log.js</a></b>
<a href="#h14-0" id="h14-0" class="h">@@ -1,56 +0,0 @@
</a><a href="#h14-0-0" id="h14-0-0" class="d">-&quot;use strict&quot;;
</a><a href="#h14-0-1" id="h14-0-1" class="d">-
</a><a href="#h14-0-2" id="h14-0-2" class="d">-var sqlite3 = require(&#39;sqlite3&#39;).verbose(),
</a><a href="#h14-0-3" id="h14-0-3" class="d">-    carrier = require(&#39;carrier&#39;),
</a><a href="#h14-0-4" id="h14-0-4" class="d">-    fs      = require(&#39;fs&#39;);
</a><a href="#h14-0-5" id="h14-0-5" class="d">-var db;
</a><a href="#h14-0-6" id="h14-0-6" class="d">-
</a><a href="#h14-0-7" id="h14-0-7" class="d">-function go() {
</a><a href="#h14-0-8" id="h14-0-8" class="d">-  db.run(
</a><a href="#h14-0-9" id="h14-0-9" class="d">-&#39;CREATE TABLE IF NOT EXISTS query_log (\n&#39; +
</a><a href="#h14-0-10" id="h14-0-10" class="d">-&#39;  query_time TIMESTAMP, \n&#39; +
</a><a href="#h14-0-11" id="h14-0-11" class="d">-&#39;  line VARCHAR(255), \n&#39; +
</a><a href="#h14-0-12" id="h14-0-12" class="d">-&#39;  file VARCHAR(255), \n&#39; +
</a><a href="#h14-0-13" id="h14-0-13" class="d">-&#39;  remote_ip VARCHAR(255), \n&#39; +
</a><a href="#h14-0-14" id="h14-0-14" class="d">-&#39;  search_time INT \n&#39; +
</a><a href="#h14-0-15" id="h14-0-15" class="d">-&#39;); \n&#39;, insert_data)
</a><a href="#h14-0-16" id="h14-0-16" class="d">-}
</a><a href="#h14-0-17" id="h14-0-17" class="d">-
</a><a href="#h14-0-18" id="h14-0-18" class="d">-function insert_data() {
</a><a href="#h14-0-19" id="h14-0-19" class="d">-  var stream = fs.createReadStream(process.argv[2], {
</a><a href="#h14-0-20" id="h14-0-20" class="d">-                                     encoding: &#39;utf8&#39;
</a><a href="#h14-0-21" id="h14-0-21" class="d">-                                   });
</a><a href="#h14-0-22" id="h14-0-22" class="d">-  var stmt = db.prepare(&#39;INSERT INTO query_log VALUES (?, ?, ?, ?, ?)&#39;);
</a><a href="#h14-0-23" id="h14-0-23" class="d">-  var re = /^\[(\d{4}-\d{2}-\d{2} \d\d:\d\d:\d\d\.\d\d\d)\] \[DEBUG\] appserver - \[([0-9.]+):\d+\] Search done: \((.*)\): (\d+)/;
</a><a href="#h14-0-24" id="h14-0-24" class="d">-  var ct = 0;
</a><a href="#h14-0-25" id="h14-0-25" class="d">-  function handle_one(line) {
</a><a href="#h14-0-26" id="h14-0-26" class="d">-    var m = re.exec(line);
</a><a href="#h14-0-27" id="h14-0-27" class="d">-    if (!m)
</a><a href="#h14-0-28" id="h14-0-28" class="d">-      return;
</a><a href="#h14-0-29" id="h14-0-29" class="d">-    var ts = m[1],
</a><a href="#h14-0-30" id="h14-0-30" class="d">-        ip = m[2],
</a><a href="#h14-0-31" id="h14-0-31" class="d">-        q  = m[3],
</a><a href="#h14-0-32" id="h14-0-32" class="d">-        ms = parseInt(m[4]);
</a><a href="#h14-0-33" id="h14-0-33" class="d">-    try {
</a><a href="#h14-0-34" id="h14-0-34" class="d">-      q = JSON.parse(q);
</a><a href="#h14-0-35" id="h14-0-35" class="d">-    } catch(e) {
</a><a href="#h14-0-36" id="h14-0-36" class="d">-      console.error(&quot;parse error: %s: %s&quot;, q, e);
</a><a href="#h14-0-37" id="h14-0-37" class="d">-      return;
</a><a href="#h14-0-38" id="h14-0-38" class="d">-    }
</a><a href="#h14-0-39" id="h14-0-39" class="d">-    stmt.run(ts, q.line, q.file, ip, ms);
</a><a href="#h14-0-40" id="h14-0-40" class="d">-    if (0 == (++ct % 1000))
</a><a href="#h14-0-41" id="h14-0-41" class="d">-      console.log(&quot;%d...&quot;, ct);
</a><a href="#h14-0-42" id="h14-0-42" class="d">-  }
</a><a href="#h14-0-43" id="h14-0-43" class="d">-  carrier.carry(stream, handle_one);
</a><a href="#h14-0-44" id="h14-0-44" class="d">-  stream.on(&#39;end&#39;, function() {
</a><a href="#h14-0-45" id="h14-0-45" class="d">-              stmt.finalize(done);
</a><a href="#h14-0-46" id="h14-0-46" class="d">-            });
</a><a href="#h14-0-47" id="h14-0-47" class="d">-}
</a><a href="#h14-0-48" id="h14-0-48" class="d">-
</a><a href="#h14-0-49" id="h14-0-49" class="d">-function done() {
</a><a href="#h14-0-50" id="h14-0-50" class="d">-  console.log(&quot;Done.&quot;);
</a><a href="#h14-0-51" id="h14-0-51" class="d">-  db.close()
</a><a href="#h14-0-52" id="h14-0-52" class="d">-  process.exit(0);
</a><a href="#h14-0-53" id="h14-0-53" class="d">-}
</a><a href="#h14-0-54" id="h14-0-54" class="d">-
</a><a href="#h14-0-55" id="h14-0-55" class="d">-db = new sqlite3.Database(&#39;logs.sqlite&#39;, go);
</a><b>diff --git a/<a id="h15" href="../file/js/util.js">js/util.js</a> b/<a href="../file/js/util.js">js/util.js</a></b>
<a href="#h15-0" id="h15-0" class="h">@@ -1,23 +0,0 @@
</a><a href="#h15-0-0" id="h15-0-0" class="d">-/*
</a><a href="#h15-0-1" id="h15-0-1" class="d">- * Used to invoke callbacks on remote objects, where they may or may not provide
</a><a href="#h15-0-2" id="h15-0-2" class="d">- * a method of the appropriate name, or may provide something that is not even a
</a><a href="#h15-0-3" id="h15-0-3" class="d">- * function.
</a><a href="#h15-0-4" id="h15-0-4" class="d">- *
</a><a href="#h15-0-5" id="h15-0-5" class="d">- * An alternate approach would be to validate remote objects as soon as we get
</a><a href="#h15-0-6" id="h15-0-6" class="d">- * them, but that seems more error-prone, especially during prototyping.
</a><a href="#h15-0-7" id="h15-0-7" class="d">- */
</a><a href="#h15-0-8" id="h15-0-8" class="d">-function remote_call(obj, fn) {
</a><a href="#h15-0-9" id="h15-0-9" class="d">-  var args = Array.prototype.slice.call(arguments, 2);
</a><a href="#h15-0-10" id="h15-0-10" class="d">-  try {
</a><a href="#h15-0-11" id="h15-0-11" class="d">-    obj[fn].apply(obj, args.map(function (a) {
</a><a href="#h15-0-12" id="h15-0-12" class="d">-                                  if (typeof a === &#39;object&#39;)
</a><a href="#h15-0-13" id="h15-0-13" class="d">-                                    a = JSON.stringify(a);
</a><a href="#h15-0-14" id="h15-0-14" class="d">-                                  return a;
</a><a href="#h15-0-15" id="h15-0-15" class="d">-                                }));
</a><a href="#h15-0-16" id="h15-0-16" class="d">-  } catch (e) {
</a><a href="#h15-0-17" id="h15-0-17" class="d">-    console.warn(&quot;remote_call: %s: %s&quot;, fn, e);
</a><a href="#h15-0-18" id="h15-0-18" class="d">-    console.trace();
</a><a href="#h15-0-19" id="h15-0-19" class="d">-  }
</a><a href="#h15-0-20" id="h15-0-20" class="d">-}
</a><a href="#h15-0-21" id="h15-0-21" class="d">-
</a><a href="#h15-0-22" id="h15-0-22" class="d">-module.exports.remote_call = remote_call;
</a><b>diff --git a/<a id="h16" href="../file/package.json">package.json</a> b/<a href="../file/package.json">package.json</a></b>
<a href="#h16-0" id="h16-0" class="h">@@ -1,24 +0,0 @@
</a><a href="#h16-0-0" id="h16-0-0" class="d">-{
</a><a href="#h16-0-1" id="h16-0-1" class="d">-  &quot;name&quot;: &quot;codesearch&quot;,
</a><a href="#h16-0-2" id="h16-0-2" class="d">-  &quot;description&quot;: &quot;Live grep!&quot;,
</a><a href="#h16-0-3" id="h16-0-3" class="d">-  &quot;version&quot;: &quot;0.1.0&quot;,
</a><a href="#h16-0-4" id="h16-0-4" class="d">-  &quot;keywords&quot;: [],
</a><a href="#h16-0-5" id="h16-0-5" class="d">-  &quot;maintainers&quot;: [{&quot;name&quot;: &quot;Nelson Elhage&quot;, &quot;email&quot;: &quot;nelhage@nelhage.com&quot;}],
</a><a href="#h16-0-6" id="h16-0-6" class="d">-  &quot;contributors&quot;:[],
</a><a href="#h16-0-7" id="h16-0-7" class="d">-  &quot;bugs&quot;: &quot;mailto:nelhage@nelhage.com&quot;,
</a><a href="#h16-0-8" id="h16-0-8" class="d">-  &quot;licenses&quot;: [],
</a><a href="#h16-0-9" id="h16-0-9" class="d">-  &quot;dependencies&quot;: {
</a><a href="#h16-0-10" id="h16-0-10" class="d">-    &quot;express&quot;: &quot;&gt;= 3.0&quot;,
</a><a href="#h16-0-11" id="h16-0-11" class="d">-    &quot;express-extras&quot;: &quot;0.1.1&quot;,
</a><a href="#h16-0-12" id="h16-0-12" class="d">-    &quot;carrier&quot;: &quot;&gt;= 0.1.3&quot;,
</a><a href="#h16-0-13" id="h16-0-13" class="d">-    &quot;dnode&quot;: &quot;&gt;= 0.9.1&quot;,
</a><a href="#h16-0-14" id="h16-0-14" class="d">-    &quot;log4js&quot;: &quot;&gt;= 0.4.1&quot;,
</a><a href="#h16-0-15" id="h16-0-15" class="d">-    &quot;parseopt&quot;: &quot;&gt;= 1.0.0&quot;,
</a><a href="#h16-0-16" id="h16-0-16" class="d">-    &quot;temp&quot;: &quot;&gt;= 0.4.0&quot;,
</a><a href="#h16-0-17" id="h16-0-17" class="d">-    &quot;printf&quot;: &quot;&gt;= 0.0.4&quot;,
</a><a href="#h16-0-18" id="h16-0-18" class="d">-    &quot;socket.io&quot;: &quot;&gt;= 0.8.7&quot;,
</a><a href="#h16-0-19" id="h16-0-19" class="d">-    &quot;underscore&quot;: &quot;&gt;= 1.3&quot;,
</a><a href="#h16-0-20" id="h16-0-20" class="d">-    &quot;emailjs&quot;: &quot;&gt;= 0.2.2&quot;,
</a><a href="#h16-0-21" id="h16-0-21" class="d">-    &quot;hbs&quot;: &quot;&gt;= 1.0.5&quot;
</a><a href="#h16-0-22" id="h16-0-22" class="d">-  }
</a><a href="#h16-0-23" id="h16-0-23" class="d">-}
</a><b>diff --git a/<a id="h17" href="../file/runtests.sh">runtests.sh</a> b/<a href="../file/runtests.sh">runtests.sh</a></b>
<a href="#h17-0" id="h17-0" class="h">@@ -1,21 +0,0 @@
</a><a href="#h17-0-0" id="h17-0-0" class="d">-#!/bin/bash
</a><a href="#h17-0-1" id="h17-0-1" class="d">-
</a><a href="#h17-0-2" id="h17-0-2" class="d">-testfiles=(testcases index unicode benchmarks)
</a><a href="#h17-0-3" id="h17-0-3" class="d">-files=(&#39;&#39; &#39;^arch/x86&#39; &#39;sched\..&#39; &#39;sunhme&#39;)
</a><a href="#h17-0-4" id="h17-0-4" class="d">-
</a><a href="#h17-0-5" id="h17-0-5" class="d">-set -e
</a><a href="#h17-0-6" id="h17-0-6" class="d">-
</a><a href="#h17-0-7" id="h17-0-7" class="d">-for fre in &quot;${files[@]}&quot;; do
</a><a href="#h17-0-8" id="h17-0-8" class="d">-    for case in &quot;${testfiles[@]}&quot;; do
</a><a href="#h17-0-9" id="h17-0-9" class="d">-        extra=()
</a><a href="#h17-0-10" id="h17-0-10" class="d">-        if [ &quot;$fre&quot; ]; then
</a><a href="#h17-0-11" id="h17-0-11" class="d">-            extra=(--noempty)
</a><a href="#h17-0-12" id="h17-0-12" class="d">-            if [ &quot;$case&quot; = &quot;benchmarks&quot; ]; then
</a><a href="#h17-0-13" id="h17-0-13" class="d">-                echo &quot;Skipping benchmark tests with non-empty file regex...&quot;;
</a><a href="#h17-0-14" id="h17-0-14" class="d">-                continue;
</a><a href="#h17-0-15" id="h17-0-15" class="d">-            fi
</a><a href="#h17-0-16" id="h17-0-16" class="d">-        fi
</a><a href="#h17-0-17" id="h17-0-17" class="d">-        echo &quot;Testing $case with file &#39;$fre&#39;...&quot;
</a><a href="#h17-0-18" id="h17-0-18" class="d">-        node test/test.js --querylist &quot;test/$case&quot; &quot;${extra[@]}&quot; -- --file &quot;$fre&quot;
</a><a href="#h17-0-19" id="h17-0-19" class="d">-    done
</a><a href="#h17-0-20" id="h17-0-20" class="d">-done
</a></pre>
</div>
</body>
</html>
