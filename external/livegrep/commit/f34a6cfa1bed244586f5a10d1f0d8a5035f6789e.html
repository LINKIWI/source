<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Update node rules for bazel 1.1 - livegrep - Fast, regular expression code search service</title>
<meta name="description" content="Fast, regular expression code search service" />
<meta name="author" content="Kevin Lin" />
<link rel="icon" type="image/png" href="https://static.kevinlin.info/favicon.png" />
<link rel="alternate" type="application/atom+xml" title="livegrep Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="livegrep Atom Feed (tags)" href="../tags.xml" />
<style type="text/css">
body{color:#000;background-color:#fff;font-family:monospace}h1,h2,h3,h4,h5,h6{font-size:1em;margin:0}img,h1,h2{vertical-align:middle}img{border:0}a:target{background-color:#ccc}a.d,a.h,a.i{text-decoration:none}a.line{text-decoration:none;user-select:none}#blob a{color:#555}#blob a:hover{color:blue;text-decoration:none}table thead td{font-weight:bold}table td{padding:0 .4em}#content table td{vertical-align:top;white-space:nowrap}#branches tr:hover td,#tags tr:hover td,#index tr:hover td,#log tr:hover td,#files tr:hover td{background-color:#eee}#index tr td:nth-child(2),#tags tr td:nth-child(3),#branches tr td:nth-child(3),#log tr td:nth-child(2){white-space:normal}td.num{text-align:right}.desc{color:#555}hr{border:0;border-top:1px solid #555;height:1px}pre{font-family:monospace}pre a.h{color:#00a}.A,span.i,pre a.i{color:#070}.D,span.d,pre a.d{color:#e00}pre a.h:hover,pre a.i:hover,pre a.d:hover{text-decoration:none}/*# sourceMappingURL=style.css.min.map */
</style>
</head>
<body>
<table><tr><td><a href="/"><img src="https://static.kevinlin.info/favicon.png" alt="" width="32" height="32" /></a></td><td><h1>livegrep</h1><span class="desc">Fast, regular expression code search service</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://source.static.kevinlin.info/external/livegrep.git">https://source.static.kevinlin.info/external/livegrep.git</a></td></tr><tr><td></td><td>
<a href="../log">Log</a> | <a href="../files">Files</a> | <a href="../refs">Refs</a> | <a href="../file/README.md">README</a> | <a href="../file/COPYING">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/f34a6cfa1bed244586f5a10d1f0d8a5035f6789e">f34a6cfa1bed244586f5a10d1f0d8a5035f6789e</a>
<b>parent</b> <a href="../commit/f70174b564c582757a940c8fd0aa02fcbfafbca7">f70174b564c582757a940c8fd0aa02fcbfafbca7</a>
<b>Author:</b> Nelson Elhage &lt;<a href="mailto:nelhage@nelhage.com">nelhage@nelhage.com</a>&gt;
<b>Date:</b>   Sun, 27 Oct 2019 10:01:52 -0700

Update node rules for bazel 1.1

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">WORKSPACE</a></td><td> | </td><td class="num">5</td><td><span class="i">++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">tools/org_dropbox_rules_node/node/defs.bzl</a></td><td> | </td><td class="num">392</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++</span><span class="d">-------------------------------------</span></td></tr>
</table></pre><pre>2 files changed, 209 insertions(+), 188 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/WORKSPACE">WORKSPACE</a> b/<a href="../file/WORKSPACE">WORKSPACE</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -128,10 +128,9 @@ git_repository(
</a>     remote = &quot;https://github.com/bazelbuild/buildifier.git&quot;,
 )
 
<a href="#h0-0-3" id="h0-0-3" class="d">-git_repository(
</a><a href="#h0-0-4" id="h0-0-4" class="i">+local_repository(
</a>     name = &quot;org_dropbox_rules_node&quot;,
<a href="#h0-0-6" id="h0-0-6" class="d">-    commit = &quot;4c53c3ab5e7d4f75b50d6234567973c10ab3f7b8&quot;,
</a><a href="#h0-0-7" id="h0-0-7" class="d">-    remote = &quot;https://github.com/dropbox/rules_node.git&quot;,
</a><a href="#h0-0-8" id="h0-0-8" class="i">+    path = &quot;tools/org_dropbox_rules_node&quot;,
</a> )
 
 load(&quot;@org_dropbox_rules_node//node:defs.bzl&quot;, &quot;node_repositories&quot;)
<b>diff --git a/<a id="h1" href="../file/tools/org_dropbox_rules_node/node/defs.bzl">tools/org_dropbox_rules_node/node/defs.bzl</a> b/<a href="../file/tools/org_dropbox_rules_node/node/defs.bzl">tools/org_dropbox_rules_node/node/defs.bzl</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -5,7 +5,6 @@ Bazel rules for working with node.
</a> 
 load(&quot;@bazel_tools//tools/build_defs/repo:http.bzl&quot;, &quot;http_archive&quot;)
 
<a href="#h1-0-3" id="h1-0-3" class="d">-
</a> # Helper functions
 
 runfiles_tmpl = &#39;&#39;&#39;#!/bin/bash -eu
<a href="#h1-1" id="h1-1" class="h">@@ -35,53 +34,53 @@ def _get_runfiles_tmpl(ctx, content):
</a>     # If we&#39;re building an external binary, then we need to use the
     # workspace name of that binary, not the current workspace.
     if ctx.label.workspace_root:
<a href="#h1-1-3" id="h1-1-3" class="d">-        if not ctx.label.workspace_root.startswith(&#39;external/&#39;):
</a><a href="#h1-1-4" id="h1-1-4" class="d">-            fail(&#39;Workspace root must start with external/: {}&#39;.format(
</a><a href="#h1-1-5" id="h1-1-5" class="i">+        if not ctx.label.workspace_root.startswith(&quot;external/&quot;):
</a><a href="#h1-1-6" id="h1-1-6" class="i">+            fail(&quot;Workspace root must start with external/: {}&quot;.format(
</a>                 ctx.label.workspace_root,
             ))
<a href="#h1-1-9" id="h1-1-9" class="d">-        workspace_name = ctx.label.workspace_root[len(&#39;external/&#39;):]
</a><a href="#h1-1-10" id="h1-1-10" class="i">+        workspace_name = ctx.label.workspace_root[len(&quot;external/&quot;):]
</a>     else:
         workspace_name = ctx.workspace_name
 
     return runfiles_tmpl.format(
<a href="#h1-1-15" id="h1-1-15" class="d">-        content=content,
</a><a href="#h1-1-16" id="h1-1-16" class="d">-        workspace_name=workspace_name,
</a><a href="#h1-1-17" id="h1-1-17" class="i">+        content = content,
</a><a href="#h1-1-18" id="h1-1-18" class="i">+        workspace_name = workspace_name,
</a>     )
 
<a href="#h1-1-21" id="h1-1-21" class="d">-
</a> def _get_package_dir(ctx):
     return ctx.label.package
 
 def _get_output_dir(ctx):
     # If it&#39;s an external label, output to workspace_root.
     if ctx.label.workspace_root:
<a href="#h1-1-28" id="h1-1-28" class="d">-        return ctx.configuration.bin_dir.path + &#39;/&#39; + ctx.label.workspace_root + &#39;/&#39; + _get_package_dir(ctx)
</a><a href="#h1-1-29" id="h1-1-29" class="i">+        return ctx.configuration.bin_dir.path + &quot;/&quot; + ctx.label.workspace_root + &quot;/&quot; + _get_package_dir(ctx)
</a> 
<a href="#h1-1-31" id="h1-1-31" class="d">-    return ctx.configuration.bin_dir.path + &#39;/&#39; + _get_package_dir(ctx)
</a><a href="#h1-1-32" id="h1-1-32" class="i">+    return ctx.configuration.bin_dir.path + &quot;/&quot; + _get_package_dir(ctx)
</a> 
 def _get_relpath(ctx, src):
<a href="#h1-1-35" id="h1-1-35" class="d">-    package_prefix = _get_package_dir(ctx) + &#39;/&#39;
</a><a href="#h1-1-36" id="h1-1-36" class="i">+    package_prefix = _get_package_dir(ctx) + &quot;/&quot;
</a> 
     relpath = src.short_path
<a href="#h1-1-39" id="h1-1-39" class="i">+
</a>     # If relpath starts with &#39;../&#39;, that means it belongs to an
     # external dependency, and it&#39;ll look like:
     #   &#39;../{workspace_name}/{package_path}/{file}
     # We want to transform it so it includes the package path
     # and the file.
<a href="#h1-1-45" id="h1-1-45" class="d">-    if relpath.startswith(&#39;../&#39;):
</a><a href="#h1-1-46" id="h1-1-46" class="d">-        parts = relpath.split(&#39;/&#39;)
</a><a href="#h1-1-47" id="h1-1-47" class="d">-        relpath = &#39;/&#39;.join(parts[2:])
</a><a href="#h1-1-48" id="h1-1-48" class="i">+    if relpath.startswith(&quot;../&quot;):
</a><a href="#h1-1-49" id="h1-1-49" class="i">+        parts = relpath.split(&quot;/&quot;)
</a><a href="#h1-1-50" id="h1-1-50" class="i">+        relpath = &quot;/&quot;.join(parts[2:])
</a> 
     if not relpath.startswith(package_prefix):
<a href="#h1-1-53" id="h1-1-53" class="d">-        fail(&#39;Path must be in the package: (path: {relpath}, package prefix: {package_prefix})&#39;.format(
</a><a href="#h1-1-54" id="h1-1-54" class="d">-                relpath=relpath,
</a><a href="#h1-1-55" id="h1-1-55" class="d">-                package_prefix=package_prefix,
</a><a href="#h1-1-56" id="h1-1-56" class="d">-            ))
</a><a href="#h1-1-57" id="h1-1-57" class="i">+        fail(&quot;Path must be in the package: (path: {relpath}, package prefix: {package_prefix})&quot;.format(
</a><a href="#h1-1-58" id="h1-1-58" class="i">+            relpath = relpath,
</a><a href="#h1-1-59" id="h1-1-59" class="i">+            package_prefix = package_prefix,
</a><a href="#h1-1-60" id="h1-1-60" class="i">+        ))
</a> 
     return relpath[len(package_prefix):]
 
 def _new_node_modules_srcs_dict():
<a href="#h1-1-65" id="h1-1-65" class="d">-    &#39;&#39;&#39;Returns a new `node_modules_srcs_dict` dict. It&#39;s just a normal
</a><a href="#h1-1-66" id="h1-1-66" class="i">+    &quot;&quot;&quot;Returns a new `node_modules_srcs_dict` dict. It&#39;s just a normal
</a>     dict, this function exists so we can document how it works in one
     place.
 
<a href="#h1-2" id="h1-2" class="h">@@ -96,11 +95,11 @@ def _new_node_modules_srcs_dict():
</a>     NOTE: Make sure to fail if you need to add a path to
     `node_modules_srcs_dict` that already exists.
 
<a href="#h1-2-3" id="h1-2-3" class="d">-    &#39;&#39;&#39;
</a><a href="#h1-2-4" id="h1-2-4" class="i">+    &quot;&quot;&quot;
</a>     return {}
 
 def _new_all_node_modules():
<a href="#h1-2-8" id="h1-2-8" class="d">-    &#39;&#39;&#39;Returns a new `all_node_modules` dict. It&#39;s just a normal
</a><a href="#h1-2-9" id="h1-2-9" class="i">+    &quot;&quot;&quot;Returns a new `all_node_modules` dict. It&#39;s just a normal
</a>     dict, this function exists so we can document how it works in one
     place.
 
<a href="#h1-3" id="h1-3" class="h">@@ -109,32 +108,32 @@ def _new_all_node_modules():
</a> 
     The key should be unique to the package, and doesn&#39;t necessarily
     have any other semantic meaning.
<a href="#h1-3-3" id="h1-3-3" class="d">-    &#39;&#39;&#39;
</a><a href="#h1-3-4" id="h1-3-4" class="i">+    &quot;&quot;&quot;
</a>     return {}
 
 def _npm_library_impl(ctx):
     node_module_srcs = []
 
     npm_req = ctx.attr.npm_req
<a href="#h1-3-11" id="h1-3-11" class="d">-    if &#39;@&#39; not in npm_req:
</a><a href="#h1-3-12" id="h1-3-12" class="d">-        fail(&quot;npm_req must contain a &#39;@&#39;: {npm_req}&quot;.format(npm_req=npm_req))
</a><a href="#h1-3-13" id="h1-3-13" class="i">+    if &quot;@&quot; not in npm_req:
</a><a href="#h1-3-14" id="h1-3-14" class="i">+        fail(&quot;npm_req must contain a &#39;@&#39;: {npm_req}&quot;.format(npm_req = npm_req))
</a> 
     # The module name is everything before the last &#39;@&#39;.
<a href="#h1-3-17" id="h1-3-17" class="d">-    require_name = npm_req.rsplit(&#39;@&#39;, 1)[0]
</a><a href="#h1-3-18" id="h1-3-18" class="d">-    require_prefix = require_name + &#39;/&#39;
</a><a href="#h1-3-19" id="h1-3-19" class="i">+    require_name = npm_req.rsplit(&quot;@&quot;, 1)[0]
</a><a href="#h1-3-20" id="h1-3-20" class="i">+    require_prefix = require_name + &quot;/&quot;
</a> 
     node_modules_srcs_dict = _new_node_modules_srcs_dict()
     for content in ctx.attr.contents:
         if content in node_modules_srcs_dict:
<a href="#h1-3-25" id="h1-3-25" class="d">-            fail(&#39;Duplicate path in node_modules: {content}&#39;.format(content=content))
</a><a href="#h1-3-26" id="h1-3-26" class="i">+            fail(&quot;Duplicate path in node_modules: {content}&quot;.format(content = content))
</a> 
<a href="#h1-3-28" id="h1-3-28" class="d">-        if not content.startswith(require_prefix) and not content.startswith(&#39;.bin/&#39;):
</a><a href="#h1-3-29" id="h1-3-29" class="d">-            fail((&quot;npm library cannot include paths outside of {require_name} &quot;+
</a><a href="#h1-3-30" id="h1-3-30" class="d">-                  &quot;or &#39;.bin&#39;: {content}&quot;).format(require_name=require_name, content=content))
</a><a href="#h1-3-31" id="h1-3-31" class="i">+        if not content.startswith(require_prefix) and not content.startswith(&quot;.bin/&quot;):
</a><a href="#h1-3-32" id="h1-3-32" class="i">+            fail((&quot;npm library cannot include paths outside of {require_name} &quot; +
</a><a href="#h1-3-33" id="h1-3-33" class="i">+                  &quot;or &#39;.bin&#39;: {content}&quot;).format(require_name = require_name, content = content))
</a> 
         # The created files are all under `node_modules/` because
         # that&#39;s where the npm installer puts them.
<a href="#h1-3-37" id="h1-3-37" class="d">-        node_modules_srcs_dict[content] = ctx.new_file(&#39;node_modules/&#39; + content)
</a><a href="#h1-3-38" id="h1-3-38" class="i">+        node_modules_srcs_dict[content] = ctx.actions.declare_file(&quot;node_modules/&quot; + content)
</a> 
     shrinkwrap = ctx.file.shrinkwrap
 
<a href="#h1-4" id="h1-4" class="h">@@ -146,18 +145,18 @@ def _npm_library_impl(ctx):
</a>         command_args.extend(ctx.attr.npm_installer_extra_args)
 
     env = {}
<a href="#h1-4-3" id="h1-4-3" class="d">-    if &#39;HTTP_PROXY&#39; in ctx.var:
</a><a href="#h1-4-4" id="h1-4-4" class="d">-        env[&#39;HTTP_PROXY&#39;] = ctx.var[&#39;HTTP_PROXY&#39;]
</a><a href="#h1-4-5" id="h1-4-5" class="d">-    if &#39;HTTPS_PROXY&#39; in ctx.var:
</a><a href="#h1-4-6" id="h1-4-6" class="d">-        env[&#39;HTTPS_PROXY&#39;] = ctx.var[&#39;HTTPS_PROXY&#39;]
</a><a href="#h1-4-7" id="h1-4-7" class="i">+    if &quot;HTTP_PROXY&quot; in ctx.var:
</a><a href="#h1-4-8" id="h1-4-8" class="i">+        env[&quot;HTTP_PROXY&quot;] = ctx.var[&quot;HTTP_PROXY&quot;]
</a><a href="#h1-4-9" id="h1-4-9" class="i">+    if &quot;HTTPS_PROXY&quot; in ctx.var:
</a><a href="#h1-4-10" id="h1-4-10" class="i">+        env[&quot;HTTPS_PROXY&quot;] = ctx.var[&quot;HTTPS_PROXY&quot;]
</a> 
<a href="#h1-4-12" id="h1-4-12" class="d">-    ctx.action(
</a><a href="#h1-4-13" id="h1-4-13" class="i">+    ctx.actions.run(
</a>         inputs = [shrinkwrap],
         outputs = node_modules_srcs_dict.values(),
         executable = ctx.executable.npm_installer,
         arguments = command_args,
<a href="#h1-4-18" id="h1-4-18" class="d">-        progress_message = &#39;installing node modules from {}&#39;.format(shrinkwrap.path),
</a><a href="#h1-4-19" id="h1-4-19" class="d">-        mnemonic = &#39;InstallNPMModules&#39;,
</a><a href="#h1-4-20" id="h1-4-20" class="i">+        progress_message = &quot;installing node modules from {}&quot;.format(shrinkwrap.path),
</a><a href="#h1-4-21" id="h1-4-21" class="i">+        mnemonic = &quot;InstallNPMModules&quot;,
</a>         env = env,
     )
 
<a href="#h1-5" id="h1-5" class="h">@@ -169,24 +168,31 @@ def _npm_library_impl(ctx):
</a>     )
 
 _npm_library_internal = rule(
<a href="#h1-5-3" id="h1-5-3" class="d">-    implementation = _npm_library_impl,
</a>     attrs = {
<a href="#h1-5-5" id="h1-5-5" class="d">-        &#39;shrinkwrap&#39;: attr.label(allow_single_file=True, mandatory=True),
</a><a href="#h1-5-6" id="h1-5-6" class="d">-        &#39;npm_req&#39;: attr.string(mandatory=True),
</a><a href="#h1-5-7" id="h1-5-7" class="d">-        &#39;contents&#39;: attr.string_list(mandatory=True),
</a><a href="#h1-5-8" id="h1-5-8" class="d">-        &#39;npm_installer&#39;: attr.label(
</a><a href="#h1-5-9" id="h1-5-9" class="i">+        &quot;shrinkwrap&quot;: attr.label(
</a><a href="#h1-5-10" id="h1-5-10" class="i">+            allow_single_file = True,
</a><a href="#h1-5-11" id="h1-5-11" class="i">+            mandatory = True,
</a><a href="#h1-5-12" id="h1-5-12" class="i">+        ),
</a><a href="#h1-5-13" id="h1-5-13" class="i">+        &quot;npm_req&quot;: attr.string(mandatory = True),
</a><a href="#h1-5-14" id="h1-5-14" class="i">+        &quot;contents&quot;: attr.string_list(mandatory = True),
</a><a href="#h1-5-15" id="h1-5-15" class="i">+        &quot;npm_installer&quot;: attr.label(
</a>             executable = True,
<a href="#h1-5-17" id="h1-5-17" class="d">-            cfg = &#39;host&#39;,
</a><a href="#h1-5-18" id="h1-5-18" class="i">+            cfg = &quot;host&quot;,
</a>         ),
<a href="#h1-5-20" id="h1-5-20" class="d">-        &#39;npm_installer_extra_args&#39;: attr.string_list(),
</a><a href="#h1-5-21" id="h1-5-21" class="i">+        &quot;npm_installer_extra_args&quot;: attr.string_list(),
</a>     },
<a href="#h1-5-23" id="h1-5-23" class="i">+    implementation = _npm_library_impl,
</a> )
 
<a href="#h1-5-26" id="h1-5-26" class="d">-def npm_library(name, npm_req, shrinkwrap, contents,
</a><a href="#h1-5-27" id="h1-5-27" class="d">-                no_import_main_test=False,
</a><a href="#h1-5-28" id="h1-5-28" class="d">-                npm_installer=&#39;@org_dropbox_rules_node//node/tools/npm:install&#39;,
</a><a href="#h1-5-29" id="h1-5-29" class="d">-                npm_installer_extra_args=[]):
</a><a href="#h1-5-30" id="h1-5-30" class="d">-    &#39;&#39;&#39;Defines an external npm module.
</a><a href="#h1-5-31" id="h1-5-31" class="i">+def npm_library(
</a><a href="#h1-5-32" id="h1-5-32" class="i">+        name,
</a><a href="#h1-5-33" id="h1-5-33" class="i">+        npm_req,
</a><a href="#h1-5-34" id="h1-5-34" class="i">+        shrinkwrap,
</a><a href="#h1-5-35" id="h1-5-35" class="i">+        contents,
</a><a href="#h1-5-36" id="h1-5-36" class="i">+        no_import_main_test = False,
</a><a href="#h1-5-37" id="h1-5-37" class="i">+        npm_installer = &quot;@org_dropbox_rules_node//node/tools/npm:install&quot;,
</a><a href="#h1-5-38" id="h1-5-38" class="i">+        npm_installer_extra_args = []):
</a><a href="#h1-5-39" id="h1-5-39" class="i">+    &quot;&quot;&quot;Defines an external npm module.
</a> 
     This rule should usually be generated using
     `//node/tools/npm:gen_build_npm`, like this:
<a href="#h1-6" id="h1-6" class="h">@@ -248,43 +254,41 @@ def npm_library(name, npm_req, shrinkwrap, contents,
</a> 
       npm_installer_args: Extra arguments to pass to `npm_installer`.
 
<a href="#h1-6-3" id="h1-6-3" class="d">-    &#39;&#39;&#39;
</a><a href="#h1-6-4" id="h1-6-4" class="i">+    &quot;&quot;&quot;
</a>     _npm_library_internal(
         name = name,
<a href="#h1-6-7" id="h1-6-7" class="d">-        shrinkwrap = shrinkwrap,
</a><a href="#h1-6-8" id="h1-6-8" class="d">-        npm_req = npm_req,
</a>         contents = contents,
         npm_installer = npm_installer,
         npm_installer_extra_args = npm_installer_extra_args,
<a href="#h1-6-12" id="h1-6-12" class="i">+        npm_req = npm_req,
</a><a href="#h1-6-13" id="h1-6-13" class="i">+        shrinkwrap = shrinkwrap,
</a>     )
     _node_import_test(
<a href="#h1-6-16" id="h1-6-16" class="d">-        name = name + &#39;_import_test&#39;,
</a><a href="#h1-6-17" id="h1-6-17" class="d">-        deps = [name],
</a><a href="#h1-6-18" id="h1-6-18" class="d">-        npm_req = npm_req,
</a><a href="#h1-6-19" id="h1-6-19" class="i">+        name = name + &quot;_import_test&quot;,
</a>         no_import_main_test = no_import_main_test,
<a href="#h1-6-21" id="h1-6-21" class="i">+        npm_req = npm_req,
</a><a href="#h1-6-22" id="h1-6-22" class="i">+        deps = [name],
</a>     )
 
 def _collect_srcs_and_deps(ctx):
<a href="#h1-6-26" id="h1-6-26" class="d">-    &#39;&#39;&#39;
</a><a href="#h1-6-27" id="h1-6-27" class="i">+    &quot;&quot;&quot;
</a>     Collects all the srcs and deps from ctx&#39;s direct and transitive dependencies.
 
     Returns the tuple (srcs, all_node_modules).
<a href="#h1-6-31" id="h1-6-31" class="d">-    &#39;&#39;&#39;
</a><a href="#h1-6-32" id="h1-6-32" class="d">-    srcs = depset()
</a><a href="#h1-6-33" id="h1-6-33" class="i">+    &quot;&quot;&quot;
</a><a href="#h1-6-34" id="h1-6-34" class="i">+    srcs = depset(ctx.files.srcs)
</a>     all_node_modules = _new_all_node_modules()
 
<a href="#h1-6-37" id="h1-6-37" class="d">-    srcs += ctx.files.srcs
</a><a href="#h1-6-38" id="h1-6-38" class="d">-
</a>     # Verify that `srcs` are not node_library or npm_library rules.
     for src in ctx.attr.srcs:
<a href="#h1-6-41" id="h1-6-41" class="d">-        if hasattr(src, &#39;all_node_modules&#39;):
</a><a href="#h1-6-42" id="h1-6-42" class="d">-            fail(&#39;Invalid src, srcs must only be files: {}&#39;.format(src.label))
</a><a href="#h1-6-43" id="h1-6-43" class="i">+        if hasattr(src, &quot;all_node_modules&quot;):
</a><a href="#h1-6-44" id="h1-6-44" class="i">+            fail(&quot;Invalid src, srcs must only be files: {}&quot;.format(src.label))
</a> 
     for dep in ctx.attr.deps:
<a href="#h1-6-47" id="h1-6-47" class="d">-        if hasattr(dep, &#39;srcs&#39;):
</a><a href="#h1-6-48" id="h1-6-48" class="i">+        if hasattr(dep, &quot;srcs&quot;):
</a>             srcs += dep.srcs
 
<a href="#h1-6-51" id="h1-6-51" class="d">-        if hasattr(dep, &#39;all_node_modules&#39;):
</a><a href="#h1-6-52" id="h1-6-52" class="i">+        if hasattr(dep, &quot;all_node_modules&quot;):
</a>             for key, value in dep.all_node_modules.items():
                 if key not in all_node_modules:
                     all_node_modules[key] = value
<a href="#h1-7" id="h1-7" class="h">@@ -297,17 +301,18 @@ def _node_library_impl(ctx):
</a>     return struct(
         srcs = srcs,
         all_node_modules = all_node_modules,
<a href="#h1-7-3" id="h1-7-3" class="d">-        runfiles = ctx.runfiles(collect_default=True),
</a><a href="#h1-7-4" id="h1-7-4" class="i">+        runfiles = ctx.runfiles(collect_default = True),
</a>     )
 
 node_library = rule(
<a href="#h1-7-8" id="h1-7-8" class="d">-    implementation = _node_library_impl,
</a>     attrs = {
<a href="#h1-7-10" id="h1-7-10" class="d">-        &#39;srcs&#39;: attr.label_list(allow_files=True),
</a><a href="#h1-7-11" id="h1-7-11" class="d">-        &#39;deps&#39;: attr.label_list(allow_files=False),
</a><a href="#h1-7-12" id="h1-7-12" class="d">-        &#39;data&#39;: attr.label_list(allow_files=True),
</a><a href="#h1-7-13" id="h1-7-13" class="d">-    }
</a><a href="#h1-7-14" id="h1-7-14" class="i">+        &quot;srcs&quot;: attr.label_list(allow_files = True),
</a><a href="#h1-7-15" id="h1-7-15" class="i">+        &quot;deps&quot;: attr.label_list(allow_files = False),
</a><a href="#h1-7-16" id="h1-7-16" class="i">+        &quot;data&quot;: attr.label_list(allow_files = True),
</a><a href="#h1-7-17" id="h1-7-17" class="i">+    },
</a><a href="#h1-7-18" id="h1-7-18" class="i">+    implementation = _node_library_impl,
</a> )
<a href="#h1-7-20" id="h1-7-20" class="i">+
</a> &quot;&quot;&quot;
 Groups node.js sources and deps together.
 
<a href="#h1-8" id="h1-8" class="h">@@ -318,36 +323,35 @@ Args:
</a>   data: The list of files needed by this library at runtime.
 &quot;&quot;&quot;
 
<a href="#h1-8-3" id="h1-8-3" class="d">-
</a> def _construct_runfiles(ctx, srcs, all_node_modules):
<a href="#h1-8-5" id="h1-8-5" class="d">-    &#39;&#39;&#39;
</a><a href="#h1-8-6" id="h1-8-6" class="i">+    &quot;&quot;&quot;
</a>     Create the set of runfiles for node rules.
 
     Puts all of the node modules in `$RUNFILES/{pkg_dir}/node_modules`
     for the binary target.
 
     Fails if any files in all_node_modules conflict with each other.
<a href="#h1-8-13" id="h1-8-13" class="d">-    &#39;&#39;&#39;
</a><a href="#h1-8-14" id="h1-8-14" class="i">+    &quot;&quot;&quot;
</a>     package_dir = _get_package_dir(ctx)
     if ctx.label.workspace_root:
<a href="#h1-8-17" id="h1-8-17" class="d">-        if not ctx.label.workspace_root.startswith(&#39;external/&#39;):
</a><a href="#h1-8-18" id="h1-8-18" class="d">-            fail(&#39;Workspace root must start with external/: {}&#39;.format(
</a><a href="#h1-8-19" id="h1-8-19" class="i">+        if not ctx.label.workspace_root.startswith(&quot;external/&quot;):
</a><a href="#h1-8-20" id="h1-8-20" class="i">+            fail(&quot;Workspace root must start with external/: {}&quot;.format(
</a>                 ctx.label.workspace_root,
             ))
<a href="#h1-8-23" id="h1-8-23" class="d">-        package_dir = ctx.label.workspace_root[len(&#39;external/&#39;):] + &#39;/&#39; + package_dir
</a><a href="#h1-8-24" id="h1-8-24" class="i">+        package_dir = ctx.label.workspace_root[len(&quot;external/&quot;):] + &quot;/&quot; + package_dir
</a> 
     symlinks = {}
     for node_modules_srcs_dict in all_node_modules.values():
         for content_path, src in node_modules_srcs_dict.items():
<a href="#h1-8-29" id="h1-8-29" class="d">-            path = package_dir + &#39;/node_modules/&#39; + content_path
</a><a href="#h1-8-30" id="h1-8-30" class="i">+            path = package_dir + &quot;/node_modules/&quot; + content_path
</a> 
             if path in symlinks:
<a href="#h1-8-33" id="h1-8-33" class="d">-                fail((&#39;Cannot have conflicting paths in node_modules. This path was &#39; +
</a><a href="#h1-8-34" id="h1-8-34" class="d">-                      &#39;in your node modules twice: {path}. These are the deps included &#39; +
</a><a href="#h1-8-35" id="h1-8-35" class="d">-                      &#39;in your node_modules folder: {all_node_modules_keys}&#39;).format(
</a><a href="#h1-8-36" id="h1-8-36" class="d">-                          path=path,
</a><a href="#h1-8-37" id="h1-8-37" class="d">-                          all_node_modules_keys=all_node_modules.keys(),
</a><a href="#h1-8-38" id="h1-8-38" class="d">-                      ))
</a><a href="#h1-8-39" id="h1-8-39" class="i">+                fail((&quot;Cannot have conflicting paths in node_modules. This path was &quot; +
</a><a href="#h1-8-40" id="h1-8-40" class="i">+                      &quot;in your node modules twice: {path}. These are the deps included &quot; +
</a><a href="#h1-8-41" id="h1-8-41" class="i">+                      &quot;in your node_modules folder: {all_node_modules_keys}&quot;).format(
</a><a href="#h1-8-42" id="h1-8-42" class="i">+                    path = path,
</a><a href="#h1-8-43" id="h1-8-43" class="i">+                    all_node_modules_keys = all_node_modules.keys(),
</a><a href="#h1-8-44" id="h1-8-44" class="i">+                ))
</a> 
             symlinks[path] = src
 
<a href="#h1-9" id="h1-9" class="h">@@ -357,29 +361,29 @@ def _construct_runfiles(ctx, srcs, all_node_modules):
</a>         return ctx.runfiles(
             files = list(srcs),
             root_symlinks = symlinks,
<a href="#h1-9-3" id="h1-9-3" class="d">-            collect_default=True,
</a><a href="#h1-9-4" id="h1-9-4" class="i">+            collect_default = True,
</a>         )
     else:
         return ctx.runfiles(
             files = list(srcs),
             symlinks = symlinks,
<a href="#h1-9-10" id="h1-9-10" class="d">-            collect_default=True,
</a><a href="#h1-9-11" id="h1-9-11" class="i">+            collect_default = True,
</a>         )
 
<a href="#h1-9-14" id="h1-9-14" class="d">-
</a> def _node_binary_impl(ctx):
     srcs, all_node_modules = _collect_srcs_and_deps(ctx)
 
     # Add node binary to runfiles
<a href="#h1-9-19" id="h1-9-19" class="i">+    srcs = srcs.to_list()
</a>     srcs += [ctx.file.node]
 
<a href="#h1-9-22" id="h1-9-22" class="d">-    node_flags = [&#39;--preserve-symlinks&#39;]
</a><a href="#h1-9-23" id="h1-9-23" class="i">+    node_flags = [&quot;--preserve-symlinks&quot;]
</a>     if ctx.attr.max_old_memory:
<a href="#h1-9-25" id="h1-9-25" class="d">-        node_flags.append(&#39;--max_old_space_size={}&#39;.format(ctx.attr.max_old_memory))
</a><a href="#h1-9-26" id="h1-9-26" class="i">+        node_flags.append(&quot;--max_old_space_size={}&quot;.format(ctx.attr.max_old_memory))
</a>     if ctx.attr.expose_gc:
<a href="#h1-9-28" id="h1-9-28" class="d">-        node_flags.append(&#39;--expose-gc&#39;)
</a><a href="#h1-9-29" id="h1-9-29" class="i">+        node_flags.append(&quot;--expose-gc&quot;)
</a> 
<a href="#h1-9-31" id="h1-9-31" class="d">-    default_args = &#39; &#39;.join(ctx.attr.extra_args + [&#39;&quot;$@&quot;&#39;])
</a><a href="#h1-9-32" id="h1-9-32" class="i">+    default_args = &quot; &quot;.join(ctx.attr.extra_args + [&#39;&quot;$@&quot;&#39;])
</a> 
     # We use --preserve-symlinks so that node will respect the symlink
     # tree in runfiles. One quirk of preserve symlinks is that
<a href="#h1-10" id="h1-10" class="h">@@ -391,11 +395,11 @@ def _node_binary_impl(ctx):
</a>     # node won&#39;t populate process.argv correctly.
 
     # Create the inner wrapper with the require call.
<a href="#h1-10-3" id="h1-10-3" class="d">-    inner_wrapper = ctx.new_file(ctx.outputs.executable, ctx.outputs.executable.basename + &#39;-wrapper.js&#39;)
</a><a href="#h1-10-4" id="h1-10-4" class="i">+    inner_wrapper = ctx.actions.declare_file(ctx.outputs.executable.basename + &quot;-wrapper.js&quot;, sibling = ctx.outputs.executable)
</a>     srcs += [inner_wrapper]
<a href="#h1-10-6" id="h1-10-6" class="d">-    ctx.file_action(
</a><a href="#h1-10-7" id="h1-10-7" class="i">+    ctx.actions.write(
</a>         inner_wrapper,
<a href="#h1-10-9" id="h1-10-9" class="d">-        &#39;&#39;&#39;require(process.env[&#39;BAZEL_NODE_MAIN_ID&#39;]);&#39;&#39;&#39;,
</a><a href="#h1-10-10" id="h1-10-10" class="i">+        &quot;&quot;&quot;require(process.env[&#39;BAZEL_NODE_MAIN_ID&#39;]);&quot;&quot;&quot;,
</a>     )
 
     # Some scripts use the pattern `if (require.main === module) {` to
<a href="#h1-11" id="h1-11" class="h">@@ -403,54 +407,57 @@ def _node_binary_impl(ctx):
</a>     # If you want that to work with bazel, you should check
     # BAZEL_NODE_MAIN_ID against the module id instead, like this:
     #   if (process.env[&#39;BAZEL_NODE_MAIN_ID&#39;] === module.id || require.main === module) {
<a href="#h1-11-3" id="h1-11-3" class="d">-    node_runfile_tmpl = &#39;&#39;&#39;
</a><a href="#h1-11-4" id="h1-11-4" class="i">+    node_runfile_tmpl = &quot;&quot;&quot;
</a> export BAZEL_NODE_MAIN_ID=$RUNFILES/{main}
 export NODE_PATH=$RUNFILES/{node_path}
 
 $RUNFILES/{node} {node_flags} $RUNFILES/{inner_wrapper} {default_args}
<a href="#h1-11-9" id="h1-11-9" class="d">-&#39;&#39;&#39;
</a><a href="#h1-11-10" id="h1-11-10" class="i">+&quot;&quot;&quot;
</a>     runfile_content = _get_runfiles_tmpl(
<a href="#h1-11-12" id="h1-11-12" class="d">-        ctx = ctx,
</a>         content = node_runfile_tmpl.format(
             main = ctx.file.main.short_path,
             node = ctx.file.node.short_path,
<a href="#h1-11-16" id="h1-11-16" class="d">-            node_flags = &#39; &#39;.join(node_flags),
</a><a href="#h1-11-17" id="h1-11-17" class="i">+            node_flags = &quot; &quot;.join(node_flags),
</a>             inner_wrapper = inner_wrapper.short_path,
             default_args = default_args,
<a href="#h1-11-20" id="h1-11-20" class="d">-            node_path = _get_package_dir(ctx) + &#39;/node_modules&#39;,
</a><a href="#h1-11-21" id="h1-11-21" class="d">-        )
</a><a href="#h1-11-22" id="h1-11-22" class="i">+            node_path = _get_package_dir(ctx) + &quot;/node_modules&quot;,
</a><a href="#h1-11-23" id="h1-11-23" class="i">+        ),
</a><a href="#h1-11-24" id="h1-11-24" class="i">+        ctx = ctx,
</a>     )
 
     # Generate output executable
<a href="#h1-11-28" id="h1-11-28" class="d">-    ctx.file_action(
</a><a href="#h1-11-29" id="h1-11-29" class="i">+    ctx.actions.write(
</a>         output = ctx.outputs.executable,
         content = runfile_content,
<a href="#h1-11-32" id="h1-11-32" class="d">-        executable = True
</a><a href="#h1-11-33" id="h1-11-33" class="i">+        is_executable = True,
</a>     )
 
     runfiles = _construct_runfiles(ctx, srcs, all_node_modules)
<a href="#h1-11-37" id="h1-11-37" class="d">-    return struct(runfiles=runfiles)
</a><a href="#h1-11-38" id="h1-11-38" class="i">+    return struct(runfiles = runfiles)
</a> 
 _node_bin_attrs = {
<a href="#h1-11-41" id="h1-11-41" class="d">-    &#39;srcs&#39;: attr.label_list(allow_files=True),
</a><a href="#h1-11-42" id="h1-11-42" class="d">-    &#39;deps&#39;: attr.label_list(allow_files=False),
</a><a href="#h1-11-43" id="h1-11-43" class="d">-    &#39;data&#39;: attr.label_list(allow_files=True),
</a><a href="#h1-11-44" id="h1-11-44" class="d">-
</a><a href="#h1-11-45" id="h1-11-45" class="d">-    &#39;main&#39;: attr.label(allow_single_file=True, mandatory=True),
</a><a href="#h1-11-46" id="h1-11-46" class="d">-    &#39;extra_args&#39;: attr.string_list(),
</a><a href="#h1-11-47" id="h1-11-47" class="d">-    &#39;node&#39;: attr.label(
</a><a href="#h1-11-48" id="h1-11-48" class="i">+    &quot;srcs&quot;: attr.label_list(allow_files = True),
</a><a href="#h1-11-49" id="h1-11-49" class="i">+    &quot;deps&quot;: attr.label_list(allow_files = False),
</a><a href="#h1-11-50" id="h1-11-50" class="i">+    &quot;data&quot;: attr.label_list(allow_files = True),
</a><a href="#h1-11-51" id="h1-11-51" class="i">+    &quot;main&quot;: attr.label(
</a>         allow_single_file = True,
<a href="#h1-11-53" id="h1-11-53" class="d">-        default = Label(&#39;@nodejs//:node&#39;),
</a><a href="#h1-11-54" id="h1-11-54" class="i">+        mandatory = True,
</a>     ),
<a href="#h1-11-56" id="h1-11-56" class="d">-    &#39;max_old_memory&#39;: attr.int(),
</a><a href="#h1-11-57" id="h1-11-57" class="d">-    &#39;expose_gc&#39;: attr.bool(default=False),
</a><a href="#h1-11-58" id="h1-11-58" class="i">+    &quot;extra_args&quot;: attr.string_list(),
</a><a href="#h1-11-59" id="h1-11-59" class="i">+    &quot;node&quot;: attr.label(
</a><a href="#h1-11-60" id="h1-11-60" class="i">+        allow_single_file = True,
</a><a href="#h1-11-61" id="h1-11-61" class="i">+        default = Label(&quot;@nodejs//:node&quot;),
</a><a href="#h1-11-62" id="h1-11-62" class="i">+    ),
</a><a href="#h1-11-63" id="h1-11-63" class="i">+    &quot;max_old_memory&quot;: attr.int(),
</a><a href="#h1-11-64" id="h1-11-64" class="i">+    &quot;expose_gc&quot;: attr.bool(default = False),
</a> }
 
 node_binary = rule(
<a href="#h1-11-68" id="h1-11-68" class="d">-    implementation = _node_binary_impl,
</a><a href="#h1-11-69" id="h1-11-69" class="d">-    executable = True,
</a>     attrs = _node_bin_attrs,
<a href="#h1-11-71" id="h1-11-71" class="i">+    executable = True,
</a><a href="#h1-11-72" id="h1-11-72" class="i">+    implementation = _node_binary_impl,
</a> )
<a href="#h1-11-74" id="h1-11-74" class="i">+
</a> &quot;&quot;&quot;Creates a node binary, which is an executable Node program consisting
 of a collection of `.js` source files.
 
<a href="#h1-12" id="h1-12" class="h">@@ -539,10 +546,11 @@ Args:
</a> &quot;&quot;&quot;
 
 node_test = rule(
<a href="#h1-12-3" id="h1-12-3" class="d">-    implementation = _node_binary_impl,
</a><a href="#h1-12-4" id="h1-12-4" class="d">-    test = True,
</a>     attrs = _node_bin_attrs,
<a href="#h1-12-6" id="h1-12-6" class="i">+    test = True,
</a><a href="#h1-12-7" id="h1-12-7" class="i">+    implementation = _node_binary_impl,
</a> )
<a href="#h1-12-9" id="h1-12-9" class="i">+
</a> &quot;&quot;&quot;
 Defines a basic node test. Succeeds if the program has a return code of
 0, otherwise it fails.
<a href="#h1-13" id="h1-13" class="h">@@ -560,10 +568,14 @@ Args:
</a>   node: The node binary used to run the binary. Must be greater than 6.2.0.
 &quot;&quot;&quot;
 
<a href="#h1-13-3" id="h1-13-3" class="d">-def mocha_test(name, srcs=[], deps=[], extra_args=[],
</a><a href="#h1-13-4" id="h1-13-4" class="d">-               mocha_target=&#39;@org_dropbox_rules_node//npm/mocha&#39;,
</a><a href="#h1-13-5" id="h1-13-5" class="d">-               chai_target=&#39;@org_dropbox_rules_node//npm/chai&#39;,
</a><a href="#h1-13-6" id="h1-13-6" class="d">-               **kwargs):
</a><a href="#h1-13-7" id="h1-13-7" class="i">+def mocha_test(
</a><a href="#h1-13-8" id="h1-13-8" class="i">+        name,
</a><a href="#h1-13-9" id="h1-13-9" class="i">+        srcs = [],
</a><a href="#h1-13-10" id="h1-13-10" class="i">+        deps = [],
</a><a href="#h1-13-11" id="h1-13-11" class="i">+        extra_args = [],
</a><a href="#h1-13-12" id="h1-13-12" class="i">+        mocha_target = &quot;@org_dropbox_rules_node//npm/mocha&quot;,
</a><a href="#h1-13-13" id="h1-13-13" class="i">+        chai_target = &quot;@org_dropbox_rules_node//npm/chai&quot;,
</a><a href="#h1-13-14" id="h1-13-14" class="i">+        **kwargs):
</a>     &quot;&quot;&quot;
     Defines a node test that uses mocha. Takes the same args as
     `node_binary`, except that you can&#39;t pass a `main` arg,
<a href="#h1-14" id="h1-14" class="h">@@ -593,7 +605,7 @@ def mocha_test(name, srcs=[], deps=[], extra_args=[],
</a>     #
     # TODO: After node is upgraded to 7.1.0+, set the env
     # NODE_PRESERVE_SYMLINKS=1 and see if `bin/mocha` works.
<a href="#h1-14-3" id="h1-14-3" class="d">-    main = &#39;node_modules/mocha/bin/_mocha&#39;
</a><a href="#h1-14-4" id="h1-14-4" class="i">+    main = &quot;node_modules/mocha/bin/_mocha&quot;
</a> 
     node_test(
         name = name,
<a href="#h1-15" id="h1-15" class="h">@@ -604,10 +616,9 @@ def mocha_test(name, srcs=[], deps=[], extra_args=[],
</a>         **kwargs
     )
 
<a href="#h1-15-3" id="h1-15-3" class="d">-
</a> def _node_internal_module_impl(ctx):
     if ctx.attr.package_json and ctx.attr.main:
<a href="#h1-15-6" id="h1-15-6" class="d">-        fail(&#39;Can only specify one of package_json or main&#39;)
</a><a href="#h1-15-7" id="h1-15-7" class="i">+        fail(&quot;Can only specify one of package_json or main&quot;)
</a> 
     srcs, all_node_modules = _collect_srcs_and_deps(ctx)
 
<a href="#h1-16" id="h1-16" class="h">@@ -618,28 +629,28 @@ def _node_internal_module_impl(ctx):
</a>         require_name = ctx.label.name
 
     if ctx.attr.package_json:
<a href="#h1-16-3" id="h1-16-3" class="d">-        srcs += [ctx.file.package_json]
</a><a href="#h1-16-4" id="h1-16-4" class="i">+        srcs = depset([ctx.file.package_json], transitive = srcs)
</a>     elif ctx.attr.main:
         # Create a package.json file that points to the &#39;main&#39; js
         # file.
<a href="#h1-16-8" id="h1-16-8" class="d">-        package_json_src = ctx.new_file(&#39;package.json&#39;)
</a><a href="#h1-16-9" id="h1-16-9" class="i">+        package_json_src = ctx.actions.declare_file(&quot;package.json&quot;)
</a>         main = ctx.file.main
 
         main_relpath = _get_relpath(ctx, main)
<a href="#h1-16-13" id="h1-16-13" class="d">-        ctx.file_action(
</a><a href="#h1-16-14" id="h1-16-14" class="i">+        ctx.actions.write(
</a>             package_json_src,
<a href="#h1-16-16" id="h1-16-16" class="d">-            &#39;&#39;&#39;{{&quot;main&quot;: &quot;{main_relpath}&quot;}}&#39;&#39;&#39;.format(main_relpath=main_relpath),
</a><a href="#h1-16-17" id="h1-16-17" class="i">+            &#39;&#39;&#39;{{&quot;main&quot;: &quot;{main_relpath}&quot;}}&#39;&#39;&#39;.format(main_relpath = main_relpath),
</a>         )
<a href="#h1-16-19" id="h1-16-19" class="d">-        srcs += [package_json_src]
</a><a href="#h1-16-20" id="h1-16-20" class="i">+        srcs = depset([package_json_src], transitive = [srcs])
</a> 
     node_modules_srcs_dict = _new_node_modules_srcs_dict()
<a href="#h1-16-23" id="h1-16-23" class="d">-    for src in srcs:
</a><a href="#h1-16-24" id="h1-16-24" class="i">+    for src in srcs.to_list():
</a>         relpath = _get_relpath(ctx, src)
 
<a href="#h1-16-27" id="h1-16-27" class="d">-        require_path = require_name + &#39;/&#39; + relpath
</a><a href="#h1-16-28" id="h1-16-28" class="i">+        require_path = require_name + &quot;/&quot; + relpath
</a>         if require_path in node_modules_srcs_dict:
<a href="#h1-16-30" id="h1-16-30" class="d">-            fail(&#39;Duplicate path in node_modules: {require_path}&#39;.format(
</a><a href="#h1-16-31" id="h1-16-31" class="d">-                require_path=require_path,
</a><a href="#h1-16-32" id="h1-16-32" class="i">+            fail(&quot;Duplicate path in node_modules: {require_path}&quot;.format(
</a><a href="#h1-16-33" id="h1-16-33" class="i">+                require_path = require_path,
</a>             ))
         node_modules_srcs_dict[require_path] = src
 
<a href="#h1-17" id="h1-17" class="h">@@ -647,21 +658,21 @@ def _node_internal_module_impl(ctx):
</a> 
     return struct(
         all_node_modules = all_node_modules,
<a href="#h1-17-3" id="h1-17-3" class="d">-        runfiles = ctx.runfiles(collect_default=True),
</a><a href="#h1-17-4" id="h1-17-4" class="i">+        runfiles = ctx.runfiles(collect_default = True),
</a>     )
 
<a href="#h1-17-7" id="h1-17-7" class="d">-
</a> node_internal_module = rule(
<a href="#h1-17-9" id="h1-17-9" class="d">-    implementation = _node_internal_module_impl,
</a>     attrs = {
<a href="#h1-17-11" id="h1-17-11" class="d">-        &#39;srcs&#39;: attr.label_list(allow_files=True),
</a><a href="#h1-17-12" id="h1-17-12" class="d">-        &#39;deps&#39;: attr.label_list(allow_files=False),
</a><a href="#h1-17-13" id="h1-17-13" class="d">-        &#39;data&#39;: attr.label_list(allow_files=True),
</a><a href="#h1-17-14" id="h1-17-14" class="d">-        &#39;require_name&#39;: attr.string(),
</a><a href="#h1-17-15" id="h1-17-15" class="d">-        &#39;package_json&#39;: attr.label(allow_single_file=True),
</a><a href="#h1-17-16" id="h1-17-16" class="d">-        &#39;main&#39;: attr.label(allow_single_file=True),
</a><a href="#h1-17-17" id="h1-17-17" class="d">-    }
</a><a href="#h1-17-18" id="h1-17-18" class="i">+        &quot;srcs&quot;: attr.label_list(allow_files = True),
</a><a href="#h1-17-19" id="h1-17-19" class="i">+        &quot;deps&quot;: attr.label_list(allow_files = False),
</a><a href="#h1-17-20" id="h1-17-20" class="i">+        &quot;data&quot;: attr.label_list(allow_files = True),
</a><a href="#h1-17-21" id="h1-17-21" class="i">+        &quot;require_name&quot;: attr.string(),
</a><a href="#h1-17-22" id="h1-17-22" class="i">+        &quot;package_json&quot;: attr.label(allow_single_file = True),
</a><a href="#h1-17-23" id="h1-17-23" class="i">+        &quot;main&quot;: attr.label(allow_single_file = True),
</a><a href="#h1-17-24" id="h1-17-24" class="i">+    },
</a><a href="#h1-17-25" id="h1-17-25" class="i">+    implementation = _node_internal_module_impl,
</a> )
<a href="#h1-17-27" id="h1-17-27" class="i">+
</a> &quot;&quot;&quot;
 Create an internal node module that can be included in the `deps` for
 other rules and that can be required as `require(&#39;module_name&#39;)`.
<a href="#h1-18" id="h1-18" class="h">@@ -696,46 +707,47 @@ def _node_import_test(name, deps, npm_req, no_import_main_test):
</a>         See npm_library for details.
 
     &quot;&quot;&quot;
<a href="#h1-18-3" id="h1-18-3" class="i">+
</a>     # Break npm_req into its name and version.
<a href="#h1-18-5" id="h1-18-5" class="d">-    if &#39;@&#39; not in npm_req:
</a><a href="#h1-18-6" id="h1-18-6" class="d">-        fail(&#39;npm_req is malformed, it must look like `module-name@1.2.3`: &#39; + npm_req)
</a><a href="#h1-18-7" id="h1-18-7" class="d">-    split = npm_req.split(&#39;@&#39;)
</a><a href="#h1-18-8" id="h1-18-8" class="i">+    if &quot;@&quot; not in npm_req:
</a><a href="#h1-18-9" id="h1-18-9" class="i">+        fail(&quot;npm_req is malformed, it must look like `module-name@1.2.3`: &quot; + npm_req)
</a><a href="#h1-18-10" id="h1-18-10" class="i">+    split = npm_req.split(&quot;@&quot;)
</a> 
<a href="#h1-18-12" id="h1-18-12" class="d">-    import_name = &#39;@&#39;.join(split[:-1])
</a><a href="#h1-18-13" id="h1-18-13" class="i">+    import_name = &quot;@&quot;.join(split[:-1])
</a>     import_version = split[-1]
 
     args = [
<a href="#h1-18-17" id="h1-18-17" class="d">-        &#39;--import_name=&#39; + import_name,
</a><a href="#h1-18-18" id="h1-18-18" class="d">-        &#39;--import_version=&#39; + import_version,
</a><a href="#h1-18-19" id="h1-18-19" class="i">+        &quot;--import_name=&quot; + import_name,
</a><a href="#h1-18-20" id="h1-18-20" class="i">+        &quot;--import_version=&quot; + import_version,
</a>     ]
     if no_import_main_test:
<a href="#h1-18-23" id="h1-18-23" class="d">-        args.append(&#39;--no_import_main_test&#39;)
</a><a href="#h1-18-24" id="h1-18-24" class="i">+        args.append(&quot;--no_import_main_test&quot;)
</a> 
     node_test(
         name = name,
<a href="#h1-18-28" id="h1-18-28" class="d">-        srcs = [&#39;@org_dropbox_rules_node//node/tools:import_check.js&#39;],
</a><a href="#h1-18-29" id="h1-18-29" class="d">-        main = &#39;@org_dropbox_rules_node//node/tools:import_check.js&#39;,
</a><a href="#h1-18-30" id="h1-18-30" class="d">-        deps = deps,
</a><a href="#h1-18-31" id="h1-18-31" class="i">+        size = &quot;small&quot;,
</a><a href="#h1-18-32" id="h1-18-32" class="i">+        srcs = [&quot;@org_dropbox_rules_node//node/tools:import_check.js&quot;],
</a>         extra_args = args,
<a href="#h1-18-34" id="h1-18-34" class="d">-        size = &#39;small&#39;,
</a><a href="#h1-18-35" id="h1-18-35" class="i">+        main = &quot;@org_dropbox_rules_node//node/tools:import_check.js&quot;,
</a><a href="#h1-18-36" id="h1-18-36" class="i">+        deps = deps,
</a>     )
 
 def _node_build_impl(ctx):
     env = dict(ctx.attr.env.items() + {
<a href="#h1-18-41" id="h1-18-41" class="d">-        &#39;BAZEL_OUTPUT_DIR&#39;: _get_output_dir(ctx),
</a><a href="#h1-18-42" id="h1-18-42" class="i">+        &quot;BAZEL_OUTPUT_DIR&quot;: _get_output_dir(ctx),
</a>     }.items())
 
     args = []
     if ctx.var[&quot;COMPILATION_MODE&quot;] == &quot;opt&quot; and ctx.attr.optimize_flag:
         args.append(ctx.attr.optimize_flag)
 
<a href="#h1-18-49" id="h1-18-49" class="d">-    ctx.action(
</a><a href="#h1-18-50" id="h1-18-50" class="i">+    ctx.actions.run(
</a>         executable = ctx.executable.builder,
         outputs = ctx.outputs.outs,
         env = env,
         arguments = args + ctx.attr.extra_args,
<a href="#h1-18-55" id="h1-18-55" class="d">-        mnemonic = &#39;NodeBuild&#39;,
</a><a href="#h1-18-56" id="h1-18-56" class="d">-        progress_message = &#39;building {} with node&#39;.format(ctx.label.name),
</a><a href="#h1-18-57" id="h1-18-57" class="i">+        mnemonic = &quot;NodeBuild&quot;,
</a><a href="#h1-18-58" id="h1-18-58" class="i">+        progress_message = &quot;building {} with node&quot;.format(ctx.label.name),
</a>     )
     return struct(
         files = depset(ctx.outputs.outs),
<a href="#h1-19" id="h1-19" class="h">@@ -746,16 +758,21 @@ def _node_build_impl(ctx):
</a>     )
 
 node_build = rule(
<a href="#h1-19-3" id="h1-19-3" class="d">-    implementation = _node_build_impl,
</a>     attrs = {
<a href="#h1-19-5" id="h1-19-5" class="d">-        &#39;outs&#39;: attr.output_list(mandatory=True),
</a><a href="#h1-19-6" id="h1-19-6" class="d">-        &#39;data&#39;: attr.label_list(allow_files=True),
</a><a href="#h1-19-7" id="h1-19-7" class="d">-        &#39;builder&#39;: attr.label(executable=True, cfg=&#39;host&#39;, mandatory=True),
</a><a href="#h1-19-8" id="h1-19-8" class="d">-        &#39;env&#39;: attr.string_dict(),
</a><a href="#h1-19-9" id="h1-19-9" class="d">-        &#39;extra_args&#39;: attr.string_list(),
</a><a href="#h1-19-10" id="h1-19-10" class="d">-        &#39;optimize_flag&#39;: attr.string(),
</a><a href="#h1-19-11" id="h1-19-11" class="i">+        &quot;outs&quot;: attr.output_list(mandatory = True),
</a><a href="#h1-19-12" id="h1-19-12" class="i">+        &quot;data&quot;: attr.label_list(allow_files = True),
</a><a href="#h1-19-13" id="h1-19-13" class="i">+        &quot;builder&quot;: attr.label(
</a><a href="#h1-19-14" id="h1-19-14" class="i">+            executable = True,
</a><a href="#h1-19-15" id="h1-19-15" class="i">+            cfg = &quot;host&quot;,
</a><a href="#h1-19-16" id="h1-19-16" class="i">+            mandatory = True,
</a><a href="#h1-19-17" id="h1-19-17" class="i">+        ),
</a><a href="#h1-19-18" id="h1-19-18" class="i">+        &quot;env&quot;: attr.string_dict(),
</a><a href="#h1-19-19" id="h1-19-19" class="i">+        &quot;extra_args&quot;: attr.string_list(),
</a><a href="#h1-19-20" id="h1-19-20" class="i">+        &quot;optimize_flag&quot;: attr.string(),
</a>     },
<a href="#h1-19-22" id="h1-19-22" class="i">+    implementation = _node_build_impl,
</a> )
<a href="#h1-19-24" id="h1-19-24" class="i">+
</a> &quot;&quot;&quot;Build JS/CSS/etc with a node binary.
 
 This is a low-level rule, and is only recommended for completely
<a href="#h1-20" id="h1-20" class="h">@@ -784,9 +801,16 @@ Args:
</a> 
 &quot;&quot;&quot;
 
<a href="#h1-20-3" id="h1-20-3" class="d">-
</a><a href="#h1-20-4" id="h1-20-4" class="d">-def webpack_build(name, srcs=[], deps=[], data=[], config=&#39;&#39;, outs=[], env={},
</a><a href="#h1-20-5" id="h1-20-5" class="d">-                   extra_args=[], webpack_target=&#39;@org_dropbox_rules_node//npm/webpack&#39;):
</a><a href="#h1-20-6" id="h1-20-6" class="i">+def webpack_build(
</a><a href="#h1-20-7" id="h1-20-7" class="i">+        name,
</a><a href="#h1-20-8" id="h1-20-8" class="i">+        srcs = [],
</a><a href="#h1-20-9" id="h1-20-9" class="i">+        deps = [],
</a><a href="#h1-20-10" id="h1-20-10" class="i">+        data = [],
</a><a href="#h1-20-11" id="h1-20-11" class="i">+        config = &quot;&quot;,
</a><a href="#h1-20-12" id="h1-20-12" class="i">+        outs = [],
</a><a href="#h1-20-13" id="h1-20-13" class="i">+        env = {},
</a><a href="#h1-20-14" id="h1-20-14" class="i">+        extra_args = [],
</a><a href="#h1-20-15" id="h1-20-15" class="i">+        webpack_target = &quot;@org_dropbox_rules_node//npm/webpack&quot;):
</a>     &quot;&quot;&quot;
     Build JS/CSS/etc with webpack.
 
<a href="#h1-21" id="h1-21" class="h">@@ -854,39 +878,37 @@ def webpack_build(name, srcs=[], deps=[], data=[], config=&#39;&#39;, outs=[], env={},
</a> 
     &quot;&quot;&quot;
     if not config:
<a href="#h1-21-3" id="h1-21-3" class="d">-        fail(&#39;Must specify a config&#39;)
</a><a href="#h1-21-4" id="h1-21-4" class="i">+        fail(&quot;Must specify a config&quot;)
</a>     if not outs:
<a href="#h1-21-6" id="h1-21-6" class="d">-        fail(&#39;Must specify output&#39;)
</a><a href="#h1-21-7" id="h1-21-7" class="i">+        fail(&quot;Must specify output&quot;)
</a> 
     srcs += [config]
 
     deps += [webpack_target]
 
     node_binary(
<a href="#h1-21-14" id="h1-21-14" class="d">-        name = name + &#39;_bin&#39;,
</a><a href="#h1-21-15" id="h1-21-15" class="i">+        name = name + &quot;_bin&quot;,
</a>         srcs = srcs,
<a href="#h1-21-17" id="h1-21-17" class="d">-        deps = deps,
</a>         data = data,
<a href="#h1-21-19" id="h1-21-19" class="d">-        main = &#39;node_modules/webpack/bin/webpack.js&#39;,
</a>         extra_args = [
<a href="#h1-21-21" id="h1-21-21" class="d">-            &#39;--config&#39;,
</a><a href="#h1-21-22" id="h1-21-22" class="d">-            &#39;$RUNFILES/{pkg}/{config}&#39;.format(
</a><a href="#h1-21-23" id="h1-21-23" class="d">-                pkg=native.package_name(),
</a><a href="#h1-21-24" id="h1-21-24" class="d">-                config=config,
</a><a href="#h1-21-25" id="h1-21-25" class="i">+            &quot;--config&quot;,
</a><a href="#h1-21-26" id="h1-21-26" class="i">+            &quot;$RUNFILES/{pkg}/{config}&quot;.format(
</a><a href="#h1-21-27" id="h1-21-27" class="i">+                pkg = native.package_name(),
</a><a href="#h1-21-28" id="h1-21-28" class="i">+                config = config,
</a>             ),
         ] + extra_args,
<a href="#h1-21-31" id="h1-21-31" class="i">+        main = &quot;node_modules/webpack/bin/webpack.js&quot;,
</a><a href="#h1-21-32" id="h1-21-32" class="i">+        deps = deps,
</a>     )
     node_build(
         name = name,
         outs = outs,
<a href="#h1-21-37" id="h1-21-37" class="i">+        builder = name + &quot;_bin&quot;,
</a>         data = data,
<a href="#h1-21-39" id="h1-21-39" class="d">-        builder = name + &#39;_bin&#39;,
</a><a href="#h1-21-40" id="h1-21-40" class="d">-        optimize_flag = &#39;-p&#39;,
</a>         env = env,
<a href="#h1-21-42" id="h1-21-42" class="i">+        optimize_flag = &quot;-p&quot;,
</a>     )
 
<a href="#h1-21-45" id="h1-21-45" class="d">-
</a><a href="#h1-21-46" id="h1-21-46" class="d">-
</a> NODEJS_BUILD_FILE_CONTENT = r&quot;&quot;&quot;
 package(default_visibility = [ &quot;//visibility:public&quot; ])
 
<a href="#h1-22" id="h1-22" class="h">@@ -905,13 +927,13 @@ filegroup(
</a> )
 &quot;&quot;&quot;
 
<a href="#h1-22-3" id="h1-22-3" class="d">-def node_repositories(omit_nodejs=False):
</a><a href="#h1-22-4" id="h1-22-4" class="i">+def node_repositories(omit_nodejs = False):
</a>     if not omit_nodejs:
         http_archive(
             name = &quot;nodejs&quot;,
<a href="#h1-22-8" id="h1-22-8" class="d">-            url = &quot;https://nodejs.org/dist/v6.11.1/node-v6.11.1-linux-x64.tar.xz&quot;,
</a><a href="#h1-22-9" id="h1-22-9" class="d">-            type = &quot;tar.xz&quot;,
</a><a href="#h1-22-10" id="h1-22-10" class="d">-            strip_prefix = &quot;node-v6.11.1-linux-x64&quot;,
</a><a href="#h1-22-11" id="h1-22-11" class="d">-            sha256 = &quot;e68cc956f0ca5c54e7f3016d639baf987f6f9de688bb7b31339ab7561af88f41&quot;,
</a>             build_file_content = NODEJS_BUILD_FILE_CONTENT,
<a href="#h1-22-13" id="h1-22-13" class="i">+            sha256 = &quot;e68cc956f0ca5c54e7f3016d639baf987f6f9de688bb7b31339ab7561af88f41&quot;,
</a><a href="#h1-22-14" id="h1-22-14" class="i">+            strip_prefix = &quot;node-v6.11.1-linux-x64&quot;,
</a><a href="#h1-22-15" id="h1-22-15" class="i">+            type = &quot;tar.xz&quot;,
</a><a href="#h1-22-16" id="h1-22-16" class="i">+            url = &quot;https://nodejs.org/dist/v6.11.1/node-v6.11.1-linux-x64.tar.xz&quot;,
</a>         )
</pre>
</div>
</body>
</html>
