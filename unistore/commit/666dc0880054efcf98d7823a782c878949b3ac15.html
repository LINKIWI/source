<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>internal/backend, internal/server: Pass original gRPC request context through entire backend chain - unistore - Universal object storage server with pluggable backends</title>
<meta name="description" content="Universal object storage server with pluggable backends" />
<meta name="author" content="Kevin Lin" />
<link rel="icon" type="image/png" href="https://static.kevinlin.info/favicon.png" />
<link rel="alternate" type="application/atom+xml" title="unistore Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="unistore Atom Feed (tags)" href="../tags.xml" />
<style type="text/css">
body{color:#000;background-color:#fff;font-family:monospace}h1,h2,h3,h4,h5,h6{font-size:1em;margin:0}img,h1,h2{vertical-align:middle}img{border:0}a:target{background-color:#ccc}a.d,a.h,a.i{text-decoration:none}a.line{text-decoration:none;user-select:none}#blob a{color:#555}#blob a:hover{color:blue;text-decoration:none}table thead td{font-weight:bold}table td{padding:0 .4em}table td pre{margin:0}#content table td{vertical-align:top;white-space:nowrap}#branches tr:hover td,#tags tr:hover td,#index tr:hover td,#log tr:hover td,#files tr:hover td{background-color:#eee}#index tr td:nth-child(2),#tags tr td:nth-child(3),#branches tr td:nth-child(3),#log tr td:nth-child(2){white-space:normal}td.num{text-align:right}.desc{color:#555}hr{border:0;border-top:1px solid #555;height:1px}pre{font-family:monospace}pre a.h{color:#00a}.A,span.i,pre a.i{color:#070}.D,span.d,pre a.d{color:#e00}pre a.h:hover,pre a.i:hover,pre a.d:hover{text-decoration:none}
</style>
</head>
<body>
<table><tr><td><a href="/"><img src="https://static.kevinlin.info/favicon.png" alt="" width="32" height="32" /></a></td><td><h1>unistore</h1><span class="desc">Universal object storage server with pluggable backends</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://source.static.kevinlin.info/unistore.git">https://source.static.kevinlin.info/unistore.git</a></td></tr><tr><td></td><td>
<a href="../log">Log</a> | <a href="../files">Files</a> | <a href="../refs">Refs</a> | <a href="../file/README.md">README</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/666dc0880054efcf98d7823a782c878949b3ac15">666dc0880054efcf98d7823a782c878949b3ac15</a>
<b>parent</b> <a href="../commit/8b08f46a5e11272f47eb991168efb09ed67133c7">8b08f46a5e11272f47eb991168efb09ed67133c7</a>
<b>Author:</b> Kevin Lin &lt;<a href="mailto:developer@kevinlin.info">developer@kevinlin.info</a>&gt;
<b>Date:</b>   Mon  3 Jan 2022 16:30:14 -0800

internal/backend, internal/server: Pass original gRPC request context through entire backend chain

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">internal/backend/alias.go</a></td><td> | </td><td class="num">29</td><td><span class="i">+++++++++++++++</span><span class="d">--------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">internal/backend/b2.go</a></td><td> | </td><td class="num">15</td><td><span class="i">++++++++</span><span class="d">-------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">internal/backend/checksum.go</a></td><td> | </td><td class="num">17</td><td><span class="i">+++++++++</span><span class="d">--------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">internal/backend/disk.go</a></td><td> | </td><td class="num">15</td><td><span class="i">++++++++</span><span class="d">-------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">internal/backend/mux.go</a></td><td> | </td><td class="num">29</td><td><span class="i">+++++++++++++++</span><span class="d">--------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">internal/backend/permission.go</a></td><td> | </td><td class="num">29</td><td><span class="i">+++++++++++++++</span><span class="d">--------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">internal/backend/processor.go</a></td><td> | </td><td class="num">17</td><td><span class="i">+++++++++</span><span class="d">--------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">internal/backend/threshold.go</a></td><td> | </td><td class="num">7</td><td><span class="i">++++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h8">internal/backend/types.go</a></td><td> | </td><td class="num">15</td><td><span class="i">++++++++</span><span class="d">-------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h9">internal/backend/unistore.go</a></td><td> | </td><td class="num">19</td><td><span class="i">+++++++</span><span class="d">------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h10">internal/server/unistore.go</a></td><td> | </td><td class="num">14</td><td><span class="i">+++++++</span><span class="d">-------</span></td></tr>
</table></pre><pre>11 files changed, 105 insertions(+), 101 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/internal/backend/alias.go">internal/backend/alias.go</a> b/<a href="../file/internal/backend/alias.go">internal/backend/alias.go</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -1,6 +1,7 @@
</a> package backend
 
 import (
<a href="#h0-0-3" id="h0-0-3" class="i">+	&quot;context&quot;
</a> 	&quot;fmt&quot;
 
 	&quot;unistore/internal/config&quot;
<a href="#h0-1" id="h0-1" class="h">@@ -23,7 +24,7 @@ func NewAlias(aliases []*config.Alias, backend Backend) Backend {
</a> }
 
 // HeadObject conditionally overwrites the request bucket and defers to the underlying backend.
<a href="#h0-1-3" id="h0-1-3" class="d">-func (a *Alias) HeadObject(request *service.HeadObjectRequest) (*service.HeadObjectResponse, error) {
</a><a href="#h0-1-4" id="h0-1-4" class="i">+func (a *Alias) HeadObject(ctx context.Context, request *service.HeadObjectRequest) (*service.HeadObjectResponse, error) {
</a> 	for _, alias := range a.aliases {
 		if alias.Pattern.MatchString(request.Resource.Bucket) {
 			request.Resource.Bucket = alias.Alias
<a href="#h0-2" id="h0-2" class="h">@@ -31,11 +32,11 @@ func (a *Alias) HeadObject(request *service.HeadObjectRequest) (*service.HeadObj
</a> 		}
 	}
 
<a href="#h0-2-3" id="h0-2-3" class="d">-	return a.Backend.HeadObject(request)
</a><a href="#h0-2-4" id="h0-2-4" class="i">+	return a.Backend.HeadObject(ctx, request)
</a> }
 
 // GetObject conditionally overwrites the request bucket and defers to the underlying backend.
<a href="#h0-2-8" id="h0-2-8" class="d">-func (a *Alias) GetObject(request *service.GetObjectRequest) (*service.GetObjectResponse, error) {
</a><a href="#h0-2-9" id="h0-2-9" class="i">+func (a *Alias) GetObject(ctx context.Context, request *service.GetObjectRequest) (*service.GetObjectResponse, error) {
</a> 	for _, alias := range a.aliases {
 		if alias.Pattern.MatchString(request.Resource.Bucket) {
 			request.Resource.Bucket = alias.Alias
<a href="#h0-3" id="h0-3" class="h">@@ -43,11 +44,11 @@ func (a *Alias) GetObject(request *service.GetObjectRequest) (*service.GetObject
</a> 		}
 	}
 
<a href="#h0-3-3" id="h0-3-3" class="d">-	return a.Backend.GetObject(request)
</a><a href="#h0-3-4" id="h0-3-4" class="i">+	return a.Backend.GetObject(ctx, request)
</a> }
 
 // StreamGetObject conditionally overwrites the request bucket and defers to the underlying backend.
<a href="#h0-3-8" id="h0-3-8" class="d">-func (a *Alias) StreamGetObject(request *service.GetObjectStreamRequest) (&lt;-chan *service.GetObjectStreamResponse, error) {
</a><a href="#h0-3-9" id="h0-3-9" class="i">+func (a *Alias) StreamGetObject(ctx context.Context, request *service.GetObjectStreamRequest) (&lt;-chan *service.GetObjectStreamResponse, error) {
</a> 	for _, alias := range a.aliases {
 		if alias.Pattern.MatchString(request.Request.Resource.Bucket) {
 			request.Request.Resource.Bucket = alias.Alias
<a href="#h0-4" id="h0-4" class="h">@@ -55,11 +56,11 @@ func (a *Alias) StreamGetObject(request *service.GetObjectStreamRequest) (&lt;-chan
</a> 		}
 	}
 
<a href="#h0-4-3" id="h0-4-3" class="d">-	return a.Backend.StreamGetObject(request)
</a><a href="#h0-4-4" id="h0-4-4" class="i">+	return a.Backend.StreamGetObject(ctx, request)
</a> }
 
 // PutObject conditionally overwrites the request bucket and defers to the underlying backend.
<a href="#h0-4-8" id="h0-4-8" class="d">-func (a *Alias) PutObject(request *service.PutObjectRequest) (*service.PutObjectResponse, error) {
</a><a href="#h0-4-9" id="h0-4-9" class="i">+func (a *Alias) PutObject(ctx context.Context, request *service.PutObjectRequest) (*service.PutObjectResponse, error) {
</a> 	for _, alias := range a.aliases {
 		if alias.Pattern.MatchString(request.Resource.Bucket) {
 			request.Resource.Bucket = alias.Alias
<a href="#h0-5" id="h0-5" class="h">@@ -67,11 +68,11 @@ func (a *Alias) PutObject(request *service.PutObjectRequest) (*service.PutObject
</a> 		}
 	}
 
<a href="#h0-5-3" id="h0-5-3" class="d">-	return a.Backend.PutObject(request)
</a><a href="#h0-5-4" id="h0-5-4" class="i">+	return a.Backend.PutObject(ctx, request)
</a> }
 
 // StreamPutObject conditionally overwrites the request bucket and defers to the underlying backend.
<a href="#h0-5-8" id="h0-5-8" class="d">-func (a *Alias) StreamPutObject(stream chan *service.PutObjectStreamRequest) (*service.PutObjectStreamResponse, error) {
</a><a href="#h0-5-9" id="h0-5-9" class="i">+func (a *Alias) StreamPutObject(ctx context.Context, stream chan *service.PutObjectStreamRequest) (*service.PutObjectStreamResponse, error) {
</a> 	proxy := make(chan *service.PutObjectStreamRequest)
 
 	go func() {
<a href="#h0-6" id="h0-6" class="h">@@ -89,11 +90,11 @@ func (a *Alias) StreamPutObject(stream chan *service.PutObjectStreamRequest) (*s
</a> 		close(proxy)
 	}()
 
<a href="#h0-6-3" id="h0-6-3" class="d">-	return a.Backend.StreamPutObject(proxy)
</a><a href="#h0-6-4" id="h0-6-4" class="i">+	return a.Backend.StreamPutObject(ctx, proxy)
</a> }
 
 // DeleteObject conditionally overwrites the request bucket and defers to the underlying backend.
<a href="#h0-6-8" id="h0-6-8" class="d">-func (a *Alias) DeleteObject(request *service.DeleteObjectRequest) (*service.DeleteObjectResponse, error) {
</a><a href="#h0-6-9" id="h0-6-9" class="i">+func (a *Alias) DeleteObject(ctx context.Context, request *service.DeleteObjectRequest) (*service.DeleteObjectResponse, error) {
</a> 	for _, alias := range a.aliases {
 		if alias.Pattern.MatchString(request.Resource.Bucket) {
 			request.Resource.Bucket = alias.Alias
<a href="#h0-7" id="h0-7" class="h">@@ -101,11 +102,11 @@ func (a *Alias) DeleteObject(request *service.DeleteObjectRequest) (*service.Del
</a> 		}
 	}
 
<a href="#h0-7-3" id="h0-7-3" class="d">-	return a.Backend.DeleteObject(request)
</a><a href="#h0-7-4" id="h0-7-4" class="i">+	return a.Backend.DeleteObject(ctx, request)
</a> }
 
 // ListObjects conditionally overwrites the request bucket and defers to the underlying backend.
<a href="#h0-7-8" id="h0-7-8" class="d">-func (a *Alias) ListObjects(request *service.ListObjectsRequest) (*service.ListObjectsResponse, error) {
</a><a href="#h0-7-9" id="h0-7-9" class="i">+func (a *Alias) ListObjects(ctx context.Context, request *service.ListObjectsRequest) (*service.ListObjectsResponse, error) {
</a> 	for _, alias := range a.aliases {
 		if alias.Pattern.MatchString(request.Resource.Bucket) {
 			request.Resource.Bucket = alias.Alias
<a href="#h0-8" id="h0-8" class="h">@@ -113,7 +114,7 @@ func (a *Alias) ListObjects(request *service.ListObjectsRequest) (*service.ListO
</a> 		}
 	}
 
<a href="#h0-8-3" id="h0-8-3" class="d">-	return a.Backend.ListObjects(request)
</a><a href="#h0-8-4" id="h0-8-4" class="i">+	return a.Backend.ListObjects(ctx, request)
</a> }
 
 // String returns a human-consumable representation of this backend.
<b>diff --git a/<a id="h1" href="../file/internal/backend/b2.go">internal/backend/b2.go</a> b/<a href="../file/internal/backend/b2.go">internal/backend/b2.go</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -2,6 +2,7 @@ package backend
</a> 
 import (
 	&quot;bytes&quot;
<a href="#h1-0-3" id="h1-0-3" class="i">+	&quot;context&quot;
</a> 	&quot;crypto/sha1&quot;
 	&quot;fmt&quot;
 	&quot;io&quot;
<a href="#h1-1" id="h1-1" class="h">@@ -89,7 +90,7 @@ func NewB2(cfg *config.B2) (Backend, error) {
</a> }
 
 // HeadObject locates the requested file ID followed by listing its metadata.
<a href="#h1-1-3" id="h1-1-3" class="d">-func (b *B2) HeadObject(request *service.HeadObjectRequest) (*service.HeadObjectResponse, error) {
</a><a href="#h1-1-4" id="h1-1-4" class="i">+func (b *B2) HeadObject(ctx context.Context, request *service.HeadObjectRequest) (*service.HeadObjectResponse, error) {
</a> 	auth, err := b.authorizeAccount()
 	if err != nil {
 		return nil, b.createError(err)
<a href="#h1-2" id="h1-2" class="h">@@ -153,7 +154,7 @@ func (b *B2) HeadObject(request *service.HeadObjectRequest) (*service.HeadObject
</a> }
 
 // GetObject downloads the requested file and buffers its full contents in memory for response.
<a href="#h1-2-3" id="h1-2-3" class="d">-func (b *B2) GetObject(request *service.GetObjectRequest) (*service.GetObjectResponse, error) {
</a><a href="#h1-2-4" id="h1-2-4" class="i">+func (b *B2) GetObject(ctx context.Context, request *service.GetObjectRequest) (*service.GetObjectResponse, error) {
</a> 	auth, err := b.authorizeAccount()
 	if err != nil {
 		return nil, b.createError(err)
<a href="#h1-3" id="h1-3" class="h">@@ -195,7 +196,7 @@ func (b *B2) GetObject(request *service.GetObjectRequest) (*service.GetObjectRes
</a> // StreamGetObject is a streaming implementation of GetObject. It segments the requests to B2 in
 // chunks of the requested size using the Range request directive, and pipes chunked responses into
 // a stream channel.
<a href="#h1-3-3" id="h1-3-3" class="d">-func (b *B2) StreamGetObject(request *service.GetObjectStreamRequest) (&lt;-chan *service.GetObjectStreamResponse, error) {
</a><a href="#h1-3-4" id="h1-3-4" class="i">+func (b *B2) StreamGetObject(ctx context.Context, request *service.GetObjectStreamRequest) (&lt;-chan *service.GetObjectStreamResponse, error) {
</a> 	stream := make(chan *service.GetObjectStreamResponse)
 
 	auth, err := b.authorizeAccount()
<a href="#h1-4" id="h1-4" class="h">@@ -283,7 +284,7 @@ func (b *B2) StreamGetObject(request *service.GetObjectStreamRequest) (&lt;-chan *s
</a> }
 
 // PutObject uploads the request file in full.
<a href="#h1-4-3" id="h1-4-3" class="d">-func (b *B2) PutObject(request *service.PutObjectRequest) (*service.PutObjectResponse, error) {
</a><a href="#h1-4-4" id="h1-4-4" class="i">+func (b *B2) PutObject(ctx context.Context, request *service.PutObjectRequest) (*service.PutObjectResponse, error) {
</a> 	auth, err := b.authorizeAccount()
 	if err != nil {
 		return nil, b.createError(err)
<a href="#h1-5" id="h1-5" class="h">@@ -356,7 +357,7 @@ func (b *B2) PutObject(request *service.PutObjectRequest) (*service.PutObjectRes
</a> // StreamPutObject is a streaming implementation of PutObject. It identifies the target file, starts
 // a large file, authorizes a chunked upload URL, uploads each incoming chunk in a single request,
 // and finishes the file when all chunks have been uploaded.
<a href="#h1-5-3" id="h1-5-3" class="d">-func (b *B2) StreamPutObject(stream chan *service.PutObjectStreamRequest) (*service.PutObjectStreamResponse, error) {
</a><a href="#h1-5-4" id="h1-5-4" class="i">+func (b *B2) StreamPutObject(ctx context.Context, stream chan *service.PutObjectStreamRequest) (*service.PutObjectStreamResponse, error) {
</a> 	var authorization string
 	var uploadURL *url.URL
 	var fileID string
<a href="#h1-6" id="h1-6" class="h">@@ -479,7 +480,7 @@ func (b *B2) StreamPutObject(stream chan *service.PutObjectStreamRequest) (*serv
</a> }
 
 // DeleteObject deletes the requested file.
<a href="#h1-6-3" id="h1-6-3" class="d">-func (b *B2) DeleteObject(request *service.DeleteObjectRequest) (*service.DeleteObjectResponse, error) {
</a><a href="#h1-6-4" id="h1-6-4" class="i">+func (b *B2) DeleteObject(ctx context.Context, request *service.DeleteObjectRequest) (*service.DeleteObjectResponse, error) {
</a> 	auth, err := b.authorizeAccount()
 	if err != nil {
 		return nil, b.createError(err)
<a href="#h1-7" id="h1-7" class="h">@@ -544,7 +545,7 @@ func (b *B2) DeleteObject(request *service.DeleteObjectRequest) (*service.Delete
</a> }
 
 // ListObjects retrieves metadata for all files that start with the specified key prefix.
<a href="#h1-7-3" id="h1-7-3" class="d">-func (b *B2) ListObjects(request *service.ListObjectsRequest) (*service.ListObjectsResponse, error) {
</a><a href="#h1-7-4" id="h1-7-4" class="i">+func (b *B2) ListObjects(ctx context.Context, request *service.ListObjectsRequest) (*service.ListObjectsResponse, error) {
</a> 	auth, err := b.authorizeAccount()
 	if err != nil {
 		return nil, b.createError(err)
<b>diff --git a/<a id="h2" href="../file/internal/backend/checksum.go">internal/backend/checksum.go</a> b/<a href="../file/internal/backend/checksum.go">internal/backend/checksum.go</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -1,6 +1,7 @@
</a> package backend
 
 import (
<a href="#h2-0-3" id="h2-0-3" class="i">+	&quot;context&quot;
</a> 	&quot;crypto/md5&quot;
 	&quot;crypto/sha1&quot;
 	&quot;crypto/sha256&quot;
<a href="#h2-1" id="h2-1" class="h">@@ -36,8 +37,8 @@ func NewChecksum(algorithm string, backend Backend) Backend {
</a> 
 // GetObject defers to the underlying Backend and transparently injects a checksum in the response
 // metadata.
<a href="#h2-1-3" id="h2-1-3" class="d">-func (c *Checksum) GetObject(request *service.GetObjectRequest) (*service.GetObjectResponse, error) {
</a><a href="#h2-1-4" id="h2-1-4" class="d">-	resp, err := c.Backend.GetObject(request)
</a><a href="#h2-1-5" id="h2-1-5" class="i">+func (c *Checksum) GetObject(ctx context.Context, request *service.GetObjectRequest) (*service.GetObjectResponse, error) {
</a><a href="#h2-1-6" id="h2-1-6" class="i">+	resp, err := c.Backend.GetObject(ctx, request)
</a> 	if err != nil {
 		return nil, err
 	}
<a href="#h2-2" id="h2-2" class="h">@@ -49,10 +50,10 @@ func (c *Checksum) GetObject(request *service.GetObjectRequest) (*service.GetObj
</a> 
 // StreamGetObject defers to the underlying Backend and transparently injects a checksum for each
 // individual response in the stream.
<a href="#h2-2-3" id="h2-2-3" class="d">-func (c *Checksum) StreamGetObject(request *service.GetObjectStreamRequest) (&lt;-chan *service.GetObjectStreamResponse, error) {
</a><a href="#h2-2-4" id="h2-2-4" class="i">+func (c *Checksum) StreamGetObject(ctx context.Context, request *service.GetObjectStreamRequest) (&lt;-chan *service.GetObjectStreamResponse, error) {
</a> 	proxy := make(chan *service.GetObjectStreamResponse)
 
<a href="#h2-2-7" id="h2-2-7" class="d">-	stream, err := c.Backend.StreamGetObject(request)
</a><a href="#h2-2-8" id="h2-2-8" class="i">+	stream, err := c.Backend.StreamGetObject(ctx, request)
</a> 	if err != nil {
 		return nil, err
 	}
<a href="#h2-3" id="h2-3" class="h">@@ -72,7 +73,7 @@ func (c *Checksum) StreamGetObject(request *service.GetObjectStreamRequest) (&lt;-c
</a> 
 // PutObject validates the checksum in the request, if available. If the checksum matches, the
 // request is passed to the underlying backend; otherwise, an error is returned.
<a href="#h2-3-3" id="h2-3-3" class="d">-func (c *Checksum) PutObject(request *service.PutObjectRequest) (*service.PutObjectResponse, error) {
</a><a href="#h2-3-4" id="h2-3-4" class="i">+func (c *Checksum) PutObject(ctx context.Context, request *service.PutObjectRequest) (*service.PutObjectResponse, error) {
</a> 	if request.Checksum != &quot;&quot; {
 		actual := c.checksum(request.Data)
 
<a href="#h2-4" id="h2-4" class="h">@@ -86,13 +87,13 @@ func (c *Checksum) PutObject(request *service.PutObjectRequest) (*service.PutObj
</a> 		}
 	}
 
<a href="#h2-4-3" id="h2-4-3" class="d">-	return c.Backend.PutObject(request)
</a><a href="#h2-4-4" id="h2-4-4" class="i">+	return c.Backend.PutObject(ctx, request)
</a> }
 
 // StreamPutObject validates the checksum for each individual request as it arrives over the stream,
 // followed by passing the request to the underlying backend. Checksum validation failures result in
 // early termination of the stream.
<a href="#h2-4-10" id="h2-4-10" class="d">-func (c *Checksum) StreamPutObject(stream chan *service.PutObjectStreamRequest) (*service.PutObjectStreamResponse, error) {
</a><a href="#h2-4-11" id="h2-4-11" class="i">+func (c *Checksum) StreamPutObject(ctx context.Context, stream chan *service.PutObjectStreamRequest) (*service.PutObjectStreamResponse, error) {
</a> 	proxy := make(chan *service.PutObjectStreamRequest)
 
 	go func() {
<a href="#h2-5" id="h2-5" class="h">@@ -112,7 +113,7 @@ func (c *Checksum) StreamPutObject(stream chan *service.PutObjectStreamRequest) 
</a> 		close(proxy)
 	}()
 
<a href="#h2-5-3" id="h2-5-3" class="d">-	return c.Backend.StreamPutObject(proxy)
</a><a href="#h2-5-4" id="h2-5-4" class="i">+	return c.Backend.StreamPutObject(ctx, proxy)
</a> }
 
 // String returns a human-consumable representation of this backend.
<b>diff --git a/<a id="h3" href="../file/internal/backend/disk.go">internal/backend/disk.go</a> b/<a href="../file/internal/backend/disk.go">internal/backend/disk.go</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -3,6 +3,7 @@ package backend
</a> import (
 	&quot;bufio&quot;
 	&quot;bytes&quot;
<a href="#h3-0-3" id="h3-0-3" class="i">+	&quot;context&quot;
</a> 	&quot;fmt&quot;
 	&quot;io&quot;
 	&quot;os&quot;
<a href="#h3-1" id="h3-1" class="h">@@ -39,7 +40,7 @@ func NewDisk(cfg *config.Disk) (Backend, error) {
</a> }
 
 // HeadObject stats the requested file.
<a href="#h3-1-3" id="h3-1-3" class="d">-func (d *Disk) HeadObject(request *service.HeadObjectRequest) (*service.HeadObjectResponse, error) {
</a><a href="#h3-1-4" id="h3-1-4" class="i">+func (d *Disk) HeadObject(ctx context.Context, request *service.HeadObjectRequest) (*service.HeadObjectResponse, error) {
</a> 	var objectType common.Object
 
 	target, err := d.resolveFileTarget(request.Resource.Bucket, request.Key)
<a href="#h3-2" id="h3-2" class="h">@@ -70,7 +71,7 @@ func (d *Disk) HeadObject(request *service.HeadObjectRequest) (*service.HeadObje
</a> }
 
 // GetObject opens a file handle for the requested file followed by reading its contents in full.
<a href="#h3-2-3" id="h3-2-3" class="d">-func (d *Disk) GetObject(request *service.GetObjectRequest) (*service.GetObjectResponse, error) {
</a><a href="#h3-2-4" id="h3-2-4" class="i">+func (d *Disk) GetObject(ctx context.Context, request *service.GetObjectRequest) (*service.GetObjectResponse, error) {
</a> 	target, err := d.resolveFileTarget(request.Resource.Bucket, request.Key)
 	if err != nil {
 		return nil, status.Error(codes.PermissionDenied, err.Error())
<a href="#h3-3" id="h3-3" class="h">@@ -102,7 +103,7 @@ func (d *Disk) GetObject(request *service.GetObjectRequest) (*service.GetObjectR
</a> 
 // StreamGetObject reads the requested file in chunks, each of which is packaged as a single
 // response instance over the return channel.
<a href="#h3-3-3" id="h3-3-3" class="d">-func (d *Disk) StreamGetObject(request *service.GetObjectStreamRequest) (&lt;-chan *service.GetObjectStreamResponse, error) {
</a><a href="#h3-3-4" id="h3-3-4" class="i">+func (d *Disk) StreamGetObject(ctx context.Context, request *service.GetObjectStreamRequest) (&lt;-chan *service.GetObjectStreamResponse, error) {
</a> 	var seek uint64
 
 	target, err := d.resolveFileTarget(request.Request.Resource.Bucket, request.Request.Key)
<a href="#h3-4" id="h3-4" class="h">@@ -172,7 +173,7 @@ func (d *Disk) StreamGetObject(request *service.GetObjectStreamRequest) (&lt;-chan 
</a> 
 // PutObject opens a file handle at the requested path followed by writing the request data payload
 // to the file in full.
<a href="#h3-4-3" id="h3-4-3" class="d">-func (d *Disk) PutObject(request *service.PutObjectRequest) (*service.PutObjectResponse, error) {
</a><a href="#h3-4-4" id="h3-4-4" class="i">+func (d *Disk) PutObject(ctx context.Context, request *service.PutObjectRequest) (*service.PutObjectResponse, error) {
</a> 	target, err := d.resolveFileTarget(request.Resource.Bucket, request.Key)
 	if err != nil {
 		return nil, status.Error(codes.PermissionDenied, err.Error())
<a href="#h3-5" id="h3-5" class="h">@@ -211,7 +212,7 @@ func (d *Disk) PutObject(request *service.PutObjectRequest) (*service.PutObjectR
</a> 
 // StreamPutObject writes the request file in chunks, where each request over the request channel
 // specifies a single chunk of data.
<a href="#h3-5-3" id="h3-5-3" class="d">-func (d *Disk) StreamPutObject(stream chan *service.PutObjectStreamRequest) (*service.PutObjectStreamResponse, error) {
</a><a href="#h3-5-4" id="h3-5-4" class="i">+func (d *Disk) StreamPutObject(ctx context.Context, stream chan *service.PutObjectStreamRequest) (*service.PutObjectStreamResponse, error) {
</a> 	var err error
 	var target string
 	var file disk.WriteSeekCloser
<a href="#h3-6" id="h3-6" class="h">@@ -273,7 +274,7 @@ func (d *Disk) StreamPutObject(stream chan *service.PutObjectStreamRequest) (*se
</a> }
 
 // DeleteObject deletes the requested file.
<a href="#h3-6-3" id="h3-6-3" class="d">-func (d *Disk) DeleteObject(request *service.DeleteObjectRequest) (*service.DeleteObjectResponse, error) {
</a><a href="#h3-6-4" id="h3-6-4" class="i">+func (d *Disk) DeleteObject(ctx context.Context, request *service.DeleteObjectRequest) (*service.DeleteObjectResponse, error) {
</a> 	target, err := d.resolveFileTarget(request.Resource.Bucket, request.Key)
 	if err != nil {
 		return nil, status.Error(codes.PermissionDenied, err.Error())
<a href="#h3-7" id="h3-7" class="h">@@ -287,7 +288,7 @@ func (d *Disk) DeleteObject(request *service.DeleteObjectRequest) (*service.Dele
</a> }
 
 // ListObjects lists files matching the requested prefix.
<a href="#h3-7-3" id="h3-7-3" class="d">-func (d *Disk) ListObjects(request *service.ListObjectsRequest) (*service.ListObjectsResponse, error) {
</a><a href="#h3-7-4" id="h3-7-4" class="i">+func (d *Disk) ListObjects(ctx context.Context, request *service.ListObjectsRequest) (*service.ListObjectsResponse, error) {
</a> 	var objects []*service.HeadObjectResponse
 
 	target, err := d.resolveFileTarget(request.Resource.Bucket, request.Prefix)
<b>diff --git a/<a id="h4" href="../file/internal/backend/mux.go">internal/backend/mux.go</a> b/<a href="../file/internal/backend/mux.go">internal/backend/mux.go</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -1,6 +1,7 @@
</a> package backend
 
 import (
<a href="#h4-0-3" id="h4-0-3" class="i">+	&quot;context&quot;
</a> 	&quot;fmt&quot;
 	&quot;strings&quot;
 
<a href="#h4-1" id="h4-1" class="h">@@ -22,7 +23,7 @@ func NewMux(backends map[common.Backend]Backend) Backend {
</a> }
 
 // HeadObject demuxes HeadObject.
<a href="#h4-1-3" id="h4-1-3" class="d">-func (m *Mux) HeadObject(request *service.HeadObjectRequest) (*service.HeadObjectResponse, error) {
</a><a href="#h4-1-4" id="h4-1-4" class="i">+func (m *Mux) HeadObject(ctx context.Context, request *service.HeadObjectRequest) (*service.HeadObjectResponse, error) {
</a> 	backend, ok := m.backends[request.Resource.Backend]
 	if !ok {
 		return nil, status.Errorf(
<a href="#h4-2" id="h4-2" class="h">@@ -32,11 +33,11 @@ func (m *Mux) HeadObject(request *service.HeadObjectRequest) (*service.HeadObjec
</a> 		)
 	}
 
<a href="#h4-2-3" id="h4-2-3" class="d">-	return backend.HeadObject(request)
</a><a href="#h4-2-4" id="h4-2-4" class="i">+	return backend.HeadObject(ctx, request)
</a> }
 
 // GetObject demuxes GetObject.
<a href="#h4-2-8" id="h4-2-8" class="d">-func (m *Mux) GetObject(request *service.GetObjectRequest) (*service.GetObjectResponse, error) {
</a><a href="#h4-2-9" id="h4-2-9" class="i">+func (m *Mux) GetObject(ctx context.Context, request *service.GetObjectRequest) (*service.GetObjectResponse, error) {
</a> 	backend, ok := m.backends[request.Resource.Backend]
 	if !ok {
 		return nil, status.Errorf(
<a href="#h4-3" id="h4-3" class="h">@@ -46,11 +47,11 @@ func (m *Mux) GetObject(request *service.GetObjectRequest) (*service.GetObjectRe
</a> 		)
 	}
 
<a href="#h4-3-3" id="h4-3-3" class="d">-	return backend.GetObject(request)
</a><a href="#h4-3-4" id="h4-3-4" class="i">+	return backend.GetObject(ctx, request)
</a> }
 
 // StreamGetObject demuxes StreamGetObject.
<a href="#h4-3-8" id="h4-3-8" class="d">-func (m *Mux) StreamGetObject(request *service.GetObjectStreamRequest) (&lt;-chan *service.GetObjectStreamResponse, error) {
</a><a href="#h4-3-9" id="h4-3-9" class="i">+func (m *Mux) StreamGetObject(ctx context.Context, request *service.GetObjectStreamRequest) (&lt;-chan *service.GetObjectStreamResponse, error) {
</a> 	backend, ok := m.backends[request.Request.Resource.Backend]
 	if !ok {
 		return nil, status.Errorf(
<a href="#h4-4" id="h4-4" class="h">@@ -60,11 +61,11 @@ func (m *Mux) StreamGetObject(request *service.GetObjectStreamRequest) (&lt;-chan *
</a> 		)
 	}
 
<a href="#h4-4-3" id="h4-4-3" class="d">-	return backend.StreamGetObject(request)
</a><a href="#h4-4-4" id="h4-4-4" class="i">+	return backend.StreamGetObject(ctx, request)
</a> }
 
 // PutObject demuxes PutObject.
<a href="#h4-4-8" id="h4-4-8" class="d">-func (m *Mux) PutObject(request *service.PutObjectRequest) (*service.PutObjectResponse, error) {
</a><a href="#h4-4-9" id="h4-4-9" class="i">+func (m *Mux) PutObject(ctx context.Context, request *service.PutObjectRequest) (*service.PutObjectResponse, error) {
</a> 	backend, ok := m.backends[request.Resource.Backend]
 	if !ok {
 		return nil, status.Errorf(
<a href="#h4-5" id="h4-5" class="h">@@ -74,14 +75,14 @@ func (m *Mux) PutObject(request *service.PutObjectRequest) (*service.PutObjectRe
</a> 		)
 	}
 
<a href="#h4-5-3" id="h4-5-3" class="d">-	return backend.PutObject(request)
</a><a href="#h4-5-4" id="h4-5-4" class="i">+	return backend.PutObject(ctx, request)
</a> }
 
 // StreamPutObject demuxes StreamPutObject. Note that the backend metadata is included in the first
 // stream request sent through the channel, so the implementation creates an intermediate &quot;proxy&quot;
 // channel to inspect the correct backend to use based on the first request followed by passing it
 // along to the backend implementation.
<a href="#h4-5-11" id="h4-5-11" class="d">-func (m *Mux) StreamPutObject(stream chan *service.PutObjectStreamRequest) (*service.PutObjectStreamResponse, error) {
</a><a href="#h4-5-12" id="h4-5-12" class="i">+func (m *Mux) StreamPutObject(ctx context.Context, stream chan *service.PutObjectStreamRequest) (*service.PutObjectStreamResponse, error) {
</a> 	proxy := make(chan *service.PutObjectStreamRequest)
 	peek := &lt;-stream
 
<a href="#h4-6" id="h4-6" class="h">@@ -102,11 +103,11 @@ func (m *Mux) StreamPutObject(stream chan *service.PutObjectStreamRequest) (*ser
</a> 		close(proxy)
 	}()
 
<a href="#h4-6-3" id="h4-6-3" class="d">-	return backend.StreamPutObject(proxy)
</a><a href="#h4-6-4" id="h4-6-4" class="i">+	return backend.StreamPutObject(ctx, proxy)
</a> }
 
 // DeleteObject demuxes DeleteObject.
<a href="#h4-6-8" id="h4-6-8" class="d">-func (m *Mux) DeleteObject(request *service.DeleteObjectRequest) (*service.DeleteObjectResponse, error) {
</a><a href="#h4-6-9" id="h4-6-9" class="i">+func (m *Mux) DeleteObject(ctx context.Context, request *service.DeleteObjectRequest) (*service.DeleteObjectResponse, error) {
</a> 	backend, ok := m.backends[request.Resource.Backend]
 	if !ok {
 		return nil, status.Errorf(
<a href="#h4-7" id="h4-7" class="h">@@ -116,11 +117,11 @@ func (m *Mux) DeleteObject(request *service.DeleteObjectRequest) (*service.Delet
</a> 		)
 	}
 
<a href="#h4-7-3" id="h4-7-3" class="d">-	return backend.DeleteObject(request)
</a><a href="#h4-7-4" id="h4-7-4" class="i">+	return backend.DeleteObject(ctx, request)
</a> }
 
 // ListObjects demuxes ListObjects.
<a href="#h4-7-8" id="h4-7-8" class="d">-func (m *Mux) ListObjects(request *service.ListObjectsRequest) (*service.ListObjectsResponse, error) {
</a><a href="#h4-7-9" id="h4-7-9" class="i">+func (m *Mux) ListObjects(ctx context.Context, request *service.ListObjectsRequest) (*service.ListObjectsResponse, error) {
</a> 	backend, ok := m.backends[request.Resource.Backend]
 	if !ok {
 		return nil, status.Errorf(
<a href="#h4-8" id="h4-8" class="h">@@ -130,7 +131,7 @@ func (m *Mux) ListObjects(request *service.ListObjectsRequest) (*service.ListObj
</a> 		)
 	}
 
<a href="#h4-8-3" id="h4-8-3" class="d">-	return backend.ListObjects(request)
</a><a href="#h4-8-4" id="h4-8-4" class="i">+	return backend.ListObjects(ctx, request)
</a> }
 
 // String returns a human-consumable representation of this backend.
<b>diff --git a/<a id="h5" href="../file/internal/backend/permission.go">internal/backend/permission.go</a> b/<a href="../file/internal/backend/permission.go">internal/backend/permission.go</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -1,6 +1,7 @@
</a> package backend
 
 import (
<a href="#h5-0-3" id="h5-0-3" class="i">+	&quot;context&quot;
</a> 	&quot;fmt&quot;
 
 	&quot;go.uber.org/zap&quot;
<a href="#h5-1" id="h5-1" class="h">@@ -35,7 +36,7 @@ func NewPermission(permissions []*config.Permission, backend Backend) Backend {
</a> }
 
 // HeadObject defers to the underlying backend only when permitted by the bucket ACL.
<a href="#h5-1-3" id="h5-1-3" class="d">-func (p *Permission) HeadObject(request *service.HeadObjectRequest) (*service.HeadObjectResponse, error) {
</a><a href="#h5-1-4" id="h5-1-4" class="i">+func (p *Permission) HeadObject(ctx context.Context, request *service.HeadObjectRequest) (*service.HeadObjectResponse, error) {
</a> 	var allowed bool
 
 	for _, permission := range p.permissions {
<a href="#h5-2" id="h5-2" class="h">@@ -49,11 +50,11 @@ func (p *Permission) HeadObject(request *service.HeadObjectRequest) (*service.He
</a> 		return nil, errBucketPermissionDenied
 	}
 
<a href="#h5-2-3" id="h5-2-3" class="d">-	return p.Backend.HeadObject(request)
</a><a href="#h5-2-4" id="h5-2-4" class="i">+	return p.Backend.HeadObject(ctx, request)
</a> }
 
 // GetObject defers to the underlying backend only when permitted by the bucket ACL.
<a href="#h5-2-8" id="h5-2-8" class="d">-func (p *Permission) GetObject(request *service.GetObjectRequest) (*service.GetObjectResponse, error) {
</a><a href="#h5-2-9" id="h5-2-9" class="i">+func (p *Permission) GetObject(ctx context.Context, request *service.GetObjectRequest) (*service.GetObjectResponse, error) {
</a> 	var allowed bool
 
 	for _, permission := range p.permissions {
<a href="#h5-3" id="h5-3" class="h">@@ -67,11 +68,11 @@ func (p *Permission) GetObject(request *service.GetObjectRequest) (*service.GetO
</a> 		return nil, errBucketPermissionDenied
 	}
 
<a href="#h5-3-3" id="h5-3-3" class="d">-	return p.Backend.GetObject(request)
</a><a href="#h5-3-4" id="h5-3-4" class="i">+	return p.Backend.GetObject(ctx, request)
</a> }
 
 // StreamGetObject defers to the underlying backend only when permitted by the bucket ACL.
<a href="#h5-3-8" id="h5-3-8" class="d">-func (p *Permission) StreamGetObject(request *service.GetObjectStreamRequest) (&lt;-chan *service.GetObjectStreamResponse, error) {
</a><a href="#h5-3-9" id="h5-3-9" class="i">+func (p *Permission) StreamGetObject(ctx context.Context, request *service.GetObjectStreamRequest) (&lt;-chan *service.GetObjectStreamResponse, error) {
</a> 	var allowed bool
 
 	for _, permission := range p.permissions {
<a href="#h5-4" id="h5-4" class="h">@@ -85,11 +86,11 @@ func (p *Permission) StreamGetObject(request *service.GetObjectStreamRequest) (&lt;
</a> 		return nil, errBucketPermissionDenied
 	}
 
<a href="#h5-4-3" id="h5-4-3" class="d">-	return p.Backend.StreamGetObject(request)
</a><a href="#h5-4-4" id="h5-4-4" class="i">+	return p.Backend.StreamGetObject(ctx, request)
</a> }
 
 // PutObject defers to the underlying backend only when permitted by the bucket ACL.
<a href="#h5-4-8" id="h5-4-8" class="d">-func (p *Permission) PutObject(request *service.PutObjectRequest) (*service.PutObjectResponse, error) {
</a><a href="#h5-4-9" id="h5-4-9" class="i">+func (p *Permission) PutObject(ctx context.Context, request *service.PutObjectRequest) (*service.PutObjectResponse, error) {
</a> 	var allowed bool
 
 	for _, permission := range p.permissions {
<a href="#h5-5" id="h5-5" class="h">@@ -103,11 +104,11 @@ func (p *Permission) PutObject(request *service.PutObjectRequest) (*service.PutO
</a> 		return nil, errBucketPermissionDenied
 	}
 
<a href="#h5-5-3" id="h5-5-3" class="d">-	return p.Backend.PutObject(request)
</a><a href="#h5-5-4" id="h5-5-4" class="i">+	return p.Backend.PutObject(ctx, request)
</a> }
 
 // StreamPutObject defers to the underlying backend only when permitted by the bucket ACL.
<a href="#h5-5-8" id="h5-5-8" class="d">-func (p *Permission) StreamPutObject(stream chan *service.PutObjectStreamRequest) (*service.PutObjectStreamResponse, error) {
</a><a href="#h5-5-9" id="h5-5-9" class="i">+func (p *Permission) StreamPutObject(ctx context.Context, stream chan *service.PutObjectStreamRequest) (*service.PutObjectStreamResponse, error) {
</a> 	proxy := make(chan *service.PutObjectStreamRequest)
 
 	go func() {
<a href="#h5-6" id="h5-6" class="h">@@ -135,11 +136,11 @@ func (p *Permission) StreamPutObject(stream chan *service.PutObjectStreamRequest
</a> 		close(proxy)
 	}()
 
<a href="#h5-6-3" id="h5-6-3" class="d">-	return p.Backend.StreamPutObject(proxy)
</a><a href="#h5-6-4" id="h5-6-4" class="i">+	return p.Backend.StreamPutObject(ctx, proxy)
</a> }
 
 // DeleteObject defers to the underlying backend only when permitted by the bucket ACL.
<a href="#h5-6-8" id="h5-6-8" class="d">-func (p *Permission) DeleteObject(request *service.DeleteObjectRequest) (*service.DeleteObjectResponse, error) {
</a><a href="#h5-6-9" id="h5-6-9" class="i">+func (p *Permission) DeleteObject(ctx context.Context, request *service.DeleteObjectRequest) (*service.DeleteObjectResponse, error) {
</a> 	var allowed bool
 
 	for _, permission := range p.permissions {
<a href="#h5-7" id="h5-7" class="h">@@ -153,11 +154,11 @@ func (p *Permission) DeleteObject(request *service.DeleteObjectRequest) (*servic
</a> 		return nil, errBucketPermissionDenied
 	}
 
<a href="#h5-7-3" id="h5-7-3" class="d">-	return p.Backend.DeleteObject(request)
</a><a href="#h5-7-4" id="h5-7-4" class="i">+	return p.Backend.DeleteObject(ctx, request)
</a> }
 
 // ListObjects defers to the underlying backend only when permitted by the bucket ACL.
<a href="#h5-7-8" id="h5-7-8" class="d">-func (p *Permission) ListObjects(request *service.ListObjectsRequest) (*service.ListObjectsResponse, error) {
</a><a href="#h5-7-9" id="h5-7-9" class="i">+func (p *Permission) ListObjects(ctx context.Context, request *service.ListObjectsRequest) (*service.ListObjectsResponse, error) {
</a> 	var allowed bool
 
 	for _, permission := range p.permissions {
<a href="#h5-8" id="h5-8" class="h">@@ -171,7 +172,7 @@ func (p *Permission) ListObjects(request *service.ListObjectsRequest) (*service.
</a> 		return nil, errBucketPermissionDenied
 	}
 
<a href="#h5-8-3" id="h5-8-3" class="d">-	return p.Backend.ListObjects(request)
</a><a href="#h5-8-4" id="h5-8-4" class="i">+	return p.Backend.ListObjects(ctx, request)
</a> }
 
 // String returns a human-consumable representation of this backend.
<b>diff --git a/<a id="h6" href="../file/internal/backend/processor.go">internal/backend/processor.go</a> b/<a href="../file/internal/backend/processor.go">internal/backend/processor.go</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -3,6 +3,7 @@ package backend
</a> import (
 	&quot;bufio&quot;
 	&quot;bytes&quot;
<a href="#h6-0-3" id="h6-0-3" class="i">+	&quot;context&quot;
</a> 	&quot;io&quot;
 
 	&quot;go.uber.org/zap&quot;
<a href="#h6-1" id="h6-1" class="h">@@ -86,8 +87,8 @@ func newIOProcessor(
</a> 
 // GetObject defers to the underlying backend followed by performing transparent transformation of
 // the full payload.
<a href="#h6-1-3" id="h6-1-3" class="d">-func (p *ioProcessor) GetObject(request *service.GetObjectRequest) (*service.GetObjectResponse, error) {
</a><a href="#h6-1-4" id="h6-1-4" class="d">-	resp, err := p.Backend.GetObject(request)
</a><a href="#h6-1-5" id="h6-1-5" class="i">+func (p *ioProcessor) GetObject(ctx context.Context, request *service.GetObjectRequest) (*service.GetObjectResponse, error) {
</a><a href="#h6-1-6" id="h6-1-6" class="i">+	resp, err := p.Backend.GetObject(ctx, request)
</a> 	if err != nil {
 		return nil, err
 	}
<a href="#h6-2" id="h6-2" class="h">@@ -108,7 +109,7 @@ func (p *ioProcessor) GetObject(request *service.GetObjectRequest) (*service.Get
</a> }
 
 // StreamGetObject is a streaming implementation of GetObject that transforms data chunk-by-chunk.
<a href="#h6-2-3" id="h6-2-3" class="d">-func (p *ioProcessor) StreamGetObject(request *service.GetObjectStreamRequest) (&lt;-chan *service.GetObjectStreamResponse, error) {
</a><a href="#h6-2-4" id="h6-2-4" class="i">+func (p *ioProcessor) StreamGetObject(ctx context.Context, request *service.GetObjectStreamRequest) (&lt;-chan *service.GetObjectStreamResponse, error) {
</a> 	var metadata *common.Metadata
 
 	proxyRequest := request
<a href="#h6-3" id="h6-3" class="h">@@ -121,7 +122,7 @@ func (p *ioProcessor) StreamGetObject(request *service.GetObjectStreamRequest) (
</a> 		proxyRequest.ChunkSize = p.streamingReadChunkSize
 	}
 
<a href="#h6-3-3" id="h6-3-3" class="d">-	stream, err := p.Backend.StreamGetObject(proxyRequest)
</a><a href="#h6-3-4" id="h6-3-4" class="i">+	stream, err := p.Backend.StreamGetObject(ctx, proxyRequest)
</a> 	if err != nil {
 		return nil, err
 	}
<a href="#h6-4" id="h6-4" class="h">@@ -199,7 +200,7 @@ func (p *ioProcessor) StreamGetObject(request *service.GetObjectStreamRequest) (
</a> 
 // PutObject transparently transforms the full data payload followed by replacing the data in the
 // outbound request to the underlying backend.
<a href="#h6-4-3" id="h6-4-3" class="d">-func (p *ioProcessor) PutObject(request *service.PutObjectRequest) (*service.PutObjectResponse, error) {
</a><a href="#h6-4-4" id="h6-4-4" class="i">+func (p *ioProcessor) PutObject(ctx context.Context, request *service.PutObjectRequest) (*service.PutObjectResponse, error) {
</a> 	errs := make(chan error, 2)
 	r, w := io.Pipe()
 
<a href="#h6-5" id="h6-5" class="h">@@ -239,11 +240,11 @@ func (p *ioProcessor) PutObject(request *service.PutObjectRequest) (*service.Put
</a> 		}
 	}
 
<a href="#h6-5-3" id="h6-5-3" class="d">-	return p.Backend.PutObject(request)
</a><a href="#h6-5-4" id="h6-5-4" class="i">+	return p.Backend.PutObject(ctx, request)
</a> }
 
 // StreamPutObject is a streaming implementation of PutObject that transforms data chunk-by-chunk.
<a href="#h6-5-8" id="h6-5-8" class="d">-func (p *ioProcessor) StreamPutObject(stream chan *service.PutObjectStreamRequest) (*service.PutObjectStreamResponse, error) {
</a><a href="#h6-5-9" id="h6-5-9" class="i">+func (p *ioProcessor) StreamPutObject(ctx context.Context, stream chan *service.PutObjectStreamRequest) (*service.PutObjectStreamResponse, error) {
</a> 	peek := &lt;-stream
 	proxyRequest := make(chan *service.PutObjectStreamRequest)
 
<a href="#h6-6" id="h6-6" class="h">@@ -325,5 +326,5 @@ func (p *ioProcessor) StreamPutObject(stream chan *service.PutObjectStreamReques
</a> 		}
 	}()
 
<a href="#h6-6-3" id="h6-6-3" class="d">-	return p.Backend.StreamPutObject(proxyRequest)
</a><a href="#h6-6-4" id="h6-6-4" class="i">+	return p.Backend.StreamPutObject(ctx, proxyRequest)
</a> }
<b>diff --git a/<a id="h7" href="../file/internal/backend/threshold.go">internal/backend/threshold.go</a> b/<a href="../file/internal/backend/threshold.go">internal/backend/threshold.go</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -1,6 +1,7 @@
</a> package backend
 
 import (
<a href="#h7-0-3" id="h7-0-3" class="i">+	&quot;context&quot;
</a> 	&quot;fmt&quot;
 
 	&quot;unistore/schemas/service&quot;
<a href="#h7-1" id="h7-1" class="h">@@ -29,7 +30,7 @@ func NewThreshold(threshold int, backend Backend) Backend {
</a> // StreamPutObject buffers up to a maximum of threshold bytes in memory, followed by either draining
 // the entire buffer as a single request to the backend&#39;s PutObject API, or passing all the chunks
 // without modification to the underlying backend.
<a href="#h7-1-3" id="h7-1-3" class="d">-func (t *Threshold) StreamPutObject(stream chan *service.PutObjectStreamRequest) (*service.PutObjectStreamResponse, error) {
</a><a href="#h7-1-4" id="h7-1-4" class="i">+func (t *Threshold) StreamPutObject(ctx context.Context, stream chan *service.PutObjectStreamRequest) (*service.PutObjectStreamResponse, error) {
</a> 	var size int
 	var buf []*service.PutObjectStreamRequest
 
<a href="#h7-2" id="h7-2" class="h">@@ -61,7 +62,7 @@ func (t *Threshold) StreamPutObject(stream chan *service.PutObjectStreamRequest)
</a> 			Checksum: request.Request.Checksum,
 		}
 
<a href="#h7-2-3" id="h7-2-3" class="d">-		resp, err := t.Backend.PutObject(unary)
</a><a href="#h7-2-4" id="h7-2-4" class="i">+		resp, err := t.Backend.PutObject(ctx, unary)
</a> 		if err != nil {
 			return nil, err
 		}
<a href="#h7-3" id="h7-3" class="h">@@ -86,7 +87,7 @@ func (t *Threshold) StreamPutObject(stream chan *service.PutObjectStreamRequest)
</a> 		close(proxy)
 	}()
 
<a href="#h7-3-3" id="h7-3-3" class="d">-	return t.Backend.StreamPutObject(proxy)
</a><a href="#h7-3-4" id="h7-3-4" class="i">+	return t.Backend.StreamPutObject(ctx, proxy)
</a> }
 
 // String returns a human-consumable representation of this backend.
<b>diff --git a/<a id="h8" href="../file/internal/backend/types.go">internal/backend/types.go</a> b/<a href="../file/internal/backend/types.go">internal/backend/types.go</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -1,6 +1,7 @@
</a> package backend
 
 import (
<a href="#h8-0-3" id="h8-0-3" class="i">+	&quot;context&quot;
</a> 	&quot;fmt&quot;
 
 	&quot;unistore/schemas/service&quot;
<a href="#h8-1" id="h8-1" class="h">@@ -11,23 +12,23 @@ type Backend interface {
</a> 	fmt.Stringer
 
 	// HeadObject retrieves metadata about an object.
<a href="#h8-1-3" id="h8-1-3" class="d">-	HeadObject(request *service.HeadObjectRequest) (*service.HeadObjectResponse, error)
</a><a href="#h8-1-4" id="h8-1-4" class="i">+	HeadObject(ctx context.Context, request *service.HeadObjectRequest) (*service.HeadObjectResponse, error)
</a> 
 	// GetObject reads an object&#39;s full contents (buffered in memory).
<a href="#h8-1-7" id="h8-1-7" class="d">-	GetObject(request *service.GetObjectRequest) (*service.GetObjectResponse, error)
</a><a href="#h8-1-8" id="h8-1-8" class="i">+	GetObject(ctx context.Context, request *service.GetObjectRequest) (*service.GetObjectResponse, error)
</a> 
 	// StreamGetObject is a streaming implementation of GetObject.
<a href="#h8-1-11" id="h8-1-11" class="d">-	StreamGetObject(request *service.GetObjectStreamRequest) (&lt;-chan *service.GetObjectStreamResponse, error)
</a><a href="#h8-1-12" id="h8-1-12" class="i">+	StreamGetObject(ctx context.Context, request *service.GetObjectStreamRequest) (&lt;-chan *service.GetObjectStreamResponse, error)
</a> 
 	// PutObject writes an object&#39;s full contents (buffered in memory).
<a href="#h8-1-15" id="h8-1-15" class="d">-	PutObject(request *service.PutObjectRequest) (*service.PutObjectResponse, error)
</a><a href="#h8-1-16" id="h8-1-16" class="i">+	PutObject(ctx context.Context, request *service.PutObjectRequest) (*service.PutObjectResponse, error)
</a> 
 	// StreamPutObject is a streaming implementation of PutObject.
<a href="#h8-1-19" id="h8-1-19" class="d">-	StreamPutObject(stream chan *service.PutObjectStreamRequest) (*service.PutObjectStreamResponse, error)
</a><a href="#h8-1-20" id="h8-1-20" class="i">+	StreamPutObject(ctx context.Context, stream chan *service.PutObjectStreamRequest) (*service.PutObjectStreamResponse, error)
</a> 
 	// DeleteObject deletes an object.
<a href="#h8-1-23" id="h8-1-23" class="d">-	DeleteObject(request *service.DeleteObjectRequest) (*service.DeleteObjectResponse, error)
</a><a href="#h8-1-24" id="h8-1-24" class="i">+	DeleteObject(ctx context.Context, request *service.DeleteObjectRequest) (*service.DeleteObjectResponse, error)
</a> 
 	// ListObjects lists objects under a particular prefix.
<a href="#h8-1-27" id="h8-1-27" class="d">-	ListObjects(request *service.ListObjectsRequest) (*service.ListObjectsResponse, error)
</a><a href="#h8-1-28" id="h8-1-28" class="i">+	ListObjects(ctx context.Context, request *service.ListObjectsRequest) (*service.ListObjectsResponse, error)
</a> }
<b>diff --git a/<a id="h9" href="../file/internal/backend/unistore.go">internal/backend/unistore.go</a> b/<a href="../file/internal/backend/unistore.go">internal/backend/unistore.go</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -75,10 +75,9 @@ func NewUnistore(cfg *config.Unistore) (Backend, error) {
</a> }
 
 // HeadObject invokes the gRPC HeadObject RPC.
<a href="#h9-0-3" id="h9-0-3" class="d">-func (u *Unistore) HeadObject(request *service.HeadObjectRequest) (*service.HeadObjectResponse, error) {
</a><a href="#h9-0-4" id="h9-0-4" class="i">+func (u *Unistore) HeadObject(ctx context.Context, request *service.HeadObjectRequest) (*service.HeadObjectResponse, error) {
</a> 	var cancel context.CancelFunc
 
<a href="#h9-0-7" id="h9-0-7" class="d">-	ctx := context.Background()
</a> 	if u.connection.RequestTimeout &gt; 0 {
 		ctx, cancel = context.WithTimeout(ctx, u.connection.RequestTimeout)
 		defer cancel()
<a href="#h9-1" id="h9-1" class="h">@@ -90,10 +89,9 @@ func (u *Unistore) HeadObject(request *service.HeadObjectRequest) (*service.Head
</a> }
 
 // GetObject invokes the gRPC GetObject RPC.
<a href="#h9-1-3" id="h9-1-3" class="d">-func (u *Unistore) GetObject(request *service.GetObjectRequest) (*service.GetObjectResponse, error) {
</a><a href="#h9-1-4" id="h9-1-4" class="i">+func (u *Unistore) GetObject(ctx context.Context, request *service.GetObjectRequest) (*service.GetObjectResponse, error) {
</a> 	var cancel context.CancelFunc
 
<a href="#h9-1-7" id="h9-1-7" class="d">-	ctx := context.Background()
</a> 	if u.connection.RequestTimeout &gt; 0 {
 		ctx, cancel = context.WithTimeout(ctx, u.connection.RequestTimeout)
 		defer cancel()
<a href="#h9-2" id="h9-2" class="h">@@ -105,7 +103,7 @@ func (u *Unistore) GetObject(request *service.GetObjectRequest) (*service.GetObj
</a> }
 
 // StreamGetObject invokes the gRPC StreamGetObject RPC and adapts the response stream to a channel.
<a href="#h9-2-3" id="h9-2-3" class="d">-func (u *Unistore) StreamGetObject(request *service.GetObjectStreamRequest) (&lt;-chan *service.GetObjectStreamResponse, error) {
</a><a href="#h9-2-4" id="h9-2-4" class="i">+func (u *Unistore) StreamGetObject(ctx context.Context, request *service.GetObjectStreamRequest) (&lt;-chan *service.GetObjectStreamResponse, error) {
</a> 	responses := make(chan *service.GetObjectStreamResponse)
 
 	request.Request.Resource.Backend = u.backend
<a href="#h9-3" id="h9-3" class="h">@@ -135,10 +133,9 @@ func (u *Unistore) StreamGetObject(request *service.GetObjectStreamRequest) (&lt;-c
</a> }
 
 // PutObject invokes the gRPC PutObject RPC.
<a href="#h9-3-3" id="h9-3-3" class="d">-func (u *Unistore) PutObject(request *service.PutObjectRequest) (*service.PutObjectResponse, error) {
</a><a href="#h9-3-4" id="h9-3-4" class="i">+func (u *Unistore) PutObject(ctx context.Context, request *service.PutObjectRequest) (*service.PutObjectResponse, error) {
</a> 	var cancel context.CancelFunc
 
<a href="#h9-3-7" id="h9-3-7" class="d">-	ctx := context.Background()
</a> 	if u.connection.RequestTimeout &gt; 0 {
 		ctx, cancel = context.WithTimeout(ctx, u.connection.RequestTimeout)
 		defer cancel()
<a href="#h9-4" id="h9-4" class="h">@@ -150,7 +147,7 @@ func (u *Unistore) PutObject(request *service.PutObjectRequest) (*service.PutObj
</a> }
 
 // StreamPutObject invokes the gRPC StreamPutObject RPC and adapts the request stream to a channel.
<a href="#h9-4-3" id="h9-4-3" class="d">-func (u *Unistore) StreamPutObject(stream chan *service.PutObjectStreamRequest) (*service.PutObjectStreamResponse, error) {
</a><a href="#h9-4-4" id="h9-4-4" class="i">+func (u *Unistore) StreamPutObject(ctx context.Context, stream chan *service.PutObjectStreamRequest) (*service.PutObjectStreamResponse, error) {
</a> 	c, err := u.client.StreamPutObject(context.Background())
 	if err != nil {
 		return nil, err
<a href="#h9-5" id="h9-5" class="h">@@ -168,10 +165,9 @@ func (u *Unistore) StreamPutObject(stream chan *service.PutObjectStreamRequest) 
</a> }
 
 // DeleteObject invokes the gRPC DeleteObject RPC.
<a href="#h9-5-3" id="h9-5-3" class="d">-func (u *Unistore) DeleteObject(request *service.DeleteObjectRequest) (*service.DeleteObjectResponse, error) {
</a><a href="#h9-5-4" id="h9-5-4" class="i">+func (u *Unistore) DeleteObject(ctx context.Context, request *service.DeleteObjectRequest) (*service.DeleteObjectResponse, error) {
</a> 	var cancel context.CancelFunc
 
<a href="#h9-5-7" id="h9-5-7" class="d">-	ctx := context.Background()
</a> 	if u.connection.RequestTimeout &gt; 0 {
 		ctx, cancel = context.WithTimeout(ctx, u.connection.RequestTimeout)
 		defer cancel()
<a href="#h9-6" id="h9-6" class="h">@@ -183,10 +179,9 @@ func (u *Unistore) DeleteObject(request *service.DeleteObjectRequest) (*service.
</a> }
 
 // ListObjects invokes the gRPC ListObjects RPC.
<a href="#h9-6-3" id="h9-6-3" class="d">-func (u *Unistore) ListObjects(request *service.ListObjectsRequest) (*service.ListObjectsResponse, error) {
</a><a href="#h9-6-4" id="h9-6-4" class="i">+func (u *Unistore) ListObjects(ctx context.Context, request *service.ListObjectsRequest) (*service.ListObjectsResponse, error) {
</a> 	var cancel context.CancelFunc
 
<a href="#h9-6-7" id="h9-6-7" class="d">-	ctx := context.Background()
</a> 	if u.connection.RequestTimeout &gt; 0 {
 		ctx, cancel = context.WithTimeout(ctx, u.connection.RequestTimeout)
 		defer cancel()
<b>diff --git a/<a id="h10" href="../file/internal/server/unistore.go">internal/server/unistore.go</a> b/<a href="../file/internal/server/unistore.go">internal/server/unistore.go</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -180,17 +180,17 @@ func newUnistoreService(cfg config.Storage) (service.UnistoreServer, error) {
</a> 
 // HeadObject calls into the backend&#39;s HeadObject.
 func (u *unistoreService) HeadObject(ctx context.Context, request *service.HeadObjectRequest) (*service.HeadObjectResponse, error) {
<a href="#h10-0-3" id="h10-0-3" class="d">-	return u.backend.HeadObject(request)
</a><a href="#h10-0-4" id="h10-0-4" class="i">+	return u.backend.HeadObject(ctx, request)
</a> }
 
 // GetObject calls into the backend&#39;s GetObject.
 func (u *unistoreService) GetObject(ctx context.Context, request *service.GetObjectRequest) (*service.GetObjectResponse, error) {
<a href="#h10-0-9" id="h10-0-9" class="d">-	return u.backend.GetObject(request)
</a><a href="#h10-0-10" id="h10-0-10" class="i">+	return u.backend.GetObject(ctx, request)
</a> }
 
 // StreamGetObject calls into the backend&#39;s StreamGetObject.
 func (u *unistoreService) StreamGetObject(request *service.GetObjectStreamRequest, stream service.Unistore_StreamGetObjectServer) error {
<a href="#h10-0-15" id="h10-0-15" class="d">-	responses, err := u.backend.StreamGetObject(request)
</a><a href="#h10-0-16" id="h10-0-16" class="i">+	responses, err := u.backend.StreamGetObject(stream.Context(), request)
</a> 	if err != nil {
 		return err
 	}
<a href="#h10-1" id="h10-1" class="h">@@ -206,7 +206,7 @@ func (u *unistoreService) StreamGetObject(request *service.GetObjectStreamReques
</a> 
 // PutObject calls into the backend&#39;s PutObject.
 func (u *unistoreService) PutObject(ctx context.Context, request *service.PutObjectRequest) (*service.PutObjectResponse, error) {
<a href="#h10-1-3" id="h10-1-3" class="d">-	return u.backend.PutObject(request)
</a><a href="#h10-1-4" id="h10-1-4" class="i">+	return u.backend.PutObject(ctx, request)
</a> }
 
 // StreamPutObject calls into the backend&#39;s StreamPutObject.
<a href="#h10-2" id="h10-2" class="h">@@ -226,7 +226,7 @@ func (u *unistoreService) StreamPutObject(stream service.Unistore_StreamPutObjec
</a> 		close(puts)
 	}()
 
<a href="#h10-2-3" id="h10-2-3" class="d">-	response, err := u.backend.StreamPutObject(puts)
</a><a href="#h10-2-4" id="h10-2-4" class="i">+	response, err := u.backend.StreamPutObject(stream.Context(), puts)
</a> 	if err != nil {
 		return err
 	}
<a href="#h10-3" id="h10-3" class="h">@@ -236,10 +236,10 @@ func (u *unistoreService) StreamPutObject(stream service.Unistore_StreamPutObjec
</a> 
 // DeleteObject calls into the backend&#39;s DeleteObject.
 func (u *unistoreService) DeleteObject(ctx context.Context, request *service.DeleteObjectRequest) (*service.DeleteObjectResponse, error) {
<a href="#h10-3-3" id="h10-3-3" class="d">-	return u.backend.DeleteObject(request)
</a><a href="#h10-3-4" id="h10-3-4" class="i">+	return u.backend.DeleteObject(ctx, request)
</a> }
 
 // ListObjects calls into the backend&#39;s ListObjects.
 func (u *unistoreService) ListObjects(ctx context.Context, request *service.ListObjectsRequest) (*service.ListObjectsResponse, error) {
<a href="#h10-3-9" id="h10-3-9" class="d">-	return u.backend.ListObjects(request)
</a><a href="#h10-3-10" id="h10-3-10" class="i">+	return u.backend.ListObjects(ctx, request)
</a> }
</pre>
</div>
</body>
</html>
