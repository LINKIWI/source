<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Merge pull request #26 from tpcwang/ctags - livegrep - Fast, regular expression code search service</title>
<link rel="icon" type="image/png" href="https://static.kevinlin.info/favicon.png" />
<link rel="alternate" type="application/atom+xml" title="livegrep Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="livegrep Atom Feed (tags)" href="../tags.xml" />
<style type="text/css">
body {
	color: #000;
	background-color: #fff;
	font-family: monospace;
}

h1, h2, h3, h4, h5, h6 {
	font-size: 1em;
	margin: 0;
}

img, h1, h2 {
	vertical-align: middle;
}

img {
	border: 0;
}

a:target {
	background-color: #ccc;
}

a.d,
a.h,
a.i {
	text-decoration: none;
}

a.line {
	text-decoration: none;
	user-select: none;
}

#blob a {
	color: #555;
}

#blob a:hover {
	color: blue;
	text-decoration: none;
}

table thead td {
	font-weight: bold;
}

table td {
	padding: 0 0.4em;
}

#content table td {
	vertical-align: top;
	white-space: nowrap;
}

#branches tr:hover td,
#tags tr:hover td,
#index tr:hover td,
#log tr:hover td,
#files tr:hover td {
	background-color: #eee;
}

#index tr td:nth-child(2),
#tags tr td:nth-child(3),
#branches tr td:nth-child(3),
#log tr td:nth-child(2) {
	white-space: normal;
}

td.num {
	text-align: right;
}

.desc {
	color: #555;
}

hr {
	border: 0;
	border-top: 1px solid #555;
	height: 1px;
}

pre {
	font-family: monospace;
}

pre a.h {
	color: #00a;
}

.A,
span.i,
pre a.i {
	color: #070;
}

.D,
span.d,
pre a.d {
	color: #e00;
}

pre a.h:hover,
pre a.i:hover,
pre a.d:hover {
	text-decoration: none;
}
</style>
</head>
<body>
<table><tr><td><a href="/"><img src="https://static.kevinlin.info/favicon.png" alt="" width="32" height="32" /></a></td><td><h1>livegrep</h1><span class="desc">Fast, regular expression code search service</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://source.static.kevinlin.info/external/livegrep.git">https://source.static.kevinlin.info/external/livegrep.git</a></td></tr><tr><td></td><td>
<a href="../log">Log</a> | <a href="../files">Files</a> | <a href="../refs">Refs</a> | <a href="../file/README.md">README</a> | <a href="../file/COPYING">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/223a9e9d2e192ec583e93a7c18af117b3d9e8dcf">223a9e9d2e192ec583e93a7c18af117b3d9e8dcf</a>
<b>parent</b> <a href="../commit/fc0a012b81d4068e5aed8d8f935d4fab95cf4a3a">fc0a012b81d4068e5aed8d8f935d4fab95cf4a3a</a>
<b>Author:</b> Nelson Elhage &lt;<a href="mailto:nelhage@nelhage.com">nelhage@nelhage.com</a>&gt;
<b>Date:</b>   Sun, 21 Feb 2016 12:45:53 -0800

Merge pull request #26 from tpcwang/ctags

Added support for searching through ctags results
<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">client/types.go</a></td><td> | </td><td class="num">2</td><td><span class="i">++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">server/query.go</a></td><td> | </td><td class="num">2</td><td><span class="i">++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">server/query_test.go</a></td><td> | </td><td class="num">18</td><td><span class="i">++++++++++++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">src/Makefrag</a></td><td> | </td><td class="num">3</td><td><span class="i">++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">src/codesearch.cc</a></td><td> | </td><td class="num">16</td><td><span class="i">+++++++++++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">src/codesearch.h</a></td><td> | </td><td class="num">20</td><td><span class="i">++++++++++++++++</span><span class="d">----</span></td></tr>
<tr><td class="A">A</td><td><a href="#h6">src/tagsearch.cc</a></td><td> | </td><td class="num">128</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h7">src/tagsearch.h</a></td><td> | </td><td class="num">38</td><td><span class="i">++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h8">src/tools/codesearch.cc</a></td><td> | </td><td class="num">107</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">---------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h9">src/tools/transport.cc</a></td><td> | </td><td class="num">4</td><td><span class="i">++++</span><span class="d"></span></td></tr>
</table></pre><pre>10 files changed, 304 insertions(+), 34 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/client/types.go">client/types.go</a> b/<a href="../file/client/types.go">client/types.go</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -4,10 +4,12 @@ type Query struct {
</a> 	Line     string `json:&quot;line&quot;`
 	File     string `json:&quot;file&quot;`
 	Repo     string `json:&quot;repo&quot;`
<a href="#h0-0-3" id="h0-0-3" class="i">+	Tags     string `json:&quot;tags&quot;`
</a> 	FoldCase bool   `json:&quot;fold_case&quot;`
 	Not      struct {
 		File string `json:&quot;file&quot;`
 		Repo string `json:&quot;repo&quot;`
<a href="#h0-0-8" id="h0-0-8" class="i">+		Tags string `json:&quot;tags&quot;`
</a> 	} `json:&quot;not&quot;`
 }
 
<b>diff --git a/<a id="h1" href="../file/server/query.go">server/query.go</a> b/<a href="../file/server/query.go">server/query.go</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -80,8 +80,10 @@ func ParseQuery(query string) client.Query {
</a> 	var out client.Query
 	out.File = ops[&quot;file&quot;]
 	out.Repo = ops[&quot;repo&quot;]
<a href="#h1-0-3" id="h1-0-3" class="i">+	out.Tags = ops[&quot;tags&quot;]
</a> 	out.Not.File = ops[&quot;-file&quot;]
 	out.Not.Repo = ops[&quot;-repo&quot;]
<a href="#h1-0-6" id="h1-0-6" class="i">+	out.Not.Tags = ops[&quot;-tags&quot;]
</a> 	out.Line = strings.TrimSpace(ops[&quot;&quot;] + ops[&quot;case&quot;] + regexp.QuoteMeta(ops[&quot;lit&quot;]))
 	if _, ok := ops[&quot;case&quot;]; ok {
 		out.FoldCase = false
<b>diff --git a/<a id="h2" href="../file/server/query_test.go">server/query_test.go</a> b/<a href="../file/server/query_test.go">server/query_test.go</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -8,14 +8,16 @@ import (
</a> )
 
 func TestParseQuery(t *testing.T) {
<a href="#h2-0-3" id="h2-0-3" class="d">-	Not := func(file, repo string) struct {
</a><a href="#h2-0-4" id="h2-0-4" class="i">+	Not := func(file, repo, tags string) struct {
</a> 		File string `json:&quot;file&quot;`
 		Repo string `json:&quot;repo&quot;`
<a href="#h2-0-7" id="h2-0-7" class="i">+		Tags string `json:&quot;tags&quot;`
</a> 	} {
 		return struct {
 			File string `json:&quot;file&quot;`
 			Repo string `json:&quot;repo&quot;`
<a href="#h2-0-12" id="h2-0-12" class="d">-		}{file, repo}
</a><a href="#h2-0-13" id="h2-0-13" class="i">+			Tags string `json:&quot;tags&quot;`
</a><a href="#h2-0-14" id="h2-0-14" class="i">+		}{file, repo, tags}
</a> 	}
 	cases := []struct {
 		in  string
<a href="#h2-1" id="h2-1" class="h">@@ -90,12 +92,20 @@ func TestParseQuery(t *testing.T) {
</a> 			client.Query{Line: &quot;(file:)&quot;, FoldCase: true},
 		},
 		{
<a href="#h2-1-3" id="h2-1-3" class="i">+			`re tags:kind:function`,
</a><a href="#h2-1-4" id="h2-1-4" class="i">+			client.Query{Line: &quot;re&quot;, FoldCase: true, Tags: &quot;kind:function&quot;},
</a><a href="#h2-1-5" id="h2-1-5" class="i">+		},
</a><a href="#h2-1-6" id="h2-1-6" class="i">+		{
</a> 			`-file:Godep re`,
<a href="#h2-1-8" id="h2-1-8" class="d">-			client.Query{Line: &quot;re&quot;, Not: Not(&quot;Godep&quot;, &quot;&quot;), FoldCase: true},
</a><a href="#h2-1-9" id="h2-1-9" class="i">+			client.Query{Line: &quot;re&quot;, Not: Not(&quot;Godep&quot;, &quot;&quot;, &quot;&quot;), FoldCase: true},
</a> 		},
 		{
 			`-file:. -repo:Godep re`,
<a href="#h2-1-13" id="h2-1-13" class="d">-			client.Query{Line: &quot;re&quot;, Not: Not(&quot;.&quot;, &quot;Godep&quot;), FoldCase: true},
</a><a href="#h2-1-14" id="h2-1-14" class="i">+			client.Query{Line: &quot;re&quot;, Not: Not(&quot;.&quot;, &quot;Godep&quot;, &quot;&quot;), FoldCase: true},
</a><a href="#h2-1-15" id="h2-1-15" class="i">+		},
</a><a href="#h2-1-16" id="h2-1-16" class="i">+		{
</a><a href="#h2-1-17" id="h2-1-17" class="i">+			`-tags:kind:class re`,
</a><a href="#h2-1-18" id="h2-1-18" class="i">+			client.Query{Line: &quot;re&quot;, Not: Not(&quot;&quot;, &quot;&quot;, &quot;kind:class&quot;), FoldCase: true},
</a> 		},
 		{
 			`case:foo:`,
<b>diff --git a/<a id="h3" href="../file/src/Makefrag">src/Makefrag</a> b/<a href="../file/src/Makefrag">src/Makefrag</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -1,3 +1,4 @@
</a> SRC += src/chunk_allocator.cc src/chunk.cc src/codesearch.cc \
            src/content.cc src/dump_load.cc src/indexer.cc \
<a href="#h3-0-2" id="h3-0-2" class="d">-           src/re_width.cc src/git_indexer.cc src/fs_indexer.cc
</a><a href="#h3-0-3" id="h3-0-3" class="i">+           src/re_width.cc src/git_indexer.cc src/fs_indexer.cc \
</a><a href="#h3-0-4" id="h3-0-4" class="i">+           src/tagsearch.cc
</a><b>diff --git a/<a id="h4" href="../file/src/codesearch.cc">src/codesearch.cc</a> b/<a href="../file/src/codesearch.cc">src/codesearch.cc</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -111,8 +111,10 @@ struct match_finger;
</a> 
 class searcher {
 public:
<a href="#h4-0-3" id="h4-0-3" class="d">-    searcher(const code_searcher *cc, const query &amp;q) :
</a><a href="#h4-0-4" id="h4-0-4" class="d">-        cc_(cc), query_(&amp;q), queue_(),
</a><a href="#h4-0-5" id="h4-0-5" class="i">+    searcher(const code_searcher *cc,
</a><a href="#h4-0-6" id="h4-0-6" class="i">+             const query &amp;q,
</a><a href="#h4-0-7" id="h4-0-7" class="i">+             const code_searcher::search_thread::transform_func&amp; func) :
</a><a href="#h4-0-8" id="h4-0-8" class="i">+        cc_(cc), query_(&amp;q), transform_(func), queue_(),
</a>         matches_(0), re2_time_(false), git_time_(false),
         index_time_(false), sort_time_(false), analyze_time_(false),
         exit_reason_(kExitNone), files_(new uint8_t[cc-&gt;files_.size()]),
<a href="#h4-1" id="h4-1" class="h">@@ -316,6 +318,7 @@ protected:
</a> 
     const code_searcher *cc_;
     const query *query_;
<a href="#h4-1-3" id="h4-1-3" class="i">+    const code_searcher::search_thread::transform_func transform_;
</a>     thread_queue&lt;match_result*&gt; queue_;
     atomic_int matches_;
     intrusive_ptr&lt;IndexKey&gt; index_;
<a href="#h4-2" id="h4-2" class="h">@@ -868,8 +871,10 @@ void searcher::try_match(const StringPiece&amp; line,
</a>             m-&gt;context_after.push_back(l);
         }
 
<a href="#h4-2-3" id="h4-2-3" class="d">-        queue_.push(m);
</a><a href="#h4-2-4" id="h4-2-4" class="d">-        ++matches_;
</a><a href="#h4-2-5" id="h4-2-5" class="i">+        if (!transform_ || transform_(m)) {
</a><a href="#h4-2-6" id="h4-2-6" class="i">+            queue_.push(m);
</a><a href="#h4-2-7" id="h4-2-7" class="i">+            ++matches_;
</a><a href="#h4-2-8" id="h4-2-8" class="i">+        }
</a>         if (exit_early())
             break;
 
<a href="#h4-3" id="h4-3" class="h">@@ -888,6 +893,7 @@ code_searcher::search_thread::search_thread(code_searcher *cs)
</a> 
 void code_searcher::search_thread::match(const query &amp;q,
                                          const callback_func&amp; cb,
<a href="#h4-3-3" id="h4-3-3" class="i">+                                         const transform_func&amp; func,
</a>                                          match_stats *stats) {
     match_result *m;
     int matches = 0;
<a href="#h4-4" id="h4-4" class="h">@@ -902,7 +908,7 @@ void code_searcher::search_thread::match(const query &amp;q,
</a>         cs_-&gt;alloc_-&gt;drop_caches();
     }
 
<a href="#h4-4-3" id="h4-4-3" class="d">-    searcher search(cs_, q);
</a><a href="#h4-4-4" id="h4-4-4" class="i">+    searcher search(cs_, q, func);
</a>     job j;
     j.search = &amp;search;
     j.pending = 0;
<b>diff --git a/<a id="h5" href="../file/src/codesearch.h">src/codesearch.h</a> b/<a href="../file/src/codesearch.h">src/codesearch.h</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -15,8 +15,8 @@
</a> #include &lt;atomic&gt;
 #include &lt;mutex&gt;
 #include &lt;thread&gt;
<a href="#h5-0-3" id="h5-0-3" class="i">+#include &lt;functional&gt;
</a> #include &lt;boost/intrusive_ptr.hpp&gt;
<a href="#h5-0-5" id="h5-0-5" class="d">-#include &lt;boost/function.hpp&gt;
</a> 
 #ifdef USE_DENSE_HASH_SET
 #include &lt;google/dense_hash_set&gt;
<a href="#h5-1" id="h5-1" class="h">@@ -127,7 +127,7 @@ struct match_result {
</a> };
 
 // A query specification passed to match(). line_pat is required to be
<a href="#h5-1-3" id="h5-1-3" class="d">-// non-NULL; file_pat and tree_pat may be NULL to specify &quot;no
</a><a href="#h5-1-4" id="h5-1-4" class="i">+// non-NULL; file_pat, tree_pat and tag_pat may be NULL to specify &quot;no
</a> // constraint&quot;
 struct query {
     std::string trace_id;
<a href="#h5-2" id="h5-2" class="h">@@ -135,9 +135,11 @@ struct query {
</a>     std::unique_ptr&lt;RE2&gt; line_pat;
     std::unique_ptr&lt;RE2&gt; file_pat;
     std::unique_ptr&lt;RE2&gt; tree_pat;
<a href="#h5-2-3" id="h5-2-3" class="i">+    std::unique_ptr&lt;RE2&gt; tags_pat;
</a>     struct {
         std::unique_ptr&lt;RE2&gt; file_pat;
         std::unique_ptr&lt;RE2&gt; tree_pat;
<a href="#h5-2-7" id="h5-2-7" class="i">+        std::unique_ptr&lt;RE2&gt; tags_pat;
</a>     } negate;
 };
 
<a href="#h5-3" id="h5-3" class="h">@@ -178,10 +180,19 @@ public:
</a>         ~search_thread();
 
         // function that will be called to record a match
<a href="#h5-3-3" id="h5-3-3" class="d">-        typedef boost::function&lt;void (const struct match_result*)&gt; callback_func;
</a><a href="#h5-3-4" id="h5-3-4" class="i">+        typedef std::function&lt;void (const struct match_result*)&gt; callback_func;
</a><a href="#h5-3-5" id="h5-3-5" class="i">+        // function that will be called to transform a match
</a><a href="#h5-3-6" id="h5-3-6" class="i">+        typedef std::function&lt;bool (struct match_result*)&gt; transform_func;
</a> 
         /* file_pat may be NULL */
<a href="#h5-3-9" id="h5-3-9" class="d">-        void match(const query&amp; q, const callback_func&amp; cb, match_stats *stats);
</a><a href="#h5-3-10" id="h5-3-10" class="i">+        void match(const query&amp; q, const callback_func&amp; cb, match_stats *stats)
</a><a href="#h5-3-11" id="h5-3-11" class="i">+        {
</a><a href="#h5-3-12" id="h5-3-12" class="i">+            match(q, cb, transform_func(), stats);
</a><a href="#h5-3-13" id="h5-3-13" class="i">+        }
</a><a href="#h5-3-14" id="h5-3-14" class="i">+        void match(const query&amp; q,
</a><a href="#h5-3-15" id="h5-3-15" class="i">+                   const callback_func&amp; cb,
</a><a href="#h5-3-16" id="h5-3-16" class="i">+                   const transform_func&amp; func,
</a><a href="#h5-3-17" id="h5-3-17" class="i">+                   match_stats *stats);
</a>     protected:
         struct job {
             atomic_int pending;
<a href="#h5-4" id="h5-4" class="h">@@ -211,6 +222,7 @@ protected:
</a>     friend class searcher;
     friend class codesearch_index;
     friend class load_allocator;
<a href="#h5-4-3" id="h5-4-3" class="i">+    friend class tag_searcher;
</a> };
 
 // dump_load.cc
<b>diff --git a/<a id="h6" href="../file/src/tagsearch.cc">src/tagsearch.cc</a> b/<a href="../file/src/tagsearch.cc">src/tagsearch.cc</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -0,0 +1,128 @@
</a><a href="#h6-0-0" id="h6-0-0" class="i">+/********************************************************************
</a><a href="#h6-0-1" id="h6-0-1" class="i">+ * livegrep -- tagsearch.cc
</a><a href="#h6-0-2" id="h6-0-2" class="i">+ * Copyright (c) 2011-2013 Nelson Elhage
</a><a href="#h6-0-3" id="h6-0-3" class="i">+ *
</a><a href="#h6-0-4" id="h6-0-4" class="i">+ * This program is free software. You may use, redistribute, and/or
</a><a href="#h6-0-5" id="h6-0-5" class="i">+ * modify it under the terms listed in the COPYING file.
</a><a href="#h6-0-6" id="h6-0-6" class="i">+ ********************************************************************/
</a><a href="#h6-0-7" id="h6-0-7" class="i">+#include &quot;tagsearch.h&quot;
</a><a href="#h6-0-8" id="h6-0-8" class="i">+#include &quot;content.h&quot;
</a><a href="#h6-0-9" id="h6-0-9" class="i">+#include &quot;lib/debug.h&quot;
</a><a href="#h6-0-10" id="h6-0-10" class="i">+
</a><a href="#h6-0-11" id="h6-0-11" class="i">+#include &lt;utility&gt;
</a><a href="#h6-0-12" id="h6-0-12" class="i">+
</a><a href="#h6-0-13" id="h6-0-13" class="i">+using re2::RE2;
</a><a href="#h6-0-14" id="h6-0-14" class="i">+
</a><a href="#h6-0-15" id="h6-0-15" class="i">+namespace {
</a><a href="#h6-0-16" id="h6-0-16" class="i">+
</a><a href="#h6-0-17" id="h6-0-17" class="i">+std::string create_partial_regex(RE2 *re) {
</a><a href="#h6-0-18" id="h6-0-18" class="i">+    if (!re)
</a><a href="#h6-0-19" id="h6-0-19" class="i">+        return &quot;.*&quot;;
</a><a href="#h6-0-20" id="h6-0-20" class="i">+
</a><a href="#h6-0-21" id="h6-0-21" class="i">+    std::string pattern = re-&gt;pattern();
</a><a href="#h6-0-22" id="h6-0-22" class="i">+
</a><a href="#h6-0-23" id="h6-0-23" class="i">+    if (pattern.front() == &#39;^&#39;)
</a><a href="#h6-0-24" id="h6-0-24" class="i">+        pattern.erase(pattern.begin());
</a><a href="#h6-0-25" id="h6-0-25" class="i">+    else
</a><a href="#h6-0-26" id="h6-0-26" class="i">+        pattern.insert(0, &quot;.*&quot;);
</a><a href="#h6-0-27" id="h6-0-27" class="i">+
</a><a href="#h6-0-28" id="h6-0-28" class="i">+    if (pattern.back() == &#39;$&#39;)
</a><a href="#h6-0-29" id="h6-0-29" class="i">+        pattern.erase(pattern.size() - 1);
</a><a href="#h6-0-30" id="h6-0-30" class="i">+    else
</a><a href="#h6-0-31" id="h6-0-31" class="i">+        pattern.append(&quot;.*&quot;);
</a><a href="#h6-0-32" id="h6-0-32" class="i">+
</a><a href="#h6-0-33" id="h6-0-33" class="i">+    return pattern;
</a><a href="#h6-0-34" id="h6-0-34" class="i">+}
</a><a href="#h6-0-35" id="h6-0-35" class="i">+
</a><a href="#h6-0-36" id="h6-0-36" class="i">+std::string create_tag_line_regex(
</a><a href="#h6-0-37" id="h6-0-37" class="i">+    const std::string&amp; name,
</a><a href="#h6-0-38" id="h6-0-38" class="i">+    const std::string&amp; file,
</a><a href="#h6-0-39" id="h6-0-39" class="i">+    const std::string&amp; lno,
</a><a href="#h6-0-40" id="h6-0-40" class="i">+    const std::string&amp; tags) {
</a><a href="#h6-0-41" id="h6-0-41" class="i">+    // full regex match for a tag line created with ctags using format=2.
</a><a href="#h6-0-42" id="h6-0-42" class="i">+    return std::string(&quot;^&quot;) + name + &quot;\\t&quot; + file + &quot;\\t&quot; + lno + &quot;\\;\\\&quot;\\t&quot; + tags + &quot;$&quot;;
</a><a href="#h6-0-43" id="h6-0-43" class="i">+}
</a><a href="#h6-0-44" id="h6-0-44" class="i">+
</a><a href="#h6-0-45" id="h6-0-45" class="i">+};
</a><a href="#h6-0-46" id="h6-0-46" class="i">+
</a><a href="#h6-0-47" id="h6-0-47" class="i">+void tag_searcher::load_index(const string&amp; path) {
</a><a href="#h6-0-48" id="h6-0-48" class="i">+    cs_.load_index(path);
</a><a href="#h6-0-49" id="h6-0-49" class="i">+}
</a><a href="#h6-0-50" id="h6-0-50" class="i">+
</a><a href="#h6-0-51" id="h6-0-51" class="i">+void tag_searcher::cache_indexed_files(code_searcher* cs) {
</a><a href="#h6-0-52" id="h6-0-52" class="i">+    file_alloc_ = cs-&gt;alloc_;
</a><a href="#h6-0-53" id="h6-0-53" class="i">+    for (auto it = cs-&gt;begin_files(); it != cs-&gt;end_files(); ++it) {
</a><a href="#h6-0-54" id="h6-0-54" class="i">+        auto file = *it;
</a><a href="#h6-0-55" id="h6-0-55" class="i">+        auto key = repo_path_pair(file-&gt;tree-&gt;name, file-&gt;path);
</a><a href="#h6-0-56" id="h6-0-56" class="i">+        path_to_file_map_.insert(std::make_pair(key, file));
</a><a href="#h6-0-57" id="h6-0-57" class="i">+    }
</a><a href="#h6-0-58" id="h6-0-58" class="i">+}
</a><a href="#h6-0-59" id="h6-0-59" class="i">+
</a><a href="#h6-0-60" id="h6-0-60" class="i">+bool tag_searcher::transform(query *q, match_result *m) const {
</a><a href="#h6-0-61" id="h6-0-61" class="i">+    static const std::string regex = create_tag_line_regex(&quot;(.+)&quot;, &quot;(.+)&quot;, &quot;(\\d+)&quot;, &quot;(.+)&quot;);
</a><a href="#h6-0-62" id="h6-0-62" class="i">+    StringPiece name, path, tags;
</a><a href="#h6-0-63" id="h6-0-63" class="i">+    if (!RE2::FullMatch(m-&gt;line, regex, &amp;name, &amp;path, &amp;m-&gt;lno, &amp;tags)) {
</a><a href="#h6-0-64" id="h6-0-64" class="i">+        log(q-&gt;trace_id, &quot;unknown ctags format: %s\n&quot;, m-&gt;line.as_string().c_str());
</a><a href="#h6-0-65" id="h6-0-65" class="i">+        return false;
</a><a href="#h6-0-66" id="h6-0-66" class="i">+    }
</a><a href="#h6-0-67" id="h6-0-67" class="i">+
</a><a href="#h6-0-68" id="h6-0-68" class="i">+    // check the negation constraints
</a><a href="#h6-0-69" id="h6-0-69" class="i">+    if (q-&gt;negate.file_pat &amp;&amp;
</a><a href="#h6-0-70" id="h6-0-70" class="i">+        q-&gt;negate.file_pat-&gt;Match(path, 0, path.size(), RE2::UNANCHORED, NULL, 0))
</a><a href="#h6-0-71" id="h6-0-71" class="i">+        return false;
</a><a href="#h6-0-72" id="h6-0-72" class="i">+    if (q-&gt;negate.tags_pat &amp;&amp;
</a><a href="#h6-0-73" id="h6-0-73" class="i">+        q-&gt;negate.tags_pat-&gt;Match(tags, 0, tags.size(), RE2::UNANCHORED, NULL, 0))
</a><a href="#h6-0-74" id="h6-0-74" class="i">+        return false;
</a><a href="#h6-0-75" id="h6-0-75" class="i">+
</a><a href="#h6-0-76" id="h6-0-76" class="i">+    // lookup the indexed_file base on repo and path
</a><a href="#h6-0-77" id="h6-0-77" class="i">+    auto key = repo_path_pair(m-&gt;file-&gt;tree-&gt;name, path.as_string());
</a><a href="#h6-0-78" id="h6-0-78" class="i">+    auto value = path_to_file_map_.find(key);
</a><a href="#h6-0-79" id="h6-0-79" class="i">+    if (value == path_to_file_map_.end()) {
</a><a href="#h6-0-80" id="h6-0-80" class="i">+        log(q-&gt;trace_id,
</a><a href="#h6-0-81" id="h6-0-81" class="i">+            &quot;unable to find a file matching %s from repo %s\n&quot;,
</a><a href="#h6-0-82" id="h6-0-82" class="i">+            path.as_string().c_str(), m-&gt;file-&gt;tree-&gt;name.c_str());
</a><a href="#h6-0-83" id="h6-0-83" class="i">+        return false;
</a><a href="#h6-0-84" id="h6-0-84" class="i">+    }
</a><a href="#h6-0-85" id="h6-0-85" class="i">+    auto file = value-&gt;second;
</a><a href="#h6-0-86" id="h6-0-86" class="i">+
</a><a href="#h6-0-87" id="h6-0-87" class="i">+    // iterate through the lines to add context information
</a><a href="#h6-0-88" id="h6-0-88" class="i">+    auto line_it = file-&gt;content-&gt;begin(file_alloc_);
</a><a href="#h6-0-89" id="h6-0-89" class="i">+    auto line_end = file-&gt;content-&gt;end(file_alloc_);
</a><a href="#h6-0-90" id="h6-0-90" class="i">+    const int kContextLines = 3;
</a><a href="#h6-0-91" id="h6-0-91" class="i">+    m-&gt;file = file;
</a><a href="#h6-0-92" id="h6-0-92" class="i">+
</a><a href="#h6-0-93" id="h6-0-93" class="i">+    // jump to context before
</a><a href="#h6-0-94" id="h6-0-94" class="i">+    int current = 1;
</a><a href="#h6-0-95" id="h6-0-95" class="i">+    for (;current &lt; std::max(1, m-&gt;lno - kContextLines); ++current)
</a><a href="#h6-0-96" id="h6-0-96" class="i">+        ++line_it;
</a><a href="#h6-0-97" id="h6-0-97" class="i">+
</a><a href="#h6-0-98" id="h6-0-98" class="i">+    // context before (we reverse the order to match codesearch)
</a><a href="#h6-0-99" id="h6-0-99" class="i">+    m-&gt;context_before.clear();
</a><a href="#h6-0-100" id="h6-0-100" class="i">+    for (; current &lt; m-&gt;lno; ++current) {
</a><a href="#h6-0-101" id="h6-0-101" class="i">+        m-&gt;context_before.insert(m-&gt;context_before.begin(), *line_it);
</a><a href="#h6-0-102" id="h6-0-102" class="i">+        ++line_it;
</a><a href="#h6-0-103" id="h6-0-103" class="i">+    }
</a><a href="#h6-0-104" id="h6-0-104" class="i">+
</a><a href="#h6-0-105" id="h6-0-105" class="i">+
</a><a href="#h6-0-106" id="h6-0-106" class="i">+    // line (match the first occurrence for simplicity)
</a><a href="#h6-0-107" id="h6-0-107" class="i">+    m-&gt;line = *line_it;
</a><a href="#h6-0-108" id="h6-0-108" class="i">+    m-&gt;matchleft = line_it-&gt;find(name);
</a><a href="#h6-0-109" id="h6-0-109" class="i">+    m-&gt;matchright = m-&gt;matchleft + name.size();
</a><a href="#h6-0-110" id="h6-0-110" class="i">+    ++line_it;
</a><a href="#h6-0-111" id="h6-0-111" class="i">+
</a><a href="#h6-0-112" id="h6-0-112" class="i">+    // context after
</a><a href="#h6-0-113" id="h6-0-113" class="i">+    m-&gt;context_after.clear();
</a><a href="#h6-0-114" id="h6-0-114" class="i">+    for (int i = 0; i &lt; kContextLines &amp;&amp; line_it != line_end; ++i) {
</a><a href="#h6-0-115" id="h6-0-115" class="i">+        m-&gt;context_after.push_back(*line_it);
</a><a href="#h6-0-116" id="h6-0-116" class="i">+        ++line_it;
</a><a href="#h6-0-117" id="h6-0-117" class="i">+    }
</a><a href="#h6-0-118" id="h6-0-118" class="i">+
</a><a href="#h6-0-119" id="h6-0-119" class="i">+    return true;
</a><a href="#h6-0-120" id="h6-0-120" class="i">+}
</a><a href="#h6-0-121" id="h6-0-121" class="i">+
</a><a href="#h6-0-122" id="h6-0-122" class="i">+std::string tag_searcher::create_tag_line_regex_from_query(query *q) {
</a><a href="#h6-0-123" id="h6-0-123" class="i">+    return create_tag_line_regex(create_partial_regex(q-&gt;line_pat.get()),
</a><a href="#h6-0-124" id="h6-0-124" class="i">+                                 create_partial_regex(q-&gt;file_pat.get()),
</a><a href="#h6-0-125" id="h6-0-125" class="i">+                                 &quot;\\d+&quot;,
</a><a href="#h6-0-126" id="h6-0-126" class="i">+                                 create_partial_regex(q-&gt;tags_pat.get()));
</a><a href="#h6-0-127" id="h6-0-127" class="i">+}
</a><b>diff --git a/<a id="h7" href="../file/src/tagsearch.h">src/tagsearch.h</a> b/<a href="../file/src/tagsearch.h">src/tagsearch.h</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -0,0 +1,38 @@
</a><a href="#h7-0-0" id="h7-0-0" class="i">+/********************************************************************
</a><a href="#h7-0-1" id="h7-0-1" class="i">+ * livegrep -- tagsearch.h
</a><a href="#h7-0-2" id="h7-0-2" class="i">+ * Copyright (c) 2011-2013 Nelson Elhage
</a><a href="#h7-0-3" id="h7-0-3" class="i">+ *
</a><a href="#h7-0-4" id="h7-0-4" class="i">+ * This program is free software. You may use, redistribute, and/or
</a><a href="#h7-0-5" id="h7-0-5" class="i">+ * modify it under the terms listed in the COPYING file.
</a><a href="#h7-0-6" id="h7-0-6" class="i">+ ********************************************************************/
</a><a href="#h7-0-7" id="h7-0-7" class="i">+#ifndef TAGSEARCH_H
</a><a href="#h7-0-8" id="h7-0-8" class="i">+#define TAGSEARCH_H
</a><a href="#h7-0-9" id="h7-0-9" class="i">+
</a><a href="#h7-0-10" id="h7-0-10" class="i">+#include &quot;codesearch.h&quot;
</a><a href="#h7-0-11" id="h7-0-11" class="i">+
</a><a href="#h7-0-12" id="h7-0-12" class="i">+#include &lt;map&gt;
</a><a href="#h7-0-13" id="h7-0-13" class="i">+#include &lt;string&gt;
</a><a href="#h7-0-14" id="h7-0-14" class="i">+
</a><a href="#h7-0-15" id="h7-0-15" class="i">+class RE2;
</a><a href="#h7-0-16" id="h7-0-16" class="i">+class chunk_allocator;
</a><a href="#h7-0-17" id="h7-0-17" class="i">+
</a><a href="#h7-0-18" id="h7-0-18" class="i">+class tag_searcher {
</a><a href="#h7-0-19" id="h7-0-19" class="i">+public:
</a><a href="#h7-0-20" id="h7-0-20" class="i">+    void load_index(const string&amp; path);
</a><a href="#h7-0-21" id="h7-0-21" class="i">+
</a><a href="#h7-0-22" id="h7-0-22" class="i">+    void cache_indexed_files(code_searcher *cs);
</a><a href="#h7-0-23" id="h7-0-23" class="i">+
</a><a href="#h7-0-24" id="h7-0-24" class="i">+    bool transform(query *q, match_result *m) const;
</a><a href="#h7-0-25" id="h7-0-25" class="i">+
</a><a href="#h7-0-26" id="h7-0-26" class="i">+    code_searcher* cs() { return &amp;cs_; }
</a><a href="#h7-0-27" id="h7-0-27" class="i">+
</a><a href="#h7-0-28" id="h7-0-28" class="i">+    static std::string create_tag_line_regex_from_query(query *q);
</a><a href="#h7-0-29" id="h7-0-29" class="i">+
</a><a href="#h7-0-30" id="h7-0-30" class="i">+protected:
</a><a href="#h7-0-31" id="h7-0-31" class="i">+    code_searcher cs_;
</a><a href="#h7-0-32" id="h7-0-32" class="i">+    chunk_allocator *file_alloc_;
</a><a href="#h7-0-33" id="h7-0-33" class="i">+    typedef std::pair&lt;std::string, std::string&gt; repo_path_pair;
</a><a href="#h7-0-34" id="h7-0-34" class="i">+    std::map&lt;repo_path_pair, indexed_file*&gt; path_to_file_map_;
</a><a href="#h7-0-35" id="h7-0-35" class="i">+};
</a><a href="#h7-0-36" id="h7-0-36" class="i">+
</a><a href="#h7-0-37" id="h7-0-37" class="i">+#endif /* TAGSEARCH_H */
</a><b>diff --git a/<a id="h8" href="../file/src/tools/codesearch.cc">src/tools/codesearch.cc</a> b/<a href="../file/src/tools/codesearch.cc">src/tools/codesearch.cc</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -6,6 +6,7 @@
</a>  * modify it under the terms listed in the COPYING file.
  ********************************************************************/
 #include &quot;codesearch.h&quot;
<a href="#h8-0-3" id="h8-0-3" class="i">+#include &quot;tagsearch.h&quot;
</a> #include &quot;timer.h&quot;
 #include &quot;metrics.h&quot;
 #include &quot;re_width.h&quot;
<a href="#h8-1" id="h8-1" class="h">@@ -25,23 +26,33 @@
</a> #include &lt;semaphore.h&gt;
 
 #include &lt;iostream&gt;
<a href="#h8-1-3" id="h8-1-3" class="i">+#include &lt;functional&gt;
</a><a href="#h8-1-4" id="h8-1-4" class="i">+#include &lt;thread&gt;
</a> 
 #include &lt;gflags/gflags.h&gt;
 
<a href="#h8-1-8" id="h8-1-8" class="i">+#include &lt;boost/bind.hpp&gt;
</a> #include &lt;re2/regexp.h&gt;
<a href="#h8-1-10" id="h8-1-10" class="d">-#include &quot;re2/walker-inl.h&quot;
</a><a href="#h8-1-11" id="h8-1-11" class="i">+#include &lt;re2/walker-inl.h&gt;
</a> 
 #include &lt;json/json.h&gt;
 
 DEFINE_int32(concurrency, 16, &quot;Number of concurrent queries to allow.&quot;);
 DEFINE_string(dump_index, &quot;&quot;, &quot;Dump the produced index to a specified file&quot;);
 DEFINE_string(load_index, &quot;&quot;, &quot;Load the index from a file instead of walking the repository&quot;);
<a href="#h8-1-18" id="h8-1-18" class="i">+DEFINE_string(load_tags, &quot;&quot;, &quot;Load the index built from a tags file.&quot;);
</a> DEFINE_bool(quiet, false, &quot;Do the search, but don&#39;t print results.&quot;);
 DEFINE_string(listen, &quot;&quot;, &quot;Listen on a socket for connections. example: -listen tcp://localhost:9999&quot;);
<a href="#h8-1-21" id="h8-1-21" class="i">+DEFINE_string(listen_tags, &quot;&quot;, &quot;Listen on a socket for connections to tag search. example: -listen_tags tcp://localhost:9998&quot;);
</a> 
 using namespace std;
 using namespace re2;
 
<a href="#h8-1-26" id="h8-1-26" class="i">+const int kMaxProgramSize = 4000;
</a><a href="#h8-1-27" id="h8-1-27" class="i">+const int kMaxWidth       = 200;
</a><a href="#h8-1-28" id="h8-1-28" class="i">+
</a><a href="#h8-1-29" id="h8-1-29" class="i">+sem_t interact_sem;
</a><a href="#h8-1-30" id="h8-1-30" class="i">+
</a> void die_errno(const char *str) {
     perror(str);
     exit(1);
<a href="#h8-2" id="h8-2" class="h">@@ -59,10 +70,48 @@ protected:
</a>     codesearch_transport *tx_;
 };
 
<a href="#h8-2-3" id="h8-2-3" class="d">-const int kMaxProgramSize = 4000;
</a><a href="#h8-2-4" id="h8-2-4" class="d">-const int kMaxWidth       = 200;
</a><a href="#h8-2-5" id="h8-2-5" class="i">+typedef std::function&lt;match_stats (code_searcher::search_thread*,
</a><a href="#h8-2-6" id="h8-2-6" class="i">+                                   query*,
</a><a href="#h8-2-7" id="h8-2-7" class="i">+                                   codesearch_transport*)&gt; match_func;
</a><a href="#h8-2-8" id="h8-2-8" class="i">+
</a><a href="#h8-2-9" id="h8-2-9" class="i">+struct codesearch_matcher {
</a><a href="#h8-2-10" id="h8-2-10" class="i">+    match_stats operator()(code_searcher::search_thread *s, query *q, codesearch_transport *tx) {
</a><a href="#h8-2-11" id="h8-2-11" class="i">+        match_stats stats;
</a><a href="#h8-2-12" id="h8-2-12" class="i">+        sem_wait(&amp;interact_sem);
</a><a href="#h8-2-13" id="h8-2-13" class="i">+        s-&gt;match(*q, print_match(tx), &amp;stats);
</a><a href="#h8-2-14" id="h8-2-14" class="i">+        sem_post(&amp;interact_sem);
</a><a href="#h8-2-15" id="h8-2-15" class="i">+        return stats;
</a><a href="#h8-2-16" id="h8-2-16" class="i">+    }
</a><a href="#h8-2-17" id="h8-2-17" class="i">+};
</a> 
<a href="#h8-2-19" id="h8-2-19" class="d">-sem_t interact_sem;
</a><a href="#h8-2-20" id="h8-2-20" class="i">+struct tagsearch_matcher {
</a><a href="#h8-2-21" id="h8-2-21" class="i">+    tagsearch_matcher(tag_searcher* ts) : ts_(ts) {}
</a><a href="#h8-2-22" id="h8-2-22" class="i">+
</a><a href="#h8-2-23" id="h8-2-23" class="i">+    match_stats operator()(code_searcher::search_thread *s, query *q, codesearch_transport *tx) {
</a><a href="#h8-2-24" id="h8-2-24" class="i">+        match_stats stats;
</a><a href="#h8-2-25" id="h8-2-25" class="i">+        // the negation constraints will be checked when we transform the match
</a><a href="#h8-2-26" id="h8-2-26" class="i">+        // (unfortunately, we can&#39;t construct a line query that checks these)
</a><a href="#h8-2-27" id="h8-2-27" class="i">+        query constraints;
</a><a href="#h8-2-28" id="h8-2-28" class="i">+        constraints.negate.file_pat.swap(q-&gt;negate.file_pat);
</a><a href="#h8-2-29" id="h8-2-29" class="i">+        constraints.negate.tags_pat.swap(q-&gt;negate.tags_pat);
</a><a href="#h8-2-30" id="h8-2-30" class="i">+
</a><a href="#h8-2-31" id="h8-2-31" class="i">+        // modify the line pattern to match the constraints that we can handle now
</a><a href="#h8-2-32" id="h8-2-32" class="i">+        std::string regex = tag_searcher::create_tag_line_regex_from_query(q);
</a><a href="#h8-2-33" id="h8-2-33" class="i">+        q-&gt;line_pat.reset(new RE2(regex, q-&gt;line_pat-&gt;options()));
</a><a href="#h8-2-34" id="h8-2-34" class="i">+        q-&gt;file_pat.reset();
</a><a href="#h8-2-35" id="h8-2-35" class="i">+        q-&gt;tags_pat.reset();
</a><a href="#h8-2-36" id="h8-2-36" class="i">+
</a><a href="#h8-2-37" id="h8-2-37" class="i">+        sem_wait(&amp;interact_sem);
</a><a href="#h8-2-38" id="h8-2-38" class="i">+        s-&gt;match(*q,
</a><a href="#h8-2-39" id="h8-2-39" class="i">+                 print_match(tx),
</a><a href="#h8-2-40" id="h8-2-40" class="i">+                 boost::bind(&amp;tag_searcher::transform, ts_, &amp;constraints, _1),
</a><a href="#h8-2-41" id="h8-2-41" class="i">+                 &amp;stats);
</a><a href="#h8-2-42" id="h8-2-42" class="i">+        sem_post(&amp;interact_sem);
</a><a href="#h8-2-43" id="h8-2-43" class="i">+        return stats;
</a><a href="#h8-2-44" id="h8-2-44" class="i">+    }
</a><a href="#h8-2-45" id="h8-2-45" class="i">+protected:
</a><a href="#h8-2-46" id="h8-2-46" class="i">+    tag_searcher* ts_;
</a><a href="#h8-2-47" id="h8-2-47" class="i">+};
</a> 
 std::string pat(const std::unique_ptr&lt;RE2&gt; &amp;p) {
     if (p.get() == 0)
<a href="#h8-3" id="h8-3" class="h">@@ -70,7 +119,7 @@ std::string pat(const std::unique_ptr&lt;RE2&gt; &amp;p) {
</a>     return p-&gt;pattern();
 }
 
<a href="#h8-3-3" id="h8-3-3" class="d">-void interact(code_searcher *cs, codesearch_transport *tx) {
</a><a href="#h8-3-4" id="h8-3-4" class="i">+void interact(code_searcher *cs, codesearch_transport *tx, const match_func&amp; match) {
</a>     code_searcher::search_thread search(cs);
     WidthWalker width;
 
<a href="#h8-4" id="h8-4" class="h">@@ -87,12 +136,15 @@ void interact(code_searcher *cs, codesearch_transport *tx) {
</a>             continue;
 
         log(q.trace_id,
<a href="#h8-4-3" id="h8-4-3" class="d">-            &quot;processing query line=&#39;%s&#39; file=&#39;%s&#39; tree=&#39;%s&#39; not_file=&#39;%s&#39; not_tree=&#39;%s&#39;&quot;,
</a><a href="#h8-4-4" id="h8-4-4" class="i">+            &quot;processing query line=&#39;%s&#39; file=&#39;%s&#39; tree=&#39;%s&#39; tags=&#39;%s&#39; &quot;
</a><a href="#h8-4-5" id="h8-4-5" class="i">+                                        &quot;not_file=&#39;%s&#39; not_tree=&#39;%s&#39; not_tags=&#39;%s&#39;&quot;,
</a>             pat(q.line_pat).c_str(),
             pat(q.file_pat).c_str(),
             pat(q.tree_pat).c_str(),
<a href="#h8-4-9" id="h8-4-9" class="i">+            pat(q.tags_pat).c_str(),
</a>             pat(q.negate.file_pat).c_str(),
<a href="#h8-4-11" id="h8-4-11" class="d">-            pat(q.negate.tree_pat).c_str());
</a><a href="#h8-4-12" id="h8-4-12" class="i">+            pat(q.negate.tree_pat).c_str(),
</a><a href="#h8-4-13" id="h8-4-13" class="i">+            pat(q.negate.tags_pat).c_str());
</a> 
         if (q.line_pat-&gt;ProgramSize() &gt; kMaxProgramSize) {
             log(q.trace_id, &quot;program too large size=%d&quot;, q.line_pat-&gt;ProgramSize());
<a href="#h8-5" id="h8-5" class="h">@@ -108,13 +160,7 @@ void interact(code_searcher *cs, codesearch_transport *tx) {
</a>         {
             timer tm;
             struct timeval elapsed;
<a href="#h8-5-3" id="h8-5-3" class="d">-            match_stats stats;
</a><a href="#h8-5-4" id="h8-5-4" class="d">-
</a><a href="#h8-5-5" id="h8-5-5" class="d">-            {
</a><a href="#h8-5-6" id="h8-5-6" class="d">-                sem_wait(&amp;interact_sem);
</a><a href="#h8-5-7" id="h8-5-7" class="d">-                search.match(q, print_match(tx), &amp;stats);
</a><a href="#h8-5-8" id="h8-5-8" class="d">-                sem_post(&amp;interact_sem);
</a><a href="#h8-5-9" id="h8-5-9" class="d">-            }
</a><a href="#h8-5-10" id="h8-5-10" class="i">+            match_stats stats = match(&amp;search, &amp;q, tx);
</a>             elapsed = tm.elapsed();
             tx-&gt;write_done(elapsed, &amp;stats);
             log(q.trace_id, &quot;done elapsed=%ld matches=%d why=%d&quot;,
<a href="#h8-6" id="h8-6" class="h">@@ -169,6 +215,7 @@ void build_index(code_searcher *cs, const vector&lt;std::string&gt; &amp;argv) {
</a> }
 
 void initialize_search(code_searcher *search,
<a href="#h8-6-3" id="h8-6-3" class="i">+                       tag_searcher *tags,
</a>                        int argc, char **argv) {
     if (FLAGS_load_index.size() == 0) {
         if (FLAGS_dump_index.size())
<a href="#h8-7" id="h8-7" class="h">@@ -192,6 +239,10 @@ void initialize_search(code_searcher *search,
</a>     } else {
         search-&gt;load_index(FLAGS_load_index);
     }
<a href="#h8-7-3" id="h8-7-3" class="i">+    if (FLAGS_load_tags.size() != 0) {
</a><a href="#h8-7-4" id="h8-7-4" class="i">+        tags-&gt;load_index(FLAGS_load_tags);
</a><a href="#h8-7-5" id="h8-7-5" class="i">+        tags-&gt;cache_indexed_files(search);
</a><a href="#h8-7-6" id="h8-7-6" class="i">+    }
</a>     if (FLAGS_dump_index.size() &amp;&amp; FLAGS_load_index.size())
         search-&gt;dump_index(FLAGS_dump_index);
 }
<a href="#h8-8" id="h8-8" class="h">@@ -199,6 +250,7 @@ void initialize_search(code_searcher *search,
</a> struct child_state {
     int fd;
     code_searcher *search;
<a href="#h8-8-3" id="h8-8-3" class="i">+    match_func match;
</a> };
 
 void *handle_client(void *data) {
<a href="#h8-9" id="h8-9" class="h">@@ -225,7 +277,7 @@ void *handle_client(void *data) {
</a> 
 
     codesearch_transport *tx = new codesearch_transport(r, w);
<a href="#h8-9-3" id="h8-9-3" class="d">-    interact(child-&gt;search, tx);
</a><a href="#h8-9-4" id="h8-9-4" class="i">+    interact(child-&gt;search, tx, child-&gt;match);
</a>     delete tx;
     delete child;
     fclose(r);
<a href="#h8-10" id="h8-10" class="h">@@ -296,7 +348,7 @@ int bind_to_address(string spec) {
</a>     return server;
 }
 
<a href="#h8-10-3" id="h8-10-3" class="d">-void listen(code_searcher *search, string path) {
</a><a href="#h8-10-4" id="h8-10-4" class="i">+void listen(code_searcher *search, const string&amp; path, const match_func&amp; match) {
</a>     int server = bind_to_address(path);
 
     printf(&quot;codesearch: listening on %s.\n&quot;, path.c_str());
<a href="#h8-11" id="h8-11" class="h">@@ -309,6 +361,7 @@ void listen(code_searcher *search, string path) {
</a>         child_state *state = new child_state;
         state-&gt;fd = fd;
         state-&gt;search = search;
<a href="#h8-11-3" id="h8-11-3" class="i">+        state-&gt;match = match;
</a> 
         pthread_t thread;
         pthread_create(&amp;thread, NULL, handle_client, state);
<a href="#h8-12" id="h8-12" class="h">@@ -322,19 +375,33 @@ int main(int argc, char **argv) {
</a>     prctl(PR_SET_PDEATHSIG, SIGINT);
 
     code_searcher search;
<a href="#h8-12-3" id="h8-12-3" class="i">+    tag_searcher tags;
</a> 
     signal(SIGPIPE, SIG_IGN);
 
<a href="#h8-12-7" id="h8-12-7" class="d">-    initialize_search(&amp;search, argc, argv);
</a><a href="#h8-12-8" id="h8-12-8" class="i">+    initialize_search(&amp;search, &amp;tags, argc, argv);
</a> 
     if (sem_init(&amp;interact_sem, 0, FLAGS_concurrency) &lt; 0)
         die_errno(&quot;sem_init&quot;);
 
<a href="#h8-12-13" id="h8-12-13" class="i">+    std::vector&lt;std::thread&gt; listeners;
</a>     if (FLAGS_listen.size()) {
<a href="#h8-12-15" id="h8-12-15" class="d">-        listen(&amp;search, FLAGS_listen);
</a><a href="#h8-12-16" id="h8-12-16" class="d">-    } else {
</a><a href="#h8-12-17" id="h8-12-17" class="i">+        codesearch_matcher matcher;
</a><a href="#h8-12-18" id="h8-12-18" class="i">+        listeners.emplace_back(
</a><a href="#h8-12-19" id="h8-12-19" class="i">+            std::thread(boost::bind(&amp;listen, &amp;search, FLAGS_listen, matcher)));
</a><a href="#h8-12-20" id="h8-12-20" class="i">+    }
</a><a href="#h8-12-21" id="h8-12-21" class="i">+    if (FLAGS_listen_tags.size()) {
</a><a href="#h8-12-22" id="h8-12-22" class="i">+        tagsearch_matcher matcher(&amp;tags);
</a><a href="#h8-12-23" id="h8-12-23" class="i">+        listeners.emplace_back(
</a><a href="#h8-12-24" id="h8-12-24" class="i">+            std::thread(boost::bind(&amp;listen, tags.cs(), FLAGS_listen_tags, matcher)));
</a><a href="#h8-12-25" id="h8-12-25" class="i">+    }
</a><a href="#h8-12-26" id="h8-12-26" class="i">+    for (auto&amp; listener : listeners) {
</a><a href="#h8-12-27" id="h8-12-27" class="i">+        listener.join();
</a><a href="#h8-12-28" id="h8-12-28" class="i">+    }
</a><a href="#h8-12-29" id="h8-12-29" class="i">+
</a><a href="#h8-12-30" id="h8-12-30" class="i">+    if (listeners.size() == 0) {
</a>         codesearch_transport *tx = new codesearch_transport(stdin, stdout);
<a href="#h8-12-32" id="h8-12-32" class="d">-        interact(&amp;search, tx);
</a><a href="#h8-12-33" id="h8-12-33" class="i">+        interact(&amp;search, tx, codesearch_matcher());
</a>         delete tx;
     }
 
<b>diff --git a/<a id="h9" href="../file/src/tools/transport.cc">src/tools/transport.cc</a> b/<a href="../file/src/tools/transport.cc">src/tools/transport.cc</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -208,11 +208,15 @@ json_parse_error parse_object(json_object *js, query *q) {
</a>         err = parse_regex(b, &quot;file&quot;, opts, &amp;q-&gt;file_pat);
     if (err.ok())
         err = parse_regex(b, &quot;repo&quot;, opts, &amp;q-&gt;tree_pat);
<a href="#h9-0-3" id="h9-0-3" class="i">+    if (err.ok())
</a><a href="#h9-0-4" id="h9-0-4" class="i">+        err = parse_regex(b, &quot;tags&quot;, opts, &amp;q-&gt;tags_pat);
</a> 
     if (err.ok() &amp;&amp; negate)
         err = parse_regex(negate, &quot;file&quot;, opts, &amp;q-&gt;negate.file_pat);
     if (err.ok() &amp;&amp; negate)
         err = parse_regex(negate, &quot;repo&quot;, opts, &amp;q-&gt;negate.tree_pat);
<a href="#h9-0-10" id="h9-0-10" class="i">+    if (err.ok() &amp;&amp; negate)
</a><a href="#h9-0-11" id="h9-0-11" class="i">+        err = parse_regex(negate, &quot;tags&quot;, opts, &amp;q-&gt;negate.tags_pat);
</a> 
     return err;
 }
</pre>
</div>
</body>
</html>
